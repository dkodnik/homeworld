diff -urPw homeworld-orig/src/Game/AIAttackMan.c homeworld_sdl-0.3/src/Game/AIAttackMan.c
--- homeworld-orig/src/Game/AIAttackMan.c	2002-09-04 12:46:00.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AIAttackMan.c	2004-08-01 22:35:19.000000000 -0700
@@ -7,20 +7,21 @@
 =============================================================================*/
 
 #include <string.h>
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 #include "AIPlayer.h"
 #include "AIFleetMan.h"
 #include "AITeam.h"
 #include "AIOrders.h"
 #include "AIMoves.h"
 #include "AIHandler.h"
-#include "select.h"
-#include "stats.h"
+#include "Select.h"
+#include "Stats.h"
 #include "AIUtilities.h"
-#include "randy.h"
+#include "Randy.h"
 #include "MultiplayerGame.h"
 
+
 #define MAX_NUM_HARASS_TEAMS    2
 
 /*-----------------------------------------------------------------------------
@@ -229,7 +230,7 @@
 ----------------------------------------------------------------------------*/
 ShipPtr aiaGetTakeoutTarget(void)
 {
-    udword i,j=0;
+    udword i;
     ShipPtr targetship;
     SelectCommand *temp_sel;
     SelectCommand *target_sel = memAlloc(sizeofSelectCommand(TOTAL_NUM_SHIPS), "tata", Pyrophoric);
@@ -441,7 +442,7 @@
 ----------------------------------------------------------------------------*/
 void aiaGenerateNewAttackTeam(sdword AttackTeamNumber)
 {
-    AttackType random;
+    AttackType randomAttack;
     udword probability_of_attack;
     bool attack_type_found = FALSE;
     udword i=0;
@@ -453,12 +454,12 @@
     //upper limit to avoid weird infinite loops
     while ((!attack_type_found) && (i<100))
     {
-        random = (AttackType)(ranRandom(RAN_AIPlayer)%NUM_ATTACK_TYPES);
+        randomAttack = (AttackType)(ranRandom(RAN_AIPlayer)%NUM_ATTACK_TYPES);
         probability_of_attack = ranRandom(RAN_AIPlayer)&255;
 
-        if (probability_of_attack < aiCurrentAIPlayer->aiaAttackProbability[random])
+        if (probability_of_attack < aiCurrentAIPlayer->aiaAttackProbability[randomAttack])
         {
-            attack_type_found = aiaGenerateAttackType(aiCurrentAIPlayer->attackTeam[AttackTeamNumber], random, FALSE);
+            attack_type_found = aiaGenerateAttackType(aiCurrentAIPlayer->attackTeam[AttackTeamNumber], randomAttack, FALSE);
         }
         else
         {
diff -urPw homeworld-orig/src/Game/AIAttackMan.h homeworld_sdl-0.3/src/Game/AIAttackMan.h
--- homeworld-orig/src/Game/AIAttackMan.h	2002-09-04 12:46:00.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AIAttackMan.h	2004-08-01 22:35:19.000000000 -0700
@@ -9,9 +9,9 @@
 #ifndef ___AIATTACKMANAGER_H
 #define ___AIATTACKMANAGER_H
 
-#include "types.h"
-#include "spaceobj.h"
-#include "select.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "Select.h"
 
 typedef struct
 {
diff -urPw homeworld-orig/src/Game/AIDefenseMan.c homeworld_sdl-0.3/src/Game/AIDefenseMan.c
--- homeworld-orig/src/Game/AIDefenseMan.c	2002-09-04 12:46:00.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AIDefenseMan.c	2004-08-01 22:35:31.000000000 -0700
@@ -6,19 +6,19 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 #include "AIPlayer.h"
 #include "AIFleetMan.h"
 #include "AIHandler.h"
 #include "AITeam.h"
 #include "AIOrders.h"
 #include "AIUtilities.h"
-#include "select.h"
-#include "stats.h"
+#include "Select.h"
+#include "Stats.h"
 #include "AIMoves.h"
-#include "fastmath.h"
-#include "randy.h"
+#include "FastMath.h"
+#include "Randy.h"
 
 bool aitAnyTeamOfPlayerGuardingThisShip(struct AIPlayer *aiplayer,Ship *ship)
 {
diff -urPw homeworld-orig/src/Game/AIDefenseMan.h homeworld_sdl-0.3/src/Game/AIDefenseMan.h
--- homeworld-orig/src/Game/AIDefenseMan.h	2002-09-04 12:46:00.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AIDefenseMan.h	2004-08-01 22:35:31.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___AIDEFENSEMANAGER_H
 #define ___AIDEFENSEMANAGER_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 void aidDefenseManager(void);
 bool aidShipDied(struct AIPlayer *aiplayer, ShipPtr ship);
diff -urPw homeworld-orig/src/Game/AIEvents.c homeworld_sdl-0.3/src/Game/AIEvents.c
--- homeworld-orig/src/Game/AIEvents.c	2002-09-04 12:46:00.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AIEvents.c	2004-08-01 22:35:24.000000000 -0700
@@ -1,8 +1,8 @@
 #include "AIEvents.h"
 #include "AITeam.h"
-#include "memory.h"
+#include "Memory.h"
 #include "AIPlayer.h"
-#include "blobs.h"
+#include "Blobs.h"
 
 //
 //  handle any events applicable for the
@@ -414,7 +414,7 @@
         }
     }
 
-  end:
+//  end:
     aiumemFree(ships);
     return TRUE;
 }
@@ -665,20 +665,20 @@
         dbgAssert(move->events.interrupt.intvar < sizeof(AIPlayer));
     }
 
-    move->events.gettingRocked.handler  = aieHandlerToNum((aieHandlerSimple)move->events.gettingRocked.handler);
-    move->events.enemyNearby.handler    = aieHandlerToNum((aieHandlerSimple)move->events.enemyNearby.handler);
-    move->events.enemyNotNearby.handler = aieHandlerToNum(move->events.enemyNotNearby.handler);
-    move->events.firing.handler         = aieHandlerToNum(move->events.firing.handler);
-    move->events.disengage.handler      = aieHandlerToNum(move->events.disengage.handler);
-    move->events.healthLow.handler      = aieHandlerToNum(move->events.healthLow.handler);
-    move->events.healthHigh.handler     = aieHandlerToNum(move->events.healthHigh.handler);
-    move->events.numbersLow.handler     = aieHandlerToNum(move->events.numbersLow.handler);
-    move->events.numbersHigh.handler    = aieHandlerToNum(move->events.numbersHigh.handler);
-    move->events.fuelLow.handler        = aieHandlerToNum(move->events.fuelLow.handler);
-    move->events.fuelHigh.handler       = aieHandlerToNum(move->events.fuelHigh.handler);
-    move->events.shipDied.handler       = aieHandlerToNum((aieHandlerSimple)move->events.shipDied.handler);
-    move->events.teamDied.handler       = aieHandlerToNum(move->events.teamDied.handler);
-    move->events.interrupt.handler      = aieHandlerToNum((aieHandlerSimple)move->events.interrupt.handler);
+    move->events.gettingRocked.handler  = (aieHandlerShips)aieHandlerToNum((aieHandlerSimple)move->events.gettingRocked.handler);
+    move->events.enemyNearby.handler    = (aieHandlerShips)aieHandlerToNum((aieHandlerSimple)move->events.enemyNearby.handler);
+    move->events.enemyNotNearby.handler = (aieHandlerSimple)aieHandlerToNum(move->events.enemyNotNearby.handler);
+    move->events.firing.handler         = (aieHandlerSimple)aieHandlerToNum(move->events.firing.handler);
+    move->events.disengage.handler      = (aieHandlerSimple)aieHandlerToNum(move->events.disengage.handler);
+    move->events.healthLow.handler      = (aieHandlerSimple)aieHandlerToNum(move->events.healthLow.handler);
+    move->events.healthHigh.handler     = (aieHandlerSimple)aieHandlerToNum(move->events.healthHigh.handler);
+    move->events.numbersLow.handler     = (aieHandlerSimple)aieHandlerToNum(move->events.numbersLow.handler);
+    move->events.numbersHigh.handler    = (aieHandlerSimple)aieHandlerToNum(move->events.numbersHigh.handler);
+    move->events.fuelLow.handler        = (aieHandlerSimple)aieHandlerToNum(move->events.fuelLow.handler);
+    move->events.fuelHigh.handler       = (aieHandlerSimple)aieHandlerToNum(move->events.fuelHigh.handler);
+    move->events.shipDied.handler       = (aieHandlerShip)aieHandlerToNum((aieHandlerSimple)move->events.shipDied.handler);
+    move->events.teamDied.handler       = (aieHandlerSimple)aieHandlerToNum(move->events.teamDied.handler);
+    move->events.interrupt.handler      = (aieHandlerInt)aieHandlerToNum((aieHandlerSimple)move->events.interrupt.handler);
 }
 
 void aieFixAIEvents(struct AITeamMove *move)
diff -urPw homeworld-orig/src/Game/AIEvents.h homeworld_sdl-0.3/src/Game/AIEvents.h
--- homeworld-orig/src/Game/AIEvents.h	2002-09-04 12:46:00.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AIEvents.h	2004-08-01 22:35:24.000000000 -0700
@@ -1,9 +1,11 @@
 #ifndef __AIEVENTS_H
 #define __AIEVENTS_H
 
-#include "types.h"
-#include "shipselect.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "ShipSelect.h"
+#include "SpaceObj.h"
+
+struct AITeam;
 
 //
 //  the voids should actual be AITeams, but
@@ -145,6 +147,8 @@
 sdword aieCheckTeamDied(struct AITeam *team);
 sdword aieCheckInterrupt(struct AITeam *team);
 
+struct AITeamMove;
+
 void aieHandlerSetGettingRocked (struct AITeamMove *move, bool8 oneShot, aieHandlerShips handler);
 void aieHandlerSetEnemyNearby(struct AITeamMove *move, real32 watchRadius, bool8 oneShot, aieHandlerShips handler);
 void aieHandlerSetEnemyNotNearby(struct AITeamMove *move, real32 watchRadius, bool8 oneShot, aieHandlerSimple hander);
diff -urPw homeworld-orig/src/Game/AIFleetMan.c homeworld_sdl-0.3/src/Game/AIFleetMan.c
--- homeworld-orig/src/Game/AIFleetMan.c	2002-09-04 12:46:00.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AIFleetMan.c	2004-08-01 22:35:19.000000000 -0700
@@ -7,8 +7,8 @@
 =============================================================================*/
 
 #include <string.h>
-#include "types.h"
-#include "universe.h"
+#include "Types.h"
+#include "Universe.h"
 #include "AIPlayer.h"
 #include "AIFleetMan.h"
 #include "AIResourceMan.h"
@@ -18,12 +18,12 @@
 #include "AIUtilities.h"
 #include "AIVar.h"
 #include "CommandWrap.h"
-#include "select.h"
-#include "researchapi.h"
+#include "Select.h"
+#include "ResearchAPI.h"
 #include "SinglePlayer.h"
 #include "MultiplayerGame.h"
-#include "alliance.h"
-#include "randy.h"
+#include "Alliance.h"
+#include "Randy.h"
 
 Player *aifFindEnemyOf(Player *player)
 {
@@ -686,12 +686,12 @@
 }
 
 #define constructTeamWaiting(twaiting,stype,nships,tm,dSetVar)   \
-            twaiting = memAlloc(sizeof(TeamWaitingForTheseShips),"teamwaitingships",0);     \
-            twaiting##->shiptype = stype;                                                   \
-            twaiting##->num_ships = nships;                                                 \
-            twaiting##->team = tm;                                                          \
+            (twaiting) = memAlloc(sizeof(TeamWaitingForTheseShips),"teamwaitingships",0);   \
+            (twaiting)->shiptype = (stype);                                                 \
+            (twaiting)->num_ships = (nships);                                               \
+            (twaiting)->team = (tm);                                                        \
             dbgAssert(strlen(dSetVar) <= AIVAR_LABEL_MAX_LENGTH);                           \
-            strcpy(twaiting##->doneSetVarStr,dSetVar)
+            strcpy((twaiting)->doneSetVarStr,(dSetVar))
 
 void aifTeamRequestsShipsCB(ShipType shiptype,sdword number,struct AITeam *team,char *doneSetVar, sdword priority)
 {
diff -urPw homeworld-orig/src/Game/AIFleetMan.h homeworld_sdl-0.3/src/Game/AIFleetMan.h
--- homeworld-orig/src/Game/AIFleetMan.h	2002-09-04 12:46:00.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AIFleetMan.h	2004-08-01 22:35:19.000000000 -0700
@@ -2,8 +2,8 @@
 #ifndef ___AIFLEETCOMMAND_H
 #define ___AIFLEETCOMMAND_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 void aifFleetCommand(void);
 
diff -urPw homeworld-orig/src/Game/AIHandler.c homeworld_sdl-0.3/src/Game/AIHandler.c
--- homeworld-orig/src/Game/AIHandler.c	2002-09-04 12:46:02.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AIHandler.c	2004-08-01 22:35:29.000000000 -0700
@@ -12,11 +12,11 @@
 #include "AIHandler.h"
 #include "AIOrders.h"
 #include "CommandWrap.h"
-#include "select.h"
-#include "shipselect.h"
+#include "Select.h"
+#include "ShipSelect.h"
 #include "GravWellGenerator.h"
-#include "randy.h"
-#include "univupdate.h"
+#include "Randy.h"
+#include "UnivUpdate.h"
 
 aieHandlerSimple handlerTable[] =
 {
@@ -630,7 +630,6 @@
 void aihFastDefenseDistressHandler(struct AITeam *team, udword *intvar)
 {
     AITeamMove *newMove, *thisMove = team->curMove;
-    SelectCommand *HandlerShips = (SelectCommand *)(*intvar);
     SelectCommand *enemyShips;
     MaxSelection invadingShips, distressShips;
     udword i;
@@ -716,7 +715,6 @@
 void aihSlowDefenseDistressHandler(struct AITeam *team, udword *intvar)
 {
     AITeamMove *newMove, *thisMove = team->curMove;
-    SelectCommand *HandlerShips = (SelectCommand *)(*intvar);
     SelectCommand *enemyShips;
     MaxSelection distressShips, invadingShips;
     udword i;
diff -urPw homeworld-orig/src/Game/AIHandler.h homeworld_sdl-0.3/src/Game/AIHandler.h
--- homeworld-orig/src/Game/AIHandler.h	2002-09-04 12:46:02.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AIHandler.h	2004-08-01 22:35:29.000000000 -0700
@@ -9,7 +9,7 @@
 #define ___AIHANDLER_H
 
 #include "AITeam.h"
-#include "select.h"
+#include "Select.h"
 
 #define GENERIC_STRENGTHRATIO   1.5
 
diff -urPw homeworld-orig/src/Game/AIMoves1.c.h homeworld_sdl-0.3/src/Game/AIMoves1.c.h
--- homeworld-orig/src/Game/AIMoves1.c.h	2002-09-04 12:46:02.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AIMoves1.c.h	2004-08-01 22:35:30.000000000 -0700
@@ -1,12 +1,12 @@
-#include "fastmath.h"
-#include "select.h"
+#include "FastMath.h"
+#include "Select.h"
 #include "AIUtilities.h"
 #include "AIHandler.h"
 #include "AIAttackMan.h"
-#include "dock.h"
+#include "Dock.h"
 #include "SalCapCorvette.h"
-#include "singleplayer.h"
-#include "tutor.h"
+#include "SinglePlayer.h"
+#include "Tutor.h"
 
 /*=============================================================================
     Special Move functions:
@@ -2458,11 +2458,11 @@
 sdword aimProcessSwarmPod(AITeam *team)
 {
     AITeam *attackSwarm = team->cooperatingTeam, *defenseSwarm = team->cooperatingTeam->cooperatingTeam;
-    paramsSwarmDefense *defParams = &defenseSwarm->curMove->params.swarmdef;
+//    paramsSwarmDefense *defParams = &defenseSwarm->curMove->params.swarmdef;
     AITeamMove *thisMove = team->curMove, *newMove;
     SelectCommand /**enemyShips,*/ *targets;
 //    udword numShips, i;
-    vector current_location, target_location, destination, zerovec = {0,0,0};
+    vector current_location, target_location, destination; //, zerovec = {0,0,0};
     real32 avg_size, dist;
 
     aiuFindArmadaTarget(&target_location, &targets, team->shipList.selection);
@@ -3345,7 +3345,7 @@
 
 void aimPreFix_Intercept(AITeamMove *move)
 {
-    move->params.intercept.ship = SpaceObjRegistryGetID((SpaceObj *)move->params.intercept.ship);
+    move->params.intercept.ship = (ShipPtr)SpaceObjRegistryGetID((SpaceObj *)move->params.intercept.ship);
 }
 
 #pragma warning( 2 : 4047)      // turn back on "different levels of indirection warning"
@@ -3536,7 +3536,7 @@
 
 void aimPreFix_AdvancedAttack(AITeamMove *move)
 {
-    move->params.advatt.target_ship = SpaceObjRegistryGetID((SpaceObj *)move->params.advatt.target_ship);
+    move->params.advatt.target_ship = (Ship*)SpaceObjRegistryGetID((SpaceObj *)move->params.advatt.target_ship);
 }
 
 #pragma warning( 2 : 4047)      // turn back on "different levels of indirection warning"
@@ -3598,7 +3598,7 @@
 
 void aimPreFix_MoveAttack(AITeamMove *move)
 {
-    move->params.moveatt.target_ship = SpaceObjRegistryGetID((SpaceObj *)move->params.moveatt.target_ship);
+    move->params.moveatt.target_ship = (Ship*)SpaceObjRegistryGetID((SpaceObj *)move->params.moveatt.target_ship);
 }
 
 #pragma warning( 2 : 4047)      // turn back on "different levels of indirection warning"
@@ -3655,7 +3655,7 @@
 
 void aimPreFix_HarassAttack(AITeamMove *move)
 {
-    move->params.harass.target = SpaceObjRegistryGetID((SpaceObj *)move->params.harass.target);
+    move->params.harass.target = (ShipPtr)SpaceObjRegistryGetID((SpaceObj *)move->params.harass.target);
 }
 
 #pragma warning( 2 : 4047)      // turn back on "different levels of indirection warning"
@@ -3699,7 +3699,7 @@
 
 void aimPreFix_Dock(AITeamMove *move)
 {
-    move->params.dock.dockAt = SpaceObjRegistryGetID((SpaceObj *)move->params.dock.dockAt);
+    move->params.dock.dockAt = (ShipPtr)SpaceObjRegistryGetID((SpaceObj *)move->params.dock.dockAt);
 }
 
 #pragma warning( 2 : 4047)      // turn back on "different levels of indirection warning"
@@ -3817,7 +3817,7 @@
 
 void aimPreFix_PatrolMove(AITeamMove *move)
 {
-    move->params.patrolmove.loopMove = ConvertPointerInListToNum(&savingThisAITeam->moves,move->params.patrolmove.loopMove);
+    move->params.patrolmove.loopMove = (AITeamMove*)ConvertPointerInListToNum(&savingThisAITeam->moves,move->params.patrolmove.loopMove);
 }
 
 #pragma warning( 2 : 4047)      // turn back on "different levels of indirection warning"
@@ -3954,7 +3954,7 @@
 
 void aimPreFix_Reinforce(AITeamMove *move)
 {
-    move->params.reinforce.reinforceteam = AITeamToTeamIndex(move->params.reinforce.reinforceteam);
+    move->params.reinforce.reinforceteam = (AITeam *)AITeamToTeamIndex(move->params.reinforce.reinforceteam);
 }
 
 #pragma warning( 2 : 4047)      // turn back on "different levels of indirection warning"
diff -urPw homeworld-orig/src/Game/AIMoves2.c.h homeworld_sdl-0.3/src/Game/AIMoves2.c.h
--- homeworld-orig/src/Game/AIMoves2.c.h	2002-09-04 12:46:02.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AIMoves2.c.h	2004-08-01 22:35:35.000000000 -0700
@@ -1,4 +1,4 @@
-#include "univupdate.h"
+#include "UnivUpdate.h"
 
 sdword aimProcessGuardCooperatingTeam(AITeam *team)
 {
@@ -864,7 +864,7 @@
 
 void aimPreFix_FancyGetShips(AITeamMove *move)
 {
-    move->params.fancyGetShips.doneVar = AIVarToNumber(move->params.fancyGetShips.doneVar);
+    move->params.fancyGetShips.doneVar = (AIVar *)AIVarToNumber(move->params.fancyGetShips.doneVar);
 }
 
 #pragma warning( 2 : 4047)      // turn back on "different levels of indirection warning"
diff -urPw homeworld-orig/src/Game/AIMoves.c homeworld_sdl-0.3/src/Game/AIMoves.c
--- homeworld-orig/src/Game/AIMoves.c	2002-09-04 12:46:02.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AIMoves.c	2004-08-01 22:35:21.000000000 -0700
@@ -4,11 +4,11 @@
 #include "AIEvents.h"
 #include "AIVar.h"
 #include "AIMoves.h"
-#include "memory.h"
+#include "Memory.h"
 #include "AIPlayer.h"
 #include "AIFleetMan.h"
 #include "CommandWrap.h"
-#include "randy.h"
+#include "Randy.h"
 #include "AIUtilities.h"
 #include "SaveGame.h"
 
@@ -173,7 +173,7 @@
 
 AITeamMove *aimCreateGetShipsNoAdd(AITeam *team, ShipType shiptype, sbyte num_ships, sdword priority, bool8 wait, bool8 remove)
 {
-    TypeOfFormation formation = SAME_FORMATION;
+//    TypeOfFormation formation = SAME_FORMATION;
     AlternativeShips alternatives;
     AITeamMove *newMove = (AITeamMove *)memAlloc(sizeof(AITeamMove), "getshipsmove", 0);
 
@@ -217,7 +217,7 @@
 
 void aimPreFix_GetShips(AITeamMove *move)
 {
-    move->params.getShips.doneVar = AIVarToNumber(move->params.getShips.doneVar);
+    move->params.getShips.doneVar = (AIVar*)AIVarToNumber(move->params.getShips.doneVar);
 }
 
 #pragma warning( 2 : 4047)      // turn back on "different levels of indirection warning"
@@ -440,6 +440,6 @@
 //
 //  temporary contention relief
 //
-#include "AIMoves1.c"  // Falko
-#include "AIMoves2.c"  // Gary
+#include "AIMoves1.c.h"  // Falko
+#include "AIMoves2.c.h"  // Gary
 
diff -urPw homeworld-orig/src/Game/AIMoves.h homeworld_sdl-0.3/src/Game/AIMoves.h
--- homeworld-orig/src/Game/AIMoves.h	2002-09-04 12:46:02.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AIMoves.h	2004-08-01 22:35:21.000000000 -0700
@@ -1,8 +1,14 @@
 #ifndef __AIMOVES_H
 #define __AIMOVES_H
 
-#include "vector.h"
-#include "volume.h"
+#include "Vector.h"
+#include "Volume.h"
+#include "Formation.h"
+
+struct AITeam;
+struct AITeamMove;
+struct Path;
+struct AlternativeShips;
 
 /*=============================================================================
     Move Definitions:
@@ -14,242 +20,242 @@
 /*=============================================================================
     Utility Functions:
 =============================================================================*/
-void aimInsertMove(AITeam *team, struct AITeamMove *move);
+void aimInsertMove(struct AITeam *team, struct AITeamMove *move);
 
 /*=============================================================================
     Move Process Functions:
 =============================================================================*/
-sdword aimProcessVarSet(AITeam *team);
-sdword aimProcessVarInc(AITeam *team);
-sdword aimProcessVarDec(AITeam *team);
-sdword aimProcessVarWait(AITeam *team);
-sdword aimProcessVarDestroy(AITeam *team);
-sdword aimProcessGuardShips(AITeam *team);
-sdword aimProcessFormation(AITeam *team);
-sdword aimProcessGetShips(AITeam *team);
-sdword aimProcessMoveDone(AITeam *team);
-sdword aimProcessSpecial(AITeam *team);
-sdword aimProcessAttack(AITeam *team);
-sdword aimProcessAdvancedAttack(AITeam *team);
-sdword aimProcessMoveAttack(AITeam *team);
-sdword aimProcessMoveTeam(AITeam *team);
-sdword aimProcessIntercept(AITeam *team);
-sdword aimProcessMoveTo(AITeam *team);
-sdword aimProcessMoveSplit(AITeam *team);
-sdword aimProcessCountShips(AITeam *team);
-sdword aimProcessHarassAttack(AITeam *team);
-sdword aimProcessFancyGetShips(AITeam *team);
-sdword aimProcessGuardCooperatingTeam(AITeam *team);
-sdword aimProcessDefendMothership(AITeam *team);
-sdword aimProcessPatrolMove(AITeam *team);
-sdword aimProcessActivePatrol(AITeam *team);
-sdword aimProcessTempGuard(AITeam *team);
-sdword aimProcessSupport(AITeam *team);
-sdword aimProcessSwarmAttack(AITeam *team);
-sdword aimProcessLaunch(AITeam *team);
-sdword aimProcessResourceVolume(AITeam *team);
-sdword aimProcessCapture(AITeam *team);
-sdword aimProcessActiveCapture(AITeam *team);
-sdword aimProcessActiveMine(AITeam *team);
-sdword aimProcessMineVolume(AITeam *team);
-sdword aimProcessSpecialDefense(AITeam *team);
-sdword aimProcessKamikaze(AITeam *team);
+sdword aimProcessVarSet(struct AITeam *team);
+sdword aimProcessVarInc(struct AITeam *team);
+sdword aimProcessVarDec(struct AITeam *team);
+sdword aimProcessVarWait(struct AITeam *team);
+sdword aimProcessVarDestroy(struct AITeam *team);
+sdword aimProcessGuardShips(struct AITeam *team);
+sdword aimProcessFormation(struct AITeam *team);
+sdword aimProcessGetShips(struct AITeam *team);
+sdword aimProcessMoveDone(struct AITeam *team);
+sdword aimProcessSpecial(struct AITeam *team);
+sdword aimProcessAttack(struct AITeam *team);
+sdword aimProcessAdvancedAttack(struct AITeam *team);
+sdword aimProcessMoveAttack(struct AITeam *team);
+sdword aimProcessMoveTeam(struct AITeam *team);
+sdword aimProcessIntercept(struct AITeam *team);
+sdword aimProcessMoveTo(struct AITeam *team);
+sdword aimProcessMoveSplit(struct AITeam *team);
+sdword aimProcessCountShips(struct AITeam *team);
+sdword aimProcessHarassAttack(struct AITeam *team);
+sdword aimProcessFancyGetShips(struct AITeam *team);
+sdword aimProcessGuardCooperatingTeam(struct AITeam *team);
+sdword aimProcessDefendMothership(struct AITeam *team);
+sdword aimProcessPatrolMove(struct AITeam *team);
+sdword aimProcessActivePatrol(struct AITeam *team);
+sdword aimProcessTempGuard(struct AITeam *team);
+sdword aimProcessSupport(struct AITeam *team);
+sdword aimProcessSwarmAttack(struct AITeam *team);
+sdword aimProcessLaunch(struct AITeam *team);
+sdword aimProcessResourceVolume(struct AITeam *team);
+sdword aimProcessCapture(struct AITeam *team);
+sdword aimProcessActiveCapture(struct AITeam *team);
+sdword aimProcessActiveMine(struct AITeam *team);
+sdword aimProcessMineVolume(struct AITeam *team);
+sdword aimProcessSpecialDefense(struct AITeam *team);
+sdword aimProcessKamikaze(struct AITeam *team);
 
 /*=============================================================================
     Move Creation Functions:
 =============================================================================*/
-AITeamMove *aimCreateVarSet(AITeam *team, char *varName, sdword value, bool8 wait, bool8 remove);
-AITeamMove *aimCreateVarInc(AITeam *team, char *varName, bool8 wait, bool8 remove);
-AITeamMove *aimCreateVarDec(AITeam *team, char *varName, bool8 wait, bool8 remove);
-AITeamMove *aimCreateVarWait(AITeam *team, char *varName, sdword value, bool8 wait, bool8 remove);
-AITeamMove *aimCreateVarDestroy(AITeam *team, char *varName, bool8 wait, bool8 remove);
-AITeamMove *aimCreateGuardShips(AITeam *team, SelectCommand *ships, bool8 wait, bool8 remove);
-AITeamMove *aimCreateFormation(AITeam *team, TypeOfFormation formationtype, bool8 wait, bool8 remove);
-AITeamMove *aimCreateGetShips(AITeam *team, ShipType shiptype, sbyte num_ships, sdword priority, bool8 wait, bool8 remove);
-AITeamMove *aimCreateMoveDone(AITeam *team, bool8 wait, bool8 remove);
-AITeamMove *aimCreateSpecial(AITeam *team, SelectCommand *targets, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
-AITeamMove *aimCreateAttack(AITeam *team, SelectCommand *targets, TypeOfFormation formation, bool8 wait, bool8 remove);
-AITeamMove *aimCreateAdvancedAttack(AITeam *team, SelectCommand *targets, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
-AITeamMove *aimCreateFlankAttack(AITeam *team, SelectCommand *targets, bool8 hyperspace, bool8 wait, bool8 remove);
-AITeamMove *aimCreateMoveAttack(AITeam *team, SelectCommand *targets, bool Advanced, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
-AITeamMove *aimCreateMoveTeam(AITeam *team, vector destination, TypeOfFormation formation, bool8 wait, bool8 remove);
-AITeamMove *aimCreateMoveTeamIndex(AITeam *team, vector destination, udword index, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
-AITeamMove *aimCreateMoveTeamSplit(AITeam *team, SelectCommand *ships, Path *destinations, TacticsType tactics, bool8 wait, bool8 remove);
-AITeamMove *aimCreateHyperspace(AITeam *team, vector destination, TypeOfFormation formation, bool8 wait, bool8 remove);
-AITeamMove *aimCreateIntercept(AITeam *team, ShipPtr ship, real32 interval, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
-AITeamMove *aimCreateMoveTo(AITeam *team, vector destination, real32 limiter, udword type, TypeOfFormation formation, TacticsType tactics, bool wait, bool remove);
-AITeamMove *aimCreateCountShips(AITeam *team, bool8 wait, bool8 remove);
-AITeamMove *aimCreateHarassAttack(AITeam *team, bool8 wait, bool8 remove);
-AITeamMove *aimCreateFancyGetShips(AITeam *team, ShipType shiptype, sbyte num_ships, AlternativeShips *alternatives, sdword priority, bool8 wait, bool8 remove);
-AITeamMove *aimCreateDock(AITeam *team, sdword dockmoveFlags, ShipPtr dockAt, bool8 wait, bool8 remove);
-AITeamMove *aimCreateLaunch(AITeam *team, bool8 wait, bool8 remove);
-AITeamMove *aimCreateGuardCooperatingTeam(AITeam *team, bool8 wait, bool8 remove);
-AITeamMove *aimCreateDefendMothership(AITeam *team, bool8 wait, bool8 remove);
-AITeamMove *aimCreatePatrolMove(AITeam *team, Path *path, udword startIndex, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
-AITeamMove *aimCreateActivePatrol(AITeam *team, udword patroltype, bool8 wait, bool8 remove);
-AITeamMove *aimCreateTempGuard(AITeam *team, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
-AITeamMove *aimCreateReinforce(AITeam *team, AITeam *reinforceteam, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
-AITeamMove *aimCreateSupport(AITeam *team, SelectCommand *ships, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
-AITeamMove *aimCreateActiveRecon(AITeam *team, bool EnemyRecon, TypeOfFormation formation,TacticsType tactics, bool8 wait, bool8 remove);
-AITeamMove *aimCreateShipRecon(AITeam *team, SelectCommand *ships, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
-AITeamMove *aimCreateArmada(AITeam *team, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
-AITeamMove *aimCreateControlResources(AITeam *team, SelectCommand *ships, bool8 wait, bool8 remove);
-AITeamMove *aimCreateSwarmAttack(AITeam *team, bool8 wait, bool8 remove);
-AITeamMove *aimCreateSwarmDefense(AITeam *team, SelectCommand *pods, bool8 wait, bool8 remove);
-AITeamMove *aimCreateSwarmPod(AITeam *team, bool8 wait, bool8 remove);
-AITeamMove *aimCreateResourceVolume(AITeam *team, Volume volume, bool8 strictVolume, bool8 wait, bool8 remove);
-AITeamMove *aimCreateActiveResource(AITeam *team, bool8 wait, bool8 remove);
-AITeamMove *aimCreateMothershipMove(AITeam *team, bool8 wait, bool8 remove);
-AITeamMove *aimCreateCapture(AITeam *team, ShipPtr ship, bool8 wait, bool8 remove);
-AITeamMove *aimCreateActiveCapture(AITeam *team, bool8 wait, bool8 remove);
-AITeamMove *aimCreateActiveMine(AITeam *team, bool8 wait, bool8 remove);
-AITeamMove *aimCreateMineVolume(AITeam *team, Volume volume, bool8 wait, bool8 remove);
-AITeamMove *aimCreateSpecialDefense(AITeam *team, bool8 wait, bool8 remove);
-AITeamMove *aimCreateDeleteTeam(AITeam *team);
-AITeamMove *aimCreateKamikaze(AITeam *team, SelectCommand *targets,TypeOfFormation formation, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateVarSet(struct AITeam *team, char *varName, sdword value, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateVarInc(struct AITeam *team, char *varName, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateVarDec(struct AITeam *team, char *varName, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateVarWait(struct AITeam *team, char *varName, sdword value, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateVarDestroy(struct AITeam *team, char *varName, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateGuardShips(struct AITeam *team, SelectCommand *ships, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateFormation(struct AITeam *team, TypeOfFormation formationtype, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateGetShips(struct AITeam *team, ShipType shiptype, sbyte num_ships, sdword priority, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateMoveDone(struct AITeam *team, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateSpecial(struct AITeam *team, SelectCommand *targets, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateAttack(struct AITeam *team, SelectCommand *targets, TypeOfFormation formation, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateAdvancedAttack(struct AITeam *team, SelectCommand *targets, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateFlankAttack(struct AITeam *team, SelectCommand *targets, bool8 hyperspace, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateMoveAttack(struct AITeam *team, SelectCommand *targets, bool Advanced, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateMoveTeam(struct AITeam *team, vector destination, TypeOfFormation formation, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateMoveTeamIndex(struct AITeam *team, vector destination, udword index, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateMoveTeamSplit(struct AITeam *team, SelectCommand *ships, struct Path *destinations, TacticsType tactics, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateHyperspace(struct AITeam *team, vector destination, TypeOfFormation formation, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateIntercept(struct AITeam *team, ShipPtr ship, real32 interval, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateMoveTo(struct AITeam *team, vector destination, real32 limiter, udword type, TypeOfFormation formation, TacticsType tactics, bool wait, bool remove);
+struct AITeamMove *aimCreateCountShips(struct AITeam *team, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateHarassAttack(struct AITeam *team, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateFancyGetShips(struct AITeam *team, ShipType shiptype, sbyte num_ships, struct AlternativeShips *alternatives, sdword priority, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateDock(struct AITeam *team, sdword dockmoveFlags, ShipPtr dockAt, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateLaunch(struct AITeam *team, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateGuardCooperatingTeam(struct AITeam *team, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateDefendMothership(struct AITeam *team, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreatePatrolMove(struct AITeam *team, struct Path *path, udword startIndex, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateActivePatrol(struct AITeam *team, udword patroltype, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateTempGuard(struct AITeam *team, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateReinforce(struct AITeam *team, struct AITeam *reinforceteam, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateSupport(struct AITeam *team, SelectCommand *ships, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateActiveRecon(struct AITeam *team, bool EnemyRecon, TypeOfFormation formation,TacticsType tactics, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateShipRecon(struct AITeam *team, SelectCommand *ships, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateArmada(struct AITeam *team, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateControlResources(struct AITeam *team, SelectCommand *ships, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateSwarmAttack(struct AITeam *team, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateSwarmDefense(struct AITeam *team, SelectCommand *pods, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateSwarmPod(struct AITeam *team, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateResourceVolume(struct AITeam *team, Volume volume, bool8 strictVolume, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateActiveResource(struct AITeam *team, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateMothershipMove(struct AITeam *team, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateCapture(struct AITeam *team, ShipPtr ship, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateActiveCapture(struct AITeam *team, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateActiveMine(struct AITeam *team, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateMineVolume(struct AITeam *team, Volume volume, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateSpecialDefense(struct AITeam *team, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateDeleteTeam(struct AITeam *team);
+struct AITeamMove *aimCreateKamikaze(struct AITeam *team, SelectCommand *targets,TypeOfFormation formation, bool8 wait, bool8 remove);
 
 /*=============================================================================
     Move Creation Without Linked List Add:
 =============================================================================*/
-AITeamMove *aimCreateFormationNoAdd(AITeam *team, TypeOfFormation formationtype, bool8 wait, bool8 remove);
-AITeamMove *aimCreateFancyGetShipsNoAdd(AITeam *team, ShipType shiptype, sbyte num_ships, AlternativeShips *alternatives, sdword priority, bool8 wait, bool8 remove);
-AITeamMove *aimCreateSpecialNoAdd(AITeam *team, SelectCommand *targets, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
-AITeamMove *aimCreateAttackNoAdd(AITeam *team, SelectCommand *targets, TypeOfFormation formation, bool8 wait, bool8 remove);
-AITeamMove *aimCreateAdvancedAttackNoAdd(AITeam *team, SelectCommand *target, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
-AITeamMove *aimCreateFlankAttackNoAdd(AITeam *team, SelectCommand *targets, bool8 hyperspace, bool8 wait, bool8 remove);
-AITeamMove *aimCreateMoveAttackNoAdd(AITeam *team, SelectCommand *targets, bool Advanced, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
-AITeamMove *aimCreateMoveTeamNoAdd(AITeam *team, vector destination, TypeOfFormation formation, bool8 wait, bool8 remove);
-AITeamMove *aimCreateMoveTeamIndexNoAdd(AITeam *team, vector destination, udword index, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
-AITeamMove *aimCreateMoveTeamSplitNoAdd(AITeam *team, SelectCommand *ships, Path *destinations, TacticsType tactics, bool8 wait, bool8 remove);
-AITeamMove *aimCreateHyperspaceNoAdd(AITeam *team, vector destination, TypeOfFormation formation, bool8 wait, bool8 remove);
-AITeamMove *aimCreateInterceptNoAdd(AITeam *team, ShipPtr ship, real32 interval, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
-AITeamMove *aimCreateMoveToNoAdd(AITeam *team, vector destination, real32 limiter, udword type, TypeOfFormation formation, TacticsType tactics, bool wait, bool remove);
-AITeamMove *aimCreateCountShipsNoAdd(AITeam *team, bool8 wait, bool8 remove);
-AITeamMove *aimCreateDockNoAdd(AITeam *team, sdword dockmoveFlags, ShipPtr dockAt, bool8 wait, bool8 remove);
-AITeamMove *aimCreateLaunchNoAdd(AITeam *team, bool8 wait, bool8 remove);
-AITeamMove *aimCreateGuardCooperatingTeamNoAdd(AITeam *team, bool8 wait, bool8 remove);
-AITeamMove *aimCreateDefendMothershipNoAdd(AITeam *team, bool8 wait, bool8 remove);
-AITeamMove *aimCreatePatrolMoveNoAdd(AITeam *team, Path *path, udword startIndex, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
-AITeamMove *aimCreateActivePatrolNoAdd(AITeam *team, udword patroltype, bool8 wait, bool8 remove);
-AITeamMove *aimCreateGetShipsNoAdd(AITeam *team, ShipType shiptype, sbyte num_ships, sdword priority, bool8 wait, bool8 remove);
-AITeamMove *aimCreateTempGuardNoAdd(AITeam *team, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
-AITeamMove *aimCreateReinforceNoAdd(AITeam *team, AITeam *reinforceteam, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
-AITeamMove *aimCreateSupportNoAdd(AITeam *team, SelectCommand *ships, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
-AITeamMove *aimCreateActiveReconNoAdd(AITeam *team, bool EnemyRecon, TypeOfFormation formation,TacticsType tactics, bool8 wait, bool8 remove);
-AITeamMove *aimCreateShipReconNoAdd(AITeam *team, SelectCommand *ships, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
-AITeamMove *aimCreateArmadaNoAdd(AITeam *team, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
-AITeamMove *aimCreateControlResourcesNoAdd(AITeam *team, SelectCommand *ships, bool8 wait, bool8 remove);
-AITeamMove *aimCreateSwarmAttackNoAdd(AITeam *team, bool8 wait, bool8 remove);
-AITeamMove *aimCreateSwarmDefenseNoAdd(AITeam *team, SelectCommand *pods, bool8 wait, bool8 remove);
-AITeamMove *aimCreateResourceVolumeNoAdd(AITeam *team, Volume volume, bool8 strictVolume, bool8 wait, bool8 remove);
-AITeamMove *aimCreateActiveResourceNoAdd(AITeam *team, bool8 wait, bool8 remove);
-AITeamMove *aimCreateMothershipMove(AITeam *team, bool8 wait, bool8 remove);
-AITeamMove *aimCreateCaptureNoAdd(AITeam *team, ShipPtr ship, bool8 wait, bool8 remove);
-AITeamMove *aimCreateActiveCaptureNoAdd(AITeam *team, bool8 wait, bool8 remove);
-AITeamMove *aimCreateActiveMineNoAdd(AITeam *team, bool8 wait, bool8 remove);
-AITeamMove *aimCreateMineVolumeNoAdd(AITeam *team, Volume vol, bool8 wait, bool8 remove);
-AITeamMove *aimCreateSpecialDefenseNoAdd(AITeam *team, bool8 wait, bool8 remove);
-AITeamMove *aimCreateDeleteTeamNoAdd(AITeam *team);
-AITeamMove *aimCreateKamikazeNoAdd(AITeam *team, SelectCommand *targets,TypeOfFormation formation, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateFormationNoAdd(struct AITeam *team, TypeOfFormation formationtype, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateFancyGetShipsNoAdd(struct AITeam *team, ShipType shiptype, sbyte num_ships, struct AlternativeShips *alternatives, sdword priority, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateSpecialNoAdd(struct AITeam *team, SelectCommand *targets, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateAttackNoAdd(struct AITeam *team, SelectCommand *targets, TypeOfFormation formation, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateAdvancedAttackNoAdd(struct AITeam *team, SelectCommand *target, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateFlankAttackNoAdd(struct AITeam *team, SelectCommand *targets, bool8 hyperspace, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateMoveAttackNoAdd(struct AITeam *team, SelectCommand *targets, bool Advanced, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateMoveTeamNoAdd(struct AITeam *team, vector destination, TypeOfFormation formation, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateMoveTeamIndexNoAdd(struct AITeam *team, vector destination, udword index, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateMoveTeamSplitNoAdd(struct AITeam *team, SelectCommand *ships, struct Path *destinations, TacticsType tactics, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateHyperspaceNoAdd(struct AITeam *team, vector destination, TypeOfFormation formation, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateInterceptNoAdd(struct AITeam *team, ShipPtr ship, real32 interval, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateMoveToNoAdd(struct AITeam *team, vector destination, real32 limiter, udword type, TypeOfFormation formation, TacticsType tactics, bool wait, bool remove);
+struct AITeamMove *aimCreateCountShipsNoAdd(struct AITeam *team, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateDockNoAdd(struct AITeam *team, sdword dockmoveFlags, ShipPtr dockAt, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateLaunchNoAdd(struct AITeam *team, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateGuardCooperatingTeamNoAdd(struct AITeam *team, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateDefendMothershipNoAdd(struct AITeam *team, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreatePatrolMoveNoAdd(struct AITeam *team, struct Path *path, udword startIndex, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateActivePatrolNoAdd(struct AITeam *team, udword patroltype, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateGetShipsNoAdd(struct AITeam *team, ShipType shiptype, sbyte num_ships, sdword priority, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateTempGuardNoAdd(struct AITeam *team, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateReinforceNoAdd(struct AITeam *team, struct AITeam *reinforceteam, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateSupportNoAdd(struct AITeam *team, SelectCommand *ships, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateActiveReconNoAdd(struct AITeam *team, bool EnemyRecon, TypeOfFormation formation,TacticsType tactics, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateShipReconNoAdd(struct AITeam *team, SelectCommand *ships, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateArmadaNoAdd(struct AITeam *team, TypeOfFormation formation, TacticsType tactics, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateControlResourcesNoAdd(struct AITeam *team, SelectCommand *ships, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateSwarmAttackNoAdd(struct AITeam *team, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateSwarmDefenseNoAdd(struct AITeam *team, SelectCommand *pods, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateResourceVolumeNoAdd(struct AITeam *team, Volume volume, bool8 strictVolume, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateActiveResourceNoAdd(struct AITeam *team, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateMothershipMove(struct AITeam *team, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateCaptureNoAdd(struct AITeam *team, ShipPtr ship, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateActiveCaptureNoAdd(struct AITeam *team, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateActiveMineNoAdd(struct AITeam *team, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateMineVolumeNoAdd(struct AITeam *team, Volume vol, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateSpecialDefenseNoAdd(struct AITeam *team, bool8 wait, bool8 remove);
+struct AITeamMove *aimCreateDeleteTeamNoAdd(struct AITeam *team);
+struct AITeamMove *aimCreateKamikazeNoAdd(struct AITeam *team, SelectCommand *targets,TypeOfFormation formation, bool8 wait, bool8 remove);
 
 /*=============================================================================
     Save Move Functions
 =============================================================================*/
 
-void aimFix_MoveDone(AITeamMove *move);
-void aimFix_GuardShips(AITeamMove *move);
-void aimFix_DefMoship(AITeamMove *move);
-void aimFix_TempGuard(AITeamMove *move);
-void aimFix_GetShips(AITeamMove *move);
-void aimFix_Formation(AITeamMove *move);
-void aimFix_MoveTeam(AITeamMove *move);
-void aimFix_MoveTeamIndex(AITeamMove *move);
-void aimFix_MoveTeamSplit(AITeamMove *move);
-void aimFix_Hyperspace(AITeamMove *move);
-void aimFix_Intercept(AITeamMove *move);
-void aimFix_MoveTo(AITeamMove *move);
-void aimFix_PatrolMove(AITeamMove *move);
-void aimFix_ActivePatrol(AITeamMove *move);
-void aimFix_ActiveRecon(AITeamMove *move);
-void aimFix_ShipRecon(AITeamMove *move);
-void aimFix_CountShips(AITeamMove *move);
-void aimFix_Special(AITeamMove *move);
-void aimFix_Attack(AITeamMove *move);
-void aimFix_AdvancedAttack(AITeamMove *move);
-void aimFix_FlankAttack(AITeamMove *move);
-void aimFix_MoveAttack(AITeamMove *move);
-void aimFix_HarassAttack(AITeamMove *move);
-void aimFix_FancyGetShips(AITeamMove *move);
-void aimFix_Dock(AITeamMove *move);
-void aimFix_Launch(AITeamMove *move);
-void aimFix_Reinforce(AITeamMove *move);
-void aimFix_VarSet(AITeamMove *move);
-void aimFix_VarInc(AITeamMove *move);
-void aimFix_VarDec(AITeamMove *move);
-void aimFix_VarWait(AITeamMove *move);
-void aimFix_VarDestroy(AITeamMove *move);
-void aimFix_GuardCoopTeam(AITeamMove *move);
-void aimFix_Support(AITeamMove *move);
-void aimFix_Armada(AITeamMove *move);
-void aimFix_ControlResources(AITeamMove *move);
-void aimFix_SwarmAttack(AITeamMove *move);
-void aimFix_SwarmDefense(AITeamMove *move);
-void aimFix_SwarmPod(AITeamMove *move);
-void aimFix_ResourceVolume(AITeamMove *move);
-void aimFix_DeleteTeam(AITeamMove *move);
-void aimFix_Capture(AITeamMove *move);
-void aimFix_ActiveCapture(AITeamMove *move);
-void aimFix_ActiveMine(AITeamMove *move);
-void aimFix_MineVolume(AITeamMove *move);
-void aimFix_SpecialDefense(AITeamMove *move);
-void aimFix_ActiveResource(AITeamMove *move);
-void aimFix_MothershipMove(AITeamMove *move);
-void aimFix_Kamikaze(AITeamMove *move);
-
-void aimLoad_GuardShips(AITeamMove *move);
-void aimLoad_DefMoship(AITeamMove *move);
-void aimLoad_PatrolMove(AITeamMove *move);
-void aimLoad_MoveTeamSplit(AITeamMove *move);
-void aimLoad_Special(AITeamMove *move);
-void aimLoad_Attack(AITeamMove *move);
-void aimLoad_AdvancedAttack(AITeamMove *move);
-void aimLoad_FlankAttack(AITeamMove *move);
-void aimLoad_MoveAttack(AITeamMove *move);
-void aimLoad_Dock(AITeamMove *move);
-void aimLoad_Support(AITeamMove *move);
-void aimLoad_ShipRecon(AITeamMove *move);
-void aimLoad_ControlResources(AITeamMove *move);
-void aimLoad_SwarmAttack(AITeamMove *move);
-void aimLoad_SwarmDefense(AITeamMove *move);
-void aimLoad_ResourceVolume(AITeamMove *move);
-void aimLoad_Kamikaze(AITeamMove *move);
-
-void aimSave_GuardShips(AITeamMove *move);
-void aimSave_DefMoship(AITeamMove *move);
-void aimSave_PatrolMove(AITeamMove *move);
-void aimSave_MoveTeamSplit(AITeamMove *move);
-void aimSave_Special(AITeamMove *move);
-void aimSave_Attack(AITeamMove *move);
-void aimSave_AdvancedAttack(AITeamMove *move);
-void aimSave_FlankAttack(AITeamMove *move);
-void aimSave_MoveAttack(AITeamMove *move);
-void aimSave_Dock(AITeamMove *move);
-void aimSave_Support(AITeamMove *move);
-void aimSave_ShipRecon(AITeamMove *move);
-void aimSave_ControlResources(AITeamMove *move);
-void aimSave_SwarmAttack(AITeamMove *move);
-void aimSave_SwarmDefense(AITeamMove *move);
-void aimSave_ResourceVolume(AITeamMove *move);
-void aimSave_Kamikaze(AITeamMove *move);
-
-void aimPreFix_Dock(AITeamMove *move);
-void aimPreFix_GetShips(AITeamMove *move);
-void aimPreFix_Intercept(AITeamMove *move);
-void aimPreFix_PatrolMove(AITeamMove *move);
-void aimPreFix_AdvancedAttack(AITeamMove *move);
-void aimPreFix_MoveAttack(AITeamMove *move);
-void aimPreFix_HarassAttack(AITeamMove *move);
-void aimPreFix_FancyGetShips(AITeamMove *move);
-void aimPreFix_Reinforce(AITeamMove *move);
+void aimFix_MoveDone(struct AITeamMove *move);
+void aimFix_GuardShips(struct AITeamMove *move);
+void aimFix_DefMoship(struct AITeamMove *move);
+void aimFix_TempGuard(struct AITeamMove *move);
+void aimFix_GetShips(struct AITeamMove *move);
+void aimFix_Formation(struct AITeamMove *move);
+void aimFix_MoveTeam(struct AITeamMove *move);
+void aimFix_MoveTeamIndex(struct AITeamMove *move);
+void aimFix_MoveTeamSplit(struct AITeamMove *move);
+void aimFix_Hyperspace(struct AITeamMove *move);
+void aimFix_Intercept(struct AITeamMove *move);
+void aimFix_MoveTo(struct AITeamMove *move);
+void aimFix_PatrolMove(struct AITeamMove *move);
+void aimFix_ActivePatrol(struct AITeamMove *move);
+void aimFix_ActiveRecon(struct AITeamMove *move);
+void aimFix_ShipRecon(struct AITeamMove *move);
+void aimFix_CountShips(struct AITeamMove *move);
+void aimFix_Special(struct AITeamMove *move);
+void aimFix_Attack(struct AITeamMove *move);
+void aimFix_AdvancedAttack(struct AITeamMove *move);
+void aimFix_FlankAttack(struct AITeamMove *move);
+void aimFix_MoveAttack(struct AITeamMove *move);
+void aimFix_HarassAttack(struct AITeamMove *move);
+void aimFix_FancyGetShips(struct AITeamMove *move);
+void aimFix_Dock(struct AITeamMove *move);
+void aimFix_Launch(struct AITeamMove *move);
+void aimFix_Reinforce(struct AITeamMove *move);
+void aimFix_VarSet(struct AITeamMove *move);
+void aimFix_VarInc(struct AITeamMove *move);
+void aimFix_VarDec(struct AITeamMove *move);
+void aimFix_VarWait(struct AITeamMove *move);
+void aimFix_VarDestroy(struct AITeamMove *move);
+void aimFix_GuardCoopTeam(struct AITeamMove *move);
+void aimFix_Support(struct AITeamMove *move);
+void aimFix_Armada(struct AITeamMove *move);
+void aimFix_ControlResources(struct AITeamMove *move);
+void aimFix_SwarmAttack(struct AITeamMove *move);
+void aimFix_SwarmDefense(struct AITeamMove *move);
+void aimFix_SwarmPod(struct AITeamMove *move);
+void aimFix_ResourceVolume(struct AITeamMove *move);
+void aimFix_DeleteTeam(struct AITeamMove *move);
+void aimFix_Capture(struct AITeamMove *move);
+void aimFix_ActiveCapture(struct AITeamMove *move);
+void aimFix_ActiveMine(struct AITeamMove *move);
+void aimFix_MineVolume(struct AITeamMove *move);
+void aimFix_SpecialDefense(struct AITeamMove *move);
+void aimFix_ActiveResource(struct AITeamMove *move);
+void aimFix_MothershipMove(struct AITeamMove *move);
+void aimFix_Kamikaze(struct AITeamMove *move);
+
+void aimLoad_GuardShips(struct AITeamMove *move);
+void aimLoad_DefMoship(struct AITeamMove *move);
+void aimLoad_PatrolMove(struct AITeamMove *move);
+void aimLoad_MoveTeamSplit(struct AITeamMove *move);
+void aimLoad_Special(struct AITeamMove *move);
+void aimLoad_Attack(struct AITeamMove *move);
+void aimLoad_AdvancedAttack(struct AITeamMove *move);
+void aimLoad_FlankAttack(struct AITeamMove *move);
+void aimLoad_MoveAttack(struct AITeamMove *move);
+void aimLoad_Dock(struct AITeamMove *move);
+void aimLoad_Support(struct AITeamMove *move);
+void aimLoad_ShipRecon(struct AITeamMove *move);
+void aimLoad_ControlResources(struct AITeamMove *move);
+void aimLoad_SwarmAttack(struct AITeamMove *move);
+void aimLoad_SwarmDefense(struct AITeamMove *move);
+void aimLoad_ResourceVolume(struct AITeamMove *move);
+void aimLoad_Kamikaze(struct AITeamMove *move);
+
+void aimSave_GuardShips(struct AITeamMove *move);
+void aimSave_DefMoship(struct AITeamMove *move);
+void aimSave_PatrolMove(struct AITeamMove *move);
+void aimSave_MoveTeamSplit(struct AITeamMove *move);
+void aimSave_Special(struct AITeamMove *move);
+void aimSave_Attack(struct AITeamMove *move);
+void aimSave_AdvancedAttack(struct AITeamMove *move);
+void aimSave_FlankAttack(struct AITeamMove *move);
+void aimSave_MoveAttack(struct AITeamMove *move);
+void aimSave_Dock(struct AITeamMove *move);
+void aimSave_Support(struct AITeamMove *move);
+void aimSave_ShipRecon(struct AITeamMove *move);
+void aimSave_ControlResources(struct AITeamMove *move);
+void aimSave_SwarmAttack(struct AITeamMove *move);
+void aimSave_SwarmDefense(struct AITeamMove *move);
+void aimSave_ResourceVolume(struct AITeamMove *move);
+void aimSave_Kamikaze(struct AITeamMove *move);
+
+void aimPreFix_Dock(struct AITeamMove *move);
+void aimPreFix_GetShips(struct AITeamMove *move);
+void aimPreFix_Intercept(struct AITeamMove *move);
+void aimPreFix_PatrolMove(struct AITeamMove *move);
+void aimPreFix_AdvancedAttack(struct AITeamMove *move);
+void aimPreFix_MoveAttack(struct AITeamMove *move);
+void aimPreFix_HarassAttack(struct AITeamMove *move);
+void aimPreFix_FancyGetShips(struct AITeamMove *move);
+void aimPreFix_Reinforce(struct AITeamMove *move);
 
 #endif
diff -urPw homeworld-orig/src/Game/AIOrders2.c.h homeworld_sdl-0.3/src/Game/AIOrders2.c.h
--- homeworld-orig/src/Game/AIOrders2.c.h	2002-09-04 12:46:02.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AIOrders2.c.h	2004-08-01 22:35:34.000000000 -0700
@@ -1,7 +1,7 @@
 
-#include "types.h"
-#include "spaceobj.h"
-#include "stats.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "Stats.h"
 #include "AIPlayer.h"
 #include "AIUtilities.h"
 #include "CommandLayer.h"
diff -urPw homeworld-orig/src/Game/AIOrders.c homeworld_sdl-0.3/src/Game/AIOrders.c
--- homeworld-orig/src/Game/AIOrders.c	2002-09-04 12:46:02.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AIOrders.c	2004-08-01 22:35:21.000000000 -0700
@@ -1,17 +1,17 @@
 
-#include "types.h"
-#include "fastmath.h"
+#include "Types.h"
+#include "FastMath.h"
 #include "AIOrders.h"
 #include "AITeam.h"
 #include "AIMoves.h"
-#include "shipselect.h"
-#include "debug.h"
+#include "ShipSelect.h"
+#include "Debug.h"
 #include "AIUtilities.h"
 #include "AIPlayer.h"
 #include "AIEvents.h"
 #include "AIHandler.h"
 #include "CommandWrap.h"
-#include "randy.h"
+#include "Randy.h"
 #include "GravWellGenerator.h"
 
 /*=============================================================================
@@ -770,6 +770,6 @@
 //
 //  temporary contention relief
 //
-#include "AIOrders2.c"  // Gary
+#include "AIOrders2.c.h"  // Gary
 
 
diff -urPw homeworld-orig/src/Game/AIOrders.h homeworld_sdl-0.3/src/Game/AIOrders.h
--- homeworld-orig/src/Game/AIOrders.h	2002-09-04 12:46:02.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AIOrders.h	2004-08-01 22:35:22.000000000 -0700
@@ -1,9 +1,9 @@
 #ifndef __AIORDERS_H
 #define __AIORDERS_H
 
-#include "types.h"
-#include "shipselect.h"
-#include "aiUtilities.h"
+#include "Types.h"
+#include "ShipSelect.h"
+#include "AIUtilities.h"
 
 /*=============================================================================
     Constant Definitions:
diff -urPw homeworld-orig/src/Game/AIPlayer.c homeworld_sdl-0.3/src/Game/AIPlayer.c
--- homeworld-orig/src/Game/AIPlayer.c	2002-09-04 12:46:02.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AIPlayer.c	2004-08-01 22:35:36.000000000 -0700
@@ -8,20 +8,20 @@
 
 #include <stdarg.h>
 #include <string.h>
-#include "types.h"
-#include "Objtypes.h"
+#include "Types.h"
+#include "ObjTypes.h"
 #include "AIPlayer.h"
-#include "file.h"
-#include "universe.h"
-#include "select.h"
+#include "File.h"
+#include "Universe.h"
+#include "Select.h"
 #include "AIFleetMan.h"
 #include "AIAttackMan.h"
 #include "AIDefenseMan.h"
 #include "AIUtilities.h"
 #include "AITeam.h"
-#include "stats.h"
-#include "randy.h"
-#include "nis.h"
+#include "Stats.h"
+#include "Randy.h"
+#include "NIS.h"
 #include "SaveGame.h"
 #include "SinglePlayer.h"
 
@@ -474,7 +474,7 @@
     sdword players[MAX_MULTIPLAYER_PLAYERS][MAX_MULTIPLAYER_PLAYERS],
            bigots[MAX_MULTIPLAYER_PLAYERS],
            normcomp[MAX_MULTIPLAYER_PLAYERS];
-    udword humancnt = 0, bigotcnt = 0, normcnt = 0;
+    udword bigotcnt = 0, normcnt = 0;
     udword numbigotsperhuman, numbigotsleftover, numloops, numcompenemies;
     udword slot, i, j;
     sdword giveup;
@@ -1236,7 +1236,7 @@
 //  return 1 if the ship isn't on any team of the aiplayer
 //  return 0 otherwise
 //
-static ShipNotOnTeam(AIPlayer *aiplayer, Ship *ship)
+static int ShipNotOnTeam(AIPlayer *aiplayer, Ship *ship)
 {
     sdword i, j;
     AITeam *teamp;
@@ -1581,7 +1581,7 @@
     RequestShips copyOfRequest;
 
     memcpy(&copyOfRequest,stuff,sizeof(RequestShips));
-    copyOfRequest.creator = (sdword)SpaceObjRegistryGetID((SpaceObj *)copyOfRequest.creator);
+    copyOfRequest.creator = (ShipPtr)SpaceObjRegistryGetID((SpaceObj *)copyOfRequest.creator);
 
     SaveStructureOfSize(&copyOfRequest,sizeof(RequestShips));
 }
@@ -1594,7 +1594,7 @@
     chunk = CreateChunk(BASIC_STRUCTURE,sizeof(TeamWaitingForTheseShips),stuff);
     sc = (TeamWaitingForTheseShips *)chunkContents(chunk);
 
-    sc->team = AITeamToTeamIndex(sc->team);
+    sc->team = (AITeam*)AITeamToTeamIndex(sc->team);
 
     SaveThisChunk(chunk);
     memFree(chunk);
@@ -1631,33 +1631,33 @@
     chunk = CreateChunk(BASIC_STRUCTURE|AIPLAYER,sizeof(AIPlayer),aiplayer);
     sc = chunkContents(chunk);
 
-    sc->player = SavePlayerToPlayerIndex(aiplayer->player);
-    sc->primaryEnemyPlayer = SavePlayerToPlayerIndex(aiplayer->primaryEnemyPlayer);
+    sc->player = (Player*)SavePlayerToPlayerIndex(aiplayer->player);
+    sc->primaryEnemyPlayer = (Player*)SavePlayerToPlayerIndex(aiplayer->primaryEnemyPlayer);
 
     for (i=0;i<aiplayer->numSupportTeams;i++)
     {
-        sc->supportTeam[i] = AITeamToTeamIndex(aiplayer->supportTeam[i]);
+        sc->supportTeam[i] = (AITeam*)AITeamToTeamIndex(aiplayer->supportTeam[i]);
     }
 
     for (i=0;i<AIPLAYER_NUM_RECONTEAMS;i++)
     {
-        sc->reconTeam[i] = AITeamToTeamIndex(aiplayer->reconTeam[i]);
+        sc->reconTeam[i] = (AITeam*)AITeamToTeamIndex(aiplayer->reconTeam[i]);
     }
 
-    sc->harassTeam = AITeamToTeamIndex(aiplayer->harassTeam);
+    sc->harassTeam = (AITeam*)AITeamToTeamIndex(aiplayer->harassTeam);
 
     for (i=0;i<AIPLAYER_NUM_ATTACKTEAMS;i++)
     {
-        sc->attackTeam[i] = AITeamToTeamIndex(aiplayer->attackTeam[i]);
+        sc->attackTeam[i] = (AITeam*)AITeamToTeamIndex(aiplayer->attackTeam[i]);
     }
 
     for (i=0;i<aiplayer->numGuardTeams;i++)
     {
-        sc->guardTeams[i] = AITeamToTeamIndex(aiplayer->guardTeams[i]);
+        sc->guardTeams[i] = (AITeam*)AITeamToTeamIndex(aiplayer->guardTeams[i]);
     }
 
-    sc->ScriptCreator = (sdword)SpaceObjRegistryGetID((SpaceObj *)aiplayer->ScriptCreator);
-    sc->AICreator     = (sdword)SpaceObjRegistryGetID((SpaceObj *)aiplayer->AICreator);
+    sc->ScriptCreator = (ShipPtr)SpaceObjRegistryGetID((SpaceObj *)aiplayer->ScriptCreator);
+    sc->AICreator     = (ShipPtr)SpaceObjRegistryGetID((SpaceObj *)aiplayer->AICreator);
 
     SaveThisChunk(chunk);
     memFree(chunk);
diff -urPw homeworld-orig/src/Game/AIPlayer.h homeworld_sdl-0.3/src/Game/AIPlayer.h
--- homeworld-orig/src/Game/AIPlayer.h	2002-09-04 12:46:02.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AIPlayer.h	2004-08-01 22:35:36.000000000 -0700
@@ -9,9 +9,9 @@
 #ifndef __AIPlayer_H
 #define __AIPlayer_H
 
-#include "types.h"
-#include "objtypes.h"
-#include "universe.h"
+#include "Types.h"
+#include "ObjTypes.h"
+#include "Universe.h"
 #include "AIResourceMan.h"
 #include "AIAttackMan.h"
 #include "AIVar.h"
@@ -405,7 +405,7 @@
 void aiplayerShutdown(void);
 
 #ifndef HW_Release
-#define aiplayerLog(x)    aiplayerDebugLog##x
+#define aiplayerLog(x)    aiplayerDebugLog x
 #else
 #define aiplayerLog(x)    {;}
 #endif
@@ -427,6 +427,8 @@
     Save Game stuff
 =============================================================================*/
 
+struct Path;
+
 void aiplayerSave(void);
 void aiplayerLoad(void);
 
diff -urPw homeworld-orig/src/Game/AIResourceMan.c homeworld_sdl-0.3/src/Game/AIResourceMan.c
--- homeworld-orig/src/Game/AIResourceMan.c	2002-09-04 12:46:02.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AIResourceMan.c	2004-08-01 22:35:23.000000000 -0700
@@ -6,11 +6,11 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "spaceobj.h"
-#include "universe.h"
-#include "univupdate.h"
-#include "rescollect.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "Universe.h"
+#include "UnivUpdate.h"
+#include "ResCollect.h"
 #include "CommandWrap.h"
 #include "AIResourceMan.h"
 #include "AIPlayer.h"
@@ -19,11 +19,11 @@
 #include "AITeam.h"
 #include "AIUtilities.h"
 #include "AIDefenseMan.h"
-#include "select.h"
-#include "blobs.h"
-#include "consMgr.h"
+#include "Select.h"
+#include "Blobs.h"
+#include "ConsMgr.h"
 #include "MultiplayerGame.h"
-#include "randy.h"
+#include "Randy.h"
 
 udword UPDATE_RU_COUNT_RATE = 3;
 
@@ -99,7 +99,6 @@
 
         numRUs += resource->resourcevalue;
 
-nextnode:
         objnode = objnode->next;
     }
 
diff -urPw homeworld-orig/src/Game/AIResourceMan.h homeworld_sdl-0.3/src/Game/AIResourceMan.h
--- homeworld-orig/src/Game/AIResourceMan.h	2002-09-04 12:46:02.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AIResourceMan.h	2004-08-01 22:35:23.000000000 -0700
@@ -8,8 +8,10 @@
 #ifndef ___AIRESOURCEMAN_H
 #define ___AIRESOURCEMAN_H
 
-#include "types.h"
-#include "shipselect.h"
+#include "Types.h"
+#include "ShipSelect.h"
+
+struct AITeam;
 
 void airResourceManager(void);
 
diff -urPw homeworld-orig/src/Game/AIShip.c homeworld_sdl-0.3/src/Game/AIShip.c
--- homeworld-orig/src/Game/AIShip.c	2002-09-04 12:46:02.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AIShip.c	2004-08-01 22:35:30.000000000 -0700
@@ -15,24 +15,24 @@
 #include <stdlib.h>
 #include <stdio.h>
 #include <string.h>
-#include "types.h"
-#include "vector.h"
-#include "matrix.h"
-#include "fastmath.h"
-#include "debug.h"
-#include "spaceobj.h"
-#include "physics.h"
-#include "aitrack.h"
-#include "aiship.h"
-#include "statscript.h"
-#include "universe.h"
-#include "ships.h"
-#include "univupdate.h"
-#include "collision.h"
-#include "blobs.h"
-#include "tactics.h"
-#include "alliance.h"
-#include "randy.h"
+#include "Types.h"
+#include "Vector.h"
+#include "Matrix.h"
+#include "FastMath.h"
+#include "Debug.h"
+#include "SpaceObj.h"
+#include "Physics.h"
+#include "AITrack.h"
+#include "AIShip.h"
+#include "StatScript.h"
+#include "Universe.h"
+#include "Ships.h"
+#include "UnivUpdate.h"
+#include "Collision.h"
+#include "Blobs.h"
+#include "Tactics.h"
+#include "Alliance.h"
+#include "Randy.h"
 #include "ProfileTimers.h"
 
 #ifdef gshaw
@@ -470,9 +470,9 @@
     matGetVectFromMatrixCol2(right,obj->rotinfo.coordsys);
     matGetVectFromMatrixCol3(heading,obj->rotinfo.coordsys);
 
-    upcomp = abs(vecDotProduct(up,dir));
-    rightcomp = abs(vecDotProduct(right,dir));
-    headingcomp = abs(vecDotProduct(heading,dir));
+    upcomp = ABS(vecDotProduct(up,dir));
+    rightcomp = ABS(vecDotProduct(right,dir));
+    headingcomp = ABS(vecDotProduct(heading,dir));
 
     return (upcomp*collInfo->uplength + rightcomp*collInfo->rightlength + headingcomp*collInfo->forwardlength)*0.5f;
 }
@@ -1007,7 +1007,7 @@
                     real32 xdistanceleft = (destination->x - ship->posinfo.position.x);
                     real32 ydistanceleft = (destination->y - ship->posinfo.position.y);
                     real32 r;
-                    zdistanceleft = abs(destination->z - ship->posinfo.position.z);
+                    zdistanceleft = ABS(destination->z - ship->posinfo.position.z);
                     r = fsqrt(xdistanceleft*xdistanceleft + ydistanceleft*ydistanceleft);
                     if ((zdistanceleft < MIN_DIST_FOR_FANCY_DESCEND) ||
                         (zdistanceleft < (r*MIN_ANGLE_FOR_FANCY_DESCEND)))
@@ -1262,7 +1262,7 @@
 
                 maxdistconsider = avoidcollpad + shiprowcollpad;
 
-                if (abs(distcheck) > maxdistconsider)
+                if (ABS(distcheck) > maxdistconsider)
                 {
                     goto nextnode;
                 }
@@ -1398,7 +1398,7 @@
 
                 maxdistconsider = avoidcollpad + shipcollpad;
 
-                if (abs(distcheck) > maxdistconsider)
+                if (ABS(distcheck) > maxdistconsider)
                 {
                     goto nextnode;
                 }
@@ -1764,7 +1764,7 @@
                     // calculate normalize distance left
                     if ((destination) && (ship->aidescend != 0.0f))
                     {
-                        zdistanceleft = (destination->z - ship->posinfo.position.z) * abs(ship->aidescend);
+                        zdistanceleft = (destination->z - ship->posinfo.position.z) * ABS(ship->aidescend);
                         pitchtodescend = getPitchToDescend(zdistanceleft,shipstaticinfo->pitchdescend);
 #if DEBUG_AISHIP
                         dbgMessagef("\nzdistanceleft: %f pitchtodescend: %f",zdistanceleft,pitchtodescend);
@@ -2215,7 +2215,7 @@
 {
     blob *MyBlob;
     SelectCommand *shipselection;
-    sdword shipindex = 0;
+    //sdword shipindex = 0;
     Ship *ship;
     Ship *ShiptoRecieveShitPounding = NULL;
     //real32 distanceSqr;
@@ -2342,6 +2342,8 @@
             case OBJ_NebulaType:
             case OBJ_DustType:
                 mine->target = NULL;
+            default:
+                break;
         }
     }
 
diff -urPw homeworld-orig/src/Game/AIShip.h homeworld_sdl-0.3/src/Game/AIShip.h
--- homeworld-orig/src/Game/AIShip.h	2002-09-04 12:46:02.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AIShip.h	2004-08-01 22:35:31.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef AISHIP_H
 #define AISHIP_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Defines:
@@ -60,10 +60,10 @@
 =============================================================================*/
 
 #define aishipFlyToPointAvoidingObjs(shp,dst,flags,limitv) aishipFlyToPointAvoidingObjsFunc(shp,dst,flags,limitv,NULL)
-#define aishipFlyToShipAvoidingObjs(shp,targ,flags,limitv) aishipFlyToPointAvoidingObjsFunc(shp,&((targ)##->posinfo.position),flags,limitv,NULL)
+#define aishipFlyToShipAvoidingObjs(shp,targ,flags,limitv) aishipFlyToPointAvoidingObjsFunc(shp,&((targ)->posinfo.position),flags,limitv,NULL)
 
 #define aishipFlyToPointAvoidingObjsWithVel(shp,dst,flags,limitv,withvel) aishipFlyToPointAvoidingObjsFunc(shp,dst,flags,limitv,withvel)
-#define aishipFlyToShipAvoidingObjsWithVel(shp,targ,flags,limitv,withvel) aishipFlyToPointAvoidingObjsFunc(shp,&((targ)##->posinfo.position),flags,limitv,withvel)
+#define aishipFlyToShipAvoidingObjsWithVel(shp,targ,flags,limitv,withvel) aishipFlyToPointAvoidingObjsFunc(shp,&((targ)->posinfo.position),flags,limitv,withvel)
 
 /*=============================================================================
     Data:
diff -urPw homeworld-orig/src/Game/AITeam.c homeworld_sdl-0.3/src/Game/AITeam.c
--- homeworld-orig/src/Game/AITeam.c	2002-09-04 12:46:02.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AITeam.c	2004-08-01 22:35:23.000000000 -0700
@@ -13,17 +13,17 @@
 #include "AIDefenseMan.h"
 #include "AIHandler.h"
 #include "CommandWrap.h"
-#include "memory.h"
-#include "universe.h"
-#include "types.h"
-#include "shipselect.h"
-#include "spaceobj.h"
+#include "Memory.h"
+#include "Universe.h"
+#include "Types.h"
+#include "ShipSelect.h"
+#include "SpaceObj.h"
 #include "AIPlayer.h"
 #include "AIFleetMan.h"
 #include "AIEvents.h"
 #include "SaveGame.h"
 #include "AIMoves.h"
-#include "kas.h"
+#include "KAS.h"
 #include "Tactics.h"
 #include "GravWellGenerator.h"
 
diff -urPw homeworld-orig/src/Game/AITeam.h homeworld_sdl-0.3/src/Game/AITeam.h
--- homeworld-orig/src/Game/AITeam.h	2002-09-04 12:46:02.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AITeam.h	2004-08-01 22:35:23.000000000 -0700
@@ -9,14 +9,14 @@
 #ifndef __AITEAM_H
 #define __AITEAM_H
 
-#include "types.h"
-#include "spaceobj.h"
-#include "shipselect.h"
-#include "aievents.h"
-#include "formation.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "ShipSelect.h"
+#include "AIEvents.h"
+#include "Formation.h"
 #include "FormationDefs.h"
 #include "AIVar.h"
-#include "vector.h"
+#include "Vector.h"
 #include "AIUtilities.h"
 #include "KAS.h"
 #include "Volume.h"
@@ -139,18 +139,18 @@
 } AlternativeShips;
 
 #define SetNumAlternatives(alt,num) \
-    alt##.numNextPicks = num;   \
-    alt##.alternativeFlags = 0; \
-    dbgAssert(num <= MAX_NUM_ALTERNATIVES);
+    (alt).numNextPicks = (num);   \
+    (alt).alternativeFlags = 0; \
+    dbgAssert((num) <= MAX_NUM_ALTERNATIVES);
 
 #define SetNumAlternativesFlags(alt,num,flags) \
-    alt##.numNextPicks = num;   \
-    alt##.alternativeFlags = flags; \
-    dbgAssert(num <= MAX_NUM_ALTERNATIVES);
+    (alt).numNextPicks = (num);   \
+    (alt).alternativeFlags = (flags); \
+    dbgAssert((num) <= MAX_NUM_ALTERNATIVES);
 
 #define SetAlternative(alt,index,stype,equivnum) \
-    alt##.shipTypeNextPicks[index] = (sbyte)stype;  \
-    alt##.shipNumEquivNextPicks[index] = equivnum;
+    (alt).shipTypeNextPicks[index] = (sbyte)(stype);  \
+    (alt).shipNumEquivNextPicks[index] = (equivnum);
 
 typedef struct {
     char varName[AIVAR_LABEL_MAX_LENGTH+1];
@@ -484,23 +484,23 @@
     Macros:
 =============================================================================*/
 #define InitNewMove(newMove,movetype,waitflag,removeflag,form,tactic,moveprocessfunc,moveshipdiedfunc,moveclosefunc)    \
-    newMove##->type                     = movetype;               \
-    newMove##->processing               = FALSE;                  \
-    newMove##->wait                     = waitflag;               \
-    newMove##->remove                   = removeflag;             \
-    newMove##->formation                = form;                   \
+    (newMove)->type                     = (movetype);             \
+    (newMove)->processing               = FALSE;                  \
+    (newMove)->wait                     = (waitflag);             \
+    (newMove)->remove                   = (removeflag);           \
+    (newMove)->formation                = (form);                 \
     dbgAssert(tactic >= 0);                                       \
     dbgAssert(tactic < NUM_TACTICS_TYPES);                        \
-    newMove##->tactics                  = tactic;                 \
-    newMove##->processFunction          = moveprocessfunc;        \
-    newMove##->moveShipDiedFunction     = moveshipdiedfunc;       \
-    newMove##->moveCloseFunction        = moveclosefunc;          \
+    (newMove)->tactics                  = (tactic);               \
+    (newMove)->processFunction          = (moveprocessfunc);      \
+    (newMove)->moveShipDiedFunction     = (moveshipdiedfunc);     \
+    (newMove)->moveCloseFunction        = (moveclosefunc);        \
     aieHandlersClear(newMove)
 
 #define FixMoveFuncPtrs(move,moveprocessfunc,moveshipdiedfunc,moveclosefunc)     \
-    move##->processFunction          = moveprocessfunc;        \
-    move##->moveShipDiedFunction     = moveshipdiedfunc;       \
-    move##->moveCloseFunction        = moveclosefunc
+    (move)->processFunction          = (moveprocessfunc);      \
+    (move)->moveShipDiedFunction     = (moveshipdiedfunc);     \
+    (move)->moveCloseFunction        = (moveclosefunc)
 
 #define aitApproxTeamPos(team)          ((team)->shipList.selection->ShipPtr[0]->posinfo.position)
 #define aitNumTeamShips(team)           ((team)->shipList.selection->numShips)
diff -urPw homeworld-orig/src/Game/AITrack.c homeworld_sdl-0.3/src/Game/AITrack.c
--- homeworld-orig/src/Game/AITrack.c	2002-09-04 12:46:02.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AITrack.c	2004-08-01 22:35:19.000000000 -0700
@@ -8,17 +8,17 @@
 =============================================================================*/
 
 #include <math.h>
-#include "types.h"
-#include "debug.h"
-#include "vector.h"
-#include "matrix.h"
-#include "fastmath.h"
-#include "physics.h"
-#include "spaceobj.h"
-#include "AItrack.h"
-#include "statscript.h"
-#include "universe.h"
-#include "aiship.h"
+#include "Types.h"
+#include "Debug.h"
+#include "Vector.h"
+#include "Matrix.h"
+#include "FastMath.h"
+#include "Physics.h"
+#include "SpaceObj.h"
+#include "AITrack.h"
+#include "StatScript.h"
+#include "Universe.h"
+#include "AIShip.h"
 
 #ifdef gshaw
 #define DEBUG_AITRACK 0
@@ -730,7 +730,7 @@
         return TRUE;     // heading close enough to desired heading, so return
     }
 
-    actualpitchturn = (1.0f - abs(dotprodheading)) * pitchturn;
+    actualpitchturn = (1.0f - ABS(dotprodheading)) * pitchturn;
 
     if (pitchdescend < 0.0f)
     {
@@ -1381,9 +1381,9 @@
 ----------------------------------------------------------------------------*/
 real32 MoveLeftToGo(Ship *ship,vector *destination)
 {
-    real32 absx = abs(destination->x - ship->posinfo.position.x);
-    real32 absy = abs(destination->y - ship->posinfo.position.y);
-    real32 absz = abs(destination->z - ship->posinfo.position.z);
+    real32 absx = ABS(destination->x - ship->posinfo.position.x);
+    real32 absy = ABS(destination->y - ship->posinfo.position.y);
+    real32 absz = ABS(destination->z - ship->posinfo.position.z);
 
     return max(max(absx,absy),absz);
 }
diff -urPw homeworld-orig/src/Game/AITrack.h homeworld_sdl-0.3/src/Game/AITrack.h
--- homeworld-orig/src/Game/AITrack.h	2002-09-04 12:46:02.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AITrack.h	2004-08-01 22:35:19.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef _AITRACK_H
 #define _AITRACK_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Defines:
diff -urPw homeworld-orig/src/Game/AIUtilities.c homeworld_sdl-0.3/src/Game/AIUtilities.c
--- homeworld-orig/src/Game/AIUtilities.c	2002-09-04 12:46:02.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AIUtilities.c	2004-08-01 22:35:27.000000000 -0700
@@ -15,19 +15,19 @@
 #include "AITeam.h"
 #include "AIHandler.h"
 #include "CommandWrap.h"
-#include "fastmath.h"
-#include "randy.h"
-#include "select.h"
-#include "spaceobj.h"
-#include "shipdefs.h"
-#include "shipselect.h"
-#include "stats.h"
+#include "FastMath.h"
+#include "Randy.h"
+#include "Select.h"
+#include "SpaceObj.h"
+#include "ShipDefs.h"
+#include "ShipSelect.h"
+#include "Stats.h"
 #include "AIMoves.h"
 #include "ProximitySensor.h"
 #include "Tactics.h"
-#include "collision.h"
-#include "alliance.h"
-#include "aiship.h"
+#include "Collision.h"
+#include "Alliance.h"
+#include "AIShip.h"
 
 //later put this into the scripts
 #define AIU_MOTHERSHIP_VALUE    5500
@@ -552,7 +552,7 @@
 ----------------------------------------------------------------------------*/
 ShipPtr aiuTakeoutShipType(SelectCommand *selection, struct AITeam *team, ShipType type)
 {
-    real32 dist = REALlyBig, tempdist;
+    real32 tempdist;
     ShipPtr InvaderShip, ChosenShip = NULL;
     vector teamPos = team->shipList.selection->ShipPtr[0]->posinfo.position;
 
@@ -1781,7 +1781,6 @@
 bool aiuShipIsLargeVulnerableGoodGuy(ShipPtr ship)
 {
     ShipType shiptype = ship->shiptype;
-    ShipClass shipclass = ship->staticinfo->shipclass;
 
     if ((ship->playerowner == aiCurrentAIPlayer->player) &&
         ((shiptype == AdvanceSupportFrigate) ||
@@ -1809,7 +1808,6 @@
     udword i, j;
     vector ship_pos = ship->posinfo.position;
     real32 dist, tempdist;
-    bool done = FALSE;
 
     //initialize structures
     targets = (SelectCommand *)memAlloc(sizeofSelectCommand(aiuGoodGuyBlobs->numBlobs), "cvggs", 0);
@@ -2050,7 +2048,6 @@
 ----------------------------------------------------------------------------*/
 SelectCommand *aiuFindNearbyEnemyShips(Ship *primarytarget,real32 range)
 {
-    blob *myblob = primarytarget->collMyBlob;
     SelectCommand *enemyShips;
     MaxSelection tempShips;
     Ship *ship = getShipNearObjTok((SpaceObjRotImpTarg *)primarytarget, range);
@@ -2945,7 +2942,7 @@
 ----------------------------------------------------------------------------*/
 Resource *aiuFindBestResource(Resource **biggestResource, ShipPtr ship, ResourceSelection *resources)
 {
-    udword ResourceRoom, i, best_resValue = 0, biggest_resValue = 0;
+    udword ResourceRoom, i, biggest_resValue = 0; //, best_resValue = 0;
     real32 distsq, shortest_distsq = REALlyBig;
     Resource *best_resource = NULL;
     vector shippos = ship->posinfo.position;
diff -urPw homeworld-orig/src/Game/AIUtilities.h homeworld_sdl-0.3/src/Game/AIUtilities.h
--- homeworld-orig/src/Game/AIUtilities.h	2002-09-04 12:46:02.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AIUtilities.h	2004-08-01 22:35:28.000000000 -0700
@@ -8,13 +8,13 @@
 #ifndef ___AIUTILITIES_H
 #define ___AIUTILITIES_H
 
-#include "types.h"
-#include "spaceobj.h"
-#include "blobs.h"
-#include "memory.h"
-#include "vector.h"
-#include "universe.h"
-#include "volume.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "Blobs.h"
+#include "Memory.h"
+#include "Vector.h"
+#include "Universe.h"
+#include "Volume.h"
 
 bool ShipAlreadyHyperspaceOut(Ship *ship);      // don't include singleplayer.h, just this
 
@@ -141,6 +141,8 @@
 /*-----------------------------------------------------------------------------
     Ship Related Utility Functions:
 -----------------------------------------------------------------------------*/
+struct AITeam;
+
 //rescues (reinforces) a certain ship
 bool aiuRescueShip(ShipPtr ship, struct AITeam *team);
 
diff -urPw homeworld-orig/src/Game/AIVar.c homeworld_sdl-0.3/src/Game/AIVar.c
--- homeworld-orig/src/Game/AIVar.c	2002-09-04 12:46:02.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AIVar.c	2004-08-01 22:35:18.000000000 -0700
@@ -1,9 +1,9 @@
 #include <stdlib.h>
 #include <string.h>
 #include <stdio.h>
-#include "types.h"
-#include "memory.h"
-#include "debug.h"
+#include "Types.h"
+#include "Memory.h"
+#include "Debug.h"
 #include "SaveGame.h"
 #include "AIVar.h"
 
@@ -163,7 +163,7 @@
 {
     label[0] = '_';
     label[1] = 'V';
-    _itoa(uniqueNum, &label[2], 10 );
+    sprintf(&label[2], "%d", uniqueNum);
     uniqueNum++;
     return label;
 }
diff -urPw homeworld-orig/src/Game/AIVar.h homeworld_sdl-0.3/src/Game/AIVar.h
--- homeworld-orig/src/Game/AIVar.h	2002-09-04 12:46:02.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AIVar.h	2004-08-01 22:35:19.000000000 -0700
@@ -1,7 +1,7 @@
 #ifndef __AIVAR_H
 #define __AIVAR_H
 
-#include "types.h"
+#include "Types.h"
 
 //
 //  general purpose AI variable stuff (can be used as flags, counters, etc.)
diff -urPw homeworld-orig/src/Game/Alliance.c homeworld_sdl-0.3/src/Game/Alliance.c
--- homeworld-orig/src/Game/Alliance.c	2002-09-04 12:46:02.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Alliance.c	2004-08-01 22:35:35.000000000 -0700
@@ -8,15 +8,15 @@
 
 #include <stdio.h>
 #include "Alliance.h"
-#include "gamechat.h"
-#include "chatting.h"
+#include "GameChat.h"
+#include "Chatting.h"
 #include "utility.h"
-#include "universe.h"
-#include "commandnetwork.h"
-#include "commandlayer.h"
-#include "commandwrap.h"
-#include "strings.h"
-#include "soundevent.h"
+#include "Universe.h"
+#include "CommandNetwork.h"
+#include "CommandLayer.h"
+#include "CommandWrap.h"
+#include "Strings.h"
+#include "SoundEvent.h"
 
 /*=============================================================================
     Data:
@@ -168,6 +168,7 @@
             }
         }
         break;
+        */
         /* //obsolete Now
         case ALLIANCE_RUTRANSFER:
             universe.players[sigsPlayerIndex].resourceUnits += packet->data;
diff -urPw homeworld-orig/src/Game/Alliance.h homeworld_sdl-0.3/src/Game/Alliance.h
--- homeworld-orig/src/Game/Alliance.h	2002-09-04 12:46:02.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Alliance.h	2004-08-01 22:35:35.000000000 -0700
@@ -15,6 +15,10 @@
 #define ALLIANCE_FORMNEWALLIANCE    1
 #define ALLIANCE_BREAKALLIANCE      2
 
+struct ChatPacket;
+struct Ship;
+struct Player;
+
 void allianceFormWith(udword playerindex);
 void allianceBreakWith(udword playerindex);
 void allianceFormRequestRecievedCB(struct ChatPacket *packet);
diff -urPw homeworld-orig/src/Game/Animatic.c homeworld_sdl-0.3/src/Game/Animatic.c
--- homeworld-orig/src/Game/Animatic.c	2002-09-04 12:46:02.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Animatic.c	2004-08-01 22:35:26.000000000 -0700
@@ -9,25 +9,45 @@
 #include <stdio.h>
 #include "glinc.h"
 #include "main.h"
-#include "memory.h"
-#include "bink.h"
+#include "Memory.h"
+/*#include "bink.h"*/
 #include "render.h"
-#include "file.h"
-#include "debug.h"
-#include "animatic.h"
-#include "nis.h"
-#include "tutor.h"
-#include "subtitle.h"
-#include "universe.h"
+#include "File.h"
+#include "Debug.h"
+#include "Animatic.h"
+#include "NIS.h"
+#include "Tutor.h"
+#include "Subtitle.h"
+#include "Universe.h"
 #include "mouse.h"
-#include "soundevent.h"
+#include "SoundEvent.h"
 #include "soundlow.h"
 #include "sstglide.h"
 #include "glcaps.h"
 #include "glcompat.h"
-#include "strings.h"
+#include "Strings.h"
 
+sdword animaticJustPlayed = 0;
+
+/* TC 2003-10-01:
+ * The animStartup(), animShutdown(), and animBinkPlay() have been replaced
+ * with dummy versions (after the block ignored by #if 0) so the game code can
+ * stay the same. */
+// LMOP: 20040508
+// Whilst the Linux folks want to zap most of this file for the moment and replace
+// the original code with dummy functions (see above), the MacOSX folks don't.
+// Please replace with a suitable #if you want to turn it back on. Thanks.
+#ifdef _MACOSX_FIX_ME  // was #if 0 (for Linux)
+
+// NB: Bink players available here: http://www.radgametools.com/bnkdown.htm
+// I'm not sure how easy it will be to incorporate them (rather than SDK), nor
+// whether they'd be happy if we did.
+
+#ifdef _MACOSX_FIX_ME
+    #define USE_3DFX 0
+#else
 #define USE_3DFX 1
+#endif
 
 #if USE_3DFX
 extern bool gl3Dfx;
@@ -41,12 +61,12 @@
 static sdword g_frame, g_displayFrame;
 static bool   g_cleared;
 
-sdword animaticJustPlayed = 0;
-
 static ubyte* surf888;
 ubyte* surf8888 = NULL;
 
+#ifndef _MACOSX_FIX_ME
 extern HDC hGLDeviceContext;
+#endif
 
 #define NUM_SP_MISSIONS 19
 
@@ -73,56 +93,6 @@
 extern char *nisLanguageSubpath[];
 
 /*-----------------------------------------------------------------------------
-    Name        : animStartup
-    Description : reads animatics.lst from the Movies directory
-    Inputs      :
-    Outputs     :
-    Return      :
-----------------------------------------------------------------------------*/
-void animStartup(void)
-{
-    filehandle lst;
-    char   line[128], temp[64];
-    sdword level;
-
-    memset(animlisting, 0, NUM_SP_MISSIONS*sizeof(animlst));
-
-    if (!fileExists("Movies\\animatics.lst", 0))
-    {
-        return;
-    }
-
-    lst = fileOpen("Movies\\animatics.lst", FF_TextMode);
-    while (fileLineRead(lst, line, 127) != FR_EndOfFile)
-    {
-        if (strlen(line) < 5)
-        {
-            continue;
-        }
-        if (line[0] == ';' || line[0] == '/')
-        {
-            continue;
-        }
-        sscanf(line, "%d %s", &level, temp);
-        dbgAssert(level >= 0 && level < NUM_SP_MISSIONS);
-        memStrncpy(animlisting[level].filename, temp, 31);
-    }
-    fileClose(lst);
-}
-
-/*-----------------------------------------------------------------------------
-    Name        : animShutdown
-    Description : releases memory required by the animatics listing file
-    Inputs      :
-    Outputs     :
-    Return      :
-----------------------------------------------------------------------------*/
-void animShutdown(void)
-{
-    memset(animlisting, 0, NUM_SP_MISSIONS*sizeof(animlst));
-}
-
-/*-----------------------------------------------------------------------------
     Name        : animBinkSetup
     Description : setup / reset the GL for video playback
     Inputs      : on - TRUE or FALSE, setup or reset
@@ -252,7 +222,7 @@
 
     animSubtitlesSetup(FALSE);
 }
-
+#if 0
 /*-----------------------------------------------------------------------------
     Name        : animBinkReverseRGBA
     Description : inplace y-flip an RGBA image (640x480x32)
@@ -278,7 +248,7 @@
         memcpy(surf + pitch*bot, line, pitch);
     }
 }
-
+#endif
 #if USE_3DFX
 /*-----------------------------------------------------------------------------
     Name        : animBinkDisplay3Dfx
@@ -326,9 +296,14 @@
     Outputs     :
     Return      :
 ----------------------------------------------------------------------------*/
+#ifdef _WIN32
 void animBinkDisplay(binkDisplayCallback_proc callback)
+#else
+void animBinkDisplay()
+#endif
 {
     sdword xOfs, yOfs;
+#if 0
     ubyte* binkSurface = (ubyte*)binkGetSurface();
 
     if (g_frame <= g_displayFrame)
@@ -339,12 +314,14 @@
 
     //prepare binkSurface
     callback(NULL, 0, 0, 0);
-
+#endif
     xOfs = (MAIN_WindowWidth  - 640) / 2;
     yOfs = (MAIN_WindowHeight - 480) / 2;
 
     animBinkSetup(TRUE);
     glRasterPos2f((real32)xOfs, (real32)yOfs);
+
+#ifndef _MACOSX_FIX_ME
     switch (RGLtype)
     {
     case GLtype:
@@ -360,6 +337,8 @@
     default:
         dbgFatalf(DBG_Loc, "what's this RGLtype: %d [binkSimpleDisplayProc]", RGLtype);
     }
+#endif
+
     animBinkSetup(FALSE);
 
     animSubtitlesDraw();
@@ -399,7 +378,11 @@
         {
             for (pString = localisedPath + strlen(localisedPath); pString > localisedPath; pString--)
             {                                               //find the end of the path
+#ifdef _WIN32
                 if (*pString == '\\')
+#else
+                if (*pString == '/')
+#endif
                 {
                     strcpy(string, pString + 1);            //save the file name
                     strcpy(pString + 1, nisLanguageSubpath[strCurLanguage]);//add the language sub-path
@@ -443,7 +426,7 @@
     }
     return newHeader;
 }
-
+#if 0
 /*-----------------------------------------------------------------------------
     Name        : animGenericDecode
     Description : callback once per frame decode
@@ -484,6 +467,103 @@
 }
 
 /*-----------------------------------------------------------------------------
+    Name        : animBinkEnd
+    Description : cleanup after playing a Bink video file as an animatic
+    Inputs      :
+    Outputs     :
+    Return      :
+----------------------------------------------------------------------------*/
+void animBinkEnd(void)
+{
+    universe.totaltimeelapsed = g_timeElapsed;
+    soundEventStopMusic(0.0f);
+
+    mouseCursorShow();
+
+    rndClear();
+
+    binkCleanup();
+    soundstopall(0.0);
+    speechEventCleanup();
+    subReset();
+
+    soundEventMusicVol(animPreviousMusicVolume);
+    soundEventSpeechVol(animPreviousSpeechVolume);
+    soundEventSFXVol(animPreviousSFXVolume);
+
+    animaticJustPlayed = 8;
+}
+
+#endif	/* I hear Bink, but I don't see Bink... */
+
+#endif  // the #if 0/1 right at the very top of this file...
+
+
+
+
+/*-----------------------------------------------------------------------------
+    Name        : animStartup
+    Description : reads animatics.lst from the Movies directory
+    Inputs      :
+    Outputs     :
+    Return      :
+----------------------------------------------------------------------------*/
+void animStartup(void)
+{
+#ifdef _MACOSX_FIX_ME	/* BINK!@#$1 */
+    filehandle lst;
+    char   line[128], temp[64];
+    sdword level;
+
+    memset(animlisting, 0, NUM_SP_MISSIONS*sizeof(animlst));
+
+#ifdef _WIN32
+    if (!fileExists("Movies\\animatics.lst", 0))
+#else
+    if (!fileExists("Movies/animatics.lst", 0))
+#endif
+    {
+        return;
+    }
+
+#ifdef _WIN32
+    lst = fileOpen("Movies\\animatics.lst", FF_TextMode);
+#else
+    lst = fileOpen("Movies/animatics.lst", FF_TextMode);
+#endif
+    while (fileLineRead(lst, line, 127) != FR_EndOfFile)
+    {
+        if (strlen(line) < 5)
+        {
+            continue;
+        }
+        if (line[0] == ';' || line[0] == '/')
+        {
+            continue;
+        }
+        sscanf(line, "%d %s", &level, temp);
+        dbgAssert(level >= 0 && level < NUM_SP_MISSIONS);
+        memStrncpy(animlisting[level].filename, temp, 31);
+    }
+    fileClose(lst);
+#endif	/* BONK!@$4 */
+}
+
+/*-----------------------------------------------------------------------------
+    Name        : animShutdown
+    Description : releases memory required by the animatics listing file
+    Inputs      :
+    Outputs     :
+    Return      :
+----------------------------------------------------------------------------*/
+void animShutdown(void)
+{
+#ifdef _MACOSX_FIX_ME	/* BINK!@#$3 */
+    memset(animlisting, 0, NUM_SP_MISSIONS*sizeof(animlst));
+#endif	/* BONK!@#$1$ */
+}
+
+/*-----------------------------------------------------------------------------
     Name        : animBinkPlay
     Description : plays a Bink video file
     Inputs      : a, b - levels this video is playing between
@@ -492,6 +572,7 @@
 ----------------------------------------------------------------------------*/
 bool animBinkPlay(sdword a, sdword b)
 {
+#if 0 /* One more time...BINK!@#1 */
     bool rval;
     char filename[1024], scriptname[1024];
     void animBinkEnd(void);
@@ -521,19 +602,24 @@
             return FALSE;
         }
 
+#ifdef _WIN32
         sprintf(filename, "Movies\\%s.bik", animlisting[a].filename);
         sprintf(scriptname, "Movies\\%s.script", animlisting[a].filename);
+#else
+        sprintf(filename, "Movies/%s.bik", animlisting[a].filename);
+        sprintf(scriptname, "Movies/%s.script", animlisting[a].filename);
+#endif
         animScriptHeader = animLoadNISScript(scriptname);
     }
 
     soundEventStopMusic(0.0f);
     soundstopall(0.0f);
-
+#ifndef _MACOSX_FIX_ME
     if (!binkInit(RGLtype))
     {
         return FALSE;
     }
-
+#endif
     rndSetClearColor(colBlack);
     rndClear();
 
@@ -543,46 +629,26 @@
     universe.totaltimeelapsed = 0.0f;
 
     soundEventGetVolume(&animPreviousSFXVolume, &animPreviousSpeechVolume, &animPreviousMusicVolume);
-
+#ifndef _MACOSX_FIX_ME
     rval = binkPlay(filename,
 #if USE_3DFX
                     (gl3Dfx && sstLoaded()) ? animBinkDisplay3Dfx : animBinkDisplay,
 #else
                     animBinkDisplay,
-#endif
+#endif // USE_3DFX
                     animBinkDecode,
                     (trLitPaletteBits == 15) ? S_RGB555 : S_RGB565,
                     FALSE, -1);
+#endif // _MACOSX_FIX_ME
 
-    animBinkEnd();
+#ifndef _WIN32
+	animBinkDisplay();
+#endif
+    //animBinkEnd();
 
     return rval;
-}
-
-/*-----------------------------------------------------------------------------
-    Name        : animBinkEnd
-    Description : cleanup after playing a Bink video file as an animatic
-    Inputs      :
-    Outputs     :
-    Return      :
-----------------------------------------------------------------------------*/
-void animBinkEnd(void)
-{
-    universe.totaltimeelapsed = g_timeElapsed;
-    soundEventStopMusic(0.0f);
-
-    mouseCursorShow();
-
-    rndClear();
-
-    binkCleanup();
-    soundstopall(0.0);
-    speechEventCleanup();
-    subReset();
-
-    soundEventMusicVol(animPreviousMusicVolume);
-    soundEventSpeechVol(animPreviousSpeechVolume);
-    soundEventSFXVol(animPreviousSFXVolume);
-
+#endif	/* bonk? */
     animaticJustPlayed = 8;
+
+	return TRUE;  /* LIAR!! */
 }
diff -urPw homeworld-orig/src/Game/Animatic.h homeworld_sdl-0.3/src/Game/Animatic.h
--- homeworld-orig/src/Game/Animatic.h	2002-09-04 12:46:02.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Animatic.h	2004-08-01 22:35:27.000000000 -0700
@@ -9,7 +9,7 @@
 #ifndef _ANIMATIC_H
 #define _ANIMATIC_H
 
-#include "types.h"
+#include "Types.h"
 
 extern sdword animaticJustPlayed;
 
diff -urPw homeworld-orig/src/Game/Attack.c homeworld_sdl-0.3/src/Game/Attack.c
--- homeworld-orig/src/Game/Attack.c	2002-09-04 12:46:04.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Attack.c	2004-08-01 22:35:32.000000000 -0700
@@ -7,19 +7,19 @@
 =============================================================================*/
 
 #include <stdlib.h>
-#include "types.h"
-#include "fastmath.h"
-#include "spaceobj.h"
-#include "physics.h"
-#include "gun.h"
-#include "aiship.h"
-#include "aitrack.h"
-#include "collision.h"
-#include "attack.h"
-#include "universe.h"
-#include "tweak.h"
-#include "commandlayer.h"
-#include "randy.h"
+#include "Types.h"
+#include "FastMath.h"
+#include "SpaceObj.h"
+#include "Physics.h"
+#include "Gun.h"
+#include "AIShip.h"
+#include "AITrack.h"
+#include "Collision.h"
+#include "Attack.h"
+#include "Universe.h"
+#include "Tweak.h"
+#include "CommandLayer.h"
+#include "Randy.h"
 
 //#define DEBUG_ATTACK
 
@@ -45,7 +45,6 @@
 bool needToGoToSameVerticalPlane(Ship *ship,SpaceObjRotImpTarg *target, real32 tolerance, real32 speedToleranceSqr)
 {
     real32 ydist,speedSqr;
-    sdword retValue = 0;
 
     if ((ship->shiptype == Carrier) || (ship->shiptype == MissileDestroyer) || (ship->shiptype == P1Mothership))
     {
diff -urPw homeworld-orig/src/Game/Attack.h homeworld_sdl-0.3/src/Game/Attack.h
--- homeworld-orig/src/Game/Attack.h	2002-09-04 12:46:04.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Attack.h	2004-08-01 22:35:32.000000000 -0700
@@ -9,9 +9,9 @@
 #ifndef ___ATTACK_H
 #define ___ATTACK_H
 
-#include "types.h"
-#include "spaceobj.h"
-#include "statscript.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "StatScript.h"
 
 typedef struct
 {
diff -urPw homeworld-orig/src/Game/AutoDownloadMap.c homeworld_sdl-0.3/src/Game/AutoDownloadMap.c
--- homeworld-orig/src/Game/AutoDownloadMap.c	2002-09-04 12:46:04.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AutoDownloadMap.c	2004-08-01 22:35:32.000000000 -0700
@@ -6,17 +6,23 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include <string.h>
+#ifdef _WIN32
 #include <direct.h>
+#else
+    #include <sys/stat.h>
+    #include <dirent.h>
+#endif
+
+#include <string.h>
 #include <stdio.h>
 #include <stdlib.h>
-#include "types.h"
-#include "memory.h"
-#include "debug.h"
-#include "file.h"
-#include "commandnetwork.h"
-#include "titan.h"
-#include "horserace.h"
+#include "Types.h"
+#include "Memory.h"
+#include "Debug.h"
+#include "File.h"
+#include "CommandNetwork.h"
+#include "Titan.h"
+#include "HorseRace.h"
 #include "StringsOnly.h"
 
 #define NUM_FILES_OF_MAP_GROW       20
@@ -109,9 +115,15 @@
 {
     strcpy(autodownloadmapInfo.mapname,mapname);
 
+#ifdef _WIN32
     strcpy(autodownloadmapInfo.dirname,"Multiplayer\\");
     strcat(autodownloadmapInfo.dirname,autodownloadmapInfo.mapname);
     strcat(autodownloadmapInfo.dirname,"\\");
+#else
+    strcpy(autodownloadmapInfo.dirname,"Multiplayer/");
+    strcat(autodownloadmapInfo.dirname,autodownloadmapInfo.mapname);
+    strcat(autodownloadmapInfo.dirname,"/");
+#endif
 
     autodownloadmapInfo.numPlayers = numPlayers;
     autodownloadmapInfo.minPlayers = minPlayers;
@@ -154,8 +166,14 @@
 
 void autodownloadmapGetFilesOfMap(void)
 {
+#ifdef _WIN32
     struct _finddata_t find;
     sdword handle, startHandle;
+#else
+    DIR* dp;
+    struct dirent* dir_entry;
+    unsigned int str_len, j;
+#endif
     char dir[200];
     char file[200];
     sdword fileSize;
@@ -168,6 +186,7 @@
         GetExactMapDirNames(i);
 
         strcpy(dir,filePathPrepend(autodownloadmapInfo.exactdirname,0));
+#ifdef _WIN32
         strcat(dir,"\\*.*");
 
         startHandle = handle = _findfirst(dir, &find);
@@ -199,6 +218,42 @@
     next:
             handle = _findnext(startHandle, &find);
         }
+#else
+        str_len = strlen(dir);
+        for (j = 0; j < str_len; j++)
+        {
+            if (dir[j] == '\\')
+                dir[j] = '/';
+        }
+
+        /* Open the directory. */
+        dp = opendir(dir);
+        if (!dp)
+            continue;
+
+        /* Cycle through each directory entry. */
+        while ((dir_entry = readdir(dp)))
+        {
+            if (dir_entry->d_name[0] == '.')
+                continue;
+
+            if (strstr(dir_entry->d_name, ".mdb"))
+                continue;
+
+            strcpy(file, autodownloadmapInfo.exactdirname);
+            strcat(file, dir_entry->d_name);
+
+            fileSize = fileSizeGet(file, FF_IgnoreBIG);
+
+            if (fileSize <= 0 || fileSize > 64000)
+                continue;
+
+            AddFileOfMap(autodownloadmapInfo.exactdirname, dir_entry->d_name,
+                fileSize);
+        }
+
+        closedir(dp);
+#endif
     }
 }
 
@@ -311,7 +366,8 @@
     // and file.c, file.h is not reentrant (and we're not writing to a big file)
 
     FILE *outFile;
-    char file[250];
+    char file[PATH_MAX];
+    char *ch0, ch1;
     sdword lengthWrote;
     sdword filecontentssize = fpacket->packetheader.frame;
     sdword filenamesize = fpacket->packetheader.numberOfCommands;
@@ -319,6 +375,14 @@
     strcpy(file,filePrependPath);
     strcat(file,fpacket->filename);
 
+    if (!fileMakeDestinationDirectory(file))
+    {
+        titanDebug("autodownloadmap: WARNING could not create destination "
+                   "directory for %s\n",
+                   file);
+        return;
+    }
+
     if ((outFile = fopen(file, "wb")) == NULL)           //open the file
     {
         titanDebug("autodownloadmap: WARNING could not open file %s for writing\n",file);
@@ -359,7 +423,11 @@
 
         while (--findlastslashptr >= dirtomake)
         {
+#ifdef _WIN32
             if (*findlastslashptr == '\\')
+#else
+            if (*findlastslashptr == '\\' || *findlastslashptr == '/')
+#endif
             {
                 *findlastslashptr = 0;
                 break;
@@ -368,7 +436,11 @@
 
         dbgAssert(*findlastslashptr == 0);
 
+#ifdef _WIN32
         _mkdir(dirtomake);      // try to make directory.  If it already exists, this will fail, that's ok
+#else
+        mkdir(dirtomake, S_IRUSR | S_IWUSR | S_IXUSR);
+#endif
     }
 
     dbgAssert(sizeofPacket == sizeofFilePacketGivenPacket(fpacket));
diff -urPw homeworld-orig/src/Game/AutoDownloadMap.h homeworld_sdl-0.3/src/Game/AutoDownloadMap.h
--- homeworld-orig/src/Game/AutoDownloadMap.h	2002-09-04 12:46:04.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AutoDownloadMap.h	2004-08-01 22:35:32.000000000 -0700
@@ -9,7 +9,7 @@
 #ifndef ___AUTODOWNLOADMAP_H
 #define ___AUTODOWNLOADMAP_H
 
-#include "types.h"
+#include "Types.h"
 
 void autodownloadmapStartup();
 
diff -urPw homeworld-orig/src/Game/AutoLOD.c homeworld_sdl-0.3/src/Game/AutoLOD.c
--- homeworld-orig/src/Game/AutoLOD.c	2002-09-04 12:46:04.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AutoLOD.c	2004-08-01 22:35:28.000000000 -0700
@@ -7,10 +7,10 @@
 =============================================================================*/
 
 #include "glcaps.h"
-#include "autolod.h"
-#include "lod.h"
-#include "statscript.h"
-#include "options.h"
+#include "AutoLOD.h"
+#include "LOD.h"
+#include "StatScript.h"
+#include "Options.h"
 
 
 /*=============================================================================
@@ -294,7 +294,7 @@
     }
 
     //distance from ideal poly count
-    delta = abs((sdword)(alodTargetPolys - alodNumPolys));
+    delta = ABS((sdword)(alodTargetPolys - alodNumPolys));
 
     alodSetPanic(FALSE);
 
diff -urPw homeworld-orig/src/Game/AutoLOD.h homeworld_sdl-0.3/src/Game/AutoLOD.h
--- homeworld-orig/src/Game/AutoLOD.h	2002-09-04 12:46:04.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/AutoLOD.h	2004-08-01 22:35:29.000000000 -0700
@@ -9,7 +9,7 @@
 #ifndef _AUTOLOD_H
 #define _AUTOLOD_H
 
-#include "types.h"
+#include "Types.h"
 
 void alodStartup(void);
 void alodReset(void);
diff -urPw homeworld-orig/src/Game/Battle.c homeworld_sdl-0.3/src/Game/Battle.c
--- homeworld-orig/src/Game/Battle.c	2002-09-04 12:46:04.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Battle.c	2004-08-01 22:35:32.000000000 -0700
@@ -8,26 +8,26 @@
 
 #include <stdio.h>
 #include <math.h>
-#include "types.h"
-#include "debug.h"
-#include "memory.h"
-#include "spaceobj.h"
-#include "vector.h"
-#include "matrix.h"
+#include "Types.h"
+#include "Debug.h"
+#include "Memory.h"
+#include "SpaceObj.h"
+#include "Vector.h"
+#include "Matrix.h"
 #include "prim2d.h"
-#include "camera.h"
-#include "soundEvent.h"
-#include "randy.h"
+#include "Camera.h"
+#include "SoundEvent.h"
+#include "Randy.h"
 #include "mainrgn.h"
-#include "fastmath.h"
-#include "alliance.h"
-#include "universe.h"
-#include "flightman.h"
-#include "ping.h"
-#include "gun.h"
-#include "select.h"
-#include "blobs.h"
-#include "battle.h"
+#include "FastMath.h"
+#include "Alliance.h"
+#include "Universe.h"
+#include "FlightMan.h"
+#include "Ping.h"
+#include "Gun.h"
+#include "Select.h"
+#include "Blobs.h"
+#include "Battle.h"
 
 /*=============================================================================
     Data:
@@ -1126,14 +1126,14 @@
     if (bogeyPosition.z < 0.0f)
     {                                           //if they're behind us
         //sort of a "Manhattan bogey attitude" check
-        if (abs(bogeyPosition.x) + abs(bogeyPosition.y) < -bogeyPosition.z * batBogeyAspect)
+        if (ABS(bogeyPosition.x) + ABS(bogeyPosition.y) < -bogeyPosition.z * batBogeyAspect)
         {                                       //and they're on our 6
             vecNegate(temp);                    //vector from them to us
             matCopyAndTranspose(&badGuyShip->rotinfo.coordsys, &transpose);//transpose of coordsys
             matMultiplyMatByVec(&bogeyPosition, &transpose, &temp); //our position in badguy's local space
             if (bogeyPosition.z > 0.0f)
             {                                   //if they're ahead of us
-                if (abs(bogeyPosition.x) + abs(bogeyPosition.y) < bogeyPosition.z * batBogeyAspect)
+                if (ABS(bogeyPosition.x) + ABS(bogeyPosition.y) < bogeyPosition.z * batBogeyAspect)
                 {                               //and we're in their sights
                     return(TRUE);
                 }
@@ -1316,7 +1316,7 @@
     Ship *mouthPiece = NULL, *mothership;
     sdword handle;
     CommandToDo *command;
-    SelectCommand *ships;
+    //SelectCommand *ships;
     vector diff;
     udword chances, saveChance[4];
 
diff -urPw homeworld-orig/src/Game/BigFile.c homeworld_sdl-0.3/src/Game/BigFile.c
--- homeworld-orig/src/Game/BigFile.c	2002-09-04 12:46:04.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/BigFile.c	2004-08-01 22:35:16.000000000 -0700
@@ -1,17 +1,31 @@
+#ifdef _WIN32
+    #include <winbase.h>
+    #include <direct.h>
+#else
+    #include <unistd.h>
+    #include <dirent.h>
+    #include <ctype.h>
+#endif
+
 #include <stdio.h>
+#include <stdlib.h>
 #include <string.h>
+
+#ifndef _MACOSX
 #include <malloc.h>
-//#include <winbase.h>
-#include "bigfile.h"
-#include "crc32.h"
+#endif
+
+#include <sys/stat.h>
+#include "BigFile.h"
+#include "CRC32.h"
 #include "BitIO.h"
 #include "LZSS.h"
 
 #ifdef BF_HOMEWORLD
-#include "types.h"
-#include "memory.h"
-#include "debug.h"
-#include "file.h"
+    #include "Types.h"
+    #include "Memory.h"
+    #include "Debug.h"
+    #include "File.h"
 #endif
 
 
@@ -68,24 +82,42 @@
 #endif
 
 //
-//  1. convert all slashes to backslashes
+//  1. convert all slashes to either forward slashes or backslashes based on
+//     the platform (use backslashes on Win32, else use forward).
 //  2. reduce multiple consecutive slashes to single slashes
 //
 //  (operate on the string in place)
 //
-static void filenameSlashMassage(char *filename)
+static void filenameSlashMassage(char *filename, bool bLocalPath)
 {
     udword i, j;
+    char slash_ch, not_slash_ch;
     udword len = strlen(filename);
 
+#ifdef _WIN32
+    slash_ch = '\\';
+    not_slash_ch = '/';
+#else
+    if (bLocalPath)
+    {
+        slash_ch = '/';
+        not_slash_ch = '\\';
+    }
+    else
+    {
+        slash_ch = '\\';
+        not_slash_ch = '/';
+    }
+#endif  /* _WIN32 */
+
     for (i = 0; i < len; ++i)
-        if (filename[i] == '/')
-            filename[i] = '\\';
+        if (filename[i] == not_slash_ch)
+            filename[i] = slash_ch;
 
     i = 0;
     while (i < strlen(filename) - 1)
     {
-        if (filename[i] == '\\' && filename[i+1] == '\\')
+        if (filename[i] == slash_ch && filename[i+1] == slash_ch)
         {
             for (j = i; j < strlen(filename) - 1; ++j)
                 filename[j] = filename[j+1];
@@ -107,7 +139,7 @@
     char temp[32], tempRev[32], *p, *r;
     int count;
 
-    sprintf(temp, "%0d", bytes);
+    sprintf(temp, "%0ld", bytes);
     // copy backwards, by 3's into tempRev
     p = temp + strlen(temp) - 1;
     r = tempRev;
@@ -164,9 +196,9 @@
 ----------------------------------------------------------------------------*/
 static int bigFileExists(char *filename)
 {
-    struct _finddata_t findData;
+    struct stat findData;
 
-    return (_findfirst(filename, &findData) != -1);
+    return (stat(filename, &findData) != -1);
 }
 
 /*-----------------------------------------------------------------------------
@@ -243,7 +275,11 @@
     // backslash or the start of the string
     while (p != fullpathname)
     {
+#ifdef _WIN32
         if (*p == '\\')
+#else
+        if (*p == '\\' || *p == '/')
+#endif
         {
             ++p;
             break;
@@ -266,11 +302,22 @@
 ----------------------------------------------------------------------------*/
 static int bigTOCWrite(FILE *fp, bigTOC *toc)
 {
-    fwrite((void *)&(toc->numFiles), sizeof(toc->numFiles), 1, fp);
-    fwrite((void *)&(toc->flags), sizeof(toc->flags), 1, fp);
+#ifdef ENDIAN_BIG
+	int numFiles = LittleLong( toc->numFiles );
+	int flags    = LittleLong( toc->flags );
+#else
+	int numFiles = toc->numFiles;
+	int flags    = toc->flags;
+#endif
+
+    fwrite((void *)&numFiles, sizeof(toc->numFiles), 1, fp);
+    fwrite((void *)&flags,    sizeof(toc->flags),    1, fp);
+    
     if (toc->numFiles)
-        fwrite((void *)(toc->fileEntries),
-            sizeof(bigTOCFileEntry), toc->numFiles, fp);
+	{
+        fwrite((void *)(toc->fileEntries), sizeof(bigTOCFileEntry), toc->numFiles, fp);
+	}
+    
     return 1;
 }
 
@@ -290,12 +337,33 @@
 {
     fread((void *)&(toc->numFiles), sizeof(toc->numFiles), 1, fp);
     fread((void *)&(toc->flags), sizeof(toc->flags), 1, fp);
+
+#ifdef ENDIAN_BIG
+  	toc->numFiles = LittleLong( toc->numFiles );
+	toc->flags    = LittleLong( toc->flags );
+#endif
+
     if (toc->numFiles)
     {
         toc->fileEntries = malloc(sizeof(bigTOCFileEntry) * toc->numFiles);
-        fread((void *)(toc->fileEntries),
-            sizeof(bigTOCFileEntry), toc->numFiles, fp);
+        fread((void *)(toc->fileEntries), sizeof(bigTOCFileEntry), toc->numFiles, fp);
+
+#ifdef ENDIAN_BIG
+        int i;
+		for( i=0; i < toc->numFiles; ++i )
+		{
+			bigTOCFileEntry *e = &toc->fileEntries[i];
+			e->nameCRC1     = LittleLong( e->nameCRC1 );
+			e->nameCRC2     = LittleLong( e->nameCRC2 );
+			e->nameLength   = LittleShort( e->nameLength );
+			e->storedLength = LittleLong( e->storedLength );
+			e->realLength   = LittleLong( e->realLength );
+			e->offset       = LittleLong( e->offset );
+			e->timeStamp    = LittleLong( e->timeStamp );
+		}
+#endif
     }
+    
     return 1;
 }
 
@@ -390,6 +458,7 @@
     char filenamei[BF_MAX_FILENAME_LENGTH+1];
     bigTOCFileEntry target;
     int numFiles = toc->numFiles;
+    unsigned int i;
 
     if (!numFiles)
         return 0;
@@ -400,11 +469,10 @@
     }
 
     // pretend the filename is in lowercase
-    strcpy(filenamei, filename);
-    _strlwr(filenamei);
+    for (i = 0; (filenamei[i] = tolower(filename[i])); i++) { }
 
     // convert all slashes to backslashes and whittle multiple slashes down to a single one
-    filenameSlashMassage(filenamei);
+    filenameSlashMassage(filenamei, FALSE);
 
     target.nameLength = strlen(filenamei);
     target.nameCRC1 = (nameCRC1 = crc32Compute((ubyte *)filenamei, target.nameLength/2));
@@ -908,7 +976,12 @@
 ----------------------------------------------------------------------------*/
 int bigAdd(char *bigfilename, int numFiles, char *filenames[], int optCompression, int optNewer, int optMove, int optPathnames, int consoleOutput)
 {
+#ifdef _WIN32
     char tempfilename[L_tmpnam+1];
+#else
+    /* To be safe... */
+    char tempfilename[PATH_MAX];
+#endif
     char tempshortfilename[BF_MAX_FILENAME_LENGTH+1];
     int filesAdded = 0, filesUpdated = 0, filesUnchanged = 0;
     int f;
@@ -921,7 +994,13 @@
     char filename[BF_MAX_FILENAME_LENGTH+1];
 
     // temp file in case we need to abort
+#ifdef _WIN32
     if (!tmpnam(tempfilename))
+#else
+    strcpy(tempfilename, P_tmpdir);
+    strcat(tempfilename, "/hwXXXXXX");
+    if (mkstemp(tempfilename) == -1)
+#endif
     {
         if (consoleOutput)
             printf("ERROR: Can't create temporary filename\n");
@@ -976,7 +1055,7 @@
         {
             filelistName = filenames[f] + 1;
             // clean up messy slashes in filenames
-            filenameSlashMassage(filelistName);
+            filenameSlashMassage(filelistName, TRUE);
             filelist = 1;
             filelistFP = fopen(filelistName, "r");
             if (!filelistFP)
@@ -1007,7 +1086,7 @@
                 strcpy(filename, filenames[f]);
 
             // clean up messy slashes for the TOC
-            filenameSlashMassage(filename);
+            filenameSlashMassage(filename, FALSE);
 
             // use simple filename or full path
             if (!optPathnames)
@@ -1023,7 +1102,7 @@
             {
                 //if (consoleOutput)
                 //  printf("\nERROR: Can't add %s\n", filename);
-                _unlink(tempfilename);
+                unlink(tempfilename);
                 free(moveFiles);
                 return 0;
             }
@@ -1053,7 +1132,7 @@
                 else
                     moveFiles[f] = 0;
 
-                if (strcmpi(tempshortfilename, filename) && consoleOutput)
+                if (strcasecmp(tempshortfilename, filename) && consoleOutput)
                 {
                     printf(" (%s)", tempshortfilename);
                 }
@@ -1071,7 +1150,7 @@
     for (f = 0; f < numFiles; ++f)
         if (moveFiles[f])
         {
-            if (_unlink(filenames[f]) == -1)
+            if (unlink(filenames[f]) == -1)
                 if (consoleOutput)
                     printf("ERROR: Can't (re)move %s\n", filenames[f]);
         }
@@ -1113,7 +1192,7 @@
         free(moveFiles);
         return 0;
     }
-    if(_unlink(tempfilename) == -1)
+    if(unlink(tempfilename) == -1)
     {
         if (consoleOutput)
             printf("ERROR: Can't remove temporary file %s\n", tempfilename);
@@ -1148,7 +1227,7 @@
     char ch;
     int filesAdded = 0, dupesSkipped = 0;
     int pass;
-    int f, i, index;
+    int f, i, j, index;
     int *moveFiles;
     FILE *bigFP, *filelistFP, *dataFP;
     int filelist;
@@ -1156,7 +1235,7 @@
     char filelistLine[BF_MAX_FILENAME_LENGTH+1];
     char filename[BF_MAX_FILENAME_LENGTH+1];
     bigTOC toc;
-    struct _finddata_t findData;
+    struct stat findData;
     bigTOCFileEntry fileEntry;
     unsigned long curOffset;
     int compressedSize;
@@ -1234,7 +1313,7 @@
                     strcpy(filename, filenames[f]);
 
                 // clean up messy slashes for the TOC
-                filenameSlashMassage(filename);
+                filenameSlashMassage(filename, FALSE);
 
                 // use simple filename or full path
                 if (!optPathnames)
@@ -1243,11 +1322,12 @@
                     strcpy(tempshortfilename, filename);
 
                 // pretend name is lowercase for consistent CRCs
-                strcpy(tempshortfilenamei, tempshortfilename);
-                _strlwr(tempshortfilenamei);
+                for (j = 0; tempshortfilename[j]; j++)
+                    tempshortfilenamei[j] = tolower(tempshortfilename[j]);
+                tempshortfilenamei[j] = '\0';
 
                 // convert all slashes to backslashes and whittle multiple slashes down to a single one
-                filenameSlashMassage(tempshortfilenamei);
+                filenameSlashMassage(tempshortfilenamei, FALSE);
 
                 if (pass > 1 && consoleOutput)
                     printf("  %s ", filename);
@@ -1298,7 +1378,7 @@
                             continue;
                         }
 
-                        if (_findfirst(filename, &findData) == -1)
+                        if (stat(filename, &findData) == -1)
                         {
                             if (consoleOutput)
                                 printf("\nERROR: Can't find %s\n", filename);
@@ -1307,8 +1387,8 @@
                             free(moveFiles);
                             return 0;
                         }
-                        fileEntry.realLength = findData.size;
-                        fileEntry.timeStamp = findData.time_write;
+                        fileEntry.realLength = findData.st_size;
+                        fileEntry.timeStamp = findData.st_mtime;
 
                         // data
                         fseek(bigFP, curOffset, SEEK_SET);
@@ -1362,7 +1442,7 @@
                                 sizeof(toc.flags) +
                                 (filesAdded * sizeof(bigTOCFileEntry)), SEEK_SET);
 
-                        fileEntry.storedLength = fileEntry.compressionType ? compressedSize : findData.size;
+                        fileEntry.storedLength = fileEntry.compressionType ? compressedSize : findData.st_size;
                         fileEntry.offset = curOffset;
 
                         fwrite((void *)&(fileEntry), sizeof(fileEntry), 1, bigFP);
@@ -1385,7 +1465,7 @@
                 if (pass == 2 && consoleOutput)
                 {
                     //printf("[pass %d of 2]", pass);  // don't mention the first passes
-                    if (strcmpi(tempshortfilename, filename))
+                    if (strcasecmp(tempshortfilename, filename))
                         printf("(%s) ", tempshortfilename);
                     printf("added\n");
                 }
@@ -1443,7 +1523,7 @@
     for (f = 0; f < numFiles; ++f)
         if (moveFiles[f])
         {
-            if (_unlink(filenames[f]) == -1)
+            if (unlink(filenames[f]) == -1)
                 if (consoleOutput)
                     printf("ERROR: Can't (re)move %s\n", filenames[f]);
         }
@@ -1493,18 +1573,29 @@
     FILE *oldfp, *newfp, *datafp;
     bigTOC oldtoc, newtoc;
     bigTOCFileEntry fileEntry;
+#ifdef _WIN32
     char tempFilename[L_tmpnam], compressedTempFilename[L_tmpnam];
+#else
+    char tempFilename[PATH_MAX], compressedTempFilename[PATH_MAX];
+#endif
     int fileNum;
     int res = 0;
     signed long i;
     signed long offsetDelta;
     unsigned long oldStoredLength;
-    struct _finddata_t findData, findDataCompressed;
+    struct stat findData, findDataCompressed;
 
     newtoc.fileEntries = (bigTOCFileEntry *)0;
 
     // temp file in case we need to abort
+#ifdef _WIN32
     if (!tmpnam(tempFilename) || (optCompression && !tmpnam(compressedTempFilename)))
+#else
+    strcpy(tempFilename, P_tmpdir);
+    strcat(tempFilename, "/hwXXXXXX");
+    strcpy(compressedTempFilename, tempFilename);
+    if ((mkstemp(tempFilename) == -1) || (optCompression && (mkstemp(compressedTempFilename) == -1)))
+#endif
     {
         if (consoleOutput)
             printf("\nERROR: Can't create temporary filename\n");
@@ -1541,11 +1632,11 @@
     bigTOCRead(oldfp, &oldtoc);
 
     // clean up messy slashes for the TOC
-    filenameSlashMassage(filename);
-    filenameSlashMassage(storedFilename);
+    filenameSlashMassage(filename, TRUE);
+    filenameSlashMassage(storedFilename, FALSE);
 
     // fill in fileentry
-    if (_findfirst(filename, &findData) == -1)
+    if (stat(filename, &findData) == -1)
     {
         if (consoleOutput)
             printf("\nERROR: Can't find %s\n", filename);
@@ -1572,7 +1663,7 @@
         lzssCompressFile(datafp, bf);
         fclose(datafp);
         bitioFileCloseOutput(bf);
-        if (_findfirst(compressedTempFilename, &findDataCompressed) == -1)
+        if (stat(compressedTempFilename, &findDataCompressed) == -1)
         {
             if (consoleOutput)
                 printf("\nERROR: Can't find %s\n", filename);
@@ -1581,19 +1672,18 @@
     }
 
     // pretend name is lowercase for consistent CRCs
-    strcpy(tempshortfilenamei, storedFilename);
-    _strlwr(tempshortfilenamei);
+    for (i = 0; (tempshortfilenamei[i] = tolower(storedFilename[i])); i++) { }
 
     // convert all slashes to backslashes and whittle multiple slashes down to a single one
-    filenameSlashMassage(tempshortfilenamei);
+    filenameSlashMassage(tempshortfilenamei, FALSE);
 
     //strcpy(fileEntry.name, storedFilename);
     fileEntry.nameLength = (unsigned short)strlen(tempshortfilenamei);
     fileEntry.nameCRC1 = crc32Compute((ubyte *)tempshortfilenamei, fileEntry.nameLength/2);
     fileEntry.nameCRC2 = crc32Compute((ubyte *)tempshortfilenamei + fileEntry.nameLength/2, fileEntry.nameLength/2);
-    fileEntry.storedLength = optCompression ? findDataCompressed.size : findData.size;
-    fileEntry.realLength = findData.size;
-    fileEntry.timeStamp = findData.time_write;
+    fileEntry.storedLength = optCompression ? findDataCompressed.st_size : findData.st_size;
+    fileEntry.realLength = findData.st_size;
+    fileEntry.timeStamp = findData.st_mtime;
     fileEntry.compressionType = optCompression;  // no compression for now
     // fileEntry.offset will be calculated later
 
@@ -1606,7 +1696,7 @@
         // with the same CRCs
         if (!bigFilenameRetrieve(&oldtoc, fileNum, oldfp, compareFilename))
             goto abort;
-        if (strcmpi(storedFilename, compareFilename))
+        if (strcasecmp(storedFilename, compareFilename))
         {
             if (consoleOutput)
                     printf("\nERROR: Can't add %s (same CRC as %s)\n",
@@ -1619,7 +1709,7 @@
         {
             fclose (newfp);
             fclose (oldfp);
-            _unlink(tempFilename);
+            unlink(tempFilename);
             return BF_ADD_RES_OLD;
         }
 
@@ -1758,7 +1848,7 @@
     }
 
     // remove tempfile
-    if(_unlink(tempFilename) == -1)
+    if(unlink(tempFilename) == -1)
     {
         if (consoleOutput)
         printf("\nERROR: Can't remove temporary file %s\n", tempFilename);
@@ -1767,7 +1857,7 @@
 
     if (optCompression)
     {
-        if(_unlink(compressedTempFilename) == -1)
+        if(unlink(compressedTempFilename) == -1)
         {
             if (consoleOutput)
             printf("\nERROR: Can't remove temporary file %s\n", compressedTempFilename);
@@ -1820,7 +1910,7 @@
     unsigned long totalCompressed = 0, totalExpanded = 0;
     int displayCompressed = 0;
     char pRealSize[32], pStoredSize[32], pTimestamp[32], pRatio[16];
-    struct _finddata_t findData;
+    struct stat findData;
     char filename[BF_MAX_FILENAME_LENGTH+1];
 
     // open bigfile
@@ -1846,10 +1936,10 @@
         printf("No files in %s\n", bigFilename);
     else if (consoleOutput)
     {
-        _findfirst(bigFilename, &findData);
+        stat(bigFilename, &findData);
 
         printf("\nContents of %s ", bigFilename);
-        printf(  "(%s bytes, ", PrettyFilesize(findData.size, pStoredSize));
+        printf(  "(%s bytes, ", PrettyFilesize(findData.st_size, pStoredSize));
         printf(  "%s):\n", (toc.flags & BF_FLAG_TOC_SORTED)?"CRC-sorted TOC":"unsorted TOC");
 
         printf("\n             CRC   Stored Size     Real Size  Ratio        Date     Time  Filename\n");
@@ -2092,10 +2182,16 @@
 //
 void bigFilesystemCompare(char *baseDirectory, char *directory, bigTOC *mainTOC, bigTOC *updateTOC, unsigned char *mainNewerAvailable, unsigned char *updateNewerAvailable)
 {
+#if _WIN32
     struct _finddata_t findData;
+    long hFile;
+#else
+    struct stat file_stat;
+    DIR *dp;
+    struct dirent* dir_entry;
+#endif  // _WIN32
     char filespec[256];
     char subpath[256];
-    long hFile;
     int fileNum;
     static long compared = 0;
     static long newerMain = 0, newerUpdate;
@@ -2106,6 +2202,8 @@
     if (!directory[0])
         dbgMessagef("\nScanning for newer files in %s", baseDirectory);
 
+#if _WIN32
+
     sprintf(filespec, "%s\\%s%s*.*", baseDirectory, directory, directory[0] ? "\\" : "");
     hFile = _findfirst(filespec, &findData);
     if (hFile == -1)
@@ -2158,6 +2256,68 @@
 
     _findclose(hFile);
 
+#else  /* !_WIN32 */
+
+    /* Form path name. */
+    sprintf(filespec, "%s/%s/", baseDirectory, directory);
+    filenameSlashMassage(filespec, TRUE);
+
+    /* Open the directory. */
+    dp = opendir(filespec);
+    if (!dp)
+        return;
+
+    /* Read each directory entry. */
+    while ((dir_entry = readdir(dp)))
+    {
+        if (!strcmp(dir_entry->d_name, ".") || !strcmp(dir_entry->d_name, ".."))
+            continue;
+        sprintf(subpath, "%s%s%s", directory, directory[0] ? "/" : "", dir_entry->d_name);
+        stat(subpath, &file_stat);
+        if (S_ISDIR(file_stat.st_mode))
+        {
+            // recurse subdirectories
+            bigFilesystemCompare(baseDirectory, subpath, mainTOC, updateTOC, mainNewerAvailable, updateNewerAvailable);
+            --compared;
+        }
+        else
+        {
+            if (updateFP &&
+                bigTOCFileExists(updateTOC, subpath, &fileNum))
+            {
+                if (updateTOC->fileEntries[fileNum].timeStamp < file_stat.st_mtime)
+                {
+                    // newer one available in filesystem
+                    updateNewerAvailable[fileNum] = 2;
+
+                    ++newerUpdate;
+                }
+                else
+                    // older one available in filesystem
+                    updateNewerAvailable[fileNum] = 1;
+            }
+            if (bigTOCFileExists(mainTOC, subpath, &fileNum))
+            {
+                if (mainTOC->fileEntries[fileNum].timeStamp < file_stat.st_mtime)
+                {
+                    // newer one available in filesystem
+                    mainNewerAvailable[fileNum] = 2;
+                    // this can result in a poopload of messages...
+                    //dbgMessagef("\n  %s", subpath);
+                    ++newerMain;
+                }
+                else
+                    // older one available in filesystem
+                    mainNewerAvailable[fileNum] = 1;
+            }
+        }
+        ++compared;
+    }
+
+    closedir(dp);
+
+#endif  // _WIN32
+
     if (!directory[0])
     {
 
diff -urPw homeworld-orig/src/Game/BigFile.h homeworld_sdl-0.3/src/Game/BigFile.h
--- homeworld-orig/src/Game/BigFile.h	2002-09-04 12:46:04.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/BigFile.h	2004-08-01 22:35:16.000000000 -0700
@@ -1,9 +1,9 @@
 #ifndef __bigfile_h
 #define __bigfile_h
 
-#include <io.h>
+//#include <io.h>
 #include <time.h>
-#include "crc32.h"
+#include "CRC32.h"
 
 //
 //  Version Notes:
diff -urPw homeworld-orig/src/Game/BitIO.c homeworld_sdl-0.3/src/Game/BitIO.c
--- homeworld-orig/src/Game/BitIO.c	2002-09-04 12:46:04.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/BitIO.c	2004-08-01 22:35:19.000000000 -0700
@@ -14,8 +14,8 @@
 #include "BitIO.h"
 
 #ifdef BF_HOMEWORLD
-#include "memory.h"
-#include "debug.h"
+#include "Memory.h"
+#include "Debug.h"
 #else 
 #include "assert.h"
 #endif
diff -urPw homeworld-orig/src/Game/Blobs.c homeworld_sdl-0.3/src/Game/Blobs.c
--- homeworld-orig/src/Game/Blobs.c	2002-09-04 12:46:04.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Blobs.c	2004-08-01 22:35:18.000000000 -0700
@@ -10,20 +10,20 @@
 #include <string.h>
 #include <stdlib.h>
 #include <math.h>
-#include "debug.h"
-#include "memory.h"
-#include "spaceobj.h"
-#include "universe.h"
-#include "fastmath.h"
-#include "sensors.h"
-#include "netcheck.h"
-#include "battle.h"
-#include "soundevent.h"
+#include "Debug.h"
+#include "Memory.h"
+#include "SpaceObj.h"
+#include "Universe.h"
+#include "FastMath.h"
+#include "Sensors.h"
+#include "NetCheck.h"
+#include "Battle.h"
+#include "SoundEvent.h"
 #include "GravWellGenerator.h"
-#include "blobs.h"
+#include "Blobs.h"
 #include "Alliance.h"
 #include "TimeoutTimer.h"
-#include "singleplayer.h"
+#include "SinglePlayer.h"
 
 #ifdef BOB_STATS
 
@@ -1312,6 +1312,8 @@
 resourceCommon:
                 thisBlob->RUs += ((Resource *)object)->staticinfo->resourcevalue;
                 break;
+            default:
+                break;
         }
     }
 
diff -urPw homeworld-orig/src/Game/Blobs.h homeworld_sdl-0.3/src/Game/Blobs.h
--- homeworld-orig/src/Game/Blobs.h	2002-09-04 12:46:04.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Blobs.h	2004-08-01 22:35:19.000000000 -0700
@@ -10,11 +10,11 @@
 #ifndef ___BLOBS_H
 #define ___BLOBS_H              1
 
-#include "types.h"
-#include "vector.h"
-#include "linkedlist.h"
+#include "Types.h"
+#include "Vector.h"
+#include "LinkedList.h"
 #include "SpaceObj.h"
-#include "shipselect.h"
+#include "ShipSelect.h"
 
 /*=============================================================================
     Switches:
diff -urPw homeworld-orig/src/Game/BMP.c homeworld_sdl-0.3/src/Game/BMP.c
--- homeworld-orig/src/Game/BMP.c	2002-09-04 12:46:04.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/BMP.c	2004-08-01 22:35:27.000000000 -0700
@@ -6,9 +6,9 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "file.h"
-#include "debug.h"
-#include "bmp.h"
+#include "File.h"
+#include "Debug.h"
+#include "BMP.h"
 
 /*=============================================================================
     Functions
diff -urPw homeworld-orig/src/Game/BMP.h homeworld_sdl-0.3/src/Game/BMP.h
--- homeworld-orig/src/Game/BMP.h	2002-09-04 12:46:04.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/BMP.h	2004-08-01 22:35:27.000000000 -0700
@@ -10,7 +10,7 @@
 #define ___BMP_H
 
 #include "color.h"
-#include "file.h"
+#include "File.h"
 
 /*=============================================================================
     Switches:
diff -urPw homeworld-orig/src/Game/Bounties.c homeworld_sdl-0.3/src/Game/Bounties.c
--- homeworld-orig/src/Game/Bounties.c	2002-09-04 12:46:04.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Bounties.c	2004-08-01 22:35:31.000000000 -0700
@@ -6,11 +6,11 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "universe.h"
-#include "multiplayergame.h"
-#include "bounties.h"
-#include "alliance.h"
+#include "Types.h"
+#include "Universe.h"
+#include "MultiplayerGame.h"
+#include "Bounties.h"
+#include "Alliance.h"
 
 real32 getPlayerBountyWorthDeterm(real32 shipworth,real32 ruworth,real32 totalshipworth,real32 totalruworth);
 
diff -urPw homeworld-orig/src/Game/Bounties.h homeworld_sdl-0.3/src/Game/Bounties.h
--- homeworld-orig/src/Game/Bounties.h	2002-09-04 12:46:04.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Bounties.h	2004-08-01 22:35:31.000000000 -0700
@@ -10,9 +10,9 @@
 #define BOUNTY_H
 
 
-#include "types.h"
-#include "universe.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Universe.h"
+#include "SpaceObj.h"
 
 void BountyInit(sdword bountySettingSize);
 sdword getPlayerBountyRender(Player *player);
diff -urPw homeworld-orig/src/Game/B-Spline.c homeworld_sdl-0.3/src/Game/B-Spline.c
--- homeworld-orig/src/Game/B-Spline.c	2002-09-04 12:46:04.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/B-Spline.c	2004-08-01 22:35:32.000000000 -0700
@@ -8,12 +8,12 @@
 
 #include <stdio.h>
 #include <string.h>
-#include "types.h"
-#include "memory.h"
-#include "debug.h"
-#include "vector.h"
-#include "matrix.h"
-#include "b-spline.h"
+#include "Types.h"
+#include "Memory.h"
+#include "Debug.h"
+#include "Vector.h"
+#include "Matrix.h"
+#include "B-Spline.h"
 
 /*=============================================================================
     Functions
@@ -29,6 +29,7 @@
 void bsStartup(void)
 {
 #if BS_TEST
+    char *fileName;
     FILE *fp;
     splinecurve *curve;
     static real32 points[] = {0.0f, 1.0f, -1.0f, -0.5f, 0.0f, -2.0f, -1.2f};
@@ -39,7 +40,8 @@
     real32 time, value = 0.0f;
     sdword point;
 
-    fp = fopen("b-spline.chart", "wt");
+    fileName = filePathPrepend("b-spline.chart", FF_UserSettingsPath);
+    fp = fopen(fileName, "wt");
     if (fp != NULL)
     {
         curve = bsCurveStart(7, points, times, tcbs, TRUE);
diff -urPw homeworld-orig/src/Game/BTG.c homeworld_sdl-0.3/src/Game/BTG.c
--- homeworld-orig/src/Game/BTG.c	2002-09-04 12:46:04.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/BTG.c	2004-08-01 22:35:32.000000000 -0700
@@ -9,22 +9,21 @@
 =============================================================================*/
 
 
-#ifndef SW_Render
-#include <windows.h>
-#endif
+#include <SDL_endian.h>
 #include <stdio.h>
+#include <stdlib.h>
 #include <string.h>
 #include <math.h>
-#include "btg.h"
-#include "memory.h"
-#include "vector.h"
-#include "matrix.h"
+#include "BTG.h"
+#include "Memory.h"
+#include "Vector.h"
+#include "Matrix.h"
 #include "glinc.h"
 #include "color.h"
-#include "universe.h"
-#include "file.h"
+#include "Universe.h"
+#include "File.h"
 #include "render.h"
-#include "clipper.h"
+#include "Clipper.h"
 #include "main.h"
 #include "glcaps.h"
 #include "mainrgn.h"
@@ -267,7 +266,11 @@
     TGAFileHeader head;
     sdword i;
 
+#ifdef _WIN32
     strcpy(fullname, "btg\\bitmaps\\");
+#else
+    strcpy(fullname, "btg/bitmaps/");
+#endif
     strcat(fullname, filename);
 
     if (fileExists(fullname, 0))
@@ -280,6 +283,26 @@
         head.colorMapType = *pdata++;
         head.imageType = *pdata++;
         psdata = (unsigned short*)pdata;
+
+#ifdef ENDIAN_BIG
+        head.colorMapStartIndex = LittleShort( *psdata );
+        pdata += 2;
+        psdata = (unsigned short*)pdata;
+        head.colorMapNumEntries = LittleShort( *psdata );
+        pdata += 2;
+        head.colorMapBitsPerEntry = *pdata++;
+        psdata = (unsigned short*)pdata;
+        head.imageOffsetX = (signed short)LittleShort( *psdata );
+        pdata += 2;
+        psdata = (unsigned short*)pdata;
+        head.imageOffsetY = (signed short)LittleShort( *psdata );
+        pdata += 2;
+        psdata = (unsigned short*)pdata;
+        head.imageWidth = LittleShort( *psdata );
+        pdata += 2;
+        psdata = (unsigned short*)pdata;
+        head.imageHeight = LittleShort( *psdata );
+#else
         head.colorMapStartIndex = *psdata;
         pdata += 2;
         psdata = (unsigned short*)pdata;
@@ -297,6 +320,8 @@
         pdata += 2;
         psdata = (unsigned short*)pdata;
         head.imageHeight = *psdata;
+#endif // ENDIAN_BIG
+
         pdata += 2;
         head.pixelDepth = *pdata++;
         head.imageDescriptor = *pdata++;
@@ -482,6 +507,10 @@
     udword starSize, fileStarSize;
     udword polySize;
     real32 thetaSave, phiSave;
+    sdword i;
+#ifdef ENDIAN_BIG
+    Uint64 *swap;
+#endif
 
     fileLoadAlloc(filename, (void**)&btgData, 0);
 
@@ -499,6 +528,30 @@
     btgHead = (btgHeader*)memAlloc(headSize, "btg header", 0);
     memcpy(btgHead, btgData, headSize);
 
+#ifdef ENDIAN_BIG
+	btgHead->btgFileVersion = LittleLong( btgHead->btgFileVersion );
+	btgHead->numVerts       = LittleLong( btgHead->numVerts );
+	btgHead->numStars       = LittleLong( btgHead->numStars );
+	btgHead->numPolys       = LittleLong( btgHead->numPolys );
+	btgHead->xScroll        = LittleLong( btgHead->xScroll );
+	btgHead->yScroll        = LittleLong( btgHead->yScroll );
+	btgHead->zoomVal        = LittleLong( btgHead->zoomVal );
+	btgHead->pageWidth      = LittleLong( btgHead->pageWidth );
+	btgHead->pageHeight     = LittleLong( btgHead->pageHeight );
+	btgHead->mRed           = LittleLong( btgHead->mRed );
+	btgHead->mGreen         = LittleLong( btgHead->mGreen );
+	btgHead->mBlue          = LittleLong( btgHead->mBlue );
+	btgHead->mBGRed         = LittleLong( btgHead->mBGRed );
+	btgHead->mBGGreen       = LittleLong( btgHead->mBGGreen );
+	btgHead->mBGBlue        = LittleLong( btgHead->mBGBlue );
+	btgHead->bVerts         = LittleLong( btgHead->bVerts );
+	btgHead->bPolys         = LittleLong( btgHead->bPolys );
+	btgHead->bStars         = LittleLong( btgHead->bStars );
+	btgHead->bOutlines      = LittleLong( btgHead->bOutlines );
+	btgHead->bBlends        = LittleLong( btgHead->bBlends );
+	btgHead->renderMode     = LittleLong( btgHead->renderMode );
+#endif
+
     //set background colour
     universe.backgroundColor = colRGB(btgHead->mBGRed, btgHead->mBGGreen, btgHead->mBGBlue);
 #if 0           // set at end of gameStart to prevent color problems
@@ -517,6 +570,24 @@
     {
         btgVerts = (btgVertex*)memAlloc(vertSize, "btg verts", 0);
         memcpy(btgVerts, btgData + headSize, vertSize);
+
+#ifdef ENDIAN_BIG
+		for( i=0; i<btgHead->numVerts; i++ )
+		{
+			btgVerts[i].flags = LittleLong( btgVerts[i].flags );
+			swap  = ( Uint64 *)&btgVerts[i].x;
+			*swap = SDL_SwapLE64( *swap );
+			swap  = ( Uint64 *)&btgVerts[i].y;
+			*swap = SDL_SwapLE64( *swap );
+//			btgVerts[i].x          = LittleFloat( btgVerts[i].x );
+//			btgVerts[i].y          = LittleFloat( btgVerts[i].y );
+			btgVerts[i].red        = LittleLong( btgVerts[i].red );
+			btgVerts[i].green      = LittleLong( btgVerts[i].green );
+			btgVerts[i].blue       = LittleLong( btgVerts[i].blue );
+			btgVerts[i].alpha      = LittleLong( btgVerts[i].alpha );
+			btgVerts[i].brightness = LittleLong( btgVerts[i].brightness );
+		}
+#endif
     }
 
     //stars.  non-trivial munging around
@@ -526,13 +597,15 @@
     {
         btgStar* outstarp;
         ubyte*   instarp;
+		btgStar* inp;
         udword*  udp;
-        sdword   i, j, tempSize, count, length;
+        sdword   j, tempSize, count, length;
         char     filename[48];
 
         btgStars = (btgStar*)memAlloc(starSize, "btg stars", 0);
         instarp  = btgData + headSize + vertSize;
         outstarp = btgStars;
+		inp = ( btgStar *)instarp;
 
         for (i = 0; i < btgHead->numStars; i++, outstarp++)
         {
@@ -542,11 +615,29 @@
             instarp += tempSize;
             fileStarSize += tempSize;
 
+#ifdef ENDIAN_BIG
+			 swap = ( Uint64 *)&outstarp->x;
+			*swap = SDL_SwapLE64( *swap );
+			 swap = ( Uint64 *)&outstarp->y;
+			*swap = SDL_SwapLE64( *swap );
+			outstarp->flags = LittleLong( outstarp->flags );
+			outstarp->red   = LittleLong( outstarp->red );
+			outstarp->green = LittleLong( outstarp->green );
+			outstarp->blue  = LittleLong( outstarp->blue );
+			outstarp->alpha = LittleLong( outstarp->alpha );
+#endif
+
             //extract variable-sized filename
             count = 0;
             memset(filename, 0, 48);
             udp = (udword*)instarp;
+
+#ifdef ENDIAN_BIG
+            length = LittleLong( (sdword)*udp );
+#else
             length = (sdword)*udp;
+#endif
+
             instarp += 4;
             fileStarSize += 4;
             for (j = 0; j < length; j++)
@@ -578,6 +669,16 @@
     {
         btgPolys = (btgPolygon*)memAlloc(polySize, "btg polys", 0);
         memcpy(btgPolys, btgData + headSize + vertSize + fileStarSize, polySize);
+		
+#ifdef ENDIAN_BIG
+		for( i=0; i<btgHead->numPolys; i++ )
+		{
+			btgPolys[i].flags = LittleLong( btgPolys[i].flags );
+			btgPolys[i].v0    = LittleLong( btgPolys[i].v0 );
+			btgPolys[i].v1    = LittleLong( btgPolys[i].v1 );
+			btgPolys[i].v2    = LittleLong( btgPolys[i].v2 );
+		}
+#endif
     }
 
     memFree(btgData);
@@ -661,7 +762,7 @@
     }
 
     //continue only if approximately equal number of edge verts
-    if (abs(numLeft - numRight) > 1)
+    if (ABS(numLeft - numRight) > 1)
     {
         return;
     }
@@ -972,12 +1073,19 @@
     real32 modelview[16], projection[16];
     udword* dlast;
     udword* dnext;
-    extern bool gMosaic;
     static sdword lastFade = 255;
 
+#if MR_KEYBOARD_CHEATS
+    extern bool gMosaic;
+#endif
+
     if (btgHead == NULL)
     {
+#ifdef _WIN32
         btgLoad("BTG\\default.btg");
+#else
+        btgLoad("BTG/default.btg");
+#endif
     }
 
 #if MR_KEYBOARD_CHEATS
diff -urPw homeworld-orig/src/Game/BTG.h homeworld_sdl-0.3/src/Game/BTG.h
--- homeworld-orig/src/Game/BTG.h	2002-09-04 12:46:04.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/BTG.h	2004-08-01 22:35:32.000000000 -0700
@@ -9,7 +9,7 @@
 #ifndef _BTG_H
 #define _BTG_H
 
-#include "types.h"
+#include "Types.h"
 
 
 #define BTG_FILE_VERSION 0x600
diff -urPw homeworld-orig/src/Game/Camera.c homeworld_sdl-0.3/src/Game/Camera.c
--- homeworld-orig/src/Game/Camera.c	2002-09-04 12:46:04.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Camera.c	2004-08-01 22:35:32.000000000 -0700
@@ -8,17 +8,17 @@
 
 #include <string.h>
 #include <math.h>
-#include "types.h"
-#include "debug.h"
-#include "vector.h"
-#include "matrix.h"
-#include "key.h"
-#include "camera.h"
-#include "statscript.h"
-#include "crc32.h"
+#include "Types.h"
+#include "Debug.h"
+#include "Vector.h"
+#include "Matrix.h"
+#include "Key.h"
+#include "Camera.h"
+#include "StatScript.h"
+#include "CRC32.h"
 
 #include "CameraCommand.h"
-#include "universe.h"
+#include "Universe.h"
 
 /*=============================================================================
     Public variables:
@@ -174,10 +174,10 @@
 
     matMakeRotAboutZ(&rotzmatrix,(real32)cos(rot),(real32)sin(rot));
 
+    camera->oldlookatpoint = camera->lookatpoint;
     vecSub(position,camera->lookatpoint,about);
     matMultiplyMatByVec(&rotatedposition,&rotzmatrix,&position);
     vecAdd(camera->lookatpoint,about,rotatedposition);
-    camera->oldlookatpoint = camera->lookatpoint;
 
     vecSub(position,camera->eyeposition,about);
     matMultiplyMatByVec(&rotatedposition,&rotzmatrix,&position);
@@ -202,8 +202,8 @@
     camera->declination = 0.0f;
     camera->distance = distance;
 
-    memset(&camera->lookatpoint, 0, sizeof(camera));
-    memset(&camera->oldlookatpoint, 0, sizeof(camera));
+    memset(&camera->lookatpoint,    0, sizeof(vector));
+    memset(&camera->oldlookatpoint, 0, sizeof(vector));
 
     vecSet(camera->upvector,0.0f,0.0f,1.0f);
 
@@ -219,8 +219,8 @@
 
 void cameraChangeLookatpoint(Camera *camera,vector *newlookatpoint)
 {
+    camera->oldlookatpoint = camera->lookatpoint;
     camera->lookatpoint = *newlookatpoint;
-    camera->oldlookatpoint = *newlookatpoint;
 
     cameraSetEyePosition(camera);
 }
diff -urPw homeworld-orig/src/Game/CameraCommand.c homeworld_sdl-0.3/src/Game/CameraCommand.c
--- homeworld-orig/src/Game/CameraCommand.c	2002-09-04 12:46:04.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/CameraCommand.c	2004-08-01 22:35:26.000000000 -0700
@@ -9,25 +9,25 @@
 
 #include <string.h>
 #include <math.h>
-#include "types.h"
-#include "fastmath.h"
-#include "debug.h"
-#include "memory.h"
-#include "linkedlist.h"
-#include "camera.h"
+#include "Types.h"
+#include "FastMath.h"
+#include "Debug.h"
+#include "Memory.h"
+#include "LinkedList.h"
+#include "Camera.h"
 #include "utility.h"
 #include "prim2d.h"
-#include "statscript.h"
-#include "universe.h"
-#include "shipselect.h"
-#include "cameracommand.h"
-#include "proximitysensor.h"
-#include "sensors.h"
+#include "StatScript.h"
+#include "Universe.h"
+#include "ShipSelect.h"
+#include "CameraCommand.h"
+#include "ProximitySensor.h"
+#include "Sensors.h"
 #include "main.h"
-#include "alliance.h"
-#include "tutor.h"
-#include "singlePlayer.h"
-#include "task.h"
+#include "Alliance.h"
+#include "Tutor.h"
+#include "SinglePlayer.h"
+#include "Task.h"
 
 #ifdef gshaw
 #define DEBUG_CAMERACOMMAND     0
@@ -411,7 +411,7 @@
 udword CloseOnAngle(real32 *tracking,real32 desired,real32 rate)
 {
     real32 diff = desired - *tracking;
-    real32 absdiff = abs(diff);
+    real32 absdiff = ABS(diff);
 
     if (absdiff > PI)       // at most we will be PI radians off, so if we are "more" than
     {                       // PI radians off we are going the wrong way.
@@ -424,10 +424,10 @@
             desired += TWOPI;
         }
         diff = desired - *tracking;
-        absdiff = abs(diff);
+        absdiff = ABS(diff);
     }
 
-    if (abs(diff) < rate)
+    if (ABS(diff) < rate)
     {
         *tracking = desired;
         return 1;
@@ -465,7 +465,7 @@
 {
     real32 diff = desired - *tracking;
 
-    if (abs(diff) < rate)
+    if (ABS(diff) < rate)
     {
         *tracking = desired;
         return 1;
@@ -494,7 +494,7 @@
 udword CloseOnFast(real32 *tracking,real32 desired,real32 minrate)
 {
     real32 diff = desired - *tracking;
-    real32 dist = abs(diff);
+    real32 dist = ABS(diff);
     real32 rate = dist / 8.0f;
 
     if (rate <= minrate)
@@ -675,18 +675,14 @@
 {
 Camera *desired = &currentCameraStackEntry(cameracommand)->remembercam;
 vector targetvelocity;
-udword lockedon = 1;
 bool dontUseVelocityPredInChase = FALSE;
 long  Frames, IndZoom, IndAng;
-static real32 oldTime = 0.0f;
 vector deLookVector;
 
 static float angSpeed = 0.0f, decSpeed = 0.0f;
-static float xSpeed = 0.0f, ySpeed = 0.0f;
-static float zSpeed = 0.0f, distSpeed = 0.0f;
+    static float xSpeed = 0.0f, ySpeed = 0.0f, zSpeed = 0.0f;
 static float eyeXSpeed = 0.0f, eyeYSpeed = 0.0f, eyeZSpeed = 0.0f;
 
-
     if (cameracommand->dontUseVelocityPredInChase == TRUE)
     {
         dontUseVelocityPredInChase = TRUE;
@@ -785,7 +781,7 @@
     camera->angle = (real32)atan2(distvec->y,distvec->x);
     value = -distvec->z/camera->distance;
 
-    dbgAssert( abs(value) <= 1.01f );       // USE 1.01 SO ROUND OFF ERRORS DON'T CRASH US
+    dbgAssert( ABS(value) <= 1.01f );       // USE 1.01 SO ROUND OFF ERRORS DON'T CRASH US
 
     if(value < -1.0f)
         value = -1.0f;
@@ -1780,9 +1776,9 @@
 
     for (out->numShips = index = 0; index < in->numShips; index++)
     {
-        dx = abs(in->ShipPtr[index]->posinfo.position.x - centre->x);
-        dy = abs(in->ShipPtr[index]->posinfo.position.y - centre->y);
-        dz = abs(in->ShipPtr[index]->posinfo.position.z - centre->z);
+        dx = ABS(in->ShipPtr[index]->posinfo.position.x - centre->x);
+        dy = ABS(in->ShipPtr[index]->posinfo.position.y - centre->y);
+        dz = ABS(in->ShipPtr[index]->posinfo.position.z - centre->z);
         distanceSqr = dx * dx + dy * dy + dz * dz;          //compute distance from centre
         if (distanceSqr <= radiusSqr)
         {                                                   //if this ship close enough to the mean
diff -urPw homeworld-orig/src/Game/CameraCommand.h homeworld_sdl-0.3/src/Game/CameraCommand.h
--- homeworld-orig/src/Game/CameraCommand.h	2002-09-04 12:46:04.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/CameraCommand.h	2004-08-01 22:35:27.000000000 -0700
@@ -10,12 +10,12 @@
 #ifndef ___CAMERA_COMMAND_H
 #define ___CAMERA_COMMAND_H
 
-#include "types.h"
-#include "linkedlist.h"
-#include "spaceobj.h"
-#include "camera.h"
-#include "shipselect.h"
-#include "statscript.h"
+#include "Types.h"
+#include "LinkedList.h"
+#include "SpaceObj.h"
+#include "Camera.h"
+#include "ShipSelect.h"
+#include "StatScript.h"
 
 /*=============================================================================
     Types:
diff -urPw homeworld-orig/src/Game/Camera.h homeworld_sdl-0.3/src/Game/Camera.h
--- homeworld-orig/src/Game/Camera.h	2002-09-04 12:46:04.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Camera.h	2004-08-01 22:35:33.000000000 -0700
@@ -9,9 +9,9 @@
 #ifndef ___CAMERA_H
 #define ___CAMERA_H
 
-#include "types.h"
-#include "vector.h"
-#include "matrix.h"
+#include "Types.h"
+#include "Vector.h"
+#include "Matrix.h"
 
 /*=============================================================================
     Switches:
@@ -75,6 +75,8 @@
 udword cameraChecksum(Camera *cam);
 #endif
 
+struct Ship;
+
 void cameraSetEyePositionBasedOnShip(Camera *camera,struct Ship *ship);
 
 /*=============================================================================
diff -urPw homeworld-orig/src/Game/Captaincy.c homeworld_sdl-0.3/src/Game/Captaincy.c
--- homeworld-orig/src/Game/Captaincy.c	2002-09-04 12:46:06.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Captaincy.c	2004-08-01 22:35:27.000000000 -0700
@@ -6,22 +6,26 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-// unfortunately need this for the timers
+#ifdef _WIN32
 #define WIN32_LEAN_AND_MEAN
 #include <windows.h>
+#else
+    #include <sys/time.h>
+#endif
 
+#include "SDL.h"
 #include <string.h>
 #include <stdio.h>
 #include <stdarg.h>
-#include "types.h"
-#include "memory.h"
-#include "debug.h"
-#include "globals.h"
-#include "commandnetwork.h"
-#include "captaincy.h"
+#include "Types.h"
+#include "Memory.h"
+#include "Debug.h"
+#include "Globals.h"
+#include "CommandNetwork.h"
+#include "Captaincy.h"
 #include "utility.h"
 #include "CommandWrap.h"
-#include "file.h"
+#include "File.h"
 
 
 /*
@@ -48,12 +52,12 @@
     misc - new captain you should acknowledge
 */
 
-extern LONGLONG utyTimerDivisor;
+extern Uint32 utyTimerDivisor;
 
 typedef struct TimeoutTimer
 {
     bool enabled;
-    LONGLONG timerLast;
+    Uint32 timerLast;
     udword timeoutTicks;
 } TimeoutTimer;
 
@@ -122,11 +126,24 @@
 
     if (logEnable)
     {
+#ifdef _WIN32
         SYSTEMTIME systime;
         char buffer2[200];
 
         GetSystemTime(&systime);
         sprintf(buffer2,"\n%2d:%2d:%2d %s",systime.wHour,systime.wMinute,systime.wSecond,buffer);
+#else   /* TEE...VEE...MIND! */
+        struct timeval tv;
+        long tv_hour, tv_minute, tv_second;
+        char buffer2[200];
+
+        gettimeofday(&tv, 0);
+        tv_hour   = (tv.tv_sec % 86400) / 3600;
+        tv_minute = (tv.tv_sec %  3600) /   60;
+        tv_second = (tv.tv_sec %    60);
+        sprintf(buffer2, "\n%2ld:%2ld:%2ld %s", tv_hour, tv_minute, tv_second,
+            buffer);
+#endif
         logfileLog(CAPTAINCYLOGFILE,buffer2);
     }
 }
@@ -177,13 +194,13 @@
     {
         if (timeoutTimers[i].enabled)
         {
-            LARGE_INTEGER perftimer;
-            LONGLONG difference;
+            Uint32 timerval;
+            Uint32 difference;
             udword nTicks;
 
-            QueryPerformanceCounter(&perftimer);
+            timerval = SDL_GetTicks();
 
-            difference = perftimer.QuadPart - timeoutTimers[i].timerLast;
+            difference = timerval - timeoutTimers[i].timerLast;
             nTicks = (udword)(difference / utyTimerDivisor);
 
             if (nTicks >= timeoutTimers[i].timeoutTicks)
@@ -196,27 +213,27 @@
 
 void TimeoutTimerStart(sdword timer,real32 timeout)
 {
-    LARGE_INTEGER perftimer;
+    Uint32 timerval;
 
-    QueryPerformanceCounter(&perftimer);
+    timerval = SDL_GetTicks();
 
     timeoutTimers[timer].enabled = TRUE;
-    timeoutTimers[timer].timerLast = perftimer.QuadPart;
+    timeoutTimers[timer].timerLast = timerval;
     timeoutTimers[timer].timeoutTicks = (udword) (timeout * UTY_TimerResloutionMax);
 }
 
 void TimeoutTimerReset(sdword timer)
 {
-    LARGE_INTEGER perftimer;
+    Uint32 timerval;
 
     if (!timeoutTimers[timer].enabled)
     {
         return;
     }
 
-    QueryPerformanceCounter(&perftimer);
+    timerval = SDL_GetTicks();
 
-    timeoutTimers[timer].timerLast = perftimer.QuadPart;
+    timeoutTimers[timer].timerLast = timerval;
 }
 
 void TimeoutTimerDisable(sdword timer)
@@ -316,7 +333,7 @@
 
     while (numPackets > 0)
     {
-        sizeofPacket = Dequeue(&ProcessCaptaincyPktQ,&packet);
+        sizeofPacket = HWDequeue(&ProcessCaptaincyPktQ,&packet);
         dbgAssert(sizeofPacket > 0);
         copypacket = memAlloc(sizeofPacket,"cp(miscpacket)",Pyrophoric);
         memcpy(copypacket,packet,sizeofPacket);
@@ -339,7 +356,7 @@
     }
     else
     {
-        sizeofPacket = Dequeue(&ProcessCaptaincyPktQ,&packet);
+        sizeofPacket = HWDequeue(&ProcessCaptaincyPktQ,&packet);
         dbgAssert(sizeofPacket > 0);
         copypacket = memAlloc(sizeofPacket,"cp(miscpacket)",Pyrophoric);
         memcpy(copypacket,packet,sizeofPacket);
diff -urPw homeworld-orig/src/Game/Captaincy.h homeworld_sdl-0.3/src/Game/Captaincy.h
--- homeworld-orig/src/Game/Captaincy.h	2002-09-04 12:46:06.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Captaincy.h	2004-08-01 22:35:27.000000000 -0700
@@ -8,7 +8,7 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
+#include "Types.h"
 //#include "CommandNetwork.h"
 
 typedef enum CaptaincyEvent {
@@ -25,6 +25,8 @@
     CAPEVENT_RECEIVED_SYNC_PKT
 } CaptaincyEvent;
 
+struct CaptaincyCustomInfo;
+
 void TransferCaptaincyGameEnded(void);
 void TransferCaptaincyGameStarted(void);
 
diff -urPw homeworld-orig/src/Game/ChannelFSM.c homeworld_sdl-0.3/src/Game/ChannelFSM.c
--- homeworld-orig/src/Game/ChannelFSM.c	2002-09-04 12:46:06.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/ChannelFSM.c	2004-08-01 22:35:16.000000000 -0700
@@ -1,12 +1,13 @@
+#include <stdlib.h>
 #include <string.h>
-#include "types.h"
+#include "Types.h"
 #include "TitanInterfaceC.h"
 #include "ChannelFSM.h"
-#include "msg\ServerStatus.h"
-#include "debug.h"
-#include "multiplayergame.h"
-#include "strings.h"
-#include "titannet.h"
+#include "msg/ServerStatus.h"
+#include "Debug.h"
+#include "MultiplayerGame.h"
+#include "Strings.h"
+#include "TitanNet.h"
 
 // defines for the state of the connection to the chat server
 #define CS_Idle                 -1
@@ -270,11 +271,13 @@
     {
         cChannelFSMState = CS_RoomConnected;
         cChannelStateMachine();
+#ifndef _MACOSX_FIX_ME
         if (wcslen(RemoveGameRequest) >= 1)
         {
             titanRemoveGame(RemoveGameRequest);
             RemoveGameRequest[0] = 0;
         }
+#endif
         return;
     }
 }
diff -urPw homeworld-orig/src/Game/Chatting.c homeworld_sdl-0.3/src/Game/Chatting.c
--- homeworld-orig/src/Game/Chatting.c	2002-09-04 12:46:06.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Chatting.c	2004-08-01 22:35:24.000000000 -0700
@@ -10,22 +10,19 @@
 #include <stdio.h>
 #include <stdlib.h>
 
-#include "types.h"
-#include "commandNetwork.h"
-#include "memory.h"
-#include "debug.h"
-#include "horserace.h"
-#include "multiplayergame.h"
-#include "multiplayerlangame.h"
-#include "gamechat.h"
-#include "alliance.h"
+#include "Types.h"
+#include "CommandNetwork.h"
+#include "Memory.h"
+#include "Debug.h"
+#include "HorseRace.h"
+#include "MultiplayerGame.h"
+#include "MultiplayerLANGame.h"
+#include "GameChat.h"
+#include "Alliance.h"
 
 void recievedChatPacketCB(ubyte *packet,udword sizeofPacket)
 {
 #define chatpacket ((ChatPacket *)packet)
-    char *string = chatpacket->message;
-    uword message_from = ((HWPacketHeader *)packet)->frame;
-
     switch (chatpacket->messageType)
     {
         case CHAT_PACKET:
diff -urPw homeworld-orig/src/Game/Chatting.h homeworld_sdl-0.3/src/Game/Chatting.h
--- homeworld-orig/src/Game/Chatting.h	2002-09-04 12:46:06.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Chatting.h	2004-08-01 22:35:24.000000000 -0700
@@ -8,7 +8,7 @@
 #ifndef CHATTING_H
 #define CHATTING_H
 
-#include "types.h"
+#include "Types.h"
 
 // masks for players
 #define PLAYER_MASK(player)         (1<<player)
diff -urPw homeworld-orig/src/Game/Clamp.c homeworld_sdl-0.3/src/Game/Clamp.c
--- homeworld-orig/src/Game/Clamp.c	2002-09-04 12:46:06.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Clamp.c	2004-08-01 22:35:31.000000000 -0700
@@ -6,14 +6,14 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "spaceobj.h"
-#include "memory.h"
-#include "debug.h"
-#include "universe.h"
-#include "physics.h"
-#include "univupdate.h"
-#include "clamp.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "Memory.h"
+#include "Debug.h"
+#include "Universe.h"
+#include "Physics.h"
+#include "UnivUpdate.h"
+#include "Clamp.h"
 
 #define DEBUG_CLAMPING
 
diff -urPw homeworld-orig/src/Game/Clamp.h homeworld_sdl-0.3/src/Game/Clamp.h
--- homeworld-orig/src/Game/Clamp.h	2002-09-04 12:46:06.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Clamp.h	2004-08-01 22:35:32.000000000 -0700
@@ -6,7 +6,7 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "spaceobj.h"
+#include "SpaceObj.h"
 
 //to expand clamping to others than just ships, must modify line
 //in univupdate to check for more than just ships with
diff -urPw homeworld-orig/src/Game/Clipper.c homeworld_sdl-0.3/src/Game/Clipper.c
--- homeworld-orig/src/Game/Clipper.c	2002-09-04 12:46:06.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Clipper.c	2004-08-01 22:35:35.000000000 -0700
@@ -7,13 +7,15 @@
 =============================================================================*/
 
 #ifndef SW_Render
+#ifdef _WIN32
 #include <windows.h>
 #endif
-#include "types.h"
-#include "vector.h"
-#include "matrix.h"
+#endif
+#include "Types.h"
+#include "Vector.h"
+#include "Matrix.h"
 #include "glinc.h"
-#include "clipper.h"
+#include "Clipper.h"
 
 
 #define CORRECT_BBOX_CLIP 0
diff -urPw homeworld-orig/src/Game/Clipper.h homeworld_sdl-0.3/src/Game/Clipper.h
--- homeworld-orig/src/Game/Clipper.h	2002-09-04 12:46:06.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Clipper.h	2004-08-01 22:35:35.000000000 -0700
@@ -8,8 +8,8 @@
 #ifndef _CLIPPER_H
 #define _CLIPPER_H
 
-#include "types.h"
-#include "vector.h"
+#include "Types.h"
+#include "Vector.h"
 
 sdword clipViewclipLine(real32* vectors, udword* i, udword* j);
 void clipTransformPoints(udword n, real32* vobj, real32* vEye, real32* m);
diff -urPw homeworld-orig/src/Game/Clouds.c homeworld_sdl-0.3/src/Game/Clouds.c
--- homeworld-orig/src/Game/Clouds.c	2002-09-04 12:46:06.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Clouds.c	2004-08-01 22:35:21.000000000 -0700
@@ -7,29 +7,31 @@
 =============================================================================*/
 
 #ifndef SW_Render
+#ifdef _WIN32
 #include <windows.h>
 #endif
+#endif
 #include <stdio.h>
 #include <stdlib.h>
 #include <math.h>
-#include "types.h"
-#include "memory.h"
-#include "clouds.h"
-#include "vector.h"
-#include "matrix.h"
-#include "randy.h"
+#include "Types.h"
+#include "Memory.h"
+#include "Clouds.h"
+#include "Vector.h"
+#include "Matrix.h"
+#include "Randy.h"
 #include "glinc.h"
 #include "render.h"
-#include "linkedlist.h"
-#include "universe.h"
-#include "fastmath.h"
-#include "statscript.h"
+#include "LinkedList.h"
+#include "Universe.h"
+#include "FastMath.h"
+#include "StatScript.h"
 #include "mainrgn.h"
-#include "clipper.h"
-#include "shader.h"
+#include "Clipper.h"
+#include "Shader.h"
 #include "glcaps.h"
-#include "autolod.h"
-#include "univupdate.h"
+#include "AutoLOD.h"
+#include "UnivUpdate.h"
 #include "devstats.h"
 
 #ifndef M_PI_2
@@ -1288,7 +1290,6 @@
     color cloudColor = system->cloudColor;
     udword i;
     bool fogOn;
-    extern vector g_RndPosition;
 
     if (system == NULL)
     {
diff -urPw homeworld-orig/src/Game/Clouds.h homeworld_sdl-0.3/src/Game/Clouds.h
--- homeworld-orig/src/Game/Clouds.h	2002-09-04 12:46:06.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Clouds.h	2004-08-01 22:35:21.000000000 -0700
@@ -9,11 +9,11 @@
 #ifndef _CLOUDS_H
 #define _CLOUDS_H
 
-#include "types.h"
-#include "vector.h"
-#include "matrix.h"
+#include "Types.h"
+#include "Vector.h"
+#include "Matrix.h"
 #include "color.h"
-#include "objtypes.h"
+#include "ObjTypes.h"
 
 /*
  * STRUCTURES
diff -urPw homeworld-orig/src/Game/Collision.c homeworld_sdl-0.3/src/Game/Collision.c
--- homeworld-orig/src/Game/Collision.c	2002-09-04 12:46:06.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Collision.c	2004-08-01 22:35:31.000000000 -0700
@@ -6,24 +6,24 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "fastmath.h"
-#include "vector.h"
-#include "matrix.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "FastMath.h"
+#include "Vector.h"
+#include "Matrix.h"
+#include "SpaceObj.h"
 #include "prim3d.h"
 #include "render.h"
-#include "collision.h"
-#include "universe.h"
-#include "univupdate.h"
-#include "blobs.h"
+#include "Collision.h"
+#include "Universe.h"
+#include "UnivUpdate.h"
+#include "Blobs.h"
 #include "SalCapCorvette.h"
 #include "DefenseFighter.h"
 #include "DFGFrigate.h"
-#include "nis.h"
-#include "tactics.h"
-#include "alliance.h"
-#include "singleplayer.h"
+#include "NIS.h"
+#include "Tactics.h"
+#include "Alliance.h"
+#include "SinglePlayer.h"
 
 BlobProperties collBlobProperties;
 
@@ -1390,7 +1390,7 @@
                 goto nextobj1;
             }
 
-            if ((absdistcheck = abs(distcheck)) > maxdistCollPossible)
+            if ((absdistcheck = ABS(distcheck)) > maxdistCollPossible)
             {
                 goto nocollision;
             }
@@ -1554,7 +1554,7 @@
                 goto nextobj1;
             }
 
-            if ((absdistcheck = abs(distcheck)) > maxdistCollPossible)
+            if ((absdistcheck = ABS(distcheck)) > maxdistCollPossible)
             {
                 goto nocollision;
             }
@@ -1911,6 +1911,8 @@
 				}
 			}
             break;
+        default:
+            break;
         }
     }
 
@@ -2034,7 +2036,7 @@
                         //do bullet/missle target collision with its target only!
                          distcheck = bullet->target->collOptimizeDist - bullet->collOptimizeDist;
 
-                        if (abs(distcheck) > (bullet->target->staticinfo->staticheader.staticCollInfo.collspheresize+bullet->traveldist))
+                        if (ABS(distcheck) > (bullet->target->staticinfo->staticheader.staticCollInfo.collspheresize+bullet->traveldist))
                         {
                             //trivially reject...
                             goto nominecollision;
@@ -2064,6 +2066,8 @@
 						}
 
                         break;
+                    default:
+                        break;
                     }
                 }
 nominecollision:
@@ -2128,7 +2132,7 @@
 
                     if ((target->objtype != OBJ_ShipType) || (((Ship *)target)->shiptype != DFGFrigate && ((Ship *)target)->shiptype != DefenseFighter))
                     {
-                        if (abs(distcheck) > (targetstaticheader->staticCollInfo.collspheresize+bullet->traveldist))
+                        if (ABS(distcheck) > (targetstaticheader->staticCollInfo.collspheresize+bullet->traveldist))
                         {
                             goto nexttarget;
                         }
@@ -2366,7 +2370,7 @@
 
             targetstaticheader = &target->staticinfo->staticheader;
 
-            if (abs(distcheck) > (targetstaticheader->staticCollInfo.collspheresize+missile->maxtraveldist))
+            if (ABS(distcheck) > (targetstaticheader->staticCollInfo.collspheresize+missile->maxtraveldist))
             {
                 goto nexttarget;
             }
@@ -2531,7 +2535,7 @@
 
             targetstaticheader = &target->staticinfo->staticheader;
 
-            if (abs(distcheck) > (targetstaticheader->staticCollInfo.collspheresize+missile->maxtraveldist))
+            if (ABS(distcheck) > (targetstaticheader->staticCollInfo.collspheresize+missile->maxtraveldist))
             {
                 goto nexttarget;
             }
@@ -2690,7 +2694,7 @@
 
             targetstaticheader = &target->staticinfo->staticheader;
 
-            if (abs(distcheck) > (targetstaticheader->staticCollInfo.collspheresize+missile->maxtraveldist))
+            if (ABS(distcheck) > (targetstaticheader->staticCollInfo.collspheresize+missile->maxtraveldist))
             {
                 goto nexttarget;
             }
@@ -2835,7 +2839,7 @@
 
             targetstaticheader = &target->staticinfo->staticheader;
 
-            if (abs(distcheck) > (targetstaticheader->staticCollInfo.collspheresize+missile->maxtraveldist))
+            if (ABS(distcheck) > (targetstaticheader->staticCollInfo.collspheresize+missile->maxtraveldist))
             {
                 goto nexttarget;
             }
diff -urPw homeworld-orig/src/Game/Collision.h homeworld_sdl-0.3/src/Game/Collision.h
--- homeworld-orig/src/Game/Collision.h	2002-09-04 12:46:06.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Collision.h	2004-08-01 22:35:32.000000000 -0700
@@ -9,9 +9,9 @@
 #ifndef ___COLLISION_H
 #define ___COLLISION_H
 
-#include "types.h"
-#include "spaceobj.h"
-#include "blobs.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "Blobs.h"
 
 real32 RangeToTarget(Ship *ship,SpaceObjRotImpTarg *target,vector *trajectory);
 real32 RangeToTargetGivenDist(Ship *ship,SpaceObjRotImpTarg *target,real32 dist);
diff -urPw homeworld-orig/src/Game/ColPick.c homeworld_sdl-0.3/src/Game/ColPick.c
--- homeworld-orig/src/Game/ColPick.c	2002-09-04 12:46:06.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/ColPick.c	2004-08-01 22:35:21.000000000 -0700
@@ -10,27 +10,29 @@
 #define CP_SCALE_HUESAT 0
 
 #ifndef SW_Render
+#ifdef _WIN32
 #define WIN32_LEAN_AND_MEAN
 #include <windows.h>
 #endif
+#endif
 #include <stdio.h>
 #include "glinc.h"
-#include "types.h"
+#include "Types.h"
 #include "color.h"
 #include "prim2d.h"
 #include "font.h"
-#include "fontreg.h"
+#include "FontReg.h"
 #include "mouse.h"
-#include "memory.h"
+#include "Memory.h"
 #include "texreg.h"
 #include "mainrgn.h"
 #include "utility.h"
-#include "statscript.h"
-#include "objtypes.h"
+#include "StatScript.h"
+#include "ObjTypes.h"
 #include "render.h"
-#include "teams.h"
-#include "shipview.h"
-#include "colpick.h"
+#include "Teams.h"
+#include "ShipView.h"
+#include "ColPick.h"
 #include "glcompat.h"
 
 /*=============================================================================
@@ -507,7 +509,7 @@
     Outputs     : updates the current colors (cpBaseRed etc.)
     Return      : 0
 ----------------------------------------------------------------------------*/
-sdword cpValueProcess(regionhandle region, sdword ID, udword event, udword data)
+udword cpValueProcess(regionhandle region, sdword ID, udword event, udword data)
 {
     sdword *hue, *sat, *val, *red, *green, *blue;
     real32 realRed, realGreen, realBlue;
@@ -573,7 +575,8 @@
 
     return(mask);
 }
-sdword cpHueSaturationProcess(regionhandle region, sdword ID, udword event, udword data)
+
+udword cpHueSaturationProcess(regionhandle region, sdword ID, udword event, udword data)
 {
     sdword *hue, *sat, *val, *red, *green, *blue;
     real32 realRed, realGreen, realBlue;
@@ -1427,6 +1430,8 @@
         }
     }
     dbgAssert(FALSE);
+
+    return 0.0f;
 }
 
 /*-----------------------------------------------------------------------------
diff -urPw homeworld-orig/src/Game/ColPick.h homeworld_sdl-0.3/src/Game/ColPick.h
--- homeworld-orig/src/Game/ColPick.h	2002-09-04 12:46:06.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/ColPick.h	2004-08-01 22:35:21.000000000 -0700
@@ -9,10 +9,10 @@
 #ifndef ___COLPICK_H
 #define ___COLPICK_H
 
-#include "types.h"
+#include "Types.h"
 #include "color.h"
 #include "prim2d.h"
-#include "feflow.h"
+#include "FEFlow.h"
 #include "texreg.h"
 
 /*=============================================================================
@@ -51,8 +51,13 @@
 #define CP_HueSatTextureHeight      256
 #define CPGLC_HueSatTextureWidth    224
 #define CPGLC_HueSatTextureHeight   150
+#ifdef _WIN32
 #define CP_PreviewImageRace1        "ColorPicker\\Race1\\Race1.lif"
 #define CP_PreviewImageRace2        "ColorPicker\\Race2\\Race2.lif"
+#else
+#define CP_PreviewImageRace1        "ColorPicker/Race1/Race1.lif"
+#define CP_PreviewImageRace2        "ColorPicker/Race2/Race2.lif"
+#endif
 #define CP_PreviewWidth             256
 #define CP_PreviewHeight            128
 #define CP_ScreenName               "Select_colour"
diff -urPw homeworld-orig/src/Game/CommandLayer.c homeworld_sdl-0.3/src/Game/CommandLayer.c
--- homeworld-orig/src/Game/CommandLayer.c	2002-09-04 12:46:06.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/CommandLayer.c	2004-08-01 22:35:34.000000000 -0700
@@ -11,23 +11,23 @@
 #include <math.h>
 #include <string.h>
 #include <stdlib.h>
-#include "types.h"
-#include "fastmath.h"
-#include "debug.h"
-#include "memory.h"
-#include "formation.h"
-#include "commandlayer.h"
-#include "aiship.h"
-#include "aitrack.h"
-#include "statscript.h"
-#include "universe.h"
-#include "univupdate.h"
-#include "soundevent.h"
-#include "select.h"
-#include "collision.h"
-#include "flightman.h"
-#include "attack.h"
-#include "aiplayer.h"
+#include "Types.h"
+#include "FastMath.h"
+#include "Debug.h"
+#include "Memory.h"
+#include "Formation.h"
+#include "CommandLayer.h"
+#include "AIShip.h"
+#include "AITrack.h"
+#include "StatScript.h"
+#include "Universe.h"
+#include "UnivUpdate.h"
+#include "SoundEvent.h"
+#include "Select.h"
+#include "Collision.h"
+#include "FlightMan.h"
+#include "Attack.h"
+#include "AIPlayer.h"
 #include "GenericInterceptor.h"
 #include "DDDFrigate.h"
 #include "SalCapCorvette.h"
@@ -35,24 +35,24 @@
 #include "GravWellGenerator.h"
 #include "CloakGenerator.h"
 #include "ResearchShip.h"
-#include "researchAPI.h"
-#include "tactics.h"
-#include "singleplayer.h"
-#include "repaircorvette.h"
-#include "genericdefender.h"
-#include "alliance.h"
-#include "probe.h"
-#include "heavycorvette.h"
-#include "madLinkIn.h"
-#include "proximitysensor.h"
-#include "consmgr.h"
-#include "rescollect.h"
-#include "tutor.h"
-#include "randy.h"
-#include "battle.h"
-#include "ping.h"
-#include "netcheck.h"
-#include "commandnetwork.h"
+#include "ResearchAPI.h"
+#include "Tactics.h"
+#include "SinglePlayer.h"
+#include "RepairCorvette.h"
+#include "GenericDefender.h"
+#include "Alliance.h"
+#include "Probe.h"
+#include "HeavyCorvette.h"
+#include "MadLinkIn.h"
+#include "ProximitySensor.h"
+#include "ConsMgr.h"
+#include "ResCollect.h"
+#include "Tutor.h"
+#include "Randy.h"
+#include "Battle.h"
+#include "Ping.h"
+#include "NetCheck.h"
+#include "CommandNetwork.h"
 
 #ifdef gshaw
 #ifndef HW_Release
@@ -1572,7 +1572,6 @@
     sdword numShips = selection->numShips;
     sdword allNotAttacking;
     sdword formationoverride = FALSE;
-    sdword numShipsToAttack = attack->numTargets;
     Ship *ship;
     sdword pee;
     Ship *tempship;
@@ -2558,7 +2557,7 @@
 
                     movetodo->selection->ShipPtr[j]->hyperspacePing=TRUE;
                     //create ping HERE!
-                    newPing = pingCreate(NULL, (SpaceObj *)movetodo->selection->ShipPtr[j], hyperspaceOutPingTimeOut, NULL, 0, (udword)movetodo->selection->ShipPtr[j]);
+                    newPing = pingCreate(NULL, (SpaceObj *)movetodo->selection->ShipPtr[j], (pingeval)hyperspaceOutPingTimeOut, NULL, 0, (udword)movetodo->selection->ShipPtr[j]);
                     newPing->c = TW_HW_PING_COLOUR_OUT;
                     newPing->size = TW_HW_PING_MAX_SIZE_OUT;
                     newPing->minScreenSize = primScreenToGLScaleX(2);
@@ -2654,7 +2653,7 @@
                     ping *newPing;
                     movetodo->selection->ShipPtr[j]->hyperspacePing=TRUE;
                     //create ping HERE!
-                    newPing = pingCreate(NULL, (SpaceObj *)movetodo->selection->ShipPtr[j], hyperspaceInPingTimeOut, NULL, 0, (udword)movetodo->selection->ShipPtr[j]);
+                    newPing = pingCreate(NULL, (SpaceObj *)movetodo->selection->ShipPtr[j], (pingeval)hyperspaceInPingTimeOut, NULL, 0, (udword)movetodo->selection->ShipPtr[j]);
                     newPing->c = TW_HW_PING_COLOUR_IN;
                     newPing->size = TW_HW_PING_MAX_SIZE_IN;
                     newPing->minScreenSize = primScreenToGLScaleX(2);
@@ -5335,8 +5334,6 @@
     sdword i;
     SelectCommand *selection = todo->selection;
     sdword numShips = selection->numShips;
-    AttackCommand *attack = todo->attack;
-    sdword numShipsToAttack = attack->numTargets;
     Ship *ship;
     AttackTargets *multipleAttackTargets;
 
@@ -5793,7 +5790,7 @@
     vecDivideByScalar(avgposSelection,((real32)numShips),temp);
     vecDivideByScalar(avgposTargets,((real32)numTargetsToAttack),temp);
     vecSub(diff,avgposSelection,avgposTargets);
-    diff.z = abs(diff.z);
+    diff.z = ABS(diff.z);
 
     if ((diff.z >= ATTACKING_FROM_ABOVE_MIN_DIST) &&
         (diff.z >= (fsqrt(diff.x*diff.x + diff.y*diff.y)*ATTACKING_FROM_ABOVE_MIN_RATIO)))
@@ -6363,7 +6360,6 @@
 ----------------------------------------------------------------------------*/
 void ChangeOrderToSpecial(CommandToDo *alreadycommand,SpecialCommand *targets)
 {
-    SelectCommand *selection = alreadycommand->selection;
     SpecialCommand *specialtargets;
     udword sizeofspecialtargets;
 
@@ -8835,7 +8831,6 @@
                     {
                         if (command->dock.wasHarvesting)
                         {
-                            Ship *resourceShip = command->selection->ShipPtr[0];
                             dbgAssert(command->selection->numShips == 1);
 
                             // changing COMMAND_DOCK to COMMAND_COLLECTRESOURCE
diff -urPw homeworld-orig/src/Game/CommandLayer.h homeworld_sdl-0.3/src/Game/CommandLayer.h
--- homeworld-orig/src/Game/CommandLayer.h	2002-09-04 12:46:06.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/CommandLayer.h	2004-08-01 22:35:34.000000000 -0700
@@ -10,13 +10,13 @@
 #ifndef ___COMMAND_LAYER_H
 #define ___COMMAND_LAYER_H
 
-#include "types.h"
-#include "vector.h"
-#include "spaceobj.h"
-#include "shipselect.h"
-#include "formation.h"
-#include "dock.h"
-#include "rescollect.h"
+#include "Types.h"
+#include "Vector.h"
+#include "SpaceObj.h"
+#include "ShipSelect.h"
+#include "Formation.h"
+#include "Dock.h"
+#include "ResCollect.h"
 #include "CommandDefs.h"
 
 #ifndef HW_Release
@@ -57,8 +57,8 @@
 typedef SelectCommand ProtectCommand;
 typedef SelectCommandMax6 ProtectCommandMax6;
 
-#define IAmAWingman(attackvar) (attackvar##->myLeaderIs)
-#define IAmALeader(attackvar) (attackvar##->myWingmanIs)
+#define IAmAWingman(attackvar) ((attackvar)->myLeaderIs)
+#define IAmALeader(attackvar) ((attackvar)->myWingmanIs)
 
 typedef struct
 {
@@ -139,6 +139,8 @@
 void clProcess(CommandLayer *comlayer);
 void clPostProcess(CommandLayer *comlayer);
 
+void clChecksum(void);
+
 // Ship Command Layer
 void clMove(CommandLayer *comlayer,SelectCommand *selectcom,vector from,vector to);
 CommandToDo *clAttackThese(CommandLayer *comlayer,SelectCommand *selectcom,AttackCommand *attackcom);
diff -urPw homeworld-orig/src/Game/CommandNetwork.c homeworld_sdl-0.3/src/Game/CommandNetwork.c
--- homeworld-orig/src/Game/CommandNetwork.c	2002-09-04 12:46:06.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/CommandNetwork.c	2004-08-01 22:35:22.000000000 -0700
@@ -9,31 +9,31 @@
 
 #include <string.h>
 #include <stdlib.h>
-#include "switches.h"
-#include "types.h"
-#include "debug.h"
-#include "memory.h"
-#include "task.h"
-#include "queue.h"
-#include "universe.h"
-#include "univupdate.h"
+#include "Switches.h"
+#include "Types.h"
+#include "Debug.h"
+#include "Memory.h"
+#include "Task.h"
+#include "Queue.h"
+#include "Universe.h"
+#include "UnivUpdate.h"
 #include "CommandLayer.h"
-#include "netcheck.h"
-#include "globals.h"
+#include "NetCheck.h"
+#include "Globals.h"
 #include "utility.h"
 #include "CommandNetwork.h"
 #include "TitanInterfaceC.h"
 #include "HorseRace.h"
-#include "chatting.h"
+#include "Chatting.h"
 #include "mainswitches.h"
 #include "Captaincy.h"
-#include "titan.h"
+#include "Titan.h"
 #include "TimeoutTimer.h"
-#include "titannet.h"
-#include "multiplayergame.h"        // for mutex stuff
-#include "autodownloadmap.h"
+#include "TitanNet.h"
+#include "MultiplayerGame.h"        // for mutex stuff
+#include "AutoDownloadMap.h"
 #include "LagPrint.h"
-#include "sensors.h"
+#include "Sensors.h"
 
 /*=============================================================================
     Private Defines:
@@ -91,7 +91,6 @@
 void receivedIAmAlivePacket(HWPacketHeader *packet,udword sizeofPacket);
 void receivedAliveStatusPacket(AliveStatusPacket *packet,udword sizeofPacket);
 
-static void SendCaptainInfoPacket(void);
 void BroadCastHorseRacePacketFromCaptain(ubyte *packet, udword sizeofpacket);
 void BroadCastChatPacketFromCapatain(ChatPacket *packet, udword sizeofpacket);
 
@@ -151,7 +150,7 @@
     dbgAssert(((HWPacketHeader *)packet)->type == PACKETTYPE_SYNC);
 
     LockQueue(&ProcessSyncPktQ);
-    Enqueue(&ProcessSyncPktQ,packet,sizeofPacket);
+    HWEnqueue(&ProcessSyncPktQ,packet,sizeofPacket);
     UnLockQueue(&ProcessSyncPktQ);
 }
 
@@ -170,7 +169,7 @@
     if (IAmCaptain)
     {
         LockQueue(&ProcessCmdPktQ);
-        Enqueue(&ProcessCmdPktQ,packet,sizeofPacket);
+        HWEnqueue(&ProcessCmdPktQ,packet,sizeofPacket);
         UnLockQueue(&ProcessCmdPktQ);
     }
     // else throw packet away
@@ -189,7 +188,7 @@
     dbgAssert(((HWPacketHeader *)packet)->type == PACKETTYPE_REQUESTEDSYNC);
 
     LockQueue(&ProcessRequestedSyncPktQ);
-    Enqueue(&ProcessRequestedSyncPktQ,packet,sizeofPacket);
+    HWEnqueue(&ProcessRequestedSyncPktQ,packet,sizeofPacket);
     UnLockQueue(&ProcessRequestedSyncPktQ);
 }
 
@@ -250,7 +249,7 @@
     dbgAssert(((HWPacketHeader *)packet)->type == PACKETTYPE_TRANSFERCAPTAINCY);
 
     LockQueue(&ProcessCaptaincyPktQ);
-    Enqueue(&ProcessCaptaincyPktQ,packet,sizeofPacket);
+    HWEnqueue(&ProcessCaptaincyPktQ,packet,sizeofPacket);
     UnLockQueue(&ProcessCaptaincyPktQ);
 }
 
@@ -471,6 +470,8 @@
         case OBJ_DerelictType:
             targetID->objNumber = ((Derelict *)target)->derelictID.derelictNumber;
             break;
+        default:
+            break;
     }
 }
 
@@ -508,8 +509,12 @@
         else
         {
             shipPlayerIndex = selectCommand->ShipPtr[i]->playerowner->playerIndex;
-            if ((shipPlayerIndex >= 0) && (shipPlayerIndex < tpGameCreated.numPlayers))     // if it's a human ship
-            if (shipPlayerIndex != from)                                                    // do further cheat check - only can control own ship
+            
+            // if it's a human ship
+            if ((shipPlayerIndex >= 0) && (shipPlayerIndex < tpGameCreated.numPlayers))
+            {
+                // do further cheat check - only can control own ship
+                if (shipPlayerIndex != from)
             {
                 selectCommand->ShipPtr[i] = NULL;       // reject ship
                 someShipsDied = TRUE;
@@ -517,6 +522,7 @@
             }
         }
     }
+    }
 
     if (someShipsDied)
     {
@@ -1914,7 +1920,7 @@
         }
         else
         {
-            sizeofPacket = Dequeue(&ProcessRequestedSyncPktQ,&packet);       // actually dequeue it
+            sizeofPacket = HWDequeue(&ProcessRequestedSyncPktQ,&packet);       // actually HWDequeue it
             dbgAssert(sizeofPacket > 0);
             copypacket = memAlloc(sizeofPacket,"cp(copypacket)",Pyrophoric);
             memcpy(copypacket,packet,sizeofPacket);
@@ -1963,12 +1969,12 @@
 
             if (((HWPacketHeader *)packet)->frame == receivedPacketNumber)
             {
-                sizeofPacket = Dequeue(&ProcessSyncPktQ,&packet);       // actually dequeue it
+                sizeofPacket = HWDequeue(&ProcessSyncPktQ,&packet);       // actually HWDequeue it
                 dbgAssert(sizeofPacket > 0);
                 break;
             }
 
-            // frame is > receivedPacketNumber, don't dequeue it,
+            // frame is > receivedPacketNumber, don't HWDequeue it,
             if (!explicitlyRequestingPackets)       // and request packets receivedPacketNumber..frame-1 (but only once)
             {
                 explicitlyRequestingFrom = receivedPacketNumber;
@@ -1986,7 +1992,7 @@
             return NO_PACKET;
 
 getnextpacket:
-            sizeofPacket = Dequeue(&ProcessSyncPktQ,&packet);       // actually dequeue it
+            sizeofPacket = HWDequeue(&ProcessSyncPktQ,&packet);       // actually HWDequeue it
             dbgAssert(sizeofPacket > 0);
             numPackets = queueNumberEntries(ProcessSyncPktQ);
             if (numPackets == 0)
@@ -2047,7 +2053,9 @@
 
     taskYield(0);
 
+#ifndef C_ONLY
     for(;;)
+#endif
     {
         taskStackSaveCond(0);
         if ( (recordFakeSendPackets) ||
@@ -2077,7 +2085,7 @@
             while (queueNumberEntries(ProcessCmdPktQ) > 0)
             {
                 curqinfo = &qinfos[numCommands];
-                curqinfo->qsizeof = Dequeue(&ProcessCmdPktQ,(ubyte **)&curqinfo->qdata);
+                curqinfo->qsizeof = HWDequeue(&ProcessCmdPktQ,(ubyte **)&curqinfo->qdata);
                 dbgAssert(curqinfo->qsizeof > 0);
                 dbgAssert(curqinfo->qdata != NULL);
                 dbgAssert(numCommands < qTotalNumberEntries);
@@ -2164,6 +2172,7 @@
         taskStackRestoreCond();
         taskYield(0);
     }
+
     taskExit();
 }
 #pragma optimize("", on)
diff -urPw homeworld-orig/src/Game/CommandNetwork.h homeworld_sdl-0.3/src/Game/CommandNetwork.h
--- homeworld-orig/src/Game/CommandNetwork.h	2002-09-04 12:46:06.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/CommandNetwork.h	2004-08-01 22:35:23.000000000 -0700
@@ -7,13 +7,13 @@
 =============================================================================*/
 
 #ifndef ___COMMAND_NETWORK_H
-#define ___COMMNAD_NETWORK_H
+#define ___COMMAND_NETWORK_H
 
-#include "switches.h"
-#include "types.h"
-#include "globals.h"
-#include "commandlayer.h"
-#include "chatting.h"
+#include "Switches.h"
+#include "Types.h"
+#include "Globals.h"
+#include "CommandLayer.h"
+#include "Chatting.h"
 
 
 
diff -urPw homeworld-orig/src/Game/CommandWrap.c homeworld_sdl-0.3/src/Game/CommandWrap.c
--- homeworld-orig/src/Game/CommandWrap.c	2002-09-04 12:46:06.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/CommandWrap.c	2004-08-01 22:35:23.000000000 -0700
@@ -8,19 +8,20 @@
 =============================================================================*/
 
 #include <string.h>
-#include "types.h"
+#include "Types.h"
 #include "CommandLayer.h"
 #include "CommandNetwork.h"
 #include "CommandWrap.h"
-#include "universe.h"
-#include "globals.h"
+#include "Universe.h"
+#include "Globals.h"
 #include "mainswitches.h"
 #include "SoundEvent.h"
-#include "tutor.h"
-#include "multiplayergame.h"
-#include "salcapcorvette.h"
-#include "shipselect.h"
-#include "select.h"
+#include "Tutor.h"
+#include "MultiplayerGame.h"
+#include "SalCapCorvette.h"
+#include "ShipSelect.h"
+#include "Select.h"
+#include "InfoOverlay.h"
 
 /*-----------------------------------------------------------------------------
     Name        : clCommandMessage
diff -urPw homeworld-orig/src/Game/CommandWrap.h homeworld_sdl-0.3/src/Game/CommandWrap.h
--- homeworld-orig/src/Game/CommandWrap.h	2002-09-04 12:46:06.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/CommandWrap.h	2004-08-01 22:35:23.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___COMMAND_WRAP_H
 #define ___COMMNAD_WRAP_H
 
-#include "types.h"
-#include "commandlayer.h"
+#include "Types.h"
+#include "CommandLayer.h"
 
 void clCommandMessage(char CommandMessage[MAX_MESSAGE_LENGTH]);
 
diff -urPw homeworld-orig/src/Game/ConsMgr.c homeworld_sdl-0.3/src/Game/ConsMgr.c
--- homeworld-orig/src/Game/ConsMgr.c	2002-09-04 12:46:08.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/ConsMgr.c	2004-08-01 22:35:29.000000000 -0700
@@ -6,56 +6,63 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
+#ifdef _WIN32
 #define WIN32_LEAN_AND_MEAN
 #include <windows.h>
+#endif
+
 #include <stdio.h>
-#include "types.h"
-#include "linkedlist.h"
-#include "universe.h"
-#include "region.h"
-#include "uicontrols.h"
-#include "feflow.h"
+#include "Types.h"
+#include "LinkedList.h"
+#include "Universe.h"
+#include "Region.h"
+#include "UIControls.h"
+#include "FEFlow.h"
 #include "font.h"
-#include "fontreg.h"
-#include "objtypes.h"
-#include "task.h"
+#include "FontReg.h"
+#include "ObjTypes.h"
+#include "Task.h"
 #include "mouse.h"
 #include "MultiplayerGame.h"
 #include "CommandLayer.h"
-#include "piePlate.h"
+#include "PiePlate.h"
 #include "ConsMgr.h"
-#include "globals.h"
+#include "Globals.h"
 #include "CommandWrap.h"
-#include "scroller.h"
-#include "soundevent.h"
-#include "randy.h"
-#include "strings.h"
-#include "researchapi.h"
+#include "Scroller.h"
+#include "SoundEvent.h"
+#include "Randy.h"
+#include "Strings.h"
+#include "ResearchAPI.h"
 #include "mainrgn.h"
-#include "taskbar.h"
-#include "shipview.h"
+#include "TaskBar.h"
+#include "ShipView.h"
 #include "glinc.h"
 #include "glcaps.h"
 #include "render.h"
 #include "mainrgn.h"
-#include "sensors.h"
-#include "singleplayer.h"
-#include "ping.h"
+#include "Sensors.h"
+#include "SinglePlayer.h"
+#include "Ping.h"
 #include "texreg.h"
-#include "fereg.h"
-#include "shipdefs.h"
-#include "nis.h"
-#include "tutor.h"
-#include "options.h"
+#include "FEReg.h"
+#include "ShipDefs.h"
+#include "NIS.h"
+#include "Tutor.h"
+#include "Options.h"
 #include "FEColour.h"
 #include "glcompat.h"
-#include "infooverlay.h"
+#include "InfoOverlay.h"
 #include "SaveGame.h"
 
 /*=============================================================================
     Definitions:
 =============================================================================*/
+#ifdef _WIN32
 #define CM_FIBFile              "FEMan\\Construction_Manager.fib"
+#else
+#define CM_FIBFile              "FEMan/Construction_Manager.fib"
+#endif
 #define CM_ConstructionScreen   "Construction_manager"
 //#define CM_BuildScreen          "Build_screen"
 #define CM_DefaultFont          "default.hff"
@@ -598,14 +605,19 @@
 
 char *ShipImagePaths[] =
 {
-    {"FEMan\\Construction_Manager\\Build_race1_"},
-    {"FEMan\\Construction_Manager\\Build_race2_"}
+#ifdef _WIN32
+    "FEMan\\Construction_Manager\\Build_race1_",
+    "FEMan\\Construction_Manager\\Build_race2_"
+#else
+    "FEMan/Construction_Manager/Build_race1_",
+    "FEMan/Construction_Manager/Build_race2_"
+#endif
 };
 
 char *ShipIcons[] =
 {
-    {"icon1.lif"}, // Mothership
-    {"icon2.lif"}  // Carrier
+    "icon1.lif", // Mothership
+    "icon2.lif"  // Carrier
 };
 
 udword cmArrowTexture[6] =
@@ -620,16 +632,20 @@
 };
 
 
+#ifdef _WIN32
 #define ARROW_ICON_PATH "FEMan\\Textures\\"
+#else
+#define ARROW_ICON_PATH "FEMan/Textures/"
+#endif
 
 char *ArrowIcons[] =
 {
-    {"Build_arrow_left_mouse.lif"},
-    {"Build_Arrow_Left_on.lif"},
-    {"Build_Arrow_Left_off.lif"},
-    {"Build_Arrow_right_mouse.lif"},
-    {"Build_Arrow_right_on.lif"},
-    {"Build_Arrow_right_off.lif"},
+    "Build_arrow_left_mouse.lif",
+    "Build_Arrow_Left_on.lif",
+    "Build_Arrow_Left_off.lif",
+    "Build_Arrow_right_mouse.lif",
+    "Build_Arrow_right_on.lif",
+    "Build_Arrow_right_off.lif",
 };
 
 
@@ -2501,14 +2517,11 @@
 
     if ( (event == RPE_HoldLeft) && (cmArrowIndex!=-1) && mgAccelerator())
     {
-        bool8 skip = FALSE;
-
         if ((tutorial==TUTORIAL_ONLY) && !tutEnable.bBuildArrows)
             return(0);
 
         cmLeftArrowActive = TRUE;
 
-
         if (keyIsHit(CM_FIVEKEY))
         {
             uword j;
@@ -4467,7 +4480,7 @@
     Player* player = &universe.players[dprog->playerIndex];
     player->resourceUnits += amount;
 
-    universe.gameStats.playerStats[player->playerIndex].totalResourceUnitsSpent += min(player->resourceUnits, abs(amount));
+    universe.gameStats.playerStats[player->playerIndex].totalResourceUnitsSpent += min(player->resourceUnits, ABS(amount));
 
     if (player->resourceUnits < 0)
     {
@@ -4810,7 +4823,7 @@
 {
     cmDetermProgress_t copy = *((cmDetermProgress_t *)stuff);
 
-    copy.creator = SpaceObjRegistryGetID((SpaceObj *)copy.creator);
+    copy.creator = (ShipPtr)SpaceObjRegistryGetID((SpaceObj *)copy.creator);
 
     SaveStructureOfSize(&copy,sizeof(copy));
 }
diff -urPw homeworld-orig/src/Game/ConsMgr.h homeworld_sdl-0.3/src/Game/ConsMgr.h
--- homeworld-orig/src/Game/ConsMgr.h	2002-09-04 12:46:08.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/ConsMgr.h	2004-08-01 22:35:29.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___CONSMGR_H
 #define ___CONSMGR_H
 
-#include "types.h"
-#include "region.h"
+#include "Types.h"
+#include "Region.h"
 
 /*=============================================================================
     Switches:
diff -urPw homeworld-orig/src/Game/Crates.c homeworld_sdl-0.3/src/Game/Crates.c
--- homeworld-orig/src/Game/Crates.c	2002-09-04 12:46:08.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Crates.c	2004-08-01 22:35:17.000000000 -0700
@@ -8,20 +8,20 @@
 
 #include <stdlib.h>
 
-#include "types.h"
-#include "spaceobj.h"
-#include "univupdate.h"
-#include "universe.h"
-#include "blobs.h"
-#include "aitrack.h"
-#include "linkedlist.h"
-#include "researchapi.h"
-#include "multiplayergame.h"
-#include "levelload.h"
-#include "randy.h"
-#include "soundevent.h"
-#include "sensors.h"
-#include "pieplate.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "UnivUpdate.h"
+#include "Universe.h"
+#include "Blobs.h"
+#include "AITrack.h"
+#include "LinkedList.h"
+#include "ResearchAPI.h"
+#include "MultiplayerGame.h"
+#include "LevelLoad.h"
+#include "Randy.h"
+#include "SoundEvent.h"
+#include "Sensors.h"
+#include "PiePlate.h"
 
 
 real32 CRATES_DoWeNeedToAddCratesCheckTime =380.0f;  //every X seconds, the crate functions will check to see if it should add a crate to the world
diff -urPw homeworld-orig/src/Game/Crates.h homeworld_sdl-0.3/src/Game/Crates.h
--- homeworld-orig/src/Game/Crates.h	2002-09-04 12:46:08.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Crates.h	2004-08-01 22:35:17.000000000 -0700
@@ -10,7 +10,7 @@
 #ifndef CRATES_H
 #define CRATES_H
  
-#include "spaceobj.h"
+#include "SpaceObj.h"
       
 //prototypes      
 void cratesUpdate();    
diff -urPw homeworld-orig/src/Game/CRC32.c homeworld_sdl-0.3/src/Game/CRC32.c
--- homeworld-orig/src/Game/CRC32.c	2002-09-04 12:46:08.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/CRC32.c	2004-08-01 22:35:18.000000000 -0700
@@ -6,7 +6,7 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "crc32.h"
+#include "CRC32.h"
 
 /*=============================================================================
     Data:
diff -urPw homeworld-orig/src/Game/CRC32.h homeworld_sdl-0.3/src/Game/CRC32.h
--- homeworld-orig/src/Game/CRC32.h	2002-09-04 12:46:08.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/CRC32.h	2004-08-01 22:35:18.000000000 -0700
@@ -9,7 +9,7 @@
 #ifndef ___CRC32_H
 #define ___CRC32_H
 
-#include "types.h"
+#include "Types.h"
 
 /*=============================================================================
     Type definitions
diff -urPw homeworld-orig/src/Game/Damage.c homeworld_sdl-0.3/src/Game/Damage.c
--- homeworld-orig/src/Game/Damage.c	2002-09-04 12:46:08.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Damage.c	2004-08-01 22:35:31.000000000 -0700
@@ -9,17 +9,17 @@
 #include <math.h>
 #include <string.h>
 #include "glinc.h"
-#include "spaceobj.h"
-#include "etg.h"
+#include "SpaceObj.h"
+#include "ETG.h"
 #include "trails.h"
-#include "univupdate.h"
-#include "damage.h"
-#include "statscript.h"
-#include "debug.h"
-#include "mex.h"
-#include "memory.h"
-#include "randy.h"
-#include "singleplayer.h"
+#include "UnivUpdate.h"
+#include "Damage.h"
+#include "StatScript.h"
+#include "Debug.h"
+#include "MEX.h"
+#include "Memory.h"
+#include "Randy.h"
+#include "SinglePlayer.h"
 
 
 #define DMG_WORLDSPACE 1
diff -urPw homeworld-orig/src/Game/Damage.h homeworld_sdl-0.3/src/Game/Damage.h
--- homeworld-orig/src/Game/Damage.h	2002-09-04 12:46:08.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Damage.h	2004-08-01 22:35:31.000000000 -0700
@@ -9,7 +9,7 @@
 #ifndef _DAMAGE_H
 #define _DAMAGE_H
 
-#include "spaceobj.h"
+#include "SpaceObj.h"
 
 #ifndef HW_Release
 
diff -urPw homeworld-orig/src/Game/Debug.c homeworld_sdl-0.3/src/Game/Debug.c
--- homeworld-orig/src/Game/Debug.c	2002-09-04 12:46:08.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Debug.c	2004-08-01 22:35:26.000000000 -0700
@@ -10,11 +10,12 @@
 #include <string.h>
 #include <time.h>
 #include "resource.h"
-#include "types.h"
+#include "Types.h"
 #include "utility.h"
 #include "debugwnd.h"
-#include "task.h"
-#include "debug.h"
+#include "Task.h"
+#include "Debug.h"
+#include "File.h"
 
 /*=============================================================================
     Data:
@@ -35,7 +36,15 @@
 ----------------------------------------------------------------------------*/
 sdword dbgMessage(char *string)
 {
-    return(dbwPrint(0, string));
+    /* Debug window disabled (using stdout instead, at least for now).
+       dbw*() functions in other parts of code (main.c, utility.c, and
+       Options.c) will need to be uncommented if the debug window is
+       reenabled. */
+    /*return(dbwPrint(0, string));*/
+    if (string[0] == '\n')
+        string++;
+    printf("%s\n", string);
+    return OKAY;
 }
 
 /*-----------------------------------------------------------------------------
@@ -54,7 +63,7 @@
     sdword nParams;
 
     va_start(argList, format);                              //get first arg
-    _vsnprintf(buffer, DBG_BufferMax, format, argList);                      //prepare output string
+    vsnprintf(buffer, DBG_BufferMax, format, argList);                      //prepare output string
     va_end(argList);
 
     nParams = dbgMessage(buffer);
@@ -75,7 +84,7 @@
 {
     char buffer[DBG_BufferLength];
 
-    _snprintf(buffer, DBG_BufferMax, "\n%s (%d): Warning- %s", file, line, string);
+    snprintf(buffer, DBG_BufferMax, "\n%s (%d): Warning- %s", file, line, string);
 
     return(dbgMessage(buffer));                             //print the message
 }
@@ -98,9 +107,9 @@
     va_list argList;
     sdword returnValue;
 
-    _snprintf(newFormat, DBG_BufferMax, "\n%s (%d): Warning- %s", file, line, format);
+    snprintf(newFormat, DBG_BufferMax, "\n%s (%d): Warning- %s", file, line, format);
     va_start(argList, format);                              //get first arg
-    _vsnprintf(buffer, DBG_BufferMax, newFormat, argList);                   //prepare output string
+    vsnprintf(buffer, DBG_BufferMax, newFormat, argList);                   //prepare output string
     va_end(argList);
 
     returnValue = dbgMessage(buffer);
@@ -119,7 +128,7 @@
 ----------------------------------------------------------------------------*/
 sdword dbgFatal(char *file, sdword line, char *string)
 {
-    _snprintf(dbgFatalErrorString, DBG_BufferMax, "\n%s (%d): Fatal error - %s", file, line, string);
+    snprintf(dbgFatalErrorString, DBG_BufferMax, "\n%s (%d): Fatal error - %s", file, line, string);
 #if DBG_STACK_CONTEXT
     {
         char *fileName = dbgStackDump();
@@ -133,7 +142,11 @@
     dbgMessage(dbgFatalErrorString);                        //print the message
     if (dbgInt3Enabled)
     {
+#if defined (_MSC_VER)
         _asm int 3
+#elif defined (__GNUC__) && defined (__i386__)
+        __asm__ ( "int $3\n\t" );
+#endif
     }
     utyFatalErrorWaitLoop(DBG_ExitCode);                    //exit with a MessageBox
     return(ERROR);
@@ -155,9 +168,9 @@
     char newFormat[DBG_BufferLength];
     va_list argList;
 
-    _snprintf(newFormat, DBG_BufferMax, "\n%s (%d): Fatal Error - %s", file, line, format);
+    snprintf(newFormat, DBG_BufferMax, "\n%s (%d): Fatal Error - %s", file, line, format);
     va_start(argList, format);                              //get first arg
-    _vsnprintf(dbgFatalErrorString, DBG_BufferMax, newFormat, argList);      //prepare output string
+    vsnprintf(dbgFatalErrorString, DBG_BufferMax, newFormat, argList);      //prepare output string
     va_end(argList);
 #if DBG_STACK_CONTEXT
     {
@@ -172,7 +185,11 @@
     dbgMessage(dbgFatalErrorString);                        //print the message
     if (dbgInt3Enabled)
     {
+#if defined (_MSC_VER)
         _asm int 3
+#elif defined (__GNUC__) && defined (__i386__)
+        __asm__ ( "int $3\n\t" );
+#endif
     }
     utyFatalErrorWaitLoop(DBG_ExitCode);                    //exit with a MessageBox
     return(ERROR);
@@ -191,7 +208,11 @@
     sprintf(dbgFatalErrorString, "\n%s (%d): Non-fatal error - %s", file, line, error);
     if (utyNonFatalErrorWaitLoop() && dbgInt3Enabled)
     {
+#if defined (_MSC_VER)
         _asm int 3
+#elif defined (__GNUC__) && defined (__i386__)
+        __asm__ ( "int $3\n\t" );
+#endif
     }
     return(0);
 }
@@ -225,7 +246,7 @@
     Return      : filename of file written to, or NULL on error
 ----------------------------------------------------------------------------*/
 #if DBG_STACK_CONTEXT
-static char dbgStackFilename[256];
+static char dbgStackFilename[PATH_MAX + 1];
 udword dbgStackBase = 0;
 char *dbgStackDump(void)
 {
@@ -242,8 +263,12 @@
     }
 
     //find stack pointers
+#if defined (_MSC_VER)
     _asm mov eax, esp
     _asm mov _ESP, eax
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ ( "movl %%esp, %0\n\t" : "=r" (_ESP) );
+#endif
 
     _ESP = _ESP & (~3);                                     //round off to dword boundary
     dbgStackBase = dbgStackBase & (~3);
@@ -260,7 +285,12 @@
             *blankPtr = '-';
         }
     }
-    fp = fopen(dbgStackFilename, "wb");                     //open the dump file
+
+    blankPtr = filePathPrepend(dbgStackFilename, FF_UserSettingsPath);
+    if (!fileMakeDestinationDirectory(blankPtr))
+        return NULL;
+
+    fp = fopen(blankPtr, "wb");                             //open the dump file
     if (fp == NULL)
     {
         return(NULL);
diff -urPw homeworld-orig/src/Game/Debug.h homeworld_sdl-0.3/src/Game/Debug.h
--- homeworld-orig/src/Game/Debug.h	2002-09-04 12:46:08.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Debug.h	2004-08-01 22:35:27.000000000 -0700
@@ -16,7 +16,7 @@
 #endif
 #endif
 
-#include "types.h"
+#include "Types.h"
 
 /*=============================================================================
     Switches:
diff -urPw homeworld-orig/src/Game/Demo.c homeworld_sdl-0.3/src/Game/Demo.c
--- homeworld-orig/src/Game/Demo.c	2002-09-04 12:46:08.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Demo.c	2004-08-01 22:35:32.000000000 -0700
@@ -9,21 +9,21 @@
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
-#include "types.h"
-#include "file.h"
-#include "memory.h"
-#include "debug.h"
-#include "key.h"
-#include "region.h"
+#include "Types.h"
+#include "File.h"
+#include "Memory.h"
+#include "Debug.h"
+#include "Key.h"
+#include "Region.h"
 #include "mouse.h"
-#include "univupdate.h"
-#include "randy.h"
-#include "camera.h"
+#include "UnivUpdate.h"
+#include "Randy.h"
+#include "Camera.h"
 #include "mainrgn.h"
-#include "select.h"
+#include "Select.h"
 #include "render.h"
-#include "netcheck.h"
-#include "demo.h"
+#include "NetCheck.h"
+#include "Demo.h"
 
 /*=============================================================================
     Data:
@@ -116,6 +116,9 @@
 
     if (*demFileSaveName)
     {
+        if (!fileMakeDestinationDirectory(demFileSaveName))
+            return;
+
         appendfile = fopen(demFileSaveName, "ab");
         if (appendfile != NULL)
         {
@@ -135,6 +138,7 @@
 ----------------------------------------------------------------------------*/
 void demRecordStart(char *fileName, demstatesave saveFunction)
 {
+    char *fullFileName;
     demoheader header;
     ubyte *stateBuffer;
 #if DEM_RANDY_SAVE
@@ -164,8 +168,9 @@
     }
 
     //open the file         (actually, delete it, and every time we will open it in append write mode)
-    strcpy(demFileSaveName,fileName);
-    remove(fileName);
+    fullFileName = filePathPrepend(fileName, FF_UserSettingsPath);
+    strcpy(demFileSaveName, fullFileName);
+    remove(fullFileName);
 
     demBlockWrite(&header, sizeof(header));
     if (header.initialStateSize > 0)
@@ -176,10 +181,16 @@
 #if DEM_CHECKSUM
     if (logEnable == LOG_VERBOSE)
     {
-        netlogfile = fopen(DEM_LogFileName, "wb");
+        char *demLogFileNameFull = filePathPrepend(
+            DEM_LogFileName, FF_UserSettingsPath);
+        if (fileMakeDestinationDirectory(demLogFileNameFull))
+        {
+            netlogfile = fopen(demLogFileNameFull, "wb");
+            if (netlogfile)
         fclose(netlogfile);
         netlogfile = NULL;
     }
+    }
 #endif
     demPacketNumber = 0;
     demStateSave();
@@ -209,12 +220,17 @@
     {
         if (logEnable == LOG_VERBOSE)
         {
-            netlogfile = fopen(DEM_LogFileName, "at");
+            char *demLogFileNameFull = filePathPrepend(
+                DEM_LogFileName, FF_UserSettingsPath);
+            if (fileMakeDestinationDirectory(demLogFileNameFull))
+            {
+                netlogfile = fopen(demLogFileNameFull, "at");
             if (netlogfile)
             {
                 fprintf(netlogfile, "************* Demo packet #%d   Task time %.4f\n", demPacketNumber, taskTimeElapsed);
             }
         }
+        }
         state.univCheckSum = univGetChecksum(&numShips);
         if (netlogfile && logEnable == LOG_VERBOSE)
         {
@@ -364,10 +380,16 @@
 #if DEM_CHECKSUM
     if (logEnable == LOG_VERBOSE)
     {
-        netlogfile = fopen(DEM_LogFileName, "wb");
+        char *demLogFileNameFull = filePathPrepend(
+            DEM_LogFileName, FF_UserSettingsPath);
+        if (fileMakeDestinationDirectory(demLogFileNameFull))
+        {
+            netlogfile = fopen(demLogFileNameFull, "wb");
+            if (netlogfile)
         fclose(netlogfile);
         netlogfile = NULL;
     }
+    }
 #endif
     demFinishFunction = finishFunction;
     demFakeRenderCount = 0;
@@ -433,12 +455,17 @@
         nDemoPlays++;
         if (logEnable == LOG_VERBOSE)
         {
-            netlogfile = fopen(DEM_LogFileName, "at");
+            char *demLogFileNameFull = filePathPrepend(
+                DEM_LogFileName, FF_UserSettingsPath);
+            if (fileMakeDestinationDirectory(demLogFileNameFull))
+            {
+                netlogfile = fopen(demLogFileNameFull, "at");
             if (netlogfile)
             {
                 fprintf(netlogfile, "************* Demo packet #%d   Task time %.4f\n", demPacketNumber, taskTimeElapsed);
             }
         }
+        }
         univCheckSum = univGetChecksum(&numShips);
         if (netlogfile && logEnable == LOG_VERBOSE)
         {
diff -urPw homeworld-orig/src/Game/Demo.h homeworld_sdl-0.3/src/Game/Demo.h
--- homeworld-orig/src/Game/Demo.h	2002-09-04 12:46:08.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Demo.h	2004-08-01 22:35:32.000000000 -0700
@@ -9,10 +9,10 @@
 #ifndef ___DEMO_H
 #define ___DEMO_H
 
-#include "types.h"
-#include "key.h"
-#include "task.h"
-#include "randy.h"
+#include "Types.h"
+#include "Key.h"
+#include "Task.h"
+#include "Randy.h"
 
 /*=============================================================================
     Switches:
diff -urPw homeworld-orig/src/Game/Dock.c homeworld_sdl-0.3/src/Game/Dock.c
--- homeworld-orig/src/Game/Dock.c	2002-09-04 12:46:08.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Dock.c	2004-08-01 22:35:34.000000000 -0700
@@ -8,46 +8,51 @@
 
 #include <stdlib.h>
 #include <string.h>
+#include <strings.h>
 #include <math.h>
 #include "maths.h"
-#include "types.h"
-#include "memory.h"
-#include "debug.h"
-#include "vector.h"
-#include "fastmath.h"
-#include "linkedlist.h"
-#include "objtypes.h"
-#include "spaceobj.h"
-#include "universe.h"
-#include "aitrack.h"
-#include "aiship.h"
-#include "commandlayer.h"
+#include "Types.h"
+#include "Memory.h"
+#include "Debug.h"
+#include "Vector.h"
+#include "FastMath.h"
+#include "LinkedList.h"
+#include "ObjTypes.h"
+#include "SpaceObj.h"
+#include "Universe.h"
+#include "AITrack.h"
+#include "AIShip.h"
+#include "CommandLayer.h"
 #include "prim3d.h"
 #include "render.h"
-#include "select.h"
-#include "soundevent.h"
-#include "dock.h"
-#include "univupdate.h"
-#include "drone.h"
-#include "researchship.h"
-#include "physics.h"
+#include "Select.h"
+#include "SoundEvent.h"
+#include "Dock.h"
+#include "UnivUpdate.h"
+#include "Drone.h"
+#include "ResearchShip.h"
+#include "Physics.h"
 #include "kgl.h"
-#include "collision.h"
-#include "launchMgr.h"
-#include "tactics.h"
-#include "singleplayer.h"
-#include "madlinkin.h"
-#include "madlinkindefs.h"
-#include "mothership.h"
-#include "clamp.h"
-#include "salcapcorvette.h"
-#include "tutor.h"
-#include "randy.h"
-#include "aivar.h"
-#include "alliance.h"
-#include "battle.h"
+#include "Collision.h"
+#include "LaunchMgr.h"
+#include "Tactics.h"
+#include "SinglePlayer.h"
+#include "MadLinkIn.h"
+#include "MadLinkInDefs.h"
+#include "Mothership.h"
+#include "Clamp.h"
+#include "SalCapCorvette.h"
+#include "Tutor.h"
+#include "Randy.h"
+#include "AIVar.h"
+#include "Alliance.h"
+#include "Battle.h"
 #include "DDDFrigate.h"
 
+#ifdef _MSC_VER
+#define strcasecmp _stricmp
+#endif
+
 //#define DEBUG_DOCKING
 
 #define NOT_FINISHED_DOCKING 0
@@ -291,7 +296,7 @@
 
     for (i=0,curdockpoint=&dockstaticinfo->dockstaticpoints[0];i<numDockPoints;i++,curdockpoint++)
     {
-        if (_stricmp(name,curdockpoint->name) == 0)
+        if (strcasecmp(name,curdockpoint->name) == 0)
         {
             return i;
         }
@@ -315,7 +320,7 @@
 
     for (i=0,curdockpoint=&dockstaticinfo->dockstaticpoints[0];i<numDockPoints;i++,curdockpoint++)
     {
-        if (_stricmp(name,curdockpoint->name) == 0)
+        if (strcasecmp(name,curdockpoint->name) == 0)
         {
             return curdockpoint;
         }
@@ -355,7 +360,6 @@
     Ship *dockat;
     Ship *closestDockat = NULL;
     ShipStaticInfo *dockatstatic;
-    ShipStaticInfo *shipstatic = (ShipStaticInfo *)ship->staticinfo;
     ResearchShipSpec *spec  = (ResearchShipSpec *)ship->ShipSpecifics;
     real32 timeTest = REALlyBig;
     if(spec->seed == TRUE)
@@ -1749,8 +1753,6 @@
 
 bool dockFlyAboveMothershipDoor(Ship *ship,Ship *dockwith)
 {
-    DockStaticPoint *dockstaticpoint = ship->dockvars.dockstaticpoint;
-    real32 backupDistance = dockstaticpoint->flyawaydist;
     vector destination;
     vector dest1;
     vector heading,up,right;
@@ -1784,13 +1786,11 @@
 
 bool dockFlyToBottomOfDoor1(Ship *ship,Ship *dockwith)
 {
-    DockStaticPoint *dockstaticpoint = ship->dockvars.dockstaticpoint;
-    real32 backupDistance = dockstaticpoint->flyawaydist;
     vector destination;
     vector dest1;
     vector heading,up,right,doorheading,doorup;
     matrix coordsysWS;
-    bool track = FALSE;
+    //bool track = FALSE;
     bool dest = FALSE;
 
     mothershipGetCargoPosition(dockwith,(SpaceObjRotImpTargGuidanceShipDerelict *)ship,&destination,&coordsysWS,&heading,&up,&right);
@@ -1823,8 +1823,6 @@
 
 bool dockFlyToBottomOfDoor2(Ship *ship,Ship *dockwith)
 {
-    DockStaticPoint *dockstaticpoint = ship->dockvars.dockstaticpoint;
-    real32 backupDistance = dockstaticpoint->flyawaydist;
     vector destination;
     vector dest1;
     vector heading,up,right;
@@ -1857,8 +1855,6 @@
 }
 bool dockFlyToBottomOfDoor3(Ship *ship,Ship *dockwith)
 {
-    DockStaticPoint *dockstaticpoint = ship->dockvars.dockstaticpoint;
-    real32 backupDistance = dockstaticpoint->flyawaydist;
     vector destination;
     vector dest1;
     vector heading,up,right;
@@ -1892,8 +1888,6 @@
 
 bool dockFlyToDoor(Ship *ship,Ship *dockwith)
 {
-    DockStaticPoint *dockstaticpoint = ship->dockvars.dockstaticpoint;
-    real32 backupDistance = dockstaticpoint->flyawaydist;
     vector destination;
     vector heading,up,right;
     matrix coordsysWS;
@@ -2112,7 +2106,7 @@
             {
                 if(dockwith->shiptype == Mothership)
                 {
-                    if(stricmp(dockInfo->dockpoints[curlaunchindex].dockstaticpoint->name,"Big") == 0)
+                    if(strcasecmp(dockInfo->dockpoints[curlaunchindex].dockstaticpoint->name,"Big") == 0)
                     {
                         if(dockwith->madDoorStatus != MAD_STATUS_DOOR_CLOSED)
                         {
@@ -2146,7 +2140,7 @@
     }
     else
     {
-        retval = PotentialIndices[random(foundNumberIndices)];
+        retval = PotentialIndices[randomG(foundNumberIndices)];
     }
 
     memFree(PotentialIndices);
@@ -2251,7 +2245,7 @@
 
     dockpointindex = ship->dockvars.dockstaticpoint->dockindex;
 
-    if(stricmp(dockwith->dockInfo->dockpoints[dockpointindex].dockstaticpoint->name,"Big") == 0)
+    if(strcasecmp(dockwith->dockInfo->dockpoints[dockpointindex].dockstaticpoint->name,"Big") == 0)
     {
         if(dockwith->shiptype == Mothership)
         {
@@ -2482,7 +2476,7 @@
     Global Functions for use by anyone anywhere anytime
 =============================================================================*/
 
-#define DEBUG_SLAVE
+//#define DEBUG_SLAVE
 /*-----------------------------------------------------------------------------
     Name        : dockMakeMaster
     Description : Turns the ship, master, into a slave receivable ship
@@ -4566,6 +4560,8 @@
                 }
             }
     }
+
+    return FALSE;
 }
 
 #define CARRIERMOTHER_CONE_ALIGN_TOLERANCE  0.99f
@@ -5156,6 +5152,8 @@
                 return FALSE;
             }
     }
+
+    return FALSE;
 }
 
 typedef struct
@@ -5244,6 +5242,8 @@
             }
             return FALSE;
     }
+
+    return FALSE;
 }
 
 /*=============================================================================
@@ -5259,7 +5259,7 @@
 #define RESEARCH_WAIT                   7
 #define RESEARCH_SLAVE                  8
 
-#define DEBUG_RESEARCH_R1
+//#define R1_DEBUG_RESEARCH_DOCKING
 
 #define PIE_POINT_TOLR2   255.0f           //INCREASE THIS...AND MAKE TUNABLE!
 #define PIE_POINT_TOLR1   75.0f           //INCREASE THIS...AND MAKE TUNABLE!
@@ -5582,12 +5582,12 @@
         */
         else
         {
-        #ifdef DEBUG_RESEARCH_R1
+        #ifdef R1_DEBUG_RESEARCH_DOCKING
             dbgFatalf(DBG_Loc, "\nResearch Ship Race 1 docking error...No free docking point found");
         #endif
         }
 
-#ifdef DEBUG_RESEARCH_R1
+#ifdef R1_DEBUG_RESEARCH_DOCKING
         dbgMessagef("\nRace 1: DOCKWITH    : point %s chosen.",dockwithstatic->dockStaticInfo->dockstaticpoints[dockwithpointindex].name);
         dbgMessagef("\nRace 1: DOCKING SHIP: point %s chosen.",shipstatic->dockStaticInfo->dockstaticpoints[shippointindex].name);
         dbgMessagef("\nNow flying to PiePoint.");
@@ -5647,7 +5647,7 @@
                 goto morer1resdock;
             }
 
-#ifdef DEBUG_RESEARCH_R1
+#ifdef R1_DEBUG_RESEARCH_DOCKING
         dbgMessagef("\nRace 1: Reached Point, now parallel parking.");
 #endif
         }
@@ -5663,7 +5663,7 @@
             speechEventVar(ship, STAT_Research_Docking, 0, 2);
 
             ship->dockvars.dockstate2 = RESEARCH_FINAL_SQUEEZE;
-#ifdef DEBUG_RESEARCH_R1
+#ifdef R1_DEBUG_RESEARCH_DOCKING
         dbgMessagef("\nRace 1: Parallel Parking");
         dbgMessagef("\nAllowing Next Research Ship to start docking!");
 #endif
@@ -5682,7 +5682,7 @@
             ship->posinfo.velocity.y=0.0f;
             ship->posinfo.velocity.z=0.0f;
             ship->dockvars.dockstate2 = RESEARCH_FINAL_SQUEEZE;
-#ifdef DEBUG_RESEARCH_R1
+#ifdef R1_DEBUG_RESEARCH_DOCKING
         dbgMessagef("\nRace 1: Final Docking Phaze....");
 #endif
         }
@@ -5749,7 +5749,7 @@
                 soundEvent(ship, Ship_ResearchLockOn);
             }
             ship->dockvars.dockstate2 = RESEARCH_WAIT;
-#ifdef DEBUG_RESEARCH_R1
+#ifdef R1_DEBUG_RESEARCH_DOCKING
         dbgMessagef("\nRace 1: Docked...Slaveing ship, extending docking port.");
 #endif
         }
@@ -5770,7 +5770,7 @@
     return FALSE;
 }
 
-#define R2_DEBUG_RESEARCH_DOCKING
+//#define R2_DEBUG_RESEARCH_DOCKING
 
 #define R2_FIND_LATCH                   1
 #define R2_WAIT_FOR_DOCK_POINT          2
@@ -6172,7 +6172,6 @@
 
 bool LaunchShipFromDefaultShip(Ship *ship,Ship *dockwith)
 {
-    ShipStaticInfo *dockwithstatic = (ShipStaticInfo *)dockwith->staticinfo;
     vector destination;
     vector heading;
 
@@ -6203,6 +6202,8 @@
                 return FALSE;
             }
     }
+
+    return FALSE;
 }
 
 bool ShipDocksAtDefaultShip(struct CommandToDo *docktodo,struct Ship *ship,struct Ship *dockwith)
diff -urPw homeworld-orig/src/Game/Dock.h homeworld_sdl-0.3/src/Game/Dock.h
--- homeworld-orig/src/Game/Dock.h	2002-09-04 12:46:08.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Dock.h	2004-08-01 22:35:34.000000000 -0700
@@ -9,9 +9,10 @@
 #ifndef ___DOCK_H
 #define ___DOCK_H
 
-#include "types.h"
-#include "spaceobj.h"
-#include "shipselect.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "ShipSelect.h"
+#include "render.h"
 
 #define DOCK_FOR_BOTHREFUELANDREPAIR    1
 #define DOCK_FOR_REFUEL                 2
@@ -43,7 +44,8 @@
 void dockInitializeCustomFunctions(ShipStaticInfo *statinfo,ShipType type,ShipRace race);
 
 sdword dockFindDockIndex(char *name,DockStaticInfo *dockstaticinfo);
-static void dockReserveDockPoint(Ship *ship,Ship *dockwith,sdword dockpointindex);
+/*static void dockReserveDockPoint(Ship *ship,Ship *dockwith,sdword dockpointindex);*/
+/*void dockReserveDockPoint(Ship *ship,Ship *dockwith,sdword dockpointindex);*/
 
 void dockPutShipInside(Ship *ship,Ship *dockwith);
 void dockInitShipForLaunch(Ship *ship);
diff -urPw homeworld-orig/src/Game/ETG.c homeworld_sdl-0.3/src/Game/ETG.c
--- homeworld-orig/src/Game/ETG.c	2002-09-04 12:46:08.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/ETG.c	2004-08-01 22:35:26.000000000 -0700
@@ -7,39 +7,47 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
+#ifdef _WIN32
 #include <windows.h>
+#endif
+
 #include "glinc.h"
 #include <string.h>
+#include <strings.h>
 #include <stdarg.h>
 #include <math.h>
-#include "types.h"
-#include "file.h"
-#include "memory.h"
-#include "debug.h"
+#include "Types.h"
+#include "File.h"
+#include "Memory.h"
+#include "Debug.h"
 #include "color.h"
-#include "particle.h"
-#include "randy.h"
-#include "eval.h"
-#include "statscript.h"
+#include "Particle.h"
+#include "Randy.h"
+#include "Eval.h"
+#include "StatScript.h"
 #include "utility.h"
 #include "texreg.h"
-#include "mesh.h"
-#include "select.h"
-#include "task.h"
-#include "fastmath.h"
-#include "battle.h"
+#include "Mesh.h"
+#include "Select.h"
+#include "Task.h"
+#include "FastMath.h"
+#include "Battle.h"
 #include "mainrgn.h"
 #include "render.h"
-#include "btg.h"
-#include "etg.h"
+#include "BTG.h"
+#include "ETG.h"
+
+#include "SoundEvent.h"
+#include "SpaceObj.h"
+#include "MEX.h"
+#include "Universe.h"
+#include "UnivUpdate.h"
+#include "Damage.h"
+#include "HorseRace.h"
 
-#include "soundevent.h"
-#include "spaceobj.h"
-#include "mex.h"
-#include "universe.h"
-#include "univupdate.h"
-#include "damage.h"
-#include "horserace.h"
+#ifdef _MSC_VER
+#define strcasecmp _stricmp
+#endif
 
 /*=============================================================================
     Data:
@@ -395,28 +403,28 @@
 void etgDepthWriteResolve(struct etgeffectstatic *stat, etgfunctioncall *call);
 #define funcEntryn(name, ret, function)  {name, function, ret, (ubyte)FALSE, ETG_VariableParams}
 #define funcEntry0(name, ret, function)  {name, function, ret, (ubyte)FALSE, NULL, 0}
-#define funcEntry1(name, ret, function, p0) {name, function, ret, (ubyte)FALSE, NULL, 1, p0}
-#define funcEntry2(name, ret, function, p0, p1) {name, function, ret, (ubyte)FALSE, NULL, 2, p0, p1}
-#define funcEntry3(name, ret, function, p0, p1, p2) {name, function, ret, (ubyte)FALSE, NULL, 3, p0, p1, p2}
-#define funcEntry4(name, ret, function, p0, p1, p2, p3) {name, function, ret, (ubyte)FALSE, NULL, 4, p0, p1, p2, p3}
-#define funcEntry5(name, ret, function, p0, p1, p2, p3, p4) {name, function, ret, (ubyte)FALSE, NULL, 5, p0, p1, p2, p3, p4}
-#define funcEntry6(name, ret, function, p0, p1, p2, p3, p4, p5) {name, function, ret, (ubyte)FALSE, NULL, 6, p0, p1, p2, p3, p4, p5}
-#define funcEntry7(name, ret, function, p0, p1, p2, p3, p4, p5, p6) {name, function, ret, (ubyte)FALSE, NULL, 7, p0, p1, p2, p3, p4, p5, p6}
-#define funcEntry8(name, ret, function, p0, p1, p2, p3, p4, p5, p6, p7) {name, function, ret, (ubyte)FALSE, NULL, 7, p0, p1, p2, p3, p4, p5, p6, p7}
+#define funcEntry1(name, ret, function, p0) {name, function, ret, (ubyte)FALSE, NULL, 1, {p0}}
+#define funcEntry2(name, ret, function, p0, p1) {name, function, ret, (ubyte)FALSE, NULL, 2, {p0, p1}}
+#define funcEntry3(name, ret, function, p0, p1, p2) {name, function, ret, (ubyte)FALSE, NULL, 3, {p0, p1, p2}}
+#define funcEntry4(name, ret, function, p0, p1, p2, p3) {name, function, ret, (ubyte)FALSE, NULL, 4, {p0, p1, p2, p3}}
+#define funcEntry5(name, ret, function, p0, p1, p2, p3, p4) {name, function, ret, (ubyte)FALSE, NULL, 5, {p0, p1, p2, p3, p4}}
+#define funcEntry6(name, ret, function, p0, p1, p2, p3, p4, p5) {name, function, ret, (ubyte)FALSE, NULL, 6, {p0, p1, p2, p3, p4, p5}}
+#define funcEntry7(name, ret, function, p0, p1, p2, p3, p4, p5, p6) {name, function, ret, (ubyte)FALSE, NULL, 7, {p0, p1, p2, p3, p4, p5, p6}}
+#define funcEntry8(name, ret, function, p0, p1, p2, p3, p4, p5, p6, p7) {name, function, ret, (ubyte)FALSE, NULL, 7, {p0, p1, p2, p3, p4, p5, p6, p7}}
 #define funcEntryThisn(name, ret, function)  {name, function, ret, (ubyte)TRUE, ETG_VariableParams}
 #define funcEntryThis0(name, ret, function)  {name, function, ret, (ubyte)TRUE, NULL, 0}
-#define funcEntryThis1(name, ret, function, p0) {name, function, ret, (ubyte)TRUE, NULL, 1, p0}
-#define funcEntryThis2(name, ret, function, p0, p1) {name, function, ret, (ubyte)TRUE, NULL, 2, p0, p1}
-#define funcEntryThis3(name, ret, function, p0, p1, p2) {name, function, ret, (ubyte)TRUE, NULL, 3, p0, p1, p2}
-#define funcEntryThis4(name, ret, function, p0, p1, p2, p3) {name, function, ret, (ubyte)TRUE, NULL, 4, p0, p1, p2, p3}
-#define funcEntryThis5(name, ret, function, p0, p1, p2, p3, p4) {name, function, ret, (ubyte)TRUE, NULL, 5, p0, p1, p2, p3, p4}
-#define funcEntryThis6(name, ret, function, p0, p1, p2, p3, p4, p5) {name, function, ret, (ubyte)TRUE, NULL, 6, p0, p1, p2, p3, p4, p5}
-#define funcEntryThis7(name, ret, function, p0, p1, p2, p3, p4, p5, p6) {name, function, ret, (ubyte)TRUE, NULL, 7, p0, p1, p2, p3, p4, p5, p6}
-#define funcEntryThis8(name, ret, function, p0, p1, p2, p3, p4, p5, p6, p7) {name, function, ret, (ubyte)TRUE, NULL, 7, p0, p1, p2, p3, p4, p5, p6, p7}
-#define funcEntryR1(name, ret, function, p0, resolve) {name, function, ret, (ubyte)FALSE, resolve, 1, p0}
-#define funcEntryR2(name, ret, function, p0, p1, resolve) {name, function, ret, (ubyte)FALSE, resolve, 2, p0, p1}
-#define funcEntryThisR1(name, ret, function, p0, resolve) {name, function, ret, (ubyte)TRUE, resolve, 1, p0}
-#define funcEntryThisR2(name, ret, function, p0, p1, resolve) {name, function, ret, (ubyte)TRUE, resolve, 2, p0, p1}
+#define funcEntryThis1(name, ret, function, p0) {name, function, ret, (ubyte)TRUE, NULL, 1, {p0}}
+#define funcEntryThis2(name, ret, function, p0, p1) {name, function, ret, (ubyte)TRUE, NULL, 2, {p0, p1}}
+#define funcEntryThis3(name, ret, function, p0, p1, p2) {name, function, ret, (ubyte)TRUE, NULL, 3, {p0, p1, p2}}
+#define funcEntryThis4(name, ret, function, p0, p1, p2, p3) {name, function, ret, (ubyte)TRUE, NULL, 4, {p0, p1, p2, p3}}
+#define funcEntryThis5(name, ret, function, p0, p1, p2, p3, p4) {name, function, ret, (ubyte)TRUE, NULL, 5, {p0, p1, p2, p3, p4}}
+#define funcEntryThis6(name, ret, function, p0, p1, p2, p3, p4, p5) {name, function, ret, (ubyte)TRUE, NULL, 6, {p0, p1, p2, p3, p4, p5}}
+#define funcEntryThis7(name, ret, function, p0, p1, p2, p3, p4, p5, p6) {name, function, ret, (ubyte)TRUE, NULL, 7, {p0, p1, p2, p3, p4, p5, p6}}
+#define funcEntryThis8(name, ret, function, p0, p1, p2, p3, p4, p5, p6, p7) {name, function, ret, (ubyte)TRUE, NULL, 7, {p0, p1, p2, p3, p4, p5, p6, p7}}
+#define funcEntryR1(name, ret, function, p0, resolve) {name, function, ret, (ubyte)FALSE, resolve, 1, {p0}}
+#define funcEntryR2(name, ret, function, p0, p1, resolve) {name, function, ret, (ubyte)FALSE, resolve, 2, {p0, p1}}
+#define funcEntryThisR1(name, ret, function, p0, resolve) {name, function, ret, (ubyte)TRUE, resolve, 1, {p0}}
+#define funcEntryThisR2(name, ret, function, p0, p1, resolve) {name, function, ret, (ubyte)TRUE, resolve, 2, {p0, p1}}
 opfunctionentry etgFunctionTable[] =
 {
     //set properties of particle systems to be created
@@ -1898,17 +1906,10 @@
     udword opcode;
     sdword size;
     ubyte *pOpcode;
-/*
-#if ETG_ERROR_CHECKING
-    if (etgExecStackIndex >= ETG_ExecStackDepth - 1)
-    {
-        dbgFatalf(ETG, "Overflowed exec stack of depth %d", ETG_ExecStackDepth);
-    }
-#endif
-    etgExecStackIndex++;
-*/
+
 	//this function does not interface well with optimized code which assumes 
 	//certain variables will not get stomped, hence the pushes
+#if defined (_MSC_VER)
 	_asm
 	{
 		push eax
@@ -1918,6 +1919,33 @@
 		push esi
 		push edi
 	}
+#elif defined (__GNUC__) && defined (__i386__)
+	/* Using an array should guarantee it's in memory, right? */
+	Uint32 savedreg[6];
+ 	__asm__ __volatile__ (
+		"movl %%eax, %0\n\t"
+		"movl %%ebx, %1\n\t"
+		"movl %%ecx, %2\n\t"
+		"movl %%edx, %3\n\t"
+		"movl %%esi, %4\n\t"
+		"movl %%edi, %5\n\t" : :
+		"m" (savedreg[0]), "m" (savedreg[1]), "m" (savedreg[2]),
+		"m" (savedreg[3]), "m" (savedreg[4]), "m" (savedreg[5]));
+#elif !defined(_MACOSX)
+    // We know x86 instructions won't work on a PowerPC, thanks. We've coded around it.
+	#error Opcode-handler functions currently only supported on x86 platforms.
+#endif
+
+/*
+#if ETG_ERROR_CHECKING
+    if (etgExecStackIndex >= ETG_ExecStackDepth - 1)
+    {
+        dbgFatalf(ETG, "Overflowed exec stack of depth %d", ETG_ExecStackDepth);
+    }
+#endif
+    etgExecStackIndex++;
+*/
+
     etgExecStack.etgCodeBlockIndex = codeBlock;
     //set the proper code block and code length
     //start at beginning of code.  !!!We may want to implement the yield() function.
@@ -1948,6 +1976,7 @@
 //    etgExecStackIndex--;
 	//this function does not interface well with optimized code which assumes 
 	//certain variables will not get stomped, hence the pushes
+#if defined (_MSC_VER)
 	_asm
 	{
 		pop edi
@@ -1957,6 +1986,17 @@
 		pop ebx
 		pop eax
 	}
+#elif defined (__GNUC__) && defined (__i386__)
+	__asm__ __volatile__ (
+		"movl %0, %%eax\n\t"
+		"movl %1, %%ebx\n\t"
+		"movl %2, %%ecx\n\t"
+		"movl %3, %%edx\n\t"
+		"movl %4, %%esi\n\t"
+		"movl %5, %%edi\n\t" : :
+		"m" (savedreg[0]), "m" (savedreg[1]), "m" (savedreg[2]),
+		"m" (savedreg[3]), "m" (savedreg[4]), "m" (savedreg[5]));
+#endif
 }
 
 /*-----------------------------------------------------------------------------
@@ -2233,7 +2273,6 @@
     sdword index;
     hmatrix coordMatrixX;
     matrix scaledEffectSys;
-    bool bBillboard = FALSE;
     pointSystem *part;
     real32 timeElapsed;
     vector velInverse;
@@ -2579,7 +2618,11 @@
     etgevent *free = NULL;
 
     //strip all the path crap off, so we have just a name
+#ifdef _WIN32
     for (slash = strchr(name, '\\'); slash != NULL; slash = strchr(slash + 1, '\\'))
+#else
+    for (slash = strpbrk(name, "\\/"); slash != NULL; slash = strpbrk(slash + 1, "\\/"))
+#endif
     {
         name = slash + 1;
     }
@@ -4091,7 +4134,7 @@
         }
         else
         {                                                   //else something loaded here
-            if (!_stricmp(filename, etgMeshRegistry[index].filename))
+            if (!strcasecmp(filename, etgMeshRegistry[index].filename))
             {                                               //if this is the mesh we want
                 return(etgMeshRegistry[index].mesh);
             }
@@ -4185,7 +4228,7 @@
     if (etgParseMode == EPM_Constant)
     {                                                       //if we're creating a constant
         start = strtok(params, " =\t");
-        nScanned = sscanf(start, "%f", &initial);
+        nScanned = sscanf(start, "%f", (float*)&initial);
 #if ETG_ERROR_CHECKING
         if (stat->constLength + 4 > ETG_ConstDataPool)
         {
@@ -4212,7 +4255,7 @@
     start = etgParseVariable(params, &bSetInitial);         //prepare string
     if (bSetInitial)
     {
-        nScanned = sscanf(start, "%f", &initial);           //scan the initial value
+        nScanned = sscanf(start, "%f", (float*)&initial);           //scan the initial value
 #if ETG_ERROR_CHECKING
         if (nScanned != 1)
         {
@@ -5279,7 +5322,7 @@
             call->parameter[nParams].type = EVT_Constant;
             if (strchr(param, '.'))
             {                                               //if it's a floating-point
-                nScanned = sscanf(param, "%f", &call->parameter[nParams].param);
+                nScanned = sscanf(param, "%f", (float*)&call->parameter[nParams].param);
             }
             else
             {                                               //else it's an integer
@@ -5417,7 +5460,7 @@
     createCall = (etgfunctioncall *)userData;
     dbgAssert(createCall->opcode == EOP_Function && createCall->nParameters == 2);
 #endif
-    memcpy(userData + etgFunctionSize(1), userData, etgFunctionSize(2));//move the function forward
+    memmove(userData + etgFunctionSize(1), userData, etgFunctionSize(2));//move the function forward
     //set up the call to partCreateCallbackSet()
     call = (etgfunctioncall *)userData;
     call->opcode = EOP_Function;
@@ -5560,7 +5603,7 @@
             call->parameter[nParams].type = EVT_Constant;
             if (strchr(param, '.'))
             {                                               //if it's a floating-point
-                nScanned = sscanf(param, "%f", &call->parameter[nParams].param);
+                nScanned = sscanf(param, "%f", (float*)&call->parameter[nParams].param);
             }
             else
             {                                               //else it's an integer
@@ -5643,6 +5686,137 @@
     return(sizeof(etgvariablecopy));
 }
 
+#ifdef _MACOSX_FIX_ME
+/* handle function calls
+
+ This function causes error during compilation of ETG.c with optimization on, and still
+ needs to be fixed. It works (or seems to work) in debug mode, though. It simply calls other
+ functions, but in relly messed way. (etgfunctioncall *)opcode contains a table of paramaters
+ and a pointer to function to call. Number of params can vary from function to function, so 
+ on x86 they simply push every parameter to the stack and then call function without any params.
+ On PowerPC however, parameters are passed using registers (starting from r3 or f1 for floats),
+ that's why I have to iterate trough etgFunctionTable to check types of each param - thanks for
+ that I know what register to use. I'm still not sure if all functions called here are in this
+ table... Second thing is that I have to use this ugly if-else block to put params in right 
+ registers (and I assumed there are max. 8 params, which also may not be true). Anyway, when
+ using optimizatons, compiling stops because of float-handling part of function.
+*/
+sdword etgFunctionCall(Effect *effect, struct etgeffectstatic *stat, ubyte *opcode)
+{
+    udword param, nParams, currParam, currParamF, returnType;
+    sdword index, currEntry = 0;
+	opfunctionentry *entry = &etgFunctionTable[currEntry++];
+	while( entry->name )
+	{
+		if( entry->function == ((etgfunctioncall *)opcode)->function )
+			break;
+
+		entry = &etgFunctionTable[currEntry++];
+	}
+
+	if( !entry->name )
+	{
+		entry = NULL;
+	}
+
+    nParams = ((etgfunctioncall *)opcode)->nParameters;
+    returnType = ((etgfunctioncall *)opcode)->returnValue;
+	currParam = 0;
+	currParamF = 0;
+
+	if (((etgfunctioncall *)opcode)->passThis)
+	{                                                       //pass a 'this' pointer
+		__asm__ (
+			"lwz r3, %0\n"
+			:
+			: "m" (effect)
+			: "r3"
+		);
+
+		currParam++;
+	}
+
+	for (index = 0; index < (sdword)nParams; index++)
+    {                                                       //for each parameter
+		int isFloat = 0;
+        param = ((etgfunctioncall *)opcode)->parameter[index].param;
+        switch (((etgfunctioncall *)opcode)->parameter[index].type)
+        {
+            case EVT_Constant:
+                break;
+            case EVT_Label:
+                dbgAssert(FALSE);
+                break;
+            case EVT_ConstLabel:
+                param = (udword)stat->constData + param;
+                break;
+            case EVT_VarLabel:
+                param = (udword)effect->variable + param;
+                break;
+            default:
+                param = *((udword *)(effect->variable + param));
+                break;
+        }
+
+		if( entry )
+			if (entry->type[index] == EVT_Float)
+				isFloat = 1;
+
+		if (!isFloat)
+		{
+			if( currParam == 0 )
+				__asm__ ( "lwz r3, %0\n" : : "g" (param) : "r3" );
+			else if( currParam == 1 )
+				__asm__ ( "lwz r4, %0\n" : : "g" (param) : "r4" );
+			else if( currParam == 2 )
+				__asm__ ( "lwz r5, %0\n" : : "g" (param) : "r5" );
+			else if( currParam == 3 )
+				__asm__ ( "lwz r6, %0\n" : : "g" (param) : "r6" );
+			else if( currParam == 4 )
+				__asm__ ( "lwz r7, %0\n" : : "g" (param) : "r7" );
+			else if( currParam == 5 )
+				__asm__ ( "lwz r8, %0\n" : : "g" (param) : "r8" );
+			else if( currParam == 6 )
+				__asm__ ( "lwz r9, %0\n" : : "g" (param) : "r9" );
+			else if( currParam == 7 )
+				__asm__ ( "lwz r10, %0\n" : : "g" (param) : "r10" );
+
+			currParam++;
+		}
+		else
+		{
+			float fp = *(float*)&param;
+			if( currParamF == 0 )
+				__asm__ ( "lfs f1, %0\n" : : "g" (fp) : "f1" );
+			else if( currParamF == 1 )
+				__asm__ ( "lfs f2, %0\n" : : "g" (fp) : "f2" );
+			else if( currParamF == 2 )
+				__asm__ ( "lfs f3, %0\n" : : "g" (fp) : "f3" );
+			else if( currParamF == 3 )
+				__asm__ ( "lfs f4, %0\n" : : "g" (fp) : "f4" );
+			else if( currParamF == 4 )
+				__asm__ ( "lfs f5, %0\n" : : "g" (fp) : "f5" );
+			else if( currParamF == 5 )
+				__asm__ ( "lfs f6, %0\n" : : "g" (fp) : "f6" );
+			else if( currParamF == 6 )
+				__asm__ ( "lfs f7, %0\n" : : "g" (fp) : "f7" );
+			else if( currParamF == 7 )
+				__asm__ ( "lfs f8, %0\n" : : "g" (fp) : "f8" );
+
+			currParamF++;
+		}
+	}
+
+	param = ((etgfunctioncall *)opcode)->function();        //call the function
+    if (returnType != 0xffffffff)                           //if a return value is desired
+    {
+        *((udword *)(effect->variable + returnType)) = param;//set the return parameter
+    }
+    return(etgFunctionSize(nParams));
+}
+
+#else // for lucky so and so's with x86 processors...
+
 //handle function calls
 sdword etgFunctionCall(Effect *effect, struct etgeffectstatic *stat, ubyte *opcode)
 {
@@ -5675,19 +5849,33 @@
 //      {
 //          param = *((udword *)(effect->variable + param));
 //      }
+#if defined (_MSC_VER)
         _asm                                                //push it onto the stack
         {
             mov eax, param
             push eax
         }
+#elif defined (__GNUC__) && defined (__i386__)
+        __asm__ __volatile__ (                              /* push it onto the stack */
+            "pushl %0\n\t"
+            :
+            : "a" (param) );
+#endif
     }
     if (((etgfunctioncall *)opcode)->passThis)
     {                                                       //pass a 'this' pointer
+#if defined (_MSC_VER)
         _asm
         {
             mov eax, effect
             push eax
         }
+#elif defined (__GNUC__) && defined (__i386__)
+        __asm__ __volatile__ (                              /* pass a 'this' pointer */
+            "pushl %0\n\t"
+            :
+            : "a" (effect) );
+#endif
     }
     param = ((etgfunctioncall *)opcode)->function();        //call the function
     if (returnType != 0xffffffff)                           //if a return value is desired
@@ -5697,6 +5885,8 @@
     return(etgFunctionSize(nParams));
 }
 
+#endif // _MACOSX_FIX_ME
+
 //handle 'end'
 sdword etgEnd(Effect *effect, struct etgeffectstatic *stat, ubyte *opcode)
 {
@@ -6650,9 +6840,9 @@
     Effect *thisEffect;
     sdword nDetached;
 #if ETG_DETATCH_STATS
-    static nDetachRequests = 0;
-    static nTotalDetached = 0;
-    static nWalks = 0;
+    static int nDetachRequests = 0;
+    static int nTotalDetached = 0;
+    static int nWalks = 0;
 
     nDetachRequests += nToFind;
 #endif
diff -urPw homeworld-orig/src/Game/ETG.h homeworld_sdl-0.3/src/Game/ETG.h
--- homeworld-orig/src/Game/ETG.h	2002-09-04 12:46:08.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/ETG.h	2004-08-01 22:35:26.000000000 -0700
@@ -10,9 +10,9 @@
 #ifndef ___ETG_H
 #define ___ETG_H
 
-#include "spaceobj.h"
-#include "vector.h"
-#include "matrix.h"
+#include "SpaceObj.h"
+#include "Vector.h"
+#include "Matrix.h"
 
 /*=============================================================================
     Switches:
@@ -195,7 +195,11 @@
 #define ETG_NumberMeshes            128         //number of ETG-specific meshes
 
 //etg script file
+#ifdef _WIN32
 #define ETG_Directory               "ETG\\"
+#else
+#define ETG_Directory               "ETG/"
+#endif
 #define ETG_Script                  "etg.script"
 #define ETG_NumberTestKeys          8
 
@@ -223,8 +227,13 @@
 #define DMG_Dying                   2
 #define DMG_All                     3
 
+#ifdef _WIN32
 #define ETG_DefaultBoom             "ETG\\genericBOOM.ebg"
 #define ETG_DefaultBlast            "ETG\\defaultBlast.ebg"
+#else
+#define ETG_DefaultBoom             "ETG/genericBOOM.ebg"
+#define ETG_DefaultBlast            "ETG/defaultBlast.ebg"
+#endif
 #define ETG_UpdateRoundOff          (UNIVERSE_UPDATE_PERIOD / 2.0f)
 
 //default bullet colors
@@ -279,6 +288,10 @@
 /*=============================================================================
     Type definitions:
 =============================================================================*/
+struct Effect;
+struct etgeffectstatic;
+struct Ship;
+
 // ****** Structures for various p-code operations.  The first member is the actual opcode
 //EOP_Nop
 typedef struct
@@ -620,17 +633,17 @@
 void etgEffectCodeDelete(etgeffectstatic *stat, bool bFullDelete);
 
 //create effects
-void etgEffectCodeStart(etgeffectstatic *stat, void *effect, sdword nParams, ...);
-void etgEffectDelete(void *effect);
+void etgEffectCodeStart(struct etgeffectstatic *stat, struct Effect *effect, sdword nParams, ...);
+void etgEffectDelete(struct Effect *effect);
 void *etgEffectCreate(etgeffectstatic *stat, void *owner, vector *pos, vector *vel, matrix *coordsys, real32 nLips, udword flags, sdword nParams, ...);
 bool etgFrequencyExceeded(etgeffectstatic *stat);
 void etgHistoryRegisterFunction(etgeffectstatic *stat);
 
 //update effects
-bool etgEffectUpdate(void *effect, real32 timeElapsed);
-void etgEffectDraw(void *effect);
-void etgShipDied(void *deadDuck);
-sdword etgDeleteEffectsOwnedBy(void *owner);
+bool etgEffectUpdate(struct Effect *effect, real32 timeElapsed);
+void etgEffectDraw(struct Effect *effect);
+void etgShipDied(struct Ship *deadDuck);
+sdword etgDeleteEffectsOwnedBy(struct Ship *owner);
 
 //mesh registry stuff
 meshdata *etgMeshRegister(char *filename);
diff -urPw homeworld-orig/src/Game/Eval.c homeworld_sdl-0.3/src/Game/Eval.c
--- homeworld-orig/src/Game/Eval.c	2002-09-04 12:46:08.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Eval.c	2004-08-01 22:35:31.000000000 -0700
@@ -20,10 +20,10 @@
 //#include <values.h>
 #include <stdlib.h>
 #include <time.h>
-#include "types.h"
-#include "randy.h"
+#include "Types.h"
+#include "Randy.h"
 
-#include "eval.h"
+#include "Eval.h"
 
 #define  strequ(s1, s2) !strcmp(s1, s2)
 #define  nelems(arr) (sizeof(arr) / sizeof(arr[0]))
@@ -62,32 +62,33 @@
 static int       pc;                /* string counter       */
 static ERR_TYPE  exiterr;           /* error occurred       */
 static FUNC_ITEM func_vector[] =    /* must be in alphabetical order */
-
-{  1,  "ACOS",
-   2,  "ASIN",
-   3,  "ATAN",
-   4,  "ATAN2",
-   5,  "CEIL",
-   6,  "COS",
-   7,  "COSH",
-   8,  "EXP",
-   9,  "FABS",
-   10, "FACT",
-   11, "FLOOR",
-   12, "FMOD",
-   13, "LDEXP",
-   14, "LOG",
-   15, "LOG10",
-   16, "PI",
-   17, "POW",
-   18, "RAND",
-   19, "RND",
-   20, "SIN",
-   21, "SINH",
-   22, "SQR",
-   23, "SQRT",
-   24, "TAN",
-   25, "TANH" };
+{
+    { 1,  "ACOS"  },
+    { 2,  "ASIN"  },
+    { 3,  "ATAN"  },
+    { 4,  "ATAN2" },
+    { 5,  "CEIL"  },
+    { 6,  "COS"   },
+    { 7,  "COSH"  },
+    { 8,  "EXP"   },
+    { 9,  "FABS"  },
+    { 10, "FACT"  },
+    { 11, "FLOOR" },
+    { 12, "FMOD"  },
+    { 13, "LDEXP" },
+    { 14, "LOG"   },
+    { 15, "LOG10" },
+    { 16, "PI"    },
+    { 17, "POW"   },
+    { 18, "RAND"  },
+    { 19, "RND"   },
+    { 20, "SIN"   },
+    { 21, "SINH"  },
+    { 22, "SQR"   },
+    { 23, "SQRT"  },
+    { 24, "TAN"   },
+    { 25, "TANH"  }
+};
 
 /* ----- */
 
@@ -113,9 +114,9 @@
   pc = 0;
   s = eval_str;
 
-//  while (*eval_str = toupper(*eval_str++))
-//    ;
-  _strupr(eval_str);
+  for ( ; (*eval_str = toupper(*eval_str)); eval_str++)
+    ;
+/*  _strupr(eval_str); */
 
 } /* init_str() */
 
@@ -348,6 +349,8 @@
 
       case  NEQ:  e1 = (e1 != e2);
                   break;
+      default:
+            break;
 
     } /* switch */
 
@@ -392,6 +395,7 @@
       case PLUS:  e += p;
                   break;
       case MINUS: e -= p;
+      default:	break;
     } /* switch */
 
   } /* while */
@@ -431,6 +435,7 @@
                     math_err(DIV_ZERO);
                     return(0.0);
                   }
+        default: break;
     } /* switch */
 
   } /* while */
@@ -525,6 +530,7 @@
                                   }
                                   f = pow(f, tmp);
                                   break;
+                        default: break;
 
                     } /* switch func */
 
@@ -670,7 +676,8 @@
                                    break;
 
                            /* ...add more functions here... */
-
+                        default:
+                            break;
                     } /* switch func */
 
                     if (cur_token != CLOSED_PAR) {
diff -urPw homeworld-orig/src/Game/FastMath.c homeworld_sdl-0.3/src/Game/FastMath.c
--- homeworld-orig/src/Game/FastMath.c	2002-09-04 12:46:08.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/FastMath.c	2004-08-01 22:35:25.000000000 -0700
@@ -8,9 +8,9 @@
 
 #include <math.h>
 #include <float.h>
-#include "types.h"
-#include "fastmath.h"
-#include "debug.h"
+#include "Types.h"
+#include "FastMath.h"
+#include "Debug.h"
 
 #if 0
 real32 fmathSqrtGS(real32 num)
@@ -86,6 +86,10 @@
 
 double fmathSqrtDouble(double f)
 {
+#ifdef _MACOSX
+	return sqrt( f );
+#else
+
     unsigned int e;
     unsigned int *fi = (unsigned int *) &f + MOST_SIG_OFFSET;
 #if 0
@@ -106,16 +110,20 @@
     e >>= 1;
     *fi = (fmathsqrt_tab[*fi >> MANT_SHIFTS]) |
     ((e + EXP_BIAS) << EXP_SHIFTS);
+    
 #if 0
     dbgAssert(f > 0.0f);
-    error = abs((f - test) / test);
+    error = ABS((f - test) / test);
     if (error > 0.0001)
     {
         dbgAssert(FALSE);
     }
     dbgAssert(!_isnan(f));
 #endif
+
     return f;
+
+#endif // _MACOSX
 }
 
 void fmathInit()
diff -urPw homeworld-orig/src/Game/FastMath.h homeworld_sdl-0.3/src/Game/FastMath.h
--- homeworld-orig/src/Game/FastMath.h	2002-09-04 12:46:08.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/FastMath.h	2004-08-01 22:35:25.000000000 -0700
@@ -9,7 +9,7 @@
 #ifndef ___FASTMATH_H
 #define ___FASTMATH_H
 
-#include "types.h"
+#include "Types.h"
 
 /*=============================================================================
     Macros:
diff -urPw homeworld-orig/src/Game/FEFlow.c homeworld_sdl-0.3/src/Game/FEFlow.c
--- homeworld-orig/src/Game/FEFlow.c	2002-09-04 12:46:08.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/FEFlow.c	2004-08-01 22:35:22.000000000 -0700
@@ -7,32 +7,34 @@
 =============================================================================*/
 
 #ifndef SW_Render
+#ifdef _WIN32
 #include <windows.h>
 #endif
-#include "types.h"
-#include "file.h"
-#include "memory.h"
-#include "debug.h"
-#include "Font.h"
-#include "fontreg.h"
+#endif
+#include "Types.h"
+#include "File.h"
+#include "Memory.h"
+#include "Debug.h"
+#include "font.h"
+#include "FontReg.h"
 #include "prim2d.h"
 #include "utility.h"
-#include "uicontrols.h"
-#include "FeReg.h"
+#include "UIControls.h"
+#include "FEReg.h"
 #include "main.h"
-#include "FeFlow.h"
+#include "FEFlow.h"
 #include "glinc.h"
-#include "nis.h"
+#include "NIS.h"
 #include "mainrgn.h"
-#include "scroller.h"
+#include "Scroller.h"
 #include "mouse.h"
 #include "glcaps.h"
-#include "strings.h"
-#include "tutor.h"
-#include "soundevent.h"
+#include "Strings.h"
+#include "Tutor.h"
+#include "SoundEvent.h"
 #include "glcompat.h"
 
-#include "tactics.h"            //long story
+#include "Tactics.h"            //long story
 
 /*=============================================================================
     Defines:
@@ -1323,7 +1325,7 @@
 //        bitSet(atom->flags,FAF_UseAlpha);
         switch (atom->type)
         {
-            atom->region = NULL;                            //assume no region for this atom
+            /* atom->region = NULL; */                            //assume no region for this atom
             case FA_UserRegion:                             //named old user region
                 atom->pData = (ubyte *)feDrawCallbackFind(atom->name);
 
@@ -1671,7 +1673,7 @@
 
 /*-----------------------------------------------------------------------------
     Name        : feResRescaleBackground
-    Description : rescales a background region to fill a higher res that 640x480
+    Description : rescales a background region to fill a higher res than 640x480
     Inputs      : atom - the atom to resize
     Outputs     :
     Return      :
@@ -1782,6 +1784,12 @@
 
     fileLoadAlloc(fileName, (void **)&loadAddress, NonVolatile);     //load in the file
     header = (fibfileheader *)loadAddress;                  //get a pointer to the header
+
+#ifdef ENDIAN_BIG
+	header->version = LittleShort( header->version );
+	header->nScreens = LittleShort( header->nScreens );
+#endif
+
 #if FEF_ERROR_CHECKING
     if (strcmp(header->identify, FIB_Identify))             //verify header string
     {
@@ -1795,8 +1803,18 @@
     screen = (fescreen *)(loadAddress + sizeof(fibfileheader));//pointer to first screen
     for (screenIndex = 0; screenIndex < header->nScreens; screenIndex++, screen++)
     {
+#ifdef ENDIAN_BIG
+		screen->name   = ( char *)LittleLong( ( udword )screen->name );
+		screen->flags  = LittleLong( screen->flags );
+		screen->nLinks = LittleShort( screen->nLinks );
+		screen->nAtoms = LittleShort( screen->nAtoms );
+		screen->links  = ( void *)LittleLong( ( udword )screen->links );
+		screen->atoms  = ( void *)LittleLong( ( udword )screen->atoms );
+#endif
+
         dbgAssert(screen->name != NULL);                    //screens need a name
         screen->name += (udword)loadAddress;                //fix up load address
+
         if (((udword)((ubyte *)screen->links) & 0x03) != 0)
         {
             dbgMessagef("\nWARNING links %s not byte aligned",fileName);
@@ -1809,6 +1827,13 @@
         (ubyte *)screen->atoms += (udword)loadAddress;
         for (index = 0; index < screen->nLinks; index++)
         {                                                   //for each link in screen
+
+#ifdef ENDIAN_BIG
+			screen->links[index].name       = ( char *)LittleLong( ( udword )screen->links[index].name );
+			screen->links[index].flags      = LittleLong( screen->links[index].flags );
+			screen->links[index].linkToName = ( char *)LittleLong( ( udword )screen->links[index].linkToName );
+#endif
+
             if (bitTest(screen->links[index].flags, FL_Enabled))
             {                                               //if link enabled
                 dbgAssert(screen->links[index].name);
@@ -1822,6 +1847,30 @@
         menuItemsPresent = FALSE;
         for (index = 0; index < screen->nAtoms; index++)
         {                                                   //for each atom in screen
+#ifdef ENDIAN_BIG
+			screen->atoms[index].name = ( char *)LittleLong( ( udword )screen->atoms[index].name );
+			screen->atoms[index].flags = LittleLong( screen->atoms[index].flags );
+			screen->atoms[index].status = LittleLong( screen->atoms[index].status );
+			screen->atoms[index].tabstop = LittleShort( screen->atoms[index].tabstop );
+//			screen->atoms[index].borderColor = LittleLong( screen->atoms[index].borderColor );
+//			screen->atoms[index].contentColor = LittleLong( screen->atoms[index].contentColor );
+			screen->atoms[index].x = LittleShort( screen->atoms[index].x );
+			screen->atoms[index].loadedX = LittleShort( screen->atoms[index].loadedX );
+			screen->atoms[index].y = LittleShort( screen->atoms[index].y );
+			screen->atoms[index].loadedY = LittleShort( screen->atoms[index].loadedY );
+			screen->atoms[index].width = LittleShort( screen->atoms[index].width );
+			screen->atoms[index].loadedWidth = LittleShort( screen->atoms[index].loadedWidth );
+			screen->atoms[index].height = LittleShort( screen->atoms[index].height );
+			screen->atoms[index].loadedHeight = LittleShort( screen->atoms[index].loadedHeight );
+			screen->atoms[index].pData = ( ubyte *)LittleLong( ( udword )screen->atoms[index].pData );
+			screen->atoms[index].attribs = ( ubyte *)LittleLong( ( udword )screen->atoms[index].attribs );
+			screen->atoms[index].drawstyle[0] = LittleLong( screen->atoms[index].drawstyle[0] );
+			screen->atoms[index].drawstyle[1] = LittleLong( screen->atoms[index].drawstyle[1] );
+			screen->atoms[index].region = ( void *)LittleLong( ( udword )screen->atoms[index].region );
+			screen->atoms[index].pad[0] = LittleLong( screen->atoms[index].pad[0] );
+			screen->atoms[index].pad[1] = LittleLong( screen->atoms[index].pad[1] );
+#endif
+
             if (screen->atoms[index].type == FA_MenuItem)
             {
                 menuItemsPresent = TRUE;
@@ -1882,7 +1931,7 @@
                 }
                 if (screen->atoms[index].flags & FAF_Bitmap)
                 {                                           //if this is a bitmap
-                    _asm nop
+                    /* _asm nop */
                     //...code to load in the bitmap and set new pointer
                 }
                 else if (screen->atoms[index].type != FA_RadioButton)
@@ -2152,6 +2201,8 @@
 #if FEF_ERROR_CHECKING
     dbgFatalf(DBG_Loc, "\nfeScreenEntryremove: cannot remove screen 0x%x", screen);
 #endif
+
+    return 0;
 }
 
 /*-----------------------------------------------------------------------------
@@ -2195,7 +2246,7 @@
 {
     regionhandle baseRegion, temp;
     fescreen *newScreen;
-    udword numButtons = 0, numRadioButtonsExtra = 0;
+    udword numButtons = 0;
     udword i;
 
     while (feMenuLevel)
@@ -2718,7 +2769,7 @@
 void feAcceleratorSet(regionhandle reg, featom *atom)
 {
     sdword nKeys = 0;
-    char keys[4] = {0,0,0,0};
+    sword keys[4] = {0,0,0,0};
 
     if (bitTest(atom->hotKeyModifiers, HKM_Control))
     {
diff -urPw homeworld-orig/src/Game/FEFlow.h homeworld_sdl-0.3/src/Game/FEFlow.h
--- homeworld-orig/src/Game/FEFlow.h	2002-09-04 12:46:08.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/FEFlow.h	2004-08-01 22:35:22.000000000 -0700
@@ -10,10 +10,10 @@
 #define ___FEFLOW_H
 
 #include <string.h>
-#include "types.h"
-#include "region.h"
-#include "linkedlist.h"
-//#include "uicontrols.h"
+#include "Types.h"
+#include "Region.h"
+#include "LinkedList.h"
+//#include "UIControls.h"
 
 /*=============================================================================
     Switches:
@@ -354,6 +354,7 @@
 regionhandle feRegionsAdd(regionhandle parent, fescreen *screen, bool moveToFront);
 regionhandle feFindRadioButtonRegion(regionhandle temp, bool selected);
 
+struct uiclistwindow;
 void feWheelNegative(struct uiclistwindow *listwindow);
 void feWheelPositive(struct uiclistwindow *listwindow);
 
diff -urPw homeworld-orig/src/Game/FEReg.c homeworld_sdl-0.3/src/Game/FEReg.c
--- homeworld-orig/src/Game/FEReg.c	2002-09-04 12:46:10.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/FEReg.c	2004-08-01 22:35:18.000000000 -0700
@@ -13,9 +13,9 @@
 #include "main.h"
 #include "prim2d.h"
 #include "render.h"
-#include "FeReg.h"
+#include "FEReg.h"
 #include "glcaps.h"
-#include "horserace.h"
+#include "HorseRace.h"
 #include "glcompat.h"
 
 
@@ -782,6 +782,8 @@
             case topright:
                 ferFlipBitmap90((udword *)new_element->lif->data, new_element->lif->width);
                 break;
+            default:
+                break;
         }
     }
     //side texture
@@ -796,6 +798,8 @@
             case top:
                 ferFlipBitmap90((udword *)new_element->lif->data, new_element->lif->width);
                 break;
+            default:
+                break;
         }
     }
 
@@ -1245,6 +1249,8 @@
             case bottomright:
                 ferDraw(x - texture->height + FER_CCBM, y + FER_CCBM, texture);
                 break;
+            default:
+                break;
         }
     }
     else
@@ -1263,6 +1269,8 @@
             case bottomright:
                 ferDraw(x - texture->width, y, texture);
                 break;
+            default:
+                break;
         }
     }
 }
@@ -1807,6 +1815,9 @@
 
         return left;
     }
+    
+    // NB: should never get here; this is just to keep the compiler happy
+    return none; 
 }
 
 /*-----------------------------------------------------------------------------
@@ -2369,6 +2380,8 @@
         case c_off_disabled :
             texture = ferTextureRegister(CHECK_OFF_DISABLED, none, none);
             break;
+        default:
+            break;
     }
     x = texture->width;
     y = texture->height;
@@ -2425,6 +2438,8 @@
         case r_off_disabled :
             texture = ferTextureRegister(RADIO_OFF_DISABLED, none, none);
             break;
+        default:
+            break;
     }
     ferDraw(dimensions.x0, dimensions.y1, texture);
 
@@ -2627,6 +2642,8 @@
                 tab_mid  = VERTST_ON_MID;
                 tab_bot  = VERTST_ON_BOTTOM;
             break;
+            default:
+                break;
         }
         height = shandle->reg.rect.y1 - shandle->reg.rect.y0;
 
diff -urPw homeworld-orig/src/Game/FEReg.h homeworld_sdl-0.3/src/Game/FEReg.h
--- homeworld-orig/src/Game/FEReg.h	2002-09-04 12:46:10.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/FEReg.h	2004-08-01 22:35:18.000000000 -0700
@@ -8,18 +8,22 @@
 #ifndef ___FEREG_H
 #define ___FEREG_H
 
-#include "fontreg.h"
+#include "FontReg.h"
 #include "texreg.h"
-#include "linkedlist.h"
-#include "memory.h"
-#include "region.h"
-#include "uicontrols.h"
+#include "LinkedList.h"
+#include "Memory.h"
+#include "Region.h"
+#include "UIControls.h"
 
 /*=============================================================================
     Definitions:
 =============================================================================*/
 //texture list
+#ifdef _WIN32
 #define FER_PATH                             "FeMan\\Textures\\"
+#else
+#define FER_PATH                             "FeMan/Textures/"
+#endif
 
 //box textures
 #define FER_BOX_OUTER_CORNER            FER_PATH"medium_convex.lif"
diff -urPw homeworld-orig/src/Game/File.c homeworld_sdl-0.3/src/Game/File.c
--- homeworld-orig/src/Game/File.c	2002-09-04 12:46:10.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/File.c	2004-08-01 22:35:36.000000000 -0700
@@ -8,13 +8,14 @@
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
-#include <io.h>
+#include <limits.h>
 #include <stdarg.h>
+#include <sys/stat.h>
 
-#include "types.h"
-#include "memory.h"
-#include "debug.h"
-#include "file.h"
+#include "Types.h"
+#include "Memory.h"
+#include "Debug.h"
+#include "File.h"
 #include "BigFile.h"
 #include "BitIO.h"
 #include "LZSS.h"
@@ -54,9 +55,10 @@
     Data:
 =============================================================================*/
 #if FILE_PREPEND_PATH
-char filePrependPath[_MAX_PATH];
-char fileCDROMPath[_MAX_PATH];
-char filePrependedPath[_MAX_PATH];
+char filePrependPath[PATH_MAX + 1];
+char fileCDROMPath[PATH_MAX + 1];
+char fileUserSettingsPath[PATH_MAX + 1];
+char filePrependedPath[PATH_MAX + 1];
 #endif
 
 // filehandles are an index into this array
@@ -78,6 +80,373 @@
 =============================================================================*/
 
 /*-----------------------------------------------------------------------------
+    Name        : fileNameReplaceSlashes
+    Description : Replaces slashes in the file name with slashes used by the
+                  target platform to separate path components in the local
+                  filesystem.
+    Inputs      : fileName - Path and name of file.
+    Outputs     : fileName - Modified file name.
+    Return      : (None.)
+    Note        : This is not needed for use with BIG files (slashes are
+                  replaced as needed within BIG file functions).  Slashes are
+                  also not condensed as with filenameSlashMassage() in
+                  BigFile.c.
+----------------------------------------------------------------------------*/
+static void fileNameReplaceSlashes (char* fileName)
+{
+    char ch;
+
+    for ( ; (ch = *fileName); fileName++)
+    {
+#ifdef _WIN32
+        if (ch == '/')
+            *fileName = '\\';
+#else
+        if (ch == '\\')
+            *fileName = '/';
+#endif
+    }
+}
+
+
+/*-----------------------------------------------------------------------------
+    Name        : fileNameReducePath
+    Description : Removes extraneous slashes in the given path and reduces
+                  occurences of "." and "..".
+    Inputs      : pathName - File path.
+    Return      : (None.)
+----------------------------------------------------------------------------*/
+static void fileNameReducePath (char *pathName)
+{
+    size_t pathLen;
+
+    char *pathElem[PATH_MAX];
+    udword pathElemCount;
+
+    size_t searchLoc;
+    bool8 isPathAbsolute;
+
+    udword i;
+
+    dbgAssert(pathName != NULL);
+
+    pathLen = strlen(pathName);
+
+    /* Reduce slashes. */
+    for (i = 1; i < pathLen; i++)
+    {
+        char chPrev = pathName[i - 1];
+        char chCurr = pathName[i];
+        if ((chPrev == '/' || chPrev == '\\') &&
+            (chCurr == '/' || chCurr == '\\'))
+        {
+            memmove(pathName + i - 1, pathName + i, pathLen - i + 1);
+            pathLen--;
+            i--;
+        }
+    }
+
+    /* Remove trailing slashes. */
+    while (pathName[pathLen - 1] == '/' ||
+           pathName[pathLen - 1] == '\\')
+    {
+        pathLen--;
+        pathName[pathLen] = '\0';
+    }
+
+    /* Split up the path string into an array containing each path
+       component. */
+    pathElem[0] = pathName;
+    pathElemCount = 1;
+
+    searchLoc = strcspn(pathName, "/\\");
+    while (searchLoc != pathLen)
+    {
+        size_t searchLocPrev = searchLoc;
+
+        pathName[searchLoc] = '\0';
+
+        pathElem[pathElemCount] = pathName + searchLoc + 1;
+        pathElemCount++;
+
+        searchLoc = strcspn(pathName + searchLocPrev + 1, "/\\");
+        searchLoc += searchLocPrev + 1;
+    }
+
+#ifdef _WIN32
+    isPathAbsolute = (isalpha[pathName[0]] && pathName[1] == ':' &&
+        pathName[2] == '\0');
+#else
+    isPathAbsolute = (pathName[0] == '\0');
+#endif
+
+    if (isPathAbsolute)
+    {
+        /* Skip over the root path element, we don't need to look at it for
+           now. */
+        pathElemCount--;
+        if (pathElemCount != 0)
+        {
+            memmove(pathElem, pathElem + 1, sizeof(char *) * pathElemCount);
+        }
+    }
+
+    /* Using our array of path components, reduce any occurences of "." and
+       "..". */
+    for (i = 0; i < pathElemCount; i++)
+    {
+        char *currentElem = pathElem[i];
+
+        if (currentElem[0] != '.')
+            continue;
+
+        if (currentElem[1] == '\0')
+        {
+            /* The current path element refers to the current directory ("."),
+               so we can remove it. */
+            pathElemCount--;
+            if (i < pathElemCount)
+            {
+                memmove(pathElem + i, pathElem + i + 1,
+                    sizeof(char *) * pathElemCount - i);
+            }
+            i--;
+
+            continue;
+        }
+
+        if (!(currentElem[1] == '.' && currentElem[2] == '\0'))
+            continue;
+
+        /* The current path element refers to the parent directory (".."). */
+        if (i == 0)
+        {
+            if (isPathAbsolute)
+            {
+                dbgMessagef("\nfileNameReducePath(): Attempted to reach a "
+                            "parent directory of the root directory.");
+
+                /* Attempting to reach a directory below the root directory, so
+                   just get rid of the current element. */
+                pathElemCount--;
+                if (pathElemCount != 0)
+                {
+                    memmove(pathElem, pathElem + 1,
+                        sizeof(char *) * pathElemCount);
+                }
+                i--;
+            }
+
+            continue;
+        }
+
+        if (!strcmp(pathElem[i - 1], ".."))
+        {
+            /* Previous path element also represents the previous directory, so
+               keep this element and allow further traversal up the directory
+               tree. */
+            continue;
+        }
+
+        /* Remove the current and previous path elements. */
+        dbgAssert(pathElemCount >= 2);
+        pathElemCount--;
+        if (i < pathElemCount)
+        {
+            memmove(pathElem + i - 1, pathElem + i + 1,
+                sizeof(char *) * pathElemCount - i);
+        }
+        pathElemCount--;
+        i -= 2;
+    }
+
+    /* Rebuild the path string. */
+    pathLen = 0;
+
+    if (isPathAbsolute)
+    {
+#ifdef _WIN32
+        pathName[2] = '\\';
+        pathLen = 3;
+#else
+        pathName[0] = '/';
+        pathLen = 1;
+#endif
+    }
+
+    if (pathElemCount == 0)
+    {
+        pathName[pathLen] = '\0';
+        return;
+    }
+
+    for (i = 0; i < pathElemCount; i++)
+    {
+        char *currentElem = pathElem[i];
+        size_t elemLen = strlen(currentElem);
+
+        memmove(pathName + pathLen, currentElem,
+            sizeof(char) * elemLen);
+
+        pathLen += elemLen;
+#ifdef _WIN32
+        pathName[pathLen] = '\\';
+#else
+        pathName[pathLen] = '/';
+#endif
+        pathLen++;
+    }
+
+    /* Remove the trailing slash. */
+    pathName[pathLen - 1] = '\0';
+}
+
+
+/*-----------------------------------------------------------------------------
+    Name        : fileMakeDirectory
+    Description : Creates the specified directory, creating parent directories
+                  as necessary.
+    Inputs      : directoryName - Name of the directory to create.
+    Return      : TRUE if successful, FALSE if not.
+----------------------------------------------------------------------------*/
+bool8 fileMakeDirectory (const char *directoryName)
+{
+    char directoryCopy[PATH_MAX + 1];
+    size_t directoryLen;
+
+    char *ch;
+    udword i;
+
+    dbgAssert(directoryName != NULL);
+    dbgAssert(strlen(directoryName) <= PATH_MAX);
+
+    /* Make a copy of the directory name with which we can modify as needed. */
+    strncpy(directoryCopy, directoryName, PATH_MAX);
+    directoryCopy[PATH_MAX] = '\0';
+
+    /* Reduce the path name. */
+    fileNameReducePath(directoryCopy);
+
+    directoryLen = strlen(directoryCopy);
+    if (directoryLen == 0)
+        return TRUE;
+
+#ifdef _WIN32
+    if (directoryCopy[directoryLen - 1] != '\\')
+    {
+        directoryCopy[directoryLen] = '\\';
+        directoryLen++;
+        directoryCopy[directoryLen] = '\0';
+    }
+#else
+    if (directoryCopy[directoryLen - 1] != '/')
+    {
+        directoryCopy[directoryLen] = '/';
+        directoryLen++;
+        directoryCopy[directoryLen] = '\0';
+    }
+#endif
+
+    /* Find the first path element that isn't the root directory or a parent
+       directory delimiter. */
+#ifdef _WIN32
+    ch = strchr(directoryCopy, '\\');
+    if (ch)
+    {
+        *ch = '\0';
+
+        if (isalpha(directoryCopy[0]) && directoryCopy[1] == ':' &&
+            directoryCopy[2] == '\0')
+        {
+            *ch = '\\';
+            ch = strchr(ch + 1, '\\');
+            *ch = '\0';
+        }
+    }
+#else
+    ch = strchr(directoryCopy, '/');
+    if (ch)
+    {
+        *ch = '\0';
+
+        if (directoryCopy[0] == '\0')
+        {
+            *ch = '/';
+            ch = strchr(ch + 1, '/');
+            *ch = '\0';
+        }
+    }
+#endif
+
+    /* Create each directory as needed. */
+    struct stat fileStat;
+    while (ch)
+    {
+        *ch = 0;
+
+        /* Check if the directory exists. */
+        if (stat(directoryCopy, &fileStat) == 0)
+        {
+            /* A filesystem entry exists, so make sure it's a directory. */
+            if (!S_ISDIR(fileStat.st_mode))
+                return FALSE;
+        }
+        else
+        {
+            /* Attempt to create the directory. */
+            if (mkdir(directoryCopy, 0777) == -1)
+                return FALSE;
+        }
+
+        /* Continue with the next path element. */
+#ifdef _WIN32
+        *ch = '\\';
+        ch = strchr(ch + 1, '\\');
+#else
+        *ch = '/';
+        ch = strchr(ch + 1, '/');
+#endif
+    }
+
+    return TRUE;
+}
+
+
+/*-----------------------------------------------------------------------------
+    Name        : fileMakeDestinationDirectory
+    Description : Creates the directory in which the given file resides.
+    Inputs      : fileName - path and name of file.
+    Return      : TRUE if the directory exists or could be created, FALSE if
+                  not.
+----------------------------------------------------------------------------*/
+bool8 fileMakeDestinationDirectory(const char *fileName)
+{
+    char *directoryName[PATH_MAX + 1];
+    char *ch0, *ch1;
+
+    dbgAssert(fileName);
+
+    /* Make a copy of the directory name string, excluding the file itself. */
+    strncpy(directoryName, fileName, PATH_MAX);
+    directoryName[PATH_MAX] = '\0';
+
+    ch0 = strrchr(directoryName, '/');
+    ch1 = strrchr(directoryName, '\\');
+    if (ch1 > ch0)
+        ch0 = ch1;
+
+    /* If the file is in the current directory, assume the directory exists. */
+    if (!ch0)
+        return TRUE;
+
+    /* Create the directory. */
+    *ch0 = '\0';
+
+    return fileMakeDirectory(directoryName);
+}
+
+
+/*-----------------------------------------------------------------------------
     Name        : fileLoadAlloc
     Description : Loads specified file into memory after allocating memory for it.
     Inputs      : fileName - path and name of file to be loaded.
@@ -104,7 +473,7 @@
     dbgAssert(address != NULL);
 
     //  try to load from bigfile
-    if (!IgnoreBigfiles && !bitTest(flags, FF_CDROM|FF_IgnoreBIG))
+    if (!IgnoreBigfiles && !bitTest(flags, FF_CDROM|FF_IgnoreBIG|FF_UserSettingsPath))
     {
         // possibly still skip the bigfile version of the file
         // if there's something newer available in the filesystem
@@ -148,6 +517,7 @@
     // filesystem load
 
     fileName = filePathPrepend(_fileName, flags);           //get full path
+    fileNameReplaceSlashes(fileName);
 
     nameLength = strlen(fileName);                          //set memory name to the
     dbgAssert(nameLength > 1);                              //end of the filename if filename too long
@@ -226,7 +596,7 @@
     sdword existsInMainBigfile;
 
     //  try to load from bigfile
-    if (!IgnoreBigfiles && !bitTest(flags, FF_CDROM|FF_IgnoreBIG))
+    if (!IgnoreBigfiles && !bitTest(flags, FF_CDROM|FF_IgnoreBIG|FF_UserSettingsPath))
     {
         // possibly still skip the bigfile version of the file
         // if there's something newer available in the filesystem
@@ -270,6 +640,7 @@
     // filesystem
 
     fileName = filePathPrepend(_fileName, flags);            //get full path
+    fileNameReplaceSlashes(fileName);
 
     length = fileSizeGet(_fileName, flags);                  //get length of file
 
@@ -323,6 +694,16 @@
     sdword lengthWrote;
 
     fileName = filePathPrepend(_fileName, 0);               //get full path
+    fileNameReplaceSlashes(fileName);
+
+    if (!fileMakeDestinationDirectory(fileName))
+    {
+        dbgFatalf(
+            DBG_Loc,
+            "fileSave: unable to create destination directory for file %s",
+            fileName);
+        return 0;
+    }
 
     if ((outFile = fopen(fileName, "wb")) == NULL)           //open the file
     {
@@ -341,7 +722,7 @@
     fclose(outFile);
 
 #if FILE_VERBOSE_LEVEL >= 2
-    dbgMessagef("\fileSave: saved %d bytes of '%s' to 0x%x", length, fileName, address);
+    dbgMessagef("\nfileSave: saved %d bytes of '%s' to 0x%x", length, fileName, address);
 #endif
 
     return lengthWrote;
@@ -386,12 +767,12 @@
 ----------------------------------------------------------------------------*/
 sdword fileExists(char *_fileName, udword flags)
 {
-    struct _finddata_t findData;
+    struct stat file_stat;
     char *fileName;
     sdword existsInBigfile;
     sdword fileNum;
 
-    if (!IgnoreBigfiles && !bitTest(flags, FF_CDROM|FF_IgnoreBIG))
+    if (!IgnoreBigfiles && !bitTest(flags, FF_CDROM|FF_IgnoreBIG|FF_UserSettingsPath))
     {
         // possibly still skip the bigfile version of the file
         // if there's something newer available in the filesystem
@@ -417,8 +798,9 @@
     }
 
     fileName = filePathPrepend(_fileName, flags);            //get full path
+    fileNameReplaceSlashes(fileName);
 
-    if (_findfirst(fileName, &findData) != -1)
+    if (stat(fileName, &file_stat) != -1)
     {
 #if FILE_VERBOSE_LEVEL >= 3
     dbgMessagef("\nfileExists: '%s' exists", fileName);
@@ -449,7 +831,7 @@
     sdword fileNum;
     sdword existsInBigfile;
 
-    if (!IgnoreBigfiles && !bitTest(flags, FF_CDROM|FF_IgnoreBIG))
+    if (!IgnoreBigfiles && !bitTest(flags, FF_CDROM|FF_IgnoreBIG|FF_UserSettingsPath))
     {
         // possibly still skip the bigfile version of the file
         // if there's something newer available in the filesystem
@@ -478,6 +860,7 @@
     }
 
     fileName = filePathPrepend(_fileName, flags);            //get full path
+    fileNameReplaceSlashes(fileName);
 
     if ((file = fopen(fileName, "rb")) == NULL)             //open the file
     {
@@ -504,6 +887,7 @@
     char *fileName;
 
     fileName = filePathPrepend(_fileName, 0);               //get full path
+    fileNameReplaceSlashes(fileName);
 
     remove(fileName);
 }
@@ -549,7 +933,7 @@
     strcpy(filesOpen[fh].path, _fileName);
 
     //  try to load from bigfile
-    if (!IgnoreBigfiles && !bitTest(flags, FF_CDROM|FF_IgnoreBIG))
+    if (!IgnoreBigfiles && !bitTest(flags, FF_CDROM|FF_IgnoreBIG|FF_UserSettingsPath))
     {
         // possibly still skip the bigfile version of the file
         // if there's something newer available in the filesystem
@@ -620,7 +1004,6 @@
                             else
                             {
                                 sdword mainFileNum;
-                                sdword inMain = bigTOCFileExists(&mainTOC, _fileName, (int *)&mainFileNum);
                                 logfileLogf(FILELOADSLOG, " | [M]    %s  | ",
                                             mainNewerAvailable[mainFileNum] == 1 ? "f" : " ");
                             }
@@ -650,7 +1033,6 @@
                             else
                             {
                                 sdword mainFileNum;
-                                sdword inMain = bigTOCFileExists(&mainTOC, _fileName, (int *)&mainFileNum);
                                 logfileLogf(FILELOADSLOG, " | [M]    %s  | ",
                                             mainNewerAvailable[mainFileNum] == 1 ? "f" : " ");
                             }
@@ -680,7 +1062,6 @@
                         else
                         {
                             sdword mainFileNum;
-                            sdword inMain = bigTOCFileExists(&mainTOC, _fileName, (int *)&mainFileNum);
                             logfileLogf(FILELOADSLOG, " | [M]    %s  | ",
                                         mainNewerAvailable[mainFileNum] == 1 ? "f" : " ");
                         }
@@ -715,7 +1096,6 @@
                     else
                     {
                         sdword mainFileNum;
-                        sdword inMain = bigTOCFileExists(&mainTOC, _fileName, (int *)&mainFileNum);
                         logfileLogf(FILELOADSLOG, " | [M]    %s  | ",
                                     mainNewerAvailable[mainFileNum] == 1 ? "f" : " ");
                     }
@@ -735,6 +1115,7 @@
     // resort to the good old disk filesystem
 
     fileName = filePathPrepend(_fileName, flags);            //get full path
+    fileNameReplaceSlashes(fileName);
 
     if (bitTest(flags, FF_AppendMode))
     {
@@ -775,6 +1156,16 @@
             logfileLogf(FILELOADSLOG, "%-80s |       [F] |\n", _fileName);
     }
 
+    if (bitTest(flags, FF_AppendMode | FF_WriteMode) &&
+        !fileMakeDestinationDirectory(fileName))
+    {
+        dbgFatalf(
+            DBG_Loc,
+            "fileOpen: unable to create destination directory for file %s",
+            fileName);
+        return 0;
+    }
+
     if ((file = fopen(fileName, access)) == NULL)
     {
         if (bitTest(flags, FF_ReturnNULLOnFail))
@@ -1167,13 +1558,24 @@
 #if FILE_PREPEND_PATH
 void filePrependPathSet(char *path)
 {
+    unsigned int path_len;
     dbgAssert(path != NULL);
     strcpy(filePrependPath, path);                          //make copy of specified path
-    dbgAssert(strlen(filePrependPath));
-    if (filePrependPath[strlen(filePrependPath) - 1] != '\\')
+
+    path_len = strlen(filePrependPath);
+    dbgAssert(path_len);
+#ifdef _WIN32
+    if (filePrependPath[path_len - 1] != '\\')
     {                                                       //make sure a backslash is on the end
         strcat(filePrependPath, "\\");                      //put a backslash on the end
     }
+#else
+    if (filePrependPath[path_len - 1] != '\\' &&
+        filePrependPath[path_len - 1] != '/')
+    {                                    /* make sure a slash is on the end */
+        strcat(filePrependPath, "/");    /* put a slash on the end */
+    }
+#endif
 }
 #endif
 
@@ -1186,20 +1588,63 @@
 ----------------------------------------------------------------------------*/
 void fileCDROMPathSet(char *path)
 {
+    unsigned int path_len;
     dbgAssert(path != NULL);
     strcpy(fileCDROMPath, path);                            //make copy of specified path
-    dbgAssert(strlen(fileCDROMPath));
-    if (fileCDROMPath[strlen(fileCDROMPath) - 1] != '\\')
+
+    path_len = strlen(fileCDROMPath);
+    dbgAssert(path_len);
+#ifdef _WIN32
+    if (fileCDROMPath[path_len - 1] != '\\')
     {                                                       //make sure a backslash is on the end
         strcat(fileCDROMPath, "\\");                        //put a backslash on the end
     }
+#else
+    if (fileCDROMPath[path_len - 1] != '\\' &&
+        fileCDROMPath[path_len - 1] != '/')
+    {                                    /* make sure a slash is on the end */
+        strcat(fileCDROMPath, "/");      /* put a slash on the end */
+    }
+#endif
+}
+
+/*-----------------------------------------------------------------------------
+    Name        : fileUserSettingsPathSet
+    Description : Like above, but it sets the user settings path for storing
+                  configuration settings, saved games, and screenshots
+                  (typically ~/.homeworld)
+    Inputs      : path - path for user settings
+    Outputs     :
+    Return      :
+----------------------------------------------------------------------------*/
+void fileUserSettingsPathSet(char *path)
+{
+    unsigned int path_len;
+    dbgAssert(path != NULL);
+    strcpy(fileUserSettingsPath, path);                     //make copy of specified path
+
+    path_len = strlen(fileUserSettingsPath);
+    dbgAssert(path_len);
+#ifdef _WIN32
+    if (fileUserSettingsPath[path_len - 1] != '\\')
+    {                                                       //make sure a backslash is on the end
+        strcat(fileUserSettingsPath, "\\");                 //put a backslash on the end
+    }
+#else
+    if (fileUserSettingsPath[path_len - 1] != '\\' &&
+        fileUserSettingsPath[path_len - 1] != '/')
+    {                                       /* make sure a slash is on the end */
+        strcat(fileUserSettingsPath, "/");  /* put a slash on the end */
+    }
+#endif
 }
 
 /*-----------------------------------------------------------------------------
     Name        : filePathPrepend
     Description : Prepend the default path for opening files.
     Inputs      : fileName - file name/relative path to add to end of default path
-                  flags - flags for the file we want.  Only the FF_CDROM flag is used
+                  flags - flags for the file we want.  Only the FF_CDROM and
+                          FF_UserSettingsPath flags are used
     Outputs     : Copies prepend path to global variable and concatenates fileName
     Return      : pointer to new full path
 ----------------------------------------------------------------------------*/
@@ -1216,6 +1661,10 @@
         strcpy(filePrependedPath,fileName);     // just copy, don't actually prepend
         return(filePrependedPath);
     }
+    else if (bitTest(flags, FF_UserSettingsPath))
+    {
+        strcpy(filePrependedPath, fileUserSettingsPath);
+    }
     else if (bitTest(flags, FF_CDROM))
     {
         strcpy(filePrependedPath, fileCDROMPath);           //get the CD-ROM path
diff -urPw homeworld-orig/src/Game/File.h homeworld_sdl-0.3/src/Game/File.h
--- homeworld-orig/src/Game/File.h	2002-09-04 12:46:10.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/File.h	2004-08-01 22:35:36.000000000 -0700
@@ -9,8 +9,8 @@
 #define ___FILE_H
 
 #include <stdio.h>
-#include "bigfile.h"
-#include "types.h"
+#include "BigFile.h"
+#include "Types.h"
 
 /*=============================================================================
     Switches
@@ -60,6 +60,7 @@
 #define FF_CDROM                128             //open from CD-ROM
 #define FF_IgnoreBIG            256             //don't look in .BIG file, only try to load from disk
 #define FF_IgnorePrepend        512             //don't add stock path to beginning of file names
+#define FF_UserSettingsPath     1024            //use ~/.homeworld as the base path
 
 //names of log files
 #define FN_OpenLog              "open.log"
@@ -109,10 +110,12 @@
 void filePrependPathSet(char *path);
 char *filePathPrepend(char *path, udword flags);
 void fileCDROMPathSet(char *path);
+void fileUserSettingsPathSet(char *path);
 #else
 #define filePrependPathSet(p)
 #define filePathPrepend(p,f)
 #define fileCDROMPathSet(p)
+#define fileUserSettingsPathSet(p)
 #endif
 
 extern char filePrependPath[];
@@ -141,6 +144,8 @@
 FILE *fileStream(filehandle handle);
 
 //utility functions
+bool8 fileMakeDirectory(const char *directoryName);
+bool8 fileMakeDestinationDirectory(const char *fileName);
 sdword fileExistsInBigFile(char *_fileName);
 sdword fileExists(char *fileName, udword flags);
 sdword fileSizeGet(char *fileName, udword flags);
diff -urPw homeworld-orig/src/Game/FlightMan.c homeworld_sdl-0.3/src/Game/FlightMan.c
--- homeworld-orig/src/Game/FlightMan.c	2002-09-04 12:46:10.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/FlightMan.c	2004-08-01 22:35:25.000000000 -0700
@@ -10,18 +10,18 @@
 #include <stdlib.h>
 #include <string.h>
 #include <math.h>
-#include "types.h"
-#include "debug.h"
-#include "memory.h"
-#include "physics.h"
-#include "spaceobj.h"
-#include "universe.h"
-#include "statscript.h"
-#include "aitrack.h"
-#include "aiship.h"
-#include "soundevent.h"
-#include "flightman.h"
-#include "randy.h"
+#include "Types.h"
+#include "Debug.h"
+#include "Memory.h"
+#include "Physics.h"
+#include "SpaceObj.h"
+#include "Universe.h"
+#include "StatScript.h"
+#include "AITrack.h"
+#include "AIShip.h"
+#include "SoundEvent.h"
+#include "FlightMan.h"
+#include "Randy.h"
 
 #ifndef HW_Release
 //#define FLIGHTMAN_DEBUG
@@ -373,10 +373,7 @@
 
 bool flightmanPitchDown(Ship *ship,real32 *totalAngleRotated,real32 degreesToRotate,real32 maxrotspeed,real32 rotaccelmodifier)
 {
-    ShipStaticInfo *shipstaticinfo = (ShipStaticInfo *)ship->staticinfo;
-    real32 rotspeedy;
-
-    rotspeedy = ship->rotinfo.rotspeed.y;
+    real32 rotspeedy = ship->rotinfo.rotspeed.y;
     *totalAngleRotated += universe.phystimeelapsed * rotspeedy;
 
     if (*totalAngleRotated <= -degreesToRotate)
@@ -395,10 +392,7 @@
 
 bool flightmanPitchUp(Ship *ship,real32 *totalAngleRotated,real32 degreesToRotate,real32 maxrotspeed,real32 rotaccelmodifier)
 {
-    ShipStaticInfo *shipstaticinfo = (ShipStaticInfo *)ship->staticinfo;
-    real32 rotspeedy;
-
-    rotspeedy = ship->rotinfo.rotspeed.y;
+    real32 rotspeedy = ship->rotinfo.rotspeed.y;
     *totalAngleRotated += universe.phystimeelapsed * rotspeedy;
 
     if (*totalAngleRotated >= degreesToRotate)
@@ -417,10 +411,7 @@
 
 bool flightmanRollRight(Ship *ship,real32 *totalAngleRotated,real32 degreesToRotate,real32 maxrotspeed,real32 rotaccelmodifier)
 {
-    ShipStaticInfo *shipstaticinfo = (ShipStaticInfo *)ship->staticinfo;
-    real32 rotspeedz;
-
-    rotspeedz = ship->rotinfo.rotspeed.z;
+    real32 rotspeedz = ship->rotinfo.rotspeed.z;
     *totalAngleRotated += universe.phystimeelapsed * rotspeedz;
 
     if (*totalAngleRotated >= degreesToRotate)
@@ -439,10 +430,7 @@
 
 bool flightmanRollLeft(Ship *ship,real32 *totalAngleRotated,real32 degreesToRotate,real32 maxrotspeed,real32 rotaccelmodifier)
 {
-    ShipStaticInfo *shipstaticinfo = (ShipStaticInfo *)ship->staticinfo;
-    real32 rotspeedz;
-
-    rotspeedz = ship->rotinfo.rotspeed.z;
+    real32 rotspeedz = ship->rotinfo.rotspeed.z;
     *totalAngleRotated += universe.phystimeelapsed * rotspeedz;
 
     if (*totalAngleRotated <= -degreesToRotate)
@@ -461,10 +449,7 @@
 
 bool flightmanYawRight(Ship *ship,real32 *totalAngleRotated,real32 degreesToRotate,real32 maxrotspeed,real32 rotaccelmodifier)
 {
-    ShipStaticInfo *shipstaticinfo = (ShipStaticInfo *)ship->staticinfo;
-    real32 rotspeedx;
-
-    rotspeedx = ship->rotinfo.rotspeed.x;
+    real32 rotspeedx = ship->rotinfo.rotspeed.x;
     *totalAngleRotated += universe.phystimeelapsed * rotspeedx;
 
     if (*totalAngleRotated <= -degreesToRotate)
@@ -483,10 +468,7 @@
 
 bool flightmanYawLeft(Ship *ship,real32 *totalAngleRotated,real32 degreesToRotate,real32 maxrotspeed,real32 rotaccelmodifier)
 {
-    ShipStaticInfo *shipstaticinfo = (ShipStaticInfo *)ship->staticinfo;
-    real32 rotspeedx;
-
-    rotspeedx = ship->rotinfo.rotspeed.x;
+    real32 rotspeedx = ship->rotinfo.rotspeed.x;
     *totalAngleRotated += universe.phystimeelapsed * rotspeedx;
 
     if (*totalAngleRotated >= degreesToRotate)
@@ -618,7 +600,6 @@
 bool flightmanFlipTurnExecute(Ship *ship)
 {
     FlipTurnInfo *flipturninfo;
-    ShipStaticInfo *shipstaticinfo = (ShipStaticInfo *)ship->staticinfo;
 
     dbgAssert(ship->flightman == FLIGHTMAN_FLIPTURN);
     flipturninfo = (FlipTurnInfo *)ship->flightmanInfo;
@@ -702,7 +683,6 @@
 bool flightmanCorkscrewExecute(Ship *ship)
 {
     CorkscrewInfo *corkscrewinfo;
-    ShipStaticInfo *shipstaticinfo = (ShipStaticInfo *)ship->staticinfo;
 
     dbgAssert(ship->flightman == FLIGHTMAN_CORKSCREW);
     corkscrewinfo = (CorkscrewInfo *)ship->flightmanInfo;
@@ -756,7 +736,6 @@
 bool flightmanImmelmanExecute(Ship *ship)
 {
     ImmelmanInfo *immelmaninfo;
-    ShipStaticInfo *shipstaticinfo = (ShipStaticInfo *)ship->staticinfo;
     bool result;
 
     dbgAssert(ship->flightman == FLIGHTMAN_IMMELMAN);
@@ -842,7 +821,6 @@
 bool flightmanSplitSExecute(Ship *ship)
 {
     SplitSInfo *splitsinfo;
-    ShipStaticInfo *shipstaticinfo = (ShipStaticInfo *)ship->staticinfo;
     bool result;
 
     dbgAssert(ship->flightman == FLIGHTMAN_SPLIT_S);
@@ -931,7 +909,6 @@
 bool flightmanHardBankExecute(Ship *ship)
 {
     HardBankInfo *hardbankinfo;
-    ShipStaticInfo *shipstaticinfo = (ShipStaticInfo *)ship->staticinfo;
     bool result;
 
     dbgAssert(ship->flightman == FLIGHTMAN_HARDBANK);
@@ -1009,7 +986,6 @@
 bool flightmanSoftBankExecute(Ship *ship)
 {
     SoftBankInfo *softbankinfo;
-    ShipStaticInfo *shipstaticinfo = (ShipStaticInfo *)ship->staticinfo;
     bool result;
 
     dbgAssert(ship->flightman == FLIGHTMAN_SOFTBANK);
@@ -1139,7 +1115,6 @@
 bool flightmanSlalomExecute(Ship *ship)
 {
     SlalomInfo *slalominfo;
-    ShipStaticInfo *shipstaticinfo = (ShipStaticInfo *)ship->staticinfo;
     vector *curwaypoint;
 
     dbgAssert(ship->flightman == FLIGHTMAN_SLALOM);
@@ -1621,7 +1596,6 @@
 
 bool flightmanRollAwayExecute(Ship *ship)
 {
-    ShipStaticInfo *shipstaticinfo = (ShipStaticInfo *)ship->staticinfo;
     RollAwayInfo *rollawayinfo;
     bool result;
 
@@ -1719,7 +1693,6 @@
 bool flightmanSplitSEvasiveExecute(Ship *ship)
 {
     SplitSEvasiveInfo *splitsevasiveinfo;
-    ShipStaticInfo *shipstaticinfo = (ShipStaticInfo *)ship->staticinfo;
     bool result;
 
     dbgAssert(ship->flightman == FLIGHTMAN_SPLITS_EVASIVE);
@@ -1821,7 +1794,6 @@
 bool flightmanHiYoYoExecute(Ship *ship)
 {
     HiYoYoInfo *hiyoyoinfo;
-    ShipStaticInfo *shipstaticinfo = (ShipStaticInfo *)ship->staticinfo;
 
     dbgAssert(ship->flightman == FLIGHTMAN_HIYOYO);
     hiyoyoinfo = (HiYoYoInfo *)ship->flightmanInfo;
@@ -1886,6 +1858,8 @@
             dbgAssert(FALSE);
             break;
     }
+
+    return FALSE;
 }
 
 /*=============================================================================
@@ -1914,7 +1888,6 @@
 bool flightmanLoYoYoExecute(Ship *ship)
 {
     LoYoYoInfo *loyoyoinfo;
-    ShipStaticInfo *shipstaticinfo = (ShipStaticInfo *)ship->staticinfo;
 
     dbgAssert(ship->flightman == FLIGHTMAN_LOYOYO);
     loyoyoinfo = (LoYoYoInfo *)ship->flightmanInfo;
@@ -1979,6 +1952,8 @@
             dbgAssert(FALSE);
             break;
     }
+
+    return FALSE;
 }
 
 /*=============================================================================
@@ -2021,7 +1996,6 @@
 bool flightmanSideStepExecute(Ship *ship)
 {
     SideStepInfo *sidestepinfo;
-    ShipStaticInfo *shipstaticinfo = (ShipStaticInfo *)ship->staticinfo;
     bool result;
     bool pitchresult;
 
@@ -2101,6 +2075,8 @@
             dbgAssert(FALSE);
             break;
     }
+
+    return FALSE;
 }
 
 /*=============================================================================
@@ -2210,7 +2186,7 @@
         case FLIGHTMAN_EVASIVE_BEHIND:
             if (prob->sumtotalEvasiveBehind != 0)
             {
-                randnum = random(prob->sumtotalEvasiveBehind);
+                randnum = randomG(prob->sumtotalEvasiveBehind);
 
                 for (i=0;i<FLIGHTMAN_TYPE_EVASIVE_NUM;i++)
                 {
@@ -2226,7 +2202,7 @@
         case FLIGHTMAN_EVASIVE_FRONT:
             if (prob->sumtotalEvasiveFront != 0)
             {
-                randnum = random(prob->sumtotalEvasiveFront);
+                randnum = randomG(prob->sumtotalEvasiveFront);
 
                 for (i=0;i<FLIGHTMAN_TYPE_EVASIVE_NUM;i++)
                 {
@@ -2242,7 +2218,7 @@
         case FLIGHTMAN_EVASIVE_PURE:
             if (prob->sumtotalEvasivePure != 0)
             {
-                randnum = random(prob->sumtotalEvasivePure);
+                randnum = randomG(prob->sumtotalEvasivePure);
 
                 for (i=0;i<FLIGHTMAN_TYPE_EVASIVE_NUM;i++)
                 {
@@ -2258,7 +2234,7 @@
         case FLIGHTMAN_TURNAROUND:
             if (prob->sumtotalTurnaround != 0)
             {
-                randnum = random(prob->sumtotalTurnaround);
+                randnum = randomG(prob->sumtotalTurnaround);
 
                 for (i=0;i<FLIGHTMAN_TYPE_TURNAROUND_NUM;i++)
                 {
@@ -2274,7 +2250,7 @@
         case FLIGHTMAN_AIP:
             if (prob->sumtotalAIP != 0)
             {
-                randnum = random(prob->sumtotalAIP);
+                randnum = randomG(prob->sumtotalAIP);
 
                 for (i=0;i<FLIGHTMAN_TYPE_AIP_NUM;i++)
                 {
@@ -2309,7 +2285,9 @@
             dbgAssert(flightman <= FLIGHTMAN_TYPE_TURNAROUND_END);
             sumtotal = prob->sumtotalTurnaround;
             if (sumtotal == 0) return FALSE;
-            randnum = random(sumtotal);
+
+            randnum = randomG(sumtotal);
+
             if (randnum < prob->flightprobTurnaround[flightman-FLIGHTMAN_TYPE_TURNAROUND_START])
             {
                 return TRUE;
@@ -2321,7 +2299,9 @@
             dbgAssert(flightman <= FLIGHTMAN_TYPE_AIP_END);
             sumtotal = prob->sumtotalAIP;
             if (sumtotal == 0) return FALSE;
-            randnum = random(sumtotal);
+
+			randnum = randomG(sumtotal);
+
             if (randnum < prob->flightprobAIP[flightman-FLIGHTMAN_TYPE_AIP_START])
             {
                 return TRUE;
@@ -2333,7 +2313,9 @@
             dbgAssert(flightman <= FLIGHTMAN_TYPE_EVASIVE_END);
             sumtotal = prob->sumtotalEvasiveBehind;
             if (sumtotal == 0) return FALSE;
-            randnum = random(sumtotal);
+
+            randnum = randomG(sumtotal);
+
             if (randnum < prob->flightprobEvasiveBehind[flightman-FLIGHTMAN_TYPE_EVASIVE_START])
             {
                 return TRUE;
@@ -2345,7 +2327,9 @@
             dbgAssert(flightman <= FLIGHTMAN_TYPE_EVASIVE_END);
             sumtotal = prob->sumtotalEvasiveFront;
             if (sumtotal == 0) return FALSE;
-            randnum = random(sumtotal);
+
+            randnum = randomG(sumtotal);
+
             if (randnum < prob->flightprobEvasiveFront[flightman-FLIGHTMAN_TYPE_EVASIVE_START])
             {
                 return TRUE;
@@ -2357,7 +2341,9 @@
             dbgAssert(flightman <= FLIGHTMAN_TYPE_EVASIVE_END);
             sumtotal = prob->sumtotalEvasivePure;
             if (sumtotal == 0) return FALSE;
-            randnum = random(sumtotal);
+
+            randnum = randomG(sumtotal);
+
             if (randnum < prob->flightprobEvasivePure[flightman-FLIGHTMAN_TYPE_EVASIVE_START])
             {
                 return TRUE;
diff -urPw homeworld-orig/src/Game/FlightMan.h homeworld_sdl-0.3/src/Game/FlightMan.h
--- homeworld-orig/src/Game/FlightMan.h	2002-09-04 12:46:10.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/FlightMan.h	2004-08-01 22:35:25.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___FLIGHTMAN_H
 #define ___FLIGHTMAN_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 #include "FlightManDefs.h"
 
 #define FLIGHTMAN_TYPE_TURNAROUND   0
diff -urPw homeworld-orig/src/Game/FontReg.c homeworld_sdl-0.3/src/Game/FontReg.c
--- homeworld-orig/src/Game/FontReg.c	2002-09-04 12:46:10.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/FontReg.c	2004-08-01 22:35:35.000000000 -0700
@@ -7,11 +7,11 @@
 =============================================================================*/
 
 #include <string.h>
-#include "debug.h"
-#include "memory.h"
+#include "Debug.h"
+#include "Memory.h"
 #include "font.h"
-#include "fontreg.h"
-#include "strings.h"
+#include "FontReg.h"
+#include "Strings.h"
 
 /*=============================================================================
     Data:
diff -urPw homeworld-orig/src/Game/FontReg.h homeworld_sdl-0.3/src/Game/FontReg.h
--- homeworld-orig/src/Game/FontReg.h	2002-09-04 12:46:10.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/FontReg.h	2004-08-01 22:35:35.000000000 -0700
@@ -31,12 +31,21 @@
 =============================================================================*/
 //font registry parameters
 #define FR_NumberFonts          32+1          // hack to prevent error on NULL
+#ifdef _WIN32
 #define FR_PrependPath          "fonts\\"
 #define FR_English              "English\\"
 #define FR_German               "German\\"
 #define FR_French               "French\\"
 #define FR_Spanish              "Spanish\\"
 #define FR_Italian              "Italian\\"
+#else
+#define FR_PrependPath          "fonts/"
+#define FR_English              "English/"
+#define FR_German               "German/"
+#define FR_French               "French/"
+#define FR_Spanish              "Spanish/"
+#define FR_Italian              "Italian/"
+#endif
 
 /*=============================================================================
     Type definitions:
diff -urPw homeworld-orig/src/Game/Formation.c homeworld_sdl-0.3/src/Game/Formation.c
--- homeworld-orig/src/Game/Formation.c	2002-09-04 12:46:10.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Formation.c	2004-08-01 22:35:23.000000000 -0700
@@ -10,25 +10,25 @@
 #include <stdlib.h>
 #include <string.h>
 #include <math.h>
-#include "types.h"
-#include "memory.h"
-#include "debug.h"
-#include "fastmath.h"
-#include "spaceobj.h"
-#include "aiship.h"
-#include "aitrack.h"
-#include "shipselect.h"
-#include "formation.h"
-#include "commandlayer.h"
-#include "universe.h"
-#include "univupdate.h"
-#include "statscript.h"
-#include "proximitysensor.h"
+#include "Types.h"
+#include "Memory.h"
+#include "Debug.h"
+#include "FastMath.h"
+#include "SpaceObj.h"
+#include "AIShip.h"
+#include "AITrack.h"
+#include "ShipSelect.h"
+#include "Formation.h"
+#include "CommandLayer.h"
+#include "Universe.h"
+#include "UnivUpdate.h"
+#include "StatScript.h"
+#include "ProximitySensor.h"
 #include "DDDFrigate.h"
-#include "tactics.h"
-#include "strings.h"
-#include "salcapcorvette.h"
-#include "singleplayer.h"
+#include "Tactics.h"
+#include "Strings.h"
+#include "SalCapCorvette.h"
+#include "SinglePlayer.h"
 
 //real32 DELTA_FORMATION_PADDING = 50.0f;
 //real32 BROAD_FORMATION_PADDING = 50.0f;
@@ -441,7 +441,11 @@
             return tableentry;
         }
     }
+    
     dbgFatal(DBG_Loc,"\nSphere formation too big");
+    
+    // never going to get here because of the dbgFatal above; this is here just to keep the compiler happy
+    return tableentry;
 }
 
 /*-----------------------------------------------------------------------------
@@ -1880,7 +1884,6 @@
                 vector desiredpos = { 0.0f, 0.0f, 0.0f };
                 vector averagepos = { 0.0f, 0.0f, 0.0f };
                 vector error = { 0.0f, 0.0f, 0.0f };
-                vector desiredv = { 0.0f, 0.0f, 0.0f };
                 Ship *ship;
                 real32 minError,totalError;
                 sdword minErrorIndex;
@@ -1899,9 +1902,9 @@
                 for(i=0;i<numShips;i++)
                 {
                     vecSub(error,selection->ShipPtr[i]->posinfo.position,averagepos);
-                    error.x = abs(error.x);
-                    error.y = abs(error.y);
-                    error.z = abs(error.z);
+                    error.x = ABS(error.x);
+                    error.y = ABS(error.y);
+                    error.z = ABS(error.z);
                     totalError = error.x+error.y+error.z;
                     if(totalError < minError)
                     {
@@ -2418,7 +2421,6 @@
                 vector desiredpos = { 0.0f, 0.0f, 0.0f };
                 vector averagepos = { 0.0f, 0.0f, 0.0f };
                 vector error = { 0.0f, 0.0f, 0.0f };
-                vector desiredv = { 0.0f, 0.0f, 0.0f };
                 Ship *ship;
                 real32 minError,totalError;
                 sdword minErrorIndex;
@@ -2437,9 +2439,9 @@
                 for(i=0;i<numShips;i++)
                 {
                     vecSub(error,selection->ShipPtr[i]->posinfo.position,averagepos);
-                    error.x = abs(error.x);
-                    error.y = abs(error.y);
-                    error.z = abs(error.z);
+                    error.x = ABS(error.x);
+                    error.y = ABS(error.y);
+                    error.z = ABS(error.z);
                     totalError = error.x+error.y+error.z;
                     if(totalError < minError)
                     {
@@ -2545,7 +2547,7 @@
     bool redo = FALSE;
 
     matrix *coordsys;
-    vector center = {0.0f,0.0f,0.0f};
+    //vector center = {0.0f,0.0f,0.0f};
     sdword shipwhogetsit;
     vector tempvec;
     Ship *ship;
@@ -2639,7 +2641,10 @@
             matMultiplyMatByVec(&positions[i],coordsys,&ship->formationOffset);
             vecAddTo(positions[i],selection->ShipPtr[0]->posinfo.position);
 
-            selection->ShipPtr[i]->formationOffset;
+            // This line doesn't do anything but it was probably intended to do something...
+            // I've left it here in case someone debugging this code needs this as part of the solution!
+            //selection->ShipPtr[i]->formationOffset;
+
             shipWantsPosition[i]=0;
             shipGetsPosition[i]=0;
             positionTaken[i] = FALSE;
diff -urPw homeworld-orig/src/Game/Formation.h homeworld_sdl-0.3/src/Game/Formation.h
--- homeworld-orig/src/Game/Formation.h	2002-09-04 12:46:10.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Formation.h	2004-08-01 22:35:23.000000000 -0700
@@ -2,11 +2,11 @@
 #ifndef ___FORMATION_H
 #define ___FORMATION_H
 
-#include "types.h"
-#include "vector.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Vector.h"
+#include "SpaceObj.h"
 #include "FormationDefs.h"
-#include "shipselect.h"
+#include "ShipSelect.h"
 
 /*=============================================================================
     Defines:
@@ -142,6 +142,8 @@
     MilitarySlot *militarySlots[MAX_MILITARY_SLOTS];
 } MilitaryParadeCommand;
 
+struct CommandLayer;
+
 struct CommandToDo *CreateMilitaryGroupAroundShip(struct CommandLayer *comlayer,ShipPtr ship,ShipPtr aroundShip);
 void processMilitaryParadeToDo(struct CommandToDo *command,bool passiveAttacked);
 void AddShipToMilitaryGroup(ShipPtr ship,struct CommandToDo *militaryGroup);
diff -urPw homeworld-orig/src/Game/GameChat.c homeworld_sdl-0.3/src/Game/GameChat.c
--- homeworld-orig/src/Game/GameChat.c	2002-09-04 12:46:10.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/GameChat.c	2004-08-01 22:35:22.000000000 -0700
@@ -6,27 +6,39 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
+#ifdef _WIN32
 #include <windows.h>
+#endif
 #include <stdio.h>
+#include <stdlib.h>
+#include <strings.h>
 #include "GameChat.h"
 #include "utility.h"
-#include "uicontrols.h"
-#include "region.h"
-#include "fontreg.h"
-#include "universe.h"
-#include "chatting.h"
-#include "linkedlist.h"
-#include "commandnetwork.h"
-#include "strings.h"
+#include "UIControls.h"
+#include "Region.h"
+#include "FontReg.h"
+#include "Universe.h"
+#include "Chatting.h"
+#include "LinkedList.h"
+#include "CommandNetwork.h"
+#include "Strings.h"
 #include "mainrgn.h"
-#include "commandwrap.h"
-#include "soundevent.h"
+#include "CommandWrap.h"
+#include "SoundEvent.h"
+
+#ifdef _MSC_VER
+#define strncasecmp strnicmp
+#endif
 
 /*=============================================================================
     Defines:
 =============================================================================*/
 
+#ifdef _WIN32
 #define GC_FIBFile          "FEMan\\Game_Chat.FIB"
+#else
+#define GC_FIBFile          "FEMan/Game_Chat.FIB"
+#endif
 #define GC_ChatHistoryMax   200
 #define GC_MAXCHARACTERS    256
 
@@ -57,7 +69,7 @@
     0,0,0,0,
     0,0,
     0,
-    0,0
+    {0},{0}  /* TC: I'm guessing? (thinking this might be based off what's commented out) */
 };
 
 fescreen       *gcScreenHandle=NULL;
@@ -128,8 +140,8 @@
 ----------------------------------------------------------------------------*/
 void gcLockGameChat(void)
 {
-    DWORD result = WaitForSingleObject((HANDLE)chatmutex, INFINITE);
-    dbgAssert(result != WAIT_FAILED);
+    int result = SDL_mutexP(chatmutex);
+    dbgAssert(result != -1);
 }
 
 /*-----------------------------------------------------------------------------
@@ -141,8 +153,8 @@
 ----------------------------------------------------------------------------*/
 void gcUnLockGameChat(void)
 {
-    BOOL result = ReleaseMutex((HANDLE)chatmutex);
-    dbgAssert(result);
+    int result = SDL_mutexV(chatmutex);
+    dbgAssert(result != -1);
 }
 
 /*-----------------------------------------------------------------------------
@@ -354,7 +366,7 @@
             for (index=0;index<universe.numPlayers;index++)
             {
                 gcRemoveAmpersands(ampremoved, playerNames[index]);
-                if (strnicmp(ampremoved,toname,i)==0)
+                if (strncasecmp(ampremoved,toname,i)==0)
                 {
                     userindex = index;
 
@@ -884,7 +896,7 @@
     listAddNode(&chathistorylist,&dummy->link,dummy);
     curPosition = &dummy->link;
 
-    chatmutex = (void *)CreateMutex(NULL,FALSE,NULL);
+    chatmutex = SDL_CreateMutex();
 
     if (chatdrawregion!=NULL)
     {
@@ -932,7 +944,7 @@
 ----------------------------------------------------------------------------*/
 void gcShutdown(void)
 {
-    CloseHandle((HANDLE)chatmutex);
+    SDL_DestroyMutex(chatmutex);
     chatmutex = NULL;
 
     curPosition = NULL;
diff -urPw homeworld-orig/src/Game/GameChat.h homeworld_sdl-0.3/src/Game/GameChat.h
--- homeworld-orig/src/Game/GameChat.h	2002-09-04 12:46:10.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/GameChat.h	2004-08-01 22:35:22.000000000 -0700
@@ -8,8 +8,8 @@
 #ifndef ___GAMECHAT_H
 #define ___GAMECHAT_H
 
-#include "types.h"
-#include "multiplayergame.h"
+#include "Types.h"
+#include "MultiplayerGame.h"
 
 #define GC_NORMALMESSAGE        1
 #define GC_WHISPEREDMESSAGE     2
diff -urPw homeworld-orig/src/Game/GamePick.c homeworld_sdl-0.3/src/Game/GamePick.c
--- homeworld-orig/src/Game/GamePick.c	2002-09-04 12:46:10.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/GamePick.c	2004-08-01 22:35:34.000000000 -0700
@@ -6,31 +6,41 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
+#ifdef _WIN32
+#include <windows.h>
+#endif
 #include <stdlib.h>
 #include <string.h>
-#include <io.h>
-#include "types.h"
-#include "debug.h"
-#include "file.h"
-#include "memory.h"
-#include "feflow.h"
+#include <strings.h>
+#include <dirent.h>
+#include <ctype.h>
+#include <limits.h>
+#include "Types.h"
+#include "Debug.h"
+#include "File.h"
+#include "Memory.h"
+#include "FEFlow.h"
 #include "utility.h"
 #include "font.h"
-#include "fontreg.h"
+#include "FontReg.h"
 #include "prim2d.h"
-#include "scroller.h"
+#include "Scroller.h"
 #include "SaveGame.h"
 #include "GamePick.h"
-#include "multiplayergame.h"
-#include "universe.h"
-#include "netcheck.h"
-#include "globals.h"
+#include "MultiplayerGame.h"
+#include "Universe.h"
+#include "NetCheck.h"
+#include "Globals.h"
 #include "FEColour.h"
 #include "StringsOnly.h"
 #include "CommandWrap.h"
-#include "singleplayer.h"
+#include "SinglePlayer.h"
 #include "mainrgn.h"
-#include "soundevent.h"
+#include "SoundEvent.h"
+
+#ifdef _MSC_VER
+#define strcasecmp _stricmp
+#endif
 
 /*=============================================================================
     Data:
@@ -60,12 +70,21 @@
 bool gpLoadSinglePlayerGame = FALSE;
 bool gpLoadTutorial = FALSE;
 
+#ifdef _WIN32
 //SinglePlayerSavedGamesPath is non-static because it is used in KASFunc.c
 char SinglePlayerSavedGamesPath[] = "SavedGames\\SinglePlayer\\";
 static char MultiPlayerSavedGamesPath[] = "SavedGames\\MultiPlayer\\";
 static char RecordedGamesPath[] = "SavedGames\\RecordedGames\\";
 //TutorialSavedGamesPath is non-static because it is used in Tutor.c
 char TutorialSavedGamesPath[] = "SavedGames\\Training\\";
+#else
+//SinglePlayerSavedGamesPath is non-static because it is used in KASFunc.c
+char SinglePlayerSavedGamesPath[] = "SavedGames/SinglePlayer/";
+static char MultiPlayerSavedGamesPath[] = "SavedGames/MultiPlayer/";
+static char RecordedGamesPath[] = "SavedGames/RecordedGames/";
+//TutorialSavedGamesPath is non-static because it is used in Tutor.c
+char TutorialSavedGamesPath[] = "SavedGames/Training/";
+#endif
 static char QuickSaveName[] = "Quick Save";
 
 char *SavedGamesPath = NULL;
@@ -172,12 +191,15 @@
 {
     fonthandle fhSave;
     char gameName[128];
+    char curr_ch;
+    unsigned int i;
 
     rectangle *r = &region->rect;
 
     fhSave = fontMakeCurrent(gpNameFont); //select the appropriate font
-    memStrncpy(gameName, gpGames[gpCurrentSelected].title, 127);
-    _strupr(gameName);
+    for (i = 0; i < 127 && (curr_ch = gpGames[gpCurrentSelected].title[i]); i++)
+        gameName[i] = toupper(curr_ch);
+    gameName[i] = '\0';
     fontPrintf(r->x0, r->y0, GP_SelectedColor, gameName);
     fontMakeCurrent(fhSave);
 }
@@ -196,16 +218,16 @@
     gpgame *game1 = (gpgame *)arg1;
     gpgame *game2 = (gpgame *)arg2;
 
-    if (!_stricmp(game1->title, QuickSaveName))
+    if (!strcasecmp(game1->title, QuickSaveName))
     {
         return -1;
     }
-    else if (!_stricmp(game2->title, QuickSaveName))
+    else if (!strcasecmp(game2->title, QuickSaveName))
     {
         return 1;
     }
 
-    result = _stricmp(game1->title,game2->title);
+    result = strcasecmp(game1->title,game2->title);
     return result;
 }
 
@@ -218,17 +240,23 @@
 ----------------------------------------------------------------------------*/
 sdword gpCountTrainingSavegames(void)
 {
+#ifdef _WIN32
     struct _finddata_t find;
-    char fileSearch[128];
     sdword handle, startHandle;
+#else
+    DIR* dp;
+    struct dirent* dir_entry;
+#endif
+    char fileSearch[128];
     sdword hits;
 
     hits = 0;
 
     strcpy(fileSearch, TutorialSavedGamesPath);
+#ifdef _WIN32
     strcat(fileSearch, "*.*");
 
-    startHandle = handle = _findfirst(filePathPrepend(fileSearch, 0), &find);
+    startHandle = handle = _findfirst(filePathPrepend(fileSearch, FF_UserSettingsPath), &find);
 
     while (handle != -1)
     {
@@ -239,6 +267,20 @@
 
         handle = _findnext(startHandle, &find);
     }
+#else
+    dp = opendir(filePathPrepend(fileSearch, FF_UserSettingsPath));
+    if (!dp)
+        return 0;
+
+    while ((dir_entry = readdir(dp)))
+    {
+        if (dir_entry->d_name[0] == '.')
+            continue;
+        hits++;
+    }
+
+    closedir(dp);
+#endif
 
     return hits;
 }
@@ -253,10 +295,15 @@
 ----------------------------------------------------------------------------*/
 void gpTitleListLoad(void)
 {
+#ifdef _WIN32
     struct _finddata_t find;
     sdword handle, startHandle;
+#else
+    DIR* dp;
+    struct dirent* dir_entry;
+#endif
     sdword index;
-    char fileName[_MAX_PATH];
+    char fileName[PATH_MAX];
     char fileSearch[100];
 //    char *pString;
 //    char *title;
@@ -274,9 +321,10 @@
     }
 
     strcpy(fileSearch,SavedGamesPath);
+#ifdef _WIN32
     strcat(fileSearch,"*.*");
 
-    startHandle = handle = _findfirst(filePathPrepend(fileSearch, 0), &find);
+    startHandle = handle = _findfirst(filePathPrepend(fileSearch, FF_UserSettingsPath), &find);
 
     while (handle != -1)
     {
@@ -300,7 +348,7 @@
 
         for (index = 0; index < gpNumberGames; index++)
         {
-            if (!_stricmp(gpGames[index].fileSpec, fileName))
+            if (!strcasecmp(gpGames[index].fileSpec, fileName))
             {                                               //if matching file specs,
                 goto alreadyLoaded;                         //break-continue
             }
@@ -316,6 +364,47 @@
 alreadyLoaded:;
         handle = _findnext(startHandle, &find);
     }
+#else
+    dp = opendir(filePathPrepend(fileSearch, FF_UserSettingsPath));
+
+    if (dp)
+    {
+        while ((dir_entry = readdir(dp)))
+        {
+            if (dir_entry->d_name[0] == '.')
+                continue;
+            fileName[0] = 0;
+
+            strcpy(fileName, dir_entry->d_name);
+
+            if (fileName[0] == 0)
+                continue;
+
+            if (strstr(fileName,PKTS_EXTENSION))
+                continue;
+
+            for (index = 0; index < gpNumberGames; index++)
+            {
+                if (!strcasecmp(gpGames[index].fileSpec, fileName))
+                {                                               /*if matching file specs,*/
+                    break;                                      /*break-continue*/
+                }
+            }
+            if (index < gpNumberGames)
+                continue;
+
+            gpGames = memRealloc(gpGames, (gpNumberGames+1) * sizeof(gpgame), "gpGames", NonVolatile);
+
+            gpGames[gpNumberGames].fileSpec = memStringDupe(fileName);
+            //gpGames[gpNumberGames].title = title;
+            gpGames[gpNumberGames].title = memStringDupe(fileName);
+
+            gpNumberGames++;
+        }
+
+        closedir(dp);
+    }
+#endif
 
     if (gpNumberGames > 1)
     {
diff -urPw homeworld-orig/src/Game/GamePick.h homeworld_sdl-0.3/src/Game/GamePick.h
--- homeworld-orig/src/Game/GamePick.h	2002-09-04 12:46:10.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/GamePick.h	2004-08-01 22:35:34.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___GAMEPICK_H
 #define ___GAMEPICK_H           3.4444445f
 
-#include "types.h"
-#include "FeFlow.h"
+#include "Types.h"
+#include "FEFlow.h"
 
 /*=============================================================================
     Switches:
diff -urPw homeworld-orig/src/Game/Globals.c homeworld_sdl-0.3/src/Game/Globals.c
--- homeworld-orig/src/Game/Globals.c	2002-09-04 12:46:10.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Globals.c	2004-08-01 22:35:25.000000000 -0700
@@ -6,15 +6,15 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "globals.h"
+#include "Types.h"
+#include "Globals.h"
 #include "mainswitches.h"
-#include "universe.h"
+#include "Universe.h"
 #include "TitanInterfaceC.h"
-#include "aiplayer.h"
+#include "AIPlayer.h"
 #include "CommandNetwork.h"
-#include "netcheck.h"
-#include "multiplayergame.h"
+#include "NetCheck.h"
+#include "MultiplayerGame.h"
 #include "ProfileTimers.h"
 #include "mainrgn.h"
 
diff -urPw homeworld-orig/src/Game/Globals.h homeworld_sdl-0.3/src/Game/Globals.h
--- homeworld-orig/src/Game/Globals.h	2002-09-04 12:46:10.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Globals.h	2004-08-01 22:35:25.000000000 -0700
@@ -9,13 +9,13 @@
 #ifndef ___GLOBALS_H
 #define ___GLOBALS_H
 
-#include "types.h"
-#include "tweak.h"
+#include "Types.h"
+#include "Tweak.h"
 #include "color.h"
-#include "objtypes.h"
+#include "ObjTypes.h"
 #include "TitanInterfaceC.h"
 #include "Queue.h"
-#include "MaxMultiPlayer.h"
+#include "MaxMultiplayer.h"
 
 //define to include a number of checks to see if regions are valid
 #ifndef HW_Release
diff -urPw homeworld-orig/src/Game/Gun.c homeworld_sdl-0.3/src/Game/Gun.c
--- homeworld-orig/src/Game/Gun.c	2002-09-04 12:46:10.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Gun.c	2004-08-01 22:35:19.000000000 -0700
@@ -11,34 +11,34 @@
 #include <math.h>
 #include <stdio.h>
 #include "glinc.h"
-#include "types.h"
-#include "fastmath.h"
-#include "debug.h"
-#include "linkedlist.h"
-#include "memory.h"
-#include "spaceobj.h"
-#include "physics.h"
-#include "vector.h"
-#include "matrix.h"
-#include "universe.h"
-#include "soundevent.h"
-#include "univupdate.h"
+#include "Types.h"
+#include "FastMath.h"
+#include "Debug.h"
+#include "LinkedList.h"
+#include "Memory.h"
+#include "SpaceObj.h"
+#include "Physics.h"
+#include "Vector.h"
+#include "Matrix.h"
+#include "Universe.h"
+#include "SoundEvent.h"
+#include "UnivUpdate.h"
 #include "prim3d.h"
 #include "render.h"
-#include "tweak.h"
-#include "aiship.h"
-#include "gun.h"
-#include "ships.h"
-#include "collision.h"
-#include "tactics.h"
-#include "madlinkindefs.h"
-#include "madlinkin.h"
-#include "randy.h"
-#include "etg.h"
+#include "Tweak.h"
+#include "AIShip.h"
+#include "Gun.h"
+#include "Ships.h"
+#include "Collision.h"
+#include "Tactics.h"
+#include "MadLinkInDefs.h"
+#include "MadLinkIn.h"
+#include "Randy.h"
+#include "ETG.h"
 
 #include "mainrgn.h"
-#include "mex.h"
-#include "nis.h"
+#include "MEX.h"
+#include "NIS.h"
 
 #define ENABLE_SHIPRECOIL       0
 
diff -urPw homeworld-orig/src/Game/Gun.h homeworld_sdl-0.3/src/Game/Gun.h
--- homeworld-orig/src/Game/Gun.h	2002-09-04 12:46:10.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Gun.h	2004-08-01 22:35:20.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___GUN_H
 #define ___GUN_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Defines:
@@ -67,7 +67,7 @@
     Macros:
 =============================================================================*/
 // only valid for GUN_MissileLauncher
-#define gunHasMissiles(gun) ((gun)##->numMissiles > 0)
+#define gunHasMissiles(gun) ((gun)->numMissiles > 0)
 
 /*=============================================================================
     Variables:
diff -urPw homeworld-orig/src/Game/Hash.c homeworld_sdl-0.3/src/Game/Hash.c
--- homeworld-orig/src/Game/Hash.c	2002-09-04 12:46:10.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Hash.c	2004-08-01 22:35:20.000000000 -0700
@@ -6,9 +6,9 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "hash.h"
-#include "memory.h"
-#include "debug.h"
+#include "Hash.h"
+#include "Memory.h"
+#include "Debug.h"
 
 /*-----------------------------------------------------------------------------
     Name        : hashNewTable
diff -urPw homeworld-orig/src/Game/Hash.h homeworld_sdl-0.3/src/Game/Hash.h
--- homeworld-orig/src/Game/Hash.h	2002-09-04 12:46:10.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Hash.h	2004-08-01 22:35:21.000000000 -0700
@@ -8,7 +8,7 @@
 #ifndef _HASH_H
 #define _HASH_H
 
-#include "types.h"
+#include "Types.h"
 
 typedef struct hash_s
 {
diff -urPw homeworld-orig/src/Game/HorseRace.c homeworld_sdl-0.3/src/Game/HorseRace.c
--- homeworld-orig/src/Game/HorseRace.c	2002-09-04 12:46:10.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/HorseRace.c	2004-08-01 22:35:29.000000000 -0700
@@ -6,56 +6,67 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
+#ifdef _WIN32
 #define WIN32_LEAN_AND_MEAN
 #include <windows.h>
+#include <direct.h>
+#include <io.h>
+#else
+#include <unistd.h>
+#include <dirent.h>
+#endif
+
 #include <stdio.h>
 #include <stdlib.h>
 #include <time.h>
-#include <direct.h>
-#include <io.h>
 #include <math.h>
-#include "types.h"
-#include "globals.h"
+#include <limits.h>
+#include "Types.h"
+#include "Globals.h"
 #include "glinc.h"
-#include "types.h"
+#include "Types.h"
 #include "Debug.h"
 #include "prim2d.h"
-#include "universe.h"
+#include "Universe.h"
 #include "render.h"
 #include "CommandNetwork.h"
-#include "horserace.h"
-#include "region.h"
-#include "uicontrols.h"
-#include "feflow.h"
+#include "HorseRace.h"
+#include "Region.h"
+#include "UIControls.h"
+#include "FEFlow.h"
 #include "font.h"
-#include "fontreg.h"
+#include "FontReg.h"
 #include "prim2d.h"
 #include "utility.h"
-#include "task.h"
-#include "demo.h"
+#include "Task.h"
+#include "Demo.h"
 #include "mouse.h"
-#include "linkedlist.h"
-#include "chatting.h"
+#include "LinkedList.h"
+#include "Chatting.h"
 #include "glcaps.h"
-#include "nis.h"
-#include "multiplayergame.h"
-#include "etg.h"
-#include "file.h"
-#include "feReg.h"
+#include "NIS.h"
+#include "MultiplayerGame.h"
+#include "ETG.h"
+#include "File.h"
+#include "FEReg.h"
 #include "interfce.h"
-#include "teams.h"
+#include "Teams.h"
 #include "TimeoutTimer.h"
-#include "strings.h"
-#include "singleplayer.h"
-#include "autodownloadmap.h"
+#include "Strings.h"
+#include "SinglePlayer.h"
+#include "AutoDownloadMap.h"
 #include "glcompat.h"
 #include "texreg.h"
-#include "titan.h"
+#include "Titan.h"
 #include "devstats.h"
 
+#ifdef _WIN32
+#define strcasecmp _stricmp
+#endif
+
 #define ShouldHaveMousePtr (FALSE)
 
-extern LONGLONG utyTimerLast;
+extern Uint32 utyTimerLast;
 extern udword gDevcaps2;
 
 /*=============================================================================
@@ -73,7 +84,7 @@
     data:
 =============================================================================*/
 
-extern HDC hGLDeviceContext;
+/*extern HDC hGLDeviceContext;*/
 
 static rectangle hrSinglePlayerPos;
 static color hrSinglePlayerColor;
@@ -82,8 +93,8 @@
 static sdword localbar;
 
 // Pixels and info about the background image chosen
-static BOOL hrBackgroundInitFrame = 0;
-static DWORD *hrBackgroundImage = NULL;
+static bool hrBackgroundInitFrame = 0;
+static udword *hrBackgroundImage = NULL;
 static long hrBackgroundDirty = 0;
 bool hrBackgroundReinit = FALSE;
 static long hrBackXSize, hrBackYSize;
@@ -374,11 +385,19 @@
 #if defined(OEM)
     if (singlePlayerGameInfo.currentMission == 5)
     {
+#ifdef _WIN32
         sprintf(fname, "SinglePlayer\\mission05_OEM\\loading.jpg");
+#else
+        sprintf(fname, "SinglePlayer/mission05_OEM/loading.jpg");
+#endif
     }
     else
 #endif
+#ifdef _WIN32
     sprintf(fname, "SinglePlayer\\mission%02d\\loading.jpg", singlePlayerGameInfo.currentMission);
+#else
+    sprintf(fname, "SinglePlayer/mission%02d/loading.jpg", singlePlayerGameInfo.currentMission);
+#endif
     if (!fileExists(fname, 0))
     {
         pFilenameBuffer[0] = '\0';
@@ -399,7 +418,11 @@
     hrSinglePlayerPos.x1 = x + width;
     hrSinglePlayerPos.y1 = y + height;
 
+#ifdef _WIN32
     sprintf(fname, "SinglePlayer\\mission%02d\\loading.script", singlePlayerGameInfo.currentMission);
+#else
+    sprintf(fname, "SinglePlayer/mission%02d/loading.script", singlePlayerGameInfo.currentMission);
+#endif
     if (!fileExists(fname, 0))
     {
         hrSinglePlayerColor = colRGB(255,63,63);
@@ -415,17 +438,29 @@
 
 void hrChooseRandomBitmap(char *pFilenameBuffer)
 {
-filehandle handle;
-long    hFind, FileCount, BigFileCount, WhichFile, Result;
+#ifdef _WIN32
 struct _finddata_t  FindData;
-char BigName[512], CurDir[512], NewDir[512];
+    long hFind;
+#else
+    DIR *dp;
+    struct dirent* dir_entry;
+    FILE* fp;
+#endif
+    filehandle handle;
+    long FileCount, BigFileCount, WhichFile, Result;
+    char BigName[PATH_MAX], CurDir[PATH_MAX], NewDir[PATH_MAX];
 
     FileCount = BigFileCount = 0;
 
-    GetCurrentDirectory(511, CurDir);
+    /*GetCurrentDirectory(511, CurDir);*/
+    getcwd(CurDir, PATH_MAX);
 
     // First, find screen shots listed in the BigFile
+#ifdef _WIN32
     handle = fileOpen("ScreenShots\\ShotList.script", FF_ReturnNULLOnFail | FF_TextMode);
+#else
+    handle = fileOpen("ScreenShots/ShotList.script", FF_ReturnNULLOnFail | FF_TextMode);
+#endif
     if(handle)
     {
         do {
@@ -443,11 +478,13 @@
     FileCount = BigFileCount;
 
     NewDir[0] = 0;
-    strcpy(NewDir, filePathPrepend("ScreenShots", 0));
+    strcpy(NewDir, filePathPrepend("ScreenShots", FF_UserSettingsPath));
 
 
     // Switch to the screenshots directory and count the ones in there
-    SetCurrentDirectory(NewDir);
+    /*SetCurrentDirectory(NewDir);*/
+    chdir(NewDir);
+#ifdef _WIN32
     hFind = _findfirst("*.jpg", &FindData);
     if(hFind != -1)
     {
@@ -458,12 +495,41 @@
         } while (_findnext(hFind, &FindData) == 0);
         _findclose(hFind);
     }
+#else
+    dp = opendir(".");
+
+    if (dp)
+    {
+        unsigned int dir_str_len;
+
+        while ((dir_entry = readdir(dp)))
+        {
+            if (dir_entry->d_name[0] == '.')
+                continue;
+            dir_str_len = strlen(dir_entry->d_name);
+            if (dir_str_len < 4 ||
+                strcasecmp(dir_entry->d_name + dir_str_len - 4, ".jpg"))
+                continue;
+
+            /* See if the current process can actually open the file (simple
+               check for read permissions and if it's a directory). */
+            if (!(fp = fopen(dir_entry->d_name, "rb")))
+                continue;
+            fclose(fp);
+
+            FileCount++;
+        }
+
+        closedir(dp);
+    }
+#endif
 
     // Did we find any at all?
     if(FileCount == 0)
     {
         pFilenameBuffer[0] = 0;
-        SetCurrentDirectory(CurDir);
+        /*SetCurrentDirectory(CurDir);*/
+        chdir(CurDir);
         return;
     }
 
@@ -472,7 +538,11 @@
     if(WhichFile < BigFileCount)
     {
         // The file we want is in the bigfile script
+#ifdef _WIN32
         handle = fileOpen("ScreenShots\\ShotList.script", FF_ReturnNULLOnFail | FF_TextMode);
+#else
+        handle = fileOpen("ScreenShots/ShotList.script", FF_ReturnNULLOnFail | FF_TextMode);
+#endif
         if(handle)
         {
             do {
@@ -482,9 +552,14 @@
                     WhichFile--;
 
             } while( (WhichFile >= 0) && (Result != FR_EndOfFile));
+#ifdef _WIN32
             strcpy(pFilenameBuffer, "ScreenShots\\");
+#else
+            strcpy(pFilenameBuffer, "ScreenShots/");
+#endif
             strcat(pFilenameBuffer, BigName);
-            SetCurrentDirectory(CurDir);
+            /*SetCurrentDirectory(CurDir);*/
+            chdir(CurDir);
             return;
         }
     }
@@ -494,6 +569,7 @@
         // remove BigFileCount from the file index we're looking for
         WhichFile -= BigFileCount;
         FileCount = 0;
+#ifdef _WIN32
         hFind = _findfirst("*.jpg", &FindData);
         if(hFind != -1)
         {
@@ -514,8 +590,42 @@
                 }
             } while (_findnext(hFind, &FindData) == 0);
         }
+#else
+        dp = opendir(".");
+
+        if (dp)
+        {
+            unsigned int dir_str_len;
+
+            while ((dir_entry = readdir(dp)))
+            {
+                if (dir_entry->d_name[0] == '.')
+                    continue;
+                dir_str_len = strlen(dir_entry->d_name);
+                if (dir_str_len < 4 ||
+                    strcasecmp(dir_entry->d_name + dir_str_len - 4, ".jpg"))
+                    continue;
+                if (!(fp = fopen(dir_entry->d_name, "rb")))
+                    continue;
+                fclose(fp);
+
+                if (FileCount != WhichFile)
+                {
+                    FileCount++;
+                    continue;
     }
-    SetCurrentDirectory(CurDir);
+
+                strcpy(pFilenameBuffer, "ScreenShots/");
+                strcat(pFilenameBuffer, dir_entry->d_name);
+                break;
+            }
+
+            closedir(dp);
+        }
+#endif
+    }
+    /*SetCurrentDirectory(CurDir);*/
+    chdir(CurDir);
 }
 
 typedef struct
@@ -672,7 +782,7 @@
         //bit in devcaps2
         return FALSE;
     }
-    else if (_stricmp(GLC_VENDOR, "ati") == 0 &&
+    else if (strcasecmp(GLC_VENDOR, "ati") == 0 &&
              strstr(GLC_RENDERER, "128") != NULL)
     {
         //ATI Rage 128
@@ -693,7 +803,7 @@
 
 void hrInitBackground(void)
 {
-char hrImageName[512];
+char hrImageName[PATH_MAX];
 filehandle handle;
 long XSize, YSize, i;
 unsigned long *pDest;
@@ -704,9 +814,10 @@
 long DestX, DestY;
 long DestXSize, DestYSize, Size, Top, Bot;
 JPEGDATA    jp;
-char CurDir[512], NewDir[512];
+char CurDir[PATH_MAX], NewDir[PATH_MAX];
 
-    GetCurrentDirectory(511, CurDir);
+    /*GetCurrentDirectory(511, CurDir);*/
+    getcwd(CurDir, PATH_MAX);
 
     hrImageName[0] = 0;
     if (singlePlayerGame)
@@ -719,9 +830,10 @@
             hrChooseRandomBitmap( hrImageName );
     }
 
-    GetCurrentDirectory(511, NewDir);
+    /*GetCurrentDirectory(511, NewDir);*/
+    getcwd(NewDir, PATH_MAX);
 
-    dbgAssert(stricmp(CurDir,NewDir) == 0);
+    dbgAssert(strcasecmp(CurDir,NewDir) == 0);
 
     // Load the bitmap image
     handle = fileOpen(hrImageName, FF_ReturnNULLOnFail);
@@ -766,7 +878,7 @@
             //fixed width for singleplayer game images
             DestXSize = 640;
             DestYSize = 480;
-            hrBackgroundImage = (unsigned long*)malloc(DestXSize * DestYSize * 4);
+            hrBackgroundImage = (udword*)malloc(DestXSize * DestYSize * 4);
         }
         else
         {
@@ -775,7 +887,7 @@
                 //no DrawPixels support, must use glcompat 640x480 quilting
                 DestXSize = 640;
                 DestYSize = 480;
-                hrBackgroundImage = (unsigned long*)malloc(DestXSize * DestYSize * 4);
+                hrBackgroundImage = (udword*)malloc(DestXSize * DestYSize * 4);
             }
             else
             {
@@ -785,7 +897,7 @@
                     DestXSize = (long)((float)MAIN_WindowWidth * Scale);
                     DestYSize = (long)((float)MAIN_WindowHeight * Scale);
 
-                    hrBackgroundImage = (unsigned long *)malloc(DestXSize * DestYSize * 4);
+                    hrBackgroundImage = (udword *)malloc(DestXSize * DestYSize * 4);
                 } while((hrBackgroundImage == NULL) && (Scale > 0.4f));
             }
         }
@@ -801,7 +913,7 @@
         IncX = (float)XSize / (float)DestXSize;
         IncY = (float)YSize / (float)DestYSize;
 
-        pDest = hrBackgroundImage;
+        pDest = (unsigned long*)hrBackgroundImage;
         if((IncX < 1.0f) && (IncY < 1.0f) && (pDest != NULL))
         {
             SrcY = 0.0f;
@@ -810,7 +922,11 @@
                 SrcX = 0.0f;
                 for(DestX = 0; DestX < DestXSize; DestX++)
                 {
+#ifdef ENDIAN_BIG
+                    pDest[DestX] = LittleLong( hrGetInterpPixel(pTempImage, XSize, SrcX, SrcY) );
+#else
                     pDest[DestX] = hrGetInterpPixel(pTempImage, XSize, SrcX, SrcY);
+#endif
                     SrcX += IncX;
                 }
                 pDest += DestXSize;
@@ -826,7 +942,12 @@
                 for(DestX = 0; DestX < DestXSize; DestX++)
                 {
                     pRGB = &pTempImage[ (((unsigned long)SrcY * XSize) + (unsigned long)SrcX) * 3 ];
+
+#ifdef ENDIAN_BIG
+                    pDest[DestX] = LittleLong( 0xff000000 + ((unsigned long)pRGB[0]) + ((unsigned long)pRGB[1] << 8) + ((unsigned long)pRGB[2] << 16) );
+#else
                     pDest[DestX] = 0xff000000 + ((unsigned long)pRGB[0]) + ((unsigned long)pRGB[1] << 8) + ((unsigned long)pRGB[2] << 16);
+#endif
 
                     SrcX += IncX;
                 }
@@ -937,8 +1058,13 @@
 
         if (singlePlayerGame && (hrBackgroundInitFrame & 1))
         {
+#ifdef _WIN32
             hrDrawFile("feman\\loadscreen\\ring.lif", 115, 342);
             hrDrawFile("feman\\loadscreen\\arrows.lif", 195, 134);
+#else
+            hrDrawFile("feman/loadscreen/ring.lif", 115, 342);
+            hrDrawFile("feman/loadscreen/arrows.lif", 195, 134);
+#endif
         }
     }
 }
@@ -1263,10 +1389,19 @@
 
 void horseRaceRender()
 {
-    MSG message;
+    SDL_Event e;
 
+#if defined (_MSC_VER)
     _asm xor eax,eax
     _asm mov regRenderEventIndex, eax
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ (
+        "xorl %%eax, %%eax\n\t"
+        "movl %%eax, %0\n\t"
+        : "=m" (regRenderEventIndex) );
+#else
+    regRenderEventIndex = 0;
+#endif
 
     //special-case code for double-clicks
 
@@ -1332,9 +1467,9 @@
     if (TitanActive)
         titanPumpEngine();
 
-    Sleep(0);
+    SDL_Delay(0);
 
-    if (!PeekMessage(&message, NULL, 0, 0, PM_NOREMOVE)!=0)
+    if (!SDL_PollEvent(0))
     {
         regProcessingRegions = TRUE;
         regRegionProcess(horseCrapRegion.child, 0xffffffff);
@@ -1348,12 +1483,11 @@
     else
     {
         regRegionProcess(horseCrapRegion.child, 0xffffffff);
-        while (PeekMessage(&message, NULL, 0, 0, PM_NOREMOVE)!=0)
+        while (SDL_PollEvent(0))
         {
-            if(GetMessage(&message, NULL, 0, 0))
+            if (SDL_WaitEvent(&e))
             {
-                TranslateMessage(&message);
-                DispatchMessage(&message);
+                HandleEvent(&e);
 
                 if (multiPlayerGame)
                 {
@@ -1395,7 +1529,7 @@
             if (TitanActive)
                 titanPumpEngine();
 
-            Sleep(0);
+            SDL_Delay(0);
         }
     }
 
@@ -1512,13 +1646,13 @@
 
 bool HorseRaceNext(real32 percent)
 {
+    Uint32 lp;
     HorsePacket packet;
     real32 temptime;
     udword i;
     sdword dontrenderhack = FALSE;
     bool sendhrpackethack = FALSE;
 //    static real32 lastper = 0.0f;
-    SYSTEMTIME lp;
     static sdword modulusCounter = 0;
 
     if (percent > 1.0f) percent = 1.0f;
@@ -1553,8 +1687,8 @@
         SendHorseRacePacket((ubyte *)&packet,sizeof(HorsePacket));      // always send horse race packet when autouploading map
     }
 
-    GetSystemTime(&lp);
-    temptime = (lp.wMilliseconds+lp.wSecond*1000.0f);
+    lp = SDL_GetTicks();
+    temptime = (float)lp;
     if(temptime - lasttime < horseRaceRenderTime)
     {
         if(lasttime > temptime)
diff -urPw homeworld-orig/src/Game/HorseRace.h homeworld_sdl-0.3/src/Game/HorseRace.h
--- homeworld-orig/src/Game/HorseRace.h	2002-09-04 12:46:10.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/HorseRace.h	2004-08-01 22:35:29.000000000 -0700
@@ -8,14 +8,18 @@
 #ifndef HORSERACE_H
 #define HORSERACE_H
 
-#include "types.h"
-#include "globals.h"
+#include "Types.h"
+#include "Globals.h"
 
 /*=============================================================================
     defines:
 =============================================================================*/
 
+#ifdef _WIN32
 #define HR_FIBFile          "FEMAN\\Horse_Race.fib"
+#else
+#define HR_FIBFile          "FEMAN/Horse_Race.fib"
+#endif
 #define HR_RaceScreen       "Horse_Race"
 #define HR_RaceScreenNotNetwork "Horse_Race_NonNetwork"
 #define HR_SingleRaceScreen "Horse_Race_Single"
@@ -61,6 +65,7 @@
 /*=============================================================================
     Prototypes:
 =============================================================================*/
+struct ChatPacket;
 
 void horseRaceInit(void);
 void horseRaceShutdown(void);
diff -urPw homeworld-orig/src/Game/HS.c homeworld_sdl-0.3/src/Game/HS.c
--- homeworld-orig/src/Game/HS.c	2002-09-04 12:46:10.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/HS.c	2004-08-01 22:35:23.000000000 -0700
@@ -7,22 +7,23 @@
 =============================================================================*/
 
 #include <math.h>
+#include <ctype.h>
 #include "glinc.h"
 #include "prim3d.h"
 #include "render.h"
-#include "particle.h"
-#include "hs.h"
-#include "debug.h"
-#include "memory.h"
-#include "fereg.h"
-#include "singleplayer.h"
-#include "univupdate.h"
+#include "Particle.h"
+#include "HS.h"
+#include "Debug.h"
+#include "Memory.h"
+#include "FEReg.h"
+#include "SinglePlayer.h"
+#include "UnivUpdate.h"
 #include "glcaps.h"
 #include "SaveGame.h"
-#include "matrix.h"
-#include "aivar.h"
-#include "gravwellgenerator.h"
-#include "damage.h"
+#include "Matrix.h"
+#include "AIVar.h"
+#include "GravWellGenerator.h"
+#include "Damage.h"
 
 //scalar that determines distance out of bbox the window will travel from / to
 #define HS_DIST   1.08f
diff -urPw homeworld-orig/src/Game/HS.h homeworld_sdl-0.3/src/Game/HS.h
--- homeworld-orig/src/Game/HS.h	2002-09-04 12:46:12.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/HS.h	2004-08-01 22:35:24.000000000 -0700
@@ -9,7 +9,7 @@
 #ifndef _HS_H
 #define _HS_H
 
-#include "spaceobj.h"
+#include "SpaceObj.h"
 
 void hsStart(Ship* ship, real32 cliptDelta, bool into, bool displayEffect);
 void hsContinue(Ship* ship, bool displayEffect);
diff -urPw homeworld-orig/src/Game/InfoOverlay.c homeworld_sdl-0.3/src/Game/InfoOverlay.c
--- homeworld-orig/src/Game/InfoOverlay.c	2002-09-04 12:46:12.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/InfoOverlay.c	2004-08-01 22:35:35.000000000 -0700
@@ -6,16 +6,16 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "infooverlay.h"
-#include "key.h"
-#include "fontreg.h"
+#include "InfoOverlay.h"
+#include "Key.h"
+#include "FontReg.h"
 #include "utility.h"
-#include "select.h"
-#include "region.h"
-#include "task.h"
-#include "statscript.h"
-#include "strings.h"
-#include "tutor.h"
+#include "Select.h"
+#include "Region.h"
+#include "Task.h"
+#include "StatScript.h"
+#include "Strings.h"
+#include "Tutor.h"
 
 #include <stdio.h>
 
diff -urPw homeworld-orig/src/Game/InfoOverlay.h homeworld_sdl-0.3/src/Game/InfoOverlay.h
--- homeworld-orig/src/Game/InfoOverlay.h	2002-09-04 12:46:12.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/InfoOverlay.h	2004-08-01 22:35:35.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___INFOOVERLAY_H
 #define ___INFOOVERLAY_H
 
-#include "spaceobj.h"
-#include "region.h"
+#include "SpaceObj.h"
+#include "Region.h"
 
 /*=============================================================================
     Defines:
diff -urPw homeworld-orig/src/Game/KAS.c homeworld_sdl-0.3/src/Game/KAS.c
--- homeworld-orig/src/Game/KAS.c	2002-09-04 12:46:12.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/KAS.c	2004-08-01 22:35:35.000000000 -0700
@@ -6,27 +6,33 @@
 
 #include <stdio.h>
 #include <string.h>
+#include <strings.h>
 #include "glinc.h"
 #include "mainrgn.h"
-#include "shipselect.h"
+#include "ShipSelect.h"
 #include "AITeam.h"
 #include "AIPlayer.h"
 #include "AIUtilities.h"
 #include "AIVar.h"
 #include "Timer.h"
-#include "vector.h"
-#include "kas.h"
-#include "file.h"
-#include "volume.h"
+#include "Vector.h"
+#include "KAS.h"
+#include "File.h"
+#include "Volume.h"
 #include "font.h"
 #include "render.h"
 #include "prim3d.h"
 #include "Objectives.h"
 #include "SinglePlayer.h"
 #include "SaveGame.h"
-#include "hs.h"
+#include "HS.h"
 #include "CommandWrap.h"
 
+#ifdef _WIN32
+#define strcasecmp  _stricmp
+#define strncasecmp _strnicmp
+#endif
+
 extern sdword objectivesUsed;
 #if SP_DEBUGKEYS
 //#if SP_DEBUGLEVEL2
@@ -248,13 +254,13 @@
     while (i < aiCurrentAIPlayer->teamsUsed)
     {
         aiteamp = aiCurrentAIPlayer->teams[i];
-        if (aiteamp->teamType == ScriptTeam && !strnicmp(aiteamp->kasLabel, label, KAS_TEAM_NAME_MAX_LENGTH))
+        if (aiteamp->teamType == ScriptTeam && !strncasecmp(aiteamp->kasLabel, label, KAS_TEAM_NAME_MAX_LENGTH))
             return aiteamp;
         ++i;
     }
 
     // special reference to sender of last message received
-    if (!stricmp(label, "MsgSender"))
+    if (!strcasecmp(label, "MsgSender"))
         return CurrentTeamP->msgSender;
 #ifndef HW_Release
     dbgFatalf(DBG_Loc,"\nKAS: unresolved reference to team %s", label);
@@ -273,12 +279,12 @@
     while (i < aiCurrentAIPlayer->teamsUsed)
     {
         aiteamp = aiCurrentAIPlayer->teams[i];
-        if (aiteamp->teamType == ScriptTeam && !strnicmp(aiteamp->kasLabel, label, KAS_TEAM_NAME_MAX_LENGTH))
+        if (aiteamp->teamType == ScriptTeam && !strncasecmp(aiteamp->kasLabel, label, KAS_TEAM_NAME_MAX_LENGTH))
             return &aiteamp->shipList;
         ++i;
     }
     // special reference to sender of last message received
-    if (!stricmp(label, "MsgSender"))
+    if (!strcasecmp(label, "MsgSender"))
         if (CurrentTeamP->msgSender)
             return &CurrentTeamP->msgSender->shipList;
 #ifndef HW_Release
@@ -295,7 +301,6 @@
     static hvector errorPos= {0, 0, 0, 1};  // safe fallback
     static hvector location;
     vector loc;
-    sdword i = 0;
     GrowSelection *grow;
     real32 dummy;
 
@@ -408,7 +413,7 @@
     sdword i = 0;
     while (i < LabelledPathsUsed)
     {
-        if (!strnicmp(LabelledPaths[i]->label, label, KAS_MAX_LABEL_LENGTH))
+        if (!strncasecmp(LabelledPaths[i]->label, label, KAS_MAX_LABEL_LENGTH))
             return LabelledPaths[i]->path;
         ++i;
     }
@@ -423,7 +428,7 @@
     sdword i = 0;
     while (i < LabelledPathsUsed)
     {
-        if (!strnicmp(LabelledPaths[i]->label, label, KAS_MAX_LABEL_LENGTH))
+        if (!strncasecmp(LabelledPaths[i]->label, label, KAS_MAX_LABEL_LENGTH))
             return LabelledPaths[i]->path;
         ++i;
     }
@@ -440,7 +445,7 @@
     sdword i = 0;
     while (i < LabelledVolumesUsed)
     {
-        if (!strnicmp(LabelledVolumes[i]->label, label, KAS_MAX_LABEL_LENGTH))
+        if (!strncasecmp(LabelledVolumes[i]->label, label, KAS_MAX_LABEL_LENGTH))
             return LabelledVolumes[i]->volume;
         ++i;
     }
@@ -458,7 +463,7 @@
     sdword i = 0;
     while (i < LabelledVectorsUsed)
     {
-        if (!strnicmp(LabelledVectors[i]->label, label, KAS_MAX_LABEL_LENGTH))
+        if (!strncasecmp(LabelledVectors[i]->label, label, KAS_MAX_LABEL_LENGTH))
             return LabelledVectors[i]->hvector;
         ++i;
     }
@@ -483,7 +488,7 @@
 
     while (i < SelectionsUsed)
     {
-        if (!strnicmp(Selections[i]->label, label, KAS_MAX_LABEL_LENGTH))
+        if (!strncasecmp(Selections[i]->label, label, KAS_MAX_LABEL_LENGTH))
             return &(Selections[i]->shipList);
         ++i;
     }
@@ -501,7 +506,7 @@
 
     while (i < SelectionsUsed)
     {
-        if (!strnicmp(Selections[i]->label, label, KAS_MAX_LABEL_LENGTH))
+        if (!strncasecmp(Selections[i]->label, label, KAS_MAX_LABEL_LENGTH))
             return &(Selections[i]->shipList);
         ++i;
     }
@@ -708,7 +713,7 @@
     for (i = 0; i < aiCurrentAIPlayer->teamsUsed; i++)
     {
         teamp = aiCurrentAIPlayer->teams[i];
-        if (teamp->teamType == ScriptTeam && !strnicmp(teamp->kasLabel, label, KAS_TEAM_NAME_MAX_LENGTH))
+        if (teamp->teamType == ScriptTeam && !strncasecmp(teamp->kasLabel, label, KAS_TEAM_NAME_MAX_LENGTH))
             break;
     }
     if (i >= aiCurrentAIPlayer->teamsUsed)
@@ -784,9 +789,14 @@
     udword i, remaining;
     Timer *tp;
 
-    fullName = filePathPrepend(fileName, 0);
+    fullName = filePathPrepend(fileName, FF_UserSettingsPath);
+
+    if (!fileMakeDestinationDirectory(fullName))
+        return;
 
     fp = fopen(fullName, "wt");
+    if (!fp)
+        return;
 
     fprintf(fp, "%s\n\n", CurrentMissionName);
 
@@ -1365,8 +1375,23 @@
     }
     else
     {
+        udword i;
+        const void** func_list;
+        udword func_list_size;
+
+        func_list =
+            IndexToFunctionList(singlePlayerGameInfo.currentMission - 1);
+        func_list_size = (func_list
+            ? FunctionListSize(singlePlayerGameInfo.currentMission - 1)
+            : 0);
 
-        return ((ubyte *)func) - ((ubyte *)IndexToWatchFunction(singlePlayerGameInfo.currentMission-1));
+        for (i = 0; i < func_list_size; i++)
+        {
+            if (func_list[i] == (void*)func)
+                return (sdword)i;
+        }
+
+        return -1;
     }
 }
 
@@ -1378,7 +1403,18 @@
     }
     else
     {
-        return (void *)( ((ubyte *)IndexToWatchFunction(singlePlayerGameInfo.currentMission-1)) + offset);
+        const void** func_list;
+        udword func_list_size;
+
+        func_list =
+            IndexToFunctionList(singlePlayerGameInfo.currentMission - 1);
+        func_list_size = (func_list
+            ? FunctionListSize(singlePlayerGameInfo.currentMission - 1)
+            : 0);
+
+        return ((udword)offset < func_list_size
+            ? func_list[offset]
+            : NULL);
     }
 }
 
diff -urPw homeworld-orig/src/Game/KASFunc.c homeworld_sdl-0.3/src/Game/KASFunc.c
--- homeworld-orig/src/Game/KASFunc.c	2002-09-04 12:46:12.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/KASFunc.c	2004-08-01 22:35:28.000000000 -0700
@@ -4,52 +4,58 @@
 
 #include <stdio.h>
 #include <string.h>
+#include <strings.h>
 #include <stdlib.h>
-#include "shipselect.h"
+#include <ctype.h>
+#include "ShipSelect.h"
 #include "AITeam.h"
 #include "KASFunc.h"
 #include "AIPlayer.h"
 #include "AIUtilities.h"
-#include "vector.h"
-#include "kas.h"
+#include "Vector.h"
+#include "KAS.h"
 #include "Volume.h"
 #include "Timer.h"
 #include "CommandWrap.h"
 #include "AIVar.h"
 #include "AIMoves.h"
 #include "FormationDefs.h"
-#include "randy.h"
+#include "Randy.h"
 #include "SinglePlayer.h"
 #include "font.h"
 #include "render.h"
 #include "prim2d.h"
-#include "ping.h"
+#include "Ping.h"
 #include "Objectives.h"
-#include "univupdate.h"
-#include "tutor.h"
-#include "soundevent.h"
-#include "soundeventdefs.h"
-#include "speechevent.h"
+#include "UnivUpdate.h"
+#include "Tutor.h"
+#include "SoundEvent.h"
+#include "SoundEventDefs.h"
+#include "SpeechEvent.h"
 #include "SalCapCorvette.h"
-#include "hs.h"
+#include "HS.h"
 #include "SaveGame.h"
-#include "collision.h"
+#include "Collision.h"
 #include "mainrgn.h"
-#include "nis.h"
+#include "NIS.h"
 #include "texreg.h"
-#include "sensors.h"
-#include "subtitle.h"
-#include "btg.h"
-#include "aitrack.h"
+#include "Sensors.h"
+#include "Subtitle.h"
+#include "BTG.h"
+#include "AITrack.h"
 #include "utility.h"
-#include "fastmath.h"
-#include "animatic.h"
+#include "FastMath.h"
+#include "Animatic.h"
 #include "TradeMgr.h"
 #include "StringsOnly.h"
-#include "taskbar.h"
+#include "TaskBar.h"
 #include "DDDFrigate.h"
-#include "consmgr.h"
-#include "universe.h"
+#include "ConsMgr.h"
+#include "Universe.h"
+
+#ifdef _WIN32
+#define strncasecmp _strnicmp
+#endif
 
 extern char SinglePlayerSavedGamesPath[];
 extern sdword CurrentMissionSkillLevel;
@@ -3039,8 +3045,6 @@
 
 void kasfSpecialToggle(void)
 {
-    real32 maxHealth = 0.0, actualHealth = 0.0;
-
     if (!CurrentTeamP || !CurrentTeamP->shipList.selection->numShips)
         return;
     clWrapSpecial(&universe.mainCommandLayer, CurrentTeamP->shipList.selection, NULL);
@@ -3717,7 +3721,9 @@
 void kasfSpeechEvent(sdword event, sdword variable)
 {
     subMessageEnded = 0;
+#ifndef _MACOSX_FIX_ME
     speechEventFleet(event, variable, universe.curPlayerIndex);
+#endif
 }
 
 void kasfSpeechEventShips(GrowSelection *ships, sdword event, sdword variable)
@@ -3839,7 +3845,7 @@
 
     for (i = 0; i < LabelledVectorsUsed; ++i)
     {
-        if (!strnicmp(LabelledVectors[i]->label, "GATE", 4))
+        if (!strncasecmp(LabelledVectors[i]->label, "GATE", 4))
         {
             vecGrabVecFromHVec(loc, *(LabelledVectors[i]->hvector));
             temp = aiuFindDistanceSquared(shippos,loc);
@@ -3919,7 +3925,7 @@
 
     for (i = 0; i < LabelledVectorsUsed; ++i)
     {
-        if (!strnicmp(LabelledVectors[i]->label, "GATE", 4))
+        if (!strncasecmp(LabelledVectors[i]->label, "GATE", 4))
         {
             vecGrabVecFromHVec(loc, *(LabelledVectors[i]->hvector));
             temp = aiuFindDistanceSquared(
@@ -4058,7 +4064,7 @@
     char buffer[SUB_SubtitleLength];
 
     dbgAssert(milliseconds > 10);
-    _snprintf(buffer, SUB_SubtitleLength - 1, "#r%x#t%x%s", STR_LocationCard, STT_LocationCard, location);
+    snprintf(buffer, SUB_SubtitleLength - 1, "#r%x#t%x%s", STR_LocationCard, STT_LocationCard, location);
     subTitleAdd(STA_LocationCard, kasfDummyEventNumber, buffer, strlen(buffer), (real32)milliseconds / 1000.0f);
     kasfDummyEventNumber++;
 }
diff -urPw homeworld-orig/src/Game/KASFunc.h homeworld_sdl-0.3/src/Game/KASFunc.h
--- homeworld-orig/src/Game/KASFunc.h	2002-09-04 12:46:12.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/KASFunc.h	2004-08-01 22:35:28.000000000 -0700
@@ -1,7 +1,7 @@
 #ifndef __KASFUNC_H
 #define __KASFUNC_H
 
-#include "types.h"
+#include "Types.h"
 #include "AIUtilities.h"
 #include "Volume.h"
 
diff -urPw homeworld-orig/src/Game/KAS.h homeworld_sdl-0.3/src/Game/KAS.h
--- homeworld-orig/src/Game/KAS.h	2002-09-04 12:46:12.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/KAS.h	2004-08-01 22:35:36.000000000 -0700
@@ -2,10 +2,10 @@
 #define __KAS_H
 
 #include "AIUtilities.h"
-#include "shipselect.h"
-#include "vector.h"
-#include "volume.h"
-#include "kasfunc.h"
+#include "ShipSelect.h"
+#include "Vector.h"
+#include "Volume.h"
+#include "KASFunc.h"
 
 // run-time scoping for variables, timers, etc.
 enum {
diff -urPw homeworld-orig/src/Game/KeyBindings.c homeworld_sdl-0.3/src/Game/KeyBindings.c
--- homeworld-orig/src/Game/KeyBindings.c	2002-09-04 12:46:12.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/KeyBindings.c	2004-08-01 22:35:35.000000000 -0700
@@ -6,13 +6,13 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
+#include "Types.h"
 #include "KeyBindings.h"
-#include "uicontrols.h"
-#include "key.h"
-#include "fontreg.h"
+#include "UIControls.h"
+#include "Key.h"
+#include "FontReg.h"
 #include "FEColour.h"
-#include "strings.h"
+#include "Strings.h"
 
 /*=============================================================================
     Defines :
diff -urPw homeworld-orig/src/Game/KeyBindings.h homeworld_sdl-0.3/src/Game/KeyBindings.h
--- homeworld-orig/src/Game/KeyBindings.h	2002-09-04 12:46:12.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/KeyBindings.h	2004-08-01 22:35:35.000000000 -0700
@@ -10,10 +10,10 @@
 #ifndef ___KEYBINDINGS_H
 #define ___KEYBINDINGS_H
 
-#include "feflow.h"
+#include "FEFlow.h"
 #include "font.h"
-#include "key.h"
-#include "strings.h"
+#include "Key.h"
+#include "Strings.h"
 
 /*=============================================================================
     Defines :
diff -urPw homeworld-orig/src/Game/Key.c homeworld_sdl-0.3/src/Game/Key.c
--- homeworld-orig/src/Game/Key.c	2002-09-04 12:46:12.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Key.c	2004-08-01 22:35:28.000000000 -0700
@@ -1,13 +1,13 @@
 
 #include <stdio.h>
 #include <string.h>
-#include "types.h"
-#include "debug.h"
-#include "demo.h"
-#include "task.h"
-#include "key.h"
-#include "options.h"
-#include "consmgr.h"
+#include "Types.h"
+#include "Debug.h"
+#include "Demo.h"
+#include "Task.h"
+#include "Key.h"
+#include "Options.h"
+#include "ConsMgr.h"
 
 /*=============================================================================
     Data:
@@ -16,6 +16,7 @@
 volatile keyScanType keySaveScan[KEY_TOTAL_KEYS];
 real32 keyLastTimeHit = 0.0f;
 
+#if 0
 udword keyTableGermanToEnglish[KEY_TOTAL_KEYS]=
 {
     /*            0 0  */  0,
@@ -1055,13 +1056,14 @@
     /*              254*/  254,
     /*              255*/  255,
 };
+#endif
 
 
 //key repeat buffer
 ubyte keyNumberBufferKeys = 0;
 keybufferchar keyBuffer[KEY_BufferLength];
 
-ubyte keysToNotBuffer[] = {
+uword keysToNotBuffer[] = {
     SHIFTKEY, LMOUSE_BUTTON, RMOUSE_BUTTON, MMOUSE_BUTTON,
     FLYWHEEL_UP, FLYWHEEL_DOWN, LMOUSE_DOUBLE, RMOUSE_DOUBLE,
     MMOUSE_DOUBLE,
@@ -1102,6 +1104,17 @@
 ----------------------------------------------------------------------------*/
 void keyPressDown(udword key)
 {
+    /* Game not specific about left or right Shift/Ctrl/Alt key, so neither
+       are we. */
+    if (key == SDLK_RSHIFT)
+        key = SDLK_LSHIFT;
+    else if (key == SDLK_RCTRL)
+        key = SDLK_LCTRL;
+    else if (key == SDLK_RALT)
+        key = SDLK_LALT;
+    else if (key == SDLK_RMETA) // Apple/Command/"Windows" key
+        key = SDLK_LMETA;
+
     bool bypass = FALSE, shift = FALSE;
     keyScanType originalKey = keySaveScan[key];
 #if KEY_ERROR_CHECKING
@@ -1129,7 +1142,7 @@
                 }
                 else
                 {
-                    shift = (keyIsHit(SHIFTKEY));
+                    shift = keyIsHit(SHIFTKEY);
 
                     if (cmBuildHotKey((keyindex)key, shift))
                         bypass = TRUE;
@@ -1176,6 +1189,17 @@
 ----------------------------------------------------------------------------*/
 void keyRepeat(udword key)
 {
+    /* Game not specific about left or right Shift/Ctrl/Alt key, so neither
+       are we. */
+    if (key == SDLK_RSHIFT)
+        key = SDLK_LSHIFT;
+    else if (key == SDLK_RCTRL)
+        key = SDLK_LCTRL;
+    else if (key == SDLK_RALT)
+        key = SDLK_LALT;
+    else if (key == SDLK_RMETA) // Apple/Command/"Windows" key
+        key = SDLK_LMETA;
+
 #if KEY_ERROR_CHECKING
     dbgAssert(key < KEY_TOTAL_KEYS);
 #endif
@@ -1203,6 +1227,17 @@
 ----------------------------------------------------------------------------*/
 void keyPressUp(udword key)
 {
+    /* Game not specific about left or right Shift/Ctrl/Alt key, so neither
+       are we. */
+    if (key == SDLK_RSHIFT)
+        key = SDLK_LSHIFT;
+    else if (key == SDLK_RCTRL)
+        key = SDLK_LCTRL;
+    else if (key == SDLK_RALT)
+        key = SDLK_LALT;
+    else if (key == SDLK_RMETA) // Apple/Command/"Windows" key
+        key = SDLK_LMETA;
+
     keySaveScan[key].keypressed = 0;
     keySaveScan[key].keynumpressed = 0;
 #if KEY_VERBOSE_LEVEL >= 2
@@ -1333,8 +1368,22 @@
 ----------------------------------------------------------------------------*/
 void keyBufferAdd(udword key, bool bShift)
 {
-    if (strchr(keysToNotBuffer, key))
-    {                                                       //don't bother storing strokes of certain special keys
+    int i;
+
+    /* Game not specific about left or right Shift/Ctrl/Alt key, so neither
+       are we. */
+    if (key == SDLK_RSHIFT)
+        key = SDLK_LSHIFT;
+    else if (key == SDLK_RCTRL)
+        key = SDLK_LCTRL;
+    else if (key == SDLK_RALT)
+        key = SDLK_LALT;
+    else if (key == SDLK_RMETA) // Apple/Command/"Windows" key
+        key = SDLK_LMETA;
+
+    for (i = 0; keysToNotBuffer[i]; i++)
+    {
+        if (keysToNotBuffer[i] == key)                      //don't bother storing strokes of certain special keys
         return;
     }
     if (keyNumberBufferKeys < KEY_BufferLength - 1)
@@ -1367,7 +1416,10 @@
 -----------------------------------------------------------------------------*/
 udword keyGermanToEnglish(udword virtkey)
 {
+    /*
     return (keyTableGermanToEnglish[virtkey]);
+    */
+    return virtkey;
 }
 
 /*-----------------------------------------------------------------------------
@@ -1380,7 +1432,10 @@
 -----------------------------------------------------------------------------*/
 udword keyFrenchToEnglish(udword virtkey)
 {
+    /*
     return (keyTableFrenchToEnglish[virtkey]);
+    */
+    return virtkey;
 }
 
 /*-----------------------------------------------------------------------------
@@ -1393,7 +1448,10 @@
 -----------------------------------------------------------------------------*/
 udword keySpanishToEnglish(udword virtkey)
 {
+    /*
     return (keyTableSpanishToEnglish[virtkey]);
+    */
+    return virtkey;
 }
 
 /*-----------------------------------------------------------------------------
@@ -1406,7 +1464,10 @@
 -----------------------------------------------------------------------------*/
 udword keyItalianToEnglish(udword virtkey)
 {
+    /*
     return (keyTableItalianToEnglish[virtkey]);
+    */
+    return virtkey;
 }
 
 
diff -urPw homeworld-orig/src/Game/Key.h homeworld_sdl-0.3/src/Game/Key.h
--- homeworld-orig/src/Game/Key.h	2002-09-04 12:46:12.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Key.h	2004-08-01 22:35:28.000000000 -0700
@@ -7,7 +7,8 @@
 #ifndef ___KEY_H
 #define ___KEY_H
 
-#include "types.h"
+#include "Types.h"
+#include "SDL_keysym.h"
 
 /*=============================================================================
     Switches:
@@ -23,34 +24,43 @@
 /*=============================================================================
     Definitions:
 =============================================================================*/
-#define KEY_TOTAL_KEYS          256
+#define KEY_TOTAL_KEYS          (SDLK_LAST+8)  // Use SDL keysyms, plus some for mouse
 #define KEY_BufferLength        16
 
 #define KEY_NUMPRESSED_BITS     5
 #define KEY_NUMPRESSED_MAX ((1<<6)-1)
-#define BACKSPACEKEY            0x08
-#define TABKEY                  0x09
-#define ENTERKEY                0x0d
-#define SHIFTKEY                0x10
-#define CONTROLKEY              0x11
-#define ALTKEY                  0x12
-#define PAUSEKEY                0x13
-#define SCROLLKEY               0x91
-#define PRINTKEY                0x2A
-#define CAPSLOCKKEY             0x14
-#define ESCKEY                  0x1b
-#define ARRLEFT                 0x25
-#define ARRRIGHT                0x27
-#define ARRUP                   0x26
-#define ARRDOWN                 0x28
-#define ENDKEY                  0x23
-#define HOMEKEY                 0x24
-#define PAGEUPKEY               0x21
-#define PAGEDOWNKEY             0x22
-#define INSERTKEY               0x2D
-#define DELETEKEY               0x2E
-#define LESSTHAN                0xbc // 188
-#define GREATERTHAN             0xbe // 190
+#define BACKSPACEKEY            SDLK_BACKSPACE
+#define TABKEY                  SDLK_TAB
+#define ENTERKEY                SDLK_KP_ENTER
+#define SHIFTKEY                SDLK_LSHIFT
+/*#define LSHIFTKEY               SDLK_LSHIFT*/
+/*#define RSHIFTKEY               SDLK_RSHIFT*/
+#define CONTROLKEY              SDLK_LCTRL
+/*#define LCONTROLKEY             SDLK_LCTRL*/
+/*#define RCONTROLKEY             SDLK_RCTRL*/
+#define ALTKEY                  SDLK_LALT
+/*#define LALTKEY                 SDLK_LALT*/
+/*#define RALTKEY                 SDLK_RALT*/
+#define METAKEY                 SDLK_LMETA      // Apple/Command/"Windows" key
+/*#define LMETAKEY                SDLK_LMETA*/
+/*#define RMETAKEY                SDLK_RMETA*/
+#define PAUSEKEY                SDLK_PAUSE
+#define SCROLLKEY               SDLK_SCROLLOCK
+#define PRINTKEY                SDLK_PRINT
+#define CAPSLOCKKEY             SDLK_CAPSLOCK
+#define ESCKEY                  SDLK_ESCAPE
+#define ARRLEFT                 SDLK_LEFT
+#define ARRRIGHT                SDLK_RIGHT
+#define ARRUP                   SDLK_UP
+#define ARRDOWN                 SDLK_DOWN
+#define ENDKEY                  SDLK_END
+#define HOMEKEY                 SDLK_HOME
+#define PAGEUPKEY               SDLK_PAGEUP
+#define PAGEDOWNKEY             SDLK_PAGEDOWN
+#define INSERTKEY               SDLK_INSERT
+#define DELETEKEY               SDLK_DELETE
+#define LESSTHAN                SDLK_COMMA
+#define GREATERTHAN             SDLK_PERIOD
 #define ZEROKEY                 '0'
 #define ONEKEY                  '1'
 #define TWOKEY                  '2'
@@ -61,79 +71,79 @@
 #define SEVENKEY                '7'
 #define EIGHTKEY                '8'
 #define NINEKEY                 '9'
-#define AKEY                    'A'
-#define BKEY                    'B'
-#define CKEY                    'C'
-#define DKEY                    'D'
-#define EKEY                    'E'
-#define FKEY                    'F'
-#define GKEY                    'G'
-#define HKEY                    'H'
-#define IKEY                    'I'
-#define JKEY                    'J'
-#define KKEY                    'K'
-#define LKEY                    'L'
-#define MKEY                    'M'
-#define NKEY                    'N'
-#define OKEY                    'O'
-#define PKEY                    'P'
-#define QKEY                    'Q'
-#define RKEY                    'R'
-#define SKEY                    'S'
-#define TKEY                    'T'
-#define UKEY                    'U'
-#define VKEY                    'V'
-#define WKEY                    'W'
-#define XKEY                    'X'
-#define YKEY                    'Y'
-#define ZKEY                    'Z'
+#define AKEY                    'a'
+#define BKEY                    'b'
+#define CKEY                    'c'
+#define DKEY                    'd'
+#define EKEY                    'e'
+#define FKEY                    'f'
+#define GKEY                    'g'
+#define HKEY                    'h'
+#define IKEY                    'i'
+#define JKEY                    'j'
+#define KKEY                    'k'
+#define LKEY                    'l'
+#define MKEY                    'm'
+#define NKEY                    'n'
+#define OKEY                    'o'
+#define PKEY                    'p'
+#define QKEY                    'q'
+#define RKEY                    'r'
+#define SKEY                    's'
+#define TKEY                    't'
+#define UKEY                    'u'
+#define VKEY                    'v'
+#define WKEY                    'w'
+#define XKEY                    'x'
+#define YKEY                    'y'
+#define ZKEY                    'z'
 #define SPACEKEY                ' '
-#define RETURNKEY               0x0d
-#define NUMPAD0                 0x60
-#define NUMPAD1                 0x61
-#define NUMPAD2                 0x62
-#define NUMPAD3                 0x63
-#define NUMPAD4                 0x64
-#define NUMPAD5                 0x65
-#define NUMPAD6                 0x66
-#define NUMPAD7                 0x67
-#define NUMPAD8                 0x68
-#define NUMPAD9                 0x69
-#define LBRACK                  0xdb    // 219
-#define RBRACK                  0xdd    // 221
-#define F1KEY                   0x70
-#define F2KEY                   0x71
-#define F3KEY                   0x72
-#define F4KEY                   0x73
-#define F5KEY                   0x74
-#define F6KEY                   0x75
-#define F7KEY                   0x76
-#define F8KEY                   0x77
-#define F9KEY                   0x78
-#define F10KEY                  0x79
-#define F11KEY                  0x7a
-#define F12KEY                  0x7b
-#define TILDEKEY                0xc0    // 192
-#define NUMMINUSKEY             0x6d
-#define NUMPLUSKEY              0x6b
-#define NUMSTARKEY              0x6a
-#define NUMSLASHKEY             0x6f
-#define NUMPADSLASH             0x6f
-#define NUMDOTKEY               0x6e
-#define MINUSKEY                0xbd    // 189
-#define PLUSKEY                 0xbb    // 187
-#define BACKSLASHKEY            0xdc    // 220
-
-#define LMOUSE_BUTTON           1
-#define RMOUSE_BUTTON           2
-#define MMOUSE_BUTTON           4
-
-#define FLYWHEEL_UP             3
-#define FLYWHEEL_DOWN           5
-
-#define LMOUSE_DOUBLE           6
-#define RMOUSE_DOUBLE           7
-#define MMOUSE_DOUBLE           0xf8
+#define RETURNKEY               SDLK_RETURN
+#define NUMPAD0                 SDLK_KP0
+#define NUMPAD1                 SDLK_KP1
+#define NUMPAD2                 SDLK_KP2
+#define NUMPAD3                 SDLK_KP3
+#define NUMPAD4                 SDLK_KP4
+#define NUMPAD5                 SDLK_KP5
+#define NUMPAD6                 SDLK_KP6
+#define NUMPAD7                 SDLK_KP7
+#define NUMPAD8                 SDLK_KP8
+#define NUMPAD9                 SDLK_KP9
+#define LBRACK                  SDLK_LEFTBRACKET
+#define RBRACK                  SDLK_RIGHTBRACKET
+#define F1KEY                   SDLK_F1
+#define F2KEY                   SDLK_F2
+#define F3KEY                   SDLK_F3
+#define F4KEY                   SDLK_F4
+#define F5KEY                   SDLK_F5
+#define F6KEY                   SDLK_F6
+#define F7KEY                   SDLK_F7
+#define F8KEY                   SDLK_F8
+#define F9KEY                   SDLK_F9
+#define F10KEY                  SDLK_F10
+#define F11KEY                  SDLK_F11
+#define F12KEY                  SDLK_F12
+#define TILDEKEY                SDLK_BACKQUOTE
+#define NUMMINUSKEY             SDLK_KP_MINUS
+#define NUMPLUSKEY              SDLK_KP_PLUS
+#define NUMSTARKEY              SDLK_KP_MULTIPLY
+#define NUMSLASHKEY             SDLK_KP_DIVIDE
+#define NUMPADSLASH             SDLK_KP_DIVIDE
+#define NUMDOTKEY               SDLK_KP_PERIOD
+#define MINUSKEY                SDLK_MINUS
+#define PLUSKEY                 SDLK_EQUALS
+#define BACKSLASHKEY            SDLK_BACKSLASH
+
+#define LMOUSE_BUTTON           (SDLK_LAST+0)
+#define RMOUSE_BUTTON           (SDLK_LAST+1)
+#define MMOUSE_BUTTON           (SDLK_LAST+3)
+
+#define FLYWHEEL_UP             (SDLK_LAST+2)
+#define FLYWHEEL_DOWN           (SDLK_LAST+4)
+
+#define LMOUSE_DOUBLE           (SDLK_LAST+5)
+#define RMOUSE_DOUBLE           (SDLK_LAST+6)
+#define MMOUSE_DOUBLE           (SDLK_LAST+7)
 
 /*=============================================================================
     Type definitions:
@@ -146,11 +156,14 @@
 }
 keyScanType;
 
-typedef ubyte keyindex;
+/* Been having some problems using sizes < 4 in variable argument lists.
+   (segfault core dump AUGH MY NARDS!@$#1) */
+/*typedef uword keyindex;*/
+typedef udword keyindex;
 
 typedef struct
 {
-    ubyte key;
+    keyindex key;
     bool8 bShift;
 }
 keybufferchar;
diff -urPw homeworld-orig/src/Game/KNITransform.c homeworld_sdl-0.3/src/Game/KNITransform.c
--- homeworld-orig/src/Game/KNITransform.c	2002-09-04 12:46:12.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/KNITransform.c	2004-08-01 22:35:18.000000000 -0700
@@ -1,24 +1,47 @@
 /*=============================================================================
-    Name    : knitransform.cpp
+    Name    : knitransform.c
     Purpose : Katmai New Instructions transformation routines
 
     Created 2/1/1999 by khent
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
+#if !defined (_MSC_VER) && !(defined (__GNUC__) && defined (__i386__))
+#error KNI transform routines only available on x86 systems.
+#endif
+
+#ifdef _WIN32
 #include <windows.h>
-#include <stdlib.h.>
+#endif
+
+#include <stdlib.h>
 //#define _MM_FUNCTIONALITY
 #include <xmmintrin.h>
 
+/* Prefix and suffix for declaring types as 16-byte aligned. */
+#ifdef _MSC_VER
+#define MM_ALIGN16_PRE  _MM_ALIGN16
+#define MM_ALIGN16_POST
+#else
+#define MM_ALIGN16_PRE
+#define MM_ALIGN16_POST __attribute__ ((aligned (16)))
+#endif
+
 #define VectorSize  4
 #define VectorShift 2
+#ifndef _MSC_VER
+#define VectorShift_STR "2" /* Needed for GCC inline ASM. */
+#endif
 #define NumVerts 2048
 
 #define SFXSR_BIT 0x200     /* CR4, OS supports saving KNI state */
 #define EM_BIT    0x4       /* CR0, OS is emulating FP */
 
+#if defined (_MSC_VER)
 #define SELECT(i0,i1,i2,i3) (i0*64 + i1*16 + i2*4 + i3)
+#elif defined (__GNUC__) && defined (__i386__)
+#define SELECT(i0,i1,i2,i3) "$(" #i0 "*64 + " #i1 "*16 + " #i2 "*4 + " #i3 ")"
+#endif
 
 static int kniSupport;
 
@@ -42,30 +65,30 @@
 
 static int lastNumVerts = 0;
 
-_MM_ALIGN16 struct sInVerts
+MM_ALIGN16_PRE struct sInVerts
 {
     __m128* x;
     __m128* y;
     __m128* z;
-} sInputVerts;
+} sInputVerts MM_ALIGN16_POST;
 
-_MM_ALIGN16 struct sOutVerts
+MM_ALIGN16_PRE struct sOutVerts
 {
     __m128* x;
     __m128* y;
     __m128* z;
-} sOutputVerts;
+} sOutputVerts MM_ALIGN16_POST;
 
-_MM_ALIGN16 struct sOutVerts2
+MM_ALIGN16_PRE struct sOutVerts2
 {
     __m128* x;
     __m128* y;
     __m128* z;
     __m128* w;
-} sOutputVerts2;
+} sOutputVerts2 MM_ALIGN16_POST;
 
-extern "C" void transFree(void* ptr);
-extern "C" void* transAlloc(int n);
+void transFree(void* ptr);
+void* transAlloc(int n);
 
 /*-----------------------------------------------------------------------------
     Name        : kniTransFreeVertexLists
@@ -74,7 +97,7 @@
     Outputs     :
     Return      :
 ----------------------------------------------------------------------------*/
-extern "C" void kniTransFreeVertexLists(void)
+void kniTransFreeVertexLists(void)
 {
     if (lastNumVerts != 0)
     {
@@ -134,6 +157,7 @@
     static unsigned int cpu_eax, cpu_edx;
     int hasSFXSR, hasEM;
 
+#if defined (_MSC_VER)
     _asm
     {
         pusha
@@ -141,8 +165,17 @@
         mov [cpu_eax], eax
         popa
     }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ (
+        "pusha\n\t"
+        "movl %%CR4, %%eax\n\t"
+        "movl %%eax, %0\n\t"
+        "popa\n\t"
+        : "=m" (cpu_eax) );
+#endif
     hasSFXSR = (cpu_eax & SFXSR_BIT) ? 1 : 0;
 
+#if defined (_MSC_VER)
     _asm
     {
         pusha
@@ -150,6 +183,14 @@
         mov [cpu_eax], eax
         popa
     }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ (
+        "pusha\n\t"
+        "movl %%CR0, %%eax\n\t"
+        "movl %%eax, %0\n\t"
+        "popa\n\t"
+        : "=m" (cpu_eax) );
+#endif
     hasEM = (cpu_eax & EM_BIT) ? 1 : 0;
 
     if (hasSFXSR && !hasEM)
@@ -170,12 +211,14 @@
     Outputs     :
     Return      : 1 or 0 (does or doesn't)
 ----------------------------------------------------------------------------*/
-extern "C" int transDetermineKatmaiSupport(unsigned int haveKatmai)
+int transDetermineKatmaiSupport(unsigned int haveKatmai)
 {
 #ifdef _MM_FUNCTIONALITY
     //emulated KNI, always supported
     kniSupport = 1;
 #else
+
+#ifdef _WIN32
     DWORD version;
 
     version = GetVersion();
@@ -190,6 +233,10 @@
         //Win9x or Win32
         kniSupport = (haveKatmai) ? 1/*chkxmmbits()*/ : 0;
     }
+#else
+    kniSupport = (haveKatmai) ? 1 : 0;
+#endif
+
 #endif
     return kniSupport;
 }
@@ -201,7 +248,7 @@
     Outputs     :
     Return      :
 ----------------------------------------------------------------------------*/
-extern "C" void transSetKatmaiSupport(unsigned int on)
+void transSetKatmaiSupport(unsigned int on)
 {
     kniSupport = on;
 }
@@ -213,14 +260,15 @@
     Outputs     :
     Return      : 1 or 0 (can or can't)
 ----------------------------------------------------------------------------*/
-extern "C" int transCanSupportKatmai(void)
+int transCanSupportKatmai(void)
 {
     return kniSupport;
 }
 
-static _MM_ALIGN16 int Mask[4] = {0x80000000,0x80000000,0x80000000,0x80000000};
+static MM_ALIGN16_PRE int Mask[4] MM_ALIGN16_POST =
+    {0x80000000,0x80000000,0x80000000,0x80000000};
 
-extern "C" void transTransformCompletely_xmm(
+void transTransformCompletely_xmm(
     int nVerts, hvector* dest, vertexentry* source, float* M0, float* M1)
 {
     int i, n;
@@ -231,11 +279,11 @@
     static float* mat0;
     static float* mat1;
 
-    static _MM_ALIGN16 __m128 nextX;
+    static MM_ALIGN16_PRE __m128 nextX MM_ALIGN16_POST;
 
     //matrices
-    static _MM_ALIGN16 __m128 mat[16];
-    static _MM_ALIGN16 __m128 per[16];
+    static MM_ALIGN16_PRE __m128 mat[16] MM_ALIGN16_POST;
+    static MM_ALIGN16_PRE __m128 per[16] MM_ALIGN16_POST;
 
     //setup statics (easily accessible from asm)
     m0 = M0;
@@ -253,6 +301,7 @@
     //possibly expand our vertex lists
     kniTransGrowVertexLists(n);
 
+#if defined (_MSC_VER)
     _asm
     {
         push    esi
@@ -450,6 +499,203 @@
         pop     edi
         pop     esi
     }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ (
+             /*
+              * assignment
+              */
+
+             /* 3D */
+        "    movl    %0, %%esi\n"
+        "    movl    %1, %%edi\n"
+        "    movl    %2, %%eax\n"
+        "    movl    %3, %%edx\n"
+
+        "    prefetchnta (%%edx)\n"
+        "    movss   4*0(%%esi), %%xmm0\n"
+        "    movss   4*1(%%esi), %%xmm1\n"
+        "    shufps  $0x00, %%xmm0, %%xmm0\n"
+        "    movss   4*2(%%esi), %%xmm2\n"
+        "    shufps  $0x00, %%xmm1, %%xmm1\n"
+        "    movaps  %%xmm0, 4*4*0(%%edi)\n"
+        "    movss   4*4(%%esi), %%xmm3\n"
+        "    prefetchnta (%%eax)\n"
+        "    shufps  $0x00, %%xmm2, %%xmm2\n"
+        "    movaps  %%xmm1, 4*4*1(%%edi)\n"
+        "    movss   4*5(%%esi), %%xmm4\n"
+        "    shufps  $0x00, %%xmm3, %%xmm3\n"
+        "    movaps  %%xmm2, 4*4*2(%%edi)\n"
+        "    movss   4*6(%%esi), %%xmm5\n"
+        "    shufps  $0x00, %%xmm4, %%xmm4\n"
+        "    movaps  %%xmm3, 4*4*4(%%edi)\n"
+        "    movss   4*8(%%esi), %%xmm6\n"
+        "    shufps  $0x00, %%xmm5, %%xmm5\n"
+        "    movaps  %%xmm4, 4*4*5(%%edi)\n"
+        "    movss   4*9(%%esi), %%xmm7\n"
+        "    shufps  $0x00, %%xmm6, %%xmm6\n"
+        "    movaps  %%xmm5, 4*4*6(%%edi)\n"
+        "    shufps  $0x00, %%xmm7, %%xmm7\n"
+        "    movaps  %%xmm6, 4*4*8(%%edi)\n"
+        "    movaps  %%xmm7, 4*4*9(%%edi)\n"
+
+             /* ... */
+
+        "    movss   4*10(%%esi), %%xmm0\n"
+        "    movss   4*12(%%esi), %%xmm1\n"
+        "    shufps  $0x00, %%xmm0, %%xmm0\n"
+        "    movss   4*13(%%esi), %%xmm2\n"
+        "    shufps  $0x00, %%xmm1, %%xmm1\n"
+        "    movaps  %%xmm0, 4*4*10(%%edi)\n"
+        "    movss   4*14(%%esi), %%xmm3\n"
+        "    shufps  $0x00, %%xmm2, %%xmm2\n"
+        "    movaps  %%xmm1, 4*4*12(%%edi)\n"
+        "    shufps  $0x00, %%xmm3, %%xmm3\n"
+        "    movaps  %%xmm2, 4*4*13(%%edi)\n"
+        "    movaps  %%xmm3, 4*4*14(%%edi)\n"
+
+             /* perspective */
+        "    movss   4*0(%%eax), %%xmm0\n"
+        "    movss   4*5(%%eax), %%xmm1\n"
+        "    shufps  $0x00, %%xmm0, %%xmm0\n"
+        "    movss   4*8(%%eax), %%xmm2\n"
+        "    shufps  $0x00, %%xmm1, %%xmm1\n"
+        "    movaps  %%xmm0, 4*4*0(%%edx)\n"
+        "    movss   4*9(%%eax), %%xmm3\n"
+        "    shufps  $0x00, %%xmm2, %%xmm2\n"
+        "    movaps  %%xmm1, 4*4*5(%%edx)\n"
+        "    movss   4*10(%%eax), %%xmm4\n"
+        "    shufps  $0x00, %%xmm3, %%xmm3\n"
+        "    movaps  %%xmm2, 4*4*8(%%edx)\n"
+        "    movss   4*14(%%eax), %%xmm5\n"
+        "    shufps  $0x00, %%xmm4, %%xmm4\n"
+        "    movaps  %%xmm3, 4*4*9(%%edx)\n"
+        "    shufps  $0x00, %%xmm5, %%xmm5\n"
+        "    movaps  %%xmm4, 4*4*10(%%edx)\n"
+        "    movaps  %%xmm5, 4*4*14(%%edx)\n"
+
+             /*
+              * transformation
+              */
+
+        "    movl    %1, %%esi\n"
+        "    movl    %3, %%edi\n"
+        "    movl    %4, %%ecx\n"
+        "    movl    %5, %%eax\n"
+        "    movl    %6, %%edx\n"
+        "    shll    $(4+"VectorShift_STR"), %%ecx\n"
+
+        "transcomp_start:\n"
+        "    subl    $64, %%ecx\n"
+
+             /* swizzle */
+        "    movups  (%%eax, %%ecx), %%xmm7\n"        /* 1st xyz */
+        "    movups  16(%%eax, %%ecx), %%xmm2\n"      /* 2nd xyz */
+        "    movups  32(%%eax, %%ecx), %%xmm4\n"      /* 3rd xyz */
+        "    movups  48(%%eax, %%ecx), %%xmm3\n"      /* 4th xyz */
+        "    prefetchnta -64(%%eax, %%ecx)\n"
+        "    movaps  %%xmm7, %%xmm6\n"
+        "    movaps  %%xmm4, %%xmm5\n"
+        "    unpcklps %%xmm2, %%xmm6\n"
+        "    unpcklps %%xmm3, %%xmm5\n"
+        "    movaps  %%xmm6, %%xmm0\n"
+        "    prefetchnta 16-64(%%eax, %%ecx)\n"
+        "    shufps  "SELECT(3,2,3,2)", %%xmm5, %%xmm6\n" //yyyy in xmm6 */
+        "    shufps  "SELECT(1,0,1,0)", %%xmm5, %%xmm0\n" //xxxx in xmm0 */
+        "    unpckhps %%xmm3, %%xmm4\n"
+        "    prefetchnta 32-64(%%eax, %%ecx)\n"
+        "    unpckhps %%xmm2, %%xmm7\n"
+
+             /* transform */
+        "    movaps  4*4*0(%%esi), %%xmm3\n"
+        "    movaps  4*4*4(%%esi), %%xmm1\n"
+        "    mulps   %%xmm0, %%xmm3\n"          /* x*m0 in xmm3 */
+        "    prefetchnta 48-64(%%eax, %%ecx)\n"
+        "    shufps  "SELECT(1,0,1,0)", %%xmm4, %%xmm7\n" /* zzzz in xmm7 */
+        "    mulps   %%xmm6, %%xmm1\n"          /* y*m4 in xmm1 */
+        "    movaps  4*4*8(%%esi), %%xmm4\n"
+        "    movaps  4*4*12(%%esi), %%xmm5\n"
+        "    mulps   %%xmm7, %%xmm4\n"          /* z*m8 in xmm4 */
+        "    addps   %%xmm3, %%xmm1\n"          /* x*m0 + y*m4 in xmm1 */
+        "    addps   %%xmm5, %%xmm4\n"          /* z*m8 + m12 in xmm4 */
+        "    addps   %%xmm4, %%xmm1\n"          /* x*m0 + y*m4 + z*m8 + m12 in xmm1 */
+        "    movaps  %%xmm1, %7\n"
+
+        "    movaps  4*4*1(%%esi), %%xmm3\n"
+        "    movaps  4*4*5(%%esi), %%xmm2\n"
+        "    mulps   %%xmm0, %%xmm3\n"          /* x*m1 in xmm3 */
+        "    mulps   %%xmm6, %%xmm2\n"          /* y*m5 in xmm2 */
+        "    movaps  4*4*9(%%esi), %%xmm4\n"
+        "    movaps  4*4*13(%%esi), %%xmm5\n"
+        "    mulps   %%xmm7, %%xmm4\n"          /* z*m9 in xmm4 */
+        "    addps   %%xmm3, %%xmm2\n"          /* x*m1 + y*m5 in xmm2 */
+        "    addps   %%xmm5, %%xmm4\n"          /* z*m9 + m13 in xmm4 */
+        "    addps   %%xmm4, %%xmm2\n"          /* x*m1 + y*m5 + z*m9 + m13 in xmm2 */
+
+        "    movaps  4*4*2(%%esi), %%xmm3\n"
+        "    movaps  4*4*6(%%esi), %%xmm1\n"
+        "    mulps   %%xmm0, %%xmm3\n"          /* x*m2 in xmm3 */
+        "    mulps   %%xmm6, %%xmm1\n"          /* y*m6 in xmm1 */
+        "    movaps  4*4*10(%%esi), %%xmm4\n"
+        "    movaps  4*4*14(%%esi), %%xmm5\n"
+        "    mulps   %%xmm7, %%xmm4\n"          /* z*m10 in xmm4 */
+        "    addps   %%xmm3, %%xmm1\n"          /* x*m2 + y*m6 in xmm1 */
+        "    addps   %%xmm5, %%xmm4\n"          /* z*m10 + m14 in xmm4 */
+        "    addps   %%xmm4, %%xmm1\n"          /* x*m2 + y*m6 + z*m10 + m14 in xmm1 */
+
+             /* project */
+        "    movaps  %7, %%xmm0\n"              /* X in xmm0 */
+        "    movaps  %%xmm2, %%xmm6\n"          /* Y in xmm6 */
+        "    movaps  %%xmm1, %%xmm7\n"          /* Z in xmm7 */
+
+        "    movaps  4*4*0(%%edi), %%xmm3\n"
+        "    movaps  4*4*8(%%edi), %%xmm2\n"
+        "    mulps   %%xmm0, %%xmm3\n"          /* x*p0 in xmm3 */
+        "    mulps   %%xmm7, %%xmm2\n"          /* z*p8 in xmm2 */
+        "    movaps  4*4*5(%%edi), %%xmm5\n"    /* ... */
+        "    addps   %%xmm3, %%xmm2\n"          /* x*p0 + z*p8 in xmm2 */
+
+        "    movaps  4*4*9(%%edi), %%xmm4\n"
+        "    mulps   %%xmm6, %%xmm5\n"          /* y*p5 in xmm5 */
+        "    mulps   %%xmm7, %%xmm4\n"          /* z*p9 in xmm4 */
+        "    movaps  4*4*10(%%edi), %%xmm3\n"   /* ... */
+        "    addps   %%xmm5, %%xmm4\n"          /* y*p5 + z*p9 in xmm4 */
+
+        "    movaps  4*4*14(%%edi), %%xmm6\n"
+        "    mulps   %%xmm7, %%xmm3\n"          /* z*p10 in xmm3 */
+        "    movaps  %%xmm7, %%xmm1\n"          /* ... */
+        "    addps   %%xmm3, %%xmm6\n"          /* z*p10 + p14 in xmm6 */
+
+        "    xorps   %8, %%xmm1\n"
+        "    movaps  %%xmm2, %%xmm0\n"          /* ... */
+        "    movaps  %%xmm1, %%xmm3\n"          /* -z in xmm3 */
+
+             //swizzle
+        "    unpcklps %%xmm4, %%xmm0\n"
+        "    movaps  %%xmm0, %%xmm1\n"
+        "    movaps  %%xmm6, %%xmm5\n"
+        "    unpcklps %%xmm3, %%xmm5\n"
+        "    shufps  "SELECT(1,0,1,0)", %%xmm5, %%xmm1\n"
+        "    movaps  %%xmm1, (%%edx, %%ecx)\n"    /* w0,z0,y0,x0 */
+        "    shufps  "SELECT(3,2,3,2)", %%xmm5, %%xmm0\n"
+        "    movaps  %%xmm0, 16(%%edx, %%ecx)\n"  /* w1,z1,y1,x1 */
+        "    movaps  %%xmm2, %%xmm0\n"
+        "    unpckhps %%xmm4, %%xmm0\n"
+        "    movaps  %%xmm0, %%xmm1\n"
+        "    movaps  %%xmm6, %%xmm5\n"
+        "    unpckhps %%xmm3, %%xmm5\n"
+        "    shufps  "SELECT(1,0,1,0)", %%xmm5, %%xmm1\n"
+        "    movaps  %%xmm1, 32(%%edx, %%ecx)\n"  /* w2,z2,y1,x2 */
+        "    shufps  "SELECT(3,2,3,2)", %%xmm5, %%xmm0\n"
+        "    movaps  %%xmm0, 48(%%edx, %%ecx)\n"  /* w3,z3,y1,x3 */
+
+        "    jnz     transcomp_start\n"
+        :
+        : "m" (m0), "m" (mat0), "m" (m1), "m" (mat1),
+          "m" (n), "m" (source), "m" (dest),
+          "m" (nextX),
+          "m" (Mask)
+          : "eax", "edx", "ecx", "edi", "esi" );
+#endif
 }
 
 /*-----------------------------------------------------------------------------
@@ -463,21 +709,39 @@
     Outputs     : dest is filled
     Return      :
 ----------------------------------------------------------------------------*/
-extern "C" void transTransformCompletely_intrin(
+void transTransformCompletely_intrin(
     int nVerts, hvector* dest, vertexentry* source, float* m0, float* m1)
 {
-    int i, n;
+    int i, j, n;
     hvector* dp;
 
-    _MM_ALIGN16 __m128 curX, curY, curZ;
-    _MM_ALIGN16 __m128 nextX, nextY, nextZ;
+    MM_ALIGN16_PRE __m128 curX MM_ALIGN16_POST,
+                          curY MM_ALIGN16_POST,
+                          curZ MM_ALIGN16_POST;
+    MM_ALIGN16_PRE __m128 nextX MM_ALIGN16_POST,
+                          nextY MM_ALIGN16_POST,
+                          nextZ MM_ALIGN16_POST;
 
     //matrices
-    _MM_ALIGN16 __m128 mat00, mat04, mat08, mat12;
-    _MM_ALIGN16 __m128 mat01, mat05, mat09, mat13;
-    _MM_ALIGN16 __m128 mat02, mat06, mat10, mat14;
-
-    _MM_ALIGN16 __m128 per00, per08, per05, per09, per10, per14;
+    MM_ALIGN16_PRE __m128 mat00 MM_ALIGN16_POST,
+                          mat04 MM_ALIGN16_POST,
+                          mat08 MM_ALIGN16_POST,
+                          mat12 MM_ALIGN16_POST;
+    MM_ALIGN16_PRE __m128 mat01 MM_ALIGN16_POST,
+                          mat05 MM_ALIGN16_POST,
+                          mat09 MM_ALIGN16_POST,
+                          mat13 MM_ALIGN16_POST;
+    MM_ALIGN16_PRE __m128 mat02 MM_ALIGN16_POST,
+                          mat06 MM_ALIGN16_POST,
+                          mat10 MM_ALIGN16_POST,
+                          mat14 MM_ALIGN16_POST;
+
+    MM_ALIGN16_PRE __m128 per00 MM_ALIGN16_POST,
+                          per08 MM_ALIGN16_POST,
+                          per05 MM_ALIGN16_POST,
+                          per09 MM_ALIGN16_POST,
+                          per10 MM_ALIGN16_POST,
+                          per14 MM_ALIGN16_POST;
 
     mat00 = _mm_set_ps1(m0[0]);
     mat04 = _mm_set_ps1(m0[4]);
@@ -564,7 +828,7 @@
         float* zp = (float*)&sOutputVerts2.z[i];
         float* wp = (float*)&sOutputVerts2.w[i];
 
-        for (int j = 0; j < VectorSize; j++, dp++)
+        for (j = 0; j < VectorSize; j++, dp++)
         {
             dp->x = *(xp + j);
             dp->y = *(yp + j);
@@ -584,16 +848,27 @@
     Outputs     : sOutputVerts is filled
     Return      :
 ----------------------------------------------------------------------------*/
-extern "C" void transTransformVertexList_intrin(int nVerts, hvector* dest, vertexentry* source, float* m)
+void transTransformVertexList_intrin(int nVerts, hvector* dest, vertexentry* source, float* m)
 {
     int i, n;
 
-    _MM_ALIGN16 __m128 curX, curY, curZ;
+    MM_ALIGN16_PRE __m128 curX MM_ALIGN16_POST,
+                          curY MM_ALIGN16_POST,
+                          curZ MM_ALIGN16_POST;
 
     //matrix
-    _MM_ALIGN16 __m128 mat00, mat04, mat08, mat12;
-    _MM_ALIGN16 __m128 mat01, mat05, mat09, mat13;
-    _MM_ALIGN16 __m128 mat02, mat06, mat10, mat14;
+    MM_ALIGN16_PRE __m128 mat00 MM_ALIGN16_POST,
+                          mat04 MM_ALIGN16_POST,
+                          mat08 MM_ALIGN16_POST,
+                          mat12 MM_ALIGN16_POST;
+    MM_ALIGN16_PRE __m128 mat01 MM_ALIGN16_POST,
+                          mat05 MM_ALIGN16_POST,
+                          mat09 MM_ALIGN16_POST,
+                          mat13 MM_ALIGN16_POST;
+    MM_ALIGN16_PRE __m128 mat02 MM_ALIGN16_POST,
+                          mat06 MM_ALIGN16_POST,
+                          mat10 MM_ALIGN16_POST,
+                          mat14 MM_ALIGN16_POST;
 
     mat00 = _mm_set_ps1(m[0]);
     mat04 = _mm_set_ps1(m[4]);
@@ -662,14 +937,21 @@
     Outputs     : dest is filled
     Return      :
 ----------------------------------------------------------------------------*/
-extern "C" void transPerspectiveTransform_intrin(int nVerts, hvector* dest, hvector* source, float* m)
+void transPerspectiveTransform_intrin(int nVerts, hvector* dest, hvector* source, float* m)
 {
-    int i, n;
+    int i, j, n;
     hvector* dp;
 
-    _MM_ALIGN16 __m128 curX, curY, curZ;
-
-    _MM_ALIGN16 __m128 mat00, mat08, mat05, mat09, mat10, mat14;
+    MM_ALIGN16_PRE __m128 curX MM_ALIGN16_POST,
+                          curY MM_ALIGN16_POST,
+                          curZ MM_ALIGN16_POST;
+
+    MM_ALIGN16_PRE __m128 mat00 MM_ALIGN16_POST,
+                          mat08 MM_ALIGN16_POST,
+                          mat05 MM_ALIGN16_POST,
+                          mat09 MM_ALIGN16_POST,
+                          mat10 MM_ALIGN16_POST,
+                          mat14 MM_ALIGN16_POST;
 
     mat00 = _mm_set_ps1(m[0]);
     mat08 = _mm_set_ps1(m[8]);
@@ -705,7 +987,7 @@
         float* zp = (float*)&sOutputVerts2.z[i];
         float* wp = (float*)&sOutputVerts2.w[i];
 
-        for (int j = 0; j < VectorSize; j++, dp++)
+        for (j = 0; j < VectorSize; j++, dp++)
         {
             dp->x = *(xp + j);
             dp->y = *(yp + j);
@@ -727,16 +1009,30 @@
     Outputs     : dest is filled
     Return      :
 ----------------------------------------------------------------------------*/
-extern "C" void transGeneralPerspectiveTransform_intrin(int nVerts, hvector* dest, hvector* source, float* m)
+void transGeneralPerspectiveTransform_intrin(int nVerts, hvector* dest, hvector* source, float* m)
 {
-    int i, n;
+    int i, j, n;
     hvector* dp;
 
-    _MM_ALIGN16 __m128 curX, curY, curZ;
-    _MM_ALIGN16 __m128 mat00, mat04, mat08, mat12;
-    _MM_ALIGN16 __m128 mat01, mat05, mat09, mat13;
-    _MM_ALIGN16 __m128 mat02, mat06, mat10, mat14;
-    _MM_ALIGN16 __m128 mat03, mat07, mat11, mat15;
+    MM_ALIGN16_PRE __m128 curX MM_ALIGN16_POST,
+                          curY MM_ALIGN16_POST,
+                          curZ MM_ALIGN16_POST;
+    MM_ALIGN16_PRE __m128 mat00 MM_ALIGN16_POST,
+                          mat04 MM_ALIGN16_POST,
+                          mat08 MM_ALIGN16_POST,
+                          mat12 MM_ALIGN16_POST;
+    MM_ALIGN16_PRE __m128 mat01 MM_ALIGN16_POST,
+                          mat05 MM_ALIGN16_POST,
+                          mat09 MM_ALIGN16_POST,
+                          mat13 MM_ALIGN16_POST;
+    MM_ALIGN16_PRE __m128 mat02 MM_ALIGN16_POST,
+                          mat06 MM_ALIGN16_POST,
+                          mat10 MM_ALIGN16_POST,
+                          mat14 MM_ALIGN16_POST;
+    MM_ALIGN16_PRE __m128 mat03 MM_ALIGN16_POST,
+                          mat07 MM_ALIGN16_POST,
+                          mat11 MM_ALIGN16_POST,
+                          mat15 MM_ALIGN16_POST;
 
     mat00 = _mm_set_ps1(m[0]);
     mat01 = _mm_set_ps1(m[1]);
@@ -800,7 +1096,7 @@
         float* zp = (float*)&sOutputVerts2.z[i];
         float* wp = (float*)&sOutputVerts2.w[i];
 
-        for (int j = 0; j < VectorSize; j++, dp++)
+        for (j = 0; j < VectorSize; j++, dp++)
         {
             dp->x = *(xp + j);
             dp->y = *(yp + j);
diff -urPw homeworld-orig/src/Game/LagPrint.c homeworld_sdl-0.3/src/Game/LagPrint.c
--- homeworld-orig/src/Game/LagPrint.c	2002-09-04 12:46:12.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/LagPrint.c	2004-08-01 22:35:16.000000000 -0700
@@ -8,11 +8,11 @@
 =============================================================================*/
 
 
-#include "types.h"
+#include "Types.h"
 #include "texreg.h"
 #include "LagPrint.h"
-#include "fereg.h"
-#include "commandnetwork.h"
+#include "FEReg.h"
+#include "CommandNetwork.h"
 
 //  Data to be added to tweak.script later
 
diff -urPw homeworld-orig/src/Game/LagPrint.h homeworld_sdl-0.3/src/Game/LagPrint.h
--- homeworld-orig/src/Game/LagPrint.h	2002-09-04 12:46:12.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/LagPrint.h	2004-08-01 22:35:17.000000000 -0700
@@ -10,7 +10,11 @@
 #ifndef ___LAGPRINT_H
 #define ___LAGPRINT_H
 
+#ifdef _WIN32
 #define LAG_PATH                    "FeMan\\LagIcon\\"
+#else
+#define LAG_PATH                    "FeMan/LagIcon/"
+#endif
 
 #define SLOW_COMPUTERICON           LAG_PATH"SlowComputerIcon.lif"
 #define SLOW_INTERNETICON           LAG_PATH"SlowInternetIcon.lif"
diff -urPw homeworld-orig/src/Game/LaunchMgr.c homeworld_sdl-0.3/src/Game/LaunchMgr.c
--- homeworld-orig/src/Game/LaunchMgr.c	2002-09-04 12:46:12.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/LaunchMgr.c	2004-08-01 22:35:17.000000000 -0700
@@ -8,39 +8,39 @@
 
 
 #include <stdio.h>
-#include "types.h"
-#include "linkedlist.h"
-#include "universe.h"
-#include "region.h"
-#include "uicontrols.h"
-#include "feflow.h"
+#include "Types.h"
+#include "LinkedList.h"
+#include "Universe.h"
+#include "Region.h"
+#include "UIControls.h"
+#include "FEFlow.h"
 #include "font.h"
-#include "fontreg.h"
-#include "objtypes.h"
-#include "task.h"
+#include "FontReg.h"
+#include "ObjTypes.h"
+#include "Task.h"
 #include "mouse.h"
 #include "CommandLayer.h"
-#include "piePlate.h"
-#include "launchMgr.h"
-#include "globals.h"
+#include "PiePlate.h"
+#include "LaunchMgr.h"
+#include "Globals.h"
 #include "CommandWrap.h"
-#include "scroller.h"
-#include "soundevent.h"
-#include "randy.h"
+#include "Scroller.h"
+#include "SoundEvent.h"
+#include "Randy.h"
 #include "mainrgn.h"
-#include "shipdefs.h"
-#include "shipview.h"
+#include "ShipDefs.h"
+#include "ShipView.h"
 #include "prim2d.h"
-#include "taskbar.h"
+#include "TaskBar.h"
 #include "texreg.h"
-#include "fereg.h"
+#include "FEReg.h"
 #include "render.h"
 #include "prim2d.h"
-#include "tutor.h"
+#include "Tutor.h"
 #include "FEColour.h"
 #include "glcompat.h"
-#include "infooverlay.h"
-#include "stringsonly.h"
+#include "InfoOverlay.h"
+#include "StringsOnly.h"
 
 /*=============================================================================
     Defines:
@@ -203,14 +203,19 @@
 
 char *lmShipImagePaths[] =
 {
-    {"FEMan\\Construction_Manager\\Build_race1_"},
-    {"FEMan\\Construction_Manager\\Build_race2_"}
+#ifdef _WIN32
+    "FEMan\\Construction_Manager\\Build_race1_",
+    "FEMan\\Construction_Manager\\Build_race2_"
+#else
+    "FEMan/Construction_Manager/Build_race1_",
+    "FEMan/Construction_Manager/Build_race2_"
+#endif
 };
 
 char *lmShipIcons[] =
 {
-    {"icon1.lif"}, // Mothership
-    {"icon2.lif"}, // Carrier
+    "icon1.lif", // Mothership
+    "icon2.lif", // Carrier
 };
 
 
@@ -921,7 +926,7 @@
             select.x1 = x+(((rect.x1-rect.x0)*3)/4);
             select.y1 = y-LM_BoxSpacing+fontHeight(" ") + LM_VertSpacing;
             primRectTranslucent2(&select, FEC_ListItemTranslucent);
-            primRectOutline2(&select, 1, FEC_ListItemTranslucentBorder/*selectcol*/ /*);
+            primRectOutline2(&select, 1, FEC_ListItemTranslucentBorder); //selectcol
         }
 
 
diff -urPw homeworld-orig/src/Game/LaunchMgr.h homeworld_sdl-0.3/src/Game/LaunchMgr.h
--- homeworld-orig/src/Game/LaunchMgr.h	2002-09-04 12:46:12.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/LaunchMgr.h	2004-08-01 22:35:17.000000000 -0700
@@ -10,15 +10,19 @@
 #ifndef ___LAUNCHMGR_H
 #define ___LAUNCHMGR_H
 
-#include "types.h"
-#include "region.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Region.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Definitions:
 =============================================================================*/
 
+#ifdef _WIN32
 #define LM_FIBFile              "FEMAN\\Launch_Manager.fib"
+#else
+#define LM_FIBFile              "FEMAN/Launch_Manager.fib"
+#endif
 #define LM_LaunchScreen         "Launch_Manager"
 
 #define LM_ShipListTextColor        colRGB( 30, 160, 190)
diff -urPw homeworld-orig/src/Game/LevelLoad.c homeworld_sdl-0.3/src/Game/LevelLoad.c
--- homeworld-orig/src/Game/LevelLoad.c	2002-09-04 12:46:12.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/LevelLoad.c	2004-08-01 22:35:18.000000000 -0700
@@ -1,40 +1,45 @@
 
 #include <stdio.h>
 #include <string.h>
+#include <strings.h>
 #include <stdlib.h>
 #include <math.h>
 #include <ctype.h>
-#include "types.h"
-#include "memory.h"
-#include "debug.h"
-#include "vector.h"
-#include "spaceobj.h"
-#include "univupdate.h"
-#include "universe.h"
+#include <limits.h>
+#include "Types.h"
+#include "Memory.h"
+#include "Debug.h"
+#include "Vector.h"
+#include "SpaceObj.h"
+#include "UnivUpdate.h"
+#include "Universe.h"
 #include "CommandLayer.h"
-#include "statscript.h"
-#include "scenpick.h"
-#include "levelload.h"
+#include "StatScript.h"
+#include "ScenPick.h"
+#include "LevelLoad.h"
 #include "light.h"
-#include "sensors.h"
-#include "singleplayer.h"
-#include "soundevent.h"
-#include "nebulae.h"
+#include "Sensors.h"
+#include "SinglePlayer.h"
+#include "SoundEvent.h"
+#include "Nebulae.h"
 #include "mainrgn.h"
-#include "btg.h"
-#include "researchAPI.h"
+#include "BTG.h"
+#include "ResearchAPI.h"
 #include "AITeam.h"
 #include "AIPlayer.h"
 #include "KAS.h"
-#include "file.h"
-#include "teams.h"
-#include "multiplayergame.h"
-#include "researchapi.h"
-#include "attributes.h"
-#include "tweak.h"
-#include "ping.h"
-#include "randy.h"
-#include "researchship.h"
+#include "File.h"
+#include "Teams.h"
+#include "MultiplayerGame.h"
+#include "Attributes.h"
+#include "Tweak.h"
+#include "Ping.h"
+#include "Randy.h"
+#include "ResearchShip.h"
+
+#ifdef _MSC_VER
+#define strcasecmp _stricmp
+#endif
 
 #define CapturableCapitalShipToGive StandardFrigate
 
@@ -276,7 +281,7 @@
         index = 1;
     }
 
-    randnum = random(resourceDistribution->sumTotal[index]);
+    randnum = randomG(resourceDistribution->sumTotal[index]);
 
     for (i=0;i<MAXNUM_RESOURCETYPES;i++)
     {
@@ -325,7 +330,7 @@
 
 void AddRandomVelocityDirection(SpaceObj *obj,vector *direction,real32 avgVel,real32 deviation)
 {
-    real32 dev2 = deviation*2.0f;
+    //real32 dev2 = deviation*2.0f;
     vector devvector;
 
     devvector.x = 0;//frandom(dev2) - deviation;
@@ -417,6 +422,8 @@
             }
         }
         break;
+    default:
+        break;
     }
 
     return TRUE;
@@ -1086,7 +1093,7 @@
             {
                 paradeFormation = TRUE;
             }
-            else if (_stricmp(miscPointer,"UseAsMothership") == 0)
+            else if (strcasecmp(miscPointer,"UseAsMothership") == 0)
             {
                 useAsMothership = TRUE;
             }
@@ -1390,7 +1397,7 @@
             label, &(point.x), &(point.y), &(point.z), openClosed, &pointNum, &numPoints) != 7)
         dbgFatalf(DBG_Loc,"Bad AIPath point definition: %s",field);
 
-    closed = !strcmpi(openClosed, "closed");
+    closed = !strcasecmp(openClosed, "closed");
 
     path = kasPathPtrNoErrorChecking(label);
     if (path == NULL)
@@ -1454,7 +1461,7 @@
     sscanf(field, "%s", lightingFileName);
     if (strlen(field) > 1)
     {
-        char fullFileName[_MAX_PATH];
+        char fullFileName[PATH_MAX];
 
         strcpy(fullFileName, directory);
         strcat(fullFileName, lightingFileName);
@@ -1469,7 +1476,11 @@
         }
         else
         {
+#ifdef _WIN32
             strcpy(fullFileName, "HSF\\");
+#else
+            strcpy(fullFileName, "HSF/");
+#endif
             strcat(fullFileName, lightingFileName);
             if (strchr(lightingFileName, '.') == NULL)
             {
@@ -1503,7 +1514,7 @@
     btgSetPhi(phi);
     if (strlen(field) > 1)
     {
-        char fullFileName[_MAX_PATH];
+        char fullFileName[PATH_MAX];
 
         // first try current directory:
 
@@ -1520,7 +1531,11 @@
         }
         else
         {
+#ifdef _WIN32
             strcpy(fullFileName, "BTG\\");
+#else
+            strcpy(fullFileName, "BTG/");
+#endif
             strcat(fullFileName, btgFileName);
             if (strchr(btgFileName, '.') == NULL)
             {
@@ -1533,13 +1548,21 @@
             }
             else
             {
+#ifdef _WIN32
                 btgLoad("BTG\\default.btg");
+#else
+                btgLoad("BTG/default.btg");
+#endif
             }
         }
     }
     else
     {
+#ifdef _WIN32
         btgLoad("BTG\\default.btg");
+#else
+        btgLoad("BTG/default.btg");
+#endif
     }
 }
 
@@ -1879,15 +1902,15 @@
     //parse the ship type
     string = strtok(NULL, llDelimiters);
     dbgAssert(string != NULL);
-    if (_stricmp(string, "ALL") == 0)
+    if (strcasecmp(string, "ALL") == 0)
     {                                                       //if we should do this to all ships for this race
-        universeFlagRaceNeeded(race, (bool8)dataToFillIn);
+        universeFlagRaceNeeded(race, (bool8)(size_t)dataToFillIn);
     }
     else
     {                                                       //else just a single ship
         type = StrToShipType(string);
         dbgAssert(type != 0xffffffff);
-        SetInfoNeededForShipAndRelatedStaticInfo(type,race,(bool8)dataToFillIn);
+        SetInfoNeededForShipAndRelatedStaticInfo(type,race,(bool8)(size_t)dataToFillIn);
         rmEnableShip(race, type, (bool)dataToFillIn);
     }
 }
@@ -1911,7 +1934,7 @@
         return;
     }
 
-    bitSetTo(asteroidStaticInfos[type].staticheader.infoFlags, IF_InfoNeeded, (bool8)dataToFillIn);
+    bitSetTo(asteroidStaticInfos[type].staticheader.infoFlags, IF_InfoNeeded, (bool8)(size_t)dataToFillIn);
 }
 static void llExcludeDustCloud(char *directory,char *field,void *dataToFillIn)
 {
@@ -1920,7 +1943,7 @@
     type = StrToDustCloudType(field);
     dbgAssert(type != 0xffffffff);
 
-    bitSetTo(dustcloudStaticInfos[type].staticheader.infoFlags, IF_InfoNeeded, (bool8)dataToFillIn);
+    bitSetTo(dustcloudStaticInfos[type].staticheader.infoFlags, IF_InfoNeeded, (bool8)(size_t)dataToFillIn);
 }
 static void llExcludeGasCloud(char *directory,char *field,void *dataToFillIn)
 {
@@ -1929,7 +1952,7 @@
     type = StrToGasCloudType(field);
     dbgAssert(type != 0xffffffff);
 
-    bitSetTo(gascloudStaticInfos[type].staticheader.infoFlags, IF_InfoNeeded, (bool8)dataToFillIn);
+    bitSetTo(gascloudStaticInfos[type].staticheader.infoFlags, IF_InfoNeeded, (bool8)(size_t)dataToFillIn);
 }
 static void llExcludeNebula(char *directory,char *field,void *dataToFillIn)
 {
@@ -1938,24 +1961,24 @@
     type = StrToNebulaType(field);
     dbgAssert(type != 0xffffffff);
 
-    bitSetTo(nebulaStaticInfos[type].staticheader.infoFlags, IF_InfoNeeded, (bool8)dataToFillIn);
+    bitSetTo(nebulaStaticInfos[type].staticheader.infoFlags, IF_InfoNeeded, (bool8)(size_t)dataToFillIn);
 }
 static void llExcludeDerelict(char *directory,char *field,void *dataToFillIn)
 {
     DerelictType type;
 
-    if (_stricmp(field, "ALL") == 0)
+    if (strcasecmp(field, "ALL") == 0)
     {                                                       //if we should do this to all ships for this race
         for (type = 0; type < NUM_DERELICTTYPES; type++)
         {
-            bitSetTo(derelictStaticInfos[type].staticheader.infoFlags, IF_InfoNeeded, (bool8)dataToFillIn);
+            bitSetTo(derelictStaticInfos[type].staticheader.infoFlags, IF_InfoNeeded, (bool8)(size_t)dataToFillIn);
         }
     }
     else
     {
         type = StrToDerelictType(field);
         dbgAssert(type != 0xffffffff);
-        bitSetTo(derelictStaticInfos[type].staticheader.infoFlags, IF_InfoNeeded, (bool8)dataToFillIn);
+        bitSetTo(derelictStaticInfos[type].staticheader.infoFlags, IF_InfoNeeded, (bool8)(size_t)dataToFillIn);
     }
 }
 /*-----------------------------------------------------------------------------
@@ -1981,7 +2004,7 @@
     //parse the race
     string = strtok(field, llDelimiters);
     dbgAssert(string != NULL);
-    if (_stricmp(string, "Derelicts") == 0)
+    if (strcasecmp(string, "Derelicts") == 0)
     {                                                       //if color scheme for a derelict
         string = strtok(NULL, llDelimiters);
         dbgAssert(string != NULL);
@@ -2006,7 +2029,7 @@
     //parse the ship type
     string = strtok(NULL, llDelimiters);
     dbgAssert(string != NULL);
-    if (_stricmp(string, "ALL") == 0)
+    if (strcasecmp(string, "ALL") == 0)
     {                                                       //if we should do this to all ships for this race
         type = 0xffffffff;
     }
diff -urPw homeworld-orig/src/Game/LevelLoad.h homeworld_sdl-0.3/src/Game/LevelLoad.h
--- homeworld-orig/src/Game/LevelLoad.h	2002-09-04 12:46:12.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/LevelLoad.h	2004-08-01 22:35:18.000000000 -0700
@@ -2,8 +2,8 @@
 #ifndef ___LEVELLOAD_H
 #define ___LEVELLOAD_H
 
-#include "types.h"
-#include "objtypes.h"
+#include "Types.h"
+#include "ObjTypes.h"
 
 /*=============================================================================
     Functions:
diff -urPw homeworld-orig/src/Game/LilOptions.h homeworld_sdl-0.3/src/Game/LilOptions.h
--- homeworld-orig/src/Game/LilOptions.h	2002-09-04 12:46:12.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/LilOptions.h	2004-08-01 22:35:24.000000000 -0700
@@ -9,7 +9,7 @@
 #ifndef _LILOPTIONS_H
 #define _LILOPTIONS_H
 
-#include "types.h"
+#include "Types.h"
 
 extern udword opDeviceCRC;
 extern sdword opDeviceIndex;
diff -urPw homeworld-orig/src/Game/LinkedList.c homeworld_sdl-0.3/src/Game/LinkedList.c
--- homeworld-orig/src/Game/LinkedList.c	2002-09-04 12:46:12.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/LinkedList.c	2004-08-01 22:35:19.000000000 -0700
@@ -4,11 +4,11 @@
     Created June 1997 by Gary Shaw
 =============================================================================*/
 
-#include "types.h"
-#include "debug.h"
-#include "linkedlist.h"
-#include "spaceobj.h"
-#include "memory.h"
+#include "Types.h"
+#include "Debug.h"
+#include "LinkedList.h"
+#include "SpaceObj.h"
+#include "Memory.h"
 
 /*=============================================================================
     Private Macros:
diff -urPw homeworld-orig/src/Game/LinkedList.h homeworld_sdl-0.3/src/Game/LinkedList.h
--- homeworld-orig/src/Game/LinkedList.h	2002-09-04 12:46:12.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/LinkedList.h	2004-08-01 22:35:19.000000000 -0700
@@ -7,8 +7,8 @@
 #ifndef ___LINKEDLIST
 #define ___LINKEDLIST
 
-#include "types.h"
-#include "linkedlist.h"
+#include "Types.h"
+#include "LinkedList.h"
 
 /*=============================================================================
     Switches:
@@ -58,16 +58,16 @@
 =============================================================================*/
 
 #define ClearNode(node)                     \
-        node##.next = NULL;                 \
-        node##.prev = NULL;                 \
-        node##.belongto = NULL;             \
-        node##.structptr = NULL
+        (node).next = NULL;                 \
+        (node).prev = NULL;                 \
+        (node).belongto = NULL;             \
+        (node).structptr = NULL
 
 #define ClearNodePtr(node)                  \
-        node##->next = NULL;                \
-        node##->prev = NULL;                \
-        node##->belongto = NULL;            \
-        node##->structptr = NULL
+        (node)->next = NULL;                \
+        (node)->prev = NULL;                \
+        (node)->belongto = NULL;            \
+        (node)->structptr = NULL
 
 #if LL_ANAL_CHECKING
 #define listVerify(list)    listVerifyAnal(list)
diff -urPw homeworld-orig/src/Game/LOD.c homeworld_sdl-0.3/src/Game/LOD.c
--- homeworld-orig/src/Game/LOD.c	2002-09-04 12:46:12.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/LOD.c	2004-08-01 22:35:35.000000000 -0700
@@ -9,13 +9,15 @@
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
-#include "types.h"
-#include "statscript.h"
-#include "memory.h"
-#include "spaceobj.h"
-#include "debug.h"
-#include "file.h"
-#include "key.h"
+#include <ctype.h>
+#include <limits.h>
+#include "Types.h"
+#include "StatScript.h"
+#include "Memory.h"
+#include "SpaceObj.h"
+#include "Debug.h"
+#include "File.h"
+#include "Key.h"
 #include "texreg.h"
 #include "LOD.h"
 
@@ -136,7 +138,7 @@
     info->nLevels = index;                                  //store number of levels
 #if LOD_AUTO_SAVE
     {
-        char partialName[_MAX_PATH];
+        char partialName[PATH_MAX];
         char *fullName;
         sprintf(partialName, "%s%s", directory, fileName);
         fullName = filePathPrepend(partialName, 0);
@@ -173,13 +175,16 @@
 static void lodTypeRead(char *directory,char *field,void *dataToFillIn)
 {                                                           //set correct LOD type
     lod *dest;
+    unsigned int i;
 
     dest = (lod *)dataToFillIn;
 #if LOD_AUTO_SAVE
     dest->baseScalar = (trBaseColorScalar == 0.0f) ? 1.0f : trBaseColorScalar;
     dest->stripeScalar = (trStripeColorScalar == 0.0f) ? 1.0f : trStripeColorScalar;
 #endif
-    _strupr(field);
+    /*_strupr(field);*/
+    for (i = 0; (field[i] = toupper(field[i])); i++) { }
+
     if (strstr(field, "INVALID"))
     {
         dest->flags = (udword)((dest->flags & (~LM_LODType)) | LT_Invalid);
@@ -331,7 +336,6 @@
 lod* lodPanicLevelGet(void* spaceObj, vector* camera, vector* ship)
 {
     SpaceObj* obj = (SpaceObj*)spaceObj;
-    lod* LOD = lodLevelGet(spaceObj, camera, ship);
     lodinfo* info = obj->staticinfo->staticheader.LOD;
 
     if (obj->currentLOD == 3)
@@ -445,9 +449,21 @@
     sdword level;
     FILE *fp;
     char *filePath;
+    char *lodFileNameFull;
     real32 baseScalar = 1.0f, stripeScalar = 1.0f;
 
-    fp = fopen(LOD->fileName, "wt");
+    lodFileNameFull = filePathPrepend(LOD->fileName, FF_UserSettingsPath);
+
+    if (!fileMakeDestinationDirectory(lodFileNameFull))
+    {
+        dbgWarningf(
+            DBG_Loc,
+            "Cannot create destination directory for file '%s'.",
+            LOD->fileName);
+        return ERROR;
+    }
+
+    fp = fopen(lodFileNameFull, "wt");
     if (fp == NULL)
     {
         dbgWarningf(DBG_Loc, "Cannot open '%s' for writing - not checked out?", LOD->fileName);
@@ -472,7 +488,11 @@
         fprintf(fp, "type%d                       %s\n", level, lodTypeStrings[LOD->level[level].flags & LM_LODType]);
         if ((LOD->level[level].flags & LM_LODType) == LT_Mesh)
         {
+#ifdef _WIN32
             filePath = strchr(((meshdata *)LOD->level[level].pData)->fileName, '\\') + 1;
+#else
+            filePath = strpbrk(((meshdata *)LOD->level[level].pData)->fileName, "\\/") + 1;
+#endif
 #if LOD_ERROR_CHECKING
             if (*filePath == 0)
             {
diff -urPw homeworld-orig/src/Game/LOD.h homeworld_sdl-0.3/src/Game/LOD.h
--- homeworld-orig/src/Game/LOD.h	2002-09-04 12:46:12.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/LOD.h	2004-08-01 22:35:36.000000000 -0700
@@ -9,10 +9,10 @@
 #ifndef ___LOD_H
 #define ___LOD_H
 
-#include "types.h"
+#include "Types.h"
 #include "color.h"
-#include "mesh.h"
-#include "matrix.h"
+#include "Mesh.h"
+#include "Matrix.h"
 
 /*=============================================================================
     Switches
diff -urPw homeworld-orig/src/Game/LZSS.c homeworld_sdl-0.3/src/Game/LZSS.c
--- homeworld-orig/src/Game/LZSS.c	2002-09-04 12:46:12.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/LZSS.c	2004-08-01 22:35:37.000000000 -0700
@@ -71,12 +71,12 @@
 } tree[ WINDOW_SIZE + 1 ];
 
 // local prototypes
-void InitTree( int r );
-void ContractNode( int old_node, int new_node );
-void ReplaceNode( int old_node, int new_node );
-int FindNextNode( int node );
-void DeleteString( int p );
-int AddString( int new_node, int *match_position );
+static void InitTree( int r );
+static void ContractNode( int old_node, int new_node );
+static void ReplaceNode( int old_node, int new_node );
+static int FindNextNode( int node );
+static void DeleteString( int p );
+static int AddString( int new_node, int *match_position );
 
 /*
  * Since the tree is static data, it comes up with every node
@@ -436,7 +436,6 @@
     int match_position;
     BIT_BUFFER *inBuffer;
     char *outBuffer = output;
-    int size = 0;
  
     inBuffer = bitioBufferOpen(input);
 
@@ -483,7 +482,6 @@
     int match_length;
     int match_position;
     char *outBuffer = output;
-    int size = 0;
  
     current_position = 1;
     for ( ; ; ) {
diff -urPw homeworld-orig/src/Game/MadLinkIn.c homeworld_sdl-0.3/src/Game/MadLinkIn.c
--- homeworld-orig/src/Game/MadLinkIn.c	2002-09-04 12:46:12.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/MadLinkIn.c	2004-08-01 22:35:32.000000000 -0700
@@ -7,19 +7,19 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-//#include "meshanim.h"
+//#include "MeshAnim.h"
 #include <stdlib.h>
 
-#include "debug.h"
-#include "commandlayer.h"
-#include "universe.h"
-#include "spaceobj.h"
-#include "madLinkIn.h"
-#include "madLinkInDefs.h"
-#include "types.h"
-#include "mothership.h"
-#include "randy.h"
-#include "soundevent.h"
+#include "Debug.h"
+#include "CommandLayer.h"
+#include "Universe.h"
+#include "SpaceObj.h"
+#include "MadLinkIn.h"
+#include "MadLinkInDefs.h"
+#include "Types.h"
+#include "Mothership.h"
+#include "Randy.h"
+#include "SoundEvent.h"
 
 #ifdef bpasechn
     #define DEBUG_MESH_ANIMATIONS
diff -urPw homeworld-orig/src/Game/MadLinkIn.h homeworld_sdl-0.3/src/Game/MadLinkIn.h
--- homeworld-orig/src/Game/MadLinkIn.h	2002-09-04 12:46:12.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/MadLinkIn.h	2004-08-01 22:35:32.000000000 -0700
@@ -7,7 +7,7 @@
 =============================================================================*/
 
 
-#include "commandlayer.h"
+#include "CommandLayer.h"
 
 
 //prototypes
diff -urPw homeworld-orig/src/Game/Matrix.c homeworld_sdl-0.3/src/Game/Matrix.c
--- homeworld-orig/src/Game/Matrix.c	2002-09-04 12:46:14.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Matrix.c	2004-08-01 22:35:35.000000000 -0700
@@ -5,8 +5,8 @@
 =============================================================================*/
 
 #include <stdio.h>
-#include "types.h"
-#include "matrix.h"
+#include "Types.h"
+#include "Matrix.h"
 
 
 
@@ -22,9 +22,17 @@
 
 #define FPTR    DWORD PTR
 #define FSIZE   4
+#define FSIZE_STR "4"
+
+#if defined (_MSC_VER)
 #define SOURCE  esi
 #define DEST    ebx
 #define MATRIX  edi
+#elif defined (__GNUC__) && defined (__i386__)
+#define SOURCE  "%%esi"
+#define DEST    "%%ebx"
+#define MATRIX  "%%edi"
+#endif
 
 
 /*=============================================================================
@@ -369,7 +377,7 @@
 ----------------------------------------------------------------------------*/
 void matMultiplyMatByMat(matrix *result,matrix *first,matrix *second)
 {
-#if 1
+#if defined (_MSC_VER)
     static real32* c;
     static real32* a;
     static real32* b;
@@ -436,6 +444,56 @@
         pop       esi
         pop       edi
     }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ (
+        "    pushl     %%ebp\n"
+        "    movl      $-3, %%eax\n"
+        "    jmp       mat_x_mat_l1\n"
+        "    .align    4\n"
+        "mat_x_mat_l2:\n"
+        "    fstps     32(%%ebx, %%eax, "FSIZE_STR")\n"
+        "mat_x_mat_l1:\n"
+        "    flds      36(%%ecx, %%eax, "FSIZE_STR")\n"
+        "    fmuls     8(%%edx)\n"
+        "    flds      (%%edx)\n"
+        "    fmuls     12(%%ecx, %%eax, "FSIZE_STR")\n"
+        "    faddp     %%st, %%st(1)\n"
+        "    flds      4(%%edx)\n"
+        "    fmuls     24(%%ecx, %%eax, "FSIZE_STR")\n"
+        "    faddp     %%st, %%st(1)\n"
+        "    movl      12(%%ecx, %%eax, "FSIZE_STR"), %%ebp\n"
+        "    movl      24(%%ecx, %%eax, "FSIZE_STR"), %%esi\n"
+        "    flds      24(%%ecx, %%eax, "FSIZE_STR")\n"
+        "    flds      24(%%ecx, %%eax, "FSIZE_STR")\n"
+        "    flds      12(%%ecx, %%eax, "FSIZE_STR")\n"
+        "    flds      12(%%ecx, %%eax, "FSIZE_STR")\n"
+        "    flds      36(%%ecx, %%eax, "FSIZE_STR")\n"
+        "    flds      36(%%ecx, %%eax, "FSIZE_STR")\n"
+        "    fxch      %%st(6)\n"
+        "    movl      36(%%ecx, %%eax, "FSIZE_STR"), %%edi\n"
+        "    fstps     12(%%ebx, %%eax, "FSIZE_STR")\n"
+        "    fmuls     20(%%edx)\n"
+        "    fxch      %%st(4)\n"
+        "    fmuls     16(%%edx)\n"
+        "    faddp     %%st, %%st(4)\n"
+        "    fxch      %%st(1)\n"
+        "    fmuls     12(%%edx)\n"
+        "    faddp     %%st, %%st(3)\n"
+        "    fxch      %%st(2)\n"
+        "    fstps     24(%%ebx, %%eax, "FSIZE_STR")\n"
+        "    fmuls     28(%%edx)\n"
+        "    fxch      %%st(2)\n"
+        "    fmuls     32(%%edx)\n"
+        "    faddp     %%st, %%st(2)\n"
+        "    fmuls     24(%%edx)\n"
+        "    faddp     %%st, %%st(1)\n"
+        "    incl      %%eax\n"
+        "    jne       mat_x_mat_l2\n"
+        "    fstps     32(%%ebx, %%eax, "FSIZE_STR")\n"
+        "    popl      %%ebp\n"
+        :
+        : "b" (result), "c" (first), "d" (second)
+        : "eax", "edi", "esi" );
 #else
 #define A(row,col) a[3*col+row]
 #define B(row,col) b[3*col+row]
@@ -470,11 +528,7 @@
 ----------------------------------------------------------------------------*/
 void matMultiplyMatByVec(vector *result,matrix *matrix,vector *vector)
 {
-#if 0
-    result->x = matrixdot(matrix->m11,matrix->m12,matrix->m13,vector->x,vector->y,vector->z);
-    result->y = matrixdot(matrix->m21,matrix->m22,matrix->m23,vector->x,vector->y,vector->z);
-    result->z = matrixdot(matrix->m31,matrix->m32,matrix->m33,vector->x,vector->y,vector->z);
-#else
+#if defined (_MSC_VER)
     real32* dest = (real32*)result;
     real32* source = (real32*)vector;
     real32* mat = (real32*)matrix;
@@ -539,6 +593,59 @@
         pop     edi
         pop     esi
     }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ (
+        "    flds    0*"FSIZE_STR"("SOURCE")\n"               /*s0*/
+        "    fmuls   (0+0*3)*"FSIZE_STR"("MATRIX")\n"         /*a0*/
+        "    flds    1*"FSIZE_STR"("SOURCE")\n"               /*s1 a0*/
+        "    fmuls   (0+1*3)*"FSIZE_STR"("MATRIX")\n"         /*a1 a0*/
+        "    flds    2*"FSIZE_STR"("SOURCE")\n"               /*s2 a1 a0*/
+        "    fmuls   (0+2*3)*"FSIZE_STR"("MATRIX")\n"         /*a2 a1 a0*/
+
+        "    fxch    %%st(1)\n"                               /*a1 a2 a0*/
+        "    faddp   %%st, %%st(2)\n"                         /*a2 a1+a0*/
+
+        "    flds    0*"FSIZE_STR"("SOURCE")\n"               /*s0 a2 a1+a0*/
+        "    fmuls   (1+0*3)*"FSIZE_STR"("MATRIX")\n"         /*b0 a2 a1+a0*/
+
+        "    fxch    %%st(1)\n"                               /*a2 b0 a1+a0*/
+        "    faddp   %%st, %%st(2)\n"                         /*b0 d0*/
+
+        "    flds    1*"FSIZE_STR"("SOURCE")\n"               /*s1 b0 d0*/
+        "    fmuls   (1+1*3)*"FSIZE_STR"("MATRIX")\n"         /*b1 b0 d0*/
+        "    flds    2*"FSIZE_STR"("SOURCE")\n"               /*s2 b1 b0 d0*/
+        "    fmuls   (1+2*3)*"FSIZE_STR"("MATRIX")\n"         /*b2 b1 b0 d0*/
+
+        "    fxch    %%st(1)\n"                               /*b1 b2 b0 d0*/
+        "    faddp   %%st, %%st(1)\n"                         /*b1+b2 b0 d0*/
+
+        "    flds    0*"FSIZE_STR"("SOURCE")\n"               /*s0 b1+b2 b0 d0*/
+        "    fmuls   (2+0*3)*"FSIZE_STR"("MATRIX")\n"         /*c0 b1+b2 b0 d0*/
+
+        "    fxch    %%st(1)\n"                               /*b1+b2 c0 b0 d0*/
+        "    faddp   %%st, %%st(2)\n"                         /*c0 d1 d0*/
+
+        "    flds    1*"FSIZE_STR"("SOURCE")\n"               /*s1 c0 d1 d0*/
+        "    fmuls   (2+1*3)*"FSIZE_STR"("MATRIX")\n"         /*c1 c0 d1 d0*/
+        "    flds    2*"FSIZE_STR"("SOURCE")\n"               /*s2 c1 c0 d1 d0*/
+        "    fmuls   (2+2*3)*"FSIZE_STR"("MATRIX")\n"         /*c2 c1 c0 d1 d0*/
+
+        "    fxch    %%st(1)\n"                               /*c1 c2 c0 d1 d0*/
+        "    faddp   %%st, %%st(1)\n"                         /*c1+c2 c0 d1 d0*/
+
+        "    fxch    %%st(2)\n"                               /*d1 c0 c1+c2 d0*/
+        "    fstps   1*"FSIZE_STR"("DEST")\n"                 /*c0 c1+c2 d0*/
+        "    fxch    %%st(1)\n"                               /*c1+c2 c0 d0*/
+        "    faddp   %%st, %%st(1)\n"                         /*d2 d0*/
+        "    fxch    %%st(1)\n"                               /*d0 d2*/
+        "    fstps   0*"FSIZE_STR"("DEST")\n"                 /*d2*/
+        "    fstps   2*"FSIZE_STR"("DEST")\n"
+        :
+        : "S" (vector), "b" (result), "D" (matrix) );
+#else
+    result->x = matrixdot(matrix->m11,matrix->m12,matrix->m13,vector->x,vector->y,vector->z);
+    result->y = matrixdot(matrix->m21,matrix->m22,matrix->m23,vector->x,vector->y,vector->z);
+    result->z = matrixdot(matrix->m31,matrix->m32,matrix->m33,vector->x,vector->y,vector->z);
 #endif
 }
 
@@ -552,11 +659,7 @@
 ----------------------------------------------------------------------------*/
 void matMultiplyVecByMat(vector *result,vector *vector,matrix *matrix)
 {
-#if 0
-    result->x = matrixdot(vector->x,vector->y,vector->z,matrix->m11,matrix->m21,matrix->m31);
-    result->y = matrixdot(vector->x,vector->y,vector->z,matrix->m12,matrix->m22,matrix->m32);
-    result->z = matrixdot(vector->x,vector->y,vector->z,matrix->m13,matrix->m23,matrix->m33);
-#else
+#if defined (_MSC_VER)
     real32* dest = (real32*)result;
     real32* source = (real32*)vector;
     real32* mat = (real32*)matrix;
@@ -621,6 +724,59 @@
         pop     edi
         pop     esi
     }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ (
+        "    flds    0*"FSIZE_STR"("SOURCE")\n"               /*s0*/
+        "    fmuls   (0+0*3)*"FSIZE_STR"("MATRIX")\n"         /*a0*/
+        "    flds    1*"FSIZE_STR"("SOURCE")\n"               /*s1 a0*/
+        "    fmuls   (1+0*3)*"FSIZE_STR"("MATRIX")\n"         /*a1 a0*/
+        "    flds    2*"FSIZE_STR"("SOURCE")\n"               /*s2 a1 a0*/
+        "    fmuls   (2+0*3)*"FSIZE_STR"("MATRIX")\n"         /*a2 a1 a0*/
+
+        "    fxch    %%st(1)\n"                               /*a1 a2 a0*/
+        "    faddp   %%st, %%st(2)\n"                         /*a2 a1+a0*/
+
+        "    flds    0*"FSIZE_STR"("SOURCE")\n"               /*s0 a2 a1+a0*/
+        "    fmuls   (0+1*3)*"FSIZE_STR"("MATRIX")\n"         /*b0 a2 a1+a0*/
+
+        "    fxch    %%st(1)\n"                               /*a2 b0 a1+a0*/
+        "    faddp   %%st, %%st(2)\n"                         /*b0 d0*/
+
+        "    flds    1*"FSIZE_STR"("SOURCE")\n"               /*s1 b0 d0*/
+        "    fmuls   (1+1*3)*"FSIZE_STR"("MATRIX")\n"         /*b1 b0 d0*/
+        "    flds    2*"FSIZE_STR"("SOURCE")\n"               /*s2 b1 b0 d0*/
+        "    fmuls   (2+1*3)*"FSIZE_STR"("MATRIX")\n"         /*b2 b1 b0 d0*/
+
+        "    fxch    %%st(1)\n"                               /*b1 b2 b0 d0*/
+        "    faddp   %%st, %%st(1)\n"                         /*b1+b2 b0 d0*/
+
+        "    flds    0*"FSIZE_STR"("SOURCE")\n"               /*s0 b1+b2 b0 d0*/
+        "    fmuls   (0+2*3)*"FSIZE_STR"("MATRIX")\n"         /*c0 b1+b2 b0 d0*/
+
+        "    fxch    %%st(1)\n"                               /*b1+b2 c0 b0 d0*/
+        "    faddp   %%st, %%st(2)\n"                         /*c0 d1 d0*/
+
+        "    flds    1*"FSIZE_STR"("SOURCE")\n"               /*s1 c0 d1 d0*/
+        "    fmuls   (1+2*3)*"FSIZE_STR"("MATRIX")\n"         /*c1 c0 d1 d0*/
+        "    flds    2*"FSIZE_STR"("SOURCE")\n"               /*s2 c1 c0 d1 d0*/
+        "    fmuls   (2+2*3)*"FSIZE_STR"("MATRIX")\n"         /*c2 c1 c0 d1 d0*/
+
+        "    fxch    %%st(1)\n"                               /*c1 c2 c0 d1 d0*/
+        "    faddp   %%st, %%st(1)\n"                         /*c1+c2 c0 d1 d0*/
+
+        "    fxch    %%st(2)\n"                               /*d1 c0 c1+c2 d0*/
+        "    fstps   1*"FSIZE_STR"("DEST")\n"                 /*c0 c1+c2 d0*/
+        "    fxch    %%st(1)\n"                               /*c1+c2 c0 d0*/
+        "    faddp   %%st, %%st(1)\n"                         /*d2 d0*/
+        "    fxch    %%st(1)\n"                               /*d0 d2*/
+        "    fstps   0*"FSIZE_STR"("DEST")\n"                 /*d2*/
+        "    fstps   2*"FSIZE_STR"("DEST")\n"
+        :
+        : "S" (vector), "b" (result), "D" (matrix) );
+#else
+    result->x = matrixdot(vector->x,vector->y,vector->z,matrix->m11,matrix->m21,matrix->m31);
+    result->y = matrixdot(vector->x,vector->y,vector->z,matrix->m12,matrix->m22,matrix->m32);
+    result->z = matrixdot(vector->x,vector->y,vector->z,matrix->m13,matrix->m23,matrix->m33);
 #endif
 }
 
diff -urPw homeworld-orig/src/Game/Matrix.h homeworld_sdl-0.3/src/Game/Matrix.h
--- homeworld-orig/src/Game/Matrix.h	2002-09-04 12:46:14.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Matrix.h	2004-08-01 22:35:35.000000000 -0700
@@ -7,8 +7,8 @@
 #ifndef ___MATRIX_H
 #define ___MATRIX_H
 
-#include "types.h"
-#include "vector.h"
+#include "Types.h"
+#include "Vector.h"
 
 /*=============================================================================
     Type definitions:
@@ -65,134 +65,134 @@
 =============================================================================*/
 
 #define hmatGetHVectFromHMatrixCol1(hvec,hmat)   \
-    (hvec)##.x = (hmat)##.m11;              \
-    (hvec)##.y = (hmat)##.m21;              \
-    (hvec)##.z = (hmat)##.m31;              \
-    (hvec)##.w = (hmat)##.m41
+    (hvec).x = (hmat).m11;              \
+    (hvec).y = (hmat).m21;              \
+    (hvec).z = (hmat).m31;              \
+    (hvec).w = (hmat).m41
 
 #define hmatGetHVectFromHMatrixCol2(hvec,hmat)   \
-    (hvec)##.x = (hmat)##.m12;              \
-    (hvec)##.y = (hmat)##.m22;              \
-    (hvec)##.z = (hmat)##.m32;              \
-    (hvec)##.w = (hmat)##.m42
+    (hvec).x = (hmat).m12;              \
+    (hvec).y = (hmat).m22;              \
+    (hvec).z = (hmat).m32;              \
+    (hvec).w = (hmat).m42
 
 #define hmatGetHVectFromHMatrixCol3(hvec,hmat)   \
-    (hvec)##.x = (hmat)##.m13;              \
-    (hvec)##.y = (hmat)##.m23;              \
-    (hvec)##.z = (hmat)##.m33;              \
-    (hvec)##.w = (hmat)##.m43
+    (hvec).x = (hmat).m13;              \
+    (hvec).y = (hmat).m23;              \
+    (hvec).z = (hmat).m33;              \
+    (hvec).w = (hmat).m43
 
 #define hmatGetHVectFromHMatrixCol4(hvec,hmat)   \
-    (hvec)##.x = (hmat)##.m14;              \
-    (hvec)##.y = (hmat)##.m24;              \
-    (hvec)##.z = (hmat)##.m34;              \
-    (hvec)##.w = (hmat)##.m44
+    (hvec).x = (hmat).m14;              \
+    (hvec).y = (hmat).m24;              \
+    (hvec).z = (hmat).m34;              \
+    (hvec).w = (hmat).m44
 
 /*---------------------------------------------------------------------------*/
 
 #define hmatPutHVectIntoHMatrixCol1(hvec,hmat)    \
-    (hmat)##.m11 = (hvec)##.x;              \
-    (hmat)##.m21 = (hvec)##.y;              \
-    (hmat)##.m31 = (hvec)##.z;              \
-    (hmat)##.m41 = (hvec)##.w
+    (hmat).m11 = (hvec).x;              \
+    (hmat).m21 = (hvec).y;              \
+    (hmat).m31 = (hvec).z;              \
+    (hmat).m41 = (hvec).w
 
 #define hmatPutHVectIntoHMatrixCol2(hvec,hmat)    \
-    (hmat)##.m12 = (hvec)##.x;              \
-    (hmat)##.m22 = (hvec)##.y;              \
-    (hmat)##.m32 = (hvec)##.z;              \
-    (hmat)##.m42 = (hvec)##.w
+    (hmat).m12 = (hvec).x;              \
+    (hmat).m22 = (hvec).y;              \
+    (hmat).m32 = (hvec).z;              \
+    (hmat).m42 = (hvec).w
 
 #define hmatPutHVectIntoHMatrixCol3(hvec,hmat)    \
-    (hmat)##.m13 = (hvec)##.x;              \
-    (hmat)##.m23 = (hvec)##.y;              \
-    (hmat)##.m33 = (hvec)##.z;              \
-    (hmat)##.m43 = (hvec)##.w
+    (hmat).m13 = (hvec).x;              \
+    (hmat).m23 = (hvec).y;              \
+    (hmat).m33 = (hvec).z;              \
+    (hmat).m43 = (hvec).w
 
 #define hmatPutHVectIntoHMatrixCol4(hvec,hmat)    \
-    (hmat)##.m14 = (hvec)##.x;              \
-    (hmat)##.m24 = (hvec)##.y;              \
-    (hmat)##.m34 = (hvec)##.z;              \
-    (hmat)##.m44 = (hvec)##.w
+    (hmat).m14 = (hvec).x;              \
+    (hmat).m24 = (hvec).y;              \
+    (hmat).m34 = (hvec).z;              \
+    (hmat).m44 = (hvec).w
 
 /*---------------------------------------------------------------------------*/
 
 #define hmatGetVectFromHMatrixCol1(vec,hmat)  \
-    (vec)##.x = (hmat)##.m11;               \
-    (vec)##.y = (hmat)##.m21;               \
-    (vec)##.z = (hmat)##.m31
+    (vec).x = (hmat).m11;               \
+    (vec).y = (hmat).m21;               \
+    (vec).z = (hmat).m31
 
 #define hmatGetVectFromHMatrixCol2(vec,hmat)  \
-    (vec)##.x = (hmat)##.m12;               \
-    (vec)##.y = (hmat)##.m22;               \
-    (vec)##.z = (hmat)##.m32
+    (vec).x = (hmat).m12;               \
+    (vec).y = (hmat).m22;               \
+    (vec).z = (hmat).m32
 
 #define hmatGetVectFromHMatrixCol3(vec,hmat)  \
-    (vec)##.x = (hmat)##.m13;               \
-    (vec)##.y = (hmat)##.m23;               \
-    (vec)##.z = (hmat)##.m33
+    (vec).x = (hmat).m13;               \
+    (vec).y = (hmat).m23;               \
+    (vec).z = (hmat).m33
 
 #define hmatGetVectFromHMatrixCol4(vec,hmat)  \
-    (vec)##.x = (hmat)##.m14;               \
-    (vec)##.y = (hmat)##.m24;               \
-    (vec)##.z = (hmat)##.m34
+    (vec).x = (hmat).m14;               \
+    (vec).y = (hmat).m24;               \
+    (vec).z = (hmat).m34
 
 /*---------------------------------------------------------------------------*/
 
 #define hmatPutVectIntoHMatrixCol1(vec,hmat)    \
-    (hmat)##.m11 = (vec)##.x;              \
-    (hmat)##.m21 = (vec)##.y;              \
-    (hmat)##.m31 = (vec)##.z;
+    (hmat).m11 = (vec).x;              \
+    (hmat).m21 = (vec).y;              \
+    (hmat).m31 = (vec).z;
 
 #define hmatPutVectIntoHMatrixCol2(vec,hmat)    \
-    (hmat)##.m12 = (vec)##.x;              \
-    (hmat)##.m22 = (vec)##.y;              \
-    (hmat)##.m32 = (vec)##.z;
+    (hmat).m12 = (vec).x;              \
+    (hmat).m22 = (vec).y;              \
+    (hmat).m32 = (vec).z;
 
 #define hmatPutVectIntoHMatrixCol3(vec,hmat)    \
-    (hmat)##.m13 = (vec)##.x;              \
-    (hmat)##.m23 = (vec)##.y;              \
-    (hmat)##.m33 = (vec)##.z;
+    (hmat).m13 = (vec).x;              \
+    (hmat).m23 = (vec).y;              \
+    (hmat).m33 = (vec).z;
 
 #define hmatPutVectIntoHMatrixCol4(vec,hmat)    \
-    (hmat)##.m14 = (vec)##.x;              \
-    (hmat)##.m24 = (vec)##.y;              \
-    (hmat)##.m34 = (vec)##.z;
+    (hmat).m14 = (vec).x;              \
+    (hmat).m24 = (vec).y;              \
+    (hmat).m34 = (vec).z;
 
 /*=============================================================================
     3 X 3 Matrix Macros:
 =============================================================================*/
 
 #define matGetVectFromMatrixCol1(vec,mat)   \
-    (vec)##.x = (mat)##.m11;              \
-    (vec)##.y = (mat)##.m21;              \
-    (vec)##.z = (mat)##.m31;
+    (vec).x = (mat).m11;              \
+    (vec).y = (mat).m21;              \
+    (vec).z = (mat).m31;
 
 #define matGetVectFromMatrixCol2(vec,mat)   \
-    (vec)##.x = (mat)##.m12;              \
-    (vec)##.y = (mat)##.m22;              \
-    (vec)##.z = (mat)##.m32;
+    (vec).x = (mat).m12;              \
+    (vec).y = (mat).m22;              \
+    (vec).z = (mat).m32;
 
 #define matGetVectFromMatrixCol3(vec,mat)   \
-    (vec)##.x = (mat)##.m13;              \
-    (vec)##.y = (mat)##.m23;              \
-    (vec)##.z = (mat)##.m33;
+    (vec).x = (mat).m13;              \
+    (vec).y = (mat).m23;              \
+    (vec).z = (mat).m33;
 
 /*---------------------------------------------------------------------------*/
 
 #define matPutVectIntoMatrixCol1(vec,mat)    \
-    (mat)##.m11 = (vec)##.x;              \
-    (mat)##.m21 = (vec)##.y;              \
-    (mat)##.m31 = (vec)##.z;
+    (mat).m11 = (vec).x;              \
+    (mat).m21 = (vec).y;              \
+    (mat).m31 = (vec).z;
 
 #define matPutVectIntoMatrixCol2(vec,mat)    \
-    (mat)##.m12 = (vec)##.x;              \
-    (mat)##.m22 = (vec)##.y;              \
-    (mat)##.m32 = (vec)##.z;
+    (mat).m12 = (vec).x;              \
+    (mat).m22 = (vec).y;              \
+    (mat).m32 = (vec).z;
 
 #define matPutVectIntoMatrixCol3(vec,mat)    \
-    (mat)##.m13 = (vec)##.x;              \
-    (mat)##.m23 = (vec)##.y;              \
-    (mat)##.m33 = (vec)##.z;
+    (mat).m13 = (vec).x;              \
+    (mat).m23 = (vec).y;              \
+    (mat).m33 = (vec).z;
 
 
 /*=============================================================================
diff -urPw homeworld-orig/src/Game/Matrix-mult.c homeworld_sdl-0.3/src/Game/Matrix-mult.c
--- homeworld-orig/src/Game/Matrix-mult.c	1969-12-31 16:00:00.000000000 -0800
+++ homeworld_sdl-0.3/src/Game/Matrix-mult.c	2004-08-01 22:35:24.000000000 -0700
@@ -0,0 +1,174 @@
+/*=============================================================================
+    Matrix-mult.C: 3x3 matrix multiply by 3x3 matrix (to avoid being inlined in
+                   Matrix.c when compiling optimized code in GCC, thus
+                   duplicating the line labels).
+=============================================================================*/
+
+#include <stdio.h>
+#include "Types.h"
+#include "Matrix.h"
+
+#define FPTR    DWORD PTR
+#define FSIZE   4
+#define FSIZE_STR "4"
+
+#if defined (_MSC_VER)
+#define SOURCE  esi
+#define DEST    ebx
+#define MATRIX  edi
+#elif defined (__GNUC__) && defined (__i386__)
+#define SOURCE  "%%esi"
+#define DEST    "%%ebx"
+#define MATRIX  "%%edi"
+#endif
+
+/*-----------------------------------------------------------------------------
+    Name        : matMultiplyMatByMat
+    Description : result = first * second, where matrices are 3 X 3
+    Inputs      : first,second
+    Outputs     : result
+    Return      :
+    Warning     : result cannot be the same matrix as first or second.
+----------------------------------------------------------------------------*/
+void matMultiplyMatByMat(matrix *result,matrix *first,matrix *second)
+{
+#if defined (_MSC_VER)
+    static real32* c;
+    static real32* a;
+    static real32* b;
+
+    c = (real32*)result;
+    a = (real32*)first;
+    b = (real32*)second;
+
+    __asm
+    {
+        push      edi
+        push      esi
+        push      ebp
+        push      ebx
+        mov       ebx, FPTR [c]
+        mov       ecx, FPTR [a]
+        mov       edx, FPTR [b]
+        mov       eax, -3
+        jmp       l1
+        align     4
+    l2:
+        fstp      FPTR [ebx+eax*FSIZE+32]
+    l1:
+        fld       FPTR [ecx+eax*FSIZE+36]
+        fmul      FPTR [edx+8]
+        fld       FPTR [edx]
+        fmul      FPTR [ecx+eax*FSIZE+12]
+        faddp     st(1), st
+        fld       FPTR [edx+4]
+        fmul      FPTR [ecx+eax*FSIZE+24]
+        faddp     st(1), st
+        mov       ebp, FPTR [ecx+eax*FSIZE+12]
+        mov       esi, FPTR [ecx+eax*FSIZE+24]
+        fld       FPTR [ecx+eax*FSIZE+24]
+        fld       FPTR [ecx+eax*FSIZE+24]
+        fld       FPTR [ecx+eax*FSIZE+12]
+        fld       FPTR [ecx+eax*FSIZE+12]
+        fld       FPTR [ecx+eax*FSIZE+36]
+        fld       FPTR [ecx+eax*FSIZE+36]
+        fxch      st(6)
+        mov       edi, FPTR [ecx+eax*FSIZE+36]
+        fstp      FPTR [ebx+eax*FSIZE+12]
+        fmul      FPTR [edx+20]
+        fxch      st(4)
+        fmul      FPTR [edx+16]
+        faddp     st(4), st
+        fxch      st(1)
+        fmul      FPTR [edx+12]
+        faddp     st(3), st
+        fxch      st(2)
+        fstp      FPTR [ebx+eax*FSIZE+24]
+        fmul      FPTR [edx+28]
+        fxch      st(2)
+        fmul      FPTR [edx+32]
+        faddp     st(2), st
+        fmul      FPTR [edx+24]
+        faddp     st(1), st
+        inc       eax
+        jne       l2
+        fstp      FPTR [ebx+eax*FSIZE+32]
+
+        pop       ebx
+        pop       ebp
+        pop       esi
+        pop       edi
+    }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ (
+        "    pushl     %%ebp\n"
+        "    movl      $-3, %%eax\n"
+        "    jmp       mat_x_mat_l1\n"
+        "    .align    4\n"
+        "mat_x_mat_l2:\n"
+        "    fstps     32(%%ebx, %%eax, "FSIZE_STR")\n"
+        "mat_x_mat_l1:\n"
+        "    flds      36(%%ecx, %%eax, "FSIZE_STR")\n"
+        "    fmuls     8(%%edx)\n"
+        "    flds      (%%edx)\n"
+        "    fmuls     12(%%ecx, %%eax, "FSIZE_STR")\n"
+        "    faddp     %%st, %%st(1)\n"
+        "    flds      4(%%edx)\n"
+        "    fmuls     24(%%ecx, %%eax, "FSIZE_STR")\n"
+        "    faddp     %%st, %%st(1)\n"
+        "    movl      12(%%ecx, %%eax, "FSIZE_STR"), %%ebp\n"
+        "    movl      24(%%ecx, %%eax, "FSIZE_STR"), %%esi\n"
+        "    flds      24(%%ecx, %%eax, "FSIZE_STR")\n"
+        "    flds      24(%%ecx, %%eax, "FSIZE_STR")\n"
+        "    flds      12(%%ecx, %%eax, "FSIZE_STR")\n"
+        "    flds      12(%%ecx, %%eax, "FSIZE_STR")\n"
+        "    flds      36(%%ecx, %%eax, "FSIZE_STR")\n"
+        "    flds      36(%%ecx, %%eax, "FSIZE_STR")\n"
+        "    fxch      %%st(6)\n"
+        "    movl      36(%%ecx, %%eax, "FSIZE_STR"), %%edi\n"
+        "    fstps     12(%%ebx, %%eax, "FSIZE_STR")\n"
+        "    fmuls     20(%%edx)\n"
+        "    fxch      %%st(4)\n"
+        "    fmuls     16(%%edx)\n"
+        "    faddp     %%st, %%st(4)\n"
+        "    fxch      %%st(1)\n"
+        "    fmuls     12(%%edx)\n"
+        "    faddp     %%st, %%st(3)\n"
+        "    fxch      %%st(2)\n"
+        "    fstps     24(%%ebx, %%eax, "FSIZE_STR")\n"
+        "    fmuls     28(%%edx)\n"
+        "    fxch      %%st(2)\n"
+        "    fmuls     32(%%edx)\n"
+        "    faddp     %%st, %%st(2)\n"
+        "    fmuls     24(%%edx)\n"
+        "    faddp     %%st, %%st(1)\n"
+        "    incl      %%eax\n"
+        "    jne       mat_x_mat_l2\n"
+        "    fstps     32(%%ebx, %%eax, "FSIZE_STR")\n"
+        "    popl      %%ebp\n"
+        :
+        : "b" (result), "c" (first), "d" (second)
+        : "eax", "edi", "esi" );
+#else
+#define A(row,col) a[3*col+row]
+#define B(row,col) b[3*col+row]
+#define P(row,col) c[3*col+row]
+    real32 *c = (real32*)result;
+    real32 *a = (real32*)first;
+    real32 *b = (real32*)second;
+    real32 ai0, ai1, ai2;
+    sdword i;
+    for (i = 0; i < 3; i++)
+    {
+        ai0 = A(i,0);
+        ai1 = A(i,1);
+        ai2 = A(i,2);
+        P(i,0) = ai0 * B(0,0) + ai1 * B(1,0) + ai2 * B(2,0);
+        P(i,1) = ai0 * B(0,1) + ai1 * B(1,1) + ai2 * B(2,1);
+        P(i,2) = ai0 * B(0,2) + ai1 * B(1,2) + ai2 * B(2,2);
+    }
+#undef A
+#undef B
+#undef P
+#endif
+}
diff -urPw homeworld-orig/src/Game/Matrix.s homeworld_sdl-0.3/src/Game/Matrix.s
--- homeworld-orig/src/Game/Matrix.s	1969-12-31 16:00:00.000000000 -0800
+++ homeworld_sdl-0.3/src/Game/Matrix.s	2004-08-01 22:35:36.000000000 -0700
@@ -0,0 +1,1352 @@
+	.file	"Matrix.c"
+.globl IdentityHMatrix
+	.section	.rodata
+	.align 32
+	.type	IdentityHMatrix, @object
+	.size	IdentityHMatrix, 64
+IdentityHMatrix:
+	.long	1065353216
+	.long	0
+	.long	0
+	.long	0
+	.long	0
+	.long	1065353216
+	.long	0
+	.long	0
+	.long	0
+	.long	0
+	.long	1065353216
+	.long	0
+	.long	0
+	.long	0
+	.long	0
+	.long	1065353216
+.globl IdentityMatrix
+	.align 32
+	.type	IdentityMatrix, @object
+	.size	IdentityMatrix, 36
+IdentityMatrix:
+	.long	1065353216
+	.long	0
+	.long	0
+	.long	0
+	.long	1065353216
+	.long	0
+	.long	0
+	.long	0
+	.long	1065353216
+	.text
+	.p2align 4,,15
+.globl hmatMakeHMatFromMat
+	.type	hmatMakeHMatFromMat, @function
+hmatMakeHMatFromMat:
+	pushl	%ebp
+	movl	%esp, %ebp
+	pushl	%ebx
+	movl	12(%ebp), %ecx
+	movl	8(%ebp), %eax
+	movl	(%ecx), %ebx
+	movl	%ebx, (%eax)
+	movl	4(%ecx), %ebx
+	movl	%ebx, 4(%eax)
+	movl	8(%ecx), %ebx
+	movl	%ebx, 8(%eax)
+	movl	$0x0, %ebx
+	movl	%ebx, 12(%eax)
+	movl	12(%ecx), %edx
+	movl	%edx, 16(%eax)
+	movl	16(%ecx), %edx
+	movl	%edx, 20(%eax)
+	movl	20(%ecx), %edx
+	movl	%ebx, 28(%eax)
+	movl	%edx, 24(%eax)
+	movl	24(%ecx), %edx
+	movl	%edx, 32(%eax)
+	movl	28(%ecx), %edx
+	movl	%edx, 36(%eax)
+	movl	32(%ecx), %edx
+	movl	$0x3f800000, %ecx
+	movl	%edx, 40(%eax)
+	movl	%ebx, 44(%eax)
+	movl	%ebx, 48(%eax)
+	movl	%ebx, 52(%eax)
+	movl	%ebx, 56(%eax)
+	movl	%ecx, 60(%eax)
+	popl	%ebx
+	popl	%ebp
+	ret
+	.size	hmatMakeHMatFromMat, .-hmatMakeHMatFromMat
+	.p2align 4,,15
+.globl hmatMakeHMatFromMatAndVec
+	.type	hmatMakeHMatFromMatAndVec, @function
+hmatMakeHMatFromMatAndVec:
+	pushl	%ebp
+	movl	%esp, %ebp
+	pushl	%esi
+	pushl	%ebx
+	movl	12(%ebp), %ecx
+	movl	8(%ebp), %eax
+	movl	16(%ebp), %esi
+	movl	(%ecx), %ebx
+	movl	%ebx, (%eax)
+	movl	4(%ecx), %ebx
+	movl	%ebx, 4(%eax)
+	movl	8(%ecx), %ebx
+	movl	%ebx, 8(%eax)
+	movl	$0x0, %ebx
+	movl	%ebx, 12(%eax)
+	movl	12(%ecx), %edx
+	movl	%edx, 16(%eax)
+	movl	16(%ecx), %edx
+	movl	%edx, 20(%eax)
+	movl	20(%ecx), %edx
+	movl	%ebx, 28(%eax)
+	movl	%edx, 24(%eax)
+	movl	24(%ecx), %edx
+	movl	%edx, 32(%eax)
+	movl	28(%ecx), %edx
+	movl	%edx, 36(%eax)
+	movl	32(%ecx), %edx
+	movl	%ebx, 44(%eax)
+	movl	%edx, 40(%eax)
+	movl	(%esi), %ecx
+	movl	%ecx, 48(%eax)
+	movl	4(%esi), %ebx
+	movl	%ebx, 52(%eax)
+	movl	8(%esi), %ecx
+	movl	%ecx, 56(%eax)
+	movl	$0x3f800000, %ecx
+	movl	%ecx, 60(%eax)
+	popl	%ebx
+	popl	%esi
+	popl	%ebp
+	ret
+	.size	hmatMakeHMatFromMatAndVec, .-hmatMakeHMatFromMatAndVec
+	.p2align 4,,15
+.globl hmatCreateHMatFromHVecs
+	.type	hmatCreateHMatFromHVecs, @function
+hmatCreateHMatFromHVecs:
+	pushl	%ebp
+	movl	%esp, %ebp
+	pushl	%edi
+	pushl	%esi
+	pushl	%ebx
+	movl	12(%ebp), %ecx
+	movl	8(%ebp), %edx
+	movl	16(%ebp), %ebx
+	movl	20(%ebp), %esi
+	movl	(%ecx), %eax
+	movl	24(%ebp), %edi
+	movl	%eax, (%edx)
+	movl	4(%ecx), %eax
+	movl	%eax, 4(%edx)
+	movl	8(%ecx), %eax
+	movl	%eax, 8(%edx)
+	movl	12(%ecx), %eax
+	movl	%eax, 12(%edx)
+	movl	(%ebx), %ecx
+	movl	%ecx, 16(%edx)
+	movl	4(%ebx), %ecx
+	movl	%ecx, 20(%edx)
+	movl	8(%ebx), %ecx
+	movl	%ecx, 24(%edx)
+	movl	12(%ebx), %ecx
+	movl	%ecx, 28(%edx)
+	movl	(%esi), %ebx
+	movl	%ebx, 32(%edx)
+	movl	4(%esi), %ecx
+	movl	%ecx, 36(%edx)
+	movl	8(%esi), %ebx
+	movl	%ebx, 40(%edx)
+	movl	12(%esi), %ecx
+	movl	%ecx, 44(%edx)
+	movl	(%edi), %esi
+	movl	%esi, 48(%edx)
+	movl	4(%edi), %ebx
+	movl	%ebx, 52(%edx)
+	movl	8(%edi), %ecx
+	movl	%ecx, 56(%edx)
+	movl	12(%edi), %ecx
+	movl	%ecx, 60(%edx)
+	popl	%ebx
+	popl	%esi
+	popl	%edi
+	popl	%ebp
+	ret
+	.size	hmatCreateHMatFromHVecs, .-hmatCreateHMatFromHVecs
+	.p2align 4,,15
+.globl hmatMultiplyHMatByHMat
+	.type	hmatMultiplyHMatByHMat, @function
+hmatMultiplyHMatByHMat:
+	pushl	%ebp
+	xorl	%edx, %edx
+	movl	%esp, %ebp
+	pushl	%ebx
+	movl	12(%ebp), %ecx
+	movl	16(%ebp), %eax
+	movl	8(%ebp), %ebx
+	.p2align 4,,7
+.L9:
+	flds	(%ecx,%edx,4)
+	flds	16(%ecx,%edx,4)
+	fld	%st(1)
+	fld	%st(1)
+	fmuls	4(%eax)
+	flds	32(%ecx,%edx,4)
+	fxch	%st(2)
+	fmuls	(%eax)
+	flds	48(%ecx,%edx,4)
+	fxch	%st(1)
+	faddp	%st, %st(2)
+	fld	%st(2)
+	fmuls	8(%eax)
+	faddp	%st, %st(2)
+	fld	%st(0)
+	fmuls	12(%eax)
+	faddp	%st, %st(2)
+	fld	%st(3)
+	fxch	%st(2)
+	fstps	(%ebx,%edx,4)
+	fld	%st(4)
+	fxch	%st(2)
+	fmuls	20(%eax)
+	fxch	%st(2)
+	fmuls	16(%eax)
+	faddp	%st, %st(2)
+	fld	%st(2)
+	fmuls	24(%eax)
+	faddp	%st, %st(2)
+	fld	%st(0)
+	fmuls	28(%eax)
+	faddp	%st, %st(2)
+	fld	%st(3)
+	fxch	%st(2)
+	fstps	16(%ebx,%edx,4)
+	fld	%st(4)
+	fxch	%st(2)
+	fmuls	36(%eax)
+	fxch	%st(2)
+	fmuls	32(%eax)
+	faddp	%st, %st(2)
+	fld	%st(2)
+	fmuls	40(%eax)
+	faddp	%st, %st(2)
+	fld	%st(0)
+	fmuls	44(%eax)
+	faddp	%st, %st(2)
+	fxch	%st(1)
+	fstps	32(%ebx,%edx,4)
+	fxch	%st(3)
+	fmuls	48(%eax)
+	fxch	%st(2)
+	fmuls	52(%eax)
+	fxch	%st(1)
+	fmuls	56(%eax)
+	fxch	%st(2)
+	faddp	%st, %st(1)
+	fxch	%st(2)
+	fmuls	60(%eax)
+	fxch	%st(2)
+	faddp	%st, %st(1)
+	faddp	%st, %st(1)
+	fstps	48(%ebx,%edx,4)
+	incl	%edx
+	cmpl	$3, %edx
+	jle	.L9
+	popl	%ebx
+	popl	%ebp
+	ret
+	.size	hmatMultiplyHMatByHMat, .-hmatMultiplyHMatByHMat
+	.p2align 4,,15
+.globl hmatMultiplyHMatByHVec
+	.type	hmatMultiplyHMatByHVec, @function
+hmatMultiplyHMatByHVec:
+	pushl	%ebp
+	movl	%esp, %ebp
+	movl	12(%ebp), %eax
+	movl	16(%ebp), %edx
+	movl	8(%ebp), %ecx
+	flds	16(%eax)
+	flds	4(%edx)
+	flds	(%edx)
+	fmuls	(%eax)
+	flds	8(%edx)
+	fxch	%st(3)
+	fmul	%st(2), %st
+	flds	12(%edx)
+	fxch	%st(2)
+	faddp	%st, %st(1)
+	flds	32(%eax)
+	fmul	%st(4), %st
+	faddp	%st, %st(1)
+	flds	48(%eax)
+	fmul	%st(2), %st
+	faddp	%st, %st(1)
+	fstps	(%ecx)
+	flds	4(%eax)
+	flds	(%edx)
+	fxch	%st(3)
+	fmuls	20(%eax)
+	flds	36(%eax)
+	fxch	%st(2)
+	fmul	%st(4), %st
+	fxch	%st(2)
+	fmul	%st(5), %st
+	fxch	%st(2)
+	faddp	%st, %st(1)
+	faddp	%st, %st(1)
+	flds	52(%eax)
+	fmul	%st(2), %st
+	faddp	%st, %st(1)
+	fstps	4(%ecx)
+	flds	8(%eax)
+	flds	24(%eax)
+	flds	4(%edx)
+	fmul	%st, %st(1)
+	fxch	%st(2)
+	fmul	%st(4), %st
+	fxch	%st(5)
+	fmuls	40(%eax)
+	fxch	%st(5)
+	faddp	%st, %st(1)
+	flds	56(%eax)
+	fmul	%st(3), %st
+	fxch	%st(1)
+	faddp	%st, %st(5)
+	faddp	%st, %st(4)
+	fxch	%st(3)
+	fstps	8(%ecx)
+	fxch	%st(1)
+	fmuls	12(%eax)
+	flds	8(%edx)
+	fxch	%st(3)
+	fmuls	28(%eax)
+	fxch	%st(3)
+	fmuls	44(%eax)
+	fxch	%st(1)
+	faddp	%st, %st(3)
+	fxch	%st(1)
+	fmuls	60(%eax)
+	fxch	%st(2)
+	faddp	%st, %st(1)
+	faddp	%st, %st(1)
+	fstps	12(%ecx)
+	popl	%ebp
+	ret
+	.size	hmatMultiplyHMatByHVec, .-hmatMultiplyHMatByHVec
+	.p2align 4,,15
+.globl hmatMultiplyHVecByHMat
+	.type	hmatMultiplyHVecByHMat, @function
+hmatMultiplyHVecByHMat:
+	pushl	%ebp
+	movl	%esp, %ebp
+	movl	12(%ebp), %edx
+	movl	16(%ebp), %eax
+	movl	8(%ebp), %ecx
+	flds	4(%edx)
+	flds	(%eax)
+	fld	%st(1)
+	fmuls	4(%eax)
+	flds	8(%edx)
+	fxch	%st(2)
+	fmuls	(%edx)
+	flds	12(%edx)
+	fxch	%st(1)
+	faddp	%st, %st(2)
+	fld	%st(2)
+	fmuls	8(%eax)
+	faddp	%st, %st(2)
+	fld	%st(0)
+	fmuls	12(%eax)
+	faddp	%st, %st(2)
+	fxch	%st(1)
+	fstps	(%ecx)
+	flds	(%edx)
+	fld	%st(0)
+	fxch	%st(4)
+	fmuls	20(%eax)
+	fld	%st(3)
+	fxch	%st(5)
+	fmuls	16(%eax)
+	fxch	%st(5)
+	fmuls	24(%eax)
+	fxch	%st(5)
+	faddp	%st, %st(1)
+	faddp	%st, %st(4)
+	fld	%st(1)
+	fmuls	28(%eax)
+	faddp	%st, %st(4)
+	fld	%st(0)
+	fxch	%st(4)
+	fstps	4(%ecx)
+	flds	4(%edx)
+	fld	%st(0)
+	fmuls	36(%eax)
+	fxch	%st(5)
+	fmuls	32(%eax)
+	fxch	%st(4)
+	fmuls	40(%eax)
+	fxch	%st(4)
+	faddp	%st, %st(5)
+	fld	%st(2)
+	fmuls	44(%eax)
+	fxch	%st(5)
+	faddp	%st, %st(4)
+	fxch	%st(3)
+	faddp	%st, %st(4)
+	fxch	%st(3)
+	fstps	8(%ecx)
+	fxch	%st(2)
+	fmuls	48(%eax)
+	flds	56(%eax)
+	fxch	%st(2)
+	fmuls	52(%eax)
+	fxch	%st(2)
+	fmuls	8(%edx)
+	fxch	%st(1)
+	faddp	%st, %st(2)
+	fxch	%st(2)
+	fmuls	60(%eax)
+	fxch	%st(1)
+	faddp	%st, %st(2)
+	faddp	%st, %st(1)
+	fstps	12(%ecx)
+	popl	%ebp
+	ret
+	.size	hmatMultiplyHVecByHMat, .-hmatMultiplyHVecByHMat
+	.p2align 4,,15
+.globl hmatTranspose
+	.type	hmatTranspose, @function
+hmatTranspose:
+	pushl	%ebp
+	movl	%esp, %ebp
+	movl	8(%ebp), %eax
+	movl	16(%eax), %ecx
+	movl	4(%eax), %edx
+	movl	%edx, 16(%eax)
+	movl	%ecx, 4(%eax)
+	movl	8(%eax), %edx
+	movl	32(%eax), %ecx
+	movl	%ecx, 8(%eax)
+	movl	%edx, 32(%eax)
+	movl	48(%eax), %ecx
+	movl	12(%eax), %edx
+	movl	%edx, 48(%eax)
+	movl	%ecx, 12(%eax)
+	movl	24(%eax), %edx
+	movl	36(%eax), %ecx
+	movl	%ecx, 24(%eax)
+	movl	%edx, 36(%eax)
+	movl	52(%eax), %ecx
+	movl	28(%eax), %edx
+	movl	%edx, 52(%eax)
+	movl	%ecx, 28(%eax)
+	movl	44(%eax), %edx
+	movl	56(%eax), %ecx
+	movl	%ecx, 44(%eax)
+	movl	%edx, 56(%eax)
+	popl	%ebp
+	ret
+	.size	hmatTranspose, .-hmatTranspose
+	.p2align 4,,15
+.globl hmatCopyAndTranspose
+	.type	hmatCopyAndTranspose, @function
+hmatCopyAndTranspose:
+	pushl	%ebp
+	movl	%esp, %ebp
+	movl	8(%ebp), %eax
+	movl	12(%ebp), %edx
+	movl	(%eax), %ecx
+	movl	%ecx, (%edx)
+	movl	4(%eax), %ecx
+	movl	%ecx, 16(%edx)
+	movl	8(%eax), %ecx
+	movl	%ecx, 32(%edx)
+	movl	12(%eax), %ecx
+	movl	%ecx, 48(%edx)
+	movl	16(%eax), %ecx
+	movl	%ecx, 4(%edx)
+	movl	20(%eax), %ecx
+	movl	%ecx, 20(%edx)
+	movl	24(%eax), %ecx
+	movl	%ecx, 36(%edx)
+	movl	28(%eax), %ecx
+	movl	%ecx, 52(%edx)
+	movl	32(%eax), %ecx
+	movl	%ecx, 8(%edx)
+	movl	36(%eax), %ecx
+	movl	%ecx, 24(%edx)
+	movl	40(%eax), %ecx
+	movl	%ecx, 40(%edx)
+	movl	44(%eax), %ecx
+	movl	%ecx, 56(%edx)
+	movl	48(%eax), %ecx
+	movl	%ecx, 12(%edx)
+	movl	52(%eax), %ecx
+	movl	%ecx, 28(%edx)
+	movl	56(%eax), %ecx
+	movl	%ecx, 44(%edx)
+	movl	60(%eax), %ecx
+	movl	%ecx, 60(%edx)
+	popl	%ebp
+	ret
+	.size	hmatCopyAndTranspose, .-hmatCopyAndTranspose
+	.p2align 4,,15
+.globl hmatMakeRotAboutZ
+	.type	hmatMakeRotAboutZ, @function
+hmatMakeRotAboutZ:
+	pushl	%ebp
+	movl	%esp, %ebp
+	pushl	%ebx
+	movl	16(%ebp), %ecx
+	movl	8(%ebp), %eax
+	movl	%ecx, %edx
+	movl	12(%ebp), %ebx
+	xorl	$-2147483648, %edx
+	movl	%ebx, (%eax)
+	movl	%edx, 16(%eax)
+	movl	%ebx, 20(%eax)
+	movl	$0x0, %edx
+	movl	$0x3f800000, %ebx
+	movl	%edx, 32(%eax)
+	movl	%edx, 48(%eax)
+	movl	%ecx, 4(%eax)
+	movl	%edx, 36(%eax)
+	movl	%edx, 52(%eax)
+	movl	%edx, 8(%eax)
+	movl	%edx, 24(%eax)
+	movl	%ebx, 40(%eax)
+	movl	%edx, 56(%eax)
+	movl	%edx, 12(%eax)
+	movl	%edx, 28(%eax)
+	movl	%edx, 44(%eax)
+	movl	%ebx, 60(%eax)
+	popl	%ebx
+	popl	%ebp
+	ret
+	.size	hmatMakeRotAboutZ, .-hmatMakeRotAboutZ
+	.p2align 4,,15
+.globl hmatMakeRotAboutX
+	.type	hmatMakeRotAboutX, @function
+hmatMakeRotAboutX:
+	pushl	%ebp
+	movl	$0x0, %edx
+	movl	%esp, %ebp
+	pushl	%edi
+	pushl	%esi
+	movl	$0x3f800000, %edi
+	pushl	%ebx
+	movl	8(%ebp), %eax
+	movl	16(%ebp), %ebx
+	movl	12(%ebp), %esi
+	movl	%ebx, %ecx
+	movl	%esi, 20(%eax)
+	xorl	$-2147483648, %ecx
+	movl	%edi, (%eax)
+	movl	%edx, 16(%eax)
+	movl	%edx, 32(%eax)
+	movl	%edx, 48(%eax)
+	movl	%edx, 4(%eax)
+	movl	%ecx, 36(%eax)
+	movl	%edx, 52(%eax)
+	movl	%edx, 8(%eax)
+	movl	%ebx, 24(%eax)
+	movl	%esi, 40(%eax)
+	movl	%edx, 56(%eax)
+	movl	%edx, 12(%eax)
+	movl	%edx, 28(%eax)
+	movl	%edx, 44(%eax)
+	movl	%edi, 60(%eax)
+	popl	%ebx
+	popl	%esi
+	popl	%edi
+	popl	%ebp
+	ret
+	.size	hmatMakeRotAboutX, .-hmatMakeRotAboutX
+	.p2align 4,,15
+.globl hmatMakeRotAboutY
+	.type	hmatMakeRotAboutY, @function
+hmatMakeRotAboutY:
+	pushl	%ebp
+	movl	$0x0, %edx
+	movl	%esp, %ebp
+	pushl	%esi
+	pushl	%ebx
+	movl	$0x3f800000, %ebx
+	movl	8(%ebp), %eax
+	movl	16(%ebp), %ecx
+	movl	12(%ebp), %esi
+	movl	%ecx, 32(%eax)
+	movl	%esi, (%eax)
+	xorl	$-2147483648, %ecx
+	movl	%edx, 16(%eax)
+	movl	%edx, 48(%eax)
+	movl	%edx, 4(%eax)
+	movl	%ebx, 20(%eax)
+	movl	%edx, 36(%eax)
+	movl	%edx, 52(%eax)
+	movl	%ecx, 8(%eax)
+	movl	%edx, 24(%eax)
+	movl	%esi, 40(%eax)
+	movl	%edx, 56(%eax)
+	movl	%edx, 12(%eax)
+	movl	%edx, 28(%eax)
+	movl	%edx, 44(%eax)
+	movl	%ebx, 60(%eax)
+	popl	%ebx
+	popl	%esi
+	popl	%ebp
+	ret
+	.size	hmatMakeRotAboutY, .-hmatMakeRotAboutY
+	.section	.rodata.str1.1,"aMS",@progbits,1
+.LC13:
+	.string	"(%8f %8f %8f %8f)\n"
+	.text
+	.p2align 4,,15
+.globl hmatPrintHMatrix
+	.type	hmatPrintHMatrix, @function
+hmatPrintHMatrix:
+	pushl	%ebp
+	movl	%esp, %ebp
+	pushl	%ebx
+	subl	$48, %esp
+	movl	8(%ebp), %ebx
+	flds	48(%ebx)
+	fstpl	24(%esp)
+	flds	32(%ebx)
+	fstpl	16(%esp)
+	flds	16(%ebx)
+	fstpl	8(%esp)
+	flds	(%ebx)
+	fstpl	(%esp)
+	pushl	$.LC13
+	call	printf
+	popl	%ecx
+	flds	52(%ebx)
+	fstpl	24(%esp)
+	flds	36(%ebx)
+	fstpl	16(%esp)
+	flds	20(%ebx)
+	fstpl	8(%esp)
+	flds	4(%ebx)
+	fstpl	(%esp)
+	pushl	$.LC13
+	call	printf
+	popl	%edx
+	flds	56(%ebx)
+	fstpl	24(%esp)
+	flds	40(%ebx)
+	fstpl	16(%esp)
+	flds	24(%ebx)
+	fstpl	8(%esp)
+	flds	8(%ebx)
+	fstpl	(%esp)
+	pushl	$.LC13
+	call	printf
+	flds	60(%ebx)
+	popl	%eax
+	fstpl	24(%esp)
+	flds	44(%ebx)
+	fstpl	16(%esp)
+	flds	28(%ebx)
+	fstpl	8(%esp)
+	flds	12(%ebx)
+	fstpl	(%esp)
+	pushl	$.LC13
+	call	printf
+	movl	-4(%ebp), %ebx
+	leave
+	ret
+	.size	hmatPrintHMatrix, .-hmatPrintHMatrix
+	.p2align 4,,15
+.globl matGetMatFromHMat
+	.type	matGetMatFromHMat, @function
+matGetMatFromHMat:
+	pushl	%ebp
+	movl	%esp, %ebp
+	movl	12(%ebp), %edx
+	movl	8(%ebp), %ecx
+	movl	(%edx), %eax
+	movl	%eax, (%ecx)
+	movl	4(%edx), %eax
+	movl	%eax, 4(%ecx)
+	movl	8(%edx), %eax
+	movl	%eax, 8(%ecx)
+	movl	16(%edx), %eax
+	movl	%eax, 12(%ecx)
+	movl	20(%edx), %eax
+	movl	%eax, 16(%ecx)
+	movl	24(%edx), %eax
+	movl	%eax, 20(%ecx)
+	movl	32(%edx), %eax
+	movl	%eax, 24(%ecx)
+	movl	36(%edx), %eax
+	movl	%eax, 28(%ecx)
+	movl	40(%edx), %eax
+	movl	%eax, 32(%ecx)
+	popl	%ebp
+	ret
+	.size	matGetMatFromHMat, .-matGetMatFromHMat
+	.p2align 4,,15
+.globl matCreateCoordSysFromHeading
+	.type	matCreateCoordSysFromHeading, @function
+matCreateCoordSysFromHeading:
+	pushl	%ebp
+	movl	%esp, %ebp
+	pushl	%ebx
+	fldz
+	fld1
+	fxch	%st(1)
+	subl	$52, %esp
+	movl	12(%ebp), %edx
+	movl	8(%ebp), %ebx
+	fsts	-24(%ebp)
+	fsts	-20(%ebp)
+	fxch	%st(1)
+	fsts	-16(%ebp)
+	movl	(%edx), %ecx
+	movl	%ecx, -40(%ebp)
+	movl	4(%edx), %ecx
+	flds	-40(%ebp)
+	movl	%ecx, -36(%ebp)
+	fucom	%st(2)
+	fnstsw	%ax
+	andb	$69, %ah
+	movl	8(%edx), %ecx
+	xorb	$64, %ah
+	movl	%ecx, -32(%ebp)
+	jne	.L29
+	flds	-36(%ebp)
+	fucom	%st(3)
+	fnstsw	%ax
+	fstp	%st(3)
+	andb	$69, %ah
+	xorb	$64, %ah
+	jne	.L31
+	flds	-32(%ebp)
+	fucom	%st(2)
+	fnstsw	%ax
+	fstp	%st(2)
+	andb	$69, %ah
+	xorb	$64, %ah
+	jne	.L32
+	fxch	%st(2)
+	fxch	%st(1)
+	movl	$0x3df40269, %ecx
+	movl	$0x3f7e2d2d, %edx
+	movl	%ecx, -24(%ebp)
+	movl	%edx, -16(%ebp)
+	jmp	.L25
+	.p2align 4,,7
+.L29:
+	fstp	%st(1)
+	fstp	%st(1)
+	flds	-36(%ebp)
+.L30:
+	flds	-32(%ebp)
+.L25:
+	flds	-16(%ebp)
+	flds	-20(%ebp)
+	fld	%st(3)
+	fld	%st(3)
+	fmul	%st(2), %st
+	subl	$12, %esp
+	fld	%st(4)
+	fxch	%st(2)
+	fmul	%st(4), %st
+	fxch	%st(4)
+	leal	-56(%ebp), %edx
+	pushl	%edx
+	fmul	%st(7), %st
+	fxch	%st(4)
+	fsubp	%st, %st(1)
+	flds	-24(%ebp)
+	fxch	%st(3)
+	fmul	%st(7), %st
+	fxch	%st(2)
+	fmul	%st(3), %st
+	fxch	%st(1)
+	fsts	-56(%ebp)
+	fxch	%st(3)
+	fmul	%st(6), %st
+	fxch	%st(1)
+	fsubp	%st, %st(4)
+	fsubrp	%st, %st(1)
+	fld	%st(2)
+	fsts	-52(%ebp)
+	fld	%st(1)
+	fsts	-48(%ebp)
+	fxch	%st(2)
+	fmul	%st(6), %st
+	fxch	%st(2)
+	fmul	%st(7), %st
+	fxch	%st(1)
+	fmulp	%st, %st(7)
+	fxch	%st(3)
+	fmul	%st(4), %st
+	fxch	%st(4)
+	fmul	%st(2), %st
+	fxch	%st(4)
+	fsubp	%st, %st(1)
+	fxch	%st(1)
+	fmulp	%st, %st(4)
+	fxch	%st(1)
+	fsubp	%st, %st(2)
+	fxch	%st(2)
+	fsubp	%st, %st(3)
+	fxch	%st(1)
+	fstps	-24(%ebp)
+	fstps	-20(%ebp)
+	fstps	-16(%ebp)
+	call	vecNormalize
+	leal	-24(%ebp), %ecx
+	movl	%ecx, (%esp)
+	call	vecNormalize
+	movl	-24(%ebp), %edx
+	movl	%edx, (%ebx)
+	movl	-20(%ebp), %ecx
+	movl	%ecx, 4(%ebx)
+	movl	-16(%ebp), %edx
+	movl	%edx, 8(%ebx)
+	movl	-56(%ebp), %ecx
+	movl	%ecx, 12(%ebx)
+	movl	-52(%ebp), %edx
+	movl	%edx, 16(%ebx)
+	movl	-48(%ebp), %ecx
+	movl	%ecx, 20(%ebx)
+	movl	-40(%ebp), %edx
+	movl	%edx, 24(%ebx)
+	movl	-36(%ebp), %ecx
+	movl	%ecx, 28(%ebx)
+	movl	-32(%ebp), %edx
+	movl	%edx, 32(%ebx)
+	movl	-4(%ebp), %ebx
+	leave
+	ret
+	.p2align 4,,7
+.L31:
+	fstp	%st(1)
+	fxch	%st(1)
+	jmp	.L30
+	.p2align 4,,7
+.L32:
+	fxch	%st(2)
+	fxch	%st(1)
+	jmp	.L25
+	.size	matCreateCoordSysFromHeading, .-matCreateCoordSysFromHeading
+	.p2align 4,,15
+.globl matCreateMatFromVecs
+	.type	matCreateMatFromVecs, @function
+matCreateMatFromVecs:
+	pushl	%ebp
+	movl	%esp, %ebp
+	pushl	%esi
+	pushl	%ebx
+	movl	12(%ebp), %ecx
+	movl	8(%ebp), %edx
+	movl	16(%ebp), %ebx
+	movl	20(%ebp), %esi
+	movl	(%ecx), %eax
+	movl	%eax, (%edx)
+	movl	4(%ecx), %eax
+	movl	%eax, 4(%edx)
+	movl	8(%ecx), %eax
+	movl	%eax, 8(%edx)
+	movl	(%ebx), %ecx
+	movl	%ecx, 12(%edx)
+	movl	4(%ebx), %ecx
+	movl	%ecx, 16(%edx)
+	movl	8(%ebx), %ecx
+	movl	%ecx, 20(%edx)
+	movl	(%esi), %ebx
+	movl	%ebx, 24(%edx)
+	movl	4(%esi), %ecx
+	movl	%ecx, 28(%edx)
+	movl	8(%esi), %ecx
+	movl	%ecx, 32(%edx)
+	popl	%ebx
+	popl	%esi
+	popl	%ebp
+	ret
+	.size	matCreateMatFromVecs, .-matCreateMatFromVecs
+	.p2align 4,,15
+.globl matMultiplyMatByMat
+	.type	matMultiplyMatByMat, @function
+matMultiplyMatByMat:
+	pushl	%ebp
+	movl	%esp, %ebp
+	pushl	%edi
+	pushl	%esi
+	pushl	%ebx
+	movl	12(%ebp), %ecx
+	movl	16(%ebp), %edx
+	movl	8(%ebp), %ebx
+#APP
+	    pushl     %ebp
+    movl      $-3, %eax
+    jmp       mat_x_mat_l1
+    .align    4
+mat_x_mat_l2:
+    fstps     32(%ebx, %eax, 4)
+mat_x_mat_l1:
+    flds      36(%ecx, %eax, 4)
+    fmuls     8(%edx)
+    flds      (%edx)
+    fmuls     12(%ecx, %eax, 4)
+    faddp     %st, %st(1)
+    flds      4(%edx)
+    fmuls     24(%ecx, %eax, 4)
+    faddp     %st, %st(1)
+    movl      12(%ecx, %eax, 4), %ebp
+    movl      24(%ecx, %eax, 4), %esi
+    flds      24(%ecx, %eax, 4)
+    flds      24(%ecx, %eax, 4)
+    flds      12(%ecx, %eax, 4)
+    flds      12(%ecx, %eax, 4)
+    flds      36(%ecx, %eax, 4)
+    flds      36(%ecx, %eax, 4)
+    fxch      %st(6)
+    movl      36(%ecx, %eax, 4), %edi
+    fstps     12(%ebx, %eax, 4)
+    fmuls     20(%edx)
+    fxch      %st(4)
+    fmuls     16(%edx)
+    faddp     %st, %st(4)
+    fxch      %st(1)
+    fmuls     12(%edx)
+    faddp     %st, %st(3)
+    fxch      %st(2)
+    fstps     24(%ebx, %eax, 4)
+    fmuls     28(%edx)
+    fxch      %st(2)
+    fmuls     32(%edx)
+    faddp     %st, %st(2)
+    fmuls     24(%edx)
+    faddp     %st, %st(1)
+    incl      %eax
+    jne       mat_x_mat_l2
+    fstps     32(%ebx, %eax, 4)
+    popl      %ebp
+
+#NO_APP
+	popl	%ebx
+	popl	%esi
+	popl	%edi
+	popl	%ebp
+	ret
+	.size	matMultiplyMatByMat, .-matMultiplyMatByMat
+	.p2align 4,,15
+.globl matMultiplyMatByVec
+	.type	matMultiplyMatByVec, @function
+matMultiplyMatByVec:
+	pushl	%ebp
+	movl	%esp, %ebp
+	pushl	%edi
+	pushl	%esi
+	pushl	%ebx
+	movl	12(%ebp), %edi
+	movl	16(%ebp), %esi
+	movl	8(%ebp), %ebx
+#APP
+	    flds    0*4(%esi)
+    fmuls   (0+0*3)*4(%edi)
+    flds    1*4(%esi)
+    fmuls   (0+1*3)*4(%edi)
+    flds    2*4(%esi)
+    fmuls   (0+2*3)*4(%edi)
+    fxch    %st(1)
+    faddp   %st, %st(2)
+    flds    0*4(%esi)
+    fmuls   (1+0*3)*4(%edi)
+    fxch    %st(1)
+    faddp   %st, %st(2)
+    flds    1*4(%esi)
+    fmuls   (1+1*3)*4(%edi)
+    flds    2*4(%esi)
+    fmuls   (1+2*3)*4(%edi)
+    fxch    %st(1)
+    faddp   %st, %st(1)
+    flds    0*4(%esi)
+    fmuls   (2+0*3)*4(%edi)
+    fxch    %st(1)
+    faddp   %st, %st(2)
+    flds    1*4(%esi)
+    fmuls   (2+1*3)*4(%edi)
+    flds    2*4(%esi)
+    fmuls   (2+2*3)*4(%edi)
+    fxch    %st(1)
+    faddp   %st, %st(1)
+    fxch    %st(2)
+    fstps   1*4(%ebx)
+    fxch    %st(1)
+    faddp   %st, %st(1)
+    fxch    %st(1)
+    fstps   0*4(%ebx)
+    fstps   2*4(%ebx)
+
+#NO_APP
+	popl	%ebx
+	popl	%esi
+	popl	%edi
+	popl	%ebp
+	ret
+	.size	matMultiplyMatByVec, .-matMultiplyMatByVec
+	.p2align 4,,15
+.globl matMultiplyVecByMat
+	.type	matMultiplyVecByMat, @function
+matMultiplyVecByMat:
+	pushl	%ebp
+	movl	%esp, %ebp
+	pushl	%edi
+	pushl	%esi
+	pushl	%ebx
+	movl	12(%ebp), %esi
+	movl	16(%ebp), %edi
+	movl	8(%ebp), %ebx
+#APP
+	    flds    0*4(%esi)
+    fmuls   (0+0*3)*4(%edi)
+    flds    1*4(%esi)
+    fmuls   (1+0*3)*4(%edi)
+    flds    2*4(%esi)
+    fmuls   (2+0*3)*4(%edi)
+    fxch    %st(1)
+    faddp   %st, %st(2)
+    flds    0*4(%esi)
+    fmuls   (0+1*3)*4(%edi)
+    fxch    %st(1)
+    faddp   %st, %st(2)
+    flds    1*4(%esi)
+    fmuls   (1+1*3)*4(%edi)
+    flds    2*4(%esi)
+    fmuls   (2+1*3)*4(%edi)
+    fxch    %st(1)
+    faddp   %st, %st(1)
+    flds    0*4(%esi)
+    fmuls   (0+2*3)*4(%edi)
+    fxch    %st(1)
+    faddp   %st, %st(2)
+    flds    1*4(%esi)
+    fmuls   (1+2*3)*4(%edi)
+    flds    2*4(%esi)
+    fmuls   (2+2*3)*4(%edi)
+    fxch    %st(1)
+    faddp   %st, %st(1)
+    fxch    %st(2)
+    fstps   1*4(%ebx)
+    fxch    %st(1)
+    faddp   %st, %st(1)
+    fxch    %st(1)
+    fstps   0*4(%ebx)
+    fstps   2*4(%ebx)
+
+#NO_APP
+	popl	%ebx
+	popl	%esi
+	popl	%edi
+	popl	%ebp
+	ret
+	.size	matMultiplyVecByMat, .-matMultiplyVecByMat
+	.p2align 4,,15
+.globl matTranspose
+	.type	matTranspose, @function
+matTranspose:
+	pushl	%ebp
+	movl	%esp, %ebp
+	movl	8(%ebp), %eax
+	movl	4(%eax), %ecx
+	movl	12(%eax), %edx
+	movl	%edx, 4(%eax)
+	movl	%ecx, 12(%eax)
+	movl	24(%eax), %edx
+	movl	8(%eax), %ecx
+	movl	%ecx, 24(%eax)
+	movl	%edx, 8(%eax)
+	movl	20(%eax), %ecx
+	movl	28(%eax), %edx
+	movl	%edx, 20(%eax)
+	movl	%ecx, 28(%eax)
+	popl	%ebp
+	ret
+	.size	matTranspose, .-matTranspose
+	.p2align 4,,15
+.globl matCopyAndTranspose
+	.type	matCopyAndTranspose, @function
+matCopyAndTranspose:
+	pushl	%ebp
+	movl	%esp, %ebp
+	movl	8(%ebp), %edx
+	movl	12(%ebp), %ecx
+	movl	(%edx), %eax
+	movl	%eax, (%ecx)
+	movl	4(%edx), %eax
+	movl	%eax, 12(%ecx)
+	movl	8(%edx), %eax
+	movl	%eax, 24(%ecx)
+	movl	12(%edx), %eax
+	movl	%eax, 4(%ecx)
+	movl	16(%edx), %eax
+	movl	%eax, 16(%ecx)
+	movl	20(%edx), %eax
+	movl	%eax, 28(%ecx)
+	movl	24(%edx), %eax
+	movl	%eax, 8(%ecx)
+	movl	28(%edx), %eax
+	movl	%eax, 20(%ecx)
+	movl	32(%edx), %eax
+	movl	%eax, 32(%ecx)
+	popl	%ebp
+	ret
+	.size	matCopyAndTranspose, .-matCopyAndTranspose
+	.p2align 4,,15
+.globl matMakeRotAboutZ
+	.type	matMakeRotAboutZ, @function
+matMakeRotAboutZ:
+	pushl	%ebp
+	movl	%esp, %ebp
+	pushl	%ebx
+	movl	16(%ebp), %ecx
+	movl	8(%ebp), %eax
+	movl	%ecx, %edx
+	movl	12(%ebp), %ebx
+	xorl	$-2147483648, %edx
+	movl	%ecx, 4(%eax)
+	movl	%edx, 12(%eax)
+	movl	$0x3f800000, %ecx
+	movl	$0x0, %edx
+	movl	%ebx, (%eax)
+	movl	%edx, 24(%eax)
+	movl	%ebx, 16(%eax)
+	movl	%edx, 28(%eax)
+	movl	%edx, 8(%eax)
+	movl	%edx, 20(%eax)
+	movl	%ecx, 32(%eax)
+	popl	%ebx
+	popl	%ebp
+	ret
+	.size	matMakeRotAboutZ, .-matMakeRotAboutZ
+	.p2align 4,,15
+.globl matMakeRotAboutX
+	.type	matMakeRotAboutX, @function
+matMakeRotAboutX:
+	pushl	%ebp
+	movl	$0x3f800000, %ecx
+	movl	%esp, %ebp
+	pushl	%esi
+	pushl	%ebx
+	movl	8(%ebp), %eax
+	movl	16(%ebp), %ebx
+	movl	%ebx, %edx
+	movl	12(%ebp), %esi
+	xorl	$-2147483648, %edx
+	movl	%ecx, (%eax)
+	movl	$0x0, %ecx
+	movl	%esi, 16(%eax)
+	movl	%ecx, 12(%eax)
+	movl	%ecx, 24(%eax)
+	movl	%ecx, 4(%eax)
+	movl	%edx, 28(%eax)
+	movl	%ecx, 8(%eax)
+	movl	%ebx, 20(%eax)
+	movl	%esi, 32(%eax)
+	popl	%ebx
+	popl	%esi
+	popl	%ebp
+	ret
+	.size	matMakeRotAboutX, .-matMakeRotAboutX
+	.p2align 4,,15
+.globl matMakeRotAboutY
+	.type	matMakeRotAboutY, @function
+matMakeRotAboutY:
+	pushl	%ebp
+	movl	$0x0, %ecx
+	movl	%esp, %ebp
+	movl	$0x3f800000, %edx
+	pushl	%esi
+	pushl	%ebx
+	movl	8(%ebp), %eax
+	movl	16(%ebp), %ebx
+	movl	12(%ebp), %esi
+	movl	%ebx, 24(%eax)
+	movl	%esi, (%eax)
+	xorl	$-2147483648, %ebx
+	movl	%ecx, 12(%eax)
+	movl	%ecx, 4(%eax)
+	movl	%edx, 16(%eax)
+	movl	%ecx, 28(%eax)
+	movl	%ebx, 8(%eax)
+	movl	%ecx, 20(%eax)
+	movl	%esi, 32(%eax)
+	popl	%ebx
+	popl	%esi
+	popl	%ebp
+	ret
+	.size	matMakeRotAboutY, .-matMakeRotAboutY
+	.section	.rodata.str1.1
+.LC26:
+	.string	"(%8f %8f %8f)\n"
+	.text
+	.p2align 4,,15
+.globl matPrintmatrix
+	.type	matPrintmatrix, @function
+matPrintmatrix:
+	pushl	%ebp
+	movl	%esp, %ebp
+	pushl	%ebx
+	subl	$32, %esp
+	movl	8(%ebp), %ebx
+	flds	24(%ebx)
+	fstpl	16(%esp)
+	flds	12(%ebx)
+	fstpl	8(%esp)
+	flds	(%ebx)
+	fstpl	(%esp)
+	pushl	$.LC26
+	call	printf
+	flds	28(%ebx)
+	popl	%eax
+	fstpl	16(%esp)
+	flds	16(%ebx)
+	fstpl	8(%esp)
+	flds	4(%ebx)
+	fstpl	(%esp)
+	pushl	$.LC26
+	call	printf
+	flds	32(%ebx)
+	popl	%eax
+	fstpl	16(%esp)
+	flds	20(%ebx)
+	fstpl	8(%esp)
+	flds	8(%ebx)
+	fstpl	(%esp)
+	pushl	$.LC26
+	call	printf
+	movl	-4(%ebp), %ebx
+	leave
+	ret
+	.size	matPrintmatrix, .-matPrintmatrix
+	.p2align 4,,15
+.globl matCopyAndScale
+	.type	matCopyAndScale, @function
+matCopyAndScale:
+	pushl	%ebp
+	movl	%esp, %ebp
+	pushl	%edi
+	pushl	%esi
+	pushl	%ebx
+	subl	$60, %esp
+	movl	IdentityMatrix+4, %edx
+	movl	IdentityMatrix, %esi
+	movl	%edx, -68(%ebp)
+	movl	%esi, -72(%ebp)
+	movl	IdentityMatrix+16, %edx
+	movl	IdentityMatrix+8, %edi
+	movl	%edx, -56(%ebp)
+	movl	IdentityMatrix+12, %esi
+	movl	IdentityMatrix+28, %edx
+	movl	12(%ebp), %ecx
+	movl	%edi, -64(%ebp)
+	movl	%esi, -60(%ebp)
+	movl	%edx, -44(%ebp)
+	movl	IdentityMatrix+20, %edi
+	movl	IdentityMatrix+24, %esi
+	movl	IdentityMatrix+32, %edx
+	movl	%edx, -40(%ebp)
+	movl	%edi, -52(%ebp)
+	movl	%esi, -48(%ebp)
+	movl	8(%ebp), %ebx
+	flds	16(%ebp)
+	flds	(%ecx)
+	fmul	%st(1), %st
+	leal	-72(%ebp), %edx
+	fstps	(%ebx)
+	flds	4(%ecx)
+	fmul	%st(1), %st
+	fstps	4(%ebx)
+	flds	8(%ecx)
+	fmul	%st(1), %st
+	fstps	8(%ebx)
+	flds	12(%ecx)
+	fmul	%st(1), %st
+	fstps	12(%ebx)
+	flds	16(%ecx)
+	fmul	%st(1), %st
+	fstps	16(%ebx)
+	flds	20(%ecx)
+	fmul	%st(1), %st
+	fstps	20(%ebx)
+	flds	24(%ecx)
+	fmul	%st(1), %st
+	fstps	24(%ebx)
+	flds	28(%ecx)
+	fmul	%st(1), %st
+	fstps	28(%ebx)
+	flds	32(%ecx)
+	fmul	%st(1), %st
+	fstps	32(%ebx)
+	flds	-72(%ebp)
+	fmul	%st(1), %st
+	fstps	-72(%ebp)
+	flds	-56(%ebp)
+	fmul	%st(1), %st
+	fxch	%st(1)
+	fmuls	-40(%ebp)
+	fxch	%st(1)
+	fstps	-56(%ebp)
+	fstps	-40(%ebp)
+#APP
+	    pushl     %ebp
+    movl      $-3, %eax
+    jmp       mat_x_mat_l1
+    .align    4
+mat_x_mat_l2:
+    fstps     32(%ebx, %eax, 4)
+mat_x_mat_l1:
+    flds      36(%ecx, %eax, 4)
+    fmuls     8(%edx)
+    flds      (%edx)
+    fmuls     12(%ecx, %eax, 4)
+    faddp     %st, %st(1)
+    flds      4(%edx)
+    fmuls     24(%ecx, %eax, 4)
+    faddp     %st, %st(1)
+    movl      12(%ecx, %eax, 4), %ebp
+    movl      24(%ecx, %eax, 4), %esi
+    flds      24(%ecx, %eax, 4)
+    flds      24(%ecx, %eax, 4)
+    flds      12(%ecx, %eax, 4)
+    flds      12(%ecx, %eax, 4)
+    flds      36(%ecx, %eax, 4)
+    flds      36(%ecx, %eax, 4)
+    fxch      %st(6)
+    movl      36(%ecx, %eax, 4), %edi
+    fstps     12(%ebx, %eax, 4)
+    fmuls     20(%edx)
+    fxch      %st(4)
+    fmuls     16(%edx)
+    faddp     %st, %st(4)
+    fxch      %st(1)
+    fmuls     12(%edx)
+    faddp     %st, %st(3)
+    fxch      %st(2)
+    fstps     24(%ebx, %eax, 4)
+    fmuls     28(%edx)
+    fxch      %st(2)
+    fmuls     32(%edx)
+    faddp     %st, %st(2)
+    fmuls     24(%edx)
+    faddp     %st, %st(1)
+    incl      %eax
+    jne       mat_x_mat_l2
+    fstps     32(%ebx, %eax, 4)
+    popl      %ebp
+
+#NO_APP
+	addl	$60, %esp
+	popl	%ebx
+	popl	%esi
+	popl	%edi
+	popl	%ebp
+	ret
+	.size	matCopyAndScale, .-matCopyAndScale
+	.ident	"GCC: (GNU) 3.3 (Mandrake Linux 9.2 3.3-2mdk)"
diff -urPw homeworld-orig/src/Game/MaxMultiplayer.h homeworld_sdl-0.3/src/Game/MaxMultiplayer.h
--- homeworld-orig/src/Game/MaxMultiplayer.h	1969-12-31 16:00:00.000000000 -0800
+++ homeworld_sdl-0.3/src/Game/MaxMultiplayer.h	2004-08-01 22:35:22.000000000 -0700
@@ -0,0 +1,9 @@
+/*=============================================================================
+    Name    : maxMultiPlayer.h
+    Purpose : Header to contain definition...for easy project sharing and modularity
+
+    Created 06/19/1999 by bpasechnik
+    Copyright Relic Entertainment, Inc.  All rights reserved.
+=============================================================================*/
+
+#define MAX_MULTIPLAYER_PLAYERS 8
Only in homeworld-orig/src/Game: MaxMultiPlayer.h
diff -urPw homeworld-orig/src/Game/Memory.c homeworld_sdl-0.3/src/Game/Memory.c
--- homeworld-orig/src/Game/Memory.c	2002-09-04 12:46:14.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Memory.c	2004-08-01 22:35:21.000000000 -0700
@@ -5,17 +5,25 @@
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
-#include "types.h"
-#include "debug.h"
-#include "key.h"
-#include "task.h"
-#include "memory.h"
+#include "Types.h"
+#include "Debug.h"
+#include "Key.h"
+#include "Task.h"
+#include "File.h"
+#include "Memory.h"
 #if MEM_VOLATILE_CLEARING
 #include <time.h>
-#include "crc32.h"
-#include "randy.h"
+#include "CRC32.h"
+#include "Randy.h"
 #endif
 
+#ifdef _MSC_VER
+#define CB_DECL __cdecl
+#else
+#define CB_DECL
+#endif
+
+
 /*=============================================================================
     Data:
 =============================================================================*/
@@ -101,7 +109,9 @@
 
     taskYield(0);
 
+#ifndef C_ONLY
     while (1)
+#endif
     {
         taskStackSaveCond(0);
         if (memStatsLogging)
@@ -176,6 +186,10 @@
 ----------------------------------------------------------------------------*/
 sdword memStartup(void *heapStart, sdword heapSize, memgrowcallback grow)
 {
+#if MEM_FILE_NV
+    char *memNonVolatileFileName;
+#endif
+
     if ((sizeof(mbhcookie) != 32) || (sizeof(memcookie) != 32))
     {
         dbgFatalf(DBG_Loc, "Bad cookie size: %d, %d", sizeof(mbhcookie), sizeof(memcookie));
@@ -199,11 +213,21 @@
     memModuleInit = TRUE;
 
 #if MEM_FILE_NV
-    memNonVolatileFile = fopen("mem.nv", "wt");
+    memNonVolatileFileName = filePathPrepend("mem.nv", FF_UserSettingsPath);
+
+    if (!fileMakeDestinationDirectory(memNonVolatileFileName))
+    {
+        dbgMessage("\nError creating the path for mem.nv.");
+        memNonVolatileFile = NULL;
+    }
+    else
+    {
+        memNonVolatileFile = fopen(memNonVolatileFileName, "wt");
     if (memNonVolatileFile == NULL)
     {
         dbgMessage("\nError creating log file mem.nv.");
     }
+    }
 #endif
     memGrowthAllocate = grow;
 
@@ -365,7 +389,9 @@
         memFree(c);
         memFree(d);
         memFree(f);
+#ifndef _MACOSX_FIX_ME
         memDefragment();
+#endif
     }
 #endif // MEM_MODULE_TEST
 
@@ -439,6 +465,7 @@
 ----------------------------------------------------------------------------*/
 sdword memClearDword(void *dest, udword pattern, sdword nDwords)
 {
+#if defined (_MSC_VER)
     _asm
     {
         mov edi,dest
@@ -446,6 +473,16 @@
         mov eax,pattern
         rep stosd
     }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ (
+        "rep stosl\n\t"
+        :
+        : "D" (dest), "c" (nDwords), "a" (pattern) );
+#else
+	udword *d = ( udword *)dest;
+    while (nDwords--)
+        *d++ = pattern;
+#endif
     return(OKAY);
 }
 
@@ -1302,7 +1339,7 @@
     }
     dbgMessagef("\nCannot log volatility of '%s': stats array length %d full", cookie->name, MEM_NumberVolatileStats);
 }
-int __cdecl memVolatilitySort(const void *p0, const void *p1)
+int CB_DECL memVolatilitySort(const void *p0, const void *p1)
 {
     real32 diff;
 
@@ -1474,11 +1511,11 @@
 
     memCookieVerify(cookie);                                //make sure cookie is valid
 
-    if (pointer < memMainPool.pool || pointer > (void *)memMainPool.last)
+    if (pointer < (void *)memMainPool.pool || pointer > (void *)memMainPool.last)
     {                                                       //if it's not part of the main pool
         for (index = 0, pool = memGrowthPool; index < memNumberGrowthPools; index++, pool++)
         {                                                   //search all existing pools
-            if (pointer > pool->pool && pointer <= (void *)pool->last)
+            if (pointer > (void *)pool->pool && pointer <= (void *)pool->last)
             {
                 goto foundPool;
             }
@@ -1936,7 +1973,7 @@
         for (index = 0, heap = (mbheap *)pool->pool; memSmallHeapInfo[index].blockSize > 0; index++, heap++)
         {                                                   //for all heaps
             //dbgAssert(heap->nBlocks == memSmallHeapInfo[index].nBlocks);
-            fprintf(fpAnalysis, "Heap 0x%x, length = %d\n", heap, heap->nBlocks * heap->blockSize);
+            fprintf(fpAnalysis, "Heap 0x%x, length = %d\n", (size_t)heap, heap->nBlocks * heap->blockSize);
 #if MEM_SMALLBLOCK_STATS
             if (heap->nAllocationAttempts == 0)
             {
@@ -1960,9 +1997,9 @@
                 bCookie = listGetStructOfNode(cookieLink);
                 mbhCookieVerify(bCookie);
 #if MEM_USE_NAMES
-                fprintf(fpAnalysis, "%20s, %10d, %10d, %10s, %10x\n", bCookie->name, bCookie->length, heap->blockSize, "allocated", bCookie);
+                fprintf(fpAnalysis, "%20s, %10d, %10d, %10s, %10x\n", bCookie->name, bCookie->length, heap->blockSize, "allocated", (size_t)bCookie);
 #else
-                fprintf(fpAnalysis, "%20s, %10d, %10d, %10s, %10x\n", "noname", bCookie->length, heap->blockSize, "allocated", bCookie);
+                fprintf(fpAnalysis, "%20s, %10d, %10d, %10s, %10x\n", "noname", bCookie->length, heap->blockSize, "allocated", (size_t)bCookie);
 #endif
                 MEM_MAP_CHAR('*');                          //print cookie character
                 for (block = 0; block < bCookie->length / MEM_BlockSize; block++)
@@ -1984,9 +2021,9 @@
                 bCookie = listGetStructOfNode(cookieLink);
                 mbhCookieVerify(bCookie);
 #if MEM_USE_NAMES
-                fprintf(fpAnalysis, "%20s, %10d, %10d, %10s, %10x\n", bCookie->name, 0, heap->blockSize, "free", bCookie);
+                fprintf(fpAnalysis, "%20s, %10d, %10d, %10s, %10x\n", bCookie->name, 0, heap->blockSize, "free", (size_t)bCookie);
 #else
-                fprintf(fpAnalysis, "%20s, %10d, %10d, %10s, %10x\n", "noname", 0, heap->blockSize, "free", bCookie);
+                fprintf(fpAnalysis, "%20s, %10d, %10d, %10s, %10x\n", "noname", 0, heap->blockSize, "free", (size_t)bCookie);
 #endif
                 MEM_MAP_CHAR('*');                          //print cookie character
                 for (block = 0; block < heap->blockSize / MEM_BlockSize; block++)
@@ -2000,7 +2037,7 @@
     //print values of the small block pointers
     for (index = 0; index < MSB_NumberSizes + 1; index++)
     {
-        fprintf(fpAnalysis, "lowestFree 0x%x = 0x%x\n", ((index) * MEM_BlockSize) + MEM_BlockSize, pool->firstSize[index]);
+        fprintf(fpAnalysis, "lowestFree 0x%x = 0x%x\n", ((index) * MEM_BlockSize) + MEM_BlockSize, (size_t)pool->firstSize[index]);
     }
     thisCookie = pool->first;                                  //start walk from very start of heap
 
@@ -2010,9 +2047,9 @@
     {
         memCookieVerify(thisCookie);                        //verify this cookie
 #if MEM_USE_NAMES
-        fprintf(fpAnalysis, "%20s, %10d, %10d, %10s, %10x\n", thisCookie->name, memBlocksToBytes(thisCookie->blocksNext), memBlocksToBytes(thisCookie->blocksPrevious), bitTest(thisCookie->flags, MBF_AllocatedNext) ? "allocated" : "free", thisCookie);
+        fprintf(fpAnalysis, "%20s, %10d, %10d, %10s, %10x\n", thisCookie->name, memBlocksToBytes(thisCookie->blocksNext), memBlocksToBytes(thisCookie->blocksPrevious), bitTest(thisCookie->flags, MBF_AllocatedNext) ? "allocated" : "free", (size_t)thisCookie);
 #else
-        fprintf(fpAnalysis, "%20s, %10d, %10d, %10s, %10x\n", "noname", memBlocksToBytes(thisCookie->blocksNext), memBlocksToBytes(thisCookie->blocksPrevious), bitTest(thisCookie->flags, MBF_AllocatedNext) ? "allocated" : "free", thisCookie);
+        fprintf(fpAnalysis, "%20s, %10d, %10d, %10s, %10x\n", "noname", memBlocksToBytes(thisCookie->blocksNext), memBlocksToBytes(thisCookie->blocksPrevious), bitTest(thisCookie->flags, MBF_AllocatedNext) ? "allocated" : "free", (size_t)thisCookie);
 #endif
         MEM_MAP_CHAR('*');
         if (bitTest(thisCookie->flags, MBF_AllocatedNext))
@@ -2076,16 +2113,36 @@
 ----------------------------------------------------------------------------*/
 void memAnalysisCreate(void)
 {
+    char *memAnalysisFileNameFull, *memMapFileNameFull;
     FILE *fpAnalysis, *fpMap;
     sdword index;
 
     dbgMessagef("\nSaving detailed analysis to '%s' and map to '%s'", MEM_ANALYSIS_FILE_NAME, MEM_MAP_FILE_NAME);
 
-    fpAnalysis = fopen(MEM_ANALYSIS_FILE_NAME, "wt");
-    fpMap = fopen(MEM_MAP_FILE_NAME, "wt");
+    memAnalysisFileNameFull = filePathPrepend(
+        MEM_ANALYSIS_FILE_NAME, FF_UserSettingsPath);
+    memMapFileNameFull = filePathPrepend(
+        MEM_MAP_FILE_NAME, FF_UserSettingsPath);
+
+    if (!fileMakeDestinationDirectory(memAnalysisFileNameFull))
+    {
+        dbgWarningf(
+            DBG_Loc,
+            "Error creating destination directory for memory analysis files.");
+        return;
+    }
+
+    fpAnalysis = fopen(memAnalysisFileNameFull, "wt");
+    fpMap = fopen(memMapFileNameFull, "wt");
     if (fpMap == NULL || fpAnalysis == NULL)
     {
         dbgWarningf(DBG_Loc, "Error opening either '%s' or '%s'.", MEM_ANALYSIS_FILE_NAME, MEM_MAP_FILE_NAME);
+
+        if (fpMap)
+            fclose(fpMap);
+        else if (fpAnalysis)
+            fclose(fpAnalysis);
+
         return;
     }
 
diff -urPw homeworld-orig/src/Game/Memory.h homeworld_sdl-0.3/src/Game/Memory.h
--- homeworld-orig/src/Game/Memory.h	2002-09-04 12:46:14.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Memory.h	2004-08-01 22:35:22.000000000 -0700
@@ -7,8 +7,8 @@
 #ifndef ___MEMORY_H
 #define ___MEMORY_H
 
-#include "task.h"
-#include "linkedlist.h"
+#include "Task.h"
+#include "LinkedList.h"
 
 /*=============================================================================
     Switches:
diff -urPw homeworld-orig/src/Game/MeshAnim.c homeworld_sdl-0.3/src/Game/MeshAnim.c
--- homeworld-orig/src/Game/MeshAnim.c	2002-09-04 12:46:14.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/MeshAnim.c	2004-08-01 22:35:36.000000000 -0700
@@ -8,19 +8,24 @@
 
 #include <stdlib.h>
 #include <string.h>
+#include <strings.h>
 #include <math.h>
-#include "debug.h"
-#include "memory.h"
-#include "file.h"
-#include "b-spline.h"
-#include "spaceobj.h"
-#include "vector.h"
-#include "matrix.h"
-#include "universe.h"
-#include "nis.h"
+#include "Debug.h"
+#include "Memory.h"
+#include "File.h"
+#include "B-Spline.h"
+#include "SpaceObj.h"
+#include "Vector.h"
+#include "Matrix.h"
+#include "Universe.h"
+#include "NIS.h"
 #include "mainrgn.h"
-#include "meshanim.h"
-#include "crc32.h"
+#include "MeshAnim.h"
+#include "CRC32.h"
+
+#ifdef _MSC_VER
+#define strcasecmp _stricmp
+#endif
 
 /*=============================================================================
     Data:
@@ -65,6 +70,18 @@
     fileSize = fileSizeGet(fileName, 0);
     file = fileOpen(fileName, 0);
     fileBlockRead(file, &header, madHeaderSize(0));
+
+#ifdef ENDIAN_BIG
+	header.version           = LittleFloat( header.version );
+	header.stringBlockLength = LittleLong( header.stringBlockLength );
+	header.stringBlock       = ( char *)LittleLong( ( udword )header.stringBlock );
+	header.length            = LittleFloat( header.length );
+	header.framesPerSecond   = LittleFloat( header.framesPerSecond );
+	header.nObjects          = LittleLong( header.nObjects );
+	header.objPath           = ( madobjpath *)LittleLong( ( udword )header.objPath );
+	header.nAnimations       = LittleLong( header.nAnimations );
+#endif
+
 #if MAD_ERROR_CHECKING
     if (strcmp(header.identifier, MAD_FileIdentifier) != 0)
     {
@@ -95,19 +112,54 @@
     //loop through all the structures and fix up pointers
     for (index = 0; index < newHeader->nAnimations; index++)
     {                                                       //fixup the name of all animations
+#ifdef ENDIAN_BIG
+		newHeader->anim[index].name      = ( char *)LittleLong( ( udword )newHeader->anim[index].name );
+		newHeader->anim[index].startTime = LittleFloat( newHeader->anim[index].startTime );
+		newHeader->anim[index].endTime   = LittleFloat( newHeader->anim[index].endTime );
+		newHeader->anim[index].flags     = LittleLong( newHeader->anim[index].flags );
+#endif
+
         newHeader->anim[index].name += (udword)newHeader->stringBlock;
     }
     (ubyte *)newHeader->objPath += (udword)newHeader;
     for (index = 0; index < newHeader->nObjects; index++)
     {
+#ifdef ENDIAN_BIG
+		newHeader->objPath[index].name = ( char *)LittleLong( ( udword )newHeader->objPath[index].name );
+		newHeader->objPath[index].nameCRC = LittleShort( newHeader->objPath[index].nameCRC );
+		newHeader->objPath[index].animationBits = LittleLong( newHeader->objPath[index].animationBits );
+		newHeader->objPath[index].nKeyframes = LittleLong( newHeader->objPath[index].nKeyframes );
+		newHeader->objPath[index].times = ( real32 *)LittleLong( ( udword )newHeader->objPath[index].times );
+		newHeader->objPath[index].parameters = ( tcb *)LittleLong( ( udword )newHeader->objPath[index].parameters );
+#endif
         newHeader->objPath[index].name += (udword)newHeader->stringBlock;//fixup name
         newHeader->objPath[index].nameCRC = crc16Compute(newHeader->objPath[index].name, strlen(newHeader->objPath[index].name));
         (ubyte *)newHeader->objPath[index].times += (udword)newHeader;//fixup times pointers
         (ubyte *)newHeader->objPath[index].parameters += (udword)newHeader;//fixup times pointers
         for (j = 0; j < 6; j++)
         {                                                   //fixup the motion path array pointers
+#ifdef ENDIAN_BIG
+			newHeader->objPath[index].path[j] = ( real32 *)LittleLong( ( udword )newHeader->objPath[index].path[j] );
+#endif
             (ubyte *)newHeader->objPath[index].path[j] += (udword)newHeader;
         }
+
+#ifdef ENDIAN_BIG
+		for( j = 0; j < newHeader->objPath[index].nKeyframes; j++ )
+		{
+			int k = 0;
+
+			newHeader->objPath[index].times[j] = LittleFloat( newHeader->objPath[index].times[j] );
+			newHeader->objPath[index].parameters[j].tension = LittleFloat( newHeader->objPath[index].parameters[j].tension );
+			newHeader->objPath[index].parameters[j].continuity = LittleFloat( newHeader->objPath[index].parameters[j].continuity );
+			newHeader->objPath[index].parameters[j].bias = LittleFloat( newHeader->objPath[index].parameters[j].bias );
+
+			for( k = 0; k < 6; k++ )
+			{
+				newHeader->objPath[index].path[k][j] = LittleFloat( newHeader->objPath[index].path[k][j] );
+			}
+		}
+#endif
     }
 
     return(newHeader);
@@ -516,7 +568,7 @@
 
     for (index = 0; index < header->nAnimations; index++)
     {
-        if (_stricmp(header->anim[index].name, name) == 0)
+        if (strcasecmp(header->anim[index].name, name) == 0)
         {
             return(index);
         }
@@ -678,8 +730,6 @@
 {
     madanim *anim = ship->madBindings;
     splinecurve *curve;
-    vector vec[2];
-    real32 *value = (real32 *)&vec;
     lodinfo *lodInfo;
     mhbinding *bindingListSource;
     hmatrix *hMatrix;
diff -urPw homeworld-orig/src/Game/MeshAnim.h homeworld_sdl-0.3/src/Game/MeshAnim.h
--- homeworld-orig/src/Game/MeshAnim.h	2002-09-04 12:46:14.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/MeshAnim.h	2004-08-01 22:35:36.000000000 -0700
@@ -9,9 +9,9 @@
 #ifndef ___MESHANIM_H
 #define ___MESHANIM_H           "steaming mad"
 
-#include "types.h"
-#include "b-spline.h"
-#include "crc32.h"
+#include "Types.h"
+#include "B-Spline.h"
+#include "CRC32.h"
 
 /*=============================================================================
     Switches:
@@ -152,29 +152,31 @@
 /*=============================================================================
     Functions:
 =============================================================================*/
+struct Ship;
+struct ShipStaticInfo;
 
 madheader *madFileLoad(char *fileName);
 void madHeaderDelete(madheader *header);
 
 //make ship local bindings for mesh animation
-void madAnimBindingsDupe(void *ship, void *staticInfo,bool LoadingGame);
+void madAnimBindingsDupe(struct Ship *ship, struct ShipStaticInfo *staticInfo,bool LoadingGame);
 
 //play an animation
-void madAnimationStart(void *ship, sdword animNumber);
-void madAnimationPause(void *ship, bool bFreeze);
-bool madAnimationUpdate(void *ship, real32 timeElapsed);
-void madAnimationStop(void *ship);
+void madAnimationStart(struct Ship *ship, sdword animNumber);
+void madAnimationPause(struct Ship *ship, bool bFreeze);
+bool madAnimationUpdate(struct Ship *ship, real32 timeElapsed);
+void madAnimationStop(struct Ship *ship);
 
 //find things in animations
 sdword madAnimIndexFindByName(madheader *header, char *name);
-sdword madGunBindingIndexFindByName(void *info, char *name);
+sdword madGunBindingIndexFindByName(struct ShipStaticInfo *info, char *name);
 sdword madBindingIndexFindByName(madheader *header, char *name);
-void madAnimBindingMatrix(matrix *destMatrix, vector *destPos, void *ship, sdword gunIndex, sdword madIndex);
+void madAnimBindingMatrix(matrix *destMatrix, vector *destPos, struct Ship *ship, sdword gunIndex, sdword madIndex);
 
-void PreFix_madBindings(void *ship,void *fixcontents);
-void Save_madBindings(void *ship);
-void Load_madBindings(void *ship);
-void Fix_madBindings(void *ship);
+void PreFix_madBindings(struct Ship *ship,struct Ship *fixcontents);
+void Save_madBindings(struct Ship *ship);
+void Load_madBindings(struct Ship *ship);
+void Fix_madBindings(struct Ship *ship);
 
 #endif //___MESHANIM_H
 
diff -urPw homeworld-orig/src/Game/Mesh.c homeworld_sdl-0.3/src/Game/Mesh.c
--- homeworld-orig/src/Game/Mesh.c	2002-09-04 12:46:14.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Mesh.c	2004-08-01 22:35:33.000000000 -0700
@@ -6,33 +6,41 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
+#ifdef _WIM32
 #define WIN32_LEAN_AND_MEAN
 #include <windows.h>
+#endif
+
 #include "glinc.h"
 #include <stdlib.h>
 #include <stdio.h>
 #include <string.h>
-
-#include "types.h"
-#include "debug.h"
-#include "file.h"
-#include "memory.h"
-#include "vector.h"
+#include <strings.h>
+#include <ctype.h>
+#include "Types.h"
+#include "Debug.h"
+#include "File.h"
+#include "Memory.h"
+#include "Vector.h"
 #include "texreg.h"
 #include "render.h"
 #include "utility.h"
-#include "teams.h"
-#include "objtypes.h"
-#include "spaceobj.h"
-#include "universe.h"
-#include "mesh.h"
-#include "shader.h"
+#include "Teams.h"
+#include "ObjTypes.h"
+#include "SpaceObj.h"
+#include "Universe.h"
+#include "Mesh.h"
+#include "Shader.h"
 #include "glcaps.h"
-#include "autolod.h"
-#include "crc32.h"
-#include "hash.h"
+#include "AutoLOD.h"
+#include "CRC32.h"
+#include "Hash.h"
 #include "prim3d.h"
-#include "transformer.h"
+#include "Transformer.h"
+
+#ifdef _MSC_VER
+#define strcasecmp _stricmp
+#endif
 
 #define GLVERTEX(x) glVertex4fv((GLfloat*)(x))
 #define VERTEXLIST clipVertexList
@@ -238,20 +246,33 @@
     ShipRace race;
     ShipType type;
 
+#ifdef _WIN32
     dbgAssert(strchr(fileName, '\\'));
     length = strchr(fileName, '\\') - fileName;
+#else
+    dbgAssert(strpbrk(fileName, "\\/"));
+    length = strpbrk(fileName, "\\/") - fileName;
+#endif
     memcpy(raceString, fileName, length);
     raceString[length] = 0;                                 //make a race name
     fileName += length + 1;
 //    dbgAssert(strchr(fileName, '\\'));                      //make a type name
+#ifdef _WIN32
     if (strchr(fileName, '\\') == NULL)
+#else
+    if (strpbrk(fileName, "\\/") == NULL)
+#endif
     {
         return(NULL);
     }
+#ifdef _WIN32
     length = strchr(fileName, '\\') - fileName;
+#else
+    length = strpbrk(fileName, "\\/") - fileName;
+#endif
     memcpy(typeString, fileName, length);
     typeString[length] = 0;
-    if (_stricmp(raceString, "Derelicts") == 0)
+    if (strcasecmp(raceString, "Derelicts") == 0)
     {                                                       //if it's a derelict
         type = StrToDerelictType(typeString);
         dbgAssert(type != 0xffffffff);
@@ -267,11 +288,11 @@
     type = StrToShipType(typeString);
     if (type == 0xffffffff)
     {
-        if (_stricmp(typeString, "MISSILE") == 0)
+        if (strcasecmp(typeString, "MISSILE") == 0)
         {
             info = (StaticInfo *)&missileStaticInfos[race];
         }
-        else if (_stricmp(typeString, "MINE") == 0)
+        else if (strcasecmp(typeString, "MINE") == 0)
         {
             info = (StaticInfo *)&mineStaticInfos[race];
         }
@@ -347,20 +368,28 @@
 void meshTextureNameToPath(char *out, char *mesh, char *tex)
 {
     char *string;
+    unsigned int i;
     //make path of mesh path and \\texture\\<shipNameNoExtension\\<textureFileName>
     strcpy(out, mesh);
 
     string = out;
+#ifdef _WIN32
     while (strchr(string, '\\'))
     {                                               //find last backslash
         string = strchr(string, '\\') + 1;
     }
+#else
+    while (strpbrk(string, "\\/"))
+    {                                               /* find last backslash */
+        string = strpbrk(string, "\\/") + 1;
+    }
+#endif
     dbgAssert(string != out);
     dbgAssert(*string);
     *string = 0;                                    //NULL terminate and append texture name
 
     strcat(out, tex);
-    _strupr(out);
+    for (i = 0; (out[i] = toupper(out[i])); i++) { }
 }
 
 bool meshStringContainsPeriod(char* s)
@@ -397,7 +426,11 @@
         else
         {
             strcat(outFileName, token);
+#ifdef _WIN32
             strcat(outFileName, "\\");
+#else
+            strcat(outFileName, "/");
+#endif
         }
 
         token = strtok(NULL, "\\/");
@@ -607,6 +640,17 @@
     sdword fileLength;
     trhandle handle;
 
+#ifdef ENDIAN_BIG
+    sdword i;
+	udword *vertsDone  = NULL;
+	udword *normsDone  = NULL;
+	udword *polysDone  = NULL;
+	int found          = -1;
+	int vertsDoneCount = 0;
+	int normsDoneCount = 0;
+	int polysDoneCount = 0;
+#endif
+
     bool allowPacking;
     bool newFormat;
 
@@ -629,6 +673,27 @@
 
     file = fileOpen(fileName, 0);                           //open file
     fileBlockRead(file, &header, sizeof(GeoFileHeader));    //read in header
+
+#ifdef ENDIAN_BIG
+	header.version          = LittleLong( header.version );
+	header.pName            = ( char *)LittleLong( ( udword )header.pName );
+	header.fileSize         = LittleLong( header.fileSize );
+	header.localSize        = LittleLong( header.localSize );
+	header.nPublicMaterials = LittleLong( header.nPublicMaterials );
+	header.nLocalMaterials  = LittleLong( header.nLocalMaterials );
+	header.oPublicMaterial  = LittleLong( header.oPublicMaterial );
+	header.oLocalMaterial   = LittleLong( header.oLocalMaterial );
+	header.nPolygonObjects  = LittleLong( header.nPolygonObjects );
+
+	vertsDone = ( udword *)malloc( header.nPolygonObjects * sizeof( udword ) );
+	normsDone = ( udword *)malloc( header.nPolygonObjects * sizeof( udword ) );
+	polysDone = ( udword *)malloc( header.nPolygonObjects * sizeof( udword ) );
+
+	memset( vertsDone, 0, header.nPolygonObjects * sizeof( udword ) );
+	memset( normsDone, 0, header.nPolygonObjects * sizeof( udword ) );
+	memset( polysDone, 0, header.nPolygonObjects * sizeof( udword ) );
+#endif
+
 #if MESH_ERROR_CHECKING
     if (strncmp(header.identifier, MESH_FileID, MESH_FileIDLength))//verify ident. string
     {
@@ -684,6 +749,34 @@
     for (index = 0; index < mesh->nPolygonObjects; index++)
     {
         object = &mesh->object[index];                      //get pointer to poly object
+
+#ifdef ENDIAN_BIG
+		if( !object ) continue;
+
+		object->pName          = ( char *)LittleLong( ( udword )object->pName );
+		object->nameCRC        = LittleShort( object->nameCRC );
+		object->nVertices      = LittleLong( object->nVertices );
+		object->nFaceNormals   = LittleLong( object->nFaceNormals );
+		object->nVertexNormals = LittleLong( object->nVertexNormals );
+		object->nPolygons      = LittleLong( object->nPolygons );
+		object->pVertexList    = ( vertexentry *)LittleLong( ( udword )object->pVertexList );
+		object->pNormalList    = ( normalentry *)LittleLong( ( udword )object->pNormalList );
+		object->pPolygonList   = ( polyentry *)LittleLong( ( udword )object->pPolygonList );
+		object->pMother        = ( polygonobject *)LittleLong( ( udword )object->pMother );
+		object->pDaughter      = ( polygonobject *)LittleLong( ( udword )object->pDaughter );
+		object->pSister        = ( polygonobject *)LittleLong( ( udword )object->pSister );
+
+        // anonymous block so I can declare mptr with limited scope and not have
+        // a plain C compiler complain
+		{
+            real32 *mptr = ( real32 *)&object->localMatrix;
+		    for( i=0; i<16; i++ )
+            {
+			    mptr[i] = LittleFloat( mptr[i] );
+            }
+        }
+#endif
+
         //object->pName += offset;                          //!!! is there a name
         (ubyte *)object->pVertexList += offset;             //fixup vertex list pointer
         (ubyte *)object->pNormalList += offset;             //fixup vertex list pointer
@@ -706,8 +799,104 @@
         }
         object->iObject = index;
         object->nameCRC = crc16Compute((ubyte*)object->pName, strlen(object->pName));
+
+#ifdef ENDIAN_BIG
+		found = -1;
+		for( i=0; i<mesh->nPolygonObjects; i++ )
+		{
+			if( vertsDone[i] == object->pVertexList )
+			{
+				found = i;
+				break;
+			}
+		}
+
+		if( found == -1 )
+		{
+			for( i=0; i<object->nVertices; i++ )
+			{
+				object->pVertexList[i].x = LittleFloat( object->pVertexList[i].x );
+				object->pVertexList[i].y = LittleFloat( object->pVertexList[i].y );
+				object->pVertexList[i].z = LittleFloat( object->pVertexList[i].z );
+				object->pVertexList[i].iVertexNormal = LittleLong( object->pVertexList[i].iVertexNormal );
     }
 
+			vertsDone[vertsDoneCount++] = object->pVertexList;
+		}
+
+		found = -1;
+		for( i=0; i<mesh->nPolygonObjects; i++ )
+		{
+			if( normsDone[i] == object->pNormalList )
+			{
+				found = i;
+				break;
+			}
+		}
+
+		if( found == -1 )
+		{
+			for( i=0; i<object->nFaceNormals + object->nVertexNormals; i++ )
+			{
+				object->pNormalList[i].x = LittleFloat( object->pNormalList[i].x );
+				object->pNormalList[i].y = LittleFloat( object->pNormalList[i].y );
+				object->pNormalList[i].z = LittleFloat( object->pNormalList[i].z );
+			}
+
+			normsDone[normsDoneCount++] = object->pNormalList;
+		}
+
+		found = -1;
+		for( i=0; i<mesh->nPolygonObjects; i++ )
+		{
+			if( polysDone[i] == object->pPolygonList )
+			{
+				found = i;
+				break;
+			}
+		}
+
+		if( found == -1 )
+		{
+			for( i=0; i<object->nPolygons; i++ )
+			{
+				object->pPolygonList[i].iFaceNormal = LittleLong( object->pPolygonList[i].iFaceNormal );
+				object->pPolygonList[i].iV0 = LittleShort( object->pPolygonList[i].iV0 );
+				object->pPolygonList[i].iV1 = LittleShort( object->pPolygonList[i].iV1 );
+				object->pPolygonList[i].iV2 = LittleShort( object->pPolygonList[i].iV2 );
+				object->pPolygonList[i].iMaterial = LittleShort( object->pPolygonList[i].iMaterial );
+				object->pPolygonList[i].s0 = LittleFloat( object->pPolygonList[i].s0 );
+				object->pPolygonList[i].t0 = LittleFloat( object->pPolygonList[i].t0 );
+				object->pPolygonList[i].s1 = LittleFloat( object->pPolygonList[i].s1 );
+				object->pPolygonList[i].t1 = LittleFloat( object->pPolygonList[i].t1 );
+				object->pPolygonList[i].s2 = LittleFloat( object->pPolygonList[i].s2 );
+				object->pPolygonList[i].t2 = LittleFloat( object->pPolygonList[i].t2 );
+				object->pPolygonList[i].flags = LittleShort( object->pPolygonList[i].flags );
+			}
+
+			polysDone[polysDoneCount++] = object->pPolygonList;
+		}
+    }
+
+	free( vertsDone );
+	free( normsDone );
+	free( polysDone );
+
+	for (index = 0; index < mesh->nLocalMaterials + mesh->nPublicMaterials; index++)
+	{
+		mesh->localMaterial[index].pName = ( char *)LittleLong( ( udword )mesh->localMaterial[index].pName );
+//		mesh->localMaterial[index].ambient = LittleLong( mesh->localMaterial[index].ambient );
+//		mesh->localMaterial[index].diffuse = LittleLong( mesh->localMaterial[index].diffuse );
+//		mesh->localMaterial[index].specular = LittleLong( mesh->localMaterial[index].specular );
+		mesh->localMaterial[index].kAlpha = LittleFloat( mesh->localMaterial[index].kAlpha );
+		mesh->localMaterial[index].texture = LittleLong( mesh->localMaterial[index].texture );
+		mesh->localMaterial[index].flags = LittleShort( mesh->localMaterial[index].flags );
+		mesh->localMaterial[index].textureNameSave = ( char *)LittleLong( ( udword )mesh->localMaterial[index].textureNameSave );
+#endif // ENDIAN_BIG
+
+	} // ENDIAN_BIG:    end of for(index < mesh->nLocalMaterials...) loop
+      // everyone else: end of for(index < mesh->nPolygonObjects)    loop
+
     if (allowPacking && mainOnlyPacking && (fileName != pagedName))
     {
         for (index = 0; index < mesh->nLocalMaterials + mesh->nPublicMaterials; index++)
@@ -1369,9 +1558,15 @@
 {
     sdword iPoly;
     polyentry* polygon;
+    char *fileNameFull;
     FILE* out;
 
-    out = fopen("uv.txt", "at");
+    fileNameFull = filePathPrepend("uv.txt", FF_UserSettingsPath);
+
+    if (!fileMakeDestinationDirectory(fileNameFull))
+        return;
+
+    out = fopen(fileNameFull, "at");
     if (out == NULL)
     {
         return;
diff -urPw homeworld-orig/src/Game/Mesh.h homeworld_sdl-0.3/src/Game/Mesh.h
--- homeworld-orig/src/Game/Mesh.h	2002-09-04 12:46:14.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Mesh.h	2004-08-01 22:35:33.000000000 -0700
@@ -9,9 +9,9 @@
 #ifndef ___MESH_H
 #define ___MESH_H
 
-#include "types.h"
+#include "Types.h"
 #include "color.h"
-#include "matrix.h"
+#include "Matrix.h"
 
 /*=============================================================================
     Switches:
@@ -55,7 +55,11 @@
 #define MESH_FileIDLength               8
 #define MESH_Version                    (0x00000402)
 
+#ifdef _WIN32
 #define MESH_TextureSubDir              "Textures\\"
+#else
+#define MESH_TextureSubDir              "Textures/"
+#endif
 
 #define MDF_AnimatingTextureMap         1
 #define MDF_Smoothing                   2
@@ -213,6 +217,7 @@
 meshdata;
 
 //hierarchy binding information
+struct shipbindings;
 typedef bool (*mhbindingfunction)(udword flags, hmatrix *startMatrix, hmatrix *matrix, void *data, sdword ID);
 typedef void (*mhhelperfunction)(meshdata *mesh, struct shipbindings *bindings, sdword currentLOD);
 typedef struct
diff -urPw homeworld-orig/src/Game/MEX.c homeworld_sdl-0.3/src/Game/MEX.c
--- homeworld-orig/src/Game/MEX.c	2002-09-04 12:46:14.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/MEX.c	2004-08-01 22:35:33.000000000 -0700
@@ -7,21 +7,26 @@
 =============================================================================*/
 
 #include <string.h>
+#include <strings.h>
 #include <math.h>
-#include "types.h"
-#include "vector.h"
-#include "matrix.h"
-#include "memory.h"
-#include "debug.h"
-#include "file.h"
-#include "mex.h"
+#include "Types.h"
+#include "Vector.h"
+#include "Matrix.h"
+#include "Memory.h"
+#include "Debug.h"
+#include "File.h"
+#include "MEX.h"
 #include "color.h"
 
+#ifdef _MSC_VER
+#define strcasecmp _stricmp
+#endif
+
 bool mexVerify(void *mex)
 {
     ubyte *curmexptr = (ubyte *)mex;
 
-    if (_stricmp(curmexptr,"mannngo") == 0)
+    if (strcasecmp(curmexptr,"mannngo") == 0)
     {
         return TRUE;
     }
@@ -34,8 +39,85 @@
 void *mexLoad(char *filename)
 {
     void *address;
+
+#ifdef ENDIAN_BIG
+	MEXFileHeader *mex;
+	MEXChunk *chunk;
+	unsigned char i;
+#endif
+
     fileLoadAlloc(filename,&address,NonVolatile);
 
+#ifdef ENDIAN_BIG
+	mex          = ( MEXFileHeader *)address;
+	mex->version = LittleShort( mex->version );
+	mex->nChunks = LittleShort( mex->nChunks );
+
+	chunk = ( MEXChunk *)( ( ( ubyte *)mex ) + sizeof( MEXFileHeader ) );
+	for( i=0; i<mex->nChunks; i++ )
+	{
+		chunk->chunkSize = LittleLong( chunk->chunkSize );
+
+		if(( strcasecmp( chunk->type, "Gun" ) == 0 )
+	    || ( strcasecmp( chunk->type, "Eng" ) == 0 )
+		|| ( strcasecmp( chunk->type, "Dok" ) == 0 )
+		|| ( strcasecmp( chunk->type, "Sal" ) == 0 ) )
+		{
+			MEXGunChunk *chunk1 = ( MEXGunChunk *)chunk;
+
+			chunk1->position.x = LittleFloat( chunk1->position.x );
+			chunk1->position.y = LittleFloat( chunk1->position.y );
+			chunk1->position.z = LittleFloat( chunk1->position.z );
+
+			chunk1->normal.x = LittleFloat( chunk1->normal.x );
+			chunk1->normal.y = LittleFloat( chunk1->normal.y );
+			chunk1->normal.z = LittleFloat( chunk1->normal.z );
+
+			chunk1->coneAngle = LittleFloat( chunk1->coneAngle );
+			chunk1->edgeAngle = LittleFloat( chunk1->edgeAngle );
+		}
+
+		if( strcasecmp( chunk->type, "Col" ) == 0 )
+		{
+			MEXCollisionSphereChunk *chunk1 = ( MEXCollisionSphereChunk *)chunk;
+
+			chunk1->level = LittleLong( chunk1->level );
+
+			chunk1->offset.x = LittleFloat( chunk1->offset.x );
+			chunk1->offset.y = LittleFloat( chunk1->offset.y );
+			chunk1->offset.z = LittleFloat( chunk1->offset.z );
+
+			chunk1->r = LittleFloat( chunk1->r );
+		}
+		
+		if( strcasecmp( chunk->type, "Rct" ) == 0 )
+		{
+			MEXCollisionRectangleChunk *chunk1 = ( MEXCollisionRectangleChunk *)chunk;
+
+			chunk1->level = LittleLong( chunk1->level );
+
+			chunk1->ox = LittleFloat( chunk1->ox );
+			chunk1->oy = LittleFloat( chunk1->oy );
+			chunk1->oz = LittleFloat( chunk1->oz );
+
+			chunk1->dx = LittleFloat( chunk1->dx );
+			chunk1->dy = LittleFloat( chunk1->dy );
+			chunk1->dz = LittleFloat( chunk1->dz );
+		}
+
+		if( strcasecmp( chunk->type, "Nav" ) == 0 )
+		{
+			MEXNAVLightChunk *chunk1 = ( MEXNAVLightChunk *)chunk;
+
+			chunk1->position.x = LittleFloat( chunk1->position.x );
+			chunk1->position.y = LittleFloat( chunk1->position.y );
+			chunk1->position.z = LittleFloat( chunk1->position.z );
+		}
+
+		chunk = ( MEXChunk *)( ( ( ubyte *)chunk ) + sizeof( MEXChunk ) + chunk->chunkSize );
+	}
+#endif // ENDIAN_BIG
+
     dbgAssert(address != NULL);
     if (!mexVerify(address))
     {
@@ -59,9 +141,9 @@
 
     for (i=0;i<numChunks;i++)
     {
-        if (_stricmp(curmexchunk->type,type) == 0)
+        if (strcasecmp(curmexchunk->type,type) == 0)
         {
-            if (_stricmp(curmexchunk->name,name) == 0)
+            if (strcasecmp(curmexchunk->name,name) == 0)
             {
                 return (void *)curmexchunk;
             }
@@ -82,11 +164,11 @@
 
     for (i=0;i<numChunks;i++)
     {
-        if (_stricmp(curmexchunk->type,"Dok") == 0)
+        if (strcasecmp(curmexchunk->type,"Dok") == 0)
         {
-            if (_stricmp(curmexchunk->name,"Dock") == 0)
+            if (strcasecmp(curmexchunk->name,"Dock") == 0)
             {
-                if (_stricmp(((MEXDockingChunk *)curmexchunk)->dockName,dockname) == 0)
+                if (strcasecmp(((MEXDockingChunk *)curmexchunk)->dockName,dockname) == 0)
                 {
                     return (MEXDockingChunk *)curmexchunk;
                 }
@@ -108,11 +190,11 @@
 
     for (i=0;i<numChunks;i++)
     {
-        if (_stricmp(curmexchunk->type,"Sal") == 0)
+        if (strcasecmp(curmexchunk->type,"Sal") == 0)
         {
-            if (_stricmp(curmexchunk->name,"SALVAGE") == 0)
+            if (strcasecmp(curmexchunk->name,"SALVAGE") == 0)
             {
-                if (_stricmp(((MEXSalvageChunk *)curmexchunk)->Name,salvagename) == 0)
+                if (strcasecmp(((MEXSalvageChunk *)curmexchunk)->Name,salvagename) == 0)
                 {
                     return (MEXSalvageChunk *)curmexchunk;
                 }
@@ -135,11 +217,11 @@
 
     for (i=0;i<numChunks;i++)
     {
-        if (_stricmp(curmexchunk->type,"Nav") == 0)
+        if (strcasecmp(curmexchunk->type,"Nav") == 0)
         {
-            if (_stricmp(curmexchunk->name,"Nav") == 0)
+            if (strcasecmp(curmexchunk->name,"Nav") == 0)
             {
-                if (_stricmp(((MEXNAVLightChunk *)curmexchunk)->NAVLightName,navLightName) == 0)
+                if (strcasecmp(((MEXNAVLightChunk *)curmexchunk)->NAVLightName,navLightName) == 0)
                 {
                     return (MEXNAVLightChunk *)curmexchunk;
                 }
diff -urPw homeworld-orig/src/Game/MEX.h homeworld_sdl-0.3/src/Game/MEX.h
--- homeworld-orig/src/Game/MEX.h	2002-09-04 12:46:14.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/MEX.h	2004-08-01 22:35:33.000000000 -0700
@@ -9,9 +9,9 @@
 #ifndef ___MEX_H
 #define ___MEX_H
 
-#include "types.h"
-#include "vector.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Vector.h"
+#include "SpaceObj.h"
 
 typedef struct tagMEXFileHeader
 {
diff -urPw homeworld-orig/src/Game/MultiplayerGame.c homeworld_sdl-0.3/src/Game/MultiplayerGame.c
--- homeworld-orig/src/Game/MultiplayerGame.c	2002-09-04 12:46:14.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/MultiplayerGame.c	2004-08-01 22:35:24.000000000 -0700
@@ -6,41 +6,54 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include <windows.h>
+#define _GNU_SOURCE   /* Get to wcscasecmp() */
+
 #include <stdio.h>
+#include <stdlib.h>
+#include <strings.h>
+
+#ifndef _MACOSX
+    #include <wchar.h>
+#endif
+
 #include "MultiplayerGame.h"
 #include "MultiplayerLANGame.h"
-#include "feflow.h"
+#include "FEFlow.h"
 #include "utility.h"
-#include "scenpick.h"
-#include "uicontrols.h"
+#include "ScenPick.h"
+#include "UIControls.h"
 #include "TitanInterfaceC.h"
-#include "titannet.h"
-#include "region.h"
+#include "TitanNet.h"
+#include "Region.h"
 #include "mouse.h"
-#include "fontreg.h"
-#include "scroller.h"
-#include "linkedlist.h"
+#include "FontReg.h"
+#include "Scroller.h"
+#include "LinkedList.h"
 #include "prim2d.h"
-#include "randy.h"
-#include "chatting.h"
-#include "commandnetwork.h"
-#include "globals.h"
-#include "msg\serverstatus.h"
+#include "Randy.h"
+#include "Chatting.h"
+#include "CommandNetwork.h"
+#include "Globals.h"
+#include "msg/ServerStatus.h"
 #include "ChannelFSM.h"
-#include "colpick.h"
+#include "ColPick.h"
 #include "mainswitches.h"
-#include "chatting.h"
-#include "strings.h"
-#include "queue.h"
-#include "titan.h"
-#include "file.h"
-#include "statscript.h"
-#include "titannet.h"
-#include "universe.h"
-#include "gamechat.h"
+#include "Chatting.h"
+#include "Strings.h"
+#include "Queue.h"
+#include "Titan.h"
+#include "File.h"
+#include "StatScript.h"
+#include "TitanNet.h"
+#include "Universe.h"
+#include "GameChat.h"
 #include "SaveGame.h" // for ConvertNumToPointerInList
 
+#ifdef _MSC_VER
+#define strncasecmp _strnicmp
+#define wcscasecmp wcsicmp
+#endif
+
 #ifdef HW_Debug
 #ifdef gshaw
 #define NEED_MIN_TWO_HUMAN_PLAYERS  0
@@ -51,7 +64,11 @@
     Defines:
 =============================================================================*/
 
+#ifdef _WIN32
 #define MG_FIBFile_SERVERS      "FEMan\\Choose_Server.FIB"
+#else
+#define MG_FIBFile_SERVERS      "FEMan/Choose_Server.FIB"
+#endif
 
 #define MG_FontNameLength       64
 
@@ -192,14 +209,14 @@
 bool            mgCreatingNetworkGame = FALSE;
 
 // structures and variables for creating a game.
-CaptainGameInfo tpGameCreated=
+extern CaptainGameInfo tpGameCreated;
 // N    P   M   D   u   p      nc  sf  bs  sr   ii    ia     lt    la   ad  ab  p     f
- {L"", L"", "", "", 0,  0,0,0,  0,  1,  3,   1, 1440, 2000, 19200, 2000, 50, 50, 0, 22058};
+//= {L"", L"", "", "", 0,  {0,0,0},  0,  1,  3,   1, 1440, 2000, 19200, 2000, 50, 50, 0, 22058};
 
 CaptainGameInfo BackupGameCreated;
 sdword          spCurrentSelectedBack;
-char            scenPickBack[];
-Address myAddress;
+/*char            scenPickBack[]*/
+char           *scenPickBack;
 
 // tweakable fonthandles.
 fonthandle mgListOfGamesFont=0;
@@ -503,9 +520,6 @@
 // temporary variable for storing name, in case of cancel
 char tempname[64];
 
-wchar_t GameWereInterestedIn[MAX_TITAN_GAME_NAME_LEN] = L"";
-void *GameWereInterestedInMutex;
-
 CaptainGameInfo joinBackuptpGameCreated;
 bool joinBackuptpGameCreatedValid = FALSE;
 
@@ -929,9 +943,11 @@
 
 void mgGameInterestedIn(wchar_t *interested)
 {
+#ifndef _MACOSX_FIX_ME
     LockMutex(GameWereInterestedInMutex);
     wcscpy(GameWereInterestedIn,interested);
     UnLockMutex(GameWereInterestedInMutex);
+#endif
 }
 
 void mgGameInterestedOff()
@@ -990,7 +1006,7 @@
                 {
                     user = listGetStructOfNode(walk);
                     gcRemoveAmpersands(ampremoved, user->userName);
-                    if (strnicmp(ampremoved,toname,i)==0)
+                    if (strncasecmp(ampremoved,toname,i)==0)
                     {
                         // found a match so far
                         matched = user;
@@ -1013,7 +1029,7 @@
                 {
                     guser = listGetStructOfNode(walk);
                     gcRemoveAmpersands(ampremoved, guser->name);
-                    if (strnicmp(ampremoved,toname,i)==0)
+                    if (strncasecmp(ampremoved,toname,i)==0)
                     {
                         // found a match so far
                         gmatched = guser;
@@ -1089,7 +1105,7 @@
                 {
                     user = listGetStructOfNode(walk);
                     gcRemoveAmpersands(ampremoved, user->userName);
-                    if (strnicmp(ampremoved,toname,i)==0)
+                    if (strncasecmp(ampremoved,toname,i)==0)
                     {
                         // found a match so far
                         matched = user;
@@ -1112,7 +1128,7 @@
                 {
                     guser = listGetStructOfNode(walk);
                     gcRemoveAmpersands(ampremoved, guser->name);
-                    if (strnicmp(ampremoved,toname,i)==0)
+                    if (strncasecmp(ampremoved,toname,i)==0)
                     {
                         // found a match so far
                         gmatched = guser;
@@ -1163,7 +1179,7 @@
     {
         namestruct = (mgUserNameList *)listGetStructOfNode(search);
 
-        if (strnicmp(name, namestruct->name, MAX_PERSONAL_NAME_LEN)==0)
+        if (strncasecmp(name, namestruct->name, MAX_PERSONAL_NAME_LEN)==0)
         {
             return(search);
         }
@@ -1292,7 +1308,7 @@
 
         while (mgCommandInfoPtr[i].callback != NULL)
         {
-            if ((strnicmp(parse, mgCommandInfoPtr[i].Command, max(strlen(mgCommandInfoPtr[i].Command),space-text-1))==0) &&
+            if ((strncasecmp(parse, mgCommandInfoPtr[i].Command, max(strlen(mgCommandInfoPtr[i].Command),space-text-1))==0) &&
                 (space[0] == ' ') &&
                 (  ((GameCreator) && (mgCommandInfoPtr[i].captainonly)) ||
                    ((preGameChat)&&(mgCommandInfoPtr[i].pregamechat)) ||
@@ -1337,7 +1353,6 @@
     sdword      j,i,nummatches, command=-1;
     char        toname[64], compname[64];
     bool        done=FALSE;
-    bool        matched=FALSE;
 
     // if not command at all then return NULL
     if (text[0]!='!') return(-1);
@@ -1366,7 +1381,7 @@
 
                 for (j=0;mgCommandInfoPtr[j].callback != NULL;j++)
                 {
-                    if ((strnicmp(toname, mgCommandInfoPtr[j].Command, strlen(toname))==0) &&
+                    if ((strncasecmp(toname, mgCommandInfoPtr[j].Command, strlen(toname))==0) &&
                         (  ((GameCreator) && (mgCommandInfoPtr[j].captainonly)) ||
                            ((preGameChat)&&(mgCommandInfoPtr[j].pregamechat)) ||
                            ((!preGameChat)&&(mgCommandInfoPtr[j].roomchat))) )
@@ -1615,8 +1630,8 @@
 ----------------------------------------------------------------------------*/
 void LockMutex(void *mutex)
 {
-    DWORD result = WaitForSingleObject((HANDLE)mutex, INFINITE);
-    dbgAssert(result != WAIT_FAILED);
+    int result = SDL_mutexP(mutex);
+    dbgAssert(result != -1);
 }
 
 /*-----------------------------------------------------------------------------
@@ -1628,8 +1643,8 @@
 ----------------------------------------------------------------------------*/
 void UnLockMutex(void *mutex)
 {
-    BOOL result = ReleaseMutex((HANDLE)mutex);
-    dbgAssert(result);
+    int result = SDL_mutexV(mutex);
+    dbgAssert(result != -1);
 }
 
 /*-----------------------------------------------------------------------------
@@ -1641,7 +1656,7 @@
 ----------------------------------------------------------------------------*/
 void *gameCreateMutex()
 {
-    return (void *)CreateMutex(NULL,FALSE,NULL);
+    return SDL_CreateMutex();
 }
 
 /*-----------------------------------------------------------------------------
@@ -1653,7 +1668,7 @@
 ----------------------------------------------------------------------------*/
 void gameCloseMutex(void *mutex)
 {
-    CloseHandle((HANDLE)mutex);
+    SDL_DestroyMutex(mutex);
 }
 
 /*=============================================================================
@@ -1822,6 +1837,11 @@
     tpGameCreated.numComputers  = 1;
     tpGameCreated.numPlayers    = 1;
     mgShowScreen(MGS_Skirmish_Basic, TRUE);
+
+#ifdef _MACOSX_FIX_ME
+	multiPlayerGame = FALSE;
+#endif
+
 #endif
 }
 
@@ -1910,7 +1930,7 @@
     }
     else
     {
-        firewallButton = (ubyte)atom->pData;
+        firewallButton = (ubyte)(size_t)atom->pData;
     }
 }
 
@@ -2386,7 +2406,8 @@
                         aNumChars = mbstowcs(aWideStringP, strptr, (uword)strlen(strptr));
                         if (aNumChars != (size_t)-1)
                         {
-                            SendPrivateChatMessage(&user->userID,1,(uword)(aNumChars*2),aWideStringP);
+                            SendPrivateChatMessage((unsigned long*)(&user->userID), 1,
+                                                   (uword)(aNumChars*2),aWideStringP);
                         }
                     }
                 }
@@ -2703,6 +2724,7 @@
 
 void mgJoinChannel(char*name,featom*atom)
 {
+#ifndef _MACOSX_FIX_ME
     sdword       i;
     channellist *channelinfo;
 
@@ -2728,6 +2750,7 @@
             }
         }
     }
+#endif
 }
 
 void mgCreateChannel(char*name,featom*atom)
@@ -2999,6 +3022,7 @@
 
 bool channelAlreadyExists(wchar_t *channelname)
 {
+#ifndef _MACOSX_FIX_ME
     sdword i;
 
     tpLockChannelList();
@@ -3012,6 +3036,8 @@
         }
     }
     tpUnLockChannelList();
+#endif
+
     return FALSE;
 }
 
@@ -3202,6 +3228,7 @@
             }
         }
 
+#ifndef _MACOSX_FIX_ME
         if (wcslen(gameinfo->game.directoryCustomInfo.stringdata)>1)
         {
             joingame = &gameinfo->game;
@@ -3211,6 +3238,7 @@
         {
             mgRequestJoinGame(&gameinfo->game);
         }
+#endif
     }
 }
 
@@ -3238,7 +3266,10 @@
 // callback for sorting the game list window
 bool mgListOfGamesCompare(void *firststruct,void *secondstruct)
 {
+#ifndef _MACOSX_FIX_ME
     sdword i;
+#endif
+
     gamelist *one = (gamelist *)(((listitemhandle)firststruct)->data);
     gamelist *two = (gamelist *)(((listitemhandle)secondstruct)->data);
 
@@ -3253,11 +3284,11 @@
             return(FALSE);
     }
 
-
+#ifndef _MACOSX_FIX_ME
     switch (mgListOfGamesWindow->sorttype)
     {
         case MG_SortByGameName:
-            if ((i=wcsicmp( one->game.Name,two->game.Name)) > 0)
+            if ((i=wcscasecmp( one->game.Name,two->game.Name)) > 0)
                 return (mgListOfGamesWindow->sortOrder);
             else
             {
@@ -3294,7 +3325,7 @@
             wchar_t *onemapname = one->game.directoryCustomInfo.stringdata + 1+wcslen(one->game.directoryCustomInfo.stringdata);
             wchar_t *twomapname = two->game.directoryCustomInfo.stringdata + 1+wcslen(two->game.directoryCustomInfo.stringdata);
 
-            if ((i=wcsicmp( onemapname,twomapname)) > 0)
+            if ((i=wcscasecmp( onemapname,twomapname)) > 0)
                 return (mgListOfGamesWindow->sortOrder);
             else
             {
@@ -3306,6 +3337,9 @@
 
         }
     }
+#endif // _MACOSX_FIX_ME
+
+    return FALSE;
 }
 
 // callback if the title is clicked on
@@ -3465,10 +3499,13 @@
     color       c;
     fonthandle  oldfont;
     gamelist   *gameinfo = (gamelist *)data->data;
-    udword passwordlen;
     bool gameinprogress = gameinfo->game.directoryCustomInfo.flag & GAME_IN_PROGRESS;
     bool diffversion = (!CheckNetworkVersionCompatibility(gameinfo->game.directoryCustomInfo.versionInfo));
 
+#ifndef _MACOSX_FIX_ME
+    udword passwordlen;
+#endif
+
     oldfont = fontMakeCurrent(mgListOfGamesFont);
 
     if (data->flags&UICLI_Selected)
@@ -3501,6 +3538,7 @@
     sprintf(temp,"%i",gameinfo->game.directoryCustomInfo.numPlayers);
     fontPrint(x-fontWidth(temp)-fontWidth("W"),y,c,temp);
 
+#ifndef _MACOSX_FIX_ME
     passwordlen = wcslen(gameinfo->game.directoryCustomInfo.stringdata);
 
     wcstombs(temp,gameinfo->game.directoryCustomInfo.stringdata + 1+passwordlen,512);
@@ -3521,6 +3559,7 @@
     }
 
     fontMakeCurrent(oldfont);
+#endif
 }
 
 // initilize the list of games window structure to needed settings
@@ -4113,6 +4152,7 @@
 
 bool mgInvalidGameName()
 {
+#ifndef _MACOSX_FIX_ME
     featom  *atomchange;
 
     if (wcslen(tpGameCreated.Name)<2)
@@ -4137,12 +4177,14 @@
 
         return TRUE;
     }
+#endif
 
     return FALSE;
 }
 
 bool mgInvalidGamePassword()
 {
+#ifndef _MACOSX_FIX_ME
     if (bitTest(tpGameCreated.flag,MG_PasswordProtected))
     {
         if (wcslen(tpGameCreated.Password) < 2)
@@ -4150,6 +4192,7 @@
             return TRUE;
         }
     }
+#endif
 
     return FALSE;
 }
@@ -4194,12 +4237,14 @@
                 return;
             }
 
+#ifndef _MACOSX_FIX_ME
             if (wcslen(GetCurrentChannel()) <= 0)
             {
                 mgPrepareMessageBox(strGetString(strMustBeInRoomToCreateGame),strGetString(strMustBeInRoomToCreateGame2));
                 mgShowScreen(MGS_Message_Box,FALSE);
                 return;
             }
+#endif
 
             if (mgInvalidGamePassword())
             {
@@ -4336,11 +4381,13 @@
 }
 
 
-/*void mgAcceleratorRelease(void)
+#if 0
+void mgAcceleratorRelease(void)
 {
-/*    mgAccRate = MG_START_ACC_RATE;
+/*    mgAccRate = MG_START_ACC_RATE;*/
     mgAccCount = 1;
-}*/
+}
+#endif
 
 sdword mgSelectOpponentType(regionhandle region, sdword yClicked)
 {
@@ -4384,7 +4431,8 @@
             mgRemoveCPUOpp();
         mgCPULeftArrowActive = TRUE;
 
-/*        if ( TRUE ) // max  )
+#if 0
+        if ( TRUE ) // max  )
         {
             mgCPULeftArrowActive = TRUE;
             if (mgAccelerator())
@@ -4392,8 +4440,9 @@
         }
         else
         {
-            /*    Put sound effect HERE
-        }*/
+            /*    Put sound effect HERE */
+        }
+#endif
     }
     region->status |= RSF_DrawThisFrame;
     return(0);
@@ -4422,7 +4471,8 @@
         if (mgAccelerator())
             mgAddCPUOpp();
         mgCPURightArrowActive = TRUE;
-/*        if ( TRUE /* max  )
+#if 0
+        if ( TRUE /* max */ )
         {
             mgCPURightArrowActive = TRUE;
             if (mgAccelerator())
@@ -4434,7 +4484,8 @@
         else
         {
             //    Put sound effect HERE
-        }*/
+        }
+#endif
     }
     region->status |= RSF_DrawThisFrame;
     return(0);
@@ -4627,7 +4678,7 @@
     }
     else
     {
-        tpGameCreated.startingFleet = (ubyte)atom->pData;
+        tpGameCreated.startingFleet = (ubyte)(size_t)atom->pData;
     }
     mgGameTypesOtherButtonPressed();
 }
@@ -4669,7 +4720,7 @@
     }
     else
     {
-        gameNum = (ubyte)atom->pData;
+        gameNum = (ubyte)(size_t)atom->pData;
         mgSetGameTypeByNum(gameNum);
         //regRecursiveSetReallyDirty(feStack[feStackIndex].baseRegion);
         feAllCallOnCreate(feStack[feStackIndex].screen);
@@ -4843,7 +4894,7 @@
     }
     else
     {
-        tpGameCreated.bountySize = (ubyte)atom->pData;
+        tpGameCreated.bountySize = (ubyte)(size_t)atom->pData;
     }
     mgGameTypesOtherButtonPressed();
 #endif
@@ -5019,7 +5070,7 @@
     }
     else
     {
-        tpGameCreated.startingResources = (ubyte)atom->pData;
+        tpGameCreated.startingResources = (ubyte)(size_t)atom->pData;
     }
     mgGameTypesOtherButtonPressed();
 }
@@ -5098,7 +5149,7 @@
     {
         // initialize button here
         mgResourceInjectionAmountEntryBox = (textentryhandle)atom->pData;
-        sprintf(temp,"%d",tpGameCreated.resourceInjectionsAmount);
+        sprintf(temp,"%ld",tpGameCreated.resourceInjectionsAmount);
         uicTextEntrySet(mgResourceInjectionAmountEntryBox,temp,strlen(temp)+1);
         uicTextBufferResize(mgResourceInjectionAmountEntryBox,MAX_NUM_LENGTH-6);
         uicTextEntryInit(mgResourceInjectionAmountEntryBox,UICTE_NumberEntry);
@@ -5110,7 +5161,7 @@
     {
         case CM_LoseFocus :
         case CM_AcceptText :
-            sscanf(mgResourceInjectionAmountEntryBox->textBuffer,"%d",&tpGameCreated.resourceInjectionsAmount);
+            sscanf(mgResourceInjectionAmountEntryBox->textBuffer,"%ld",&tpGameCreated.resourceInjectionsAmount);
             if (uicTextEntryMessage(atom)==CM_AcceptText) feToggleButtonSet("MG_ResourceInjections", TRUE);
         break;
         case CM_GainFocus :
@@ -5193,7 +5244,7 @@
     {
         // initialize button here
         mgResourceLumpSumAmountEntryBox = (textentryhandle)atom->pData;
-        sprintf(temp,"%d",tpGameCreated.resourceLumpSumAmount);
+        sprintf(temp,"%ld",tpGameCreated.resourceLumpSumAmount);
         uicTextEntrySet(mgResourceLumpSumAmountEntryBox,temp,strlen(temp)+1);
         uicTextBufferResize(mgResourceLumpSumAmountEntryBox,MAX_NUM_LENGTH-6);
         uicTextEntryInit(mgResourceLumpSumAmountEntryBox,UICTE_NumberEntry);
@@ -5205,7 +5256,7 @@
     {
         case CM_LoseFocus :
         case CM_AcceptText :
-            sscanf(mgResourceLumpSumAmountEntryBox->textBuffer,"%d",&tpGameCreated.resourceLumpSumAmount);
+            sscanf(mgResourceLumpSumAmountEntryBox->textBuffer,"%ld",&tpGameCreated.resourceLumpSumAmount);
             if (uicTextEntryMessage(atom)==CM_AcceptText) feToggleButtonSet("MG_ResourceLumpSum", TRUE);
         break;
         case CM_GainFocus :
@@ -5483,6 +5534,7 @@
 
 void mgGoPassword(char *name, featom *atom)
 {
+#ifndef _MACOSX_FIX_ME
     static wchar_t widepasswordentryboxtext[MAX_PASSWORD_LENGTH];
 
     if (joingame!=NULL)
@@ -5498,6 +5550,7 @@
             mgShowScreen(MGS_Message_Box,FALSE);
         }
     }
+#endif
 }
 
 void mgBackFromRoomPassword(char *name, featom *atom)
@@ -5507,11 +5560,13 @@
 
 void mgGoRoomPassword(char *name, featom *atom)
 {
+#ifndef _MACOSX_FIX_ME
     if (wcslen(joinchannelname) >= 2)
     {
         mbstowcs(ChannelPassword,mgGamePasswordEntryEntryBox->textBuffer,strlen(mgGamePasswordEntryEntryBox->textBuffer)+1);
         mgJoinChannelNow(joinchannelname,joinchanneldescription);
     }
+#endif
 }
 
 /*=============================================================================
@@ -5756,6 +5811,7 @@
 
 void mgProcessGameListGameAdded(mgqueuegamelistgame *added)
 {
+#ifndef _MACOSX_FIX_ME
     Node       *walk;
     gamelist   *gameinfo;
 
@@ -5795,10 +5851,12 @@
     {
         gameinfo->item = NULL;
     }
+#endif
 }
 
 void mgProcessGameListGameRemoved(mgqueuegamelistgame *removed)
 {
+#ifndef _MACOSX_FIX_ME
     Node       *walk;
     gamelist   *gameinfo;
 
@@ -5833,10 +5891,12 @@
     }
 
     listDeleteNode(walk);
+#endif
 }
 
 void mgProcessGameListGameChanged(mgqueuegamelistgame *changed)
 {
+#ifndef _MACOSX_FIX_ME
     Node       *walk;
     gamelist   *gameinfo;
 
@@ -5872,6 +5932,7 @@
 #endif
         mgListOfGamesWindow->reg.status |= RSF_DrawThisFrame;
     }
+#endif // _MACOSX_FIX_ME
 }
 
 void mgProcessGameListNew(mgqueuegamelistnew *newlist)
@@ -6084,6 +6145,7 @@
 #pragma optimize("gy", off)                       //turn on stack frame (we need ebp for this function)
 void mgProcessCallBacksTask(void)
 {
+#ifndef _MACOSX_FIX_ME
     static Node           *walk;
     static Node           *nextnode;
     static channellist    *channelinfo;
@@ -6095,7 +6157,9 @@
 
     taskYield(0);
 
+#ifndef C_ONLY
     while (1)
+#endif
     {
         taskStackSaveCond(0);
 #if defined(OEM) || defined(Downloadable) || defined(CGW)
@@ -6313,7 +6377,7 @@
         {
             LockQueue(&mgThreadTransfer);
 
-            sizeofpacket = Dequeue(&mgThreadTransfer, &packet);
+            sizeofpacket = HWDequeue(&mgThreadTransfer, &packet);
             dbgAssert(sizeofpacket > 0);
             copypacket = memAlloc(sizeofpacket,"mg(mgthreadtransfer)", Pyrophoric);
             memcpy(copypacket, packet, sizeofpacket);
@@ -6408,6 +6472,7 @@
         taskStackRestoreCond();
         taskYield(0);
     }
+#endif // _MACOSX_FIX_ME
 }
 #pragma optimize("", on)
 
@@ -6531,9 +6596,9 @@
 
     GameWereInterestedIn[0] = 0;
 
-    changescreenmutex       = (void *)CreateMutex(NULL,FALSE,NULL);
-    gamestartedmutex        = (void *)CreateMutex(NULL,FALSE,NULL);
-    GameWereInterestedInMutex = (void *)CreateMutex(NULL,FALSE,NULL);
+    changescreenmutex       = SDL_CreateMutex();
+    gamestartedmutex        = SDL_CreateMutex();
+    GameWereInterestedInMutex = SDL_CreateMutex();
 
     ProccessCallback = taskStart(mgProcessCallBacksTask, MG_TaskServicePeriod, 0);
     taskPause(ProccessCallback);
@@ -6569,9 +6634,9 @@
 {
     CloseQueue(&mgThreadTransfer);
 
-    CloseHandle((HANDLE)changescreenmutex);
-    CloseHandle((HANDLE)gamestartedmutex);
-    CloseHandle((HANDLE)GameWereInterestedInMutex);
+    SDL_DestroyMutex(changescreenmutex);
+    SDL_DestroyMutex(gamestartedmutex);
+    SDL_DestroyMutex(GameWereInterestedInMutex);
 
     titanGameShutdown();
 }
@@ -6625,7 +6690,7 @@
     strcpy(user.user.userName, utyName);
     user.user.userID = userID;
 
-    Enqueue(&mgThreadTransfer, (ubyte *)&user, sizeof(mgqueueuserlist));
+    HWEnqueue(&mgThreadTransfer, (ubyte *)&user, sizeof(mgqueueuserlist));
 
     // Queue up the packet that will say, <you> have joined the room.
     chat.header.packettype = MG_QUEUEROOMCHATINFO;
@@ -6634,7 +6699,7 @@
     chat.chat.index = userID;
     chat.chat.messagetype = MG_MESSAGECHAT;
 
-    Enqueue(&mgThreadTransfer, (ubyte *)&chat, sizeof(mgqueuechatlist));
+    HWEnqueue(&mgThreadTransfer, (ubyte *)&chat, sizeof(mgqueuechatlist));
 
     UnLockQueue(&mgThreadTransfer);
 
@@ -6657,7 +6722,7 @@
     user.user.userID       = userID;
     strcpy(user.user.userName, name);
 
-    Enqueue(&mgThreadTransfer, (ubyte *)&user, sizeof(mgqueueuserlist));
+    HWEnqueue(&mgThreadTransfer, (ubyte *)&user, sizeof(mgqueueuserlist));
 
     UnLockQueue(&mgThreadTransfer);
 }
@@ -6673,7 +6738,7 @@
     user.user.userID       = userID;
     strcpy(user.user.userName, name);
 
-    Enqueue(&mgThreadTransfer, (ubyte *)&user, sizeof(mgqueueuserlist));
+    HWEnqueue(&mgThreadTransfer, (ubyte *)&user, sizeof(mgqueueuserlist));
 
     // Queue up the packet that will say, <they> have joined the room.
     chat.header.packettype = MG_QUEUEROOMCHATINFO;
@@ -6682,7 +6747,7 @@
     chat.chat.index = userID;
     chat.chat.messagetype = MG_MESSAGECHAT;
 
-    Enqueue(&mgThreadTransfer, (ubyte *)&chat, sizeof(mgqueuechatlist));
+    HWEnqueue(&mgThreadTransfer, (ubyte *)&chat, sizeof(mgqueuechatlist));
 
     UnLockQueue(&mgThreadTransfer);
 }
@@ -6701,12 +6766,12 @@
     chat.chat.index = userID;
     chat.chat.messagetype = MG_MESSAGECHAT;
 
-    Enqueue(&mgThreadTransfer, (ubyte *)&chat, sizeof(mgqueuechatlist));
+    HWEnqueue(&mgThreadTransfer, (ubyte *)&chat, sizeof(mgqueuechatlist));
 
     user.header.packettype = MG_QUEUEROOMGONEUSERINFO;
     user.user.userID       = userID;
 
-    Enqueue(&mgThreadTransfer, (ubyte *)&user, sizeof(mgqueueuserlist));
+    HWEnqueue(&mgThreadTransfer, (ubyte *)&user, sizeof(mgqueueuserlist));
 
     UnLockQueue(&mgThreadTransfer);
 }
@@ -6740,7 +6805,7 @@
             chat.chat.messagetype = MG_NORMALCHAT;
         chat.chat.index  = originUserID;
 
-        Enqueue(&mgThreadTransfer, (ubyte *)&chat, sizeof(mgqueuechatlist));
+        HWEnqueue(&mgThreadTransfer, (ubyte *)&chat, sizeof(mgqueuechatlist));
 
         UnLockQueue(&mgThreadTransfer);
     }
@@ -7069,7 +7134,7 @@
     ping.ping.Port         = GetPortFromInternetAddress(*address);
     ping.ping.pingtime     = theLag;
 
-    Enqueue(&mgThreadTransfer, (ubyte *)&ping, sizeof(mgqueuenewping));
+    HWEnqueue(&mgThreadTransfer, (ubyte *)&ping, sizeof(mgqueuenewping));
 
     UnLockQueue(&mgThreadTransfer);
 }
@@ -7083,7 +7148,7 @@
     qgame.header.packettype = MG_QUEUEGAMELISTGAMEADDED;
     qgame.game = *thegame;
 
-    Enqueue(&mgThreadTransfer, (ubyte *)&qgame, sizeof(mgqueuegamelistgame));
+    HWEnqueue(&mgThreadTransfer, (ubyte *)&qgame, sizeof(mgqueuegamelistgame));
 
     UnLockQueue(&mgThreadTransfer);
 }
@@ -7097,7 +7162,7 @@
     qgame.header.packettype = MG_QUEUEGAMELISTGAMEREMOVED;
     qgame.game = *thegame;
 
-    Enqueue(&mgThreadTransfer, (ubyte *)&qgame, sizeof(mgqueuegamelistgame));
+    HWEnqueue(&mgThreadTransfer, (ubyte *)&qgame, sizeof(mgqueuegamelistgame));
 
     UnLockQueue(&mgThreadTransfer);
 }
@@ -7111,7 +7176,7 @@
     qgame.header.packettype = MG_QUEUEGAMELISTGAMECHANGED;
     qgame.game = *thegame;
 
-    Enqueue(&mgThreadTransfer, (ubyte *)&qgame, sizeof(mgqueuegamelistgame));
+    HWEnqueue(&mgThreadTransfer, (ubyte *)&qgame, sizeof(mgqueuegamelistgame));
 
     UnLockQueue(&mgThreadTransfer);
 }
@@ -7124,7 +7189,7 @@
 
     qnew.header.packettype = MG_QUEUEGAMELISTNEW;
 
-    Enqueue(&mgThreadTransfer, (ubyte *)&qnew, sizeof(mgqueuegamelistnew));
+    HWEnqueue(&mgThreadTransfer, (ubyte *)&qnew, sizeof(mgqueuegamelistnew));
 
     UnLockQueue(&mgThreadTransfer);
 }
@@ -7148,7 +7213,7 @@
     wcscpy(qnew.channelname,theRoomName);
     qnew.numpeople = theNumUsers;
 
-    Enqueue(&mgThreadTransfer, (ubyte *)&qnew, sizeof(mgqueuenumpeopleroominfo));
+    HWEnqueue(&mgThreadTransfer, (ubyte *)&qnew, sizeof(mgqueuenumpeopleroominfo));
 
     UnLockQueue(&mgThreadTransfer);
 }
@@ -7174,7 +7239,7 @@
     status.header.packettype = MG_QUEUESTATUSINFO;
     strcpy(status.status.message, message);
 
-    Enqueue(&mgThreadTransfer, (ubyte *)&status, sizeof(mgqueuestatusline));
+    HWEnqueue(&mgThreadTransfer, (ubyte *)&status, sizeof(mgqueuestatusline));
 
     UnLockQueue(&mgThreadTransfer);
 }
@@ -7186,7 +7251,7 @@
     LockQueue(&mgThreadTransfer);
 
     general.packettype = MG_QUEUEKICKEDOUT;
-    Enqueue(&mgThreadTransfer, (ubyte *)&general, sizeof(general));
+    HWEnqueue(&mgThreadTransfer, (ubyte *)&general, sizeof(general));
 
     UnLockQueue(&mgThreadTransfer);
 }
@@ -7216,7 +7281,7 @@
         player.player.race        = tpGameCreated.playerInfo[i].race;
         player.player.index       = i;
 
-        Enqueue(&mgThreadTransfer, (ubyte *)&player, sizeof(mgqueuegameplayerinfo));
+        HWEnqueue(&mgThreadTransfer, (ubyte *)&player, sizeof(mgqueuegameplayerinfo));
     }
 
     sigsNumPlayers = tpGameCreated.numPlayers;
@@ -7339,7 +7404,7 @@
     LockQueue(&mgThreadTransfer);
 
     connfailed.packettype = MG_QUEUECHATDISCONNECTED;
-    Enqueue(&mgThreadTransfer, (ubyte *)&connfailed, sizeof(mgqueuegeneral));
+    HWEnqueue(&mgThreadTransfer, (ubyte *)&connfailed, sizeof(mgqueuegeneral));
 
     UnLockQueue(&mgThreadTransfer);
 }
@@ -7357,7 +7422,7 @@
     LockQueue(&mgThreadTransfer);
 
     disolved.packettype = MG_QUEUEGAMEDISOLVED;
-    Enqueue(&mgThreadTransfer, (ubyte *)&disolved, sizeof(mgqueuegeneral));
+    HWEnqueue(&mgThreadTransfer, (ubyte *)&disolved, sizeof(mgqueuegeneral));
 
     UnLockQueue(&mgThreadTransfer);
 }
@@ -7381,7 +7446,7 @@
     else
         chat.chat.messagetype = MG_NORMALCHAT;
 
-    Enqueue(&mgThreadTransfer, (ubyte *)&chat, sizeof(mgqueuechatlist));
+    HWEnqueue(&mgThreadTransfer, (ubyte *)&chat, sizeof(mgqueuechatlist));
 
     UnLockQueue(&mgThreadTransfer);
 }
@@ -7640,6 +7705,7 @@
 // callback for sorting the server list window
 bool mgListOfServersCompare(void *firststruct,void *secondstruct)
 {
+#ifndef _MACOSX_FIX_ME
     sdword i;
     serverlist *one = (serverlist *)(((listitemhandle)firststruct)->data);
     serverlist *two = (serverlist *)(((listitemhandle)secondstruct)->data);
@@ -7647,7 +7713,7 @@
     switch (mgListOfServersWindow->sorttype)
     {
         case MG_ServerSortByName:
-            if ((i=wcsicmp( one->ServerName,two->ServerName)) > 0)
+            if ((i=wcscasecmp( one->ServerName,two->ServerName)) > 0)
                 return (mgListOfServersWindow->sortOrder);
             else
             {
@@ -7658,7 +7724,7 @@
             }
 
         case MG_ServerSortByDescription:
-            if ((i=wcsicmp( one->ServerDescription,two->ServerDescription)) > 0)
+            if ((i=wcscasecmp( one->ServerDescription,two->ServerDescription)) > 0)
                 return (mgListOfServersWindow->sortOrder);
             else
             {
@@ -7701,6 +7767,7 @@
                     return (FALSE);
             }
     }
+#endif
 
     return FALSE;
 }
diff -urPw homeworld-orig/src/Game/MultiplayerGame.h homeworld_sdl-0.3/src/Game/MultiplayerGame.h
--- homeworld-orig/src/Game/MultiplayerGame.h	2002-09-04 12:46:14.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/MultiplayerGame.h	2004-08-01 22:35:24.000000000 -0700
@@ -9,10 +9,10 @@
 #ifndef ___MULTIPLAYERGAME_H
 #define ___MULTIPLAYERGAME_H
 
-#include "types.h"
-#include "region.h"
-#include "linkedlist.h"
-#include "uicontrols.h"
+#include "Types.h"
+#include "Region.h"
+#include "LinkedList.h"
+#include "UIControls.h"
 #include "TitanInterfaceC.h"
 #include "TimeoutTimer.h"
 
@@ -20,7 +20,11 @@
     defines:
 =============================================================================*/
 
+#ifdef _WIN32
 #define MG_FIBFile          "FEMan\\Multiplayer_Game.FIB"
+#else
+#define MG_FIBFile          "FEMan/Multiplayer_Game.FIB"
+#endif
 #define MAX_GAMENAME_LENGTH     MAX_TITAN_GAME_NAME_LEN
 #define MAX_MAPNAME_LENGTH      MAX_MAPNAME_LEN
 #define MAX_CHANNELNAME_LENGTH  MAX_CHANNEL_NAME_LEN
@@ -278,6 +282,8 @@
     Function Prototypes:
 =============================================================================*/
 
+struct ChatPacket;
+
 void mgStartMultiPlayerGameScreens(regionhandle region, sdword ID, udword event, udword data, bool AlreadyLoggedIn);
 void mgShutdownMultiPlayerGameScreens(void);
 
diff -urPw homeworld-orig/src/Game/MultiplayerLANGame.c homeworld_sdl-0.3/src/Game/MultiplayerLANGame.c
--- homeworld-orig/src/Game/MultiplayerLANGame.c	2002-09-04 12:46:14.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/MultiplayerLANGame.c	2004-08-01 22:35:37.000000000 -0700
@@ -6,38 +6,54 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-
+#ifdef _WIN32
 #include <windows.h>
+#else
+#define _GNU_SOURCE   /* Get to wcscasecmp() */
+#endif
+
 #include <stdio.h>
+#include <strings.h>
+
+#ifndef _MACOSX
+    #include <wchar.h>
+#endif
+
+#include <stdlib.h>
 #include "MultiplayerLANGame.h"
-#include "MultiplayerGame.h"
-#include "feflow.h"
+//#include "MultiplayerGame.h"
+#include "FEFlow.h"
 #include "utility.h"
-#include "scenpick.h"
-#include "uicontrols.h"
-#include "region.h"
+#include "ScenPick.h"
+#include "UIControls.h"
+#include "Region.h"
 #include "mouse.h"
-#include "fontreg.h"
-#include "scroller.h"
-#include "linkedlist.h"
+#include "FontReg.h"
+#include "Scroller.h"
+#include "LinkedList.h"
 #include "prim2d.h"
-#include "randy.h"
-#include "chatting.h"
-#include "commandnetwork.h"
-#include "globals.h"
-#include "msg\serverstatus.h"
+#include "Randy.h"
+#include "Chatting.h"
+#include "CommandNetwork.h"
+#include "Globals.h"
+#include "msg/ServerStatus.h"
 #include "ChannelFSM.h"
-#include "colpick.h"
+#include "ColPick.h"
 #include "mainswitches.h"
-#include "chatting.h"
-#include "strings.h"
-#include "queue.h"
-#include "file.h"
-#include "statscript.h"
+#include "Chatting.h"
+#include "Strings.h"
+#include "Queue.h"
+#include "File.h"
+#include "StatScript.h"
 #include "TimeoutTimer.h"
 #include "Titan.h"
-#include "Titannet.h"
-#include "gamechat.h"
+#include "TitanNet.h"
+#include "GameChat.h"
+
+#ifdef _WIN32
+#define strncasecmp _strnicmp
+#define wcscasecmp  _wcsicmp
+#endif
 
 /*=============================================================================
     Defines:
@@ -498,7 +514,7 @@
                 {
                     user = listGetStructOfNode(walk);
                     gcRemoveAmpersands(ampremoved, user->userName);
-                    if (strnicmp(ampremoved,toname,i)==0)
+                    if (strncasecmp(ampremoved,toname,i)==0)
                     {
                         // found a match so far
                         matched = user;
@@ -521,7 +537,7 @@
                 {
                     guser = listGetStructOfNode(walk);
                     gcRemoveAmpersands(ampremoved, guser->name);
-                    if (strnicmp(ampremoved,toname,i)==0)
+                    if (strncasecmp(ampremoved,toname,i)==0)
                     {
                         // found a match so far
                         gmatched = guser;
@@ -715,7 +731,7 @@
     }
     else
     {
-        LanProtocalButton = (ubyte)atom->pData;
+        LanProtocalButton = (ubyte)(size_t)atom->pData;
     }
 }
 
@@ -1081,6 +1097,7 @@
 
 void lgSeeDetails(char*name,featom*atom)
 {
+#ifndef _MACOSX_FIX_ME
     dbgAssert(LANGame);
 
     if (lgListOfGamesWindow->CurLineSelected!=NULL)
@@ -1091,6 +1108,7 @@
         dbgAssert(SeeingDetailsForGameName[0] != 0);
         mgShowScreen(MGS_Basic_Options_View,TRUE);
     }
+#endif
 }
 
 void lgRequestJoinGame(tpscenario *game)
@@ -1134,6 +1152,7 @@
             }
         }
 
+#ifndef _MACOSX_FIX_ME
         if (wcslen(gameinfo->game.directoryCustomInfo.stringdata)>1)
         {
             joingame = &gameinfo->game;
@@ -1143,6 +1162,7 @@
         {
             lgRequestJoinGame(&gameinfo->game);
         }
+#endif
     }
 }
 
@@ -1151,7 +1171,10 @@
 // callback for sorting the game list window
 bool lgListOfGamesCompare(void *firststruct,void *secondstruct)
 {
+#ifndef _MACOSX_FIX_ME
     sdword i;
+#endif
+
     lggamelist *one = (lggamelist *)(((listitemhandle)firststruct)->data);
     lggamelist *two = (lggamelist *)(((listitemhandle)secondstruct)->data);
 
@@ -1166,11 +1189,11 @@
             return(FALSE);
     }
 
-
+#ifndef _MACOSX_FIX_ME
     switch (lgListOfGamesWindow->sorttype)
     {
         case LG_SortByGameName:
-            if ((i=wcsicmp( one->game.Name,two->game.Name)) > 0)
+            if ((i=wcscasecmp( one->game.Name,two->game.Name)) > 0)
                 return (lgListOfGamesWindow->sortOrder);
             else
             {
@@ -1195,7 +1218,7 @@
             wchar_t *onemapname = one->game.directoryCustomInfo.stringdata + 1+wcslen(one->game.directoryCustomInfo.stringdata);
             wchar_t *twomapname = two->game.directoryCustomInfo.stringdata + 1+wcslen(two->game.directoryCustomInfo.stringdata);
 
-            if ((i=wcsicmp( onemapname,twomapname)) > 0)
+            if ((i=wcscasecmp( onemapname,twomapname)) > 0)
                 return (lgListOfGamesWindow->sortOrder);
             else
             {
@@ -1206,6 +1229,9 @@
             }
         }
     }
+#endif
+
+    return FALSE;
 }
 
 // callback if the title is clicked on
@@ -1360,10 +1386,13 @@
     color       c;
     fonthandle  oldfont;
     lggamelist   *gameinfo = (lggamelist *)data->data;
-    udword passwordlen;
     bool gameinprogress = gameinfo->game.directoryCustomInfo.flag & GAME_IN_PROGRESS;
     bool diffversion = (!CheckNetworkVersionCompatibility(gameinfo->game.directoryCustomInfo.versionInfo));
 
+#ifndef _MACOSX_FIX_ME
+    udword passwordlen;
+#endif
+
     oldfont = fontMakeCurrent(lgListOfGamesFont);
 
     if (data->flags&UICLI_Selected)
@@ -1393,6 +1422,7 @@
     sprintf(temp,"%i",gameinfo->game.directoryCustomInfo.numPlayers);
     fontPrint(x-fontWidth(temp)-fontWidth("W"),y,c,temp);
 
+#ifndef _MACOSX_FIX_ME
     passwordlen = wcslen(gameinfo->game.directoryCustomInfo.stringdata);
 
     wcstombs(temp,gameinfo->game.directoryCustomInfo.stringdata + 1+passwordlen,512);
@@ -1413,6 +1443,7 @@
     }
 
     fontMakeCurrent(oldfont);
+#endif
 }
 
 // initilize the list of games window structure to needed settings
@@ -1677,6 +1708,7 @@
 
 void lgStartGame(char*name,featom*atom)
 {
+#ifndef _MACOSX_FIX_ME
     sdword i;
 
     if (tpGameCreated.numPlayers == 0)
@@ -1725,6 +1757,7 @@
     sigsPressedStartGame = TRUE;
 
     lgShutdownMultiPlayerGameScreens();
+#endif // _MACOSX_FIX_ME
 }
 
 void lgGameChatTextEntry(char *name, featom *atom)
@@ -1854,6 +1887,7 @@
 
 void lgCreateGameNow(char *name, featom *atom)
 {
+#ifndef _MACOSX_FIX_ME
     if (SeeingDetailsForGameName[0])
     {
         SeeingDetailsForGameName[0] = 0;
@@ -1924,6 +1958,7 @@
 
         lgUpdateGameInfo();
     }
+#endif // _MACOSX_FIX_ME
 }
 
 void lgGameNameTextEntry(char *name, featom *atom)
@@ -2052,6 +2087,7 @@
 
 void lgGoPassword(char *name, featom *atom)
 {
+#ifndef _MACOSX_FIX_ME
     static wchar_t widepasswordentryboxtext[MAX_PASSWORD_LENGTH];
 
     if (joingame!=NULL)
@@ -2067,6 +2103,7 @@
             mgShowScreen(LGS_Message_Box,FALSE);
         }
     }
+#endif
 }
 
 
@@ -2195,6 +2232,7 @@
 
 void lgProcessGameHere(lgqueuegamehere *game)
 {
+#ifndef _MACOSX_FIX_ME
     LANAdvert_GameHere *gamehere = &game->gamehere;
 
     // see if gamehere is already in the list
@@ -2277,6 +2315,7 @@
     {
         gameinfo->item = NULL;
     }
+#endif // _MACOSX_FIX_ME
 }
 
 void lgProcessChatMsg(lgqueuechatmsg *chat)
@@ -2521,6 +2560,7 @@
 
 static void lgExplicitlyDeleteGameFromGameList(wchar_t *name)
 {
+#ifndef _MACOSX_FIX_ME
     lggamelist *gameinfo;
     Node     *walk2;
 
@@ -2553,6 +2593,7 @@
 
         walk2 = walk2->next;
     }
+#endif
 }
 
 #pragma optimize("gy", off)                       //turn on stack frame (we need ebp for this function)
@@ -2564,7 +2605,9 @@
 
     taskYield(0);
 
+#ifndef C_ONLY
     while (1)
+#endif
     {
         taskStackSaveCond(0);
 
@@ -2665,7 +2708,7 @@
         {
             LockQueue(&lgThreadTransfer);
 
-            sizeofpacket = Dequeue(&lgThreadTransfer, &packet);
+            sizeofpacket = HWDequeue(&lgThreadTransfer, &packet);
             dbgAssert(sizeofpacket > 0);
             copypacket = memAlloc(sizeofpacket,"lg(lgthreadtransfer)", Pyrophoric);
             memcpy(copypacket, packet, sizeofpacket);
@@ -2823,8 +2866,8 @@
 
     TTimerDisable(&lgAdvertiseMyselfTimer);
 
-    lgchangescreenmutex       = (void *)CreateMutex(NULL,FALSE,NULL);
-    gamestartedmutex        = (void *)CreateMutex(NULL,FALSE,NULL);
+    lgchangescreenmutex = SDL_CreateMutex();
+    gamestartedmutex    = SDL_CreateMutex();
 
     lgProccessCallback = taskStart(lgProcessCallBacksTask, LG_TaskServicePeriod, 0);
     taskPause(lgProccessCallback);
@@ -2837,7 +2880,7 @@
 {
     CloseQueue(&lgThreadTransfer);
 
-    CloseHandle((HANDLE)lgchangescreenmutex);
+    SDL_DestroyMutex(lgchangescreenmutex);
 }
 
 
@@ -2870,7 +2913,7 @@
                 {
                     memcpy(&userhere.userhere,thePacket,sizeof(LANAdvert_UserHere));
 
-                    Enqueue(&lgThreadTransfer, (ubyte *)&userhere, sizeof(userhere));
+                    HWEnqueue(&lgThreadTransfer, (ubyte *)&userhere, sizeof(userhere));
                 }
                 else
                 {
@@ -2889,7 +2932,7 @@
                 {
                     memcpy(&gamehere.gamehere,thePacket,sizeof(LANAdvert_GameHere));
 
-                    Enqueue(&lgThreadTransfer, (ubyte *)&gamehere,sizeof(gamehere));
+                    HWEnqueue(&lgThreadTransfer, (ubyte *)&gamehere,sizeof(gamehere));
                 }
                 else
                 {
@@ -2908,7 +2951,7 @@
                 {
                     memcpy(&chatmsg.chatmsg,thePacket,sizeof(LANAdvert_ChatMsg));
 
-                    Enqueue(&lgThreadTransfer, (ubyte *)&chatmsg,sizeof(chatmsg));
+                    HWEnqueue(&lgThreadTransfer, (ubyte *)&chatmsg,sizeof(chatmsg));
                 }
                 else
                 {
@@ -2941,7 +2984,7 @@
     status.header.packettype = LG_QUEUESTATUSINFO;
     strcpy(status.status.message, message);
 
-    Enqueue(&lgThreadTransfer, (ubyte *)&status, sizeof(lgqueuestatusline));
+    HWEnqueue(&lgThreadTransfer, (ubyte *)&status, sizeof(lgqueuestatusline));
 
     UnLockQueue(&lgThreadTransfer);
 }
@@ -2973,7 +3016,7 @@
         player.player.race        = tpGameCreated.playerInfo[i].race;
         player.player.index       = i;
 
-        Enqueue(&lgThreadTransfer, (ubyte *)&player, sizeof(lgqueuegameplayerinfo));
+        HWEnqueue(&lgThreadTransfer, (ubyte *)&player, sizeof(lgqueuegameplayerinfo));
     }
 
     sigsNumPlayers = tpGameCreated.numPlayers;
@@ -3010,7 +3053,7 @@
     LockQueue(&lgThreadTransfer);
 
     disolved.packettype = LG_QUEUEGAMEDISOLVED;
-    Enqueue(&lgThreadTransfer, (ubyte *)&disolved, sizeof(lgqueuegeneral));
+    HWEnqueue(&lgThreadTransfer, (ubyte *)&disolved, sizeof(lgqueuegeneral));
 
     UnLockQueue(&lgThreadTransfer);
 }
@@ -3034,7 +3077,7 @@
     else
         chat.chat.messagetype = LG_NORMALCHAT;
 
-    Enqueue(&lgThreadTransfer, (ubyte *)&chat, sizeof(lgqueuechatlist));
+    HWEnqueue(&lgThreadTransfer, (ubyte *)&chat, sizeof(lgqueuechatlist));
 
     UnLockQueue(&lgThreadTransfer);
 }
diff -urPw homeworld-orig/src/Game/MultiplayerLANGame.h homeworld_sdl-0.3/src/Game/MultiplayerLANGame.h
--- homeworld-orig/src/Game/MultiplayerLANGame.h	2002-09-04 12:46:14.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/MultiplayerLANGame.h	2004-08-01 22:35:16.000000000 -0700
@@ -12,18 +12,22 @@
 #define ___MULTIPLAYERLANGAME_H
 
 
-#include "types.h"
-#include "region.h"
-#include "linkedlist.h"
-#include "uicontrols.h"
+#include "Types.h"
+#include "Region.h"
+#include "LinkedList.h"
+#include "UIControls.h"
 #include "TitanInterfaceC.h"
-#include "multiplayergame.h"
+#include "MultiplayerGame.h"
 
 /*=============================================================================
     defines:
 =============================================================================*/
 
+#ifdef _WIN32
 #define LG_FIBFile          "FEMan\\Multiplayer_LAN_Game.FIB"
+#else
+#define LG_FIBFile          "FEMan/Multiplayer_LAN_Game.FIB"
+#endif
 #define MAX_GAMENAME_LENGTH     MAX_TITAN_GAME_NAME_LEN
 #define MAX_MAPNAME_LENGTH      MAX_MAPNAME_LEN
 #define MAX_CHANNELNAME_LENGTH  MAX_CHANNEL_NAME_LEN
diff -urPw homeworld-orig/src/Game/NavLights.c homeworld_sdl-0.3/src/Game/NavLights.c
--- homeworld-orig/src/Game/NavLights.c	2002-09-04 12:46:14.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/NavLights.c	2004-08-01 22:35:20.000000000 -0700
@@ -7,14 +7,16 @@
 =============================================================================*/
 
 #ifndef SW_Render
+#ifdef _WIN32
 #include <windows.h>
 #endif
-#include "navlights.h"
-#include "spaceobj.h"
-#include "matrix.h"
+#endif
+#include "NavLights.h"
+#include "SpaceObj.h"
+#include "Matrix.h"
 #include "render.h"
 #include "prim3d.h"
-#include "universe.h"
+#include "Universe.h"
 #include "glinc.h"
 #include "glcaps.h"
 
diff -urPw homeworld-orig/src/Game/NavLights.h homeworld_sdl-0.3/src/Game/NavLights.h
--- homeworld-orig/src/Game/NavLights.h	2002-09-04 12:46:14.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/NavLights.h	2004-08-01 22:35:20.000000000 -0700
@@ -9,7 +9,7 @@
 #ifndef __NAVLIGHTS_H
 #define __NAVLIGHTS_H
 
-#include "spaceobj.h"
+#include "SpaceObj.h"
 
 void RenderNAVLights(Ship *ship);
 void navLightStaticInfoDelete(NAVLightStaticInfo *staticInfo);
diff -urPw homeworld-orig/src/Game/Nebulae.c homeworld_sdl-0.3/src/Game/Nebulae.c
--- homeworld-orig/src/Game/Nebulae.c	2002-09-04 12:46:14.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Nebulae.c	2004-08-01 22:35:33.000000000 -0700
@@ -7,28 +7,30 @@
 =============================================================================*/
 
 #ifndef SW_Render
+#ifdef _WIN32
 #include <windows.h>
 #endif
+#endif
 #include <stdio.h>
 #include <string.h>
 #include <math.h>
-#include "types.h"
-#include "memory.h"
-#include "clouds.h"
-#include "randy.h"
+#include "Types.h"
+#include "Memory.h"
+#include "Clouds.h"
+#include "Randy.h"
 #include "glinc.h"
-#include "fastmath.h"
+#include "FastMath.h"
 #include "render.h"
-#include "debug.h"
-#include "univupdate.h"
-#include "statscript.h"
-#include "matrix.h"
-#include "universe.h"
-#include "nebulae.h"
+#include "Debug.h"
+#include "UnivUpdate.h"
+#include "StatScript.h"
+#include "Matrix.h"
+#include "Universe.h"
+#include "Nebulae.h"
 #include "mainrgn.h"
-#include "autolod.h"
+#include "AutoLOD.h"
 
-#include "shader.h"
+#include "Shader.h"
 #include "glcaps.h"
 
 #include "SaveGame.h"
@@ -1359,7 +1361,6 @@
 ----------------------------------------------------------------------------*/
 void nebRenderChunk(nebChunk* chunk, sdword lod)
 {
-    vector origin = {0.0f, 0.0f, 0.0f};
     udword i, actualTendrils;
     nebTendril* tendril;
 
diff -urPw homeworld-orig/src/Game/Nebulae.h homeworld_sdl-0.3/src/Game/Nebulae.h
--- homeworld-orig/src/Game/Nebulae.h	2002-09-04 12:46:14.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Nebulae.h	2004-08-01 22:35:34.000000000 -0700
@@ -14,9 +14,9 @@
 // INCLUDES
 // -----
 
-#include "types.h"
-#include "vector.h"
-#include "clouds.h"
+#include "Types.h"
+#include "Vector.h"
+#include "Clouds.h"
 
 
 // -----
@@ -137,6 +137,8 @@
 // PROTOS
 // -----
 
+struct Nebula;
+
 void nebStartup(void);
 void nebShutdown(void);
 void nebReset(void);
diff -urPw homeworld-orig/src/Game/NetCheck.c homeworld_sdl-0.3/src/Game/NetCheck.c
--- homeworld-orig/src/Game/NetCheck.c	2002-09-04 12:46:14.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/NetCheck.c	2004-08-01 22:35:29.000000000 -0700
@@ -2,22 +2,22 @@
 #include <stdlib.h>
 #include <stdio.h>
 #include <string.h>
-#include "switches.h"
-#include "types.h"
-#include "file.h"
-#include "universe.h"
-#include "univupdate.h"
-#include "netcheck.h"
-#include "commandnetwork.h"
-#include "blobs.h"
-#include "globals.h"
-#include "titannet.h"
+#include "Switches.h"
+#include "Types.h"
+#include "File.h"
+#include "Universe.h"
+#include "UnivUpdate.h"
+#include "NetCheck.h"
+#include "CommandNetwork.h"
+#include "Blobs.h"
+#include "Globals.h"
+#include "TitanNet.h"
 #include "SaveGame.h"
-#include "randy.h"
-#include "titaninterfacec.h"
-#include "commandwrap.h"
-#include "stringsonly.h"
-#include "stats.h"
+#include "Randy.h"
+#include "TitanInterfaceC.h"
+#include "CommandWrap.h"
+#include "StringsOnly.h"
+#include "Stats.h"
 
 #if SYNC_CHECK
 udword randSyncErr;
diff -urPw homeworld-orig/src/Game/NetCheck.h homeworld_sdl-0.3/src/Game/NetCheck.h
--- homeworld-orig/src/Game/NetCheck.h	2002-09-04 12:46:14.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/NetCheck.h	2004-08-01 22:35:29.000000000 -0700
@@ -9,9 +9,10 @@
 #ifndef ___NETCHECK_H
 #define ___NETCHECK_H
 
-#include "switches.h"
-#include "types.h"
-#include "file.h"
+#include "Switches.h"
+#include "Types.h"
+#include "File.h"
+#include "CommandNetwork.h"
 
 #define PKTS_EXTENSION  ".pkts"
 
@@ -20,10 +21,10 @@
 void netcheckReset(void);
 void netcheckInit(void);
 void netcheckClose(void);
-void netcheckShow(void *packet);
+void netcheckShow(HWPacketHeader *packet);
 #if SYNC_CHECK
-void netcheckFillInChecksum(void *packet);
-void netcheckCheckChecksum(void *checksum);
+void netcheckFillInChecksum(HWPacketHeader *packet);
+void netcheckCheckChecksum(NetSyncChecksums *checksum);
 #endif
 //void netcheckShow(HWPacketHeader *packet);
 //void netcheckFillInChecksum(HWPacketHeader *packet);
diff -urPw homeworld-orig/src/Game/NIS.c homeworld_sdl-0.3/src/Game/NIS.c
--- homeworld-orig/src/Game/NIS.c	2002-09-04 12:46:14.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/NIS.c	2004-08-01 22:35:20.000000000 -0700
@@ -7,45 +7,54 @@
 =============================================================================*/
 
 #ifndef SW_Render
+#ifdef _WIN32
 #include <windows.h>
 #endif
+#endif
 #include <stdlib.h>
 #include <string.h>
+#include <strings.h>
 #include <math.h>
 #include <float.h>
+#include <ctype.h>
+#include <limits.h>
 #include "glinc.h"
-#include "types.h"
-#include "file.h"
-#include "debug.h"
-#include "memory.h"
-#include "task.h"
-#include "universe.h"
-#include "univupdate.h"
-#include "spaceobj.h"
-#include "camera.h"
-#include "mex.h"
-#include "select.h"
-#include "b-spline.h"
-#include "fastmath.h"
-#include "attack.h"
-#include "soundevent.h"
+#include "Types.h"
+#include "File.h"
+#include "Debug.h"
+#include "Memory.h"
+#include "Task.h"
+#include "Universe.h"
+#include "UnivUpdate.h"
+#include "SpaceObj.h"
+#include "Camera.h"
+#include "MEX.h"
+#include "Select.h"
+#include "B-Spline.h"
+#include "FastMath.h"
+#include "Attack.h"
+#include "SoundEvent.h"
 #include "light.h"
-#include "btg.h"
-#include "nis.h"
+#include "BTG.h"
+#include "NIS.h"
 #include "glcaps.h"
-#include "randy.h"
-#include "region.h"
-#include "feflow.h"
+#include "Randy.h"
+#include "Region.h"
+#include "FEFlow.h"
 #include "mouse.h"
-#include "soundevent.h"
+#include "SoundEvent.h"
 #include "mainrgn.h"
-#include "kas.h"
-#include "commandWrap.h"
-#include "strings.h"
-#include "bink.h"
+#include "KAS.h"
+#include "CommandWrap.h"
+#include "Strings.h"
+/*#include "bink.h"*/
 #include "render.h"
-#include "eval.h"
-#include "tracking.h"
+#include "Eval.h"
+#include "Tracking.h"
+
+#ifdef _MSC_VER
+#define strcasecmp _stricmp
+#endif
 
 /*=============================================================================
     Data:
@@ -277,8 +286,13 @@
 char *nisLanguageSubpath[] =
 {
     "",
+#ifdef _WIN32
     "French\\",
     "German\\",
+#else
+    "French/",
+    "German/",
+#endif
     "",         // Spanish uses the same script settings as English as the audio isn't localized
     ""          // Italian uses the same script settings as English as the audio isn't localized
 };
@@ -298,7 +312,7 @@
     filehandle fp;
     char *parse;
 
-    parse = memAlloc(_MAX_PATH * 2, "Sdfgadsf", 0);
+    parse = memAlloc(PATH_MAX * 2, "Sdfgadsf", 0);
     *NIS = *script = NULL;
     if (!fileExists(nisTestNIS, 0))
     {
@@ -307,7 +321,7 @@
     fp = fileOpen(nisTestNIS, FF_TextMode);
     for (; index >= 0; index--)
     {
-        if (fileLineRead(fp, parse, _MAX_PATH * 2) == FR_EndOfFile)
+        if (fileLineRead(fp, parse, PATH_MAX * 2) == FR_EndOfFile)
         {
             fileClose(fp);
             return;
@@ -419,7 +433,9 @@
 
     taskYield(0);
 
+#ifndef C_ONLY
     while (1)
+#endif
     {
         taskStackSaveCond(0);
         //code for playing in-game NIS's
@@ -444,7 +460,7 @@
         //fade to/from black
         if (nisBlackFade != nisBlackFadeDest)
         {
-            if (abs(nisBlackFade - nisBlackFadeDest) <= UNIVERSE_UPDATE_PERIOD)
+            if (ABS(nisBlackFade - nisBlackFadeDest) <= UNIVERSE_UPDATE_PERIOD)
             {                                           //if the end of the fade
                 nisBlackFade = nisBlackFadeDest;
                 nisBlackFadeRate = 0.0f;
@@ -1670,12 +1686,12 @@
     {                                                   //(all curves should end at same time)
         return;
     }
-    dbgAssert(!_isnan((double)xyz.x));
+    dbgAssert(!isnan((double)xyz.x));
     //get rest of motion path
     xyz.y = bsCurveUpdate(camPath->curve[1], timeElapsed);
     xyz.z = bsCurveUpdate(camPath->curve[2], timeElapsed);
-    dbgAssert(!_isnan((double)xyz.y));
-    dbgAssert(!_isnan((double)xyz.z));
+    dbgAssert(!isnan((double)xyz.y));
+    dbgAssert(!isnan((double)xyz.z));
     //camera rotation: X, Y, Z (mode 0)
     rot.x = bsCurveUpdate(camPath->curve[3], timeElapsed);
     rot.y = bsCurveUpdate(camPath->curve[4], timeElapsed);
@@ -1685,9 +1701,9 @@
     xyzTemp.x = -xyz.z;
     xyzTemp.y = xyz.x;
     xyzTemp.z = xyz.y;
-    dbgAssert(!_isnan((double)xyzTemp.x));
-    dbgAssert(!_isnan((double)xyzTemp.y));
-    dbgAssert(!_isnan((double)xyzTemp.z));
+    dbgAssert(!isnan((double)xyzTemp.x));
+    dbgAssert(!isnan((double)xyzTemp.y));
+    dbgAssert(!isnan((double)xyzTemp.z));
     matMultiplyMatByVec(&xyz, &NIS->nisMatrix, &xyzTemp);//multiply NIS world matrix
     camPath->cam->eyeposition.x = NIS->nisPosition.x + xyz.x;
     camPath->cam->eyeposition.y = NIS->nisPosition.y + xyz.y;
@@ -1720,10 +1736,12 @@
     sdword index, j;
     nisevent *event;
 
+#if 0   /* Bink-specific */
     if (!binkDonePlaying)
     {
         return 0.0000001f;
     }
+#endif
 
 #if NIS_CAMERA_RELEASE
     if (keyIsStuck(NIS_CAMERA_RELEASE))
@@ -1838,7 +1856,7 @@
             }
         }
         //cap the velocity vector of the ship
-        if (abs(tempVect.x) + abs(tempVect.y) + abs(tempVect.z) > 0.0f)
+        if (ABS(tempVect.x) + ABS(tempVect.y) + ABS(tempVect.z) > 0.0f)
         {
             if (NIS->header->objectPath[index].type < NUM_RACES)
             {
@@ -1965,7 +1983,11 @@
                         if (pString != NULL)
                         {
                             strcat(nisInfoString, pString);
+#ifdef _WIN32
                             strcat(nisInfoString, "\\");
+#else
+                            strcat(nisInfoString, "/");
+#endif
                         }
                     }
                     strcat(nisInfoString, ShipTypeToStr(((Ship *)NIS->objectsInMotion[index].spaceobj)->shiptype));
@@ -2046,7 +2068,8 @@
         sscanf(pSlash, "(%d)", &instance);
         *(pSlash - 1) = 0;                                  //get rid of the instance ID
     }
-    if ((pSlash = strchr(name, '\\')) != NULL || (pSlash = strchr(name, '/')) != NULL)
+    /*if ((pSlash = strchr(name, '\\')) != NULL || (pSlash = strchr(name, '/')) != NULL)*/
+    if ((pSlash = strpbrk(name, "\\/")) != NULL)
     {                                                       //find the race
         memcpy(raceString, name, pSlash - name);
         raceString[pSlash - name] = 0;
@@ -2069,7 +2092,7 @@
     {
         pSlash = name;
     }
-    if (!_stricmp(pSlash, "Missile"))
+    if (!strcasecmp(pSlash, "Missile"))
     {                                                       //if we're looking for a missile
         race = NSR_Missile;
     }
@@ -2112,7 +2135,11 @@
                     pType = DerelictTypeToStr(path->type);
                     break;
                 case NSR_Effect:
+#ifdef _WIN32
                     for (pType = ((etgeffectstatic *)path->type)->name; strchr(pType, '\\'); pType = strchr(pType, '\\'))
+#else
+                    for (pType = ((etgeffectstatic *)path->type)->name; strpbrk(pType, "\\/"); pType = strpbrk(pType, "\\/"))
+#endif
                     {                                       //find just the name
                         ;
                     }
@@ -2136,7 +2163,7 @@
                     dbgFatalf(DBG_Loc, "Invalid object race: %d", path->race);
 #endif
             }
-            if (!_stricmp(pType, pSlash))
+            if (!strcasecmp(pType, pSlash))
             {                                               //if this is the proper object type
                 return(index);
             }
@@ -3108,6 +3135,8 @@
 #endif
             soundEventSFXVol(TreatAsReal32(event->param[0]));
             break;
+        default:
+            break;
     }
 }
 
@@ -3217,7 +3246,7 @@
 void nisNewEnvironment(nisplaying *NIS, nisevent *event)
 {
     nisenvironment *env = (nisenvironment *)event->param[0];
-    char path[_MAX_PATH];
+    char path[PATH_MAX];
 
     if (nisSeeking)
     {
@@ -3231,14 +3260,22 @@
     {
         nisPreviousLighting = memStringDupeNV(lightCurrentLighting);
     }
+#ifdef _WIN32
     sprintf(path, "BTG\\%s.btg", env->name);                //load the background
+#else
+    sprintf(path, "BTG/%s.btg", env->name);                //load the background
+#endif
     nisPreviousTheta = btgGetTheta();
     nisPreviousPhi = btgGetPhi();
     btgSetTheta(env->theta);
     btgSetPhi(env->phi);
     btgLoad(path);
 
+#ifdef _WIN32
     sprintf(path,"hsf\\%s.hsf",env->name);
+#else
+    sprintf(path,"hsf/%s.hsf",env->name);
+#endif
     lightParseHSF(path);                               //load the lighting
 }
 
@@ -3372,8 +3409,9 @@
 //sets the time for sebsequent events
 void nisCurrentTimeSet(char *directory,char *field,void *dataToFillIn)
 {
+    unsigned int i;
     sdword nScanned;
-    _strupr(field);
+    for (i = 0; (field[i] = toupper(field[i])); i++) { }
     if (strstr(field, "FRAME") == field)
     {
         nScanned = sscanf(field, "FRAME %f", &nisCurrentTime);
@@ -3469,6 +3507,7 @@
     char eventNumberString[256];
     double evaluatedNumber;
     ERR_TYPE exprError;
+    unsigned int i;
     nisevent *event = nisNewEvent(NEO_SpeechEvent);
     sdword actor = -1;
 
@@ -3486,7 +3525,7 @@
     {
         sscanf(nextString + 1, "%d", &event->param[1]);
     }
-    strupr(field);
+    for (i = 0; (field[i] = toupper(field[i])); i++) { }
     if ((actorString = strstr(field, "ACTOR")) != NULL)
     {
         sscanf(actorString + strlen("ACTOR "), "%d", &actor);
@@ -3596,7 +3635,8 @@
     nisevent *event = nisNewEventNoObject(NEO_CameraCut);
     sdword nScanned;
     real32 value;
-    _strupr(field);
+    unsigned int i;
+    for (i = 0; (field[i] = toupper(field[i])); i++) { }
     if (strstr(field, "FRAME"))
     {
         nScanned = sscanf(field, "%f FRAME", &value);
@@ -3655,8 +3695,9 @@
     nisevent *event = nisNewEventNoObject(NEO_TextScroll);
     sdword nScanned;
     real32 duration, distance;
+    unsigned int i;
 
-    _strupr(field);
+    for (i = 0; (field[i] = toupper(field[i])); i++) { }
     if (strstr(field, "FRAME"))
     {
         nScanned = sscanf(field, "%f,%f FRAME", &distance, &duration);
@@ -3681,8 +3722,9 @@
 {
     sdword nScanned;
     real32 fade;
+    unsigned int i;
 
-    _strupr(field);
+    for (i = 0; (field[i] = toupper(field[i])); i++) { }
     if (strstr(field, "FRAME"))
     {
         nScanned = sscanf(field, "%f FRAME", &fade);
@@ -3720,8 +3762,9 @@
 {
     sdword nScanned;
     real32 value;
+    unsigned int i;
 
-    _strupr(field);
+    for (i = 0; (field[i] = toupper(field[i])); i++) { }
     if (strstr(field, "FRAME"))
     {
         nScanned = sscanf(field, "%f FRAME", &value);
@@ -3796,8 +3839,9 @@
     sdword nScanned;
     real32 time0, time1 = -1.0f;
     char *string0, *string1;
+    unsigned int i;
 
-    _strupr(field);
+    for (i = 0; (field[i] = toupper(field[i])); i++) { }
     string0 = strtok(field, " \n\t,");
     string1 = strtok(NULL, " \n\t,");
     //read in the first time
@@ -3860,8 +3904,9 @@
     sdword nScanned;
     real32 value;
     nisevent *event;
+    unsigned int i;
 
-    _strupr(field);
+    for (i = 0; (field[i] = toupper(field[i])); i++) { }
     if (strstr(field, "FRAME"))
     {
         nScanned = sscanf(field, "%f FRAME", &value);
@@ -3919,9 +3964,10 @@
 {
     real32 fadeOut;
     sdword nScanned;
+    unsigned int i;
     nisevent *event = nisNewEventNoObject(NEO_StopMusic);
 
-    _strupr(field);
+    for (i = 0; (field[i] = toupper(field[i])); i++) { }
     if (strstr(field, "FRAME"))
     {
         nScanned = sscanf(field, "%f FRAME", &fadeOut);
@@ -3977,6 +4023,7 @@
     real32 level, duration;
     sdword nScanned;
     char *time;
+    unsigned int i;
 
     time = strchr(field, ',');
     dbgAssert(time);
@@ -3993,7 +4040,7 @@
         dbgFatalf(DBG_Loc, "'%s' is not in the range of 0..1", field);
     }
 #endif
-    _strupr(time);
+    for (i = 0; (time[i] = toupper(time[i])); i++) { }
     if (strstr(time, "FRAME"))
     {
         nScanned = sscanf(time, "%f FRAME", &duration);
@@ -4049,8 +4096,9 @@
     nisevent *event = nisNewEvent(NEO_MeshAnimationSeek);
     real32 seekTime;
     sdword nScanned;
+    unsigned int i;
 
-    _strupr(field);
+    for (i = 0; (field[i] = toupper(field[i])); i++) { }
     if (strstr(field, "FRAME"))
     {
         nScanned = sscanf(field, "FRAME %f", &seekTime);
@@ -4148,7 +4196,8 @@
 
     //scan in all the parameters
     RemoveCommasFromString(field);
-    nScanned = sscanf(field, "%s %d %d %s %d %d %d %s %s", timeString, &x, &y, &red, &green, &blue, fontString, formatString);
+    /*nScanned = sscanf(field, "%s %d %d %s %d %d %d %s %s", timeString, &x, &y, &red, &green, &blue, fontString, formatString);*/
+    nScanned = sscanf(field, "%s %d %d %s %hhu %hhu %hhu %s %s", timeString, &x, &y, justifyString, &red, &green, &blue, fontString, formatString);
     dbgAssert(nScanned >= 3);
     dbgAssert(strlen(formatString) > 1);
 
@@ -4258,11 +4307,19 @@
     dbgAssert(nScanned == 2);
     dbgAssert(strlen(nisName) > 0);
     dbgAssert(strlen(scriptName) > 0);
+#ifdef _WIN32
     strcpy(fileName, "nis\\");
+#else
+    strcpy(fileName, "nis/");
+#endif
     strcat(fileName, nisName);
     dbgAssert(fileExists(fileName, 0));
     event->param[0] = (udword)memStringDupeNV(fileName);
+#ifdef _WIN32
     strcpy(fileName, "nis\\");
+#else
+    strcpy(fileName, "nis/");
+#endif
     strcat(fileName, scriptName);
     dbgAssert(fileExists(fileName, 0));
     event->param[1] = (udword)memStringDupeNV(fileName);
@@ -4467,7 +4524,11 @@
     generic->staticInfo = memAlloc(sizeof(DerelictStaticInfo), "NISGenericStat", 0);
     strcpy(shipFile, name);
     strcat(shipFile, ".shp");
+#ifdef _WIN32
     InitStatDerelictInfoByPath(generic->staticInfo, NUM_DERELICTTYPES + index, "Misc\\", shipFile);
+#else
+    InitStatDerelictInfoByPath(generic->staticInfo, NUM_DERELICTTYPES + index, "Misc/", shipFile);
+#endif
     return(header->nGenericObjects - 1);
 }
 
@@ -4496,6 +4557,27 @@
 
     f = fileOpen(fileName, 0);                              //open the file
     fileBlockRead(f, &header, sizeof(nisheader));           //read the header
+
+#ifdef ENDIAN_BIG
+	header.version           = LittleLong( header.version );
+	header.flags             = LittleLong( header.flags );
+	header.stringBlock       = ( char *)LittleLong( ( udword )header.stringBlock );
+	header.stringBlockLength = LittleLong( header.stringBlockLength );
+	header.length            = LittleFloat( header.length );
+	header.loop              = LittleFloat( header.loop );
+	header.nObjectPaths      = LittleLong( header.nObjectPaths );
+	header.objectPath        = ( spaceobjpath *)LittleLong( ( udword )header.objectPath );
+	header.nCameraPaths      = LittleLong( header.nCameraPaths );
+	header.cameraPath        = ( camerapath *)LittleLong( ( udword )header.cameraPath );
+	header.nLightPaths       = LittleLong( header.nLightPaths );
+	header.lightPath         = ( lightpath *)LittleLong( ( udword )header.lightPath );
+	header.nEvents           = LittleLong( header.nEvents );
+	header.events            = ( nisevent *)LittleLong( ( udword )header.events );
+	header.nGenericObjects   = LittleLong( header.nGenericObjects );
+	header.genericObject     = ( nisgenericobject **)LittleLong( ( udword )header.genericObject );
+	header.iLookyObject      = LittleLong( header.iLookyObject );
+#endif
+
 #if NIS_ERROR_CHECKING
     if (strcmp(header.identifier, NIS_Identifier) != 0)
     {
@@ -4517,9 +4599,33 @@
     fileClose(f);                                           //done with the file
     newHeader->flags = 0;
 //    newHeader->name += (udword)newHeader->stringBlock;      //fixup file name
+
     (ubyte *)newHeader->objectPath += (udword)newHeader;//fixup the object motion path array
+
+#ifdef ENDIAN_BIG
+	for (index = 0; index < newHeader->nObjectPaths; index++)
+    {                                                       //for each object motion path
+        objPath = &newHeader->objectPath[index];            //get pointer to this motion path
+		objPath->instance = LittleLong( objPath->instance );
+		objPath->type = LittleLong( objPath->type );
+		objPath->parentIndex = LittleLong( objPath->parentIndex );
+		objPath->race = LittleLong( objPath->race );
+		objPath->nSamples = LittleLong( objPath->nSamples );
+		objPath->timeOffset = LittleFloat( objPath->timeOffset );
+		objPath->times = ( real32 *)LittleLong( ( udword )objPath->times );
+		objPath->parameters = ( tcb *)LittleLong( ( udword )objPath->parameters );
+		objPath->curve[0] = ( real32 *)LittleLong( ( udword )objPath->curve[0] );
+		objPath->curve[1] = ( real32 *)LittleLong( ( udword )objPath->curve[1] );
+		objPath->curve[2] = ( real32 *)LittleLong( ( udword )objPath->curve[2] );
+		objPath->curve[3] = ( real32 *)LittleLong( ( udword )objPath->curve[3] );
+		objPath->curve[4] = ( real32 *)LittleLong( ( udword )objPath->curve[4] );
+		objPath->curve[5] = ( real32 *)LittleLong( ( udword )objPath->curve[5] );
+	}
+#endif
+
     //sort the object headers based upon their parentage
     qsort(newHeader->objectPath, newHeader->nObjectPaths, sizeof(spaceobjpath), nisCompareFunc);
+
     for (index = 0; index < newHeader->nObjectPaths; index++)
     {                                                       //for each object motion path
         objPath = &newHeader->objectPath[index];            //get pointer to this motion path
@@ -4530,6 +4636,23 @@
             (ubyte *)objPath->curve[j] += (udword)newHeader;
         }
 
+#ifdef ENDIAN_BIG
+		for( j = 0; j < objPath->nSamples; j++ )
+		{
+			int k;
+
+			objPath->times[j]                 = LittleFloat( objPath->times[j] );
+			objPath->parameters[j].tension    = LittleFloat( objPath->parameters[j].tension );
+			objPath->parameters[j].continuity = LittleFloat( objPath->parameters[j].continuity );
+			objPath->parameters[j].bias       = LittleFloat( objPath->parameters[j].bias );
+			
+			for( k = 0; k < 6; k++ )
+			{
+				objPath->curve[k][j] = LittleFloat( objPath->curve[k][j] );
+			}
+		}
+#endif
+
 #if NIS_NORMALIZE_ANGLES
 
         for (j = 3; j < 6; j++)
@@ -4563,7 +4686,7 @@
             case P2:
             case P3:
             case Traders:
-                if (!_stricmp(string, "Missile"))
+                if (!strcasecmp(string, "Missile"))
                 {                                               //if they're creating a missile
                     type = objPath->race;
                     objPath->race = NSR_Missile;
@@ -4589,7 +4712,11 @@
                 type = StrToDerelictType(string);
                 break;
             case NSR_Effect:
+#ifdef _WIN32
                 sprintf(effectPath, "ETG\\%s.ebg", string);
+#else
+                sprintf(effectPath, "ETG/%s.ebg", string);
+#endif
                 etgErrorRecoverable = FALSE;
                 type = (ShipType)etgEffectCodeLoad(effectPath);
                 break;
@@ -4646,17 +4773,47 @@
             objPath->parentIndex = -1;
         }
     }
+
     (ubyte *)newHeader->cameraPath += (udword)newHeader;    //fixup the object motion path array
     for (index = 0; index < newHeader->nCameraPaths; index++)
     {                                                       //for each object motion path
         camPath = &newHeader->cameraPath[index];            //get pointer to this motion path
+
+#ifdef ENDIAN_BIG
+		camPath->oLength = LittleFloat( camPath->oLength );
+		camPath->nSamples = LittleLong( camPath->nSamples );
+		camPath->timeOffset = LittleFloat( camPath->timeOffset );
+		camPath->times = ( real32 *)LittleLong( ( udword )camPath->times );
+		camPath->parameters = ( tcb *)LittleLong( ( udword )camPath->parameters );
+#endif
+
         (ubyte *)camPath->parameters += (udword)newHeader;  //fixup the various arrays
         (ubyte *)camPath->times += (udword)newHeader;
         for (j = 0; j < 6; j++)
         {
+#ifdef ENDIAN_BIG
+			camPath->curve[j] = ( real32 *)LittleLong( ( udword )camPath->curve[j] );
+#endif
             (ubyte *)camPath->curve[j] += (udword)newHeader;
         }
 
+#ifdef ENDIAN_BIG
+		for( j = 0; j < camPath->nSamples; j++ )
+		{
+			int k;
+
+			camPath->times[j]                 = LittleFloat( camPath->times[j] );
+			camPath->parameters[j].tension    = LittleFloat( camPath->parameters[j].tension );
+			camPath->parameters[j].continuity = LittleFloat( camPath->parameters[j].continuity );
+			camPath->parameters[j].bias       = LittleFloat( camPath->parameters[j].bias );
+			
+			for( k = 0; k < 6; k++ )
+			{
+				camPath->curve[k][j] = LittleFloat( camPath->curve[k][j] );
+			}
+		}
+#endif
+
 #if NIS_NORMALIZE_ANGLES
         for (j = 3; j < 6; j++)
         {                                                   //for heading, pitch, bank
@@ -4679,7 +4836,11 @@
         {
             for (pString = localisedPath + strlen(localisedPath); pString > localisedPath; pString--)
             {                                               //find the end of the path
+#ifdef _WIN32
                 if (*pString == '\\')
+#else
+                if (*pString == '\\' || *pString == '/')
+#endif
                 {
                     strcpy(string, pString + 1);            //save the file name
                     strcpy(pString + 1, nisLanguageSubpath[strCurLanguage]);//add the language sub-path
@@ -4744,6 +4905,8 @@
                 case NEO_StaticOn:
                     memFree((char *)header->events[index].param[0]);//free the text strings
                     break;
+                default:
+                    break;
             }
         }
         memFree(header->events);
diff -urPw homeworld-orig/src/Game/NIS.h homeworld_sdl-0.3/src/Game/NIS.h
--- homeworld-orig/src/Game/NIS.h	2002-09-04 12:46:16.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/NIS.h	2004-08-01 22:35:20.000000000 -0700
@@ -10,18 +10,18 @@
 #define ___NIS_H
 
 #ifndef ___TYPES_H
-#include "types.h"
+#include "Types.h"
 #endif
 
 #ifndef ___B_SPLINE_H
-#include "b-spline.h"
+#include "B-Spline.h"
 #endif
 
-#include "camera.h"
-#include "spaceobj.h"
-#include "task.h"
-#include "fontreg.h"
-#include "statscript.h"
+#include "Camera.h"
+#include "SpaceObj.h"
+#include "Task.h"
+#include "FontReg.h"
+#include "StatScript.h"
 #include "texreg.h"
 
 /*=============================================================================
diff -urPw homeworld-orig/src/Game/Objectives.c homeworld_sdl-0.3/src/Game/Objectives.c
--- homeworld-orig/src/Game/Objectives.c	2002-09-04 12:46:16.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Objectives.c	2004-08-01 22:35:23.000000000 -0700
@@ -3,28 +3,33 @@
 //
 
 #include <string.h>
+#include <strings.h>
 #include <stdio.h>
-#include "types.h"
+#include "Types.h"
 #include "Objectives.h"
-#include "shipselect.h"
+#include "ShipSelect.h"
 #include "KASFunc.h"
-#include "memory.h"
+#include "Memory.h"
 #include "Strings.h"
 #include "font.h"
 #include "render.h"
-#include "feflow.h"
+#include "FEFlow.h"
 #include "mainrgn.h"
-#include "sensors.h"
-#include "universe.h"
-#include "taskbar.h"
-#include "kasfunc.h"
+#include "Sensors.h"
+#include "Universe.h"
+#include "TaskBar.h"
+#include "KASFunc.h"
 #include "SaveGame.h"
-#include "fontreg.h"
-#include "singleplayer.h"
-#include "soundevent.h"
+#include "FontReg.h"
+#include "SinglePlayer.h"
+#include "SoundEvent.h"
 #include "AIVar.h"
-#include "nis.h"
-#include "subtitle.h"
+#include "NIS.h"
+#include "Subtitle.h"
+
+#ifdef _MSC_VER
+#define strcasecmp _stricmp
+#endif
 
 extern sdword popupTextNumLines;
 extern char *getWord(char *dest, char *source); // defined in researchgui.c
@@ -116,7 +121,7 @@
     memStrncpy(objective->label, label, MAX_OBJECTIVE_LABEL_LENGTH);
     objective->description = memStringDupe(briefDescription);
 
-    if (!_stricmp(label, "hyperspace"))
+    if (!strcasecmp(label, "hyperspace"))
     {
         hyperspace = TRUE;
         singlePlayerGameInfo.playerCanHyperspace = TRUE;
@@ -213,8 +218,6 @@
 void objectiveSet(char *label, sdword status)
 {
     Objective *obj = objectiveFind(label);
-    sdword i = 0, completed = 0;
-
 
     if (!obj)
         return;
@@ -644,7 +647,7 @@
     for (i=0;i<objectivesUsed;i++)
     {
         objectives[i] = LoadObjective();
-        if (!_stricmp(objectives[i]->label, "hyperspace"))
+        if (!strcasecmp(objectives[i]->label, "hyperspace"))
         {
             dbgAssert(hyperspaceObjective == NULL);
             hyperspaceObjective = objectives[i];
diff -urPw homeworld-orig/src/Game/Objectives.h homeworld_sdl-0.3/src/Game/Objectives.h
--- homeworld-orig/src/Game/Objectives.h	2002-09-04 12:46:16.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Objectives.h	2004-08-01 22:35:23.000000000 -0700
@@ -5,9 +5,9 @@
 //  SINGLE-PLAYER MISSION OBJECTIVES
 //
 
-#include "types.h"
-#include "feflow.h"
-#include "linkedlist.h"
+#include "Types.h"
+#include "FEFlow.h"
+#include "LinkedList.h"
 
 #define MAX_OBJECTIVE_LABEL_LENGTH 32
 #define OBJECTIVES_ALLOC_INITIAL 8
diff -urPw homeworld-orig/src/Game/ObjTypes.c homeworld_sdl-0.3/src/Game/ObjTypes.c
--- homeworld-orig/src/Game/ObjTypes.c	2002-09-04 12:46:16.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/ObjTypes.c	2004-08-01 22:35:20.000000000 -0700
@@ -7,10 +7,15 @@
 =============================================================================*/
 
 #include <string.h>
-#include "types.h"
-#include "statscript.h"
-#include "strings.h"
-#include "objtypes.h"
+#include <strings.h>
+#include "Types.h"
+#include "StatScript.h"
+#include "Strings.h"
+#include "ObjTypes.h"
+
+#ifdef _MSC_VER
+#define strcasecmp _stricmp
+#endif
 
 /*=============================================================================
     Public Data:
@@ -440,6 +445,8 @@
     {
         return Traders;
     }
+
+    return 0;
 }
 
 /*-----------------------------------------------------------------------------
@@ -480,7 +487,7 @@
 
     for (i=0,curnumstr=numstrtab;curnumstr->str != NULL;i++,curnumstr++)
     {
-        if (_stricmp(str,curnumstr->str) == 0)
+        if (strcasecmp(str,curnumstr->str) == 0)
         {
             return curnumstr->number;
         }
diff -urPw homeworld-orig/src/Game/ObjTypes.h homeworld_sdl-0.3/src/Game/ObjTypes.h
--- homeworld-orig/src/Game/ObjTypes.h	2002-09-04 12:46:16.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/ObjTypes.h	2004-08-01 22:35:20.000000000 -0700
@@ -9,7 +9,7 @@
 #ifndef ___OBJTYPES_H
 #define ___OBJTYPES_H
 
-#include "types.h"
+#include "Types.h"
 #include "ClassDefs.h"
 #include "RaceDefs.h"
 #include "ShipDefs.h"
diff -urPw homeworld-orig/src/Game/Options.c homeworld_sdl-0.3/src/Game/Options.c
--- homeworld-orig/src/Game/Options.c	2002-09-04 12:46:16.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Options.c	2004-08-01 22:35:20.000000000 -0700
@@ -6,38 +6,40 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#define WIN32_LEAN_AND_MEAN
-#include <windows.h>
 #include <stdio.h>
 #include <math.h>
 #include "glinc.h"
-#include "types.h"
-#include "key.h"
-#include "feflow.h"
-#include "options.h"
-#include "fontreg.h"
+#include "Types.h"
+#include "Key.h"
+#include "FEFlow.h"
+#include "Options.h"
+#include "FontReg.h"
 #include "mouse.h"
 #include "utility.h"
-#include "uicontrols.h"
+#include "UIControls.h"
 #include "texreg.h"
-#include "sensors.h"
-#include "soundevent.h"
-#include "shader.h"
-#include "autolod.h"
+#include "Sensors.h"
+#include "SoundEvent.h"
+#include "Shader.h"
+#include "AutoLOD.h"
 #include "rinit.h"
-#include "aiplayer.h"
+#include "AIPlayer.h"
 #include "FEColour.h"
 #include "sstglide.h"
-#include "battle.h"
+#include "Battle.h"
 #include "soundlow.h"
 #include "glcompat.h"
 #include "InfoOverlay.h"
 #include "KeyBindings.h"
 #include "glcaps.h"
-#include "multiplayergame.h"
+#include "MultiplayerGame.h"
 #include "debugwnd.h"
 #include "devstats.h"
 
+#ifdef _MSC_VER
+#define strcasecmp _stricmp
+#endif
+
 
 /*=============================================================================
     Definitions:
@@ -693,11 +695,9 @@
 ----------------------------------------------------------------------------*/
 udword opSelectKey(regionhandle region, sdword ID, udword event, udword data)
 {
-    //sdword index;
-    color c = colRGB(250,200,120);
+    //sdword index = cmSelectShipType(region, mouseCursorY());
     uword column=0,row = 0;
 
-    //index = cmSelectShipType(region, mouseCursorY());
     bitClear(data, RF_ShiftBit);
 
     if ((mouseCursorX() > region->rect.x0+OP_KBMarginLeft) &&
@@ -1185,7 +1185,7 @@
     opTimerActive = FALSE;
     feScreenDisappear(NULL, NULL);
     opGLCStart();
-    if (_stricmp(GLC_RENDERER, GENERIC_OPENGL_RENDERER) == 0)
+    if (strcasecmp(GLC_RENDERER, GENERIC_OPENGL_RENDERER) == 0)
     {
         GeneralMessageBox(strGetString(strGDIGeneric0),
                           strGetString(strGDIGeneric1));
@@ -1389,7 +1389,7 @@
                 mainSaveRender();
                 opGLCStop();
 
-                if (_stricmp(rnd->name, "3dfx OpenGL") == 0)
+                if (strcasecmp(rnd->name, "3dfx OpenGL") == 0)
                 {
                     opUsing3DfxGL = TRUE;
                 }
@@ -1422,7 +1422,7 @@
 
                 opUsing3DfxGL = FALSE;
                 soundEventRestart();
-                Sleep(20);
+                SDL_Delay(20);
                 opGLCStart();
             }
         }
@@ -1904,7 +1904,10 @@
     {
         if (utyTest(SSA_DebugWindow))
         {
-            dbwWriteOptions();
+            /* dbw*() functions in other parts of code (main.c, utility.c, and
+               Debug.c) will need to be uncommented if the debug window is
+               reenabled. */
+            /*dbwWriteOptions();*/
         }
     }
 }
@@ -2334,7 +2337,7 @@
     }
     else
     {
-        opSpeakerSetting = (ubyte)atom->pData;
+        opSpeakerSetting = (sdword)atom->pData;
     }
 
     opEQHelper();
@@ -2348,7 +2351,7 @@
     }
     else
     {
-        opSoundQuality = (ubyte)atom->pData;
+        opSoundQuality = (sdword)atom->pData;
     }
 
     soundMixerSetMode(opSoundQuality);
@@ -2388,7 +2391,7 @@
     }
     else
     {
-        opLightingVal = (ubyte)atom->pData;
+        opLightingVal = (sdword)atom->pData;
     }
 }
 
@@ -2479,7 +2482,7 @@
     }
     else
     {
-        opEffectsVal = (ubyte)atom->pData;
+        opEffectsVal = (sdword)atom->pData;
     }
 
     opEffectsHelper();
@@ -3230,7 +3233,7 @@
     }
     else
     {
-        opVoiceSetting = (ubyte)atom->pData;
+        opVoiceSetting = (sdword)atom->pData;
     }
 
     switch (opVoiceSetting)
@@ -3654,11 +3657,11 @@
                 (smoo->callback)(smoo->buffer, smoo);
             }
 #else
-            if (abs(*(smoo->source)) == smoo->buffer)
+            if (ABS(*(smoo->source)) == smoo->buffer)
             {
                 ; //nothing
             }
-            else if (abs(*(smoo->source) - smoo->buffer) < smoo->threshold)
+            else if (ABS(*(smoo->source) - smoo->buffer) < smoo->threshold)
             {
                 //make same and do last update
                 *(smoo->source) = smoo->buffer;
diff -urPw homeworld-orig/src/Game/Options.h homeworld_sdl-0.3/src/Game/Options.h
--- homeworld-orig/src/Game/Options.h	2002-09-04 12:46:16.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Options.h	2004-08-01 22:35:20.000000000 -0700
@@ -11,9 +11,9 @@
 #ifndef ___OPTIONS_H
 #define ___OPTIONS_H
 
-#include "types.h"
-#include "liloptions.h"
-#include "region.h"
+#include "Types.h"
+#include "LilOptions.h"
+#include "Region.h"
 
 /*=============================================================================
     Definitions:
@@ -74,6 +74,8 @@
 #define NUM_SMOOTHIES 32
 
 
+struct SmoothieX;
+
 typedef void (*smoothieFunc)(real32 data, struct SmoothieX *smoo);    //callback function
 
 typedef struct SmoothieX
diff -urPw homeworld-orig/src/Game/Particle.c homeworld_sdl-0.3/src/Game/Particle.c
--- homeworld-orig/src/Game/Particle.c	2002-09-04 12:46:16.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Particle.c	2004-08-01 22:35:17.000000000 -0700
@@ -8,29 +8,32 @@
 
 #define PART_TEST_MORPH 0
 
+#ifdef _WIN32
+#include <windows.h>
+#endif
+
 #include <stdio.h>
 #include <math.h>
 #include <float.h>
-#include <windows.h>
 #include "glinc.h"
-#include "types.h"
-#include "vector.h"
-#include "randy.h"
-#include "debug.h"
+#include "Types.h"
+#include "Vector.h"
+#include "Randy.h"
+#include "Debug.h"
 #include "color.h"
-#include "matrix.h"
-#include "memory.h"
-#include "particle.h"
-#include "spaceobj.h"
+#include "Matrix.h"
+#include "Memory.h"
+#include "Particle.h"
+#include "SpaceObj.h"
 #include "render.h"
-#include "mesh.h"
+#include "Mesh.h"
 #include "texreg.h"
-#include "fastmath.h"
+#include "FastMath.h"
 #include "mainrgn.h"
-#include "task.h"
-#include "universe.h"
-#include "autolod.h"
-#include "shader.h"
+#include "Task.h"
+#include "Universe.h"
+#include "AutoLOD.h"
+#include "Shader.h"
 #include "glcaps.h"
 #include "devstats.h"
 
@@ -62,7 +65,7 @@
 static bool wasStippled;
 
 //function called for each particle created
-void (*partCreateCallback)(sdword userValue, void *userData) = NULL;
+void (*partCreateCallback)(sdword userValue, ubyte *userData) = NULL;
 sdword partCreateUserValue = 0;
 ubyte *partCreateUserData = NULL;
 
@@ -332,7 +335,6 @@
         if ((r) < -1.0f) r = -1.0f; \
         else if ((r) > 1.0f) r = 1.0f;
 
-static psysPtr g_psys = NULL;
 static hmatrix particleHMatrix;
 static matrix  shiprotmatrix;
 static vector  shipposition;
@@ -1607,12 +1609,12 @@
         {
             vector rv = p->wVel;
             vecNormalize(&rv);
-            if (_isnan((double)rv.x) || _isnan((double)rv.y) || _isnan((double)rv.z) || 
-				abs(rv.x) < REALlySmall && abs(rv.y) <= REALlySmall && abs(rv.z) <= REALlySmall)
+            if (isnan((double)rv.x) || isnan((double)rv.y) || isnan((double)rv.z) ||
+				(ABS(rv.x) < REALlySmall && ABS(rv.y) <= REALlySmall && ABS(rv.z) <= REALlySmall))
             {
                 rv.z = 1.0f;
             }
-            if (!_isnan((double)p->length))
+            if (!isnan((double)p->length))
             {
                 vecMultiplyByScalar(rv, p->length);
             }
@@ -1939,26 +1941,34 @@
 
     ma = (meshAnim*)memAlloc(5*sizeof(meshAnim), "mesh animation block", 0);
 
+#ifdef _WIN32
+#define TMP_MESH_PATH "etg\\meshes\\"
+#else
+#define TMP_MESH_PATH "etg/meshes/"
+#endif
+
     a = ma;
-    a->mesh = meshLoad("etg\\meshes\\head00.geo");
+    a->mesh = meshLoad(TMP_MESH_PATH "head00.geo");
     a->flags = PART_LOOPSTART;
 
     a++;
-    a->mesh = meshLoad("etg\\meshes\\head01.geo");
+    a->mesh = meshLoad(TMP_MESH_PATH "head01.geo");
     a->flags = 0;
 
     a++;
-    a->mesh = meshLoad("etg\\meshes\\head02.geo");
+    a->mesh = meshLoad(TMP_MESH_PATH "head02.geo");
     a->flags = 0;
 
     a++;
-    a->mesh = meshLoad("etg\\meshes\\head03.geo");
+    a->mesh = meshLoad(TMP_MESH_PATH "head03.geo");
     a->flags = PART_LOOP;
 
     a++;
     a->mesh = NULL;
     a->flags = 0;
 
+#undef TMP_MESH_PATH
+
     return ma;
 }
 #endif
@@ -2035,7 +2045,7 @@
     //find the trivial next
     frame = (sdword)p->meshFrame + 1;
     next = animblock + frame;
-    if (next->mesh == NULL || (sdword)next->mesh == -1)
+    if (next->mesh == NULL || next->mesh == 0x7fffffff)
     {
         if (p->loopCount == 0)
         {
@@ -2307,7 +2317,7 @@
         if (p->deltaLength)
         {
             p->length += dt * p->deltaLength;
-            if (_isnan((double)p->length))
+            if (isnan((double)p->length))
             {
                 p->length = 1.0f;
             }
diff -urPw homeworld-orig/src/Game/Particle.h homeworld_sdl-0.3/src/Game/Particle.h
--- homeworld-orig/src/Game/Particle.h	2002-09-04 12:46:16.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Particle.h	2004-08-01 22:35:18.000000000 -0700
@@ -8,9 +8,9 @@
 #ifndef __PARTICLE_H
 #define __PARTICLE_H
 
-#include "matrix.h"
+#include "Matrix.h"
 #include "color.h"
-#include "spaceobj.h"
+#include "SpaceObj.h"
 #include "texreg.h"
 
 void partFilter(bool on);
diff -urPw homeworld-orig/src/Game/Physics.c homeworld_sdl-0.3/src/Game/Physics.c
--- homeworld-orig/src/Game/Physics.c	2002-09-04 12:46:16.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Physics.c	2004-08-01 22:35:29.000000000 -0700
@@ -7,23 +7,23 @@
 =============================================================================*/
 
 #include <math.h>
-#include "types.h"
-#include "debug.h"
-#include "vector.h"
-#include "matrix.h"
-#include "fastmath.h"
-#include "spaceobj.h"
-#include "collision.h"
-#include "physics.h"
-#include "soundevent.h"
-#include "universe.h"
-#include "univupdate.h"
-#include "tweak.h"
-#include "tactics.h"
-#include "attributes.h"
-#include "gun.h"
-#include "multiplayergame.h"
-#include "battle.h"
+#include "Types.h"
+#include "Debug.h"
+#include "Vector.h"
+#include "Matrix.h"
+#include "FastMath.h"
+#include "SpaceObj.h"
+#include "Collision.h"
+#include "Physics.h"
+#include "SoundEvent.h"
+#include "Universe.h"
+#include "UnivUpdate.h"
+#include "Tweak.h"
+#include "Tactics.h"
+#include "Attributes.h"
+#include "Gun.h"
+#include "MultiplayerGame.h"
+#include "Battle.h"
 
 #define UPDATE_COLLRECT_RATE    3
 #define UPDATE_COLLRECT_FRAME   3
@@ -187,6 +187,8 @@
                             case GUN_NewGimble:
                                 gunOrientGimbleGun(ship,gun,bullet->target);
                                 break;
+                            default:
+                                break;
                         }
                     }
 
diff -urPw homeworld-orig/src/Game/Physics.h homeworld_sdl-0.3/src/Game/Physics.h
--- homeworld-orig/src/Game/Physics.h	2002-09-04 12:46:16.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Physics.h	2004-08-01 22:35:29.000000000 -0700
@@ -9,15 +9,15 @@
 #ifndef ___PHYSICS_H
 #define ___PHYSICS_H
 
-#include "types.h"
-#include "vector.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Vector.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Macros:
 =============================================================================*/
 
-#define physApplyForceVectorToObj(obj,forcevector) vecAddTo((obj)##->posinfo.force,(forcevector))
+#define physApplyForceVectorToObj(obj,forcevector) vecAddTo((obj)->posinfo.force,(forcevector))
 
 /*=============================================================================
     Functions:
diff -urPw homeworld-orig/src/Game/PiePlate.c homeworld_sdl-0.3/src/Game/PiePlate.c
--- homeworld-orig/src/Game/PiePlate.c	2002-09-04 12:46:16.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/PiePlate.c	2004-08-01 22:35:32.000000000 -0700
@@ -7,35 +7,37 @@
 =============================================================================*/
 
 #ifndef SW_Render
+#ifdef _WIN32
 #include <windows.h>
 #endif
+#endif
 #include "glinc.h"
 #include <math.h>
 #include <float.h>
 #include <stdio.h>
-#include "spaceobj.h"
-#include "universe.h"
+#include "SpaceObj.h"
+#include "Universe.h"
 #include "mouse.h"
-#include "select.h"
-#include "undo.h"
+#include "Select.h"
+#include "Undo.h"
 #include "font.h"
-#include "fontreg.h"
+#include "FontReg.h"
 #include "main.h"
 #include "color.h"
 #include "mainrgn.h"
 #include "prim2d.h"
 #include "prim3d.h"
-#include "fastmath.h"
+#include "FastMath.h"
 #include "render.h"
-#include "sensors.h"
+#include "Sensors.h"
 #include "mainrgn.h"
-#include "lod.h"
-#include "clipper.h"
-#include "pieplate.h"
+#include "LOD.h"
+#include "Clipper.h"
+#include "PiePlate.h"
 #include "glcaps.h"
-#include "proximitySensor.h"
-#include "tutor.h"
-#include "soundevent.h"
+#include "ProximitySensor.h"
+#include "Tutor.h"
+#include "SoundEvent.h"
 
 /*=============================================================================
     Data:
@@ -570,7 +572,7 @@
                  (shipPoint.y - selCentrePoint.y) * (shipPoint.y - selCentrePoint.y)));
         //now draw circle on the plane
         bHeightPointDrawn = FALSE;
-        if (abs(shipPoint.z - planePoint.z) > ship->staticinfo->staticheader.staticCollInfo.collspheresize)
+        if (ABS(shipPoint.z - planePoint.z) > ship->staticinfo->staticheader.staticCollInfo.collspheresize)
         {
             radius = ship->staticinfo->staticheader.staticCollInfo.collspheresize;
             selCircleComputeGeneral(&rndCameraMatrix, &rndProjectionMatrix,
@@ -592,8 +594,8 @@
         }
 
         //see if this is the closest ship to the cursor
-        length = abs(piePlanePoint.x - planePoint.x) +       //manhattan distance
-            abs(piePlanePoint.y - planePoint.y);
+        length = ABS(piePlanePoint.x - planePoint.x) +       //manhattan distance
+            ABS(piePlanePoint.y - planePoint.y);
         if (length < closestDistance)
         {                                                   //if this ship closest so far
             closestDistance = length;
@@ -731,7 +733,7 @@
     sdword nSegments;
 
     stipple = glCapFastFeature(GL_LINE_STIPPLE);
-    if (abs(piePointSpecZ) < pieDottedDistance)
+    if (ABS(piePointSpecZ) < pieDottedDistance)
     {
         if (stipple)
         {
@@ -913,7 +915,6 @@
     Return      : TRUE if a valid intersection found, FALSE otherwise
 ----------------------------------------------------------------------------*/
 #define SGN(x)      ((x) < 0.0f ? -1.0f : 1.0f)
-#define ABS(x)      ((x) < 0.0f ? -(x) : (x))
 bool pieMovePointClipToLimits(real32 sizeX, real32 sizeY, real32 sizeZ, vector *pointA, vector *pointB)
 {
     real32 discriminant;
@@ -1003,7 +1004,6 @@
     return(TRUE);
 }
 #undef SGN
-#undef ABS
 
 /*-----------------------------------------------------------------------------
     Name        : piePointSpecDraw
@@ -1213,7 +1213,7 @@
             }
             */
             //don't use this new value if the intersection test resulted in a bad number
-            if (!_isnan(pieHeightPoint.z))
+            if (!isnan(pieHeightPoint.z))
             {
                 //compute point along this line
                 pieHeightPoint.x = piePlanePoint.x;         //compute height point relative to pizza dish
@@ -1262,7 +1262,7 @@
             pieHeightPoint.y = piePlanePoint.y;
         }
         maxMoveLength = pieMaxMoveVertical;
-        moveLength = abs(pieHeightPoint.z - piePlanePoint.z);
+        moveLength = ABS(pieHeightPoint.z - piePlanePoint.z);
         if (moveLength > maxMoveLength)
         {                                                   //if moved too high
             pieHeightPoint.z = piePlanePoint.z + (pieHeightPoint.z - piePlanePoint.z) * maxMoveLength / moveLength;
diff -urPw homeworld-orig/src/Game/PiePlate.h homeworld_sdl-0.3/src/Game/PiePlate.h
--- homeworld-orig/src/Game/PiePlate.h	2002-09-04 12:46:16.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/PiePlate.h	2004-08-01 22:35:32.000000000 -0700
@@ -9,7 +9,7 @@
 #ifndef ___PIEPLATE_H
 #define ___PIEPLATE_H   PI
 
-#include "types.h"
+#include "Types.h"
 
 /*=============================================================================
     Switches:
@@ -89,8 +89,8 @@
 extern color piePointLineColor;
 extern color pieOriginColor;
 extern void (*pieLineDrawCallback)(real32 distance);
-void (*pieMovementCursorDrawCallback)(real32 distance);
-void (*piePlaneDrawCallback)(real32 distance);
+extern void (*pieMovementCursorDrawCallback)(real32 distance);
+extern void (*piePlaneDrawCallback)(real32 distance);
 
 #if PIE_VISUALIZE_VERTICAL
 extern vector pieScreen0, pieScreen1;
diff -urPw homeworld-orig/src/Game/Ping.c homeworld_sdl-0.3/src/Game/Ping.c
--- homeworld-orig/src/Game/Ping.c	2002-09-04 12:46:16.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Ping.c	2004-08-01 22:35:32.000000000 -0700
@@ -8,29 +8,29 @@
 
 #include <math.h>
 #include <string.h>
-#include "types.h"
-#include "memory.h"
-#include "debug.h"
-#include "task.h"
+#include "Types.h"
+#include "Memory.h"
+#include "Debug.h"
+#include "Task.h"
 #include "prim2d.h"
-#include "spaceobj.h"
-#include "linkedlist.h"
-#include "universe.h"
-#include "camera.h"
-#include "pieplate.h"
-#include "select.h"
-#include "blobs.h"
-#include "strings.h"
-#include "tactical.h"
-#include "teams.h"
+#include "SpaceObj.h"
+#include "LinkedList.h"
+#include "Universe.h"
+#include "Camera.h"
+#include "PiePlate.h"
+#include "Select.h"
+#include "Blobs.h"
+#include "Strings.h"
+#include "Tactical.h"
+#include "Teams.h"
 #include "ProximitySensor.h"
-#include "sensors.h"
-#include "alliance.h"
-#include "battle.h"
+#include "Sensors.h"
+#include "Alliance.h"
+#include "Battle.h"
 #include "SaveGame.h"
-#include "soundevent.h"
-#include "cameraCommand.h"
-#include "ping.h"
+#include "SoundEvent.h"
+#include "CameraCommand.h"
+#include "Ping.h"
 
 /*=============================================================================
     Data:
@@ -151,7 +151,10 @@
     static ping *thisPing;
 
     taskYield(0);
+    
+#ifndef C_ONLY
     while (1)
+#endif
     {
         taskStackSaveCond(0);
 
diff -urPw homeworld-orig/src/Game/Ping.h homeworld_sdl-0.3/src/Game/Ping.h
--- homeworld-orig/src/Game/Ping.h	2002-09-04 12:46:16.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Ping.h	2004-08-01 22:35:32.000000000 -0700
@@ -9,10 +9,10 @@
 #ifndef ___PING_H
 #define ___PING_H
 
-#include "types.h"
-#include "linkedlist.h"
-#include "spaceobj.h"
-#include "blobs.h"
+#include "Types.h"
+#include "LinkedList.h"
+#include "SpaceObj.h"
+#include "Blobs.h"
 
 /*=============================================================================
     Switches:
@@ -74,6 +74,8 @@
     Type definitions:
 =============================================================================*/
 
+struct ping;
+
 typedef bool (*pingeval)(struct ping *hellaPing, udword userID, char *userData, bool bRemoveReferences);
 //structure of a ping
 typedef struct ping
diff -urPw homeworld-orig/src/Game/PlugScreen.c homeworld_sdl-0.3/src/Game/PlugScreen.c
--- homeworld-orig/src/Game/PlugScreen.c	2002-09-04 12:46:16.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/PlugScreen.c	2004-08-01 22:35:36.000000000 -0700
@@ -11,19 +11,19 @@
 #include <string.h>
 #include <math.h>
 #include "glinc.h"
-#include "task.h"
-#include "region.h"
+#include "Task.h"
+#include "Region.h"
 #include "color.h"
 #include "prim2d.h"
 #include "interfce.h"
 #include "texreg.h"
-#include "fontreg.h"
-#include "statscript.h"
-#include "feflow.h"
+#include "FontReg.h"
+#include "StatScript.h"
+#include "FEFlow.h"
 #include "mouse.h"
 #include "utility.h"
-#include "soundevent.h"
-#include "strings.h"
+#include "SoundEvent.h"
+#include "Strings.h"
 #include "PlugScreen.h"
 #include "render.h"
 #include "glcompat.h"
@@ -575,11 +575,13 @@
 void psRenderTaskFunction(void)
 {
     static bool shouldSwap;
-    static sdword index;
     static regionhandle reg;
 
     taskYield(0);
+    
+#ifndef C_ONLY
     while (1)
+#endif
     {
         primErrorMessagePrint();
 
@@ -747,7 +749,7 @@
     Outputs     :
     Return      : void
 ----------------------------------------------------------------------------*/
-ubyte psScreenSkipKey[] = {ESCKEY, SPACEKEY, ENTERKEY, 0};
+udword psScreenSkipKey[] = {ESCKEY, SPACEKEY, ENTERKEY, 0};
 void psScreenStart(char *name)
 {
     sdword index;
diff -urPw homeworld-orig/src/Game/PlugScreen.h homeworld_sdl-0.3/src/Game/PlugScreen.h
--- homeworld-orig/src/Game/PlugScreen.h	2002-09-04 12:46:16.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/PlugScreen.h	2004-08-01 22:35:36.000000000 -0700
@@ -10,7 +10,7 @@
 #define ___PLUGSCREEN_H
 
 #include "texreg.h"
-#include "region.h"
+#include "Region.h"
 
 /*=============================================================================
     Switches:
diff -urPw homeworld-orig/src/Game/ProfileTimers.c homeworld_sdl-0.3/src/Game/ProfileTimers.c
--- homeworld-orig/src/Game/ProfileTimers.c	2002-09-04 12:46:16.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/ProfileTimers.c	2004-08-01 22:35:34.000000000 -0700
@@ -4,9 +4,9 @@
 #include "color.h"
 #include "font.h"
 #include <string.h>
-#include "memory.h"
-#include "debug.h"
-#include "file.h"
+#include "Memory.h"
+#include "Debug.h"
+#include "File.h"
 
 #ifdef PROFILE_TIMERS
 
diff -urPw homeworld-orig/src/Game/ProfileTimers.h homeworld_sdl-0.3/src/Game/ProfileTimers.h
--- homeworld-orig/src/Game/ProfileTimers.h	2002-09-04 12:46:16.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/ProfileTimers.h	2004-08-01 22:35:35.000000000 -0700
@@ -1,5 +1,5 @@
 
-#include "types.h"
+#include "Types.h"
 
 #ifndef HW_Release
 #define PROFILE_TIMERS
diff -urPw homeworld-orig/src/Game/Randy.c homeworld_sdl-0.3/src/Game/Randy.c
--- homeworld-orig/src/Game/Randy.c	2002-09-04 12:46:16.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Randy.c	2004-08-01 22:35:29.000000000 -0700
@@ -6,18 +6,15 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-// unfortunately need this for system time
-#define WIN32_LEAN_AND_MEAN
-#include <windows.h>
-
-#include "types.h"
-#include "debug.h"
-#include "randy.h"
+#include <string.h>
+#include "Types.h"
+#include "Debug.h"
+#include "Randy.h"
 #include "SaveGame.h"
 
 #if RAN_DEBUG_CALLER
-#include "universe.h"
-#include "file.h"
+#include "Universe.h"
+#include "File.h"
 #include <stdio.h>
 #endif
 
@@ -64,6 +61,7 @@
     ranstream *stream;
 
 #if RAN_DEBUG_CALLER
+    char *fileNameFull;
     char *truncatedFile;
     FILE *fp;
 
@@ -75,7 +73,11 @@
         }
         if (ranLogIndex >= RAN_LogBufferLength)
         {
-            fp = fopen(RAN_LogFile, ranLogCleared ? "at" : "wt");
+            fileNameFull = filePathPrepend(RAN_LogFile, FF_UserSettingsPath);
+
+            if (fileMakeDestinationDirectory(fileNameFull))
+            {
+                fp = fopen(fileNameFull, ranLogCleared ? "at" : "wt");
             if (fp != NULL)
             {
                 ranLogCleared = TRUE;
@@ -85,6 +87,7 @@
                 }
                 fclose(fp);
             }
+            }
             ranLogIndex = 0;
         }
         truncatedFile = file + strlen(file) - (RAN_LogStringLength - 1);
@@ -197,13 +200,13 @@
 ----------------------------------------------------------------------------*/
 void ranRandomize(sdword ranIndex)
 {
-    SYSTEMTIME systime;
+    Uint32 curr_ticks;
     udword iter;
     udword i;
 
-    GetSystemTime(&systime);
+    curr_ticks = SDL_GetTicks();
 
-    iter = systime.wSecond & 255;
+    iter = curr_ticks & 255;
 
     for (i=0;i<iter;i++)
     {
@@ -238,12 +241,17 @@
 void ranShutdown(void)
 {
 #if RAN_DEBUG_CALLER
+    char *fileNameFull;
     FILE *fp;
     sdword index;
 
     if (ranLogBuffer != NULL)
     {
-        fp = fopen(RAN_LogFile, ranLogCleared ? "at" : "wt");
+        fileNameFull = filePathPrepend(RAN_LogFile, FF_UserSettingsPath);
+
+        if (fileMakeDestinationDirectory(fileNameFull))
+        {
+            fp = fopen(fileNameFull, ranLogCleared ? "at" : "wt");
         if (fp != NULL)
         {
             ranLogCleared = TRUE;
@@ -253,6 +261,7 @@
             }
             fclose(fp);
         }
+        }
         ranLogIndex = 0;
         memFree(ranLogBuffer);
     }
diff -urPw homeworld-orig/src/Game/Randy.h homeworld_sdl-0.3/src/Game/Randy.h
--- homeworld-orig/src/Game/Randy.h	2002-09-04 12:46:16.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Randy.h	2004-08-01 22:35:29.000000000 -0700
@@ -9,7 +9,7 @@
 #ifndef ___RANDY_H
 #define ___RANDY_H
 
-#include "types.h"
+#include "Types.h"
 
 /*=============================================================================
     Swithces:
@@ -104,7 +104,7 @@
 #define ranRandom(i)    ranRandomFn(i, NULL, 0)
 #define gamerand() ranRandomFn(RAN_Game, __FILE__, __LINE__)
 // if you change RAN_Game in randy.h, change 11 as well.  Don't include randy.h because types.h included in other projects
-#define random(n) (ranRandomFn(RAN_Game, __FILE__, __LINE__) % (n))
+#define randomG(n) (ranRandomFn(RAN_Game, __FILE__, __LINE__) % (n))
 // if you change RAN_Game in randy.h, change 11 as well.  Don't include randy.h because types.h included in other projects
 #define frandom(n) (ranRandomFn(RAN_Game, __FILE__, __LINE__) * (((real32)(n)) * (1.0f/((real32)UDWORD_Max))))
 
@@ -113,13 +113,13 @@
 #define ranRandom(i)    ranRandomFn(i)
 #define gamerand() ranRandomFn(RAN_Game)
 // if you change RAN_Game in randy.h, change 11 as well.  Don't include randy.h because types.h included in other projects
-#define random(n) (ranRandomFn(RAN_Game) % (n))
+#define randomG(n) (ranRandomFn(RAN_Game) % (n))
 // if you change RAN_Game in randy.h, change 11 as well.  Don't include randy.h because types.h included in other projects
 #define frandom(n) (ranRandomFn(RAN_Game) * (((real32)(n)) * (1.0f/((real32)UDWORD_Max))))
 
 #endif //RAN_DEBUG_CALLER
 
-#define randombetween(a,b) ( random((b)-(a)+1) + (a) )
+#define randombetween(a,b) ( randomG((b)-(a)+1) + (a) )
 #define frandombetween(a,b) (frandom((b)-(a)) + (a))
 
 #endif //___RANDY_H
diff -urPw homeworld-orig/src/Game/Region.c homeworld_sdl-0.3/src/Game/Region.c
--- homeworld-orig/src/Game/Region.c	2002-09-04 12:46:16.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Region.c	2004-08-01 22:35:18.000000000 -0700
@@ -11,17 +11,23 @@
 #include <stdio.h>
 #include <stdarg.h>
 #include <string.h>
-#include "types.h"
-#include "debug.h"
-#include "memory.h"
-#include "task.h"
-#include "key.h"
+#include <strings.h>
+#include <ctype.h>
+#include "Types.h"
+#include "Debug.h"
+#include "Memory.h"
+#include "Task.h"
+#include "Key.h"
 #include "prim2d.h"
 #include "mouse.h"
-#include "demo.h"
+#include "Demo.h"
 #include "main.h"
 #include "utility.h"
-#include "region.h"
+#include "Region.h"
+
+#ifdef _MSC_VER
+#define strcasecmp _stricmp
+#endif
 
 /*=============================================================================
     Data:
@@ -807,7 +813,7 @@
         {
             if (bShift)
             {
-                iKey |= BIT9;
+                iKey |= RF_ShiftBit;
             }
             regFunctionCall(reg, RPE_KeyDown, iKey, &mask);//call the function
         }
@@ -911,15 +917,23 @@
 {
     taskYield(0);
 
+#ifndef C_ONLY
     while (1)
+#endif
     {
         taskStackSaveCond(0);
 #if REG_VERBOSE_LEVEL >= 2
         dbgMessage("\nProcessing regions...");
 #endif
         mousePoll();                                        //poll mouse
+#if defined (_MSC_VER)
         _asm xor eax,eax
         _asm mov regRenderEventIndex, eax
+#elif defined (__GNUC__) && defined (__i386__)
+        __asm__ __volatile__ ( "xorl %%eax, %%eax\n\t" : "=a" (regRenderEventIndex) );
+#else
+        regRenderEventIndex = 0;
+#endif
 //        regRenderEventIndex = regRenderEventIndex - regRenderEventIndex;                            //no render events yet this frame
 
         //special-case code for double-clicks
@@ -946,6 +960,7 @@
         taskStackRestoreCond();
         taskYield(0);
     }
+
     taskExit();
 }
 #pragma optimize("", on)
@@ -1198,7 +1213,8 @@
     newRegion->drawFunction = regNULLRenderFunction;        //blank processing functions
     newRegion->processFunction = regNULLProcessFunction;
     newRegion->userID = ID;
-    *((udword *)newRegion->key) = 0;
+    /**((udword *)newRegion->key) = 0;*/
+    memset(newRegion->key, 0, sizeof(keyindex) * REG_NumberKeys);
     newRegion->nKeys = 0;
     listInit(&newRegion->cutouts);
 #if REG_ERROR_CHECKING
@@ -1646,7 +1662,7 @@
     va_start(argPointer, nKeys);
     for (index = 0; index < nKeys; index++)
     {
-        region->key[index] = va_arg(argPointer, keyindex);
+        region->key[index] = tolower(va_arg(argPointer, keyindex));
     }
     va_end(argPointer);
 }
@@ -1753,7 +1769,7 @@
         if(child->atom)
         {
             pAtom = (featom *)child->atom;
-            if(pAtom->name && (stricmp(pAtom->name, pAtomName) == 0))
+            if(pAtom->name && (strcasecmp(pAtom->name, pAtomName) == 0))
                 return child;
         }
 
diff -urPw homeworld-orig/src/Game/Region.h homeworld_sdl-0.3/src/Game/Region.h
--- homeworld-orig/src/Game/Region.h	2002-09-04 12:46:16.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Region.h	2004-08-01 22:35:18.000000000 -0700
@@ -44,12 +44,12 @@
 #ifndef ___REGION_H
 #define ___REGION_H
 
-#include "types.h"
-#include "memory.h"
-#include "key.h"
-#include "debug.h"
+#include "Types.h"
+#include "Memory.h"
+#include "Key.h"
+#include "Debug.h"
 #include "prim2d.h"
-#include "linkedlist.h"
+#include "LinkedList.h"
 
 /*=============================================================================
     Switches:
@@ -151,12 +151,14 @@
 #define REG_TaskStackSize           100000      //size of region processing task stack
 #define REG_OutlineColor            colRGB(10, 10, 30)//color of outlines
 
-#define RF_ShiftBit                 BIT9        //shift status in certain functions
+#define RF_ShiftBit                 BIT10       //shift status in certain functions
 
 /*=============================================================================
     Type definitions:
 =============================================================================*/
 
+struct tagRegion;
+
 //pointers to region functions
 typedef void (*regiondrawfunction) (struct tagRegion *reg);
 typedef udword (*regionfunction) (struct tagRegion *reg, sdword ID, udword event, udword data);
diff -urPw homeworld-orig/src/Game/ResCollect.c homeworld_sdl-0.3/src/Game/ResCollect.c
--- homeworld-orig/src/Game/ResCollect.c	2002-09-04 12:46:16.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/ResCollect.c	2004-08-01 22:35:36.000000000 -0700
@@ -1,26 +1,26 @@
 
 #include <stdlib.h>
-#include "types.h"
-#include "fastmath.h"
-#include "memory.h"
-#include "debug.h"
-#include "vector.h"
-#include "spaceobj.h"
-#include "aitrack.h"
-#include "aiship.h"
-#include "rescollect.h"
-#include "commandlayer.h"
-#include "statscript.h"
-#include "univupdate.h"
-#include "universe.h"
-#include "soundevent.h"
-#include "collision.h"
-#include "physics.h"
-#include "tutor.h"
-#include "randy.h"
-#include "clouds.h"
-#include "nebulae.h"
-#include "singleplayer.h"
+#include "Types.h"
+#include "FastMath.h"
+#include "Memory.h"
+#include "Debug.h"
+#include "Vector.h"
+#include "SpaceObj.h"
+#include "AITrack.h"
+#include "AIShip.h"
+#include "ResCollect.h"
+#include "CommandLayer.h"
+#include "StatScript.h"
+#include "UnivUpdate.h"
+#include "Universe.h"
+#include "SoundEvent.h"
+#include "Collision.h"
+#include "Physics.h"
+#include "Tutor.h"
+#include "Randy.h"
+#include "Clouds.h"
+#include "Nebulae.h"
+#include "SinglePlayer.h"
 
 #ifndef HW_Release
 
@@ -153,9 +153,9 @@
         maxvelocitychase = MAX_RESOURCE_VELOCITY_TO_CHASE_LEVEL6;
     }
 
-    if ((abs(resource->posinfo.velocity.x) > maxvelocitychase) ||
-        (abs(resource->posinfo.velocity.y) > maxvelocitychase) ||
-        (abs(resource->posinfo.velocity.z) > maxvelocitychase) )
+    if ((ABS(resource->posinfo.velocity.x) > maxvelocitychase) ||
+        (ABS(resource->posinfo.velocity.y) > maxvelocitychase) ||
+        (ABS(resource->posinfo.velocity.z) > maxvelocitychase) )
     {
 #ifdef DEBUG_COLLECTRESOURCES
             dbgMessage("\nResource moving too fast. Picking different one...");
@@ -460,7 +460,6 @@
 ----------------------------------------------------------------------------*/
 void DustCloudChargesUp(DustCloud* dustcloud, sdword damagetaken, bool targetWasAlive)
 {
-    DustCloudStaticInfo* dustcloudstatic = (DustCloudStaticInfo*)dustcloud->staticinfo;
     cloudSystem* csys = (cloudSystem*)dustcloud->stub;
 
     if (!targetWasAlive || csys == NULL)
diff -urPw homeworld-orig/src/Game/ResCollect.h homeworld_sdl-0.3/src/Game/ResCollect.h
--- homeworld-orig/src/Game/ResCollect.h	2002-09-04 12:46:16.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/ResCollect.h	2004-08-01 22:35:36.000000000 -0700
@@ -2,9 +2,9 @@
 #ifndef ___RESCOLLECT_H
 #define ___RESCOLLECT_H
 
-#include "types.h"
-#include "spaceobj.h"
-#include "attributes.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "Attributes.h"
 
 typedef struct
 {
@@ -13,6 +13,8 @@
     vector resourceVolumePosition;  // position of volume
 } CollectResourceCommand;
 
+struct CommandLayer;
+
 void ChangeSingleShipToCollectResource(struct CommandToDo *command);
 
 // returns TRUE if resource is already being targeted for harvesting
diff -urPw homeworld-orig/src/Game/ResearchAPI.c homeworld_sdl-0.3/src/Game/ResearchAPI.c
--- homeworld-orig/src/Game/ResearchAPI.c	2002-09-04 12:46:16.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/ResearchAPI.c	2004-08-01 22:35:19.000000000 -0700
@@ -8,30 +8,30 @@
 
 #include <stdio.h>
 
-#include "types.h"
-#include "shipdefs.h"
-#include "objtypes.h"
-#include "researchapi.h"
-#include "universe.h"
-#include "statscript.h"
-#include "researchGUI.h"
-#include "strings.h"
-#include "linkedlist.h"
-#include "soundevent.h"
-
-#include "fereg.h"
-#include "region.h"
-#include "trademgr.h"
-
-#include "multiplayergame.h"
-#include "consmgr.h"
-
-#define makeSPR1TechEntry(var) {"SPR1" #var, scriptSetSdwordCB, &SinglePlayerR1TechStatic.TimeToComplete[##var]}
-#define makeSPR2TechEntry(var) {"SPR2" #var, scriptSetSdwordCB, &SinglePlayerR2TechStatic.TimeToComplete[##var]}
-#define makeMPR1TechEntry(var) {"MPR1" #var, scriptSetSdwordCB, &MultiPlayerR1TechStatic.TimeToComplete[##var]}
-#define makeMPR2TechEntry(var) {"MPR2" #var, scriptSetSdwordCB, &MultiPlayerR2TechStatic.TimeToComplete[##var]}
-#define makeMPCR1TechEntry(var) {"MPCR1" #var, scriptSetSdwordCB, &MultiPlayerCR1TechStatic.TimeToComplete[##var]}
-#define makeMPCR2TechEntry(var) {"MPCR2" #var, scriptSetSdwordCB, &MultiPlayerCR2TechStatic.TimeToComplete[##var]}
+#include "Types.h"
+#include "ShipDefs.h"
+#include "ObjTypes.h"
+#include "ResearchAPI.h"
+#include "Universe.h"
+#include "StatScript.h"
+#include "ResearchGUI.h"
+#include "Strings.h"
+#include "LinkedList.h"
+#include "SoundEvent.h"
+
+#include "FEReg.h"
+#include "Region.h"
+#include "TradeMgr.h"
+
+#include "MultiplayerGame.h"
+#include "ConsMgr.h"
+
+#define makeSPR1TechEntry(var) {"SPR1" #var, scriptSetSdwordCB, &SinglePlayerR1TechStatic.TimeToComplete[var]}
+#define makeSPR2TechEntry(var) {"SPR2" #var, scriptSetSdwordCB, &SinglePlayerR2TechStatic.TimeToComplete[var]}
+#define makeMPR1TechEntry(var) {"MPR1" #var, scriptSetSdwordCB, &MultiPlayerR1TechStatic.TimeToComplete[var]}
+#define makeMPR2TechEntry(var) {"MPR2" #var, scriptSetSdwordCB, &MultiPlayerR2TechStatic.TimeToComplete[var]}
+#define makeMPCR1TechEntry(var) {"MPCR1" #var, scriptSetSdwordCB, &MultiPlayerCR1TechStatic.TimeToComplete[var]}
+#define makeMPCR2TechEntry(var) {"MPCR2" #var, scriptSetSdwordCB, &MultiPlayerCR2TechStatic.TimeToComplete[var]}
 
 /*=============================================================================
     Data:
@@ -677,7 +677,7 @@
 
 udword rmTechRequiredForTech(Player *player, TechnologyType type)
 {
-    sdword i, numtech=0;
+    sdword i;
     udword techdepend, temp;
 
     temp=player->researchinfo.techstat->TechNeededToResearch[type];
@@ -704,7 +704,7 @@
 -----------------------------------------------------------------------*/
 udword rmAllTechRequiredforTech(Player *player, TechnologyType type)
 {
-    udword i, numtech=0;
+    udword i;
     udword techdepend,temp;
 
     techdepend = temp = player->researchinfo.techstat->TechNeededToResearch[type];
@@ -731,7 +731,7 @@
 -----------------------------------------------------------------------*/
 udword rmAllTechRequredForShip(Player *player, ShipType type)
 {
-    sdword i, numtech=0;
+    sdword i;
     udword techneeded, temp;
 
     temp = player->researchinfo.techstat->TechNeededToBuildShip[type];
@@ -796,7 +796,6 @@
 ----------------------------------------------------------------------------*/
 bool rmResearchTechForShip(struct Player *player, ShipType type)
 {
-    udword techforship = player->researchinfo.techstat->TechNeededToBuildShip[type];
     udword numtech, techneeded;
     sdword freelab;
     sdword techtoresearch = -1;
diff -urPw homeworld-orig/src/Game/ResearchAPI.h homeworld_sdl-0.3/src/Game/ResearchAPI.h
--- homeworld-orig/src/Game/ResearchAPI.h	2002-09-04 12:46:16.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/ResearchAPI.h	2004-08-01 22:35:20.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___RESEARCHAPI_H
 #define ___RESEARCHAPI_H
 
-#include "types.h"
-#include "region.h"
+#include "Types.h"
+#include "Region.h"
 
 /*=============================================================================
     Definitions:
diff -urPw homeworld-orig/src/Game/ResearchGUI.c homeworld_sdl-0.3/src/Game/ResearchGUI.c
--- homeworld-orig/src/Game/ResearchGUI.c	2002-09-04 12:46:18.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/ResearchGUI.c	2004-08-01 22:35:30.000000000 -0700
@@ -7,48 +7,50 @@
 =============================================================================*/
 
 #ifndef SW_Render
+#ifdef _WIN32
 #include <windows.h>
 #endif
+#endif
 #include <stdio.h>
 #include <math.h>
 #include "glinc.h"
 #include "main.h"
-#include "types.h"
-#include "universe.h"
-#include "region.h"
-#include "uicontrols.h"
-#include "feflow.h"
+#include "Types.h"
+#include "Universe.h"
+#include "Region.h"
+#include "UIControls.h"
+#include "FEFlow.h"
 #include "font.h"
-#include "fontreg.h"
-#include "objtypes.h"
+#include "FontReg.h"
+#include "ObjTypes.h"
 #include "texreg.h"
-#include "task.h"
+#include "Task.h"
 #include "mouse.h"
 #include "CommandLayer.h"
-#include "piePlate.h"
-#include "globals.h"
+#include "PiePlate.h"
+#include "Globals.h"
 #include "CommandWrap.h"
-#include "scroller.h"
-#include "soundevent.h"
-#include "randy.h"
+#include "Scroller.h"
+#include "SoundEvent.h"
+#include "Randy.h"
 #include "mainrgn.h"
-#include "shipdefs.h"
+#include "ShipDefs.h"
 #include "prim2d.h"
-#include "researchapi.h"
-#include "researchgui.h"
-#include "strings.h"
-#include "fereg.h"
-#include "taskbar.h"
+#include "ResearchAPI.h"
+#include "ResearchGUI.h"
+#include "Strings.h"
+#include "FEReg.h"
+#include "TaskBar.h"
 #include "render.h"
 #include "fixed.h"
-#include "singleplayer.h"
-#include "tutor.h"
-#include "trademgr.h"
-#include "multiplayergame.h"
+#include "SinglePlayer.h"
+#include "Tutor.h"
+#include "TradeMgr.h"
+#include "MultiplayerGame.h"
 #include "FEColour.h"
 #include "glcompat.h"
 #include "InfoOverlay.h"
-#include "commandnetwork.h"
+#include "CommandNetwork.h"
 
 /*=============================================================================
     Defines:
@@ -304,9 +306,14 @@
 
 char* TechImagePaths[]=
 {
-    {"ResearchGUI\\Race1\\" },
-    {"ResearchGUI\\Race2\\" },
-    {NULL                   }
+#ifdef _WIN32
+    "ResearchGUI\\Race1\\",
+    "ResearchGUI\\Race2\\",
+#else
+    "ResearchGUI/Race1/",
+    "ResearchGUI/Race2/",
+#endif
+    NULL
 };
 
 TechPrintList *PlayerTechList;
@@ -784,7 +791,6 @@
     rectangle rect, progressRect;
     real32 percent, width;
     sdword pos;
-    sdword labid = labprint->labid - 1; // zero based
     PlayerResearchInfo *research = &universe.curPlayerPtr->researchinfo;
 
     rect.x0 = region->rect.x0 + RM_LAB_INSET;
@@ -1718,7 +1724,6 @@
     char      filename[128];
     sdword    index, lru;
     real32    time=(real32)1.0e22;
-    bool      loaded=FALSE;
     rectangle textureRect;
 
     rmTechImageRegion = region;
@@ -2084,7 +2089,7 @@
     PlayerResearchInfo *research=&universe.curPlayerPtr->researchinfo;
     TechnologyType tech;
     sdword index, mask, hastech, canprint=STAT_CANTPRINT;
-    sdword lastHeading = 0, count=0;
+    sdword count=0;
 //    ubyte *data=NULL;
 
     for (index=0;PlayerTechList[index].itemtype!=ITEM_ENDLIST; index++)
diff -urPw homeworld-orig/src/Game/ResearchGUI.h homeworld_sdl-0.3/src/Game/ResearchGUI.h
--- homeworld-orig/src/Game/ResearchGUI.h	2002-09-04 12:46:18.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/ResearchGUI.h	2004-08-01 22:35:30.000000000 -0700
@@ -9,16 +9,20 @@
 #ifndef ___RESEARCHGUI_H
 #define ___RESEARCHGUI_H
 
-#include "types.h"
-#include "region.h"
+#include "Types.h"
+#include "Region.h"
 #include "texreg.h"
-#include "researchapi.h"
+#include "ResearchAPI.h"
 
 /*=============================================================================
     Definitions:
 =============================================================================*/
 
+#ifdef _WIN32
 #define RM_FIBFile          "FEMan\\Research_Manager.fib"
+#else
+#define RM_FIBFile          "FEMan/Research_Manager.fib"
+#endif
 #define RM_ResearchScreen   "Research_Manager"
 #define RM_DefaultFont      "default.hff"
 #define RM_FontNameLength   64
diff -urPw homeworld-orig/src/Game/SaveGame.c homeworld_sdl-0.3/src/Game/SaveGame.c
--- homeworld-orig/src/Game/SaveGame.c	2002-09-04 12:46:18.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/SaveGame.c	2004-08-01 22:35:35.000000000 -0700
@@ -7,39 +7,40 @@
 =============================================================================*/
 
 #include <string.h>
-#include "types.h"
+#include <limits.h>
+#include "Types.h"
 #include "LinkedList.h"
-#include "spaceobj.h"
-#include "blobs.h"
-#include "shipselect.h"
-#include "universe.h"
-#include "univupdate.h"
-#include "singleplayer.h"
-#include "file.h"
+#include "SpaceObj.h"
+#include "Blobs.h"
+#include "ShipSelect.h"
+#include "Universe.h"
+#include "UnivUpdate.h"
+#include "SinglePlayer.h"
+#include "File.h"
 #include "CameraCommand.h"
-#include "clouds.h"
+#include "Clouds.h"
 #include "Star3d.h"
 #include "SalCapCorvette.h"
-#include "tactics.h"
-#include "consMgr.h"
+#include "Tactics.h"
+#include "ConsMgr.h"
 #include "AIPlayer.h"
 #include "SaveGame.h"
 #include "Objectives.h"
 #include "utility.h"
-#include "levelload.h"
-#include "damage.h"
-#include "tutor.h"
+#include "LevelLoad.h"
+#include "Damage.h"
+#include "Tutor.h"
 #include "TradeMgr.h"
-#include "ping.h"
-#include "teams.h"
-#include "btg.h"
+#include "Ping.h"
+#include "Teams.h"
+#include "BTG.h"
 #include "light.h"
-#include "commandwrap.h"
-#include "strings.h"
-#include "sensors.h"
-#include "randy.h"
-#include "soundevent.h"
-#include "multiplayergame.h"
+#include "CommandWrap.h"
+#include "Strings.h"
+#include "Sensors.h"
+#include "Randy.h"
+#include "SoundEvent.h"
+#include "MultiplayerGame.h"
 
 void SaveConsMgr();
 void LoadConsMgr();
@@ -464,9 +465,11 @@
 {
     Load_StringToAddress(lightCurrentLighting);
 
-    if (strlen(lightCurrentLighting) > 1)
+    if (lightCurrentLighting[0])
     {
-        lightParseHSF(lightCurrentLighting);
+        char tmp_path[PATH_MAX];
+        strcpy(tmp_path, lightCurrentLighting);
+        lightParseHSF(tmp_path);
     }
     else
     {
@@ -599,7 +602,7 @@
 {
     sdword i;
 
-    savefile = fileOpen(filename,FF_WriteMode|FF_ReturnNULLOnFail);
+    savefile = fileOpen(filename, FF_WriteMode | FF_ReturnNULLOnFail | FF_UserSettingsPath);
     if (savefile == NULL)
     {
         return FALSE;
@@ -684,7 +687,7 @@
 {
     sdword verify;
 
-    savefile = fileOpen(filename,FF_ReturnNULLOnFail);
+    savefile = fileOpen(filename, FF_ReturnNULLOnFail | FF_UserSettingsPath);
     if (savefile == NULL)
     {
         return VERIFYSAVEFILE_ERROROPENING;
@@ -711,7 +714,7 @@
 {
     sdword verify;
 
-    savefile = fileOpen(filename,0);
+    savefile = fileOpen(filename, FF_UserSettingsPath);
     verify = LoadVersionInfo();
     if (verify != VERIFYSAVEFILE_OK)
     {
@@ -1090,7 +1093,7 @@
 
     for (i=0;i<multipleAttackTargets->numAttackTargets;i++)
     {
-        savecontents->TargetPtr[i] = (sdword)SpaceObjRegistryGetID((SpaceObj *)multipleAttackTargets->TargetPtr[i]);
+        savecontents->TargetPtr[i] = (TargetPtr)SpaceObjRegistryGetID((SpaceObj *)multipleAttackTargets->TargetPtr[i]);
     }
 
     SaveThisChunk(chunk);
@@ -1198,7 +1201,7 @@
         }
         else
         {
-            savecontents->dockpoints[i].dockstaticpoint = savecontents->dockpoints[i].dockstaticpoint->dockindex;
+            savecontents->dockpoints[i].dockstaticpoint = (DockStaticPoint*)savecontents->dockpoints[i].dockstaticpoint->dockindex;
         }
     }
 
@@ -2642,6 +2645,8 @@
             dbgAssert(FALSE);
             return NULL;
     }
+
+	return NULL;
 }
 
 typedef struct SaveLLSpaceObj {
@@ -3643,7 +3648,7 @@
     while (cur < num)
     {
         insideShip = memAlloc(sizeof(InsideShip),"InsideShip",0);
-        insideShip->ship = loadcontents->ID[cur++];
+        insideShip->ship = (Ship*)loadcontents->ID[cur++];
         if (insideShip->ship != -1)
         {
             listAddNode(list,&insideShip->node,insideShip);
diff -urPw homeworld-orig/src/Game/SaveGame.h homeworld_sdl-0.3/src/Game/SaveGame.h
--- homeworld-orig/src/Game/SaveGame.h	2002-09-04 12:46:18.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/SaveGame.h	2004-08-01 22:35:35.000000000 -0700
@@ -6,11 +6,14 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "spaceobj.h"
-#include "shipselect.h"
-
-#define SAVE_VERSION_NUMBER             0x10ad0027
+#include "Types.h"
+#include "SpaceObj.h"
+#include "ShipSelect.h"
+
+/* Save game version for original Homeworld. */
+/*#define SAVE_VERSION_NUMBER             0x10ad0027*/
+/* Save game version for Homeworld SDL. */
+#define SAVE_VERSION_NUMBER             0x10ad0028
 
 #define BASIC_STRUCTURE                 0x80000000
 #define VARIABLE_STRUCTURE              0x40000000
@@ -73,12 +76,12 @@
 
 #define VerifyChunk(c,t,s)              \
     dbgAssert(c);                       \
-    dbgAssert(c->type == t);            \
-    dbgAssert(c->contentsSize == s)
+    dbgAssert((c)->type == (t));        \
+    dbgAssert((c)->contentsSize == (s))
 
 #define VerifyChunkNoSize(c,t)          \
     dbgAssert(c);                       \
-    dbgAssert(c->type == t);
+    dbgAssert((c)->type == (t));
 
 bool SaveGame(char *filename);
 void LoadGame(char *filename);
diff -urPw homeworld-orig/src/Game/ScenPick.c homeworld_sdl-0.3/src/Game/ScenPick.c
--- homeworld-orig/src/Game/ScenPick.c	2002-09-04 12:46:18.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/ScenPick.c	2004-08-01 22:35:27.000000000 -0700
@@ -6,30 +6,43 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
+#ifdef _WIN32
+    #include <io.h>
+#else
+    #include <sys/stat.h>
+    #include <dirent.h>
+#endif
+
 #include <stdlib.h>
 #include <string.h>
-#include <io.h>
-#include "types.h"
-#include "debug.h"
-#include "file.h"
-#include "memory.h"
-#include "feflow.h"
+#include <strings.h>
+#include <ctype.h>
+#include <limits.h>
+#include "Types.h"
+#include "Debug.h"
+#include "File.h"
+#include "Memory.h"
+#include "FEFlow.h"
 #include "utility.h"
 #include "font.h"
-#include "fontreg.h"
+#include "FontReg.h"
 #include "prim2d.h"
 #include "mouse.h"
-#include "scroller.h"
+#include "Scroller.h"
 #include "ScenPick.h"
 #include "texreg.h"
 #include "render.h"
-#include "bmp.h"
-#include "multiplayergame.h"
+#include "BMP.h"
+#include "MultiplayerGame.h"
 #include "FEColour.h"
-#include "statscript.h"
-#include "subtitle.h"
+#include "StatScript.h"
+#include "Subtitle.h"
 #include "glcompat.h"
-#include "strings.h"
+#include "Strings.h"
+
+#ifdef _MSC_VER
+    #define strcasecmp _stricmp
+#endif
 
 /*=============================================================================
     Data:
@@ -60,7 +73,11 @@
 listwindowhandle spScenarioListWindow = NULL;
 //regionhandle     spScenarioBitmapWindow = NULL;
 
+#ifdef _WIN32
 char *ScenarioImagePath = "MultiPlayer\\";
+#else
+char *ScenarioImagePath = "MultiPlayer/";
+#endif
 
 lifheader *scenarioImage;
 udword scenarioTexture = TR_InvalidInternalHandle;
@@ -188,6 +205,7 @@
     fonthandle fhSave;
     char scenarioName[128];
     bool useDisplayName = FALSE;
+    unsigned int i;
 
     rectangle *r = &region->rect;
 
@@ -215,7 +233,7 @@
         memStrncpy(scenarioName, tpGameCreated.DisplayMapName, 127);
     else
         memStrncpy(scenarioName, spScenarios[spCurrentSelected].title, 127);
-    _strupr(scenarioName);
+    for (i = 0; (scenarioName[i] = toupper(scenarioName[i])); i++) { }
     fontPrintf(r->x0, r->y0, FEC_ListItemSelected, scenarioName);
     fontMakeCurrent(fhSave);
 }
@@ -229,13 +247,17 @@
 ----------------------------------------------------------------------------*/
 char *spTitleFind(char *directory, char *fileName)
 {
-    char string[256], fullName[_MAX_PATH];
+    char string[256], fullName[PATH_MAX];
     filehandle handle;
     sdword status;
 
-    memStrncpy(fullName, directory, _MAX_PATH - 1);
+    memStrncpy(fullName, directory, PATH_MAX - 1);
     strcat(fullName, fileName);
+#ifdef _WIN32
     strcat(fullName,"\\");
+#else
+    strcat(fullName,"/");
+#endif
     strcat(fullName, fileName);
     strcat(fullName,".level");
     handle = fileOpen(fullName, FF_TextMode|FF_ReturnNULLOnFail);
@@ -285,7 +307,7 @@
     spscenario *scenario1 = (spscenario *)arg1;
     spscenario *scenario2 = (spscenario *)arg2;
 
-    result = _stricmp(scenario1->title,scenario2->title);
+    result = strcasecmp(scenario1->title,scenario2->title);
     return result;
 }
 
@@ -323,18 +345,26 @@
 void spTitleListLoad(void)
 {
 #if !(defined(CGW) || defined (Downloadable) || defined(DLPublicBeta) || defined(OEM))
+#ifdef _WIN32
     struct _finddata_t find;
     sdword handle, startHandle;
+#else
+    DIR* dp;
+    struct dirent* dir_entry;
+#endif
 #endif
     sdword index, numplayers;
-    char fileName[_MAX_PATH], nameBuffer[_MAX_PATH];
+    char fileName[PATH_MAX], nameBuffer[PATH_MAX];
 #if MAIN_Password
-    char upperNameBuffer[_MAX_PATH];
+    char upperNameBuffer[PATH_MAX];
 #endif
-    char bitmapfileName[_MAX_PATH];
+    char bitmapfileName[PATH_MAX];
     char *pString;
     char *title;
     filehandle scriptFile;
+#if MAIN_Password
+    unsigned int i;
+#endif
 
 #if defined(CGW) || defined(Downloadable) || defined(DLPublicBeta)
     scriptFile = fileOpen("DemoMissions.script", FF_TextMode);
@@ -344,7 +374,7 @@
 #endif
     dbgAssert(scriptFile != 0);
 
-    while (fileLineRead(scriptFile, nameBuffer, _MAX_PATH) != FR_EndOfFile)
+    while (fileLineRead(scriptFile, nameBuffer, PATH_MAX) != FR_EndOfFile)
     {
         if (nameBuffer[0] == ';' || (nameBuffer[0] == '/' && nameBuffer[1] == '/'))
         {
@@ -355,8 +385,8 @@
         {                                                   //search for a numeral character
             if (strchr("0123456789", *pString) != NULL)
             {                                               //if this is a numeral
-                numplayers = atoi(pString);
-                memset(fileName, 0, _MAX_PATH);
+				sscanf( pString, "%d", &numplayers );
+                memset(fileName, 0, PATH_MAX);
                 memStrncpy(fileName, nameBuffer, pString - nameBuffer + 1);//copy the start of the string
                 memStrncpy(bitmapfileName, nameBuffer, pString - nameBuffer + 1);//copy the start of the string
                 strcat(fileName, "%d");                     //make something like:
@@ -369,7 +399,11 @@
             goto alreadyLoaded;
         }
 
+#ifdef _WIN32
         title = spTitleFind("MultiPlayer\\", nameBuffer);
+#else
+        title = spTitleFind("MultiPlayer/", nameBuffer);
+#endif
         if (title == NULL)
         {
             goto alreadyLoaded;                             //break-continue
@@ -377,8 +411,7 @@
 #if MAIN_Password
         if (!mainEnableSpecialMissions)
         {                                                   //if this is an "off-limits" mission
-            strcpy(upperNameBuffer, title);
-            _strupr(upperNameBuffer);
+            for (i = 0; (upperNameBuffer[i] = toupper(title[i])); i++) { }
             if (strstr(upperNameBuffer, "ALL"))
             {
                 memFree(title);
@@ -389,7 +422,7 @@
 
         for (index = 0; index < spNumberScenarios; index++)
         {
-            if (!_stricmp(spScenarios[index].fileSpec, fileName))
+            if (!strcasecmp(spScenarios[index].fileSpec, fileName))
             {                                               //if matching file specs,
                 // matches, but we should update max number of player if necessary
                 if (numplayers > spScenarios[index].maxplayers) spScenarios[index].maxplayers = numplayers;
@@ -417,6 +450,7 @@
     fileClose(scriptFile);
 
 #if !(defined(CGW) || defined (Downloadable) || defined(DLPublicBeta) || defined(OEM))
+#ifdef _WIN32
     startHandle = handle = _findfirst(filePathPrepend("MultiPlayer\\*.", 0), &find);
 
     while (handle != -1)
@@ -431,8 +465,8 @@
         {                                                   //search for a numeral character
             if (strchr("0123456789", *pString) != NULL)
             {                                               //if this is a numeral
-                numplayers = atoi(pString);
-                memset(fileName, 0, _MAX_PATH);
+				sscanf( pString, "%d", &numplayers );
+                memset(fileName, 0, PATH_MAX);
                 strncpy(fileName, find.name, pString - find.name);//copy the start of the string
                 memStrncpy(bitmapfileName, find.name, pString - find.name + 1);//copy the start of the string
                 strcat(fileName, "%d");                     //make something like:
@@ -457,8 +491,7 @@
 #if MAIN_Password
         if (!mainEnableSpecialMissions)
         {                                                   //if this is an "off-limits" mission
-            strcpy(upperNameBuffer, title);
-            _strupr(upperNameBuffer);
+            for (i = 0; (upperNameBuffer[i] = toupper(title[i])); i++) { }
             if (strstr(upperNameBuffer, "ALL"))
             {
                 memFree(title);
@@ -469,7 +502,7 @@
 
         for (index = 0; index < spNumberScenarios; index++)
         {
-            if (!_stricmp(spScenarios[index].fileSpec, fileName))
+            if (!strcasecmp(spScenarios[index].fileSpec, fileName))
             {                                               //if matching file specs,
                 // matches, but we should update max number of player if necessary
                 if (numplayers > spScenarios[index].maxplayers) spScenarios[index].maxplayers = numplayers;
@@ -495,6 +528,82 @@
 alreadyLoadedFromFileSystem:;
         handle = _findnext(startHandle, &find);
     }
+#else   /* File search, not _WIN32... */
+    dp = opendir(filePathPrepend("MultiPlayer", 0));
+
+    if (dp)
+    {
+        while ((dir_entry = readdir(dp)))
+        {
+            if (dir_entry->d_name[0] == '.')
+                continue;
+
+            fileName[0] = 0;
+            numplayers = 0;
+            while ((pString = strpbrk(pString, "0123456789")))
+            {                                               /*search for a numeral character*/
+				sscanf( pString, "%d", &numplayers );
+                memset(fileName, 0, PATH_MAX);
+                strncpy(fileName, dir_entry->d_name,
+                    pString - dir_entry->d_name);           /*copy the start of the string*/
+                memStrncpy(bitmapfileName, dir_entry->d_name,
+                    pString - dir_entry->d_name + 1);       /*copy the start of the string*/
+                strcat(fileName, "%d");                     /*make something like:*/
+                strcat(fileName, pString + 1);              /*'StdGame%d.level'*/
+            }
+
+            if (numplayers == 0)
+                continue;
+
+            if (fileName[0] == '\0')
+                continue;
+
+            title = spTitleFind("MultiPlayer/", dir_entry->d_name);
+            if (title == NULL)
+                continue;
+#if MAIN_Password
+            if (!mainEnableSpecialMissions)
+            {                                               /*if this is an "off-limits" mission*/
+                for (i = 0; (upperNameBuffer[i] = toupper(title[i])); i++) { }
+                if (strstr(upperNameBuffer, "ALL"))
+                {
+                    memFree(title);
+                    continue;           /*break-continue*/
+                }
+            }
+#endif //MAIN_Password
+
+            for (index = 0; index < spNumberScenarios; index++)
+            {
+                if (strcasecmp(spScenarios[index].fileSpec, fileName))
+                    continue;
+
+                /* matches, but we should update max number of player if necessary */
+                if (numplayers > spScenarios[index].maxplayers) spScenarios[index].maxplayers = numplayers;
+                if (numplayers < spScenarios[index].minplayers) spScenarios[index].minplayers = numplayers;
+                memFree(title);
+                break;                         /*break-continue*/
+            }
+            if (index < spNumberScenarios)
+                continue;
+
+            if (spNumberScenarios >= spScenarioListLength)
+            {
+                spScenarioListLength += SP_ScenarioListGrowth;
+                spScenarios = memRealloc(spScenarios, spScenarioListLength * sizeof(spscenario), "spScenarios", NonVolatile);
+            }
+            dbgAssert(spNumberScenarios < spScenarioListLength);
+            spScenarios[spNumberScenarios].fileSpec = memStringDupe(fileName);
+            spScenarios[spNumberScenarios].bitmapfileSpec = memStringDupe(bitmapfileName);
+            spScenarios[spNumberScenarios].title = title;
+            spScenarios[spNumberScenarios].maxplayers = numplayers;
+            spScenarios[spNumberScenarios].minplayers = numplayers;
+            spNumberScenarios++;
+        }
+
+        closedir(dp);
+    }
+#endif   /* _WIN32 */
 #endif //defined(CGW) || defined (Downloadable) || defined(DLPublicBeta) || defined(OEM)
 
     dbgAssert(spNumberScenarios > 0);
@@ -769,7 +878,7 @@
 
     for (index = 0; index < spNumberScenarios; index++)
     {
-        if (stricmp(spScenarios[index].title,MapName)==0)
+        if (strcasecmp(spScenarios[index].title,MapName)==0)
         {
             spCurrentSelected = index;
             break;
@@ -807,7 +916,11 @@
 #endif
         if (!foundText)
         {
+#ifdef _WIN32
             sprintf(textFile, "%s%s%c\\description.txt", ScenarioImagePath, scenarioFile, '0' + i);
+#else
+            sprintf(textFile, "%s%s%c/description.txt", ScenarioImagePath, scenarioFile, '0' + i);
+#endif
             if (fileExists(textFile, 0))
             {                                               //see if there is a description text file in this directory
                 foundText = TRUE;
@@ -866,8 +979,8 @@
 ----------------------------------------------------------------------------*/
 void spNewItem(void)
 {
-    char bitmapFile[_MAX_PATH];
-    char descriptionFile[_MAX_PATH];
+    char bitmapFile[PATH_MAX];
+    char descriptionFile[PATH_MAX];
     char *chopBuffer;
     sdword scen;
     rectangle textureRect;
diff -urPw homeworld-orig/src/Game/ScenPick.h homeworld_sdl-0.3/src/Game/ScenPick.h
--- homeworld-orig/src/Game/ScenPick.h	2002-09-04 12:46:18.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/ScenPick.h	2004-08-01 22:35:27.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___SCENPICK_H
 #define ___SCENPICK_H           3.4444445f
 
-#include "types.h"
-#include "FeFlow.h"
+#include "Types.h"
+#include "FEFlow.h"
 
 /*=============================================================================
     Switches:
diff -urPw homeworld-orig/src/Game/Scroller.c homeworld_sdl-0.3/src/Game/Scroller.c
--- homeworld-orig/src/Game/Scroller.c	2002-09-04 12:46:18.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Scroller.c	2004-08-01 22:35:25.000000000 -0700
@@ -6,10 +6,10 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "UIcontrols.h"
+#include "UIControls.h"
 #include "prim2d.h"
 #include "mouse.h"
-#include "scroller.h"
+#include "Scroller.h"
 
 #ifdef khent
 #define SCROLL_DEBUG 0
diff -urPw homeworld-orig/src/Game/Scroller.h homeworld_sdl-0.3/src/Game/Scroller.h
--- homeworld-orig/src/Game/Scroller.h	2002-09-04 12:46:18.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Scroller.h	2004-08-01 22:35:25.000000000 -0700
@@ -9,7 +9,7 @@
 #define __SCROLLER_H
 
 #include "prim2d.h"
-#include "UIcontrols.h"
+#include "UIControls.h"
 
 #define widthOf(r) ((uword)(r.x1 - r.x0))
 #define heightOf(r) ((uword)(r.y1 - r.y0))
diff -urPw homeworld-orig/src/Game/Select.c homeworld_sdl-0.3/src/Game/Select.c
--- homeworld-orig/src/Game/Select.c	2002-09-04 12:46:18.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Select.c	2004-08-01 22:35:29.000000000 -0700
@@ -7,40 +7,42 @@
 =============================================================================*/
 
 #ifndef SW_Render
+#ifdef _WIN32
 #include <windows.h>
 #endif
+#endif
 #include <stdlib.h>
-#include "types.h"
-#include "spaceobj.h"
-#include "matrix.h"
-#include "vector.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "Matrix.h"
+#include "Vector.h"
 #include "prim2d.h"
 #include "font.h"
-#include "fontreg.h"
+#include "FontReg.h"
 #include "utility.h"
-#include "camera.h"
-#include "debug.h"
-#include "spaceobj.h"
-#include "universe.h"
-#include "cloakgenerator.h"
-#include "gravwellgenerator.h"
-#include "univupdate.h"
-#include "fastmath.h"
-#include "pieplate.h"
+#include "Camera.h"
+#include "Debug.h"
+#include "SpaceObj.h"
+#include "Universe.h"
+#include "CloakGenerator.h"
+#include "GravWellGenerator.h"
+#include "UnivUpdate.h"
+#include "FastMath.h"
+#include "PiePlate.h"
 #include "mouse.h"
 #include "glinc.h"
 #include "main.h"
 #include "InfoOverlay.h"
 #include "mainrgn.h"
 #include "render.h"
-#include "alliance.h"
-#include "sensors.h"
-#include "select.h"
-#include "salcapcorvette.h"
-#include "proximitysensor.h"
-#include "strings.h"
-#include "tweak.h"
-#include "tutor.h"
+#include "Alliance.h"
+#include "Sensors.h"
+#include "Select.h"
+#include "SalCapCorvette.h"
+#include "ProximitySensor.h"
+#include "Strings.h"
+#include "Tweak.h"
+#include "Tutor.h"
 #include "mainrgn.h"
 
 
@@ -572,8 +574,8 @@
                     p3 = primPointLineIntersection(xReal, yReal, point[pIndex[base + 3]].x, point[pIndex[base + 3]].y, point[pIndex[base + 0]].x, point[pIndex[base + 0]].y);
                     if (p0 > 0.0f && p1 > 0.0f && p2 > 0.0f && p3 > 0.0f)
                     {                                       //if point inside this poly
-                        distance = abs(primGLToScreenX(ship->collInfo.selCircleX) - x) +
-                            abs(primGLToScreenY(ship->collInfo.selCircleY) - y) +
+                        distance = ABS(primGLToScreenX(ship->collInfo.selCircleX) - x) +
+                            ABS(primGLToScreenY(ship->collInfo.selCircleY) - y) +
                             primGLToScreenScaleX(ship->collInfo.selCircleDepth);
                         if (distance < closestDistance)
                         {
@@ -595,8 +597,8 @@
                 if ((selectRect.x0 <= x) && (x <= selectRect.x1) &&
                     (selectRect.y0 <= y) && (y <= selectRect.y1))
                 {                                           //found a matching object, return
-                    distance = abs(primGLToScreenX(ship->collInfo.selCircleX) - x) +
-                        abs(primGLToScreenY(ship->collInfo.selCircleY) - y) +
+                    distance = ABS(primGLToScreenX(ship->collInfo.selCircleX) - x) +
+                        ABS(primGLToScreenY(ship->collInfo.selCircleY) - y) +
                             primGLToScreenScaleX(ship->collInfo.selCircleDepth);
                     if (distance < closestDistance)
                     {
@@ -660,8 +662,8 @@
             if ((selectRect.x0 <= x) && (x <= selectRect.x1) &&
                 (selectRect.y0 <= y) && (y <= selectRect.y1))
             {                                           //found a matching object, return
-                distance = abs(primGLToScreenX(((SpaceObjRotImpTarg *)object)->collInfo.selCircleX) - x) +
-                    abs(primGLToScreenY(((SpaceObjRotImpTarg *)object)->collInfo.selCircleY) - y);//manhattan distance
+                distance = ABS(primGLToScreenX(((SpaceObjRotImpTarg *)object)->collInfo.selCircleX) - x) +
+                    ABS(primGLToScreenY(((SpaceObjRotImpTarg *)object)->collInfo.selCircleY) - y);//manhattan distance
                 if (distance < closestDistance)
                 {
                     closestDistance = distance;
@@ -1061,8 +1063,8 @@
                 {                                       //if mouse inside this poly
                     if (target->collInfo.selCircleRadius > 0.0f)
                     {
-                        distance = abs(primGLToScreenX(target->collInfo.selCircleX) - mouseCursorX()) +
-                            abs(primGLToScreenY(target->collInfo.selCircleY) - mouseCursorY());
+                        distance = ABS(primGLToScreenX(target->collInfo.selCircleX) - mouseCursorX()) +
+                            ABS(primGLToScreenY(target->collInfo.selCircleY) - mouseCursorY());
                         selShipUnderMouse(target, distance);
                     }
                     break;
@@ -1081,8 +1083,8 @@
         if ((selectRect.x0 <= mouseCursorX()) && (mouseCursorX() <= selectRect.x1) &&
             (selectRect.y0 <= mouseCursorY()) && (mouseCursorY() <= selectRect.y1))
         {                                               //if under mouse
-            distance = abs(primGLToScreenX(collision->selCircleX) - mouseCursorX()) +
-                abs(primGLToScreenY(collision->selCircleY) - mouseCursorY());
+            distance = ABS(primGLToScreenX(collision->selCircleX) - mouseCursorX()) +
+                ABS(primGLToScreenY(collision->selCircleY) - mouseCursorY());
             selShipUnderMouse(target, distance);
 
         }
@@ -2110,7 +2112,6 @@
 {
     sdword index;
     Ship *ship;
-    vector zero = {0.0, 0.0, 0.0};
     fonthandle currentFont = fontCurrentGet();
     sdword currentLOD;
 
diff -urPw homeworld-orig/src/Game/Select.h homeworld_sdl-0.3/src/Game/Select.h
--- homeworld-orig/src/Game/Select.h	2002-09-04 12:46:18.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Select.h	2004-08-01 22:35:29.000000000 -0700
@@ -9,15 +9,15 @@
 #ifndef ___SELECT_H
 #define ___SELECT_H
 
-#include "types.h"
+#include "Types.h"
 #include "prim2d.h"
-#include "matrix.h"
-#include "spaceobj.h"
-#include "commandlayer.h"
-#include "camera.h"
+#include "Matrix.h"
+#include "SpaceObj.h"
+#include "CommandLayer.h"
+#include "Camera.h"
 #include "font.h"
 
-#include "pieplate.h"
+#include "PiePlate.h"
 
 /*=============================================================================
     Switches:
diff -urPw homeworld-orig/src/Game/Sensors.c homeworld_sdl-0.3/src/Game/Sensors.c
--- homeworld-orig/src/Game/Sensors.c	2002-09-04 12:46:18.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Sensors.c	2004-08-01 22:35:37.000000000 -0700
@@ -6,67 +6,70 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
+#ifdef _WIN32
 #define WIN32_LEAN_AND_MEAN
 #include <windows.h>
+#endif
+
 #include <math.h>
 #include <float.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include "glinc.h"
-#include "types.h"
-#include "debug.h"
-#include "memory.h"
+#include "Types.h"
+#include "Debug.h"
+#include "Memory.h"
 #include "prim2d.h"
 #include "prim3d.h"
 #include "mainrgn.h"
-#include "pieplate.h"
+#include "PiePlate.h"
 #include "utility.h"
 #include "font.h"
-#include "region.h"
-#include "feflow.h"
-#include "camera.h"
-#include "cameracommand.h"
-#include "vector.h"
-#include "vector.h"
-#include "universe.h"
-#include "univupdate.h"
+#include "Region.h"
+#include "FEFlow.h"
+#include "Camera.h"
+#include "CameraCommand.h"
+#include "Vector.h"
+#include "Vector.h"
+#include "Universe.h"
+#include "UnivUpdate.h"
 #include "render.h"
 #include "mouse.h"
-#include "select.h"
-#include "shipselect.h"
-#include "commandwrap.h"
-#include "teams.h"
-#include "taskbar.h"
-#include "soundevent.h"
-#include "blobs.h"
+#include "Select.h"
+#include "ShipSelect.h"
+#include "CommandWrap.h"
+#include "Teams.h"
+#include "TaskBar.h"
+#include "SoundEvent.h"
+#include "Blobs.h"
 #include "light.h"
-#include "fastmath.h"
-#include "nis.h"
-#include "sensors.h"
-#include "proximitysensor.h"
-#include "singleplayer.h"
-#include "probe.h"
-#include "strings.h"
+#include "FastMath.h"
+#include "NIS.h"
+#include "Sensors.h"
+#include "ProximitySensor.h"
+#include "SinglePlayer.h"
+#include "Probe.h"
+#include "Strings.h"
 #include "mainrgn.h"
 #include "main.h"
 #include "InfoOverlay.h"
-#include "alliance.h"
-#include "statscript.h"
-#include "ping.h"
-#include "tactical.h"
-#include "teams.h"
-#include "tutor.h"
-#include "multiplayergame.h"
-#include "bounties.h"
-#include "btg.h"
+#include "Alliance.h"
+#include "StatScript.h"
+#include "Ping.h"
+#include "Tactical.h"
+#include "Teams.h"
+#include "Tutor.h"
+#include "MultiplayerGame.h"
+#include "Bounties.h"
+#include "BTG.h"
 #include "glcaps.h"
-#include "subtitle.h"
+#include "Subtitle.h"
 #include "SaveGame.h"
-#include "randy.h"
-#include "transformer.h"
-#include "battle.h"
-#include "gravwellgenerator.h"
-#include "shader.h"
+#include "Randy.h"
+#include "Transformer.h"
+#include "Battle.h"
+#include "GravWellGenerator.h"
+#include "Shader.h"
 #include "devstats.h"
 
 //located in mainrg.c
@@ -74,6 +77,9 @@
 void toFieldSphereDraw(ShipPtr ship,real32 radius, real32 scale);
 
 
+void (*smHoldLeft)(void);
+void (*smHoldRight)(void);
+
 /*=============================================================================
     Data:
 =============================================================================*/
@@ -1620,11 +1626,11 @@
                 }
                 primPoint3(&obj->posinfo.position, c);
                 break;
-//            default:
+            default:
 //#ifndef DEBUG_COLLBLOBS
 //                dbgAssert(FALSE);       // don't assert if DEBUG_COLLBLOBS because debug collblobs can have bullets,etc.
 //#endif
-//                break;
+                break;
         }
 
 dontRenderThisResource:;
@@ -1722,8 +1728,8 @@
     vector planePoint = thisBlob->centre;
 
     planePoint.z = selCentrePoint.z;
-    return(abs(piePlanePoint.x - planePoint.x) +            //manhattan distance
-            abs(piePlanePoint.y - planePoint.y));
+    return(ABS(piePlanePoint.x - planePoint.x) +            //manhattan distance
+            ABS(piePlanePoint.y - planePoint.y));
 }
 
 /*-----------------------------------------------------------------------------
@@ -1781,7 +1787,7 @@
         thisBlob = smBlobSortList[blobIndex];
         closestSortDistance = min(closestSortDistance, thisBlob->cameraSortDistance);
         farthestSortDistance = max(farthestSortDistance, thisBlob->cameraSortDistance);
-        highestBlob = max(highestBlob, abs(thisBlob->centre.z));
+        highestBlob = max(highestBlob, ABS(thisBlob->centre.z));
         moveDistance = smBlobDropLineDistance(thisBlob);
         if (moveDistance < closestMoveDistance)
         {                                                   //closest blob to movement mechanism
@@ -1883,7 +1889,7 @@
 #endif
         if (mouseInRectGeneral(o.centreX - o.radiusX, o.centreY - o.radiusY, o.centreX + o.radiusX, o.centreY + o.radiusY))
         {                                                   //if inside bounding box of circle
-            distance = abs(o.centreX - mouseCursorX()) + abs(o.centreY - mouseCursorY());
+            distance = ABS(o.centreX - mouseCursorX()) + ABS(o.centreY - mouseCursorY());
             if (distance < closestDistance)
             {                                               //if closest yet
                 closestDistance = distance;
@@ -2065,7 +2071,7 @@
                 p1.x = thisBlob->centre.x;                  //draw from blob to move plane
                 p1.y = thisBlob->centre.y;
                 p1.z = piePlanePoint.z;
-                if (abs(p1.z - p0.z) >= smShortFootLength)
+                if (ABS(p1.z - p0.z) >= smShortFootLength)
                 {
                     primLine3(&p0, &p1, c);                     //draw line to plane
                     selCircleComputeGeneral(modelView, projection, &p1, smBlobCircleSize, &x, &y, &screenRadius);
@@ -2588,7 +2594,8 @@
                 fontPrint(x,
                           playerColorRect.y0, playerhasdroppedOutOrQuit ? HorseRaceDropoutColor : colWhite, "B: ");
                 bounty = getPlayerBountyRender(&universe.players[index]);
-                itoa(bounty,buffer,10);
+                /*itoa(bounty,buffer,10);*/
+                sprintf(buffer, "%d", bounty);
                 x += fontWidth("B: ");
 
                 fontPrint(x, playerColorRect.y0, playerhasdroppedOutOrQuit ? HorseRaceDropoutColor : colWhite, buffer);
@@ -2681,6 +2688,8 @@
                                 break;
                         }
                         break;
+                    default:
+                        break;
                 }
             }
         }
@@ -2715,6 +2724,8 @@
                         case OBJ_DerelictType:
                             cursorText = strGetString(strDerelictShip);
                             break;
+                        default:
+                            break;
                     }
                 }
             }
@@ -3046,7 +3057,7 @@
         }
         //perform cubic spline interpolation of the panned camera point
         vecSub(rememberVec, smCamera.lookatpoint, smCameraLookatPoint);
-        if (abs(rememberVec.x) + abs(rememberVec.y) + abs(rememberVec.z) > smPanEvalThreshold)
+        if (ABS(rememberVec.x) + ABS(rememberVec.y) + ABS(rememberVec.z) > smPanEvalThreshold)
         {                                                   //if there is any distance between pan point and camera point
             while (frameTicks)
             {
@@ -3191,8 +3202,8 @@
 ----------------------------------------------------------------------------*/
 void smSelectHold(void)
 {
-    if (abs(mouseCursorX() - mrOldMouseX) >= selClickBoxWidth ||
-        abs(mouseCursorY() - mrOldMouseY) >= selClickBoxHeight)
+    if (ABS(mouseCursorX() - mrOldMouseX) >= selClickBoxWidth ||
+        ABS(mouseCursorY() - mrOldMouseY) >= selClickBoxHeight)
     {                                                       //if mouse has moved from anchor point
         mrSelectRectBuild(&smSelectionRect, mrOldMouseX, mrOldMouseY);//create a selection rect
         selRectNone();
@@ -3246,7 +3257,7 @@
     smEyeEnd = smCamera.eyeposition;
     smLookEnd = smCamera.lookatpoint;
     smLookStart = centre;
-    vecSub(smEyeStart, smEyeEnd, smEyeEnd);
+    vecSub(smEyeStart, smLookEnd, smEyeEnd);
     vecNormalize(&smEyeStart);
     dbgAssert(smEyeStart.x < (real32)1e19 && smEyeStart.x > (real32)-1e19);
     vecMultiplyByScalar(smEyeStart, CAMERA_FOCUSFAR_DISTANCE);
@@ -3328,7 +3339,7 @@
                         invalid...in the probes case this could be often...very often   **/
                     /**  Done :)  **/
                     /** Hooray !! **/
-                    if (!(_isnan((double)destination.x) || _isnan((double)destination.x) || _isnan((double)destination.x)))
+                    if (!(isnan((double)destination.x) || isnan((double)destination.x) || isnan((double)destination.x)))
                     {
                         if(mrNeedProbeHack())
                         {   //looks like we need a little probe hacksy poo here too
@@ -3393,8 +3404,8 @@
             {
                 Ship *clickedOn = NULL;
 
-                if (abs(mouseCursorX() - mrOldMouseX) < selClickBoxWidth &&
-                    abs(mouseCursorY() - mrOldMouseY) < selClickBoxHeight)
+                if (ABS(mouseCursorX() - mrOldMouseX) < selClickBoxWidth &&
+                    ABS(mouseCursorY() - mrOldMouseY) < selClickBoxHeight)
                 {                                           //if mouse has moved much
                     smSelectionRect.x0 = mouseCursorX() - smSelectionWidth / 2;
                     smSelectionRect.x1 = mouseCursorX() + smSelectionWidth / 2;
@@ -4234,7 +4245,7 @@
 
     //add any additional key messages the sensors manager will need
     regKeyChildAlloc(smViewportRegion, SHIFTKEY, RPE_KeyUp | RPE_KeyDown, smViewportProcess, 1, SHIFTKEY);
-//    regKeyChildAlloc(smViewportRegion, MKEY, RPE_KeyUp | RPE_KeyDown, smViewportProcess, 1, MKEY);
+    regKeyChildAlloc(smViewportRegion, MKEY, RPE_KeyUp | RPE_KeyDown, smViewportProcess, 1, MKEY);
     regKeyChildAlloc(smViewportRegion, FKEY, RPE_KeyUp | RPE_KeyDown, smViewportProcess, 1, FKEY);
     regKeyChildAlloc(smViewportRegion, MMOUSE_BUTTON, RPE_KeyUp | RPE_KeyDown, smViewportProcess, 1, MMOUSE_BUTTON);
 
diff -urPw homeworld-orig/src/Game/Sensors.h homeworld_sdl-0.3/src/Game/Sensors.h
--- homeworld-orig/src/Game/Sensors.h	2002-09-04 12:46:18.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Sensors.h	2004-08-01 22:35:16.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___SENSORS_H
 #define ___SENSORS_H
 
-#include "types.h"
-#include "feflow.h"
+#include "Types.h"
+#include "FEFlow.h"
 
 /*=============================================================================
     Switches:
@@ -261,8 +261,8 @@
 
 //logic handlers for main region
 void smNULL(void);
-void (*smHoldLeft)(void);
-void (*smHoldRight)(void);
+extern void (*smHoldLeft)(void);
+extern void (*smHoldRight)(void);
 
 /*=============================================================================
     Save Game stuff:
diff -urPw homeworld-orig/src/Game/Shader.c homeworld_sdl-0.3/src/Game/Shader.c
--- homeworld-orig/src/Game/Shader.c	2002-09-04 12:46:18.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Shader.c	2004-08-01 22:35:19.000000000 -0700
@@ -9,13 +9,13 @@
 #include "glinc.h"
 #include <math.h>
 #include <string.h>
-#include "shader.h"
-#include "clipper.h"
-#include "fastmath.h"
+#include "Shader.h"
+#include "Clipper.h"
+#include "FastMath.h"
 #include "light.h"
-#include "debug.h"
+#include "Debug.h"
 #include "render.h"
-#include "memory.h"
+#include "Memory.h"
 
 
 /*=============================================================================
@@ -258,6 +258,9 @@
 {
     sdword l;
 
+	// shStdBaseColor should be (62.xx, 57.xx, 68.xx)
+	// shBaseColor - (87.xx, 79.xx, 89.xx)
+
     shBaseColor[0] = shGlobalAmbient[0] * shMaterial.ambient[0];
     shBaseColor[1] = shGlobalAmbient[1] * shMaterial.ambient[1];
     shBaseColor[2] = shGlobalAmbient[2] * shMaterial.ambient[2];
@@ -824,7 +827,8 @@
     else if (specInd == 1)
     {
         vector vpInfNorm[2];
-        real32 alpha0, alpha1;
+        //real32 alpha0;
+        real32 alpha1;
         sdword l, c;
 
         memcpy(&vpInfNorm[0], shLight[0].position, sizeof(vector));
diff -urPw homeworld-orig/src/Game/Shader.h homeworld_sdl-0.3/src/Game/Shader.h
--- homeworld-orig/src/Game/Shader.h	2002-09-04 12:46:18.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Shader.h	2004-08-01 22:35:19.000000000 -0700
@@ -9,9 +9,9 @@
 #ifndef _SHADER_H
 #define _SHADER_H
 
-#include "types.h"
-#include "vector.h"
-#include "matrix.h"
+#include "Types.h"
+#include "Vector.h"
+#include "Matrix.h"
 #include "color.h"
 
 typedef struct
diff -urPw homeworld-orig/src/Game/ShipSelect.c homeworld_sdl-0.3/src/Game/ShipSelect.c
--- homeworld-orig/src/Game/ShipSelect.c	2002-09-04 12:46:18.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/ShipSelect.c	2004-08-01 22:35:27.000000000 -0700
@@ -7,17 +7,17 @@
 =============================================================================*/
 
 #include <string.h>
-#include "types.h"
-#include "spaceobj.h"
-#include "shipselect.h"
-#include "universe.h"
-#include "alliance.h"
-#include "attributes.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "ShipSelect.h"
+#include "Universe.h"
+#include "Alliance.h"
+#include "Attributes.h"
 #include "ProximitySensor.h"
 #include "SinglePlayer.h"
-#include "soundevent.h"
-#include "speechevent.h"
-#include "battle.h"
+#include "SoundEvent.h"
+#include "SpeechEvent.h"
+#include "Battle.h"
 
 /*-----------------------------------------------------------------------------
     Name        : AddSpaceObjToSelectionBeforeIndex
@@ -1767,7 +1767,7 @@
 SelectCommand *selectMergeTwoSelections(SelectCommand *selection1, SelectCommand *selection2, udword dealloc)
 {
     SelectCommand *new_selection;
-    udword num_ships = 0, i, j;
+    udword i, j;
 
     if (selection1 == NULL)
     {
@@ -1833,7 +1833,6 @@
         }
     }
 
-
     return new_selection;
 }
 
@@ -1988,7 +1987,7 @@
 
 bool MakeSelectionKamikazeCapable(SelectCommand *selection)
 {
-    sdword numShips = 0,i;
+    sdword i;
 
     for (i = 0; i < selection->numShips; )
     {
diff -urPw homeworld-orig/src/Game/ShipSelect.h homeworld_sdl-0.3/src/Game/ShipSelect.h
--- homeworld-orig/src/Game/ShipSelect.h	2002-09-04 12:46:18.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/ShipSelect.h	2004-08-01 22:35:27.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___SHIPSELECT_H
 #define ___SHIPSELECT_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Defines:
diff -urPw homeworld-orig/src/Game/ShipView.c homeworld_sdl-0.3/src/Game/ShipView.c
--- homeworld-orig/src/Game/ShipView.c	2002-09-04 12:46:18.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/ShipView.c	2004-08-01 22:35:23.000000000 -0700
@@ -6,34 +6,37 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
+#ifdef _WIN32
 #define WIN32_LEAN_AND_MEAN
 #include <windows.h>
+#endif
+
 #include <math.h>
 #include <string.h>
 #include <stdio.h>
 #include <float.h>
-#include "types.h"
-#include "objtypes.h"
-#include "strings.h"
-#include "shipview.h"
-#include "camera.h"
-#include "feflow.h"
-#include "fereg.h"
+#include "Types.h"
+#include "ObjTypes.h"
+#include "Strings.h"
+#include "ShipView.h"
+#include "Camera.h"
+#include "FEFlow.h"
+#include "FEReg.h"
 #include "glinc.h"
 #include "glcaps.h"
 #include "render.h"
-#include "universe.h"
+#include "Universe.h"
 #include "light.h"
 #include "mouse.h"
 #include "font.h"
-#include "fontreg.h"
-#include "soundevent.h"
-#include "consmgr.h"
-#include "options.h"
+#include "FontReg.h"
+#include "SoundEvent.h"
+#include "ConsMgr.h"
+#include "Options.h"
 #include "FEColour.h"
-#include "gun.h"
+#include "Gun.h"
 #include "glcompat.h"
-#include "probe.h"
+#include "Probe.h"
 
 /*=============================================================================
     Private Types:
@@ -75,8 +78,8 @@
 char svShipStatFontName[SV_FontNameLength] = SV_StatFont;
 
 
-//for printing numbers
-char buf[20];
+// storage for printing numbers and some strings relating to Ship statistics
+char buf[40];
 
 /*=============================================================================
     Data:
@@ -181,13 +184,13 @@
 
 */
 
-
 Camera svCamera;
 
 real32 svAngle = -150.0;
-real32 svDeclination = -20;
+real32 svDeclination   = -20.0;
 real32 svZoomOutScalar=1.1f;
 real32 svZoomInScalar=1.05f;
+
 scriptEntry ShipViewTweaks[] =
 {
     makeEntry(svAngle, scriptSetReal32CB),
@@ -614,11 +617,9 @@
     sdword x, y;
     keyindex key;
     char* keystring;
-    bool resetRender;
+    bool resetRender = FALSE;
     char    temp[100];
 
-    resetRender = FALSE;
-
     //test if we'll need a mesh callback from glcPageFlip later
     if (glcActive())
     {
@@ -719,12 +720,14 @@
             mouseCursorHide();
             mousePositionSet(svMouseCentreX, svMouseCentreY); // Reset position so it doesn't walk off region
         }
-        else
+        else // auto rotate ship model
         {
-            // Default rotation and return declination to normal
+            // continual 360 degree yaw rotation
+            svCamera.angle += DEG_TO_RAD(1);
+            
+            // collapse pitch to default declination
+            svCamera.declination += 0.02 * (DEG_TO_RAD(svDeclination) - svCamera.declination);
 
-            //uncomment for free rotation
-            //svCamera.angle += 0.001f*savecamMouseX;
             if (svMouseInside) mouseCursorShow();
         }
     }
@@ -1059,7 +1062,7 @@
 {
     rectangle *rect = &region->rect;
     fonthandle currentFont;
-    char maneuverability[100];
+    char maneuverability[100] = "";
     ShipStaticInfo *info = GetShipStaticInfoSafe(svShipType, universe.curPlayerPtr->race);
 
     svManeuverRegion = region;
diff -urPw homeworld-orig/src/Game/ShipView.h homeworld_sdl-0.3/src/Game/ShipView.h
--- homeworld-orig/src/Game/ShipView.h	2002-09-04 12:46:18.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/ShipView.h	2004-08-01 22:35:23.000000000 -0700
@@ -9,9 +9,9 @@
 #ifndef ___SHIPVIEW_H
 #define ___SHIPVIEW_H
 
-#include "objtypes.h"
-#include "region.h"
-#include "feflow.h"
+#include "ObjTypes.h"
+#include "Region.h"
+#include "FEFlow.h"
 
 /*=============================================================================
     Switches:
diff -urPw homeworld-orig/src/Game/SinglePlayer.c homeworld_sdl-0.3/src/Game/SinglePlayer.c
--- homeworld-orig/src/Game/SinglePlayer.c	2002-09-04 12:46:18.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/SinglePlayer.c	2004-08-01 22:35:21.000000000 -0700
@@ -2,81 +2,86 @@
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
+#include <strings.h>
 #include <ctype.h>
 #include <math.h>
-#include "bink.h"
-#include "types.h"
-#include "vector.h"
-#include "linkedlist.h"
-#include "objtypes.h"
-#include "spaceobj.h"
-#include "statscript.h"
+/*#include "bink.h"*/
+#include "Types.h"
+#include "Vector.h"
+#include "LinkedList.h"
+#include "ObjTypes.h"
+#include "SpaceObj.h"
+#include "StatScript.h"
 #include "font.h"
-#include "feflow.h"
-#include "universe.h"
-#include "univupdate.h"
-#include "physics.h"
-#include "singleplayer.h"
+#include "FEFlow.h"
+#include "Universe.h"
+#include "UnivUpdate.h"
+#include "Physics.h"
+#include "SinglePlayer.h"
 #include "DDDFrigate.h"
-#include "taskbar.h"
+#include "TaskBar.h"
 #include "utility.h"
 #include "mainrgn.h"
-#include "aitrack.h"
-#include "aiship.h"
-#include "levelload.h"
-#include "sensors.h"
-#include "nis.h"
+#include "AITrack.h"
+#include "AIShip.h"
+#include "LevelLoad.h"
+#include "Sensors.h"
+#include "NIS.h"
 #include "mouse.h"
-#include "select.h"
-#include "soundevent.h"
-#include "collision.h"
+#include "Select.h"
+#include "SoundEvent.h"
+#include "Collision.h"
 #include "ResearchShip.h"
 #include "InfoOverlay.h"
 #include "AIPlayer.h"
 #include "KAS.h"
-#include "hs.h"
+#include "HS.h"
 #include "AIVar.h"
 #include "Objectives.h"
 #include "ResearchGUI.h"
-#include "launchMgr.h"
-#include "trademgr.h"
-#include "file.h"
-#include "etg.h"
-#include "horserace.h"
-#include "attributes.h"
+#include "LaunchMgr.h"
+#include "TradeMgr.h"
+#include "File.h"
+#include "ETG.h"
+#include "HorseRace.h"
+#include "Attributes.h"
 #include "SaveGame.h"
-#include "damage.h"
+#include "Damage.h"
 #include "TradeMgr.h"
-#include "ping.h"
+#include "Ping.h"
 #include "Tutor.h"
-#include "randy.h"
-#include "..\\Generated\\mission01.h"
-#include "..\\Generated\\mission02.h"
-#include "..\\Generated\\mission03.h"
-#include "..\\Generated\\mission04.h"
+#include "Randy.h"
+#include "../Generated/Mission01.h"
+#include "../Generated/Mission02.h"
+#include "../Generated/Mission03.h"
+#include "../Generated/Mission04.h"
 #ifdef OEM
-#include "..\\Generated\\mission05_OEM.h"
+#include "../Generated/Mission05_OEM.h"
 #else
-#include "..\\Generated\\mission05.h"
-#include "..\\Generated\\mission06.h"
-#include "..\\Generated\\mission07.h"
-#include "..\\Generated\\mission08.h"
-#include "..\\Generated\\mission09.h"
-#include "..\\Generated\\mission10.h"
-#include "..\\Generated\\mission11.h"
-#include "..\\Generated\\mission12.h"
-#include "..\\Generated\\mission13.h"
-#include "..\\Generated\\mission14.h"
-#include "..\\Generated\\mission15.h"
-#include "..\\Generated\\mission16.h"
-#endif
-#include "..\\Generated\\tutorial1.h"
-#include "strings.h"
-#include "animatic.h"
-#include "gravwellgenerator.h"
-#include "commandwrap.h"
-#include "mothership.h"
-#include "alliance.h"
+#include "../Generated/Mission05.h"
+#include "../Generated/Mission06.h"
+#include "../Generated/Mission07.h"
+#include "../Generated/Mission08.h"
+#include "../Generated/Mission09.h"
+#include "../Generated/Mission10.h"
+#include "../Generated/Mission11.h"
+#include "../Generated/Mission12.h"
+#include "../Generated/Mission13.h"
+#include "../Generated/Mission14.h"
+#include "../Generated/Mission15.h"
+#include "../Generated/Mission16.h"
+#endif
+#include "../Generated/Tutorial1.h"
+#include "Strings.h"
+#include "Animatic.h"
+#include "GravWellGenerator.h"
+#include "CommandWrap.h"
+#include "Mothership.h"
+#include "Alliance.h"
+
+#ifdef _MSC_VER
+#define strcasecmp _stricmp
+#endif
 
 #define NUMBER_SINGLEPLAYER_MISSIONS 19
 
@@ -244,7 +249,6 @@
 };
 
 static sdword WarpToLevelEnabled();
-static void SetMissionStartEnemyRUs(char *directory,char *field,void *dataToFillIn);
 static void SetOnMissionCompleteInfo(char *directory,char *field,void *dataToFillIn);
 static void singlePlayerKasMissionStart(sdword missionnum);
 static void singlePlayerStartNis(char *nis, char *script, bool centre, hvector *positionAndAngle);
@@ -298,13 +302,21 @@
 #ifdef OEM
     if (mission == 5)
     {
+#ifdef _WIN32
         sprintf(spMissionsDir, "SinglePlayer\\Mission05_OEM\\");
+#else
+        sprintf(spMissionsDir, "SinglePlayer/Mission05_OEM/");
+#endif
         sprintf(spMissionsFile, "Mission05_OEM.mission");
         return;
     }
 #endif
 
+#ifdef _WIN32
     sprintf(spMissionsDir, "SinglePlayer\\Mission%02d\\", mission);
+#else
+    sprintf(spMissionsDir, "SinglePlayer/Mission%02d/", mission);
+#endif
     sprintf(spMissionsFile,"Mission%02d.mission", mission);
 }
 
@@ -608,7 +620,7 @@
                 SelectCommand selectone;
 //                if (!(ship->specialFlags & SPECIAL_SinglePlayerWithinHyperSpaceRange))
 //                {
-putinparade:
+//putinparade:
                     selectone.ShipPtr[0] = ship;
                     selectone.numShips = 1;
                     RemoveShipsFromDoingStuff(&universe.mainCommandLayer,&selectone);
@@ -834,7 +846,11 @@
     {
         feCallbackAddMultiple(spHyperspaceCallback);      //add in the callbacks
         feDrawCallbackAddMultiple(spHyperspaceDrawCallback);
+#ifdef _WIN32
         spHyperspaceRollCallHandle = feScreensLoad("FEMan\\Hyperspace_Roll_Call.fib");   //load in the screen
+#else
+        spHyperspaceRollCallHandle = feScreensLoad("FEMan/Hyperspace_Roll_Call.fib");   //load in the screen
+#endif
     }
 
     CalculateRollCall();
@@ -1528,6 +1544,7 @@
 noupdateonincomminghs:;
                 }
                 break;
+                    
             case HS_COLLAPSE_OUTOF:
                 if (ship->soundevent.hyperspaceHandle != SOUND_NOTINITED)
                 {
@@ -1555,15 +1572,20 @@
 noupdateHSMP:;
                 }
                 break;
+                    
             case HS_INACTIVE:
                 if (universe.totaltimeelapsed > shipSinglePlayerGameInfo->timeToHyperspace)
                 {
                     thisShipArrived = TRUE;
                 }
                 break;
+                    
             default:
                 hsUpdate(ship);
+                    break;
             }
+
+        default:
             break;
     }
 
@@ -2474,10 +2496,12 @@
                 }
                 else
                 {
+#if 0   /* Bink...the VOICES...MAKE IT STOP!#@$1 */
                     if (!binkDonePlaying)
                     {
                         break;
                     }
+#endif
 
                     // clear damage effects from ships
                     CleanupDamageEffects();
@@ -2561,6 +2585,9 @@
                 singlePlayerGameInfo.hyperspaceFails = FALSE;
             }
             break;
+            
+        default:
+            break;
     }
 }
 
@@ -2771,6 +2798,12 @@
 
 #define NUMBER_SINGLEPLAYER_NIS 12
 
+#ifdef _WIN32
+#define NIS_PATH "nis\\"
+#else
+#define NIS_PATH "nis/"
+#endif
+
 //Note: single player order has been changed.  The Previous mission 3
 //      where the player meets the traders and fights the Turanic raiders
 //      has been moved to mission 4.  Previous mission 4 (capture the
@@ -2782,40 +2815,40 @@
 //      is now Mission 15.  The only change this effects is the nislet names
 char *nisR1Names[NUMBER_SINGLEPLAYER_NIS][2] =
 {
-    { "nis\\n01r1.nis",    "nis\\n01r1.script" },
+    { NIS_PATH"n01r1.nis",    NIS_PATH"n01r1.script" },
 #if defined (Downloadable)
-    { "nis\\n02.nis",      "nis\\n02-demo.script" },
+    { NIS_PATH"n02.nis",      NIS_PATH"n02-demo.script" },
 #else
-    { "nis\\n02.nis",      "nis\\n02.script" },
+    { NIS_PATH"n02.nis",      NIS_PATH"n02.script" },
 #endif
-    { "nis\\n04.nis",      "nis\\n04.script" },
-    { "nis\\n03r1.nis",    "nis\\n03r1.script" },
-    { "nis\\n05r1.nis",    "nis\\n05r1.script" },
-    { "nis\\n06.nis",      "nis\\n06.script" },
-    { "nis\\n07.nis",      "nis\\n07.script" },
-    { "nis\\n08r1a.nis",   "nis\\n08r1a.script" },
-    { "nis\\n09.nis",      "nis\\n09.script" },
-    { "nis\\n10r1.nis",    "nis\\n10r1.script" },
-    { "nis\\n11r1.nis",    "nis\\n11r1.script" },
-    { "nis\\n12r1.nis",    "nis\\n12r1.script" },
+    { NIS_PATH"n04.nis",      NIS_PATH"n04.script" },
+    { NIS_PATH"n03r1.nis",    NIS_PATH"n03r1.script" },
+    { NIS_PATH"n05r1.nis",    NIS_PATH"n05r1.script" },
+    { NIS_PATH"n06.nis",      NIS_PATH"n06.script" },
+    { NIS_PATH"n07.nis",      NIS_PATH"n07.script" },
+    { NIS_PATH"n08r1a.nis",   NIS_PATH"n08r1a.script" },
+    { NIS_PATH"n09.nis",      NIS_PATH"n09.script" },
+    { NIS_PATH"n10r1.nis",    NIS_PATH"n10r1.script" },
+    { NIS_PATH"n11r1.nis",    NIS_PATH"n11r1.script" },
+    { NIS_PATH"n12r1.nis",    NIS_PATH"n12r1.script" },
 };
 char *singlePlayerNISName = NULL;
 
 //See note above regarding the weird NIS ordering
 char *nisR2Names[NUMBER_SINGLEPLAYER_NIS][2] =
 {
-    { "nis\\n01r2.nis",    "nis\\n01r2.script" },
-    { "nis\\n02.nis",      "nis\\n02.script" },
-    { "nis\\n04.nis",      "nis\\n04.script" },
-    { "nis\\n03r2.nis",    "nis\\n03r2.script" },
-    { "nis\\n05r2.nis",    "nis\\n05r2.script" },
-    { "nis\\n06.nis",      "nis\\n06.script" },
-    { "nis\\n07.nis",      "nis\\n07.script" },
-    { "nis\\n08r2a.nis",   "nis\\n08r2a.script" },
-    { "nis\\n09.nis",      "nis\\n09.script" },
-    { "nis\\n10r2.nis",    "nis\\n10r2.script" },
-    { "nis\\n11r2.nis",    "nis\\n11r2.script" },
-    { "nis\\n12r2.nis",    "nis\\n12r2.script" },
+    { NIS_PATH"n01r2.nis",    NIS_PATH"n01r2.script" },
+    { NIS_PATH"n02.nis",      NIS_PATH"n02.script" },
+    { NIS_PATH"n04.nis",      NIS_PATH"n04.script" },
+    { NIS_PATH"n03r2.nis",    NIS_PATH"n03r2.script" },
+    { NIS_PATH"n05r2.nis",    NIS_PATH"n05r2.script" },
+    { NIS_PATH"n06.nis",      NIS_PATH"n06.script" },
+    { NIS_PATH"n07.nis",      NIS_PATH"n07.script" },
+    { NIS_PATH"n08r2a.nis",   NIS_PATH"n08r2a.script" },
+    { NIS_PATH"n09.nis",      NIS_PATH"n09.script" },
+    { NIS_PATH"n10r2.nis",    NIS_PATH"n10r2.script" },
+    { NIS_PATH"n11r2.nis",    NIS_PATH"n11r2.script" },
+    { NIS_PATH"n12r2.nis",    NIS_PATH"n12r2.script" },
 };
 
 #define NISLETS_PER_LEVEL       3
@@ -2831,21 +2864,21 @@
 nisletnames nisletNames[NUMBER_SINGLEPLAYER_MISSIONS] =
 {
     {{NULL, NULL, NULL},                     {FALSE,FALSE,FALSE}},
-    {{"nis\\m02a", NULL, NULL},              {FALSE,FALSE,FALSE}},
+    {{NIS_PATH"m02a", NULL, NULL},                    {FALSE,FALSE,FALSE}},
     {{NULL, NULL, NULL},                     {FALSE,FALSE,FALSE}},
-    {{"nis\\m03", NULL, NULL},               {FALSE,FALSE,FALSE}},
+    {{NIS_PATH"m03", NULL, NULL},                     {FALSE,FALSE,FALSE}},
     {{NULL, NULL, NULL},                     {FALSE,FALSE,FALSE}},
-    {{"nis\\m06a", NULL, NULL},              {FALSE,FALSE,FALSE}},
-    {{"nis\\m07a", NULL, NULL},              {FALSE,FALSE,FALSE}},
-    {{"nis\\m08a", NULL, NULL},              {FALSE,FALSE,FALSE}},
-    {{"nis\\m09a", "nis\\m09b", "nis\\m06a"},{FALSE,FALSE,FALSE}},
-    {{"nis\\m10a", NULL, NULL},              {FALSE,FALSE,FALSE}},
-    {{"nis\\m11a", NULL, NULL},              {FALSE,FALSE,FALSE}},
-    {{"nis\\m12a", "nis\\m12b", NULL},       {FALSE,TRUE, FALSE}},
-    {{"nis\\m13a", NULL, "nis\\m13c"},       {FALSE,FALSE,TRUE }},
-    {{"nis\\m15a", "nis\\m15b", NULL},       {FALSE,FALSE,FALSE}},
-    {{"nis\\m14a", NULL, NULL},              {TRUE, FALSE,FALSE}},
-    {{"nis\\m16a", "nis\\m16a", "nis\\m16a"},{FALSE,FALSE,TRUE }},
+    {{NIS_PATH"m06a", NULL, NULL},                    {FALSE,FALSE,FALSE}},
+    {{NIS_PATH"m07a", NULL, NULL},                    {FALSE,FALSE,FALSE}},
+    {{NIS_PATH"m08a", NULL, NULL},                    {FALSE,FALSE,FALSE}},
+    {{NIS_PATH"m09a", NIS_PATH"m09b", NIS_PATH"m06a"},{FALSE,FALSE,FALSE}},
+    {{NIS_PATH"m10a", NULL, NULL},                    {FALSE,FALSE,FALSE}},
+    {{NIS_PATH"m11a", NULL, NULL},                    {FALSE,FALSE,FALSE}},
+    {{NIS_PATH"m12a", NIS_PATH"m12b", NULL},          {FALSE,TRUE, FALSE}},
+    {{NIS_PATH"m13a", NULL, NIS_PATH"m13c"},          {FALSE,FALSE,TRUE }},
+    {{NIS_PATH"m15a", NIS_PATH"m15b", NULL},          {FALSE,FALSE,FALSE}},
+    {{NIS_PATH"m14a", NULL, NULL},                    {TRUE, FALSE,FALSE}},
+    {{NIS_PATH"m16a", NIS_PATH"m16a", NIS_PATH"m16a"},{FALSE,FALSE,TRUE }},
     {{NULL, NULL, NULL},                     {FALSE,FALSE,FALSE}},
 };
 
@@ -2921,6 +2954,81 @@
     return WatchFunctionAddress(index);
 }
 
+/* Get the proper FSM function list for the given mission index. */
+const void **FunctionListAddress(sdword i)
+{
+    switch (i)
+    {
+        case 0:     return Mission01_FunctionPointers;
+        case 1:     return Mission02_FunctionPointers;
+        case 2:     return Mission03_FunctionPointers;
+        case 3:     return Mission04_FunctionPointers;
+#ifdef OEM
+        case 4:     return Mission05_OEM_FunctionPointers;
+#else
+        case 4:     return Mission05_FunctionPointers;
+        case 5:     return Mission06_FunctionPointers;
+        case 6:     return Mission07_FunctionPointers;
+        case 7:     return Mission08_FunctionPointers;
+        case 8:     return Mission09_FunctionPointers;
+        case 9:     return Mission10_FunctionPointers;
+        case 10:     return Mission11_FunctionPointers;
+        case 11:     return Mission12_FunctionPointers;
+        case 12:     return Mission13_FunctionPointers;
+        case 13:     return Mission14_FunctionPointers;
+        case 14:     return Mission15_FunctionPointers;
+        case 15:     return Mission16_FunctionPointers;
+#endif
+        case 16:     return Tutorial1_FunctionPointers;
+    }
+
+    return NULL;
+}
+
+/* Get the size of an FSM function list for the given mission index. */
+udword FunctionListSize(sdword i)
+{
+    switch (i)
+    {
+        case 0:     return Mission01_FunctionPointerCount;
+        case 1:     return Mission02_FunctionPointerCount;
+        case 2:     return Mission03_FunctionPointerCount;
+        case 3:     return Mission04_FunctionPointerCount;
+#ifdef OEM
+        case 4:     return Mission05_OEM_FunctionPointerCount;
+#else
+        case 4:     return Mission05_FunctionPointerCount;
+        case 5:     return Mission06_FunctionPointerCount;
+        case 6:     return Mission07_FunctionPointerCount;
+        case 7:     return Mission08_FunctionPointerCount;
+        case 8:     return Mission09_FunctionPointerCount;
+        case 9:     return Mission10_FunctionPointerCount;
+        case 10:     return Mission11_FunctionPointerCount;
+        case 11:     return Mission12_FunctionPointerCount;
+        case 12:     return Mission13_FunctionPointerCount;
+        case 13:     return Mission14_FunctionPointerCount;
+        case 14:     return Mission15_FunctionPointerCount;
+        case 15:     return Mission16_FunctionPointerCount;
+#endif
+        case 16:     return Tutorial1_FunctionPointerCount;
+    }
+
+    return 0;
+}
+
+/* Get the the FSM function list for the given level index. */
+const void** IndexToFunctionList(sdword index)
+{
+    if (index == -1)
+    {
+        return NULL;
+    }
+
+    dbgAssert(index >= 0);
+    dbgAssert(index < NUMBER_SINGLEPLAYER_MISSIONS);
+    return FunctionListAddress(index);
+}
+
 //nisplaying *singlePlayerNISPlaying = NULL;
 
 sdword singlePlayerNisNumber = -1;
@@ -3322,7 +3430,7 @@
 
         if (sscanf(line,"%s %d",tempbuf,&warpLevel) == 2)
         {
-            if (_stricmp("WarpTo",tempbuf) == 0)
+            if (strcasecmp("WarpTo",tempbuf) == 0)
             {
                 if (warpLevel > 1)
                 {
diff -urPw homeworld-orig/src/Game/SinglePlayer.h homeworld_sdl-0.3/src/Game/SinglePlayer.h
--- homeworld-orig/src/Game/SinglePlayer.h	2002-09-04 12:46:18.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/SinglePlayer.h	2004-08-01 22:35:21.000000000 -0700
@@ -6,12 +6,12 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "vector.h"
-#include "region.h"
-#include "spaceobj.h"
-#include "kas.h"
-#include "etg.h"
+#include "Types.h"
+#include "Vector.h"
+#include "Region.h"
+#include "SpaceObj.h"
+#include "KAS.h"
+#include "ETG.h"
 
 /*=============================================================================
     Switches:
@@ -192,6 +192,9 @@
 sdword WatchFunctionToIndex(KASWatchFunction watchFunction);
 KASWatchFunction IndexToWatchFunction(sdword index);
 
+udword FunctionListSize(sdword i);
+const void** IndexToFunctionList(sdword index);
+
 #if SP_NISLET_TEST
 void spNISletTestAttempt(sdword index);
 #endif
diff -urPw homeworld-orig/src/Game/SoundEvent.c homeworld_sdl-0.3/src/Game/SoundEvent.c
--- homeworld-orig/src/Game/SoundEvent.c	2002-09-04 12:46:20.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/SoundEvent.c	2004-08-01 22:35:22.000000000 -0700
@@ -8,13 +8,13 @@
 
 #include "SoundEventPrivate.h"
 #include "SoundEvent.h"
-#include "gun.h"
-#include "matrix.h"
-#include "select.h"
+#include "Gun.h"
+#include "Matrix.h"
+#include "Select.h"
 #include "GenericInterceptor.h"
 #include "SalCapCorvette.h"
 #include "render.h"
-#include "singleplayer.h"
+#include "SinglePlayer.h"
 
 
 #define DIRECTSOUND     1
@@ -25,6 +25,98 @@
 #define SFX_MAX_STRIKEENGINES   5
 #define SFX_MAX_CAPENGINES      3
 
+real32	SPEECH_MOSHIP_WARNING_TIME;
+real32	SPEECH_WARNING_TIME;
+
+real32 SFX_VOL_FACTOR;
+sdword SFX_MAX_ENGINES;
+sdword SFX_MIN_CAPSHIPS;
+sdword SFX_AMBIENT_VOLUME;
+sdword SFX_NIS_MAX_ENGINES;
+sdword SFX_NIS_MIN_CAPSHIPS;
+real32 SFX_MAX_ENGINE_RANGE;
+bool   SFX_CAPSHIPS_ALWAYS_ON;
+sdword SFX_MAX_AMBIENT;
+real32 SFX_FLOAT_VELOCITY;
+real32 SFX_NIS_FLOAT_VELOCITY;
+real32 SFX_MIN_PERCEPTABLE_VOL;
+
+sword  SFX_HYPERSPACE_VOLUME;
+
+real32 SFX_DAMAGERATIO_LIGHT;
+real32 SFX_DAMAGERATIO_MEDIUM;
+real32 SFX_DAMAGERATIO_HEAVY;
+bool   SFX_DAMAGERATIO_ENABLE;
+
+real32 SFX_CARDIOD_FACTOR;
+real32 SFX_CARDIOD_MIN;
+
+real32 FIGHTER_VELOCITY_LOWPITCH;
+real32 FIGHTER_VELOCITY_HIGHPITCH;
+real32 FIGHTER_VELOCITY_SCALE;
+
+real32 CORVETTE_VELOCITY_LOWPITCH;
+real32 CORVETTE_VELOCITY_HIGHPITCH;
+real32 CORVETTE_VELOCITY_SCALE;
+
+real32 FIGHTER_DOPPLER_SCALE;
+sdword FIGHTER_DOPPLER_LOW;
+sdword FIGHTER_DOPPLER_HIGH;
+bool   FIGHTER_DOPPLER_USEVELOCITY;
+
+real32 CORVETTE_DOPPLER_SCALE;
+sdword CORVETTE_DOPPLER_LOW;
+sdword CORVETTE_DOPPLER_HIGH;
+bool   CORVETTE_DOPPLER_USEVELOCITY;
+
+real32 SPEECH_VOL_FACTOR;
+sword  SPEECH_VOL_LOW;
+sword  SPEECH_VOL_MAX;
+real32 SPEECH_NOISE_FACTOR;
+real32 SPEECH_NOISE_LOW;
+real32 SPEECH_NOISE_HIGH;
+udword SPEECH_FILTER_LOW;
+udword SPEECH_FILTER_HIGH;
+real32 SPEECH_BREAK_THRESHOLD;
+real32 SPEECH_BREAK_RATE_FACTOR;
+udword SPEECH_BREAK_RATE_LOW;
+udword SPEECH_BREAK_RATE_HIGH;
+real32 SPEECH_BREAK_LENGTH_FACTOR;
+udword SPEECH_BREAK_LENGTH_LOW;
+udword SPEECH_BREAK_LENGTH_HIGH;
+real32 SPEECH_CAPSHIP_CHATTER_RANGE;
+sdword SPEECH_CAPSHIP_CHATTER_TIME;
+real32 SPEECH_COMBAT_CHATTER_RANGE;
+sdword SPEECH_COMBAT_CHATTER_TIME;
+real32 SPEECH_DISOBEY_FORCEDATTACK;
+
+real32 SPEECH_MIN_PERCEPTABLE_VOL;
+real32 SPEECH_AMBIENT_LEVEL;
+bool   SPEECH_AMBIENT_ENABLE;
+
+real32 SPEECH_STIKEDAMAGE_MULT;
+real32 SPEECH_CAPDAMAGE_MULT;
+
+real32 SPEECH_SINGLEPLAYER_RATIO;
+real32 SPEECH_STATUS_RATIO;
+real32 SPEECH_CHATTER_RATIO;
+
+real32 MUSIC_DISTANCE_SILENT;
+real32 MUSIC_DISTANCE_MAX;
+real32 MUSIC_MAXGAME_VOL;
+real32 MUSIC_MINACTIVE_VOL;
+real32 MUSIC_MININACTIVE_VOL;
+real32 MUSIC_SENSORS_VOL;
+real32 MUSIC_MANAGERS_VOL;
+real32 MUSIC_TUTORIAL_VOL;
+real32 MUSIC_FADE_TIME;
+real32 MUSIC_MAXBATTLE_VOL;
+real32 MUSIC_MINBATTLE_VOL;
+
+real32 RANDOM_AMBIENCE_MINFREQ;
+sdword RANDOM_AMBIENCE_ADDRANDOM;
+
+
 /*=============================================================================
     Tweaks
 =============================================================================*/
@@ -154,10 +246,9 @@
 real32  DefaultEQ[SOUND_EQ_SIZE];
 real32  MasterEQ[SOUND_EQ_SIZE] = {1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0};
 
-extern HWND ghMainWindow;
 extern bool nisIsRunning;
 
-MCI_OPEN_PARMS MCIOpen;                     // MCI_OPEN structure
+SDL_CD* gCD = NULL;  /* CD device used for CD playback. */
 
 real32 cardiod[CARDIOD_POINTS];
 
@@ -560,6 +651,15 @@
 {
     sdword i, j, index;
 	
+#ifdef ENDIAN_BIG	
+        for (j = 0; j< (RangeLUT->rows * RangeLUT->columns); j++ )
+            RangeLUT->lookup[j] = LittleLong( RangeLUT->lookup[j] );
+        for (j = 0; j< (VolumeLUT->rows * VolumeLUT->columns); j++ )
+            VolumeLUT->lookup[j] = LittleLong( VolumeLUT->lookup[j] );
+        for (j=0; j < (FrequencyLUT->columns * FrequencyLUT->rows); j++ )
+            FrequencyLUT->lookup[j] = LittleFloat( FrequencyLUT->lookup[j] );
+#endif
+
 	/* do some precalculations on the volume and range tables, saves a divide, compare, 2 [] and 2 subtractions for every volume update */
 	for (j = 0; j < (VolumeLUT->rows * VolumeLUT->columns); j += VolumeLUT->columns)
 	{
@@ -607,7 +707,7 @@
         return;
     }
 
-    if (soundinit(ghMainWindow, useWaveout) == SOUND_ERR)
+    if (soundinit(useWaveout) == SOUND_ERR)
     {
         enableSFX = FALSE;
         enableSpeech = FALSE;
@@ -626,19 +726,37 @@
     /* LOAD volume curves */
     strcpy(loadfile, SOUNDFXDIR);
     strcat(loadfile, "Volume.lut");
-    size = fileLoadAlloc(loadfile, &VolumeLUT, NonVolatile);
+    size = fileLoadAlloc(loadfile, (void**)&VolumeLUT, NonVolatile);
     VolumeFloatLUT = memAlloc(size, "Volume Table", NonVolatile);
 
+#ifdef ENDIAN_BIG
+    VolumeLUT->ID      = LittleLong( VolumeLUT->ID );
+    VolumeLUT->columns = LittleShort( VolumeLUT->columns );
+    VolumeLUT->rows    = LittleShort( VolumeLUT->rows );
+#endif
+
     strcpy(loadfile, SOUNDFXDIR);
     strcat(loadfile, "Range.lut");
-    size = fileLoadAlloc(loadfile, &RangeLUT, NonVolatile);
+    size = fileLoadAlloc(loadfile, (void**)&RangeLUT, NonVolatile);
 	RangeFloatLUT = memAlloc(size, "Range Table", NonVolatile);
 
+#ifdef ENDIAN_BIG
+    RangeLUT->ID      = LittleLong( RangeLUT->ID );
+    RangeLUT->columns = LittleShort( RangeLUT->columns );
+    RangeLUT->rows    = LittleShort( RangeLUT->rows );
+#endif
+    
     strcpy(loadfile, SOUNDFXDIR);
     strcat(loadfile, "Frequency.lut");
-    size = fileLoadAlloc(loadfile, &FrequencyLUT, NonVolatile);
+    size = fileLoadAlloc(loadfile, (void**)&FrequencyLUT, NonVolatile);
 	FreqLUT = memAlloc(size, "Frequency Table", NonVolatile);
 
+#ifdef ENDIAN_BIG
+    FrequencyLUT->ID      = LittleLong( FrequencyLUT->ID );
+    FrequencyLUT->columns = LittleShort( FrequencyLUT->columns );
+    FrequencyLUT->rows    = LittleShort( FrequencyLUT->rows );
+#endif
+    
     /* do some pre-calculations on the volume, range and frequency tables */
 	SEprecalcVolTables();
 
@@ -653,17 +771,21 @@
     }
 
 #if SPEECH
+#ifndef _MACOSX_FIX_ME
     if (enableSpeech)
+#endif
     {
         if (speechEventInit() != SOUND_OK)
         {
             enableSpeech = FALSE;
         }
     }
-#endif
+#endif // SPEECH
+
     soundeventinited = TRUE;
-#endif
-#endif
+    
+#endif // DIRECTSOUND
+#endif // SOUND
 }
 
 
@@ -734,7 +856,7 @@
 {
 	if (enableSFX || enableSpeech)
 	{
-		soundreinit(ghMainWindow);
+		soundreinit();
 		soundEventPlayMusic(SOUND_FRONTEND_TRACK);
 	}
 
@@ -880,7 +1002,6 @@
         objnode = objnode->prev;
     }
 
-    soundupdate();
 }
 #endif
 
@@ -904,11 +1025,8 @@
     real32 dist;
     real32 velocity;
     real32 velratio = 1.0f;
-    udword iscapship;
     sdword  numships = 0,
-            numcapships = 0,
-            numabmient = 0;
-    static sdword numbattlechatter = 0;
+            numcapships = 0;
     sword shipangle = 0;
     static real32 tempEQ[SOUND_EQ_SIZE];
     GunInfo *gunInfo;
@@ -923,7 +1041,6 @@
     real32 damageratio = 1.0f;
     sdword ambient;
 	ShipSinglePlayerGameInfo *shipSinglePlayerGameInfo;
-	static real32 strikescale = 5.0f;
 	bool damageOn = FALSE;
 	bool noAmbient = FALSE;
 
@@ -1123,7 +1240,7 @@
 		if (shipclass == CLASS_Fighter)
 		{
 			vol = (sword)(vol * (1.0f - ship->soundevent.coverage));
-			velratio = FIGHTER_VELOCITY_LOWPITCH; + (velocity / ship->staticinfo->staticheader.maxvelocity * FIGHTER_VELOCITY_SCALE);
+			velratio = FIGHTER_VELOCITY_LOWPITCH; //+ (velocity / ship->staticinfo->staticheader.maxvelocity * FIGHTER_VELOCITY_SCALE);
 			if (velratio > FIGHTER_VELOCITY_HIGHPITCH)
 			{
 				velratio = FIGHTER_VELOCITY_HIGHPITCH;
@@ -1132,7 +1249,7 @@
 		else if (shipclass == CLASS_Corvette)
 		{
 			vol = (sword)(vol * (1.0f - ship->soundevent.coverage));
-			velratio = CORVETTE_VELOCITY_LOWPITCH; + (velocity / ship->staticinfo->staticheader.maxvelocity * CORVETTE_VELOCITY_SCALE);
+			velratio = CORVETTE_VELOCITY_LOWPITCH; //+ (velocity / ship->staticinfo->staticheader.maxvelocity * CORVETTE_VELOCITY_SCALE);
 			if (velratio > CORVETTE_VELOCITY_HIGHPITCH)
 			{
 				velratio = CORVETTE_VELOCITY_HIGHPITCH;
@@ -2449,18 +2566,56 @@
 {
     char loadfile[100];
 
+#ifdef ENDIAN_BIG
+	int  i;
+#endif
+
     /* new stuff */
     strcpy(loadfile, SOUNDFXDIR);
     strcat(loadfile, "GunEvents.lut");
-    fileLoadAlloc(loadfile, &GunEventsLUT, NonVolatile);
+    fileLoadAlloc(loadfile, (void**)&GunEventsLUT, NonVolatile);
+
+#ifdef ENDIAN_BIG	
+	GunEventsLUT->ID            = LittleLong( GunEventsLUT->ID );
+	GunEventsLUT->checksum      = LittleLong( GunEventsLUT->checksum );
+	GunEventsLUT->numvariations = LittleShort( GunEventsLUT->numvariations );
+	GunEventsLUT->numevents     = LittleShort( GunEventsLUT->numevents );
+	GunEventsLUT->numobjects    = LittleShort( GunEventsLUT->numobjects );
+	int lt = GunEventsLUT->numvariations * GunEventsLUT->numevents * GunEventsLUT->numobjects;
+	for ( i=0; i<lt; i++ )
+		GunEventsLUT->lookup[i] = LittleShort( GunEventsLUT->lookup[i] );
+#endif
 
     strcpy(loadfile, SOUNDFXDIR);
     strcat(loadfile, "ShipCmnEvents.lut");
-    fileLoadAlloc(loadfile, &ShipCmnEventsLUT, NonVolatile);
+    fileLoadAlloc(loadfile, (void**)&ShipCmnEventsLUT, NonVolatile);
+
+#ifdef ENDIAN_BIG
+	ShipCmnEventsLUT->ID            = LittleLong( ShipCmnEventsLUT->ID );
+	ShipCmnEventsLUT->checksum      = LittleLong( ShipCmnEventsLUT->checksum );
+	ShipCmnEventsLUT->numvariations = LittleShort( ShipCmnEventsLUT->numvariations );
+	ShipCmnEventsLUT->numevents     = LittleShort( ShipCmnEventsLUT->numevents );
+	ShipCmnEventsLUT->numobjects    = LittleShort( ShipCmnEventsLUT->numobjects );
+	lt = ShipCmnEventsLUT->numvariations * ShipCmnEventsLUT->numevents * ShipCmnEventsLUT->numobjects;
+	for ( i=0; i<lt; i++ )
+		ShipCmnEventsLUT->lookup[i] = LittleShort( ShipCmnEventsLUT->lookup[i] );
+#endif
 
     strcpy(loadfile, SOUNDFXDIR);
     strcat(loadfile, "ShipEvents.lut");
-    fileLoadAlloc(loadfile, &ShipEventsLUT, NonVolatile);
+    fileLoadAlloc(loadfile, (void**)&ShipEventsLUT, NonVolatile);
+
+#ifdef ENDIAN_BIG
+	ShipEventsLUT->ID            = LittleLong( ShipEventsLUT->ID );
+	ShipEventsLUT->checksum      = LittleLong( ShipEventsLUT->checksum );
+	ShipEventsLUT->numvariations = LittleShort( ShipEventsLUT->numvariations );
+	ShipEventsLUT->numevents     = LittleShort( ShipEventsLUT->numevents );
+	ShipEventsLUT->numobjects    = LittleShort( ShipEventsLUT->numobjects );
+	lt = ShipEventsLUT->numvariations * ShipEventsLUT->numevents * ShipEventsLUT->numobjects;
+	for ( i=0; i<lt; i++ )
+		ShipEventsLUT->lookup[i] = LittleShort( ShipEventsLUT->lookup[i] );
+#endif
+		
 	if (ShipEventsLUT->checksum != ShipCmnEventsLUT->checksum)
 	{
 		dbgMessage("Lookup tables do not match.  Not from same generate.\n");
@@ -2469,7 +2624,19 @@
 
     strcpy(loadfile, SOUNDFXDIR);
     strcat(loadfile, "DerelictEvents.lut");
-    fileLoadAlloc(loadfile, &DerelictEventsLUT, NonVolatile);
+    fileLoadAlloc(loadfile, (void**)&DerelictEventsLUT, NonVolatile);
+
+#ifdef ENDIAN_BIG
+	DerelictEventsLUT->ID            = LittleLong( DerelictEventsLUT->ID );
+	DerelictEventsLUT->checksum      = LittleLong( DerelictEventsLUT->checksum );
+	DerelictEventsLUT->numvariations = LittleShort( DerelictEventsLUT->numvariations );
+	DerelictEventsLUT->numevents     = LittleShort( DerelictEventsLUT->numevents );
+	DerelictEventsLUT->numobjects    = LittleShort( DerelictEventsLUT->numobjects );
+	lt = DerelictEventsLUT->numvariations * DerelictEventsLUT->numevents * DerelictEventsLUT->numobjects;
+	for ( i=0; i<lt; i++ )
+		DerelictEventsLUT->lookup[i] = LittleShort( DerelictEventsLUT->lookup[i] );
+#endif
+		
 	if (DerelictEventsLUT->checksum != ShipCmnEventsLUT->checksum)
 	{
 		dbgMessage("Lookup tables do not match.  Not from same generate.\n");
@@ -2482,7 +2649,19 @@
 
     strcpy(loadfile, SOUNDFXDIR);
     strcat(loadfile, "SpecExpEvents.lut");
-    fileLoadAlloc(loadfile, &SpecExpEventsLUT, NonVolatile);
+    fileLoadAlloc(loadfile, (void**)&SpecExpEventsLUT, NonVolatile);
+
+#ifdef ENDIAN_BIG
+	SpecExpEventsLUT->ID            = LittleLong( SpecExpEventsLUT->ID );
+	SpecExpEventsLUT->checksum      = LittleLong( SpecExpEventsLUT->checksum );
+	SpecExpEventsLUT->numvariations = LittleShort( SpecExpEventsLUT->numvariations );
+	SpecExpEventsLUT->numevents     = LittleShort( SpecExpEventsLUT->numevents );
+	SpecExpEventsLUT->numobjects    = LittleShort( SpecExpEventsLUT->numobjects );
+	lt = SpecExpEventsLUT->numvariations * SpecExpEventsLUT->numevents * SpecExpEventsLUT->numobjects;
+	for ( i=0; i<lt; i++ )
+		SpecExpEventsLUT->lookup[i] = LittleShort( SpecExpEventsLUT->lookup[i] );
+#endif
+
 //	if (SpecExpEventsLUT->checksum != SpecEffectEventsLUT->checksum)
 //	{
 //		dbgMessage("Lookup tables do not match.  Not from same generate.\n");
@@ -2491,7 +2670,19 @@
 
     strcpy(loadfile, SOUNDFXDIR);
     strcat(loadfile, "SpecHitEvents.lut");
-    fileLoadAlloc(loadfile, &SpecHitEventsLUT, NonVolatile);
+    fileLoadAlloc(loadfile, (void**)&SpecHitEventsLUT, NonVolatile);
+
+#ifdef ENDIAN_BIG
+	SpecHitEventsLUT->ID            = LittleLong( SpecHitEventsLUT->ID );
+	SpecHitEventsLUT->checksum      = LittleLong( SpecHitEventsLUT->checksum );
+	SpecHitEventsLUT->numvariations = LittleShort( SpecHitEventsLUT->numvariations );
+	SpecHitEventsLUT->numevents     = LittleShort( SpecHitEventsLUT->numevents );
+	SpecHitEventsLUT->numobjects    = LittleShort( SpecHitEventsLUT->numobjects );
+	lt = SpecHitEventsLUT->numvariations * SpecHitEventsLUT->numevents * SpecHitEventsLUT->numobjects;
+	for ( i=0; i<lt; i++ )
+		SpecHitEventsLUT->lookup[i] = LittleShort( SpecHitEventsLUT->lookup[i] );
+#endif
+		
 //	if (SpecHitEventsLUT->checksum != SpecEffectEventsLUT->checksum)
 	if (SpecHitEventsLUT->checksum != SpecExpEventsLUT->checksum)
 	{
@@ -2501,11 +2692,22 @@
 
     strcpy(loadfile, SOUNDFXDIR);
     strcat(loadfile, "UIEvents.lut");
-    fileLoadAlloc(loadfile, &UIEventsLUT, NonVolatile);
+    fileLoadAlloc(loadfile, (void**)&UIEventsLUT, NonVolatile);
+
+#ifdef ENDIAN_BIG
+	UIEventsLUT->ID = LittleLong( UIEventsLUT->ID );
+	UIEventsLUT->checksum = LittleLong( UIEventsLUT->checksum );
+	UIEventsLUT->numvariations = LittleShort( UIEventsLUT->numvariations );
+	UIEventsLUT->numevents = LittleShort( UIEventsLUT->numevents );
+	UIEventsLUT->numobjects = LittleShort( UIEventsLUT->numobjects );
+	lt = UIEventsLUT->numvariations * UIEventsLUT->numevents * UIEventsLUT->numobjects;
+	for ( i=0; i<lt; i++ )
+		UIEventsLUT->lookup[i] = LittleShort( UIEventsLUT->lookup[i] );
+#endif
 
     strcpy(loadfile, SOUNDFXDIR);
     strcat(loadfile, "Guns.bnk");
-    fileLoadAlloc(loadfile, &GunBank, NonVolatile);
+    fileLoadAlloc(loadfile, (void**)&GunBank, NonVolatile);
 	if (soundbankadd(GunBank) != GunEventsLUT->checksum)
 	{
 		dbgMessage("Lookup tables do not match.  Not from same generate.\n");
@@ -2514,7 +2716,7 @@
 
     strcpy(loadfile, SOUNDFXDIR);
     strcat(loadfile, "Ships.bnk");
-    fileLoadAlloc(loadfile, &ShipBank, NonVolatile);
+    fileLoadAlloc(loadfile, (void**)&ShipBank, NonVolatile);
 	if (soundbankadd(ShipBank) != ShipCmnEventsLUT->checksum)
 	{
 		dbgMessage("Ship bank file does not match Lookup tables.  Not from same generate.\n");
@@ -2523,7 +2725,7 @@
 
     strcpy(loadfile, SOUNDFXDIR);
     strcat(loadfile, "SpecialEffects.bnk");
-    fileLoadAlloc(loadfile, &SpecialEffectBank, NonVolatile);
+    fileLoadAlloc(loadfile, (void**)&SpecialEffectBank, NonVolatile);
 //	if (soundbankadd(SpecialEffectBank) != SpecEffectEventsLUT->checksum)
 	if (soundbankadd(SpecialEffectBank) != SpecExpEventsLUT->checksum)
 	{
@@ -2533,7 +2735,7 @@
 
     strcpy(loadfile, SOUNDFXDIR);
     strcat(loadfile, "UI.bnk");
-    fileLoadAlloc(loadfile, &UIBank, NonVolatile);
+    fileLoadAlloc(loadfile, (void**)&UIBank, NonVolatile);
 	if (soundbankadd(UIBank) != UIEventsLUT->checksum)
 	{
 		dbgMessage("Lookup tables do not match.  Not from same generate.\n");
@@ -2551,44 +2753,85 @@
 ----------------------------------------------------------------------------*/
 void soundEventPlayCD(uword tracknum)
 {
-    MCIERROR ret;
-    MCI_STATUS_PARMS MCIStatus;                 // MCI_STATUS structure
-    MCI_SET_PARMS MCISet;                       // MCI_SET structure
-    MCI_PLAY_PARMS MCIPlay;                     // MCI_PLAY structure
-
-    MCIOpen.lpstrDeviceType = (LPCSTR) MCI_DEVTYPE_CD_AUDIO;
+    Uint32 flags, i;
 
-    ret = mciSendCommand (0, MCI_OPEN, MCI_OPEN_TYPE | MCI_OPEN_TYPE_ID, (DWORD) (LPVOID) &MCIOpen);
-
-    MCISet.dwTimeFormat = MCI_FORMAT_TMSF;
-    mciSendCommand (MCIOpen.wDeviceID, MCI_SET, MCI_SET_TIME_FORMAT,
-        (DWORD) (LPVOID) &MCISet);
+    /* Initialize CD playback if necessary. */
+    flags = SDL_WasInit(SDL_INIT_CDROM);
+    if (!flags)
+    {
+        if (SDL_Init(SDL_INIT_CDROM) == -1)
+            return;
+    }
+    if (!(flags & SDL_INIT_CDROM))
+    {
+        if (SDL_InitSubSystem(SDL_INIT_CDROM) == -1)
+            return;
+    }
 
-    MCIStatus.dwItem = MCI_STATUS_MEDIA_PRESENT;
-    mciSendCommand (MCIOpen.wDeviceID, MCI_STATUS, MCI_STATUS_ITEM |
-                        MCI_WAIT, (DWORD) (LPVOID) &MCIStatus);
+    /* Check the current CD status. */
+    if (gCD)
+    {
+        if (!CD_INDRIVE(SDL_CDStatus(gCD)))
+        {
+            SDL_CDClose(gCD);
+            gCD = NULL;
+        }
+        else if (gCD->status != CD_STOPPED)
+        {
+            SDL_CDStop(gCD);
+        }
+    }
 
-    if (MCIStatus.dwReturn)
+    if (!gCD)
+    {
+        /* Cycle through each drive. */
+        flags = SDL_CDNumDrives();
+        for (i = 0; i < flags; i++)
+        {
+            if (!(gCD = SDL_CDOpen(i)))
+                continue;
+            if (!CD_INDRIVE(SDL_CDStatus(gCD)))
     {
+                SDL_CDClose(gCD);
+                gCD = NULL;
+                continue;
+            }
+            break;
+        }
+        if (i >= flags)
+            return;
+    }
 
-        // Send an MCI_PLAY command to the CD Audio driver.
-        MCIPlay.dwCallback = (DWORD) ghMainWindow;
-        MCIPlay.dwFrom = MCI_MAKE_TMSF (tracknum, 0, 0, 0);
-        ret = mciSendCommand (MCIOpen.wDeviceID, MCI_PLAY, MCI_FROM | MCI_NOTIFY,
-                (DWORD) (LPVOID) &MCIPlay);
+    /* Play the track. */
+    if (tracknum >= gCD->numtracks)
+        return;
+    if (SDL_CDPlayTracks(gCD, tracknum, 0, 1, 0) == -1)
+    {
+        SDL_CDClose(gCD);
+        gCD = NULL;
     }
 }
 
 
 void soundEventStopCD(void)
 {
-    mciSendCommand (MCIOpen.wDeviceID, MCI_STOP, 0, 0);
+    CDstatus status;
+
+    if (!gCD)
+        return;
+    status = SDL_CDStatus(gCD);
+    if (status == CD_PLAYING || status == CD_PAUSED)
+        SDL_CDStop(gCD);
+    SDL_CDClose(gCD);
+    gCD = NULL;
 }
 
 
 void soundEventPlayMusic(sdword tracknum)
 {
+#ifndef _MACOSX_FIX_ME
     musicEventPlay(tracknum);
+#endif
 
     return;
 }
@@ -2596,14 +2839,18 @@
 
 void soundEventStopMusic(real32 fadetime)
 {
+#ifndef _MACOSX_FIX_ME
     musicEventStop(-1, fadetime);
+#endif
     return;
 }
 
 
 void soundEventStopTrack(sdword tracknum, real32 fadetime)
 {
+#ifndef _MACOSX_FIX_ME
     musicEventStop(tracknum, fadetime);
+#endif
     return;
 }
 
diff -urPw homeworld-orig/src/Game/SoundEvent.h homeworld_sdl-0.3/src/Game/SoundEvent.h
--- homeworld-orig/src/Game/SoundEvent.h	2002-09-04 12:46:20.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/SoundEvent.h	2004-08-01 22:35:23.000000000 -0700
@@ -9,11 +9,11 @@
 #ifndef ___SOUND_EVENT_H
 #define ___SOUND_EVENT_H
 
-#include "types.h"
-#include "speechevent.h"
-#include "soundstructs.h"
-#include "spaceobj.h"
-#include "soundmusic.h"
+#include "Types.h"
+#include "SpeechEvent.h"
+#include "SoundStructs.h"
+#include "SpaceObj.h"
+#include "SoundMusic.h"
 #include "SoundEventDefs.h"
 
 /*=============================================================================
@@ -47,8 +47,8 @@
     Tweaks
 =============================================================================*/
 
-real32	SPEECH_MOSHIP_WARNING_TIME;
-real32	SPEECH_WARNING_TIME;
+extern real32	SPEECH_MOSHIP_WARNING_TIME;
+extern real32	SPEECH_WARNING_TIME;
 
 extern Ship *lastshiptospeak;
 extern sdword lastgrouptospeak;
diff -urPw homeworld-orig/src/Game/SoundEventPlay.c homeworld_sdl-0.3/src/Game/SoundEventPlay.c
--- homeworld-orig/src/Game/SoundEventPlay.c	2002-09-04 12:46:20.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/SoundEventPlay.c	2004-08-01 22:35:19.000000000 -0700
@@ -7,9 +7,9 @@
 =============================================================================*/
 
 #include "SoundEventPrivate.h"
-#include "soundevent.h"
-#include "gun.h"
-#include "matrix.h"
+#include "SoundEvent.h"
+#include "Gun.h"
+#include "Matrix.h"
 
 #define OBJ_None    -1
 #define OBJ_Gun     -2
@@ -62,8 +62,6 @@
     sword pan;
 	sdword i;
     real32 dist;
-    real32 velocity = 0.0f;
-    real32 velratio = 1.0f;
     sdword priority = SOUND_PRIORITY_MIN;
     SpaceObj *spaceobject;
     Effect *effect;
@@ -406,7 +404,6 @@
     sword vol;
     sword pan;
     real32 dist;
-    sdword priority = SOUND_PRIORITY_MIN;
     real32 tempEQ[SOUND_EQ_SIZE];
     sdword eventflag;
 
diff -urPw homeworld-orig/src/Game/SoundEventPrivate.h homeworld_sdl-0.3/src/Game/SoundEventPrivate.h
--- homeworld-orig/src/Game/SoundEventPrivate.h	2002-09-04 12:46:20.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/SoundEventPrivate.h	2004-08-01 22:35:22.000000000 -0700
@@ -9,22 +9,20 @@
 #ifndef ___SOUND_PRIV_H
 #define ___SOUND_PRIV_H
 
-#include <windows.h>
-#include <windowsx.h>
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
 #include <math.h>
 
 #include "soundlow.h"
-#include "types.h"
-#include "switches.h"
-#include "memory.h"
-#include "file.h"
-#include "universe.h"
-#include "univupdate.h"
-#include "fastmath.h"
-#include "randy.h"
+#include "Types.h"
+#include "Switches.h"
+#include "Memory.h"
+#include "File.h"
+#include "Universe.h"
+#include "UnivUpdate.h"
+#include "FastMath.h"
+#include "Randy.h"
 #include "main.h"
 #include "fqeffect.h"
 
@@ -47,7 +45,11 @@
 #define EXPLOSION_OFFSET	58
 #define HIT_OFFSET			65
 
+#ifdef _WIN32
 #define SOUNDFXDIR "SoundFX\\"
+#else
+#define SOUNDFXDIR "SoundFX/"
+#endif
 
 #define CGW1 0
 #if defined(Downloadable) || defined(DLPublicBeta)
@@ -73,93 +75,93 @@
     Tweaks
 =============================================================================*/
 
-real32 SFX_VOL_FACTOR;
-sdword SFX_MAX_ENGINES;
-sdword SFX_MIN_CAPSHIPS;
-sdword SFX_AMBIENT_VOLUME;
-sdword SFX_NIS_MAX_ENGINES;
-sdword SFX_NIS_MIN_CAPSHIPS;
-real32 SFX_MAX_ENGINE_RANGE;
-bool   SFX_CAPSHIPS_ALWAYS_ON;
-sdword SFX_MAX_AMBIENT;
-real32 SFX_FLOAT_VELOCITY;
-real32 SFX_NIS_FLOAT_VELOCITY;
-real32 SFX_MIN_PERCEPTABLE_VOL;
-
-sword  SFX_HYPERSPACE_VOLUME;
-
-real32 SFX_DAMAGERATIO_LIGHT;
-real32 SFX_DAMAGERATIO_MEDIUM;
-real32 SFX_DAMAGERATIO_HEAVY;
-bool   SFX_DAMAGERATIO_ENABLE;
-
-real32 SFX_CARDIOD_FACTOR;
-real32 SFX_CARDIOD_MIN;
-
-real32 FIGHTER_VELOCITY_LOWPITCH;
-real32 FIGHTER_VELOCITY_HIGHPITCH;
-real32 FIGHTER_VELOCITY_SCALE;
-
-real32 CORVETTE_VELOCITY_LOWPITCH;
-real32 CORVETTE_VELOCITY_HIGHPITCH;
-real32 CORVETTE_VELOCITY_SCALE;
-
-real32 FIGHTER_DOPPLER_SCALE;
-sdword FIGHTER_DOPPLER_LOW;
-sdword FIGHTER_DOPPLER_HIGH;
-bool   FIGHTER_DOPPLER_USEVELOCITY;
-
-real32 CORVETTE_DOPPLER_SCALE;
-sdword CORVETTE_DOPPLER_LOW;
-sdword CORVETTE_DOPPLER_HIGH;
-bool   CORVETTE_DOPPLER_USEVELOCITY;
-
-real32 SPEECH_VOL_FACTOR;
-sword  SPEECH_VOL_LOW;
-sword  SPEECH_VOL_MAX;
-real32 SPEECH_NOISE_FACTOR;
-real32 SPEECH_NOISE_LOW;
-real32 SPEECH_NOISE_HIGH;
-udword SPEECH_FILTER_LOW;
-udword SPEECH_FILTER_HIGH;
-real32 SPEECH_BREAK_THRESHOLD;
-real32 SPEECH_BREAK_RATE_FACTOR;
-udword SPEECH_BREAK_RATE_LOW;
-udword SPEECH_BREAK_RATE_HIGH;
-real32 SPEECH_BREAK_LENGTH_FACTOR;
-udword SPEECH_BREAK_LENGTH_LOW;
-udword SPEECH_BREAK_LENGTH_HIGH;
-real32 SPEECH_CAPSHIP_CHATTER_RANGE;
-sdword SPEECH_CAPSHIP_CHATTER_TIME;
-real32 SPEECH_COMBAT_CHATTER_RANGE;
-sdword SPEECH_COMBAT_CHATTER_TIME;
-real32 SPEECH_DISOBEY_FORCEDATTACK;
-
-real32 SPEECH_MIN_PERCEPTABLE_VOL;
-real32 SPEECH_AMBIENT_LEVEL;
-bool   SPEECH_AMBIENT_ENABLE;
-
-real32 SPEECH_STIKEDAMAGE_MULT;
-real32 SPEECH_CAPDAMAGE_MULT;
-
-real32 SPEECH_SINGLEPLAYER_RATIO;
-real32 SPEECH_STATUS_RATIO;
-real32 SPEECH_CHATTER_RATIO;
-
-real32 MUSIC_DISTANCE_SILENT;
-real32 MUSIC_DISTANCE_MAX;
-real32 MUSIC_MAXGAME_VOL;
-real32 MUSIC_MINACTIVE_VOL;
-real32 MUSIC_MININACTIVE_VOL;
-real32 MUSIC_SENSORS_VOL;
-real32 MUSIC_MANAGERS_VOL;
-real32 MUSIC_TUTORIAL_VOL;
-real32 MUSIC_FADE_TIME;
-real32 MUSIC_MAXBATTLE_VOL;
-real32 MUSIC_MINBATTLE_VOL;
+extern real32 SFX_VOL_FACTOR;
+extern sdword SFX_MAX_ENGINES;
+extern sdword SFX_MIN_CAPSHIPS;
+extern sdword SFX_AMBIENT_VOLUME;
+extern sdword SFX_NIS_MAX_ENGINES;
+extern sdword SFX_NIS_MIN_CAPSHIPS;
+extern real32 SFX_MAX_ENGINE_RANGE;
+extern bool   SFX_CAPSHIPS_ALWAYS_ON;
+extern sdword SFX_MAX_AMBIENT;
+extern real32 SFX_FLOAT_VELOCITY;
+extern real32 SFX_NIS_FLOAT_VELOCITY;
+extern real32 SFX_MIN_PERCEPTABLE_VOL;
+
+extern sword  SFX_HYPERSPACE_VOLUME;
+
+extern real32 SFX_DAMAGERATIO_LIGHT;
+extern real32 SFX_DAMAGERATIO_MEDIUM;
+extern real32 SFX_DAMAGERATIO_HEAVY;
+extern bool   SFX_DAMAGERATIO_ENABLE;
+
+extern real32 SFX_CARDIOD_FACTOR;
+extern real32 SFX_CARDIOD_MIN;
+
+extern real32 FIGHTER_VELOCITY_LOWPITCH;
+extern real32 FIGHTER_VELOCITY_HIGHPITCH;
+extern real32 FIGHTER_VELOCITY_SCALE;
+
+extern real32 CORVETTE_VELOCITY_LOWPITCH;
+extern real32 CORVETTE_VELOCITY_HIGHPITCH;
+extern real32 CORVETTE_VELOCITY_SCALE;
+
+extern real32 FIGHTER_DOPPLER_SCALE;
+extern sdword FIGHTER_DOPPLER_LOW;
+extern sdword FIGHTER_DOPPLER_HIGH;
+extern bool   FIGHTER_DOPPLER_USEVELOCITY;
+
+extern real32 CORVETTE_DOPPLER_SCALE;
+extern sdword CORVETTE_DOPPLER_LOW;
+extern sdword CORVETTE_DOPPLER_HIGH;
+extern bool   CORVETTE_DOPPLER_USEVELOCITY;
+
+extern real32 SPEECH_VOL_FACTOR;
+extern sword  SPEECH_VOL_LOW;
+extern sword  SPEECH_VOL_MAX;
+extern real32 SPEECH_NOISE_FACTOR;
+extern real32 SPEECH_NOISE_LOW;
+extern real32 SPEECH_NOISE_HIGH;
+extern udword SPEECH_FILTER_LOW;
+extern udword SPEECH_FILTER_HIGH;
+extern real32 SPEECH_BREAK_THRESHOLD;
+extern real32 SPEECH_BREAK_RATE_FACTOR;
+extern udword SPEECH_BREAK_RATE_LOW;
+extern udword SPEECH_BREAK_RATE_HIGH;
+extern real32 SPEECH_BREAK_LENGTH_FACTOR;
+extern udword SPEECH_BREAK_LENGTH_LOW;
+extern udword SPEECH_BREAK_LENGTH_HIGH;
+extern real32 SPEECH_CAPSHIP_CHATTER_RANGE;
+extern sdword SPEECH_CAPSHIP_CHATTER_TIME;
+extern real32 SPEECH_COMBAT_CHATTER_RANGE;
+extern sdword SPEECH_COMBAT_CHATTER_TIME;
+extern real32 SPEECH_DISOBEY_FORCEDATTACK;
+
+extern real32 SPEECH_MIN_PERCEPTABLE_VOL;
+extern real32 SPEECH_AMBIENT_LEVEL;
+extern bool   SPEECH_AMBIENT_ENABLE;
+
+extern real32 SPEECH_STIKEDAMAGE_MULT;
+extern real32 SPEECH_CAPDAMAGE_MULT;
+
+extern real32 SPEECH_SINGLEPLAYER_RATIO;
+extern real32 SPEECH_STATUS_RATIO;
+extern real32 SPEECH_CHATTER_RATIO;
+
+extern real32 MUSIC_DISTANCE_SILENT;
+extern real32 MUSIC_DISTANCE_MAX;
+extern real32 MUSIC_MAXGAME_VOL;
+extern real32 MUSIC_MINACTIVE_VOL;
+extern real32 MUSIC_MININACTIVE_VOL;
+extern real32 MUSIC_SENSORS_VOL;
+extern real32 MUSIC_MANAGERS_VOL;
+extern real32 MUSIC_TUTORIAL_VOL;
+extern real32 MUSIC_FADE_TIME;
+extern real32 MUSIC_MAXBATTLE_VOL;
+extern real32 MUSIC_MINBATTLE_VOL;
 
-real32 RANDOM_AMBIENCE_MINFREQ;
-sdword RANDOM_AMBIENCE_ADDRANDOM;
+extern real32 RANDOM_AMBIENCE_MINFREQ;
+extern sdword RANDOM_AMBIENCE_ADDRANDOM;
 
 
 /*=============================================================================
diff -urPw homeworld-orig/src/Game/SoundStructs.h homeworld_sdl-0.3/src/Game/SoundStructs.h
--- homeworld-orig/src/Game/SoundStructs.h	2002-09-04 12:46:20.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/SoundStructs.h	2004-08-01 22:35:21.000000000 -0700
@@ -9,7 +9,7 @@
 #ifndef ___SOUND_STRUCTS_H
 #define ___SOUND_STRUCTS_H
 
-#include "types.h"
+#include "Types.h"
 
 
 typedef struct
diff -urPw homeworld-orig/src/Game/SpaceObj.h homeworld_sdl-0.3/src/Game/SpaceObj.h
--- homeworld-orig/src/Game/SpaceObj.h	2002-09-04 12:46:20.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/SpaceObj.h	2004-08-01 22:35:35.000000000 -0700
@@ -7,20 +7,20 @@
 #ifndef ___SPACEOBJ
 #define ___SPACEOBJ
 
-#include "types.h"
-#include "vector.h"
-#include "matrix.h"
-#include "linkedlist.h"
-#include "mesh.h"
-#include "lod.h"
-#include "objtypes.h"
-#include "etg.h"
+#include "Types.h"
+#include "Vector.h"
+#include "Matrix.h"
+#include "LinkedList.h"
+#include "Mesh.h"
+#include "LOD.h"
+#include "ObjTypes.h"
+#include "ETG.h"
 #include "trails.h"
 #include "color.h"
-#include "soundstructs.h"
-#include "meshanim.h"
-#include "clouds.h"
-#include "nebulae.h"
+#include "SoundStructs.h"
+#include "MeshAnim.h"
+#include "Clouds.h"
+#include "Nebulae.h"
 
 /*=============================================================================
     Switches:
@@ -517,6 +517,9 @@
 #define THISSHIPIS_RESOURCER            2
 #define THISSHIPIS_OTHERNONCAPITALSHIP  3
 
+struct ShipStaticInfo;
+struct CommandToDo;
+
 typedef struct
 {
     ShipType shiptype;
@@ -1279,6 +1282,8 @@
 #define SPECIAL_2_DisabledForever                   0x00000080
 				
 
+struct Resource;
+
 typedef struct Ship         // Ship object
 {
     Node objlink;
@@ -1384,7 +1389,7 @@
     sbyte dontrotateever;
     sbyte dontapplyforceever;
     bool8 shipisattacking;
-    ubyte colorScheme;              //what color scheme does this ship use?
+    sbyte colorScheme;              //what color scheme does this ship use?
     ubyte recentlyAttacked;         // counts down from RECENT_ATTACK_DURATION -- see recentAttacker
     ubyte recentlyFiredUpon;        // same, see firingAtUs
     ubyte chatterBits;              // flags for battle chatter
@@ -1660,7 +1665,7 @@
 
     Node derelictlink;
     DerelictID derelictID;
-    ubyte colorScheme;              //what color scheme does this ship use?
+    sbyte colorScheme;              //what color scheme does this ship use?
     ubyte pad[3];
 
     sdword ambientSoundHandle;      //used by sound engine to keep track of the ambient sound the derelict makes
@@ -1927,10 +1932,10 @@
 
 //#define isCapitalShip(ship) (((ShipStaticInfo *)((ship)##->staticinfo))->shipclass <= CLASS_Frigate)
 //#define isCapitalShipStatic(shipstatic) (shipstatic##->shipclass <= CLASS_Frigate)
-#define isCapitalShip(ship) (((ShipStaticInfo *)((ship)##->staticinfo))->shipIsCapital)
-#define isCapitalShipStatic(shipstatic) (shipstatic##->shipIsCapital)
+#define isCapitalShip(ship) (((ShipStaticInfo *)((ship)->staticinfo))->shipIsCapital)
+#define isCapitalShipStatic(shipstatic) ((shipstatic)->shipIsCapital)
 
-#define isShipOfClass(ship,checkclass) (((ShipStaticInfo *)((ship)##->staticinfo))->shipclass == (checkclass))
+#define isShipOfClass(ship,checkclass) (((ShipStaticInfo *)((ship)->staticinfo))->shipclass == (checkclass))
 
 /*=============================================================================
     Support Functions:
diff -urPw homeworld-orig/src/Game/SpeechEvent.c homeworld_sdl-0.3/src/Game/SpeechEvent.c
--- homeworld-orig/src/Game/SpeechEvent.c	2002-09-04 12:46:20.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/SpeechEvent.c	2004-08-01 22:35:30.000000000 -0700
@@ -6,19 +6,24 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
+#include <strings.h>
 #include "SoundEventPrivate.h"
 #include "SoundEvent.h"
-#include "select.h"
-#include "blobs.h"
+#include "Select.h"
+#include "Blobs.h"
 #include "soundcmn.h"
-#include "nis.h"
-#include "soundmusic.h"
+#include "NIS.h"
+#include "SoundMusic.h"
 #include "fquant.h"
-#include "chatting.h"
-#include "singleplayer.h"
-#include "bink.h"
+#include "Chatting.h"
+#include "SinglePlayer.h"
+/*#include "bink.h"*/
 #include "utility.h"
 
+#ifdef _MSC_VER
+#define strncasecmp strnicmp
+#endif
+
 #define STATE_BREAK     3
 
 #define MAX_BATTLES     20
@@ -326,11 +331,17 @@
 {
     sdword i;
 
-    scriptSetStruct("SoundFX\\Scripts\\", "eq_fleet.script", streamEQScriptTable, (ubyte *)&streamEQ[SPEECH_FLEET]);
-    scriptSetStruct("SoundFX\\Scripts\\", "eq_intel.script", streamEQScriptTable, (ubyte *)&streamEQ[SPEECH_INTEL]);
-    scriptSetStruct("SoundFX\\Scripts\\", "eq_pilot1.script", streamEQScriptTable, (ubyte *)&streamEQ[SPEECH_PILOT1]);
-    scriptSetStruct("SoundFX\\Scripts\\", "eq_pilot2.script", streamEQScriptTable, (ubyte *)&streamEQ[SPEECH_PILOT2]);
-    scriptSetStruct("SoundFX\\Scripts\\", "eq_pilot3.script", streamEQScriptTable, (ubyte *)&streamEQ[SPEECH_PILOT3]);
+#ifdef _WIN32
+#define SFX_SCRIPT_PATH "SoundFX\\Scripts\\"
+#else
+#define SFX_SCRIPT_PATH "SoundFX/Scripts/"
+#endif
+
+    scriptSetStruct(SFX_SCRIPT_PATH, "eq_fleet.script", streamEQScriptTable, (ubyte *)&streamEQ[SPEECH_FLEET]);
+    scriptSetStruct(SFX_SCRIPT_PATH, "eq_intel.script", streamEQScriptTable, (ubyte *)&streamEQ[SPEECH_INTEL]);
+    scriptSetStruct(SFX_SCRIPT_PATH, "eq_pilot1.script", streamEQScriptTable, (ubyte *)&streamEQ[SPEECH_PILOT1]);
+    scriptSetStruct(SFX_SCRIPT_PATH, "eq_pilot2.script", streamEQScriptTable, (ubyte *)&streamEQ[SPEECH_PILOT2]);
+    scriptSetStruct(SFX_SCRIPT_PATH, "eq_pilot3.script", streamEQScriptTable, (ubyte *)&streamEQ[SPEECH_PILOT3]);
 
     // set last unsused eq band to 1
     streamEQ[SPEECH_FLEET].eq[8]=1.0F;
@@ -339,11 +350,11 @@
     streamEQ[SPEECH_PILOT2].eq[8]=1.0F;
     streamEQ[SPEECH_PILOT3].eq[8]=1.0F;
 
-    scriptSetStruct("SoundFX\\Scripts\\", "delay_fleet.script", streamDelaySciptTable, (ubyte *)&streamdelay[SPEECH_FLEET]);
-    scriptSetStruct("SoundFX\\Scripts\\", "delay_intel.script", streamDelaySciptTable, (ubyte *)&streamdelay[SPEECH_INTEL]);
-    scriptSetStruct("SoundFX\\Scripts\\", "delay_strikecraft.script", streamDelaySciptTable, (ubyte *)&streamdelay[SPEECH_STRIKECRAFT]);
-    scriptSetStruct("SoundFX\\Scripts\\", "delay_capships.script", streamDelaySciptTable, (ubyte *)&streamdelay[SPEECH_CAPSHIPS]);
-    scriptSetStruct("SoundFX\\Scripts\\", "delay_construction.script", streamDelaySciptTable, (ubyte *)&streamdelay[SPEECH_CONSTRUCTION]);
+    scriptSetStruct(SFX_SCRIPT_PATH, "delay_fleet.script", streamDelaySciptTable, (ubyte *)&streamdelay[SPEECH_FLEET]);
+    scriptSetStruct(SFX_SCRIPT_PATH, "delay_intel.script", streamDelaySciptTable, (ubyte *)&streamdelay[SPEECH_INTEL]);
+    scriptSetStruct(SFX_SCRIPT_PATH, "delay_strikecraft.script", streamDelaySciptTable, (ubyte *)&streamdelay[SPEECH_STRIKECRAFT]);
+    scriptSetStruct(SFX_SCRIPT_PATH, "delay_capships.script", streamDelaySciptTable, (ubyte *)&streamdelay[SPEECH_CAPSHIPS]);
+    scriptSetStruct(SFX_SCRIPT_PATH, "delay_construction.script", streamDelaySciptTable, (ubyte *)&streamdelay[SPEECH_CONSTRUCTION]);
 
     // set last unsused eq band to 1
     streamdelay[SPEECH_FLEET].eq[8]=1.0F;
@@ -352,12 +363,12 @@
     streamdelay[SPEECH_CAPSHIPS].eq[8]=1.0F;
     streamdelay[SPEECH_CONSTRUCTION].eq[8]=1.0F;
 
-    scriptSetStruct("SoundFX\\Scripts\\", "effect_fleet.script", streamEffectScriptTable, (ubyte *)&cleaneffect[SPEECH_FLEET]);
-    scriptSetStruct("SoundFX\\Scripts\\", "effect_intel.script", streamEffectScriptTable, (ubyte *)&cleaneffect[SPEECH_INTEL]);
-    scriptSetStruct("SoundFX\\Scripts\\", "effect_strikecraft.script", streamEffectScriptTable, (ubyte *)&cleaneffect[SPEECH_STRIKECRAFT]);
-    scriptSetStruct("SoundFX\\Scripts\\", "effect_capships.script", streamEffectScriptTable, (ubyte *)&cleaneffect[SPEECH_CAPSHIPS]);
+    scriptSetStruct(SFX_SCRIPT_PATH, "effect_fleet.script", streamEffectScriptTable, (ubyte *)&cleaneffect[SPEECH_FLEET]);
+    scriptSetStruct(SFX_SCRIPT_PATH, "effect_intel.script", streamEffectScriptTable, (ubyte *)&cleaneffect[SPEECH_INTEL]);
+    scriptSetStruct(SFX_SCRIPT_PATH, "effect_strikecraft.script", streamEffectScriptTable, (ubyte *)&cleaneffect[SPEECH_STRIKECRAFT]);
+    scriptSetStruct(SFX_SCRIPT_PATH, "effect_capships.script", streamEffectScriptTable, (ubyte *)&cleaneffect[SPEECH_CAPSHIPS]);
 
-    scriptSetStruct("SoundFX\\Scripts\\", "effect_damage.script", streamEffectScriptTable, (ubyte *)&damageeffect);
+    scriptSetStruct(SFX_SCRIPT_PATH, "effect_damage.script", streamEffectScriptTable, (ubyte *)&damageeffect);
 
     /* copy the unchanging effects to the mixed effect */
     for (i = 0;  i < SE_NUM_ACTORS; i++)
@@ -368,6 +379,7 @@
         mixedeffect[i].fLimitLev = cleaneffect[i].fLimitLev;
     }
 
+#undef SFX_SCRIPT_PATH
 }
 
 
@@ -383,10 +395,14 @@
         memset(streamdelay[i].eq, 0, SOUND_EQ_SIZE * sizeof(real32));
 //      streamEQ[i].flags = STREAM_FLAGS_NOEFFECT;
 //      memset(streamEQ[i].eq, 0, SOUND_EQ_SIZE * sizeof(real32));
+#if 0  /* fq*() functions not yet implemented... */
         fqInitE(&cleaneffect[i]);
         fqInitE(&mixedeffect[i]);
+#endif
     }
+#if 0  /* fq*() functions not yet implemented... */
     fqInitE(&damageeffect);
+#endif
 }
 
 
@@ -404,6 +420,11 @@
     sdword streamersize;
     char loadfile[100];
     sdword i, j;
+    
+#ifdef ENDIAN_BIG
+    sdword p, z;
+#endif
+
 #if 0
     sdword numoffsets;
     sdword index;
@@ -418,7 +439,26 @@
 #else
     strcat(loadfile, "speechsentence_comp.lut");
 #endif
-    fileLoadAlloc(loadfile, &SentenceLUT, NonVolatile);
+    fileLoadAlloc(loadfile, (void**)&SentenceLUT, NonVolatile);
+
+#ifdef ENDIAN_BIG
+	SentenceLUT->ID         = LittleLong( SentenceLUT->ID );
+	SentenceLUT->checksum   = LittleLong( SentenceLUT->checksum );
+	SentenceLUT->numcolumns = LittleShort( SentenceLUT->numcolumns );
+	SentenceLUT->numevents  = LittleShort( SentenceLUT->numevents );
+	SentenceLUT->numactors  = LittleShort( SentenceLUT->numactors );
+#if defined(Downloadable) || defined(DLPublicBeta)
+	SentenceLUT->compbitrate[3] = LittleShort( SentenceLUT->compbitrate[3] );
+#else
+	SentenceLUT->compbitrate[0] = LittleShort( SentenceLUT->compbitrate[0] );
+	SentenceLUT->compbitrate[1] = LittleShort( SentenceLUT->compbitrate[1] );
+	SentenceLUT->compbitrate[2] = LittleShort( SentenceLUT->compbitrate[2] );
+	SentenceLUT->compbitrate[3] = LittleShort( SentenceLUT->compbitrate[3] );
+#endif // Downloadable
+	for ( z=0; z< (SentenceLUT->numcolumns*(SentenceLUT->numactors*SentenceLUT->numevents)); z++){
+		SentenceLUT->lookup[z] = LittleShort( SentenceLUT->lookup[z] );
+	}
+#endif // ENDIAN_BIG
 
     strcpy(loadfile, SOUNDFXDIR);
 #ifdef CGW
@@ -428,7 +468,18 @@
 #else
     strcat(loadfile, "speechphrase_comp.lut");
 #endif
-    fileLoadAlloc(loadfile, &PhraseLUT, NonVolatile);
+    fileLoadAlloc(loadfile, (void**)&PhraseLUT, NonVolatile);
+
+#ifdef ENDIAN_BIG
+	PhraseLUT->ID = LittleLong( PhraseLUT->ID );
+	PhraseLUT->checksum = LittleLong( PhraseLUT->checksum );
+	PhraseLUT->numcolumns = LittleShort( PhraseLUT->numcolumns );
+	PhraseLUT->numsentences = LittleShort( PhraseLUT->numsentences );
+
+	for ( p=0; p< (PhraseLUT->numcolumns*PhraseLUT->numsentences); p++){
+		PhraseLUT->lookupsy[p] = LittleShort( PhraseLUT->lookupsy[p] );
+	}
+#endif
 
     /* verify sentence and phrase luts */
     if (SentenceLUT->checksum != PhraseLUT->checksum)
@@ -507,7 +558,13 @@
     /* load the music header file */
     strcpy(loadfile, SOUNDFXDIR);
     strcat(loadfile,musicHeaderName);
-    fileLoadAlloc(loadfile, &musicheader, NonVolatile);
+    fileLoadAlloc(loadfile, (void**)&musicheader, NonVolatile);
+
+#ifdef ENDIAN_BIG
+	musicheader->ID = LittleLong( musicheader->ID );
+	musicheader->checksum = LittleLong( musicheader->checksum );
+	musicheader->numstreams = LittleLong( musicheader->numstreams );
+#endif
 
     /* open music file and compare checksums */
     strcpy(loadfile,utyMusicFilename);
@@ -584,7 +641,6 @@
 void speechEventUpdate(void)
 {
     /* must call this so the streamer gets updated */
-    soundupdate();
     speechQueueUpdate();
 }
 
@@ -642,8 +698,13 @@
         }
 
         /* are we ready to play something? */
+#if 0   /* For reasons of Bink... */
         if ((pSQueue->status == SOUND_STOPPED) && (pSQueue->nextevent >= SOUND_OK) && (!pSQueue->locked) &&
             (((universe.totaltimeelapsed - pSQueue->timeover) >= SPEECH_PAUSE) || !gameIsRunning || !binkDonePlaying || FalkosFuckedUpTutorialFlag))
+#else
+        if ((pSQueue->status == SOUND_STOPPED) && (pSQueue->nextevent >= SOUND_OK) && (!pSQueue->locked) &&
+            (((universe.totaltimeelapsed - pSQueue->timeover) >= SPEECH_PAUSE) || !gameIsRunning || FalkosFuckedUpTutorialFlag))
+#endif
         {
             /* find the event that we should play */
 
@@ -1496,7 +1557,7 @@
 
         for (i = 0; i < MAX_RELIC_NAMES; i++)
         {
-            if (strnicmp(playerNames[ally], relicPlayerNames[i], MAX_PERSONAL_NAME_LEN) == 0)
+            if (strncasecmp(playerNames[ally], relicPlayerNames[i], MAX_PERSONAL_NAME_LEN) == 0)
             {
                 if (event == COMM_F_AllianceFormed)
                 {
@@ -1515,7 +1576,7 @@
     {
         for (i = 0; i < MAX_RELIC_NAMES; i++)
         {
-            if (strnicmp(playerNames[var], relicPlayerNames[i], MAX_PERSONAL_NAME_LEN) == 0)
+            if (strncasecmp(playerNames[var], relicPlayerNames[i], MAX_PERSONAL_NAME_LEN) == 0)
             {
                 var = i;
                 break;
diff -urPw homeworld-orig/src/Game/SpeechEvent.h homeworld_sdl-0.3/src/Game/SpeechEvent.h
--- homeworld-orig/src/Game/SpeechEvent.h	2002-09-04 12:46:20.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/SpeechEvent.h	2004-08-01 22:35:31.000000000 -0700
@@ -1,3 +1,6 @@
+//#if defined(__LITTLE_ENDIAN__)
+#ifndef ENDIAN_BIG
+
 /* Actor Flags */
 #define ACTOR_PILOT_FLAG						1024        //  0x00000400
 #define ACTOR_FLEETCOMMAND_FLAG					2048        //  0x00000800
@@ -28,6 +31,40 @@
 #define SPEECH_FLAG_MASK						4193280		//	0x003FFC00
 #define SPEECH_TYPE_MASK						4026531840	//	0xFFC00000
 
+#else // we are PPC/BIG_ENDIAN!!!
+
+    /* Actor Flags */
+    #define ACTOR_PILOT_FLAG						0x04000000
+    #define ACTOR_FLEETCOMMAND_FLAG					0x08000000
+    #define ACTOR_FLEETINTEL_FLAG					0x10000000
+    #define ACTOR_TRADERS_FLAG						0x20000000
+    #define ACTOR_PIRATES2_FLAG						0x40000000
+    #define ACTOR_ALLSHIPSENEMY_FLAG				0x80000000
+    #define ACTOR_AMBASSADOR_FLAG					0x00000001
+    #define ACTOR_NARRATOR_FLAG                     0x00000002
+    #define ACTOR_DEFECTOR_FLAG						0x00000004
+    #define ACTOR_GENERAL_FLAG						0x00000008
+    #define ACTOR_EMPEROR_FLAG						0x00000010
+    #define ACTOR_KHARSELIM_FLAG					0x00000020
+    
+    /* Speech Type Flags */
+    #define SPEECH_GROUP_FLAG						0x00000080
+    #define SPEECH_CHATTER_FLAG						0x00000100
+    #define SPEECH_STATUS_FLAG						0x00000200
+    #define SPEECH_COMMAND_FLAG						0x00000400
+    #define SPEECH_TUTORIAL_FLAG					0x00000800
+    #define SPEECH_SINGLEPLAYER_FLAG				0x00001000
+    #define SPEECH_NIS_FLAG							0x00002000
+    #define SPEECH_ANIMATIC_FLAG					0x00004000
+    #define SPEECH_ALWAYSPLAY_FLAG					0x00008000
+    
+    /* Speech Masks */
+    #define SPEECH_EVENT_MASK						0x03FF0000
+    #define SPEECH_FLAG_MASK						0xFC00003F
+    #define SPEECH_TYPE_MASK						0x0000FFC0
+    
+#endif
+
 
 /******************************************
 ****                                   ****
diff -urPw homeworld-orig/src/Game/Star3d.c homeworld_sdl-0.3/src/Game/Star3d.c
--- homeworld-orig/src/Game/Star3d.c	2002-09-04 12:46:20.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Star3d.c	2004-08-01 22:35:36.000000000 -0700
@@ -8,12 +8,12 @@
 
 #include <stdlib.h>
 #include <math.h>
-#include "types.h"
-#include "vector.h"
-#include "matrix.h"
-#include "memory.h"
-#include "star3d.h"
-#include "randy.h"
+#include "Types.h"
+#include "Vector.h"
+#include "Matrix.h"
+#include "Memory.h"
+#include "Star3d.h"
+#include "Randy.h"
 
 /*=============================================================================
     Data:
diff -urPw homeworld-orig/src/Game/Star3d.h homeworld_sdl-0.3/src/Game/Star3d.h
--- homeworld-orig/src/Game/Star3d.h	2002-09-04 12:46:20.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Star3d.h	2004-08-01 22:35:36.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___STAR3D_H
 #define ___STAR3D_H
 
-#include "types.h"
-#include "vector.h"
+#include "Types.h"
+#include "Vector.h"
 #include "color.h"
 
 /*=============================================================================
diff -urPw homeworld-orig/src/Game/Stats.c homeworld_sdl-0.3/src/Game/Stats.c
--- homeworld-orig/src/Game/Stats.c	2002-09-04 12:46:20.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Stats.c	2004-08-01 22:35:36.000000000 -0700
@@ -8,18 +8,18 @@
 
 #include <string.h>
 #include <stdarg.h>
-#include "types.h"
-#include "spaceobj.h"
-#include "universe.h"
-#include "univupdate.h"
-#include "file.h"
-#include "tweak.h"
-#include "stats.h"
-#include "fastmath.h"
-#include "singleplayer.h"
-#include "crc32.h"
-#include "researchapi.h"
-#include "netcheck.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "Universe.h"
+#include "UnivUpdate.h"
+#include "File.h"
+#include "Tweak.h"
+#include "Stats.h"
+#include "FastMath.h"
+#include "SinglePlayer.h"
+#include "CRC32.h"
+#include "ResearchAPI.h"
+#include "NetCheck.h"
 
 #define STATLOG_FILENAME "statlog.txt"
 
@@ -619,7 +619,6 @@
 {
     Node *curnode = universe.mainCommandLayer.todolist.head;
     CommandToDo *command;
-    sdword numCommands = universe.mainCommandLayer.todolist.num;
     SelectCommand *selection;
     sdword numShips;
     sdword i;
@@ -1360,7 +1359,7 @@
 void statsPrintTable(void)
 {
     ShipRace racei,racej;
-    filehandle tablefileFH = fileOpen("stattable.txt", FF_IgnoreBIG | FF_WriteMode | FF_TextMode);
+    filehandle tablefileFH = fileOpen("stattable.txt", FF_IgnoreBIG | FF_WriteMode | FF_TextMode | FF_UserSettingsPath);
     FILE *tablefile;
 
     dbgAssert(!fileUsingBigfile(tablefileFH));
@@ -1945,13 +1944,13 @@
 // strength of fleet2 against fleet1, e.g. fleet2/fleet1
 real32 statsGetRelativeFleetStrengths(SelectCommand *fleet1,SelectCommand *fleet2)
 {
-    sdword numShips1 = fleet1->numShips;
+    //sdword numShips1 = fleet1->numShips;
     sdword numShips2 = fleet2->numShips;
     sdword j;
-    real32 totalstr1 = 0.0f;
+    //real32 totalstr1 = 0.0f;
     real32 totalstr2 = 0.0f;
 
-    dbgAssert(numShips1 > 0);
+    //dbgAssert(numShips1 > 0);
     dbgAssert(numShips2 > 0);
 #if 0
     for (i=0;i<numShips1;i++)
@@ -1970,11 +1969,11 @@
 // strength of ship against fleet strength, e.g. targetstatic strength / fleet1 strength
 real32 statsGetRelativeFleetStrengthAgainstShip(SelectCommand *fleet1,ShipStaticInfo *targetstatic)
 {
-    sdword numShips1 = fleet1->numShips;
-    real32 totalstr1 = 0.0f;
+    //sdword numShips1 = fleet1->numShips;
+    //real32 totalstr1 = 0.0f;
     real32 totalstr2;
 
-    dbgAssert(numShips1 > 0);
+    //dbgAssert(numShips1 > 0);
 #if 0
     for (i=0;i<numShips1;i++)
     {
diff -urPw homeworld-orig/src/Game/StatScript.c homeworld_sdl-0.3/src/Game/StatScript.c
--- homeworld-orig/src/Game/StatScript.c	2002-09-04 12:46:20.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/StatScript.c	2004-08-01 22:35:18.000000000 -0700
@@ -9,21 +9,28 @@
 #include <math.h>
 #include <stdio.h>
 #include <string.h>
-#include "types.h"
-#include "objtypes.h"
-#include "debug.h"
-#include "memory.h"
-#include "file.h"
+#include <strings.h>
+#include <limits.h>
+#include "Types.h"
+#include "ObjTypes.h"
+#include "Debug.h"
+#include "Memory.h"
+#include "File.h"
 #include "color.h"
-#include "spaceobj.h"
-#include "formation.h"
-#include "statscript.h"
+#include "SpaceObj.h"
+#include "Formation.h"
+#include "StatScript.h"
 #include "texreg.h"
-#include "tactics.h"
-#include "mex.h"
-#include "multiplayerGame.h"
-#include "crates.h"
-#include "mothership.h"
+#include "Tactics.h"
+#include "MEX.h"
+#include "MultiplayerGame.h"
+#include "Crates.h"
+#include "Mothership.h"
+
+#ifdef _MSC_VER
+#define strcasecmp _stricmp
+#define strncasecmp strnicmp
+#endif
 
 //#define USE_SPHERE_TABLES
 
@@ -58,6 +65,8 @@
 extern scriptEntry GatherStatsScriptTable[];
 extern scriptEntry FrontEndColourTweaks[];
 
+char globalScriptFileName[50];  //file name of file loaded in a script callback function
+
 /*=============================================================================
     Private Defines:
 =============================================================================*/
@@ -236,7 +245,7 @@
 }
 #endif
 
-void scriptSetReal32CB_ARRAY(char *directory, char *field, real32 *dataToFillIn)
+void scriptSetReal32CB_ARRAY(char *directory, char *field, void *dataToFillIn)
 {
     char tactic_buffer[32];
     char class_buffer[64];
@@ -256,8 +265,8 @@
     CheckValidTacticsClass(tactic,shipclass,field);
 #endif
 
-    dataToFillIn += (tactic * (NUM_CLASSES + 1)) + shipclass;
-    *dataToFillIn = value;
+    (real32*)dataToFillIn += (tactic * (NUM_CLASSES + 1)) + shipclass;
+    *(real32*)dataToFillIn = value;
 }
 void scriptSetShipProbCB(char *directory, char *field, real32 *dataToFillIn)
 {
@@ -407,8 +416,8 @@
     {
         return(TRUE);
     }
-    if ((_stricmp(boolString, "TRUE") == 0) ||
-        (_stricmp(boolString, "YES") == 0))
+    if ((strcasecmp(boolString, "TRUE") == 0) ||
+        (strcasecmp(boolString, "YES") == 0))
     {
         return(TRUE);
     }
@@ -429,7 +438,7 @@
 {
     udword readval;
 
-    if (strnicmp(field, "BIT",3) == 0)
+    if (strncasecmp(field, "BIT",3) == 0)
     {
         sscanf(field+3,"%d", &readval);
 
@@ -441,7 +450,7 @@
 {
     udword readval;
 
-    if (strnicmp(field, "BIT",3) == 0)
+    if (strncasecmp(field, "BIT",3) == 0)
     {
         sscanf(field+3,"%d", &readval);
 
@@ -477,7 +486,7 @@
     *((real32 *)dataToFillIn) = cosine*cosine;
 }
 
-void scriptSetCosAngCB_ARRAY(char *directory, char *field, real32 *dataToFillIn)
+void scriptSetCosAngCB_ARRAY(char *directory, char *field, void *dataToFillIn)
 {
     char tactic_buffer[32];
     char class_buffer[64];
@@ -497,8 +506,8 @@
     CheckValidTacticsClass(tactic,shipclass,field);
 #endif
 
-    dataToFillIn += (tactic * (NUM_CLASSES + 1)) + shipclass;
-    *dataToFillIn = (real32)cos(DEG_TO_RAD(value));
+    (real32*)dataToFillIn += (tactic * (NUM_CLASSES + 1)) + shipclass;
+    *(real32*)dataToFillIn = (real32)cos(DEG_TO_RAD(value));
 }
 
 void scriptSetSinAngCB(char *directory,char *field,void *dataToFillIn)
@@ -867,7 +876,6 @@
                 foundentry->setVarCB(directory,value,foundentry->dataPtr);
             }
         }
-
     }
 
     fileClose(fh);
@@ -886,7 +894,7 @@
     FILE *fh;
     char line[MAX_LINE_CHARS];
     char *name, *value;
-    char fullfilename[80];
+    char fullfilename[PATH_MAX];
     scriptEntry *foundentry;
 
     if (directory != NULL)
@@ -1277,14 +1285,19 @@
 
 void scriptSetDockPointCB(char *directory,char *field,void *dataToFillIn)
 {
-    char docktypestr[30];
+    char docktypestr[30] = "";
+
     DockStaticPoint *dockstaticpoint = (DockStaticPoint *)dataToFillIn;
 
     RemoveCommasFromString(field);
 
-    sscanf(field,"%s %s %f %f %f %d %d",&dockstaticpoint->name,docktypestr,
-                               &dockstaticpoint->flyawaydist,&dockstaticpoint->mindist,&dockstaticpoint->maxdist,
-                               &dockstaticpoint->headingdirection, &dockstaticpoint->updirection);
+    sscanf(field,"%s %s %f %f %f %d %d", &dockstaticpoint->name,
+                                         docktypestr,
+                                         &dockstaticpoint->flyawaydist,
+                                         &dockstaticpoint->mindist,
+                                         &dockstaticpoint->maxdist,
+                                         &dockstaticpoint->headingdirection,
+                                         &dockstaticpoint->updirection);
 
     dockstaticpoint->type = StrToDockPointType(docktypestr);
 }
@@ -1543,7 +1556,7 @@
 
 void scriptSetSalvagePointCB(char *directory,char *field,void *dataToFillIn)
 {
-    char saltypestr[30];
+    char saltypestr[30] = "";
     SalvageStaticPoint *salvagestaticpoint = (SalvageStaticPoint *)dataToFillIn;
 
     RemoveCommasFromString(field);
diff -urPw homeworld-orig/src/Game/StatScript.h homeworld_sdl-0.3/src/Game/StatScript.h
--- homeworld-orig/src/Game/StatScript.h	2002-09-04 12:46:20.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/StatScript.h	2004-08-01 22:35:19.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___STATSCRIPT_H
 #define ___STATSCRIPT_H
 
-#include "types.h"
-#include "objtypes.h"
+#include "Types.h"
+#include "ObjTypes.h"
 
 /*=============================================================================
     Types:
@@ -34,7 +34,7 @@
 } scriptEntry;
 
 ///////DATA!!!!
-char globalScriptFileName[50];  //file name of file loaded in a script callback function
+extern char globalScriptFileName[50];  //file name of file loaded in a script callback function
 
 
 /*=============================================================================
@@ -42,13 +42,16 @@
 =============================================================================*/
 
 // for filling in scriptEntry
-#define makeEntry(var,callback) { str$(var),callback,&##var }
+#define makeEntry(var,callback) { str$(var),callback,&(var) }
 #define endEntry { NULL, NULL, 0 }
 
 /*=============================================================================
     Functions:
 =============================================================================*/
 
+struct StaticInfoHealthGuidanceShipDerelict;
+struct ShipStaticInfo;
+
 void RemoveCommasFromString(char *field);
 void StripTrailingSpaces(char *value);
 
diff -urPw homeworld-orig/src/Game/Stats.h homeworld_sdl-0.3/src/Game/Stats.h
--- homeworld-orig/src/Game/Stats.h	2002-09-04 12:46:20.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Stats.h	2004-08-01 22:35:36.000000000 -0700
@@ -6,9 +6,10 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "shipdefs.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "ShipDefs.h"
+#include "SpaceObj.h"
+#include "ShipSelect.h"
 
 #define NUM_SHIPS_TO_GATHER_STATS_FOR   (TOTAL_STD_SHIPS+TOTAL_STD_SHIPS+TOTAL_P1_SHIPS+TOTAL_P2_SHIPS+TOTAL_P3_SHIPS)
 
@@ -112,5 +113,6 @@
     Cheat detection:
 =============================================================================*/
 // returns a checksum of the statistics gathered by the game
-real32 statsGetStatsChecksum();
+/*real32 statsGetStatsChecksum();*/
+udword statsGetStatChecksum();
 
diff -urPw homeworld-orig/src/Game/Strings.c homeworld_sdl-0.3/src/Game/Strings.c
--- homeworld-orig/src/Game/Strings.c	2002-09-04 12:46:20.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Strings.c	2004-08-01 22:35:29.000000000 -0700
@@ -7,16 +7,19 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
+#ifdef _WIN32
 #define WIN32_LEAN_AND_MEAN
 #include <windows.h>
+#endif
+
 #include <string.h>
-#include "types.h"
-#include "memory.h"
-#include "statscript.h"
+#include "Types.h"
+#include "Memory.h"
+#include "StatScript.h"
 #include "Strings.h"
-#include "debug.h"
+#include "Debug.h"
 
-#define strEntry(var)  {#var,strSetStringCB,&MessageStrings[##var]}
+#define strEntry(var)  {#var,strSetStringCB,&MessageStrings[var]}
 
 udword strCurLanguage=0;
 udword strCurKeyboardLanguage=0;
@@ -553,7 +556,7 @@
     strEntry(strHOMEKEY),
     strEntry(strPAGEDOWNKEY),
     strEntry(strPAGEUPKEY),
-    strEntry(strBACKSLASHKEY,),
+    strEntry(strBACKSLASHKEY),
     strEntry(strPAUSEKEY),
     strEntry(strSCROLLKEY),
     strEntry(strPRINTKEY),
@@ -680,6 +683,7 @@
 
 void strSetCurKeyboard(void)
 {
+#ifdef _WIN32
     udword keyboard;
 
     if (keyboard = GetKeyboardLayout(0))
@@ -706,6 +710,7 @@
         }
     }
     else
+#endif
         strCurKeyboardLanguage = languageEnglish;
 }
 
@@ -720,13 +725,16 @@
 bool8 strLoadLanguage(strLanguageType language)
 {
     udword i;
+#ifdef _WIN32
     udword keyboard;
+#endif
 
     for (i=0;i<NumStrings;i++)
     {
         MessageStrings[i]=crapMessage;
     }
 
+#ifdef _WIN32
     if (keyboard = GetKeyboardLayout(0))
     {
         if (PRIMARYLANGID(keyboard)==LANG_ENGLISH)
@@ -751,6 +759,7 @@
         }
     }
     else
+#endif
         strCurKeyboardLanguage = languageEnglish;
 
     if (strInitialized==TRUE)
@@ -817,10 +826,10 @@
     Outputs     : none
     Return      : none
 ----------------------------------------------------------------------------*/
-void strSetStringCB(char *directory,char *field,void **dataToFillIn)
+void strSetStringCB(char *directory,char *field,void *dataToFillIn)
 {
-    *dataToFillIn = (void *)memStringDupe(field);
-    *dataToFillIn = strParseString(*dataToFillIn);
+    *(void**)dataToFillIn = (void *)memStringDupe(field);
+    *(void**)dataToFillIn = strParseString(*(void**)dataToFillIn);
 }
 
 
diff -urPw homeworld-orig/src/Game/Strings.h homeworld_sdl-0.3/src/Game/Strings.h
--- homeworld-orig/src/Game/Strings.h	2002-09-04 12:46:20.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Strings.h	2004-08-01 22:35:29.000000000 -0700
@@ -8,6 +8,7 @@
 #ifndef ___STRINGS_H
 #define ___STRINGS_H
 
+#include "Types.h"
 #include "StringsOnly.h"
 // try not to include many files in here since strings.h may be included by jpeg files, etc.
 
diff -urPw homeworld-orig/src/Game/Tactical.c homeworld_sdl-0.3/src/Game/Tactical.c
--- homeworld-orig/src/Game/Tactical.c	2002-09-04 12:46:20.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Tactical.c	2004-08-01 22:35:27.000000000 -0700
@@ -7,22 +7,27 @@
 =============================================================================*/
 
 #include <stdio.h>
-#include "types.h"
-#include "memory.h"
-#include "debug.h"
-#include "statscript.h"
-#include "spaceobj.h"
-#include "universe.h"
-#include "teams.h"
-#include "vector.h"
-#include "tactical.h"
-#include "ships.h"
+#include <strings.h>
+#include "Types.h"
+#include "Memory.h"
+#include "Debug.h"
+#include "StatScript.h"
+#include "SpaceObj.h"
+#include "Universe.h"
+#include "Teams.h"
+#include "Vector.h"
+#include "Tactical.h"
+#include "Ships.h"
 #include "main.h"
 #include "utility.h"
 #include "render.h"
-#include "alliance.h"
-#include "sensors.h"
-#include "blobs.h"
+#include "Alliance.h"
+#include "Sensors.h"
+#include "Blobs.h"
+
+#ifdef _MSC_VER
+#define strcasecmp _stricmp
+#endif
 
 extern fonthandle selGroupFont2;
 
@@ -43,7 +48,7 @@
 //basic, default TO icon
 toicon toDefaultIcon =
 {
-    0, {0.0f ,0.0f}
+    0, {{0.0f, 0.0f}}
 };
 
 //to icons for all classes of ships + 1 for mines
@@ -131,7 +136,7 @@
 -----------------------------------------------------------------------------*/
 void toNewClassSet(char *directory,char *field,void *dataToFillIn)
 {                                                           //set new ship class
-    if (_stricmp(field,"CLASS_Mine") == 0)
+    if (strcasecmp(field,"CLASS_Mine") == 0)
     {
         toCurrentClass = NUM_CLASSES;   // use NUM_CLASSES to indicate mine
     }
diff -urPw homeworld-orig/src/Game/Tactical.h homeworld_sdl-0.3/src/Game/Tactical.h
--- homeworld-orig/src/Game/Tactical.h	2002-09-04 12:46:20.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Tactical.h	2004-08-01 22:35:28.000000000 -0700
@@ -8,11 +8,11 @@
 #ifndef ___TACTICAL_H
 #define ___TACTICAL_H
 
-#include "types.h"
+#include "Types.h"
 #include "color.h"
 #include "prim2d.h"
 #include "utility.h"
-#include "objtypes.h"
+#include "ObjTypes.h"
 
 /*=============================================================================
     Switches:
diff -urPw homeworld-orig/src/Game/Tactics.c homeworld_sdl-0.3/src/Game/Tactics.c
--- homeworld-orig/src/Game/Tactics.c	2002-09-04 12:46:20.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Tactics.c	2004-08-01 22:35:28.000000000 -0700
@@ -5,34 +5,37 @@
 =============================================================================*/
 #include <stdlib.h>
 
-#include "tactics.h"
-#include "univupdate.h"
-#include "statscript.h"
-#include "region.h"
-#include "feflow.h"
+#include "Tactics.h"
+#include "UnivUpdate.h"
+#include "StatScript.h"
+#include "Region.h"
+#include "FEFlow.h"
 #include "mainrgn.h"
-#include "task.h"
-#include "universe.h"
-#include "physics.h"
-#include "classdefs.h"
-#include "types.h"
-#include "commandlayer.h"
-#include "tweak.h"
-#include "blobs.h"
-#include "proximitySensor.h"
-#include "formation.h"
-#include "fastmath.h"
-#include "repaircorvette.h"
-#include "flightman.h"
+#include "Task.h"
+#include "Universe.h"
+#include "Physics.h"
+#include "ClassDefs.h"
+#include "Types.h"
+#include "CommandLayer.h"
+#include "Tweak.h"
+#include "Blobs.h"
+#include "ProximitySensor.h"
+#include "Formation.h"
+#include "FastMath.h"
+#include "RepairCorvette.h"
+#include "FlightMan.h"
 #include "mouse.h"
-#include "salcapcorvette.h"
-#include "alliance.h"
+#include "SalCapCorvette.h"
+#include "Alliance.h"
 #include "Probe.h"
-#include "randy.h"
-#include "soundevent.h"
-#include "battle.h"
+#include "Randy.h"
+#include "SoundEvent.h"
+#include "Battle.h"
 
 //global data
+BabyCallBack    *tacticsFlashMenuBaby;
+regionhandle    tacticsMenuRegion;
+
 //special ops tweakables
 real32 kamikazeDamage[TOTAL_NUM_SHIPS];
 real32 kamikazeSpeedBurst;
@@ -78,6 +81,8 @@
 //special ops prototype
 void speedBurstUpdate(Ship *ship);
 
+TacticsInfo tacticsInfo;
+
 scriptEntry TacticsInfotable[] =
 {
     { "EnemyNearZone" ,scriptSetReal32CB, &tacticsInfo.EnemyNearZone},
@@ -713,12 +718,10 @@
 
 void tacticsDoDodge(Ship *ship)
 {
-    ShipStaticInfo *shipstaticinfo=ship->staticinfo;
 #ifdef DEBUG_TACTICS
     dbgAssert(tacticsOn);
 #endif
 
-
     physApplyForceToObj((SpaceObj *)ship,ship->staticinfo->thruststrengthstat[ship->DodgeDir]*tacticsInfo.DodgeInfo[DODGE_THRUST_MULT][ship->staticinfo->shiptype],ship->DodgeDir);
     if(universe.totaltimeelapsed > ship->DodgeTime)
     {
@@ -879,7 +882,7 @@
                 }
             }
         }
-nextnode:
+
         node = node->next;
     }
 }
@@ -1111,6 +1114,8 @@
   //      }
   //      tacticsSpeechForRetaliation(ship);
         break;
+    default:
+        break;
     }
 
 }
@@ -1178,6 +1183,8 @@
         //clPassiveAttack(comlayer,selectone,attack);
         //tacticsSpeechForRetaliation(ship);
         break;
+    default:
+        break;
     }
 
 }
@@ -2056,7 +2063,6 @@
     sdword objindex = 0;
     SelectCommand *blobships = thisblob->blobShips;
     udword num = blobships->numShips;
-    udword shipIndex = 0;
     Ship *ship;
     vector diff;
     real32 timesincecloak;
diff -urPw homeworld-orig/src/Game/Tactics.h homeworld_sdl-0.3/src/Game/Tactics.h
--- homeworld-orig/src/Game/Tactics.h	2002-09-04 12:46:20.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Tactics.h	2004-08-01 22:35:28.000000000 -0700
@@ -7,11 +7,11 @@
 #ifndef TACTICS_H
 #define TACTICS_H
 
-#include "spaceobj.h"
-#include "objtypes.h"
-#include "task.h"
-#include "region.h"
-#include "select.h"
+#include "SpaceObj.h"
+#include "ObjTypes.h"
+#include "Task.h"
+#include "Region.h"
+#include "Select.h"
 #include "mainswitches.h"
 
 // comment this bitch out and no more tacticsOn crap
@@ -114,7 +114,7 @@
     real32 tacticsDamageModifierYellow;
 } TacticsInfo;
 
-TacticsInfo tacticsInfo;
+extern TacticsInfo tacticsInfo;
 
 //special operation tweakables
 extern real32 kamikazeDamage[TOTAL_NUM_SHIPS];
@@ -139,8 +139,8 @@
 
 //data
 
-BabyCallBack    *tacticsFlashMenuBaby;
-regionhandle    tacticsMenuRegion;
+extern BabyCallBack    *tacticsFlashMenuBaby;
+extern regionhandle    tacticsMenuRegion;
 //ProtoTypes
 
 void tacticsStartUp();
diff -urPw homeworld-orig/src/Game/TaskBar.c homeworld_sdl-0.3/src/Game/TaskBar.c
--- homeworld-orig/src/Game/TaskBar.c	2002-09-04 12:46:22.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/TaskBar.c	2004-08-01 22:35:25.000000000 -0700
@@ -9,30 +9,35 @@
 #include <stdlib.h>
 #include <stdio.h>
 #include <string.h>
-#include "types.h"
-#include "debug.h"
-#include "memory.h"
-#include "universe.h"
-#include "region.h"
+#include <strings.h>
+#include "Types.h"
+#include "Debug.h"
+#include "Memory.h"
+#include "Universe.h"
+#include "Region.h"
 #include "mainrgn.h"
-#include "select.h"
-#include "feflow.h"
+#include "Select.h"
+#include "FEFlow.h"
 #include "utility.h"
 #include "font.h"
-#include "fontreg.h"
-#include "sensors.h"
-#include "globals.h"
-#include "taskbar.h"
+#include "FontReg.h"
+#include "Sensors.h"
+#include "Globals.h"
+#include "TaskBar.h"
 #include "main.h"
-#include "infooverlay.h"
-#include "objectives.h"
-#include "tutor.h"
-#include "objtypes.h"
-#include "launchmgr.h"
-#include "singleplayer.h"
-#include "strings.h"
+#include "InfoOverlay.h"
+#include "Objectives.h"
+#include "Tutor.h"
+#include "ObjTypes.h"
+#include "LaunchMgr.h"
+#include "SinglePlayer.h"
+#include "Strings.h"
 #include "FEColour.h"
-#include "subtitle.h"
+#include "Subtitle.h"
+
+#ifdef _MSC_VER
+#define strcasecmp _stricmp
+#endif
 
 
 /*=============================================================================
@@ -846,7 +851,7 @@
 {
     sdword     x, y;
     fonthandle oldfont;
-    uiclistitem  *item = data, *listitem;
+    uiclistitem  *listitem;
     tasklistitem  *taskitem = (tasklistitem *)(data->data);
     Objective *objective = (Objective *)((tasklistitem *)(data->data))->objective, *obj;
     char text[TBL_MaxCharsPerLine];
@@ -1313,6 +1318,8 @@
         case Aggressive:
             tbShipsAggr++;
             break;
+        default:
+            break;
         }
 
         /*
@@ -1332,7 +1339,7 @@
 {
     sdword width;
     fonthandle oldfont;
-    rectangle rect = region->rect;
+    //rectangle rect = region->rect;
 
     oldfont = fontMakeCurrent(tbObjectiveFont);
 
@@ -1352,7 +1359,7 @@
 {
     sdword width;
     fonthandle oldfont;
-    rectangle rect = region->rect;
+    //rectangle rect = region->rect;
 
     oldfont = fontMakeCurrent(tbButtonCaptionFont);
 
@@ -1433,6 +1440,8 @@
         //SetAtom(tbAtomN, FALSE);
         dbgMessage("\nA");
         break;
+    default:
+        break;
     }
 }
 
@@ -1506,7 +1515,7 @@
     {
         atom = &tbScreen->atoms[i];
         if (atom->name != NULL &&
-            _stricmp(atom->name, name) == 0)
+            strcasecmp(atom->name, name) == 0)
         {
             return (regionhandle)atom->region;
         }
diff -urPw homeworld-orig/src/Game/TaskBar.h homeworld_sdl-0.3/src/Game/TaskBar.h
--- homeworld-orig/src/Game/TaskBar.h	2002-09-04 12:46:22.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/TaskBar.h	2004-08-01 22:35:25.000000000 -0700
@@ -9,11 +9,11 @@
 #ifndef ___TASKBAR_H
 #define ___TASKBAR_H
 
-#include "types.h"
-#include "region.h"
-#include "feflow.h"
+#include "Types.h"
+#include "Region.h"
+#include "FEFlow.h"
 #include "FEColour.h"
-#include "uicontrols.h"
+#include "UIControls.h"
 
 /*=============================================================================
     Switches:
@@ -38,7 +38,11 @@
     Definitions:
 =============================================================================*/
 //general definitions
+#ifdef _WIN32
 #define TB_FileName             "FEMan\\TaskBar.fib"//filename of taskbar feman file
+#else
+#define TB_FileName             "FEMan/TaskBar.fib" /*filename of taskbar feman file*/
+#endif
 #define TB_ScreenName           "Task_Bar"      //name of the taskbar FEMan screen
 #define TB_FleetManager         "TB_Fleet"      //entry points/function callbacks
 #define TB_SensorsManager       "TB_Sensors"
@@ -75,6 +79,8 @@
 /*=============================================================================
     Type definitions:
 =============================================================================*/
+struct taskbutton;
+
 //taskbar button callback function
 typedef void (*tbfunction)(struct taskbutton *button, ubyte *userData);
 
diff -urPw homeworld-orig/src/Game/Task.c homeworld_sdl-0.3/src/Game/Task.c
--- homeworld-orig/src/Game/Task.c	2002-09-04 12:46:22.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Task.c	2004-08-01 22:35:24.000000000 -0700
@@ -10,12 +10,12 @@
 #include <stdio.h>
 #include <string.h>
 
-#include "types.h"
-#include "debug.h"
-#include "memory.h"
-#include "demo.h"
+#include "Types.h"
+#include "Debug.h"
+#include "Memory.h"
+#include "Demo.h"
 #include "TitanInterfaceC.h"
-#include "task.h"
+#include "Task.h"
 
 /*=============================================================================
     Data:
@@ -25,6 +25,8 @@
 sdword taskMaxTask;                             //highest indexed task enabled
 sdword taskModuleInit = FALSE;
 
+CallBacks callbacks;
+
 //speed of task timer, in Hz
 real32 taskFrequency;
 
@@ -127,7 +129,7 @@
 #if TASK_TEST                                               //test this crazy module
     {
         taskhandle handle;
-        handle = taskStart(taskTestFunction, 1, 4096, TF_OncePerFrame);
+        handle = taskStart(taskTestFunction, 1, TF_OncePerFrame);
         taskRename(handle, "Task this you commie bastards!");
         taskExecuteAllPending(1);
         taskExecuteAllPending(1);
@@ -199,9 +201,8 @@
 
 #if TASK_ERROR_CHECKING
     dbgFatalf(DBG_Loc, "All %d task pointers in use.", taskMaxTask);
-#else
-    return(ERROR);
 #endif
+    return(ERROR);
 }
 
 /*-----------------------------------------------------------------------------
@@ -252,14 +253,27 @@
     newTask->ticksPerCall = (udword)(period * taskFrequency);//save ticks per call
 
 #if DBG_STACK_CONTEXT
+#ifndef C_ONLY
+#if defined (_MSC_VER)
     _asm
     {
         mov     eax, esp
         mov     dbgStackBase, eax
     }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ (
+        "    movl %%esp, %%eax\n"
+        "    movl %%eax, %0\n"
+        : "=m" (dbgStackBase)
+        :
+        : "eax" );
+#endif
+#endif // C_ONLY
 #endif//DBG_STACK_CONTEXT
     //now that stack is created OK, let's call it's handler function to start it
     taskFunctionContinueSave = taskFunctionContinue;
+#ifndef C_ONLY
+#if defined (_MSC_VER)
     _asm
     {
         mov     eax, OFFSET taskContinued
@@ -324,6 +338,84 @@
         mov     eax, [taskEBXSave]
         mov     ebx, eax
     }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ (
+        "    movl $(taskStart_taskContinued), %%eax\n"      /*set point to continue from*/
+        "    movl %%eax, %0\n"
+        : "=m" (taskFunctionContinue)
+        :
+        : "eax" );
+
+        /*taskCurrentTask = handle;*/
+
+    __asm__ __volatile__ (
+        "    movl %%esi, %%eax\n"
+        "    movl %%eax, %0\n"                              /*save esi,edi*/
+        "    movl %%edi, %%eax\n"
+        "    movl %%eax, %1\n"
+
+        "    movl %%esp, %%eax\n"
+        "    movl %%eax, %2\n"
+#if TASK_STACK_SAVE
+        "    movl %%eax, %8\n"
+#endif
+
+        "    movl %%ebp, %%eax\n"
+        "    movl %%eax, %3\n"
+
+        "    movl %%ebx, %%eax\n"
+        "    movl %%eax, %4\n"
+        "    movl %5, %%eax\n"
+
+        "    jmp  *%%eax\n"                                 /*call the function*/
+
+        "taskStart_taskContinued:\n"
+        "    movl %6, %%edx\n"                              /*get edx->taskdata structure*/
+        "    shll $2, %%edx\n"
+        "    addl %7, %%edx\n"
+        "    movl (%%edx), %%edx\n"
+
+        "    popl %%eax\n"                                  /*get return IP from stack (jumped here via a CALL)*/
+        "    movl %%eax, "TOF_Context_STR"+24(%%edx)\n"     /*eip*/
+        "    movl %%ebx, %%eax\n"
+        "    movl %%eax, "TOF_Context_STR"+0(%%edx)\n"      /*ebx*/
+        "    movl %%ecx, %%eax\n"
+        "    movl %%eax, "TOF_Context_STR"+4(%%edx)\n"      /*ecx*/
+        "    movl %%edi, %%eax\n"
+        "    movl %%eax, "TOF_Context_STR"+8(%%edx)\n"      /*edi*/
+        "    movl %%esi, %%eax\n"
+        "    movl %%eax, "TOF_Context_STR"+12(%%edx)\n"     /*esi*/
+        "    movl %%esp, %%eax\n"
+        "    movl %%eax, "TOF_Context_STR"+16(%%edx)\n"     /*esp*/
+        "    movl %%ebp, %%eax\n"
+        "    movl %%eax, "TOF_Context_STR"+20(%%edx)\n"     /*ebp*/
+
+        "    movl %0, %%eax\n"                          /*restore esi,edi,ebp,esp*/
+        "    movl %%eax, %%esi\n"
+        "    movl %1, %%eax\n"
+        "    movl %%eax, %%edi\n"
+        "    movl %2, %%eax\n"
+        "    movl %%eax, %%esp\n"
+        "    movl %3, %%eax\n"
+        "    movl %%eax, %%ebp\n"
+        "    movl %4, %%eax\n"
+        "    movl %%eax, %%ebx\n"
+        :
+        : "m" (taskESISave), "m" (taskEDISave), "m" (taskESPSave),
+          "m" (taskEBPSave), "m" (taskEBXSave),
+          "m" (function), "m" (handle), "m" (taskData)
+#if TASK_STACK_SAVE
+          , "m" (taskESPSaveInitial)
+#endif
+        : "eax", "edx" );
+#else
+#error Function uses inline x86 assembly.
+#endif
+
+#else  // C_ONLY
+	function();  // calling the taskfunction 'function' pointer argument that this function was given
+#endif // C_ONLY
+
 #if TASK_STACK_SAVE
     taskESPDiff = (sdword)(taskESPSaveInitial - taskData[handle]->esp);
     dbgAssert(taskESPDiff >= 0);
@@ -385,6 +477,12 @@
     static udword localStackSize;
     static udword biggestStackSize;
 #endif
+#if defined (__GNUC__) // && defined (__i386__)
+    /* See "taskExec_taskReturned" assembly block for an explanation. */
+    static ubyte continue_hack;
+    continue_hack = 1;
+#endif
+
 /*
 #if TASK_STACK_CHECKING                                     //set the stack underflow detection cookie
     udword validationCookie;
@@ -398,11 +496,22 @@
 #endif
 
 #if DBG_STACK_CONTEXT
+#ifndef C_ONLY
+#if defined (_MSC_VER)
     _asm
     {
         mov     eax, esp
         mov     dbgStackBase, eax
     }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ (
+        "    movl %%esp, %%eax\n"
+        "    movl %%eax, %0\n"
+        : "=m" (dbgStackBase)
+        :
+        : "eax" );
+#endif
+#endif // C_ONLY
 #endif//DBG_STACK_CONTEXT
     if (taskModuleInit == FALSE)
     {   //don't do a taskInitCheck because this sometimes gets called on exiting,
@@ -427,6 +536,8 @@
     dbgAssert(taskCurrentTask == -1);                       //verify we're not in any task currently
 
     //save the global task execution pointers
+#ifndef C_ONLY
+#if defined (_MSC_VER)
     _asm
     {
         mov     eax, OFFSET taskContinued
@@ -435,18 +546,38 @@
         mov     [taskFunctionReturn], eax
         mov     [taskFunctionExit], eax
     }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ (
+        "    movl $(taskExec_taskContinued), %%eax\n"
+        "    movl %%eax, %0\n"
+        "    movl $(taskExec_taskReturned), %%eax\n"
+        "    movl %%eax, %1\n"
+        "    movl %%eax, %2\n"
+        : "=m" (taskFunctionContinue), "=m" (taskFunctionReturn),
+          "=m" (taskFunctionExit)
+        :
+        : "eax" );
+#endif
+#endif // C_ONLY
 #if TASK_STACK_SAVE
     //save a chunk of the stack that might get overwritten by some of the tasks
     biggestStackSize = taskLargestLocals;
     if (biggestStackSize > 0)
     {
+#if defined (_MSC_VER)
         _asm
         {
             mov     [currentESP], esp
         }
+#elif defined (__GNUC__) && defined (__i386__)
+        __asm__ __volatile__ (
+            "    movl %%esp, %0\n"
+            : "=m" (currentESP) );
+#endif
         memcpy(localStack, currentESP, biggestStackSize);
     }
-#endif
+#endif // TASK_STACK_SAVE
+
     for (taskCurrentTask = 0; taskCurrentTask < taskMaxTask; taskCurrentTask++)
     {
         if (taskData[taskCurrentTask] != NULL)              //if this task is enabled
@@ -490,9 +621,11 @@
             }
 #endif
             //!!! needed?
+            //save the current register context
+#ifndef C_ONLY
+#if defined (_MSC_VER)
             _asm
             {
-                //save the current register context
                 mov     eax, esi
                 mov     [taskESISave], eax                  //save esi,edi,esp,ebp
                 mov     eax, edi
@@ -504,6 +637,24 @@
                 mov     eax, ebx
                 mov     [taskEBXSave], eax
             }
+#elif defined (__GNUC__) && defined (__i386__)
+            __asm__ __volatile__ (
+                "    movl %%esi, %%eax\n"
+                "    movl %%eax, %0\n"                      /*save esi,edi,esp,ebp*/
+                "    movl %%edi, %%eax\n"
+                "    movl %%eax, %1\n"
+                "    movl %%esp, %%eax\n"
+                "    movl %%eax, %2\n"
+                "    movl %%ebp, %%eax\n"
+                "    movl %%eax, %3\n"
+                "    movl %%ebx, %%eax\n"
+                "    movl %%eax, %4\n"
+                : "=m" (taskESISave), "=m" (taskEDISave), "=m" (taskESPSave),
+                  "=m" (taskEBPSave), "=m" (taskEBXSave)
+                :
+                : "eax" );
+#endif
+#endif // C_ONLY
             taskProcessIndex++;
 #if TASK_STACK_SAVE
             localStackSize = taskData[taskCurrentTask]->nBytesStack;
@@ -528,6 +679,8 @@
                 validationCookie = TSK_StackValidation + taskCurrentTask;
 #endif
 */
+#ifndef C_ONLY
+#if defined (_MSC_VER)
                 _asm
                 {
                     //restore register context from the taskdata structure
@@ -579,6 +732,66 @@
                     mov     [edx + TOF_Context + 20], eax   //ebp
 //#endif
                 }
+#elif defined (__GNUC__) && defined (__i386__)
+                __asm__ __volatile__ (
+                         /*restore register context from the taskdata structure*/
+
+                    "    movl %0, %%edx\n"                  /*get edx->taskdata structure*/
+                    "    shll $2, %%edx\n"
+                    "    addl %1, %%edx\n"
+                    "    movl (%%edx), %%eax\n"
+
+                    "    movl "TOF_Context_STR"+0(%%eax), %%edx\n"   /*ebx*/
+                    "    movl %%edx, %%ebx\n"
+                    "    movl "TOF_Context_STR"+4(%%eax), %%edx\n"   /*ecx*/
+                    "    movl %%edx, %%ecx\n"
+                    "    movl "TOF_Context_STR"+8(%%eax), %%edx\n"   /*edi*/
+                    "    movl %%edx, %%edi\n"
+                    "    movl "TOF_Context_STR"+12(%%eax), %%edx\n"  /*esi*/
+                    "    movl %%edx, %%esi\n"
+                    "    movl "TOF_Context_STR"+16(%%eax), %%edx\n"  /*esp*/
+                    "    movl %%edx, %%esp\n"
+                    "    movl "TOF_Context_STR"+20(%%eax), %%edx\n"  /*ebp*/
+                    "    movl %%edx, %%ebp\n"
+
+                    "    movl "TOF_Context_STR"+24(%%eax), %%edx\n"  /*eip*/
+                    "    jmp *%%edx\n"                      /*jump to the task*/
+
+                    "taskExec_taskContinued:\n"
+                         /*save register context to the taskdata structure*/
+                    "    movl %0, %%edx\n"                  /*get edx->taskdata structure*/
+                    "    shll $2, %%edx\n"
+                    "    addl %1, %%edx\n"
+                    "    movl (%%edx), %%edx\n"
+
+                    "    popl %%eax\n"                      /*get return IP from stack (jumped here via a CALL)*/
+                    "    movl %%eax, "TOF_Context_STR"+24(%%edx)\n"  /*eip*/
+                    "    movl %%ebx, %%eax\n"
+                    "    movl %%eax, "TOF_Context_STR"+0(%%edx)\n"   /*ebx*/
+                    "    movl %%ecx, %%eax\n"
+                    "    movl %%eax, "TOF_Context_STR"+4(%%edx)\n"   /*ecx*/
+                    "    movl %%edi, %%eax\n"
+                    "    movl %%eax, "TOF_Context_STR"+8(%%edx)\n"   /*edi*/
+                    "    movl %%esi, %%eax\n"
+                    "    movl %%eax, "TOF_Context_STR"+12(%%edx)\n"  /*esi*/
+/*#if TASK_STACK_CHECKING*/
+                    "    movl %%esp, %%eax\n"
+                    "    movl %%eax, "TOF_Context_STR"+16(%%edx)\n"  /*esp*/
+                    "    movl %%ebp, %%eax\n"
+                    "    movl %%eax, "TOF_Context_STR"+20(%%edx)\n"  /*ebp*/
+/*#endif*/
+                    :
+                    : "m" (taskCurrentTask), "m" (taskData)
+                    : "eax", "edx" );
+#endif
+
+#else  // C_ONLY
+
+	// Call current task function
+	taskData[taskCurrentTask]->function();
+
+#endif // C_ONLY
+
 /*
 #if TASK_STACK_CHECKING
                 if (taskData[taskCurrentTask]->esp < taskESPSave)
@@ -592,6 +805,8 @@
 */
             }
             //!!! needed?
+#ifndef C_ONLY
+#if defined (_MSC_VER)
             _asm
             {
                 mov     eax, [taskESISave]                  //restore esi,edi,ebp,esp
@@ -605,6 +820,24 @@
                 mov     eax, [taskEBXSave]
                 mov     ebx, eax
             }
+#elif defined (__GNUC__) && defined (__i386__)
+            __asm__ __volatile__ (
+                "    movl %0, %%eax\n"                      /*restore esi,edi,ebp,esp*/
+                "    movl %%eax, %%esi\n"
+                "    movl %1, %%eax\n"
+                "    movl %%eax, %%edi\n"
+                "    movl %2, %%eax\n"
+                "    movl %%eax, %%esp\n"
+                "    movl %3, %%eax\n"
+                "    movl %%eax, %%ebp\n"
+                "    movl %4, %%eax\n"
+                "    movl %%eax, %%ebx\n"
+                :
+                : "m" (taskESISave), "m" (taskEDISave), "m" (taskESPSave),
+                  "m" (taskEBPSave), "m" (taskEBXSave)
+                : "eax" );
+#endif
+#endif // C_ONLY
 #if TASK_STACK_SAVE
             if (localStackSize > 0)
             {                                           //if this task uses some local stack
@@ -620,6 +853,8 @@
                 //memcpy((ubyte *)(taskData[taskCurrentTask] + 1), ((ubyte *)taskData[taskCurrentTask]->esp), localStackSize);
             }
 #endif //TASK_STACK_SAVE
+#ifndef C_ONLY
+#if defined (_MSC_VER)
             continue;
 taskReturned:
             _asm
@@ -636,6 +871,36 @@
                 mov     eax, [taskEBXSave]
                 mov     ebx, eax
             }
+#elif defined (__GNUC__) && defined (__i386__)
+            /* The (unconditional) "continue" statement which immediately
+               preceded this block caused GCC to remove all the code following
+               it up to the end of the block, so we need to hack in a way to
+               force GCC not to do so...bleh... */
+            if (continue_hack)
+                continue;
+            __asm__ __volatile__ (
+                "\ntaskExec_taskReturned:\n"
+                "    popl %%eax\n"                          /*remove the IP from the stack because it got here from a CALL*/
+                "    movl %0, %%eax\n"                      /*restore esi,edi,ebp,esp*/
+                "    movl %%eax, %%esi\n"
+                "    movl %1, %%eax\n"
+                "    movl %%eax, %%edi\n"
+                "    movl %2, %%eax\n"
+                "    movl %%eax, %%esp\n"
+                "    movl %3, %%eax\n"
+                "    movl %%eax, %%ebp\n"
+                "    movl %4, %%eax\n"
+                "    movl %%eax, %%ebx\n"
+                :
+                : "m" (taskESISave), "m" (taskEDISave), "m" (taskESPSave),
+                  "m" (taskEBPSave), "m" (taskEBXSave)
+                : "eax" );
+#endif
+#else  // C_ONLY
+			if (continue_hack)
+                continue;
+#endif // C_ONLY
+
             taskStop(taskCurrentTask);                      //kill the task
         }
     }
@@ -855,9 +1120,10 @@
 
     taskYield(0);
 
+#ifndef C_ONLY
     while(1)
+#endif
     {
-
         taskStackSaveCond(0);
 
         babynode = callbacks.babies.head;
diff -urPw homeworld-orig/src/Game/Task.h homeworld_sdl-0.3/src/Game/Task.h
--- homeworld-orig/src/Game/Task.h	2002-09-04 12:46:22.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Task.h	2004-08-01 22:35:25.000000000 -0700
@@ -9,14 +9,14 @@
 #ifndef ___TASK_H
 #define ___TASK_H
 
-#include "types.h"
-#include "linkedlist.h"
+#include "Types.h"
+#include "LinkedList.h"
 
 /*=============================================================================
     Switches:
 =============================================================================*/
-#define TASK_STACK_SAVE_HACK    1               //save the stack for Windows 95 baby
-#define TASK_STACK_SAVE         1               //save local stack frame the task function may create
+#define TASK_STACK_SAVE_HACK    0               //save the stack for Windows 95 baby
+#define TASK_STACK_SAVE         0               //save local stack frame the task function may create
 
 #ifndef HW_Release
 
@@ -56,6 +56,7 @@
 
 //task structure constants
 #define TOF_Context             16                 //offset to start of saved context
+#define TOF_Context_STR         "16"               /*string version*/
 
 //taskStackSave/Restore definitions
 #define TSK_StackSaveExtra      2               //normally save return address and ESP in C functions
@@ -92,6 +93,7 @@
 }
 taskdata;
 
+struct BabyCallBack;
 typedef bool (*babyFuncCB)(udword num, void *data, struct BabyCallBack *baby);    //callback function
 
 typedef struct BabyCallBack
@@ -112,7 +114,7 @@
 
 #define BABY_CallBackPeriod   1.0f / 16.0f
 
-CallBacks callbacks;
+extern CallBacks callbacks;
 
 void taskCallBackInit();
 void taskCallBackShutDown();
@@ -162,8 +164,14 @@
 #endif
 
 //macros for task continuation and exiting
+#ifndef C_ONLY
 #define taskYield(n)    ((void (*)(void))taskFunctionContinue)()
 #define taskExit()     ((void (*)(void))taskFunctionExit)()
+#else
+#define taskYield(n)
+#define taskExit()
+#endif // C_ONLY
+
 //rename the memory block associated with a task
 #define taskRename(t, n)    memRename((void *)taskData[t], (n))
 
@@ -214,4 +222,3 @@
 //adjust attributes of tasks
 udword taskFrequencySet(taskhandle handle, udword frequency);
 #endif // ___TASK_H
-
diff -urPw homeworld-orig/src/Game/Teams.c homeworld_sdl-0.3/src/Game/Teams.c
--- homeworld-orig/src/Game/Teams.c	2002-09-04 12:46:22.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Teams.c	2004-08-01 22:35:22.000000000 -0700
@@ -8,15 +8,15 @@
 =============================================================================*/
 
 #include <stdio.h>
-#include "types.h"
-#include "memory.h"
-#include "debug.h"
-#include "statscript.h"
-#include "spaceobj.h"
-#include "universe.h"
-#include "statscript.h"
-#include "tactical.h"
-#include "teams.h"
+#include "Types.h"
+#include "Memory.h"
+#include "Debug.h"
+#include "StatScript.h"
+#include "SpaceObj.h"
+#include "Universe.h"
+#include "StatScript.h"
+#include "Tactical.h"
+#include "Teams.h"
 
 #define TE_DorkyCheaterBaseColor    colRGB(255, 62, 164)
 #define TE_DorkyCheaterStripeColor  colRGB(255, 62, 164)
diff -urPw homeworld-orig/src/Game/Teams.h homeworld_sdl-0.3/src/Game/Teams.h
--- homeworld-orig/src/Game/Teams.h	2002-09-04 12:46:22.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Teams.h	2004-08-01 22:35:22.000000000 -0700
@@ -10,10 +10,10 @@
 #ifndef ___TEAMS_H
 #define ___TEAMS_H
 
-#include "types.h"
+#include "Types.h"
 #include "color.h"
 #include "texreg.h"
-#include "globals.h"
+#include "Globals.h"
 
 /*=============================================================================
     Switches:
diff -urPw homeworld-orig/src/Game/Timer.c homeworld_sdl-0.3/src/Game/Timer.c
--- homeworld-orig/src/Game/Timer.c	2002-09-04 12:46:22.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Timer.c	2004-08-01 22:35:36.000000000 -0700
@@ -2,7 +2,7 @@
 #include <stdlib.h>
 #include <stdio.h>
 #include "Timer.h"
-#include "memory.h"
+#include "Memory.h"
 #include "SaveGame.h"
 
 //
diff -urPw homeworld-orig/src/Game/Timer.h homeworld_sdl-0.3/src/Game/Timer.h
--- homeworld-orig/src/Game/Timer.h	2002-09-04 12:46:22.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Timer.h	2004-08-01 22:35:36.000000000 -0700
@@ -1,8 +1,8 @@
 #ifndef __TIMER_H
 #define __TIMER_H
 
-#include "types.h"
-#include "universe.h"
+#include "Types.h"
+#include "Universe.h"
 
 //
 //  Created 1997/07/01  Darren Stone
diff -urPw homeworld-orig/src/Game/TitanNet.c homeworld_sdl-0.3/src/Game/TitanNet.c
--- homeworld-orig/src/Game/TitanNet.c	2002-09-04 12:46:22.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/TitanNet.c	2004-08-01 22:35:36.000000000 -0700
@@ -6,29 +6,36 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
+#ifdef _WIN32
 #define WIN32_LEAN_AND_MEAN
 #include <windows.h>
 #include <winbase.h>
+#include <io.h>
+#endif
+
 #include <stdlib.h>
 #include <stdio.h>
 #include <string.h>
-#include <io.h>
-#include "titannet.h"
-#include "types.h"
-#include "debug.h"
-#include "statscript.h"
+#include "TitanNet.h"
+#include "Types.h"
+#include "Debug.h"
+#include "StatScript.h"
 #include "TitanInterfaceC.h"
 #include "CommandNetwork.h"
-#include "multiplayergame.h"
-#include "multiplayerlangame.h"
+#include "MultiplayerGame.h"
+#include "MultiplayerLANGame.h"
 #include "utility.h"
-#include "teams.h"
-#include "scenpick.h"
-#include "colpick.h"
+#include "Teams.h"
+#include "ScenPick.h"
+#include "ColPick.h"
 #include "Captaincy.h"
 #include "color.h"
-#include "file.h"
-#include "titan.h"
+#include "File.h"
+#include "Titan.h"
+
+#ifdef _MSC_VER
+#define strcasecmp _stricmp
+#endif
 
 #define DEBUG_GAME_BW
 
@@ -39,16 +46,16 @@
 unsigned long TitanActive = FALSE;
 unsigned long TitanReadyToShutdown = FALSE;
 
-TPChannelList tpChannelList;
-TPServerList  tpServerList;
-CaptainGameInfo tpGameCreated;
+extern TPChannelList tpChannelList;
+extern TPServerList  tpServerList;
+extern CaptainGameInfo tpGameCreated;
 wchar_t CurrentChannel[MAX_CHANNEL_NAME_LEN] = L"";
 wchar_t CurrentChannelDescription[MAX_CHANNEL_DESCRIPTION_LEN] = L"";
 unsigned long myIP;
 unsigned long myPort;
 
 int ChannelProtectedFlag = 0;
-wchar_t ChannelPassword[MAX_PASSWORD_LEN] = L"";
+extern wchar_t ChannelPassword[MAX_PASSWORD_LEN];
 
 wchar_t RemoveGameRequest[MAX_TITAN_GAME_NAME_LEN] = L"";
 
@@ -68,17 +75,17 @@
 unsigned long TITAN_CHANNEL_EXPIRE_TIME = 300;
 
 
-unsigned long DIRSERVER_NUM = 1;
 unsigned long AUTHSERVER_NUM = 0;       // get from dirserver now
+unsigned long DIRSERVER_NUM   = 1;
 unsigned long PATCHSERVER_NUM = 1;
 
-unsigned long DIRSERVER_PORTS[MAX_PORTS];
 unsigned long AUTHSERVER_PORTS[MAX_PORTS];
-unsigned long PATCHSERVER_PORTS[MAX_PORTS];
+extern unsigned long DIRSERVER_PORTS[MAX_PORTS];
+extern unsigned long PATCHSERVER_PORTS[MAX_PORTS];
 
 ipString AUTHSERVER_IPSTRINGS[MAX_IPS];
-ipString DIRSERVER_IPSTRINGS[MAX_IPS];
-ipString PATCHSERVER_IPSTRINGS[MAX_IPS];
+extern ipString DIRSERVER_IPSTRINGS[MAX_IPS];
+extern ipString PATCHSERVER_IPSTRINGS[MAX_IPS];
 
 unsigned long GAME_PORT = 2500;
 unsigned long AD_PORT = 2501;
@@ -208,10 +215,12 @@
 
 void SetChannel(wchar_t *channel, wchar_t *description)
 {
+#ifndef _MACOSX_FIX_ME
     dbgAssert(wcslen(channel) <= MAX_CHANNEL_NAME_LEN);
     wcscpy(CurrentChannel,channel);
     dbgAssert(wcslen(description) <= MAX_CHANNEL_DESCRIPTION_LEN);
     wcscpy(CurrentChannelDescription,description);
+#endif
 }
 
 wchar_t *GetCurrentChannel(void)
@@ -233,8 +242,8 @@
 ----------------------------------------------------------------------------*/
 void tpLockChannelList()
 {
-    DWORD result = WaitForSingleObject((HANDLE)tpChannelList.mutex,INFINITE);
-    dbgAssert(result != WAIT_FAILED);
+    int result = SDL_mutexP(tpChannelList.mutex);
+    dbgAssert(result != -1);
 }
 
 /*-----------------------------------------------------------------------------
@@ -246,8 +255,8 @@
 ----------------------------------------------------------------------------*/
 void tpUnLockChannelList()
 {
-    BOOL result = ReleaseMutex((HANDLE)tpChannelList.mutex);
-    dbgAssert(result);
+    int result = SDL_mutexV(tpChannelList.mutex);
+    dbgAssert(result != -1);
 }
 
 /*-----------------------------------------------------------------------------
@@ -259,8 +268,8 @@
 ----------------------------------------------------------------------------*/
 void tpLockServerList()
 {
-    DWORD result = WaitForSingleObject((HANDLE)tpServerList.mutex,INFINITE);
-    dbgAssert(result != WAIT_FAILED);
+    int result = SDL_mutexP(tpServerList.mutex);
+    dbgAssert(result != -1);
 }
 
 /*-----------------------------------------------------------------------------
@@ -272,8 +281,8 @@
 ----------------------------------------------------------------------------*/
 void tpUnLockServerList()
 {
-    BOOL result = ReleaseMutex((HANDLE)tpServerList.mutex);
-    dbgAssert(result);
+    int result = SDL_mutexV(tpServerList.mutex);
+    dbgAssert(result != -1);
 }
 
 /*-----------------------------------------------------------------------------
@@ -287,11 +296,11 @@
 {
     tpChannelList.numChannels = 0;
     tpChannelList.newDataArrived = FALSE;
-    tpChannelList.mutex = (void *)CreateMutex(NULL,FALSE,NULL);
+    tpChannelList.mutex = SDL_CreateMutex();
     dbgAssert(tpChannelList.mutex != NULL);
     tpServerList.numServers = 0;
     tpServerList.newDataArrived = FALSE;
-    tpServerList.mutex = (void *)CreateMutex(NULL,FALSE,NULL);
+    tpServerList.mutex = SDL_CreateMutex();
     dbgAssert(tpServerList.mutex != NULL);
 
     titanResetGameCreated();
@@ -322,8 +331,8 @@
 ----------------------------------------------------------------------------*/
 void titanGameShutdown(void)
 {
-    CloseHandle((HANDLE)tpChannelList.mutex);
-    CloseHandle((HANDLE)tpServerList.mutex);
+    SDL_DestroyMutex(tpChannelList.mutex);
+    SDL_DestroyMutex(tpServerList.mutex);
     tpChannelList.mutex = NULL;
     tpServerList.mutex = NULL;
 }
@@ -337,6 +346,7 @@
 ----------------------------------------------------------------------------*/
 void titanGameEnded(void)
 {
+#ifndef _MACOSX_FIX_ME
     signed int IWasCaptain = IAmCaptain;
 
     mgGameInterestedOff();
@@ -350,6 +360,7 @@
                                                             // to the room before you call it
         }
     }
+#endif
 }
 
 /*-----------------------------------------------------------------------------
@@ -457,6 +468,7 @@
 
 bool titanKickPlayer(udword i)
 {
+#ifndef _MACOSX_FIX_ME
     unsigned long j;
     DirectoryCustomInfoMax buildDirectoryCustomInfo;
 
@@ -510,10 +522,13 @@
     {
         return FALSE;
     }
+#endif
+	return FALSE;
 }
 
 unsigned long titanLeaveGameReceivedCB(Address *address,const void *blob,unsigned short bloblen)
 {
+#ifndef _MACOSX_FIX_ME
     unsigned long i,j;
     bool       found=FALSE;
     DirectoryCustomInfoMax buildDirectoryCustomInfo;
@@ -573,7 +588,7 @@
 
         return TRUE;
     }
-
+#endif // _MACOSX_FIX_ME
     return FALSE;
 }
 
@@ -584,7 +599,7 @@
     int n;
 
     dbgAssert(mapnamelen <= MAX_MAPNAME_LEN);
-
+#ifndef _MACOSX_FIX_ME
     if (bitTest(tpGameCreated.flag,MG_PasswordProtected))
     {
         wcscpy(buildDirectoryCustomInfo->stringdata,tpGameCreated.Password);
@@ -595,7 +610,7 @@
         wcscpy(buildDirectoryCustomInfo->stringdata,L"");
         passwordnamelen = wcslen(L"") + 1;
     }
-
+#endif
     dbgAssert(passwordnamelen <= MAX_PASSWORD_LEN);
 
     mbstowcs(buildDirectoryCustomInfo->stringdata + passwordnamelen, tpGameCreated.DisplayMapName, mapnamelen);
@@ -625,6 +640,7 @@
 
 signed long titanRequestReceivedCB(Address *address,const void *blob,unsigned short bloblen)
 {
+#ifndef _MACOSX_FIX_ME
     sdword i;
     DirectoryCustomInfoMax buildDirectoryCustomInfo;
     const PlayerJoinInfo* pInfo;
@@ -708,7 +724,7 @@
         wcscpy(lgMyGameInfo.Name,tpGameCreated.Name);
         lgUpdateGameInfo();
     }
-
+#endif // _MACOSX_FIX_ME
     return REQUEST_RECV_CB_ACCEPT;
 }
 
@@ -826,7 +842,7 @@
     }
     else
     {
-        sprintf(buffer,"(IP:%x Port:%d)",address->AddrPart.IP,address->Port);
+        sprintf(buffer,"(IP:%lx Port:%d)",address->AddrPart.IP,address->Port);
     }
 }
 
@@ -872,7 +888,7 @@
         if (!ptr)
             return FALSE;
 
-        if (stricmp(ptr,myversion) == 0)
+        if (strcasecmp(ptr,myversion) == 0)
         {
             return TRUE;
         }
@@ -900,7 +916,7 @@
 
 bool CheckNetworkVersionCompatibility(char *netversion)
 {
-    if (stricmp(netversion,networkVersion) == 0)
+    if (strcasecmp(netversion,networkVersion) == 0)
         return TRUE;
     else
         return FALSE;
diff -urPw homeworld-orig/src/Game/TitanNet.h homeworld_sdl-0.3/src/Game/TitanNet.h
--- homeworld-orig/src/Game/TitanNet.h	2002-09-04 12:46:22.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/TitanNet.h	2004-08-01 22:35:36.000000000 -0700
@@ -9,7 +9,7 @@
 #ifndef ___TITANNET_H
 #define ___TITANNET_H
 
-#include "types.h"
+#include "Types.h"
 #include "TitanInterfaceC.h"
 
 extern real32 TITAN_PICKER_REFRESH_TIME;
diff -urPw homeworld-orig/src/Game/Tracking.c homeworld_sdl-0.3/src/Game/Tracking.c
--- homeworld-orig/src/Game/Tracking.c	2002-09-04 12:46:22.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Tracking.c	2004-08-01 22:35:32.000000000 -0700
@@ -6,16 +6,16 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "tracking.h"
+#include "Tracking.h"
 
 #if NUMBER_TRACKING         //if anything in this module is enabled,
 #include <string.h>
 #include "main.h"
-#include "debug.h"
-#include "memory.h"
+#include "Debug.h"
+#include "Memory.h"
 #include "prim2d.h"
 #include "font.h"
-#include "key.h"
+#include "Key.h"
 
 /*=============================================================================
     Data:
@@ -172,7 +172,7 @@
         }
         //print the name of the value
         fontPrint(x - fontWidth(trkValue[index].name), y, trkValue[index].c, trkValue[index].name);
-        delta = abs(*trkValue[index].value - trkValue[index].lastValue) / timeElapsed;//see how much it has changed
+        delta = ABS(*trkValue[index].value - trkValue[index].lastValue) / timeElapsed;//see how much it has changed
         if (delta == 0.0f)
         {                                                   //don't do anything else if it has not changed
             continue;
diff -urPw homeworld-orig/src/Game/Tracking.h homeworld_sdl-0.3/src/Game/Tracking.h
--- homeworld-orig/src/Game/Tracking.h	2002-09-04 12:46:22.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Tracking.h	2004-08-01 22:35:32.000000000 -0700
@@ -9,7 +9,7 @@
 #ifndef ___TRACKING_H
 #define ___TRACKING_H   12
 
-#include "types.h"
+#include "Types.h"
 #include "color.h"
 
 /*=============================================================================
@@ -63,7 +63,7 @@
 #define trkTrackValueRemoveAll()            trkTrackValueRemoveAllFn()
 #define trkTrackValuesDisplay()             trkTrackValuesDisplayFn()
 #else
-#define trkTrackValueAdd(name, number, c)
+#define trkTrackValueAdd(name, number, timer, c)
 #define trkTrackValueRemove(name)
 #define trkTrackValueRemoveAll()
 #define trkTrackValuesDisplay()
diff -urPw homeworld-orig/src/Game/TradeMgr.c homeworld_sdl-0.3/src/Game/TradeMgr.c
--- homeworld-orig/src/Game/TradeMgr.c	2002-09-04 12:46:22.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/TradeMgr.c	2004-08-01 22:35:21.000000000 -0700
@@ -6,51 +6,54 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
+#ifdef _WIN32
 #define WIN32_LEAN_AND_MEAN
 #include <windows.h>
+#endif
+
 #include <stdio.h>
 #include <math.h>
-#include "fastmath.h"
+#include "FastMath.h"
 
-#include "types.h"
-#include "linkedlist.h"
-#include "universe.h"
-#include "region.h"
-#include "uicontrols.h"
-#include "feflow.h"
+#include "Types.h"
+#include "LinkedList.h"
+#include "Universe.h"
+#include "Region.h"
+#include "UIControls.h"
+#include "FEFlow.h"
 #include "font.h"
-#include "fontreg.h"
-#include "objtypes.h"
-#include "task.h"
+#include "FontReg.h"
+#include "ObjTypes.h"
+#include "Task.h"
 #include "mouse.h"
 #include "CommandLayer.h"
-#include "piePlate.h"
+#include "PiePlate.h"
 #include "ConsMgr.h"
 #include "TradeMgr.h"
-#include "globals.h"
+#include "Globals.h"
 #include "CommandWrap.h"
-#include "soundevent.h"
-#include "randy.h"
-#include "strings.h"
-#include "researchapi.h"
+#include "SoundEvent.h"
+#include "Randy.h"
+#include "Strings.h"
+#include "ResearchAPI.h"
 #include "mainrgn.h"
-#include "taskbar.h"
-#include "shipview.h"
+#include "TaskBar.h"
+#include "ShipView.h"
 #include "glinc.h"
 #include "glcaps.h"
 #include "render.h"
-#include "sensors.h"
-#include "singleplayer.h"
-#include "ping.h"
+#include "Sensors.h"
+#include "SinglePlayer.h"
+#include "Ping.h"
 #include "texreg.h"
-#include "fereg.h"
-#include "shipdefs.h"
-#include "nis.h"
-#include "researchgui.h"
-#include "select.h"
-#include "matrix.h"
-#include "vector.h"
-#include "key.h"
+#include "FEReg.h"
+#include "ShipDefs.h"
+#include "NIS.h"
+#include "ResearchGUI.h"
+#include "Select.h"
+#include "Matrix.h"
+#include "Vector.h"
+#include "Key.h"
 #include "CameraCommand.h"
 #include "SaveGame.h"
 #include "InfoOverlay.h"
@@ -63,7 +66,11 @@
 extern char TM_Font[64];
 
 
+#ifdef _WIN32
 #define TM_FIBFile              "FEMan\\Trader_Interface.fib"
+#else
+#define TM_FIBFile              "FEMan/Trader_Interface.fib"
+#endif
 #define TM_TradeScreen          "Trader_Interface"
 #define TM_FontNameLength       64
 #define TM_HeadingColorFactor   1.5f
@@ -220,7 +227,6 @@
 udword          tmCurTexture   = TR_InvalidInternalHandle;
 lifheader      *tmCurTechImage = NULL;
 TechnologyType  tmCurTechTexture = -1;
-sdword          drawstate;
 udword          tmLabTexture[MAX_RACES] = { TR_InvalidInternalHandle, TR_InvalidInternalHandle };
 lifheader      *tmLabImage[MAX_RACES] = { NULL, NULL };
 
@@ -466,7 +472,7 @@
     bool        newline=FALSE;
     color c;
     fonthandle currentFont;
-    sdword  numlines,startind=0;
+    sdword  numlines;
 
     currentFont = fontCurrentGet();
     fontMakeCurrent(tmTechListFont);
@@ -629,7 +635,6 @@
     }
     else if ( (event == RPE_PressRight) && (index!=-1) )
     {
-        bool8 skip = FALSE;
         tmtechinfo = index;
     }
 
@@ -648,11 +653,10 @@
 void tmTechListDraw(featom *atom, regionhandle region)
 {
     sdword x, y, index;
-    rectangle rect = region->rect;
     color c;
     fonthandle currentFont;
     bool       newline;
-    sdword     numlines, startind=0, buyable=0;
+    sdword     numlines, buyable=0;
     sdword     price;
 
     if (tmTechSelected == -1)
@@ -797,7 +801,6 @@
     bool        justified, done;
     fonthandle oldfont;
 
-    rectangle rect = region->rect;
     char tmKASMissing[] = "Hello there, fellow space travellers!  Until somebdoy gives me some new lines in KAS, that is all I can say.";
 
     tmDialogRegion = region;
@@ -1079,7 +1082,6 @@
     char      filename[128];
     sdword    index, lru;
     real32    time=(real32)1.0e22;
-    bool      loaded=FALSE;
     rectangle textureRect;
 
     tmTechImageRegion = region;
@@ -1630,7 +1632,7 @@
         if (trader->controlrot)
         {
             trader->vang += trader->controlrot*trader->vangacc;
-            if (abs(trader->vang) > trader->vangmax)
+            if (ABS(trader->vang) > trader->vangmax)
             {
                 if (trader->vang>0)
                     trader->vang = trader->vangmax;
@@ -1640,7 +1642,7 @@
         }
         else
         {
-            if (abs(trader->vang) < trader->vangacc)
+            if (ABS(trader->vang) < trader->vangacc)
             {
                 trader->vang = 0.0f;
             }
diff -urPw homeworld-orig/src/Game/TradeMgr.h homeworld_sdl-0.3/src/Game/TradeMgr.h
--- homeworld-orig/src/Game/TradeMgr.h	2002-09-04 12:46:22.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/TradeMgr.h	2004-08-01 22:35:22.000000000 -0700
@@ -9,11 +9,11 @@
 #ifndef ___TRADEMGR_H
 #define ___TRADEMGR_H
 
-#include "types.h"
-#include "region.h"
+#include "Types.h"
+#include "Region.h"
 
 #include "texreg.h"
-#include "researchapi.h"
+#include "ResearchAPI.h"
 
 /*=============================================================================
     Switches:
@@ -161,7 +161,7 @@
 wkTradeType;
 
 extern wkTradeType wkTradeShips[WK_MAX_SHIPS];
-bool wkTradeStuffActive;
+extern bool wkTradeStuffActive;
 void mrTradeStuffTest(sdword *a, sdword *b);
 void wkTradeUpdate(void);
 
diff -urPw homeworld-orig/src/Game/Transformer.c homeworld_sdl-0.3/src/Game/Transformer.c
--- homeworld-orig/src/Game/Transformer.c	2002-09-04 12:46:22.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Transformer.c	2004-08-01 22:35:19.000000000 -0700
@@ -7,21 +7,28 @@
 =============================================================================*/
 
 #include "glcaps.h"
-#include "transformer.h"
-#include "memory.h"
+#include "Transformer.h"
+#include "Memory.h"
 #include "main.h"
 
 #define FPTR dword ptr
 #define FSIZE 4
+#define FSIZE_STR "4"
 
 
 /*=============================================================================
     Data
 =============================================================================*/
 
+#if defined (_MSC_VER)
 #define S(x) [esi + FSIZE*x]
 #define D(x) [edi + FSIZE*x]
 #define M(x) [edx + FSIZE*x]
+#elif defined (__GNUC__) && defined (__i386__)
+#define S(x) FSIZE_STR "*" #x "(%%esi)"
+#define D(x) FSIZE_STR "*" #x "(%%edi)"
+#define M(x) FSIZE_STR "*" #x "(%%edx)"
+#endif
 
 static sdword nVerts;
 hvector* eyeVertexList = NULL;
@@ -70,6 +77,7 @@
 static int chkcpubit()
 {
     int rval;
+#if defined (_MSC_VER)
     _asm
     {
         pusha
@@ -108,6 +116,42 @@
 
         popa
     }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ (
+        "    pushfl\n"
+        "    popl %%eax\n"
+        "    testl $0x00200000, %%eax\n"
+        "    jz chkcpubit_set_21\n"
+        "    andl $0xffdfffff, %%eax\n"
+        "    pushl %%eax\n"
+        "    popfl\n"
+        "    pushfl\n"
+        "    popl %%eax\n"
+        "    testl $0x00200000, %%eax\n"
+        "    jz chkcpubit_cpu_id_ok\n"
+        "    jmp chkcpubit_err\n"
+
+        "chkcpubit_set_21:\n"
+        "    orl $0x00200000, %%eax\n"
+        "    pushl %%eax\n"
+        "    popfl\n"
+        "    pushfl\n"
+        "    popl %%eax\n"
+        "    testl $0x00200000, %%eax\n"
+        "    jnz chkcpubit_cpu_id_ok\n"
+
+        "chkcpubit_err:\n"
+        "    movl $0, %%eax\n"
+        "    jmp chkcpubit_exit\n"
+
+        "chkcpubit_cpu_id_ok:\n"
+        "    movl $1, %%eax\n"
+
+        "chkcpubit_exit:\n"
+        : "=a" (rval) );
+#else
+    rval = 0;
+#endif
     return rval;
 }
 
@@ -126,13 +170,17 @@
 
     if (mainForceKatmai)
     {
+#ifndef _MACOSX_FIX_ME
         transSetKatmaiSupport(1);
+#endif
         haveKatmai = 1;
         haveFXSR = 1;
     }
     else if (!mainAllowKatmai)
     {
+#ifndef _MACOSX_FIX_ME
         transSetKatmaiSupport(0);
+#endif
         haveKatmai = 0;
         haveFXSR = 0;
     }
@@ -145,6 +193,7 @@
         }
         else
         {
+#if defined (_MSC_VER)
             _asm
             {
                 pusha
@@ -155,6 +204,14 @@
                 mov [cpu_edx], edx
                 popa
             }
+#elif defined (__GNUC__) && defined (__i386__)
+            __asm__ __volatile__ (
+                "    movl $1, %%eax\n"
+                "    cpuid\n"
+                : "=d" (cpu_edx)
+                :
+                : "eax", "ebx", "ecx" );
+#endif
 
             haveFXSR = (cpu_edx & FXSR_BIT) ? 1 : 0;
             if (haveFXSR)
@@ -166,14 +223,20 @@
                 haveKatmai = 0;
             }
         }
+        
+#ifndef _MACOSX_FIX_ME
         (void)transDetermineKatmaiSupport(haveKatmai);
+#endif
     }
 
+#ifdef _MACOSX_FIX_ME
+    useKatmai = 0;
+#else
     useKatmai = transCanSupportKatmai();
-
     transVertexList = (useKatmai) ? transTransformVertexList_intrin : transTransformVertexList_asm;
     transPerspective = (useKatmai) ? transPerspectiveTransform_intrin : transPerspectiveTransform_asm;
     transGeneral = (useKatmai) ? transGeneralPerspectiveTransform_intrin : transGeneralPerspectiveTransform_asm;
+#endif 
 }
 
 /*-----------------------------------------------------------------------------
@@ -196,7 +259,10 @@
         memFree(clipVertexList);
         clipVertexList = NULL;
     }
+
+#ifndef _MACOSX_FIX_ME
     kniTransFreeVertexLists();
+#endif
 }
 
 /*-----------------------------------------------------------------------------
@@ -256,6 +322,7 @@
 //x87 3D transform
 void transTransformVertexList_asm(sdword n, hvector* dest, vertexentry* source, hmatrix* m)
 {
+#if defined (_MSC_VER)
     _asm
     {
         mov ecx, n
@@ -320,6 +387,69 @@
         add     ecx, 4*FSIZE
         jnz     MEGA0
     }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ (
+        "    shll $4, %%ecx\n"
+        "    addl %%ecx, %%esi\n"
+        "    addl %%ecx, %%ebx\n"
+
+        "    negl %%ecx\n"
+
+        "    cmpl $0, %%ecx\n"
+        "    je MEGA1\n"
+
+        ".align 16\n"
+
+        "MEGA0:\n"
+        "    flds    0*"FSIZE_STR"(%%esi, %%ecx)\n"
+        "    fmuls   (0*4+0)*"FSIZE_STR"(%%edi)\n"
+        "    flds    1*"FSIZE_STR"(%%esi, %%ecx)\n"
+        "    fmuls   (1*4+0)*"FSIZE_STR"(%%edi)\n"
+        "    flds    2*"FSIZE_STR"(%%esi, %%ecx)\n"
+        "    fmuls   (2*4+0)*"FSIZE_STR"(%%edi)\n"
+        "    fxch    %%st(1)\n"
+        "    faddp   %%st, %%st(2)\n"
+        "    flds    0*"FSIZE_STR"(%%esi, %%ecx)\n"
+        "    fmuls   (0*4+1)*"FSIZE_STR"(%%edi)\n"
+        "    fxch    %%st(1)\n"
+        "    faddp   %%st, %%st(2)\n"
+        "    flds    1*"FSIZE_STR"(%%esi, %%ecx)\n"
+        "    fmuls   (1*4+1)*"FSIZE_STR"(%%edi)\n"
+        "    flds    2*"FSIZE_STR"(%%esi, %%ecx)\n"
+        "    fmuls   (2*4+1)*"FSIZE_STR"(%%edi)\n"
+        "    fxch    %%st(1)\n"
+        "    faddp   %%st, %%st(2)\n"
+        "    flds    0*"FSIZE_STR"(%%esi, %%ecx)\n"
+        "    fmuls   (0*4+2)*"FSIZE_STR"(%%edi)\n"
+        "    fxch    %%st(1)\n"
+        "    faddp   %%st, %%st(2)\n"
+        "    flds    1*"FSIZE_STR"(%%esi, %%ecx)\n"
+        "    fmuls   (1*4+2)*"FSIZE_STR"(%%edi)\n"
+        "    flds    2*"FSIZE_STR"(%%esi, %%ecx)\n"
+        "    fmuls   (2*4+2)*"FSIZE_STR"(%%edi)\n"
+        "    fxch    %%st(1)\n"
+        "    faddp   %%st, %%st(2)\n"
+        "    fxch    %%st(3)\n"
+        "    faddl   (3*4+0)*"FSIZE_STR"(%%edi)\n"
+        "    fxch    %%st(1)\n"
+        "    faddp   %%st, %%st(3)\n"
+        "    fxch    %%st(1)\n"
+        "    faddl   (3*4+1)*"FSIZE_STR"(%%edi)\n"
+        "    fxch    %%st(2)\n"
+        "    faddl   (3*4+2)*"FSIZE_STR"(%%edi)\n"
+        "    fxch    %%st(1)\n"
+        "    fstps   0*"FSIZE_STR"(%%ebx, %%ecx)\n"
+        "    fxch    %%st(1)\n"
+        "    fstps   1*"FSIZE_STR"(%%ebx, %%ecx)\n"
+        "    fstps   2*"FSIZE_STR"(%%ebx, %%ecx)\n"
+
+        "    addl    $(4*"FSIZE_STR"), %%ecx\n"
+        "    jnz     MEGA0\n"
+
+        "MEGA1:\n"
+        :
+        : "c" (n), "S" (source), "b" (dest), "D" (m) );
+#endif
 }
 
 /*-----------------------------------------------------------------------------
@@ -350,6 +480,7 @@
 //x87 perspective transform
 void transPerspectiveTransform_asm(sdword n, hvector* dest, hvector* source, hmatrix* m)
 {
+#if defined (_MSC_VER)
     _asm
     {
         push esi
@@ -400,6 +531,49 @@
         pop edi
         pop esi
     }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ (
+        "    testl %%ecx, %%ecx\n"
+        "    jz perspxform_two\n"
+
+        "    .align 16\n"
+
+        "perspxform_one:\n"
+        "    flds "S(0)"\n"
+        "    fmuls "M(0)"\n"
+        "    flds "S(1)"\n"
+        "    fmuls "M(5)"\n"
+        "    flds "S(2)"\n"
+        "    fmuls "M(10)"\n"
+
+        "    flds "S(2)"\n"
+        "    fmuls "M(8)"\n"
+        "    flds "S(2)"\n"
+        "    fmuls "M(9)"\n"
+        "    flds "M(14)"\n"
+
+        "    movl "S(2)", %%eax\n"
+        "    leal "S(4)", %%esi\n"
+        "    xorl $0x80000000, %%eax\n"
+        "    decl %%ecx\n"
+
+        "    faddp %%st, %%st(3)\n"
+        "    faddp %%st, %%st(3)\n"
+        "    faddp %%st, %%st(3)\n"
+
+        "    fstps "D(2)"\n"
+        "    fstps "D(1)"\n"
+        "    fstps "D(0)"\n"
+
+        "    movl %%eax, "D(3)"\n"
+        "    leal "D(4)", %%edi\n"
+        "    jnz perspxform_one\n"
+
+        "perspxform_two:\n"
+        :
+        : "c" (n), "S" (source), "D" (dest), "d" (m)
+        : "eax" );
+#endif
 }
 
 /*-----------------------------------------------------------------------------
@@ -503,7 +677,9 @@
 {
     if (useKatmai)
     {
+#ifndef _MACOSX_FIX_ME
         transTransformCompletely_xmm(n, dest, source, m0, m1);
+#endif
     }
     else
     {
@@ -515,6 +691,7 @@
 //x87 general perspective transform
 void transGeneralPerspectiveTransform_asm(sdword n, hvector* dest, hvector* source, hmatrix* m)
 {
+#if defined (_MSC_VER)
     _asm
     {
         push esi
@@ -603,6 +780,86 @@
         pop edi
         pop esi
     }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ (
+        "    testl %%ecx, %%ecx\n"
+        "    jz genperspxform_two\n"
+
+        "    .align 16\n"
+
+        "genperspxform_one:\n"
+        "    flds "S(0)"\n"
+        "    fmuls "M(0)"\n"
+        "    flds "S(0)"\n"
+        "    fmuls "M(1)"\n"
+        "    flds "S(0)"\n"
+        "    fmuls "M(2)"\n"
+        "    flds "S(0)"\n"
+        "    fmuls "M(3)"\n"
+
+        "    flds "S(1)"\n"
+        "    fmuls "M(4)"\n"
+        "    flds "S(1)"\n"
+        "    fmuls "M(5)"\n"
+        "    flds "S(1)"\n"
+        "    fmuls "M(6)"\n"
+        "    flds "S(1)"\n"
+        "    fmuls "M(7)"\n"
+
+        "    fxch %%st(3)\n"
+        "    faddp %%st, %%st(7)\n"
+        "    fxch %%st(1)\n"
+        "    faddp %%st, %%st(5)\n"
+        "    faddp %%st, %%st(3)\n"
+        "    faddp %%st, %%st(1)\n"
+
+        "    flds "S(2)"\n"
+        "    fmuls "M(8)"\n"
+        "    flds "S(2)"\n"
+        "    fmuls "M(9)"\n"
+        "    flds "S(2)"\n"
+        "    fmuls "M(10)"\n"
+        "    flds "S(2)"\n"
+        "    fmuls "M(11)"\n"
+
+        "    fxch %%st(3)\n"
+        "    faddp %%st, %%st(7)\n"
+        "    fxch %%st(1)\n"
+        "    faddp %%st, %%st(5)\n"
+        "    faddp %%st, %%st(3)\n"
+        "    faddp %%st, %%st(1)\n"
+
+        "    flds "M(12)"\n"
+        "    flds "M(13)"\n"
+        "    flds "M(14)"\n"
+        "    flds "M(15)"\n"
+
+        "    fxch %%st(3)\n"
+        "    faddp %%st, %%st(7)\n"
+        "    fxch %%st(1)\n"
+        "    faddp %%st, %%st(5)\n"
+        "    faddp %%st, %%st(3)\n"
+
+        "    leal "S(4)", %%esi\n"
+        "    decl %%ecx\n"
+
+        "    faddp %%st, %%st(1)\n"
+
+        "    fxch %%st(3)\n"
+        "    fstps "D(0)"\n"
+        "    fxch %%st(1)\n"
+        "    fstps "D(1)"\n"
+        "    fstps "D(2)"\n"
+        "    fstps "D(3)"\n"
+
+        "    leal "D(4)", %%edi\n"
+
+        "    jnz genperspxform_one\n"
+
+        "genperspxform_two:\n"
+        :
+        : "c" (n), "D" (dest), "d" (m), "S" (source) );
+#endif
 }
 
 /*-----------------------------------------------------------------------------
diff -urPw homeworld-orig/src/Game/Transformer.h homeworld_sdl-0.3/src/Game/Transformer.h
--- homeworld-orig/src/Game/Transformer.h	2002-09-04 12:46:22.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Transformer.h	2004-08-01 22:35:19.000000000 -0700
@@ -9,10 +9,10 @@
 #ifndef _TRANSFORMER_H
 #define _TRANSFORMER_H
 
-#include "types.h"
-#include "vector.h"
-#include "matrix.h"
-#include "mesh.h"
+#include "Types.h"
+#include "Vector.h"
+#include "Matrix.h"
+#include "Mesh.h"
 
 extern hvector* eyeVertexList;
 extern hvector* clipVertexList;
diff -urPw homeworld-orig/src/Game/Tutor.c homeworld_sdl-0.3/src/Game/Tutor.c
--- homeworld-orig/src/Game/Tutor.c	2002-09-04 12:46:22.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Tutor.c	2004-08-01 22:35:24.000000000 -0700
@@ -4,45 +4,52 @@
 
 */
 
+#ifdef _WIN32
 #include <windows.h>
+#endif
+
 #include "glinc.h"
 #include <stdlib.h>
 #include <math.h>
 #include <stdio.h>
 #include <string.h>
-#include "types.h"
-#include "feflow.h"
-#include "aiplayer.h"
+#include <strings.h>
+#include "Types.h"
+#include "FEFlow.h"
+#include "AIPlayer.h"
 #include "utility.h"
-#include "levelload.h"
-#include "region.h"
+#include "LevelLoad.h"
+#include "Region.h"
 #include "KAS.h"
-#include "uicontrols.h"
-#include "strings.h"
-#include "fontreg.h"
-#include "select.h"
+#include "UIControls.h"
+#include "Strings.h"
+#include "FontReg.h"
+#include "Select.h"
 #include "texreg.h"
-#include "fontReg.h"
+#include "FontReg.h"
 #include "render.h"
 #include "mouse.h"
-#include "fastmath.h"
+#include "FastMath.h"
 #include "Tutor.h"
-#include "Utility.h"
-#include "consmgr.h"
-#include "cameracommand.h"
-#include "fastmath.h"
-#include "savegame.h"
-#include "collision.h"
-#include "gamepick.h"
+#include "ConsMgr.h"
+#include "CameraCommand.h"
+#include "FastMath.h"
+#include "SaveGame.h"
+#include "Collision.h"
+#include "GamePick.h"
 #include "main.h"
-#include "subtitle.h"
-#include "singleplayer.h"
-#include "speechevent.h"
-#include "soundevent.h"
-#include "file.h"
+#include "Subtitle.h"
+#include "SinglePlayer.h"
+#include "SpeechEvent.h"
+#include "SoundEvent.h"
+#include "File.h"
 #include "mainrgn.h"
-#include "taskbar.h"
-#include "..\\Generated\\tutorial1.h"
+#include "TaskBar.h"
+#include "../Generated/Tutorial1.h"
+
+#ifdef _MSC_VER
+#define strcasecmp _stricmp
+#endif
 
 //hack to get the speech to work when game is paused
 bool FalkosFuckedUpTutorialFlag = FALSE;
@@ -64,9 +71,6 @@
 static char tutLastLessonName[256] = "";
 static char tutCurrLessonName[256] = "";
 
-static const sbyte ExpandY = 0;
-static const sbyte ExpandX = 1;
-
 /*
 sdword  tutTextPointerType = 0;
 sdword  tutPointerX, tutPointerY;
@@ -137,10 +141,11 @@
     NULL,                   //  ubyte *pData;                               //pointer to type-specific data
     NULL,                   //  ubyte *attribs;                             //sound(button atom) or font(static text atom) reference
     0,                      //  char   hotKeyModifiers;
-    0,                      //  char   hotKey[FE_NumberLanguages];
-    0,                      //  udword drawstyle[2];
+    {0},                    //  char   hotKey[FE_NumberLanguages];
+    {0},                    //  char   pad2[2]
+    {0},                    //  udword drawstyle[2];
     0,                      //  void*  region;
-    0                       //  udword pad[2];
+    {0}                     //  udword pad[2];
 };
 
 
@@ -161,10 +166,11 @@
     NULL,                   //  ubyte *pData;                               //pointer to type-specific data
     NULL,                   //  ubyte *attribs;                             //sound(button atom) or font(static text atom) reference
     0,                      //  char   hotKeyModifiers;
-    0,                      //  char   hotKey[FE_NumberLanguages];
-    0,                      //  udword drawstyle[2];
+    {0},                    //  char   hotKey[FE_NumberLanguages];
+    {0},                    //  char   pad2[2]
+    {0},                    //  udword drawstyle[2];
     0,                      //  void*  region;
-    0                       //  udword pad[2];
+    {0}                     //  udword pad[2];
 };
 
 featom tutImageAtom =
@@ -184,10 +190,11 @@
     NULL,                   //  ubyte *pData;                               //pointer to type-specific data
     NULL,                   //  ubyte *attribs;                             //sound(button atom) or font(static text atom) reference
     0,                      //  char   hotKeyModifiers;
-    0,                      //  char   hotKey[FE_NumberLanguages];
-    0,                      //  udword drawstyle[2];
+    {0},                    //  char   hotKey[FE_NumberLanguages];
+    {0},                    //  char   pad2[2]
+    {0},                    //  udword drawstyle[2];
     0,                      //  void*  region;
-    0                       //  udword pad[2];
+    {0}                     //  udword pad[2];
 };
 
 featom tutNextAtom =
@@ -207,10 +214,11 @@
     NULL,                   //  ubyte *pData;                               //pointer to type-specific data
     NULL,                   //  ubyte *attribs;                             //sound(button atom) or font(static text atom) reference
     0,                      //  char   hotKeyModifiers;
-    0,                      //  char   hotKey[FE_NumberLanguages];
-    0,                      //  udword drawstyle[2];
+    {0},                    //  char   hotKey[FE_NumberLanguages];
+    {0},                    //  char   pad2[2]
+    {0},                    //  udword drawstyle[2];
     0,                      //  void*  region;
-    0                       //  udword pad[2];
+    {0}                     //  udword pad[2];
 };
 
 featom tutBackAtom =
@@ -230,10 +238,11 @@
     NULL,                   //  ubyte *pData;                               //pointer to type-specific data
     NULL,                   //  ubyte *attribs;                             //sound(button atom) or font(static text atom) reference
     0,                      //  char   hotKeyModifiers;
-    0,                      //  char   hotKey[FE_NumberLanguages];
-    0,                      //  udword drawstyle[2];
+    {0},                    //  char   hotKey[FE_NumberLanguages];
+    {0},                    //  char   pad2[2]
+    {0},                    //  udword drawstyle[2];
     0,                      //  void*  region;
-    0                       //  udword pad[2];
+    {0}                     //  udword pad[2];
 };
 
 
@@ -501,7 +510,11 @@
 
 void tutPreInitTutorial(char *dirfile, char *levelfile)
 {
+#ifdef _WIN32
     sprintf(dirfile, "Tutorials\\%s\\", tutTutorialNames[tutorial]);
+#else
+    sprintf(dirfile, "Tutorials/%s/", tutTutorialNames[tutorial]);
+#endif
     sprintf(levelfile, "%s.mission", tutTutorialNames[tutorial]);
 
     tutEnableEverything();
@@ -1674,7 +1687,7 @@
     i = 0;
     while(pTokenList[i][0])
     {
-        if(stricmp(pTokenList[i], pToken) == 0)
+        if(strcasecmp(pTokenList[i], pToken) == 0)
             return i;
         i++;
     }
@@ -1831,7 +1844,11 @@
         if (tutTexture[i] == TR_InvalidInternalHandle)
         {
             dbgAssert(tutImage[i] == NULL);
+#ifdef _WIN32
             strcpy(Filename, "feman\\texdecorative\\");
+#else
+            strcpy(Filename, "feman/texdecorative/");
+#endif
 
             //load the correct texture depending on language
             if (strCurLanguage == languageEnglish)
@@ -1919,7 +1936,11 @@
     pFlagMem = (long *)&tutEnable;
     pFlagMem += Index/32;
 
+#ifdef _MACOSX_FIX_ME // ENDIAN_BIG?
+	FlagBit = 1 << (31 - Index & 31);
+#else
     FlagBit = 1 << (Index & 31);
+#endif
 
     if(Val)
         *pFlagMem |= FlagBit;
@@ -2059,7 +2080,7 @@
     {
         for(i=0; i<tutGameMessageIndex; i++)
         {
-            if(stricmp(szToken, tutGameMessageList[i]) == 0)
+            if(strcasecmp(szToken, tutGameMessageList[i]) == 0)
                 RetVal = 1;
         }
         StrIndex = GetNextCommaDelimitedToken(NULL, szToken, StrIndex);
diff -urPw homeworld-orig/src/Game/Tutor.h homeworld_sdl-0.3/src/Game/Tutor.h
--- homeworld-orig/src/Game/Tutor.h	2002-09-04 12:46:22.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Tutor.h	2004-08-01 22:35:24.000000000 -0700
@@ -8,10 +8,10 @@
 #define TUTOR_H
 
 #include "Types.h"
-#include "shipselect.h"
-#include "shipdefs.h"
-#include "feflow.h"
-#include "volume.h"
+#include "ShipSelect.h"
+#include "ShipDefs.h"
+#include "FEFlow.h"
+#include "Volume.h"
 
 /*=============================================================================
     Definitions:
diff -urPw homeworld-orig/src/Game/Tutorial.c homeworld_sdl-0.3/src/Game/Tutorial.c
--- homeworld-orig/src/Game/Tutorial.c	2002-09-04 12:46:22.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Tutorial.c	2004-08-01 22:35:27.000000000 -0700
@@ -1,27 +1,30 @@
+#ifdef _WIN32
 #include <windows.h>
+#endif
+
 #include "glinc.h"
 #include <stdlib.h>
 #include <stdio.h>
 #include <string.h>
-#include "types.h"
-#include "feflow.h"
-#include "aiplayer.h"
+#include "Types.h"
+#include "FEFlow.h"
+#include "AIPlayer.h"
 #include "utility.h"
-#include "levelload.h"
-#include "region.h"
+#include "LevelLoad.h"
+#include "Region.h"
 #include "KAS.h"
-#include "..\\Generated\\basic.h"
-#include "..\\Generated\\advanced.h"
-#include "..\\Generated\\new.h"
-#include "uicontrols.h"
-#include "strings.h"
-#include "fontreg.h"
-#include "select.h"
+#include "../Generated/basic.h"
+#include "../Generated/advanced.h"
+#include "../Generated/new.h"
+#include "UIControls.h"
+#include "Strings.h"
+#include "FontReg.h"
+#include "Select.h"
 #include "texreg.h"
 #include "render.h"
 #include "mouse.h"
-#include "tutorial.h"
-#include "fastmath.h"
+#include "Tutorial.h"
+#include "FastMath.h"
 #include "Tutor.h"
 
 extern char *getWord(char *dest, char *source);
@@ -86,34 +89,39 @@
     NUM_BUTTON_TEXTURES
 } BUTTON_TEXTURES;
 
+#ifdef _WIN32
+#define FEMAN_TEXDEC_PATH "feman\\texdecorative\\"
+#else
+#define FEMAN_TEXDEC_PATH "feman/texdecorative/"
+#endif
 char tutTextureNames[NUM_BUTTON_TEXTURES][64] =
 {
-{"feman\\texdecorative\\Tut_next_on.LiF"},
-{"feman\\texdecorative\\Tut_next_off.LiF"},
-{"feman\\texdecorative\\Tut_next_mouse.LiF"},
-{"feman\\texdecorative\\Tut_mouse_right.LiF"},
-{"feman\\texdecorative\\Tut_mouse_right_left.LiF"},
-{"feman\\texdecorative\\Tut_mouse_middle.LiF"},
-{"feman\\texdecorative\\Tut_mouse_left.LiF"},
-{"feman\\texdecorative\\Tut_mouse_left_arrows.LiF"},
-{"feman\\texdecorative\\Tut_mouse_left_x2.LiF"},
-{"feman\\texdecorative\\Tut_key_c.LiF"},            // need correct art for b button
-{"feman\\texdecorative\\Tut_key_c.LiF"},
-{"feman\\texdecorative\\Tut_key_d.LiF"},
-{"feman\\texdecorative\\Tut_key_f.LiF"},
-{"feman\\texdecorative\\Tut_key_h.LiF"},
-{"feman\\texdecorative\\Tut_key_m.LiF"},
-{"feman\\texdecorative\\Tut_key_z.LiF"},
-{"feman\\texdecorative\\Tut_key_f1.LiF"},
-{"feman\\texdecorative\\Tut_key_esc.LiF"},
-{"feman\\texdecorative\\Tut_key_tab.LiF"},
-{"feman\\texdecorative\\Tut_key_shift.LiF"},
-{"feman\\texdecorative\\Tut_key_capslock.LiF"},
-{"feman\\texdecorative\\Tut_key_space.LiF"},
-{"feman\\texdecorative\\Tut_key_ctrl_1.LiF"},
-{"feman\\texdecorative\\Tut_key_ctrl_alt.LiF"},
-{"feman\\texdecorative\\Tut_key_c.LiF"},            // need correct art for right-click icon
-{"feman\\texdecorative\\Tut_key_d.LiF"},            // need correct art for taskbar icon
+{FEMAN_TEXDEC_PATH "Tut_next_on.LiF"},
+{FEMAN_TEXDEC_PATH "Tut_next_off.LiF"},
+{FEMAN_TEXDEC_PATH "Tut_next_mouse.LiF"},
+{FEMAN_TEXDEC_PATH "Tut_mouse_right.LiF"},
+{FEMAN_TEXDEC_PATH "Tut_mouse_right_left.LiF"},
+{FEMAN_TEXDEC_PATH "Tut_mouse_middle.LiF"},
+{FEMAN_TEXDEC_PATH "Tut_mouse_left.LiF"},
+{FEMAN_TEXDEC_PATH "Tut_mouse_left_arrows.LiF"},
+{FEMAN_TEXDEC_PATH "Tut_mouse_left_x2.LiF"},
+{FEMAN_TEXDEC_PATH "Tut_key_c.LiF"},            // need correct art for b button
+{FEMAN_TEXDEC_PATH "Tut_key_c.LiF"},
+{FEMAN_TEXDEC_PATH "Tut_key_d.LiF"},
+{FEMAN_TEXDEC_PATH "Tut_key_f.LiF"},
+{FEMAN_TEXDEC_PATH "Tut_key_h.LiF"},
+{FEMAN_TEXDEC_PATH "Tut_key_m.LiF"},
+{FEMAN_TEXDEC_PATH "Tut_key_z.LiF"},
+{FEMAN_TEXDEC_PATH "Tut_key_f1.LiF"},
+{FEMAN_TEXDEC_PATH "Tut_key_esc.LiF"},
+{FEMAN_TEXDEC_PATH "Tut_key_tab.LiF"},
+{FEMAN_TEXDEC_PATH "Tut_key_shift.LiF"},
+{FEMAN_TEXDEC_PATH "Tut_key_capslock.LiF"},
+{FEMAN_TEXDEC_PATH "Tut_key_space.LiF"},
+{FEMAN_TEXDEC_PATH "Tut_key_ctrl_1.LiF"},
+{FEMAN_TEXDEC_PATH "Tut_key_ctrl_alt.LiF"},
+{FEMAN_TEXDEC_PATH "Tut_key_c.LiF"},            // need correct art for right-click icon
+{FEMAN_TEXDEC_PATH "Tut_key_d.LiF"},            // need correct art for taskbar icon
 };
 
 sword tutBitmapList[TUT_TOTAL_LESSONS][3] =
diff -urPw homeworld-orig/src/Game/Tutorial.h homeworld_sdl-0.3/src/Game/Tutorial.h
--- homeworld-orig/src/Game/Tutorial.h	2002-09-04 12:46:22.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Tutorial.h	2004-08-01 22:35:27.000000000 -0700
@@ -1,7 +1,7 @@
 #ifndef _TUTORIAL_H
 #define _TUTORIAL_H
 
-#include "feflow.h"
+#include "FEFlow.h"
 
 typedef enum
 {
diff -urPw homeworld-orig/src/Game/Tweak.c homeworld_sdl-0.3/src/Game/Tweak.c
--- homeworld-orig/src/Game/Tweak.c	2002-09-04 12:46:22.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Tweak.c	2004-08-01 22:35:30.000000000 -0700
@@ -2,12 +2,12 @@
 #include <string.h>
 #include <stdio.h>
 #include <math.h>
-#include "types.h"
-#include "tweak.h"
-#include "statscript.h"
-#include "blobs.h"
-#include "multiplayergame.h"
-#include "horserace.h"
+#include "Types.h"
+#include "Tweak.h"
+#include "StatScript.h"
+#include "Blobs.h"
+#include "MultiplayerGame.h"
+#include "HorseRace.h"
 
 /*=============================================================================
     Insert global tweakables here:
diff -urPw homeworld-orig/src/Game/Tweak.h homeworld_sdl-0.3/src/Game/Tweak.h
--- homeworld-orig/src/Game/Tweak.h	2002-09-04 12:46:22.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Tweak.h	2004-08-01 22:35:31.000000000 -0700
@@ -2,11 +2,11 @@
 #ifndef ___TWEAK_H
 #define ___TWEAK_H
 
-#include "types.h"
+#include "Types.h"
 #include "color.h"
-#include "shipdefs.h"
-#include "classdefs.h"
-#include "objtypes.h"
+#include "ShipDefs.h"
+#include "ClassDefs.h"
+#include "ObjTypes.h"
 
 /*=============================================================================
     Insert global tweakables here:
diff -urPw homeworld-orig/src/Game/Twiddle.c homeworld_sdl-0.3/src/Game/Twiddle.c
--- homeworld-orig/src/Game/Twiddle.c	2002-09-04 12:46:22.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Twiddle.c	2004-08-01 22:35:18.000000000 -0700
@@ -6,7 +6,7 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "twiddle.h"
+#include "Twiddle.h"
 
 /*=============================================================================
     Functions:
diff -urPw homeworld-orig/src/Game/Twiddle.h homeworld_sdl-0.3/src/Game/Twiddle.h
--- homeworld-orig/src/Game/Twiddle.h	2002-09-04 12:46:22.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Twiddle.h	2004-08-01 22:35:18.000000000 -0700
@@ -9,7 +9,7 @@
 #ifndef ___TWIDDLE_H
 #define ___TWIDDLE_H
 
-#include "types.h"
+#include "Types.h"
 
 /*=============================================================================
     Functions:
@@ -24,5 +24,5 @@
 //find lowest/highest bit set in a number
 udword bitLowBitPosition(udword number);
 
-#endif ___TWIDDLE_H
+#endif  /* ___TWIDDLE_H */
 
diff -urPw homeworld-orig/src/Game/Types.c homeworld_sdl-0.3/src/Game/Types.c
--- homeworld-orig/src/Game/Types.c	1969-12-31 16:00:00.000000000 -0800
+++ homeworld_sdl-0.3/src/Game/Types.c	2004-08-01 22:35:33.000000000 -0700
@@ -0,0 +1,27 @@
+#include "Types.h"
+
+
+Uint16 SwapShort( Uint16 val )
+{
+	return( Uint16 )( ( val << 8 ) | ( val >> 8 ) );
+}
+
+
+Uint32 SwapLong( Uint32 val )
+{
+	return( ( val << 24 ) | ( ( val << 8 ) & 0x00ff0000 ) | ( ( val >> 8 ) & 0x0000ff00 ) | ( val >> 24 ) );
+}
+
+
+float SwapFloat( float val )
+{
+	union
+	{
+		float f;
+		Uint32 i;
+	} swap;
+
+	swap.f = val;
+	swap.i = SwapLong( swap.i );
+	return swap.f;
+}
diff -urPw homeworld-orig/src/Game/Types.h homeworld_sdl-0.3/src/Game/Types.h
--- homeworld-orig/src/Game/Types.h	2002-09-04 12:46:22.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Types.h	2004-08-01 22:35:33.000000000 -0700
@@ -1,16 +1,24 @@
 /*=========================================================================
-   TYPES.H definitions for Watcom C
+   TYPES.H definitions
+   Based on TYPES.H definitions for Watcom C in original Homeworld source.
+   (Modified for use outside Watcom C, i.e. GCC, by Ted Cipicchio)
+
+   The main difference is that we now use SDL data types since they
+   already deal different data type sizes across platforms.  The original
+   data type declarations (sbyte, udword, etc.) are still used to keep
+   consistent with the original game source.
 ==========================================================================*/
 
 #ifndef ___TYPES_H
 #define ___TYPES_H
 
+#include "SDL_types.h"
+
 /*-------------------------------------------------------------------------
    Declare size of integers in bytes by compiler type
 --------------------------------------------------------------------------*/
-#if defined(_WIN32) && defined(_M_IX86)
-#else  // not Microsoft C
-#error Use of types.h for compiler other than Microsoft C
+#ifndef SDL_HAS_64BIT_TYPE
+#error 64-bit integer type not supported on this platform.
 #endif
 
 /*-----------------------------------------------------------------------------
@@ -26,22 +34,54 @@
 /*-------------------------------------------------------------------------
    Declare basic integer data types
 --------------------------------------------------------------------------*/
-typedef signed   char       sbyte;
-typedef unsigned char       ubyte;
-typedef signed   short int  sword;
-typedef unsigned short int  uword;
-typedef signed   long  int  sdword;
-typedef unsigned long  int  udword;
-typedef signed   __int64    sqword;
-typedef unsigned __int64    uqword;
+typedef Sint8   sbyte;
+typedef Uint8   ubyte;
+typedef Sint16  sword;
+typedef Uint16  uword;
+typedef Sint32  sdword;
+typedef Uint32  udword;
+typedef Sint64  sqword;
+typedef Uint64  uqword;
 typedef float               real32;
 typedef double              real64;
 
-typedef sdword              bool;
+#ifndef __cplusplus
+    typedef udword  bool;
+#endif
 typedef sbyte               bool8;
 typedef sword               bool16;
 
 /*-------------------------------------------------------------------------
+	Functions for converting endian-specific values
+--------------------------------------------------------------------------*/
+
+Uint16 SwapShort( Uint16 val );
+Uint32 SwapLong( Uint32 val );
+float  SwapFloat( float val );
+
+#if defined(__i386__) || defined(_WIN32) || defined(__LITTLE_ENDIAN__)
+	#define ENDIAN_LITTLE
+#else
+	#define ENDIAN_BIG
+#endif
+
+#ifdef ENDIAN_BIG
+	#define LittleShort(x)		SwapShort((x))
+	#define LittleLong(x)		SwapLong((x))
+	#define LittleFloat(x)		SwapFloat((x))
+	#define BigShort(x)			(x)
+	#define BigLong(x)			(x)
+	#define BigFloat(x)			(x)
+#else
+	#define LittleShort(x)		(x)
+	#define LittleLong(x)		(x)
+	#define LittleFloat(x)		(x)
+	#define BigShort(x)			SwapShort((x))
+	#define BigLong(x)			SwapLong((x))
+	#define BigFloat(x)			SwapFloat((x))
+#endif
+
+/*-------------------------------------------------------------------------
    Declare common numbers etc.
 --------------------------------------------------------------------------*/
 
@@ -70,9 +110,9 @@
 #define  SWORD_Max     32767
 #define  SDWORD_Max    2147483647L
 
-#define  UBYTE_Max     255                      // maximums for unsigned types
-#define  UWORD_Max     65535L
-#define  UDWORD_Max    4294967295L
+#define  UBYTE_Max     255U                     // maximums for unsigned types
+#define  UWORD_Max     65535UL
+#define  UDWORD_Max    4294967295UL
 
 #define  BIT0       0x01
 #define  BIT1       0x02
@@ -114,11 +154,13 @@
 #ifndef max
 #define max(a,b) ((a) > (b) ? (a) : (b))
 #endif
+
 #ifndef min
 #define min(a,b) ((a) > (b) ? (b) : (a))
 #endif
-#ifndef abs
-#define abs(a)   ((a) < 0 ? -(a) : (a))
+
+#if !defined(ABS)
+    #define ABS(a)   ((a) < 0 ? -(a) : (a))
 #endif
 
 #define frandyrandom(stream,n) (ranRandom(stream) * (((real32)(n)) * (1.0f/((real32)UDWORD_Max))))
@@ -170,7 +212,7 @@
 #define bitSet(dest, bitFlags)      ((dest) |= (bitFlags))
 #define bitClear(dest, bitFlags)    ((dest) &= ~(bitFlags))
 #define bitTest(dest, bitFlags)     ((dest) & (bitFlags))
-#define bitToggle(dest, bitFlags)   if ((dest) & (bitFlags)) bitClear((dest), (bitFlags)); else bitSet((dest), (bitFlags))
+#define bitToggle(dest, bitFlags)   { if ((dest) & (bitFlags)) bitClear((dest), (bitFlags)); else bitSet((dest), (bitFlags)); }
 //#define bitSetTo(dest, bitFlags, bSet) ((bSet) ? bitSet(dest, bitFlags) : bitClear(dest, bitFlags)
 #define bitSetTo(dest, bitFlags, bSet) ((dest) = ((dest) & (~bitFlags)) | ((bSet)?bitFlags:0))
 
@@ -196,5 +238,7 @@
 #define sphereArea(radius)          (4.0f * PI * (radius) * (radius))
 #define sphereVolume(radius)        (4.0f / 3.0f * PI * (radius) * (radius) * (radius))
 
+#define PATH_MAX	1024
+
 #endif  // ___TYPES_H
 
diff -urPw homeworld-orig/src/Game/UIControls.c homeworld_sdl-0.3/src/Game/UIControls.c
--- homeworld-orig/src/Game/UIControls.c	2002-09-04 12:46:22.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/UIControls.c	2004-08-01 22:35:16.000000000 -0700
@@ -7,27 +7,29 @@
 =============================================================================*/
 
 #ifndef SW_Render
+#ifdef _WIN32
 #include <windows.h>
 #endif
+#endif
 #include "glinc.h"
-#include "types.h"
-#include "region.h"
+#include "Types.h"
+#include "Region.h"
 #include "color.h"
 #include "prim2d.h"
 #include "mouse.h"
 #include "font.h"
-#include "fontreg.h"
-#include "soundevent.h"
-#include "uicontrols.h"
-#include "scroller.h"
-#include "scenpick.h"
-#include "FeReg.h"
+#include "FontReg.h"
+#include "SoundEvent.h"
+#include "UIControls.h"
+#include "Scroller.h"
+#include "ScenPick.h"
+#include "FEReg.h"
 #include "mainswitches.h"
 #include "mouse.h"
-#include "universe.h"
+#include "Universe.h"
 #include "utility.h"
-#include "task.h"
-#include "strings.h"
+#include "Task.h"
+#include "Strings.h"
 
 #include "glcaps.h"
 
@@ -140,1302 +142,1368 @@
 
 uicKeyTable uicKeyEntryTable[KEY_TOTAL_KEYS] =
 {
-    /*            0 0  */  0,    0,
-    /*              1  */  0,    0,
-    /*              2  */  0,    0,
-    /*              3  */  0,    0,
-    /*              4  */  0,    0,
-    /*              5  */  0,    0,
-    /*              6  */  0,    0,
-    /*              7  */  0,    0,
-    /*              8  */  0,    0,
-    /*              9  */  0,    0,
-    /*              10 */  0,    0,
-    /*              11 */  0,    0,
-    /*              12 */  0,    0,
-    /*              13 */  0,    0,
-    /*              14 */  0,    0,
-    /*              15 */  0,    0,
-    /*           16 16 */  0,    0,
-    /*              17 */  0,    0,
-    /*              18 */  0,    0,
-    /*              19 */  0,    0,
-    /*              20 */  0,    0,
-    /*              21 */  0,    0,
-    /*              22 */  0,    0,
-    /*              23 */  0,    0,
-    /*              24 */  0,    0,
-    /*              25 */  0,    0,
-    /*              26 */  0,    0,
-    /*              27 */  0,    0,
-    /*              28 */  0,    0,
-    /*              29 */  0,    0,
-    /*              30 */  0,    0,
-    /*              31 */  0,    0,
-    /* space     32 32 */  ' ',  ' ',
-    /*              33 */  0,    0,
-    /*              34 */  0,    0,
-    /*              35 */  0,    0,
-    /*              36 */  0,    0,
-    /*              37 */  0,    0,
-    /*              38 */  0,    0,
-    /* punctuation  39 */  0,    0,
-    /*              40 */  0,    0,
-    /*              41 */  0,    0,
-    /*              42 */  0,    0,
-    /*              43 */  0,    0,
-    /*              44 */  0,    0,
-    /*              45 */  '-',  '_',
-    /*              46 */  0,    0,
-    /*              47 */  0,    0,
-    /* 0         48 48 */  '0',  ')',
-    /* 1            49 */  '1',  '!',
-    /* 2            50 */  '2',  '@',
-    /* 3            51 */  '3',  '#',
-    /* 4            52 */  '4',  '$',
-    /* 5            53 */  '5',  '%',
-    /* 6            54 */  '6',  '^',
-    /* 7            55 */  '7',  '&',
-    /* 8            56 */  '8',  '*',
-    /* 9            57 */  '9',  '(',
-    /* :            58 */  ':',  0,
-    /* ;            59 */  ';',  0,
-    /* <            60 */  '<',  0,
-    /* =            61 */  '=',  '+',
-    /* >            62 */  '>',  0,
-    /* ?            63 */  '?',  0,
-    /* @         64 64 */  '@',  0,
-    /* A            65 */  'a',  'A',
-    /* B            66 */  'b',  'B',
-    /* C            67 */  'c',  'C',
-    /* D            68 */  'd',  'D',
-    /* E            69 */  'e',  'E',
-    /* F            70 */  'f',  'F',
-    /* G            71 */  'g',  'G',
-    /* H            72 */  'h',  'H',
-    /* I            73 */  'i',  'I',
-    /* J            74 */  'j',  'J',
-    /* K            75 */  'k',  'K',
-    /* L            76 */  'l',  'L',
-    /* M            77 */  'm',  'M',
-    /* N            78 */  'n',  'N',
-    /* O            79 */  'o',  'O',
-    /* P         80 80 */  'p',  'P',
-    /* Q            81 */  'q',  'Q',
-    /* R            82 */  'r',  'R',
-    /* S            83 */  's',  'S',
-    /* T            84 */  't',  'T',
-    /* U            85 */  'u',  'U',
-    /* V            86 */  'v',  'V',
-    /* W            87 */  'w',  'W',
-    /* X            88 */  'x',  'X',
-    /* Y            89 */  'y',  'Y',
-    /* Z            90 */  'z',  'Z',
-    /*              91 */  0,    0,
-    /*              92 */  0,    0,
-    /*              93 */  0,    0,
-    /*              94 */  0,    0,
-    /*              95 */  0,    0,
-    /*           96 96 */  '0',  0,
-    /*              97 */  '1',  0,
-    /*              98 */  '2',  0,
-    /*              99 */  '3',  0,
-    /*              100*/  '4',  0,
-    /*              101*/  '5',  0,
-    /*              102*/  '6',  0,
-    /*              103*/  '7',  0,
-    /*              104*/  '8',  0,
-    /*              105*/  '9',  0,
-    /*              106*/  '*',  0,
-    /*              107*/  '+',  0,
-    /*              108*/  0,    0,
-    /*              109*/  '-',  0,
-    /*              110*/  '.',  0,
-    /*              111*/  '/',  0,
-    /*          112 112*/  0,    0,
-    /*              113*/  0,    0,
-    /*              114*/  0,    0,
-    /*              115*/  0,    0,
-    /*              116*/  0,    0,
-    /*              117*/  0,    0,
-    /*              118*/  0,    0,
-    /*              119*/  0,    0,
-    /*              120*/  0,    0,
-    /*              121*/  0,    0,
-    /*              122*/  0,    0,
-    /*              123*/  0,    0,
-    /*              124*/  0,    0,
-    /*              125*/  0,    0,
-    /*              126*/  0,    0,
-    /*              127*/  0,    0,
-    /*          128 128*/  0,    0,
-    /*              129*/  0,    0,
-    /*              130*/  0,    0,
-    /*              131*/  0,    0,
-    /*              132*/  0,    0,
-    /*              133*/  0,    0,
-    /*              134*/  0,    0,
-    /*              135*/  0,    0,
-    /*              136*/  0,    0,
-    /*              137*/  0,    0,
-    /*              138*/  0,    0,
-    /*              139*/  0,    0,
-    /*              140*/  0,    0,
-    /*              141*/  0,    0,
-    /*              142*/  0,    0,
-    /*              143*/  0,    0,
-    /*          144 144*/  0,    0,
-    /*              145*/  0,    0,
-    /*              146*/  0,    0,
-    /*              147*/  0,    0,
-    /*              148*/  0,    0,
-    /*              149*/  0,    0,
-    /*              150*/  0,    0,
-    /*              151*/  0,    0,
-    /*              152*/  0,    0,
-    /*              153*/  0,    0,
-    /*              154*/  0,    0,
-    /*              155*/  0,    0,
-    /*              156*/  0,    0,
-    /*              157*/  0,    0,
-    /*              158*/  0,    0,
-    /*              159*/  0,    0,
-    /*          160 160*/  0,    0,
-    /*              161*/  0,    0,
-    /*              162*/  0,    0,
-    /*              163*/  0,    0,
-    /*              164*/  0,    0,
-    /*              165*/  0,    0,
-    /*              166*/  0,    0,
-    /*              167*/  0,    0,
-    /*              168*/  0,    0,
-    /*              169*/  0,    0,
-    /*              170*/  0,    0,
-    /*              171*/  0,    0,
-    /*              172*/  0,    0,
-    /*              173*/  0,    0,
-    /*              174*/  0,    0,
-    /*              175*/  0,    0,
-    /*          176 176*/  0,    0,
-    /*              177*/  0,    0,
-    /*              178*/  0,    0,
-    /*              179*/  0,    0,
-    /*              180*/  0,    0,
-    /*              181*/  0,    0,
-    /*              182*/  0,    0,
-    /*              183*/  0,    0,
-    /*              184*/  0,    0,
-    /*              185*/  0,    0,
-    /*              186*/  ';',  ':',
-    /*              187*/  '=',  '+',
-    /*              188*/  ',',  '<',
-    /*              189*/  '-',  '_',
-    /*              190*/  '.',  '>',
-    /*              191*/  '/',  '?',
-    /*          192 192*/  '`',  '~',
-    /*              193*/  0,    0,
-    /*              194*/  0,    0,
-    /*              195*/  0,    0,
-    /*              196*/  0,    0,
-    /*              197*/  0,    0,
-    /*              198*/  0,    0,
-    /*              199*/  0,    0,
-    /*              200*/  0,    0,
-    /*              201*/  0,    0,
-    /*              202*/  0,    0,
-    /*              203*/  0,    0,
-    /*              204*/  0,    0,
-    /*              205*/  0,    0,
-    /*              206*/  0,    0,
-    /*              207*/  0,    0,
-    /*          208 208*/  0,    0,
-    /*              209*/  0,    0,
-    /*              210*/  0,    0,
-    /*              211*/  0,    0,
-    /*              212*/  0,    0,
-    /*              213*/  0,    0,
-    /*              214*/  0,    0,
-    /*              215*/  0,    0,
-    /*              216*/  0,    0,
-    /*              217*/  0,    0,
-    /*              218*/  0,    0,
-    /*              219*/  '[',  '{',
-    /*              220*/  '\\', '|',
-    /*              221*/  ']',  '}',
-    /*              222*/  '\'',  '"',
-    /*              223*/  0,    0,
-    /*          224 224*/  0,    0,
-    /*              225*/  0,    0,
-    /*              226*/  0,    0,
-    /*              227*/  0,    0,
-    /*              228*/  0,    0,
-    /*              229*/  0,    0,
-    /*              230*/  0,    0,
-    /*              231*/  0,    0,
-    /*              232*/  0,    0,
-    /*              233*/  0,    0,
-    /*              234*/  0,    0,
-    /*              235*/  0,    0,
-    /*              236*/  0,    0,
-    /*              237*/  0,    0,
-    /*              238*/  0,    0,
-    /*              239*/  0,    0,
-    /*          240 240*/  0,    0,
-    /*              241*/  0,    0,
-    /*              242*/  0,    0,
-    /*              243*/  0,    0,
-    /*              244*/  0,    0,
-    /*              245*/  0,    0,
-    /*              246*/  0,    0,
-    /*              247*/  0,    0,
-    /*              248*/  0,    0,
-    /*              249*/  0,    0,
-    /*              250*/  0,    0,
-    /*              251*/  0,    0,
-    /*              252*/  0,    0,
-    /*              253*/  0,    0,
-    /*              254*/  0,    0,
-    /*              255*/  0,    0,
+    /*            0 0  */    {  0  ,  0  },
+    /*              1  */    {  0  ,  0  },
+    /*              2  */    {  0  ,  0  },
+    /*              3  */    {  0  ,  0  },
+    /*              4  */    {  0  ,  0  },
+    /*              5  */    {  0  ,  0  },
+    /*              6  */    {  0  ,  0  },
+    /*              7  */    {  0  ,  0  },
+    /*              8  */    {  0  ,  0  },
+    /*              9  */    {  0  ,  0  },
+    /*              10 */    {  0  ,  0  },
+    /*              11 */    {  0  ,  0  },
+    /*              12 */    {  0  ,  0  },
+    /*              13 */    {  0  ,  0  },
+    /*              14 */    {  0  ,  0  },
+    /*              15 */    {  0  ,  0  },
+    /*           16 16 */    {  0  ,  0  },
+    /*              17 */    {  0  ,  0  },
+    /*              18 */    {  0  ,  0  },
+    /*              19 */    {  0  ,  0  },
+    /*              20 */    {  0  ,  0  },
+    /*              21 */    {  0  ,  0  },
+    /*              22 */    {  0  ,  0  },
+    /*              23 */    {  0  ,  0  },
+    /*              24 */    {  0  ,  0  },
+    /*              25 */    {  0  ,  0  },
+    /*              26 */    {  0  ,  0  },
+    /*              27 */    {  0  ,  0  },
+    /*              28 */    {  0  ,  0  },
+    /*              29 */    {  0  ,  0  },
+    /*              30 */    {  0  ,  0  },
+    /*              31 */    {  0  ,  0  },
+    /* space     32 32 */    { ' ' , ' ' },
+    /*              33 */    { '!' , '!' },
+    /*              34 */    { '"' , '"' },
+    /*              35 */    { '#' , '#' },
+    /*              36 */    { '$' , '$' },
+    /*              37 */    {  0  ,  0  },
+    /*              38 */    { '&' , '&' },
+    /* punctuation  39 */    { '\'', '"' },
+    /*              40 */    { '(' , '(' },
+    /*              41 */    { ')' , ')' },
+    /*              42 */    { '*' , '*' },
+    /*              43 */    { '+' , '+' },
+    /*              44 */    { ',' , '"' },
+    /*              45 */    { '-' , '_' },
+    /*              46 */    { '.' , '>' },
+    /*              47 */    { '/' , '?' },
+    /* 0         48 48 */    { '0' , ')' },
+    /* 1            49 */    { '1' , '!' },
+    /* 2            50 */    { '2' , '@' },
+    /* 3            51 */    { '3' , '#' },
+    /* 4            52 */    { '4' , '$' },
+    /* 5            53 */    { '5' , '%' },
+    /* 6            54 */    { '6' , '^' },
+    /* 7            55 */    { '7' , '&' },
+    /* 8            56 */    { '8' , '*' },
+    /* 9            57 */    { '9' , '(' },
+    /* :            58 */    { ':' , ':' },
+    /* ;            59 */    { ';' , ':' },
+    /* <            60 */    { '<' , '<' },
+    /* =            61 */    { '=' , '+' },
+    /* >            62 */    { '>' , '>' },
+    /* ?            63 */    { '?' , '?' },
+    /* @         64 64 */    { '@' , '@' },
+    /* A            65 */    { 'a' , 'A' },
+    /* B            66 */    { 'b' , 'B' },
+    /* C            67 */    { 'c' , 'C' },
+    /* D            68 */    { 'd' , 'D' },
+    /* E            69 */    { 'e' , 'E' },
+    /* F            70 */    { 'f' , 'F' },
+    /* G            71 */    { 'g' , 'G' },
+    /* H            72 */    { 'h' , 'H' },
+    /* I            73 */    { 'i' , 'I' },
+    /* J            74 */    { 'j' , 'J' },
+    /* K            75 */    { 'k' , 'K' },
+    /* L            76 */    { 'l' , 'L' },
+    /* M            77 */    { 'm' , 'M' },
+    /* N            78 */    { 'n' , 'N' },
+    /* O            79 */    { 'o' , 'O' },
+    /* P         80 80 */    { 'p' , 'P' },
+    /* Q            81 */    { 'q' , 'Q' },
+    /* R            82 */    { 'r' , 'R' },
+    /* S            83 */    { 's' , 'S' },
+    /* T            84 */    { 't' , 'T' },
+    /* U            85 */    { 'u' , 'U' },
+    /* V            86 */    { 'v' , 'V' },
+    /* W            87 */    { 'w' , 'W' },
+    /* X            88 */    { 'x' , 'X' },
+    /* Y            89 */    { 'y' , 'Y' },
+    /* Z            90 */    { 'z' , 'Z' },
+    /*              91 */    { '[' , '{' },
+    /*              92 */    { '\\', '|' },
+    /*              93 */    { ']' , '}' },
+    /*              94 */    { '^' , '^' },
+    /*              95 */    { '_' , '_' },
+    /*           96 96 */    { '`' , '~' },
+    /*              97 */    { 'a' , 'A' },
+    /*              98 */    { 'b' , 'B' },
+    /*              99 */    { 'c' , 'C' },
+    /*              100*/    { 'd' , 'D' },
+    /*              101*/    { 'e' , 'E' },
+    /*              102*/    { 'f' , 'F' },
+    /*              103*/    { 'g' , 'G' },
+    /*              104*/    { 'h' , 'H' },
+    /*              105*/    { 'i' , 'I' },
+    /*              106*/    { 'j' , 'J' },
+    /*              107*/    { 'k' , 'K' },
+    /*              108*/    { 'l' , 'L' },
+    /*              109*/    { 'm' , 'M' },
+    /*              110*/    { 'n' , 'N' },
+    /*              111*/    { 'o' , 'O' },
+    /*          112 112*/    { 'p' , 'P' },
+    /*              113*/    { 'q' , 'Q' },
+    /*              114*/    { 'r' , 'R' },
+    /*              115*/    { 's' , 'S' },
+    /*              116*/    { 't' , 'T' },
+    /*              117*/    { 'u' , 'U' },
+    /*              118*/    { 'v' , 'V' },
+    /*              119*/    { 'w' , 'W' },
+    /*              120*/    { 'x' , 'X' },
+    /*              121*/    { 'y' , 'Y' },
+    /*              122*/    { 'z' , 'Z' },
+    /*              123*/    {  0  ,  0  },
+    /*              124*/    {  0  ,  0  },
+    /*              125*/    {  0  ,  0  },
+    /*              126*/    {  0  ,  0  },
+    /*              127*/    {  0  ,  0  },
+    /*          128 128*/    {  0  ,  0  },
+    /*              129*/    {  0  ,  0  },
+    /*              130*/    {  0  ,  0  },
+    /*              131*/    {  0  ,  0  },
+    /*              132*/    {  0  ,  0  },
+    /*              133*/    {  0  ,  0  },
+    /*              134*/    {  0  ,  0  },
+    /*              135*/    {  0  ,  0  },
+    /*              136*/    {  0  ,  0  },
+    /*              137*/    {  0  ,  0  },
+    /*              138*/    {  0  ,  0  },
+    /*              139*/    {  0  ,  0  },
+    /*              140*/    {  0  ,  0  },
+    /*              141*/    {  0  ,  0  },
+    /*              142*/    {  0  ,  0  },
+    /*              143*/    {  0  ,  0  },
+    /*          144 144*/    {  0  ,  0  },
+    /*              145*/    {  0  ,  0  },
+    /*              146*/    {  0  ,  0  },
+    /*              147*/    {  0  ,  0  },
+    /*              148*/    {  0  ,  0  },
+    /*              149*/    {  0  ,  0  },
+    /*              150*/    {  0  ,  0  },
+    /*              151*/    {  0  ,  0  },
+    /*              152*/    {  0  ,  0  },
+    /*              153*/    {  0  ,  0  },
+    /*              154*/    {  0  ,  0  },
+    /*              155*/    {  0  ,  0  },
+    /*              156*/    {  0  ,  0  },
+    /*              157*/    {  0  ,  0  },
+    /*              158*/    {  0  ,  0  },
+    /*              159*/    {  0  ,  0  },
+    /*          160 160*/    {  0  ,  0  },
+    /*              161*/    {  0  ,  0  },
+    /*              162*/    {  0  ,  0  },
+    /*              163*/    {  0  ,  0  },
+    /*              164*/    {  0  ,  0  },
+    /*              165*/    {  0  ,  0  },
+    /*              166*/    {  0  ,  0  },
+    /*              167*/    {  0  ,  0  },
+    /*              168*/    {  0  ,  0  },
+    /*              169*/    {  0  ,  0  },
+    /*              170*/    {  0  ,  0  },
+    /*              171*/    {  0  ,  0  },
+    /*              172*/    {  0  ,  0  },
+    /*              173*/    {  0  ,  0  },
+    /*              174*/    {  0  ,  0  },
+    /*              175*/    {  0  ,  0  },
+    /*          176 176*/    {  0  ,  0  },
+    /*              177*/    {  0  ,  0  },
+    /*              178*/    {  0  ,  0  },
+    /*              179*/    {  0  ,  0  },
+    /*              180*/    {  0  ,  0  },
+    /*              181*/    {  0  ,  0  },
+    /*              182*/    {  0  ,  0  },
+    /*              183*/    {  0  ,  0  },
+    /*              184*/    {  0  ,  0  },
+    /*              185*/    {  0  ,  0  },
+    /*              186*/    {  0  ,  0  },
+    /*              187*/    {  0  ,  0  },
+    /*              188*/    {  0  ,  0  },
+    /*              189*/    {  0  ,  0  },
+    /*              190*/    {  0  ,  0  },
+    /*              191*/    {  0  ,  0  },
+    /*          192 192*/    {  0  ,  0  },
+    /*              193*/    {  0  ,  0  },
+    /*              194*/    {  0  ,  0  },
+    /*              195*/    {  0  ,  0  },
+    /*              196*/    {  0  ,  0  },
+    /*              197*/    {  0  ,  0  },
+    /*              198*/    {  0  ,  0  },
+    /*              199*/    {  0  ,  0  },
+    /*              200*/    {  0  ,  0  },
+    /*              201*/    {  0  ,  0  },
+    /*              202*/    {  0  ,  0  },
+    /*              203*/    {  0  ,  0  },
+    /*              204*/    {  0  ,  0  },
+    /*              205*/    {  0  ,  0  },
+    /*              206*/    {  0  ,  0  },
+    /*              207*/    {  0  ,  0  },
+    /*          208 208*/    {  0  ,  0  },
+    /*              209*/    {  0  ,  0  },
+    /*              210*/    {  0  ,  0  },
+    /*              211*/    {  0  ,  0  },
+    /*              212*/    {  0  ,  0  },
+    /*              213*/    {  0  ,  0  },
+    /*              214*/    {  0  ,  0  },
+    /*              215*/    {  0  ,  0  },
+    /*              216*/    {  0  ,  0  },
+    /*              217*/    {  0  ,  0  },
+    /*              218*/    {  0  ,  0  },
+    /*              219*/    {  0  ,  0  },
+    /*              220*/    {  0  ,  0  },
+    /*              221*/    {  0  ,  0  },
+    /*              222*/    {  0  ,  0  },
+    /*              223*/    {  0  ,  0  },
+    /*          224 224*/    {  0  ,  0  },
+    /*              225*/    {  0  ,  0  },
+    /*              226*/    {  0  ,  0  },
+    /*              227*/    {  0  ,  0  },
+    /*              228*/    {  0  ,  0  },
+    /*              229*/    {  0  ,  0  },
+    /*              230*/    {  0  ,  0  },
+    /*              231*/    {  0  ,  0  },
+    /*              232*/    {  0  ,  0  },
+    /*              233*/    {  0  ,  0  },
+    /*              234*/    {  0  ,  0  },
+    /*              235*/    {  0  ,  0  },
+    /*              236*/    {  0  ,  0  },
+    /*              237*/    {  0  ,  0  },
+    /*              238*/    {  0  ,  0  },
+    /*              239*/    {  0  ,  0  },
+    /*          240 240*/    {  0  ,  0  },
+    /*              241*/    {  0  ,  0  },
+    /*              242*/    {  0  ,  0  },
+    /*              243*/    {  0  ,  0  },
+    /*              244*/    {  0  ,  0  },
+    /*              245*/    {  0  ,  0  },
+    /*              246*/    {  0  ,  0  },
+    /*              247*/    {  0  ,  0  },
+    /*              248*/    {  0  ,  0  },
+    /*              249*/    {  0  ,  0  },
+    /*              250*/    {  0  ,  0  },
+    /*              251*/    {  0  ,  0  },
+    /*              252*/    {  0  ,  0  },
+    /*              253*/    {  0  ,  0  },
+    /*              254*/    {  0  ,  0  },
+    /*              255*/    {  0  ,  0  },
+    /*          256 256*/    { '0' , '0' },
+    /*              257*/    { '1' , '1' },
+    /*              258*/    { '2' , '2' },
+    /*              259*/    { '3' , '3' },
+    /*              260*/    { '4' , '4' },
+    /*              261*/    { '5' , '5' },
+    /*              262*/    { '6' , '6' },
+    /*              263*/    { '7' , '7' },
+    /*              264*/    { '8' , '8' },
+    /*              265*/    { '9' , '9' },
+    /*              266*/    { '.' , '.' },
+    /*              267*/    { '/' , '/' },
+    /*              268*/    { '*' , '*' },
+    /*              269*/    { '-' , '-' },
+    /*              270*/    { '+' , '+' },
+    /*              271*/    {  0  ,  0  },
+    /*          272 272*/    { '=' , '=' },
+    /*              273*/    {  0  ,  0  },
+    /*              274*/    {  0  ,  0  },
+    /*              275*/    {  0  ,  0  },
+    /*              276*/    {  0  ,  0  },
+    /*              277*/    {  0  ,  0  },
+    /*              278*/    {  0  ,  0  },
+    /*              279*/    {  0  ,  0  },
+    /*              280*/    {  0  ,  0  },
+    /*              281*/    {  0  ,  0  },
+    /*              282*/    {  0  ,  0  },
+    /*              283*/    {  0  ,  0  },
+    /*              284*/    {  0  ,  0  },
+    /*              285*/    {  0  ,  0  },
+    /*              286*/    {  0  ,  0  },
+    /*              287*/    {  0  ,  0  },
+    /*          288 288*/    {  0  ,  0  },
+    /*              289*/    {  0  ,  0  },
+    /*              290*/    {  0  ,  0  },
+    /*              291*/    {  0  ,  0  },
+    /*              292*/    {  0  ,  0  },
+    /*              293*/    {  0  ,  0  },
+    /*              294*/    {  0  ,  0  },
+    /*              295*/    {  0  ,  0  },
+    /*              296*/    {  0  ,  0  },
+    /*              297*/    {  0  ,  0  },
+    /*              298*/    {  0  ,  0  },
+    /*              299*/    {  0  ,  0  },
+    /*              300*/    {  0  ,  0  },
+    /*              301*/    {  0  ,  0  },
+    /*              302*/    {  0  ,  0  },
+    /*              303*/    {  0  ,  0  },
+    /*          304 304*/    {  0  ,  0  },
+    /*              305*/    {  0  ,  0  },
+    /*              306*/    {  0  ,  0  },
+    /*              307*/    {  0  ,  0  },
+    /*              308*/    {  0  ,  0  },
+    /*              309*/    {  0  ,  0  },
+    /*              310*/    {  0  ,  0  },
+    /*              311*/    {  0  ,  0  },
+    /*              312*/    {  0  ,  0  },
+    /*              313*/    {  0  ,  0  },
+    /*              314*/    {  0  ,  0  },
+    /*              315*/    {  0  ,  0  },
+    /*              316*/    {  0  ,  0  },
+    /*              317*/    {  0  ,  0  },
+    /*              318*/    {  0  ,  0  },
+    /*              319*/    {  0  ,  0  },
+    /*          320 320*/    {  0  ,  0  },
+    /*              321*/    {  0  ,  0  },
 };
 
 uicKeyTable uicFrenchKeyEntryTable[KEY_TOTAL_KEYS] =
 {
-    /*            0 0  */  0,    0,
-    /*              1  */  0,    0,
-    /*              2  */  0,    0,
-    /*              3  */  0,    0,
-    /*              4  */  0,    0,
-    /*              5  */  0,    0,
-    /*              6  */  0,    0,
-    /*              7  */  0,    0,
-    /*              8  */  0,    0,
-    /*              9  */  0,    0,
-    /*              10 */  0,    0,
-    /*              11 */  0,    0,
-    /*              12 */  0,    0,
-    /*              13 */  0,    0,
-    /*              14 */  0,    0,
-    /*              15 */  0,    0,
-    /*           16 16 */  0,    0,
-    /*              17 */  0,    0,
-    /*              18 */  0,    0,
-    /*              19 */  0,    0,
-    /*              20 */  0,    0,
-    /*              21 */  0,    0,
-    /*              22 */  0,    0,
-    /*              23 */  0,    0,
-    /*              24 */  0,    0,
-    /*              25 */  0,    0,
-    /*              26 */  0,    0,
-    /*              27 */  0,    0,
-    /*              28 */  0,    0,
-    /*              29 */  0,    0,
-    /*              30 */  0,    0,
-    /*              31 */  0,    0,
-    /* space     32 32 */  ' ',  ' ',
-    /*              33 */  0,    0,
-    /*              34 */  0,    0,
-    /*              35 */  0,    0,
-    /*              36 */  0,    0,
-    /*              37 */  0,    0,
-    /*              38 */  0,    0,
-    /* punctuation  39 */  0,    0,
-    /*              40 */  0,    0,
-    /*              41 */  0,    0,
-    /*              42 */  0,    0,
-    /*              43 */  0,    0,
-    /*              44 */  ',',  '?',
-    /*              45 */  '-',  '_',
-    /*              46 */  0,    0,
-    /*              47 */  0,    0,
-    /* 0         48 48 */  '',  '0',
-    /* 1            49 */  '&',  '1',
-    /* 2            50 */  '',  '2',
-    /* 3            51 */  '"',  '3',
-    /* 4            52 */  '\'', '4',
-    /* 5            53 */  '(',  '5',
-    /* 6            54 */  '-',  '6',
-    /* 7            55 */  '',  '7',
-    /* 8            56 */  '_',  '8',
-    /* 9            57 */  '',  '9',
-    /* :            58 */  ':',  0,
-    /* ;            59 */  ';',  0,
-    /* <            60 */  '<',  0,
-    /* =            61 */  '=',  '+',
-    /* >            62 */  '>',  0,
-    /* ?            63 */  '?',  0,
-    /* @         64 64 */  '@',  0,
-    /* A            65 */  'a',  'A',
-    /* B            66 */  'b',  'B',
-    /* C            67 */  'c',  'C',
-    /* D            68 */  'd',  'D',
-    /* E            69 */  'e',  'E',
-    /* F            70 */  'f',  'F',
-    /* G            71 */  'g',  'G',
-    /* H            72 */  'h',  'H',
-    /* I            73 */  'i',  'I',
-    /* J            74 */  'j',  'J',
-    /* K            75 */  'k',  'K',
-    /* L            76 */  'l',  'L',
-    /* M            77 */  'm',  'M',
-    /* N            78 */  'n',  'N',
-    /* O            79 */  'o',  'O',
-    /* P         80 80 */  'p',  'P',
-    /* Q            81 */  'q',  'Q',
-    /* R            82 */  'r',  'R',
-    /* S            83 */  's',  'S',
-    /* T            84 */  't',  'T',
-    /* U            85 */  'u',  'U',
-    /* V            86 */  'v',  'V',
-    /* W            87 */  'w',  'W',
-    /* X            88 */  'x',  'X',
-    /* Y            89 */  'y',  'Y',
-    /* Z            90 */  'z',  'Z',
-    /*              91 */  0,    0,
-    /*              92 */  0,    0,
-    /*              93 */  0,    0,
-    /*              94 */  0,    0,
-    /*              95 */  0,    0,
-    /*           96 96 */  '0',  0,
-    /*              97 */  '1',  0,
-    /*              98 */  '2',  0,
-    /*              99 */  '3',  0,
-    /*              100*/  '4',  0,
-    /*              101*/  '5',  0,
-    /*              102*/  '6',  0,
-    /*              103*/  '7',  0,
-    /*              104*/  '8',  0,
-    /*              105*/  '9',  0,
-    /*              106*/  '*',  0,
-    /*              107*/  '+',  0,
-    /*              108*/  0,    0,
-    /*              109*/  '-',  0,
-    /*              110*/  '.',  0,
-    /*              111*/  '/',  0,
-    /*          112 112*/  0,    0,
-    /*              113*/  0,    0,
-    /*              114*/  0,    0,
-    /*              115*/  0,    0,
-    /*              116*/  0,    0,
-    /*              117*/  0,    0,
-    /*              118*/  0,    0,
-    /*              119*/  0,    0,
-    /*              120*/  0,    0,
-    /*              121*/  0,    0,
-    /*              122*/  0,    0,
-    /*              123*/  0,    0,
-    /*              124*/  0,    0,
-    /*              125*/  0,    0,
-    /*              126*/  0,    0,
-    /*              127*/  0,    0,
-    /*          128 128*/  0,    0,
-    /*              129*/  0,    0,
-    /*              130*/  0,    0,
-    /*              131*/  0,    0,
-    /*              132*/  0,    0,
-    /*              133*/  0,    0,
-    /*              134*/  0,    0,
-    /*              135*/  0,    0,
-    /*              136*/  0,    0,
-    /*              137*/  0,    0,
-    /*              138*/  0,    0,
-    /*              139*/  0,    0,
-    /*              140*/  0,    0,
-    /*              141*/  0,    0,
-    /*              142*/  0,    0,
-    /*              143*/  0,    0,
-    /*          144 144*/  0,    0,
-    /*              145*/  0,    0,
-    /*              146*/  0,    0,
-    /*              147*/  0,    0,
-    /*              148*/  0,    0,
-    /*              149*/  0,    0,
-    /*              150*/  0,    0,
-    /*              151*/  0,    0,
-    /*              152*/  0,    0,
-    /*              153*/  0,    0,
-    /*              154*/  0,    0,
-    /*              155*/  0,    0,
-    /*              156*/  0,    0,
-    /*              157*/  0,    0,
-    /*              158*/  0,    0,
-    /*              159*/  0,    0,
-    /*          160 160*/  0,    0,
-    /*              161*/  0,    0,
-    /*              162*/  0,    0,
-    /*              163*/  0,    0,
-    /*              164*/  0,    0,
-    /*              165*/  0,    0,
-    /*              166*/  0,    0,
-    /*              167*/  '!',  '',
-    /*              168*/  0,    0,
-    /*              169*/  0,    0,
-    /*              170*/  0,    0,
-    /*              171*/  0,    0,
-    /*              172*/  0,    0,
-    /*              173*/  0,    0,
-    /*              174*/  0,    0,
-    /*              175*/  0,    0,
-    /*          176 176*/  0,    0,
-    /*              177*/  0,    0,
-    /*              178*/  0,    0,
-    /*              179*/  0,    0,
-    /*              180*/  0,    0,
-    /*              181*/  0,    0,
-    /*              182*/  0,    0,
-    /*              183*/  0,    0,
-    /*              184*/  0,    0,
-    /*              185*/  0,    0,
-    /*              186*/  ';',  ':',
-    /*              187*/  '=',  '+',
-    /*              188*/  ';',  '.',
-    /*              189*/  ')',  '',
-    /*              190*/  ':',  '/',
-    /*              191*/  '/',  '?',
-    /*          192 192*/  '',  0,
-    /*              193*/  0,    0,
-    /*              194*/  0,    0,
-    /*              195*/  0,    0,
-    /*              196*/  0,    0,
-    /*              197*/  0,    0,
-    /*              198*/  0,    0,
-    /*              199*/  0,    0,
-    /*              200*/  0,    0,
-    /*              201*/  0,    0,
-    /*              202*/  0,    0,
-    /*              203*/  0,    0,
-    /*              204*/  0,    0,
-    /*              205*/  0,    0,
-    /*              206*/  0,    0,
-    /*              207*/  0,    0,
-    /*          208 208*/  0,    0,
-    /*              209*/  0,    0,
-    /*              210*/  0,    0,
-    /*              211*/  0,    0,
-    /*              212*/  0,    0,
-    /*              213*/  0,    0,
-    /*              214*/  0,    0,
-    /*              215*/  0,    0,
-    /*              216*/  0,    0,
-    /*              217*/  0,    0,
-    /*              218*/  0,    0,
-    /*              219*/  '',  '',
-    /*              220*/  '*',  '',
-    /*              221*/  '$',  '',
-    /*              222*/  '\'',  '"',
-    /*              223*/  0,    0,
-    /*          224 224*/  0,    0,
-    /*              225*/  0,    0,
-    /*              226*/  0,    0,
-    /*              227*/  0,    0,
-    /*              228*/  0,    0,
-    /*              229*/  0,    0,
-    /*              230*/  0,    0,
-    /*              231*/  0,    0,
-    /*              232*/  0,    0,
-    /*              233*/  0,    0,
-    /*              234*/  0,    0,
-    /*              235*/  0,    0,
-    /*              236*/  0,    0,
-    /*              237*/  0,    0,
-    /*              238*/  0,    0,
-    /*              239*/  0,    0,
-    /*          240 240*/  0,    0,
-    /*              241*/  0,    0,
-    /*              242*/  0,    0,
-    /*              243*/  0,    0,
-    /*              244*/  0,    0,
-    /*              245*/  0,    0,
-    /*              246*/  0,    0,
-    /*              247*/  0,    0,
-    /*              248*/  0,    0,
-    /*              249*/  '',  '%',
-    /*              250*/  0,    0,
-    /*              251*/  0,    0,
-    /*              252*/  0,    0,
-    /*              253*/  0,    0,
-    /*              254*/  0,    0,
-    /*              255*/  0,    0,
+    /*            0 0  */    {  0  ,  0  },
+    /*              1  */    {  0  ,  0  },
+    /*              2  */    {  0  ,  0  },
+    /*              3  */    {  0  ,  0  },
+    /*              4  */    {  0  ,  0  },
+    /*              5  */    {  0  ,  0  },
+    /*              6  */    {  0  ,  0  },
+    /*              7  */    {  0  ,  0  },
+    /*              8  */    {  0  ,  0  },
+    /*              9  */    {  0  ,  0  },
+    /*              10 */    {  0  ,  0  },
+    /*              11 */    {  0  ,  0  },
+    /*              12 */    {  0  ,  0  },
+    /*              13 */    {  0  ,  0  },
+    /*              14 */    {  0  ,  0  },
+    /*              15 */    {  0  ,  0  },
+    /*           16 16 */    {  0  ,  0  },
+    /*              17 */    {  0  ,  0  },
+    /*              18 */    {  0  ,  0  },
+    /*              19 */    {  0  ,  0  },
+    /*              20 */    {  0  ,  0  },
+    /*              21 */    {  0  ,  0  },
+    /*              22 */    {  0  ,  0  },
+    /*              23 */    {  0  ,  0  },
+    /*              24 */    {  0  ,  0  },
+    /*              25 */    {  0  ,  0  },
+    /*              26 */    {  0  ,  0  },
+    /*              27 */    {  0  ,  0  },
+    /*              28 */    {  0  ,  0  },
+    /*              29 */    {  0  ,  0  },
+    /*              30 */    {  0  ,  0  },
+    /*              31 */    {  0  ,  0  },
+    /* space     32 32 */    { ' ' , ' ' },
+    /*              33 */    {  0  ,  0  },
+    /*              34 */    {  0  ,  0  },
+    /*              35 */    {  0  ,  0  },
+    /*              36 */    {  0  ,  0  },
+    /*              37 */    {  0  ,  0  },
+    /*              38 */    {  0  ,  0  },
+    /* punctuation  39 */    {  0  ,  0  },
+    /*              40 */    {  0  ,  0  },
+    /*              41 */    {  0  ,  0  },
+    /*              42 */    {  0  ,  0  },
+    /*              43 */    {  0  ,  0  },
+    /*              44 */    { ',' , '?' },
+    /*              45 */    { '-' , '_' },
+    /*              46 */    {  0  ,  0  },
+    /*              47 */    {  0  ,  0  },
+    /* 0         48 48 */    { '' , '0' },
+    /* 1            49 */    { '&' , '1' },
+    /* 2            50 */    { '' , '2' },
+    /* 3            51 */    { '"' , '3' },
+    /* 4            52 */    { '\'', '4' },
+    /* 5            53 */    { '(' , '5' },
+    /* 6            54 */    { '-' , '6' },
+    /* 7            55 */    { '' , '7' },
+    /* 8            56 */    { '_' , '8' },
+    /* 9            57 */    { '' , '9' },
+    /* :            58 */    { ':' ,  0  },
+    /* ;            59 */    { ';' ,  0  },
+    /* <            60 */    { '<' ,  0  },
+    /* =            61 */    { '=' , '+' },
+    /* >            62 */    { '>' ,  0  },
+    /* ?            63 */    { '?' ,  0  },
+    /* @         64 64 */    { '@' ,  0  },
+    /* A            65 */    { 'a' , 'A' },
+    /* B            66 */    { 'b' , 'B' },
+    /* C            67 */    { 'c' , 'C' },
+    /* D            68 */    { 'd' , 'D' },
+    /* E            69 */    { 'e' , 'E' },
+    /* F            70 */    { 'f' , 'F' },
+    /* G            71 */    { 'g' , 'G' },
+    /* H            72 */    { 'h' , 'H' },
+    /* I            73 */    { 'i' , 'I' },
+    /* J            74 */    { 'j' , 'J' },
+    /* K            75 */    { 'k' , 'K' },
+    /* L            76 */    { 'l' , 'L' },
+    /* M            77 */    { 'm' , 'M' },
+    /* N            78 */    { 'n' , 'N' },
+    /* O            79 */    { 'o' , 'O' },
+    /* P         80 80 */    { 'p' , 'P' },
+    /* Q            81 */    { 'q' , 'Q' },
+    /* R            82 */    { 'r' , 'R' },
+    /* S            83 */    { 's' , 'S' },
+    /* T            84 */    { 't' , 'T' },
+    /* U            85 */    { 'u' , 'U' },
+    /* V            86 */    { 'v' , 'V' },
+    /* W            87 */    { 'w' , 'W' },
+    /* X            88 */    { 'x' , 'X' },
+    /* Y            89 */    { 'y' , 'Y' },
+    /* Z            90 */    { 'z' , 'Z' },
+    /*              91 */    {  0  ,  0  },
+    /*              92 */    {  0  ,  0  },
+    /*              93 */    {  0  ,  0  },
+    /*              94 */    {  0  ,  0  },
+    /*              95 */    {  0  ,  0  },
+    /*           96 96 */    { '0' ,  0  },
+    /*              97 */    { '1' ,  0  },
+    /*              98 */    { '2' ,  0  },
+    /*              99 */    { '3' ,  0  },
+    /*              100*/    { '4' ,  0  },
+    /*              101*/    { '5' ,  0  },
+    /*              102*/    { '6' ,  0  },
+    /*              103*/    { '7' ,  0  },
+    /*              104*/    { '8' ,  0  },
+    /*              105*/    { '9' ,  0  },
+    /*              106*/    { '*' ,  0  },
+    /*              107*/    { '+' ,  0  },
+    /*              108*/    {  0  ,  0  },
+    /*              109*/    { '-' ,  0  },
+    /*              110*/    { '.' ,  0  },
+    /*              111*/    { '/' ,  0  },
+    /*          112 112*/    {  0  ,  0  },
+    /*              113*/    {  0  ,  0  },
+    /*              114*/    {  0  ,  0  },
+    /*              115*/    {  0  ,  0  },
+    /*              116*/    {  0  ,  0  },
+    /*              117*/    {  0  ,  0  },
+    /*              118*/    {  0  ,  0  },
+    /*              119*/    {  0  ,  0  },
+    /*              120*/    {  0  ,  0  },
+    /*              121*/    {  0  ,  0  },
+    /*              122*/    {  0  ,  0  },
+    /*              123*/    {  0  ,  0  },
+    /*              124*/    {  0  ,  0  },
+    /*              125*/    {  0  ,  0  },
+    /*              126*/    {  0  ,  0  },
+    /*              127*/    {  0  ,  0  },
+    /*          128 128*/    {  0  ,  0  },
+    /*              129*/    {  0  ,  0  },
+    /*              130*/    {  0  ,  0  },
+    /*              131*/    {  0  ,  0  },
+    /*              132*/    {  0  ,  0  },
+    /*              133*/    {  0  ,  0  },
+    /*              134*/    {  0  ,  0  },
+    /*              135*/    {  0  ,  0  },
+    /*              136*/    {  0  ,  0  },
+    /*              137*/    {  0  ,  0  },
+    /*              138*/    {  0  ,  0  },
+    /*              139*/    {  0  ,  0  },
+    /*              140*/    {  0  ,  0  },
+    /*              141*/    {  0  ,  0  },
+    /*              142*/    {  0  ,  0  },
+    /*              143*/    {  0  ,  0  },
+    /*          144 144*/    {  0  ,  0  },
+    /*              145*/    {  0  ,  0  },
+    /*              146*/    {  0  ,  0  },
+    /*              147*/    {  0  ,  0  },
+    /*              148*/    {  0  ,  0  },
+    /*              149*/    {  0  ,  0  },
+    /*              150*/    {  0  ,  0  },
+    /*              151*/    {  0  ,  0  },
+    /*              152*/    {  0  ,  0  },
+    /*              153*/    {  0  ,  0  },
+    /*              154*/    {  0  ,  0  },
+    /*              155*/    {  0  ,  0  },
+    /*              156*/    {  0  ,  0  },
+    /*              157*/    {  0  ,  0  },
+    /*              158*/    {  0  ,  0  },
+    /*              159*/    {  0  ,  0  },
+    /*          160 160*/    {  0  ,  0  },
+    /*              161*/    {  0  ,  0  },
+    /*              162*/    {  0  ,  0  },
+    /*              163*/    {  0  ,  0  },
+    /*              164*/    {  0  ,  0  },
+    /*              165*/    {  0  ,  0  },
+    /*              166*/    {  0  ,  0  },
+    /*              167*/    { '!' , '' },
+    /*              168*/    {  0  ,  0  },
+    /*              169*/    {  0  ,  0  },
+    /*              170*/    {  0  ,  0  },
+    /*              171*/    {  0  ,  0  },
+    /*              172*/    {  0  ,  0  },
+    /*              173*/    {  0  ,  0  },
+    /*              174*/    {  0  ,  0  },
+    /*              175*/    {  0  ,  0  },
+    /*          176 176*/    {  0  ,  0  },
+    /*              177*/    {  0  ,  0  },
+    /*              178*/    {  0  ,  0  },
+    /*              179*/    {  0  ,  0  },
+    /*              180*/    {  0  ,  0  },
+    /*              181*/    {  0  ,  0  },
+    /*              182*/    {  0  ,  0  },
+    /*              183*/    {  0  ,  0  },
+    /*              184*/    {  0  ,  0  },
+    /*              185*/    {  0  ,  0  },
+    /*              186*/    { ';' , ':' },
+    /*              187*/    { '=' , '+' },
+    /*              188*/    { ';' , '.' },
+    /*              189*/    { ')' , '' },
+    /*              190*/    { ':' , '/' },
+    /*              191*/    { '/' , '?' },
+    /*          192 192*/    { '' ,  0  },
+    /*              193*/    {  0  ,  0  },
+    /*              194*/    {  0  ,  0  },
+    /*              195*/    {  0  ,  0  },
+    /*              196*/    {  0  ,  0  },
+    /*              197*/    {  0  ,  0  },
+    /*              198*/    {  0  ,  0  },
+    /*              199*/    {  0  ,  0  },
+    /*              200*/    {  0  ,  0  },
+    /*              201*/    {  0  ,  0  },
+    /*              202*/    {  0  ,  0  },
+    /*              203*/    {  0  ,  0  },
+    /*              204*/    {  0  ,  0  },
+    /*              205*/    {  0  ,  0  },
+    /*              206*/    {  0  ,  0  },
+    /*              207*/    {  0  ,  0  },
+    /*          208 208*/    {  0  ,  0  },
+    /*              209*/    {  0  ,  0  },
+    /*              210*/    {  0  ,  0  },
+    /*              211*/    {  0  ,  0  },
+    /*              212*/    {  0  ,  0  },
+    /*              213*/    {  0  ,  0  },
+    /*              214*/    {  0  ,  0  },
+    /*              215*/    {  0  ,  0  },
+    /*              216*/    {  0  ,  0  },
+    /*              217*/    {  0  ,  0  },
+    /*              218*/    {  0  ,  0  },
+    /*              219*/    { '' , '' },
+    /*              220*/    { '*' , '' },
+    /*              221*/    { '$' , '' },
+    /*              222*/    { '\'', '"' },
+    /*              223*/    {  0  ,  0  },
+    /*          224 224*/    {  0  ,  0  },
+    /*              225*/    {  0  ,  0  },
+    /*              226*/    {  0  ,  0  },
+    /*              227*/    {  0  ,  0  },
+    /*              228*/    {  0  ,  0  },
+    /*              229*/    {  0  ,  0  },
+    /*              230*/    {  0  ,  0  },
+    /*              231*/    {  0  ,  0  },
+    /*              232*/    {  0  ,  0  },
+    /*              233*/    {  0  ,  0  },
+    /*              234*/    {  0  ,  0  },
+    /*              235*/    {  0  ,  0  },
+    /*              236*/    {  0  ,  0  },
+    /*              237*/    {  0  ,  0  },
+    /*              238*/    {  0  ,  0  },
+    /*              239*/    {  0  ,  0  },
+    /*          240 240*/    {  0  ,  0  },
+    /*              241*/    {  0  ,  0  },
+    /*              242*/    {  0  ,  0  },
+    /*              243*/    {  0  ,  0  },
+    /*              244*/    {  0  ,  0  },
+    /*              245*/    {  0  ,  0  },
+    /*              246*/    {  0  ,  0  },
+    /*              247*/    {  0  ,  0  },
+    /*              248*/    {  0  ,  0  },
+    /*              249*/    { '' , '%' },
+    /*              250*/    {  0  ,  0  },
+    /*              251*/    {  0  ,  0  },
+    /*              252*/    {  0  ,  0  },
+    /*              253*/    {  0  ,  0  },
+    /*              254*/    {  0  ,  0  },
+    /*              255*/    {  0  ,  0  },
 };
 
 uicKeyTable uicGermanKeyEntryTable[KEY_TOTAL_KEYS] =
 {
-    /*            0 0  */  0,    0,
-    /*              1  */  0,    0,
-    /*              2  */  0,    0,
-    /*              3  */  0,    0,
-    /*              4  */  0,    0,
-    /*              5  */  0,    0,
-    /*              6  */  0,    0,
-    /*              7  */  0,    0,
-    /*              8  */  0,    0,
-    /*              9  */  0,    0,
-    /*              10 */  0,    0,
-    /*              11 */  0,    0,
-    /*              12 */  0,    0,
-    /*              13 */  0,    0,
-    /*              14 */  0,    0,
-    /*              15 */  0,    0,
-    /*           16 16 */  0,    0,
-    /*              17 */  0,    0,
-    /*              18 */  0,    0,
-    /*              19 */  0,    0,
-    /*              20 */  0,    0,
-    /*              21 */  0,    0,
-    /*              22 */  0,    0,
-    /*              23 */  0,    0,
-    /*              24 */  0,    0,
-    /*              25 */  0,    0,
-    /*              26 */  0,    0,
-    /*              27 */  0,    0,
-    /*              28 */  0,    0,
-    /*              29 */  0,    0,
-    /*              30 */  0,    0,
-    /*              31 */  0,    0,
-    /* space     32 32 */  ' ',  ' ',
-    /*              33 */  0,    0,
-    /*              34 */  0,    0,
-    /*              35 */  0,    0,
-    /*              36 */  0,    0,
-    /*              37 */  0,    0,
-    /*              38 */  0,    0,
-    /* punctuation  39 */  0,    0,
-    /*              40 */  0,    0,
-    /*              41 */  0,    0,
-    /*              42 */  0,    0,
-    /*              43 */  0,    0,
-    /*              44 */  ',',  '?',
-    /*              45 */  0,    0,
-    /*              46 */  0,    0,
-    /*              47 */  0,    0,
-    /* 0         48 48 */  '0',  '=',
-    /* 1            49 */  '1',  '!',
-    /* 2            50 */  '2',  '"',
-    /* 3            51 */  '3',  '',
-    /* 4            52 */  '4',  '$',
-    /* 5            53 */  '5',  '%',
-    /* 6            54 */  '6',  '&',
-    /* 7            55 */  '7',  '/',
-    /* 8            56 */  '8',  '(',
-    /* 9            57 */  '9',  ')',
-    /* :            58 */  ':',  0,
-    /* ;            59 */  ';',  0,
-    /* <            60 */  '<',  0,
-    /* =            61 */  '=',  0,
-    /* >            62 */  '>',  0,
-    /* ?            63 */  '?',  0,
-    /* @         64 64 */  '@',  0,
-    /* A            65 */  'a',  'A',
-    /* B            66 */  'b',  'B',
-    /* C            67 */  'c',  'C',
-    /* D            68 */  'd',  'D',
-    /* E            69 */  'e',  'E',
-    /* F            70 */  'f',  'F',
-    /* G            71 */  'g',  'G',
-    /* H            72 */  'h',  'H',
-    /* I            73 */  'i',  'I',
-    /* J            74 */  'j',  'J',
-    /* K            75 */  'k',  'K',
-    /* L            76 */  'l',  'L',
-    /* M            77 */  'm',  'M',
-    /* N            78 */  'n',  'N',
-    /* O            79 */  'o',  'O',
-    /* P         80 80 */  'p',  'P',
-    /* Q            81 */  'q',  'Q',
-    /* R            82 */  'r',  'R',
-    /* S            83 */  's',  'S',
-    /* T            84 */  't',  'T',
-    /* U            85 */  'u',  'U',
-    /* V            86 */  'v',  'V',
-    /* W            87 */  'w',  'W',
-    /* X            88 */  'x',  'X',
-    /* Y            89 */  'y',  'Y',
-    /* Z            90 */  'z',  'Z',
-    /*              91 */  0,    0,
-    /*              92 */  0,    0,
-    /*              93 */  0,    0,
-    /*              94 */  0,    0,
-    /*              95 */  0,    0,
-    /*           96 96 */  '0',  0,
-    /*              97 */  '1',  0,
-    /*              98 */  '2',  0,
-    /*              99 */  '3',  0,
-    /*              100*/  '4',  0,
-    /*              101*/  '5',  0,
-    /*              102*/  '6',  0,
-    /*              103*/  '7',  0,
-    /*              104*/  '8',  0,
-    /*              105*/  '9',  0,
-    /*              106*/  '*',  0,
-    /*              107*/  '+',  0,
-    /*              108*/  0,    0,
-    /*              109*/  '-',  0,
-    /*              110*/  '.',  0,
-    /*              111*/  '/',  0,
-    /*          112 112*/  0,    0,
-    /*              113*/  0,    0,
-    /*              114*/  0,    0,
-    /*              115*/  0,    0,
-    /*              116*/  0,    0,
-    /*              117*/  0,    0,
-    /*              118*/  0,    0,
-    /*              119*/  0,    0,
-    /*              120*/  0,    0,
-    /*              121*/  0,    0,
-    /*              122*/  0,    0,
-    /*              123*/  0,    0,
-    /*              124*/  0,    0,
-    /*              125*/  0,    0,
-    /*              126*/  0,    0,
-    /*              127*/  0,    0,
-    /*          128 128*/  0,    0,
-    /*              129*/  0,    0,
-    /*              130*/  0,    0,
-    /*              131*/  0,    0,
-    /*              132*/  0,    0,
-    /*              133*/  0,    0,
-    /*              134*/  0,    0,
-    /*              135*/  0,    0,
-    /*              136*/  0,    0,
-    /*              137*/  0,    0,
-    /*              138*/  0,    0,
-    /*              139*/  0,    0,
-    /*              140*/  0,    0,
-    /*              141*/  0,    0,
-    /*              142*/  0,    0,
-    /*              143*/  0,    0,
-    /*          144 144*/  0,    0,
-    /*              145*/  0,    0,
-    /*              146*/  0,    0,
-    /*              147*/  0,    0,
-    /*              148*/  0,    0,
-    /*              149*/  0,    0,
-    /*              150*/  0,    0,
-    /*              151*/  0,    0,
-    /*              152*/  0,    0,
-    /*              153*/  0,    0,
-    /*              154*/  0,    0,
-    /*              155*/  0,    0,
-    /*              156*/  0,    0,
-    /*              157*/  0,    0,
-    /*              158*/  0,    0,
-    /*              159*/  0,    0,
-    /*          160 160*/  0,    0,
-    /*              161*/  0,    0,
-    /*              162*/  0,    0,
-    /*              163*/  0,    0,
-    /*              164*/  0,    0,
-    /*              165*/  0,    0,
-    /*              166*/  0,    0,
-    /*              167*/  0,    0,
-    /*              168*/  0,    0,
-    /*              169*/  0,    0,
-    /*              170*/  0,    0,
-    /*              171*/  0,    0,
-    /*              172*/  0,    0,
-    /*              173*/  0,    0,
-    /*              174*/  0,    0,
-    /*              175*/  0,    0,
-    /*          176 176*/  0,    0,
-    /*              177*/  0,    0,
-    /*              178*/  0,    0,
-    /*              179*/  0,    0,
-    /*              180*/  0,    0,
-    /*              181*/  0,    0,
-    /*              182*/  0,    0,
-    /*              183*/  0,    0,
-    /*              184*/  0,    0,
-    /*              185*/  0,    0,
-    /*              186*/  ';',  ':',
-    /*              187*/  '',  '`',
-    /*              188*/  ',',  ';',
-    /*              189*/  '',  '?',
-    /*              190*/  '.',  ':',
-    /*              191*/  '/',  '?',
-    /*          192 192*/  '',  '',
-    /*              193*/  0,    0,
-    /*              194*/  0,    0,
-    /*              195*/  0,    0,
-    /*              196*/  0,    0,
-    /*              197*/  0,    0,
-    /*              198*/  0,    0,
-    /*              199*/  0,    0,
-    /*              200*/  '-',  '_',
-    /*              201*/  0,    0,
-    /*              202*/  0,    0,
-    /*              203*/  0,    0,
-    /*              204*/  0,    0,
-    /*              205*/  0,    0,
-    /*              206*/  0,    0,
-    /*              207*/  0,    0,
-    /*          208 208*/  0,    0,
-    /*              209*/  0,    0,
-    /*              210*/  0,    0,
-    /*              211*/  0,    0,
-    /*              212*/  0,    0,
-    /*              213*/  0,    0,
-    /*              214*/  0,    0,
-    /*              215*/  0,    0,
-    /*              216*/  0,    0,
-    /*              217*/  0,    0,
-    /*              218*/  0,    0,
-    /*              219*/  '',  '',
-    /*              220*/  '#',  '\'',
-    /*              221*/  '+',  '*',
-    /*              222*/  '\'', '"',
-    /*              223*/  0,    0,
-    /*          224 224*/  0,    0,
-    /*              225*/  0,    0,
-    /*              226*/  0,    0,
-    /*              227*/  0,    0,
-    /*              228*/  '',  '',
-    /*              229*/  0,    0,
-    /*              230*/  0,    0,
-    /*              231*/  0,    0,
-    /*              232*/  0,    0,
-    /*              233*/  0,    0,
-    /*              234*/  0,    0,
-    /*              235*/  0,    0,
-    /*              236*/  0,    0,
-    /*              237*/  0,    0,
-    /*              238*/  0,    0,
-    /*              239*/  0,    0,
-    /*          240 240*/  0,    0,
-    /*              241*/  0,    0,
-    /*              242*/  0,    0,
-    /*              243*/  0,    0,
-    /*              244*/  0,    0,
-    /*              245*/  0,    0,
-    /*              246*/  '',  '',
-    /*              247*/  0,    0,
-    /*              248*/  0,    0,
-    /*              249*/  0,    0,
-    /*              250*/  0,    0,
-    /*              251*/  0,    0,
-    /*              252*/  0,    0,
-    /*              253*/  0,    0,
-    /*              254*/  0,    0,
-    /*              255*/  0,    0,
+    /*            0 0  */    {  0  ,  0  },
+    /*              1  */    {  0  ,  0  },
+    /*              2  */    {  0  ,  0  },
+    /*              3  */    {  0  ,  0  },
+    /*              4  */    {  0  ,  0  },
+    /*              5  */    {  0  ,  0  },
+    /*              6  */    {  0  ,  0  },
+    /*              7  */    {  0  ,  0  },
+    /*              8  */    {  0  ,  0  },
+    /*              9  */    {  0  ,  0  },
+    /*              10 */    {  0  ,  0  },
+    /*              11 */    {  0  ,  0  },
+    /*              12 */    {  0  ,  0  },
+    /*              13 */    {  0  ,  0  },
+    /*              14 */    {  0  ,  0  },
+    /*              15 */    {  0  ,  0  },
+    /*           16 16 */    {  0  ,  0  },
+    /*              17 */    {  0  ,  0  },
+    /*              18 */    {  0  ,  0  },
+    /*              19 */    {  0  ,  0  },
+    /*              20 */    {  0  ,  0  },
+    /*              21 */    {  0  ,  0  },
+    /*              22 */    {  0  ,  0  },
+    /*              23 */    {  0  ,  0  },
+    /*              24 */    {  0  ,  0  },
+    /*              25 */    {  0  ,  0  },
+    /*              26 */    {  0  ,  0  },
+    /*              27 */    {  0  ,  0  },
+    /*              28 */    {  0  ,  0  },
+    /*              29 */    {  0  ,  0  },
+    /*              30 */    {  0  ,  0  },
+    /*              31 */    {  0  ,  0  },
+    /* space     32 32 */    { ' ' , ' ' },
+    /*              33 */    {  0  ,  0  },
+    /*              34 */    {  0  ,  0  },
+    /*              35 */    {  0  ,  0  },
+    /*              36 */    {  0  ,  0  },
+    /*              37 */    {  0  ,  0  },
+    /*              38 */    {  0  ,  0  },
+    /* punctuation  39 */    {  0  ,  0  },
+    /*              40 */    {  0  ,  0  },
+    /*              41 */    {  0  ,  0  },
+    /*              42 */    {  0  ,  0  },
+    /*              43 */    {  0  ,  0  },
+    /*              44 */    { ',' , '?' },
+    /*              45 */    {  0  ,  0  },
+    /*              46 */    {  0  ,  0  },
+    /*              47 */    {  0  ,  0  },
+    /* 0         48 48 */    { '0' , '=' },
+    /* 1            49 */    { '1' , '!' },
+    /* 2            50 */    { '2' , '"' },
+    /* 3            51 */    { '3' , '' },
+    /* 4            52 */    { '4' , '$' },
+    /* 5            53 */    { '5' , '%' },
+    /* 6            54 */    { '6' , '&' },
+    /* 7            55 */    { '7' , '/' },
+    /* 8            56 */    { '8' , '(' },
+    /* 9            57 */    { '9' , ')' },
+    /* :            58 */    { ':' ,  0  },
+    /* ;            59 */    { ';' ,  0  },
+    /* <            60 */    { '<' ,  0  },
+    /* =            61 */    { '=' ,  0  },
+    /* >            62 */    { '>' ,  0  },
+    /* ?            63 */    { '?' ,  0  },
+    /* @         64 64 */    { '@' ,  0  },
+    /* A            65 */    { 'a' , 'A' },
+    /* B            66 */    { 'b' , 'B' },
+    /* C            67 */    { 'c' , 'C' },
+    /* D            68 */    { 'd' , 'D' },
+    /* E            69 */    { 'e' , 'E' },
+    /* F            70 */    { 'f' , 'F' },
+    /* G            71 */    { 'g' , 'G' },
+    /* H            72 */    { 'h' , 'H' },
+    /* I            73 */    { 'i' , 'I' },
+    /* J            74 */    { 'j' , 'J' },
+    /* K            75 */    { 'k' , 'K' },
+    /* L            76 */    { 'l' , 'L' },
+    /* M            77 */    { 'm' , 'M' },
+    /* N            78 */    { 'n' , 'N' },
+    /* O            79 */    { 'o' , 'O' },
+    /* P         80 80 */    { 'p' , 'P' },
+    /* Q            81 */    { 'q' , 'Q' },
+    /* R            82 */    { 'r' , 'R' },
+    /* S            83 */    { 's' , 'S' },
+    /* T            84 */    { 't' , 'T' },
+    /* U            85 */    { 'u' , 'U' },
+    /* V            86 */    { 'v' , 'V' },
+    /* W            87 */    { 'w' , 'W' },
+    /* X            88 */    { 'x' , 'X' },
+    /* Y            89 */    { 'y' , 'Y' },
+    /* Z            90 */    { 'z' , 'Z' },
+    /*              91 */    {  0  ,  0  },
+    /*              92 */    {  0  ,  0  },
+    /*              93 */    {  0  ,  0  },
+    /*              94 */    {  0  ,  0  },
+    /*              95 */    {  0  ,  0  },
+    /*           96 96 */    { '0' ,  0  },
+    /*              97 */    { '1' ,  0  },
+    /*              98 */    { '2' ,  0  },
+    /*              99 */    { '3' ,  0  },
+    /*              100*/    { '4' ,  0  },
+    /*              101*/    { '5' ,  0  },
+    /*              102*/    { '6' ,  0  },
+    /*              103*/    { '7' ,  0  },
+    /*              104*/    { '8' ,  0  },
+    /*              105*/    { '9' ,  0  },
+    /*              106*/    { '*' ,  0  },
+    /*              107*/    { '+' ,  0  },
+    /*              108*/    {  0  ,  0  },
+    /*              109*/    { '-' ,  0  },
+    /*              110*/    { '.' ,  0  },
+    /*              111*/    { '/' ,  0  },
+    /*          112 112*/    {  0  ,  0  },
+    /*              113*/    {  0  ,  0  },
+    /*              114*/    {  0  ,  0  },
+    /*              115*/    {  0  ,  0  },
+    /*              116*/    {  0  ,  0  },
+    /*              117*/    {  0  ,  0  },
+    /*              118*/    {  0  ,  0  },
+    /*              119*/    {  0  ,  0  },
+    /*              120*/    {  0  ,  0  },
+    /*              121*/    {  0  ,  0  },
+    /*              122*/    {  0  ,  0  },
+    /*              123*/    {  0  ,  0  },
+    /*              124*/    {  0  ,  0  },
+    /*              125*/    {  0  ,  0  },
+    /*              126*/    {  0  ,  0  },
+    /*              127*/    {  0  ,  0  },
+    /*          128 128*/    {  0  ,  0  },
+    /*              129*/    {  0  ,  0  },
+    /*              130*/    {  0  ,  0  },
+    /*              131*/    {  0  ,  0  },
+    /*              132*/    {  0  ,  0  },
+    /*              133*/    {  0  ,  0  },
+    /*              134*/    {  0  ,  0  },
+    /*              135*/    {  0  ,  0  },
+    /*              136*/    {  0  ,  0  },
+    /*              137*/    {  0  ,  0  },
+    /*              138*/    {  0  ,  0  },
+    /*              139*/    {  0  ,  0  },
+    /*              140*/    {  0  ,  0  },
+    /*              141*/    {  0  ,  0  },
+    /*              142*/    {  0  ,  0  },
+    /*              143*/    {  0  ,  0  },
+    /*          144 144*/    {  0  ,  0  },
+    /*              145*/    {  0  ,  0  },
+    /*              146*/    {  0  ,  0  },
+    /*              147*/    {  0  ,  0  },
+    /*              148*/    {  0  ,  0  },
+    /*              149*/    {  0  ,  0  },
+    /*              150*/    {  0  ,  0  },
+    /*              151*/    {  0  ,  0  },
+    /*              152*/    {  0  ,  0  },
+    /*              153*/    {  0  ,  0  },
+    /*              154*/    {  0  ,  0  },
+    /*              155*/    {  0  ,  0  },
+    /*              156*/    {  0  ,  0  },
+    /*              157*/    {  0  ,  0  },
+    /*              158*/    {  0  ,  0  },
+    /*              159*/    {  0  ,  0  },
+    /*          160 160*/    {  0  ,  0  },
+    /*              161*/    {  0  ,  0  },
+    /*              162*/    {  0  ,  0  },
+    /*              163*/    {  0  ,  0  },
+    /*              164*/    {  0  ,  0  },
+    /*              165*/    {  0  ,  0  },
+    /*              166*/    {  0  ,  0  },
+    /*              167*/    {  0  ,  0  },
+    /*              168*/    {  0  ,  0  },
+    /*              169*/    {  0  ,  0  },
+    /*              170*/    {  0  ,  0  },
+    /*              171*/    {  0  ,  0  },
+    /*              172*/    {  0  ,  0  },
+    /*              173*/    {  0  ,  0  },
+    /*              174*/    {  0  ,  0  },
+    /*              175*/    {  0  ,  0  },
+    /*          176 176*/    {  0  ,  0  },
+    /*              177*/    {  0  ,  0  },
+    /*              178*/    {  0  ,  0  },
+    /*              179*/    {  0  ,  0  },
+    /*              180*/    {  0  ,  0  },
+    /*              181*/    {  0  ,  0  },
+    /*              182*/    {  0  ,  0  },
+    /*              183*/    {  0  ,  0  },
+    /*              184*/    {  0  ,  0  },
+    /*              185*/    {  0  ,  0  },
+    /*              186*/    { ';' , ':' },
+    /*              187*/    { '' , '`' },
+    /*              188*/    { ',' , ';' },
+    /*              189*/    { '' , '?' },
+    /*              190*/    { '.' , ':' },
+    /*              191*/    { '/' , '?' },
+    /*          192 192*/    { '' , '' },
+    /*              193*/    {  0  ,  0  },
+    /*              194*/    {  0  ,  0  },
+    /*              195*/    {  0  ,  0  },
+    /*              196*/    {  0  ,  0  },
+    /*              197*/    {  0  ,  0  },
+    /*              198*/    {  0  ,  0  },
+    /*              199*/    {  0  ,  0  },
+    /*              200*/    { '-' , '_' },
+    /*              201*/    {  0  ,  0  },
+    /*              202*/    {  0  ,  0  },
+    /*              203*/    {  0  ,  0  },
+    /*              204*/    {  0  ,  0  },
+    /*              205*/    {  0  ,  0  },
+    /*              206*/    {  0  ,  0  },
+    /*              207*/    {  0  ,  0  },
+    /*          208 208*/    {  0  ,  0  },
+    /*              209*/    {  0  ,  0  },
+    /*              210*/    {  0  ,  0  },
+    /*              211*/    {  0  ,  0  },
+    /*              212*/    {  0  ,  0  },
+    /*              213*/    {  0  ,  0  },
+    /*              214*/    {  0  ,  0  },
+    /*              215*/    {  0  ,  0  },
+    /*              216*/    {  0  ,  0  },
+    /*              217*/    {  0  ,  0  },
+    /*              218*/    {  0  ,  0  },
+    /*              219*/    { '' , '' },
+    /*              220*/    { '#' , '\''},
+    /*              221*/    { '+' , '*' },
+    /*              222*/    { '\'', '"' },
+    /*              223*/    {  0  ,  0  },
+    /*          224 224*/    {  0  ,  0  },
+    /*              225*/    {  0  ,  0  },
+    /*              226*/    {  0  ,  0  },
+    /*              227*/    {  0  ,  0  },
+    /*              228*/    { '' , '' },
+    /*              229*/    {  0  ,  0  },
+    /*              230*/    {  0  ,  0  },
+    /*              231*/    {  0  ,  0  },
+    /*              232*/    {  0  ,  0  },
+    /*              233*/    {  0  ,  0  },
+    /*              234*/    {  0  ,  0  },
+    /*              235*/    {  0  ,  0  },
+    /*              236*/    {  0  ,  0  },
+    /*              237*/    {  0  ,  0  },
+    /*              238*/    {  0  ,  0  },
+    /*              239*/    {  0  ,  0  },
+    /*          240 240*/    {  0  ,  0  },
+    /*              241*/    {  0  ,  0  },
+    /*              242*/    {  0  ,  0  },
+    /*              243*/    {  0  ,  0  },
+    /*              244*/    {  0  ,  0  },
+    /*              245*/    {  0  ,  0  },
+    /*              246*/    { '' , '' },
+    /*              247*/    {  0  ,  0  },
+    /*              248*/    {  0  ,  0  },
+    /*              249*/    {  0  ,  0  },
+    /*              250*/    {  0  ,  0  },
+    /*              251*/    {  0  ,  0  },
+    /*              252*/    {  0  ,  0  },
+    /*              253*/    {  0  ,  0  },
+    /*              254*/    {  0  ,  0  },
+    /*              255*/    {  0  ,  0  },
 };
 
 uicKeyTable uicSpanishKeyEntryTable[KEY_TOTAL_KEYS] =
 {
-    /*            0 0  */  0,    0,
-    /*              1  */  0,    0,
-    /*              2  */  0,    0,
-    /*              3  */  0,    0,
-    /*              4  */  0,    0,
-    /*              5  */  0,    0,
-    /*              6  */  0,    0,
-    /*              7  */  0,    0,
-    /*              8  */  0,    0,
-    /*              9  */  0,    0,
-    /*              10 */  0,    0,
-    /*              11 */  0,    0,
-    /*              12 */  0,    0,
-    /*              13 */  0,    0,
-    /*              14 */  0,    0,
-    /*              15 */  0,    0,
-    /*           16 16 */  0,    0,
-    /*              17 */  0,    0,
-    /*              18 */  0,    0,
-    /*              19 */  0,    0,
-    /*              20 */  0,    0,
-    /*              21 */  0,    0,
-    /*              22 */  0,    0,
-    /*              23 */  0,    0,
-    /*              24 */  0,    0,
-    /*              25 */  0,    0,
-    /*              26 */  0,    0,
-    /*              27 */  0,    0,
-    /*              28 */  0,    0,
-    /*              29 */  0,    0,
-    /*              30 */  0,    0,
-    /*              31 */  0,    0,
-    /* space     32 32 */  ' ',  ' ',
-    /*              33 */  0,    0,
-    /*              34 */  0,    0,
-    /*              35 */  0,    0,
-    /*              36 */  0,    0,
-    /*              37 */  0,    0,
-    /*              38 */  0,    0,
-    /* punctuation  39 */  0,    0,
-    /*              40 */  0,    0,
-    /*              41 */  0,    0,
-    /*              42 */  0,    0,
-    /*              43 */  0,    0,
-    /*              44 */  0,    0,
-    /*              45 */  '-',  '_',
-    /*              46 */  0,    0,
-    /*              47 */  0,    0,
-    /* 0         48 48 */  '0',  '=',
-    /* 1            49 */  '1',  '!',
-    /* 2            50 */  '2',  '"',
-    /* 3            51 */  '3',  '',
-    /* 4            52 */  '4',  '$',
-    /* 5            53 */  '5',  '%',
-    /* 6            54 */  '6',  '&',
-    /* 7            55 */  '7',  '/',
-    /* 8            56 */  '8',  '(',
-    /* 9            57 */  '9',  ')',
-    /* :            58 */  ':',  0,
-    /* ;            59 */  ';',  0,
-    /* <            60 */  '<',  0,
-    /* =            61 */  '=',  '+',
-    /* >            62 */  '>',  0,
-    /* ?            63 */  '?',  0,
-    /* @         64 64 */  '@',  0,
-    /* A            65 */  'a',  'A',
-    /* B            66 */  'b',  'B',
-    /* C            67 */  'c',  'C',
-    /* D            68 */  'd',  'D',
-    /* E            69 */  'e',  'E',
-    /* F            70 */  'f',  'F',
-    /* G            71 */  'g',  'G',
-    /* H            72 */  'h',  'H',
-    /* I            73 */  'i',  'I',
-    /* J            74 */  'j',  'J',
-    /* K            75 */  'k',  'K',
-    /* L            76 */  'l',  'L',
-    /* M            77 */  'm',  'M',
-    /* N            78 */  'n',  'N',
-    /* O            79 */  'o',  'O',
-    /* P         80 80 */  'p',  'P',
-    /* Q            81 */  'q',  'Q',
-    /* R            82 */  'r',  'R',
-    /* S            83 */  's',  'S',
-    /* T            84 */  't',  'T',
-    /* U            85 */  'u',  'U',
-    /* V            86 */  'v',  'V',
-    /* W            87 */  'w',  'W',
-    /* X            88 */  'x',  'X',
-    /* Y            89 */  'y',  'Y',
-    /* Z            90 */  'z',  'Z',
-    /*              91 */  0,    0,
-    /*              92 */  0,    0,
-    /*              93 */  0,    0,
-    /*              94 */  0,    0,
-    /*              95 */  0,    0,
-    /*           96 96 */  '0',  0,
-    /*              97 */  '1',  0,
-    /*              98 */  '2',  0,
-    /*              99 */  '3',  0,
-    /*              100*/  '4',  0,
-    /*              101*/  '5',  0,
-    /*              102*/  '6',  0,
-    /*              103*/  '7',  0,
-    /*              104*/  '8',  0,
-    /*              105*/  '9',  0,
-    /*              106*/  '*',  0,
-    /*              107*/  '+',  0,
-    /*              108*/  0,    0,
-    /*              109*/  '-',  0,
-    /*              110*/  '.',  0,
-    /*              111*/  '/',  0,
-    /*          112 112*/  0,    0,
-    /*              113*/  0,    0,
-    /*              114*/  0,    0,
-    /*              115*/  0,    0,
-    /*              116*/  0,    0,
-    /*              117*/  0,    0,
-    /*              118*/  0,    0,
-    /*              119*/  0,    0,
-    /*              120*/  0,    0,
-    /*              121*/  0,    0,
-    /*              122*/  0,    0,
-    /*              123*/  0,    0,
-    /*              124*/  0,    0,
-    /*              125*/  0,    0,
-    /*              126*/  0,    0,
-    /*              127*/  0,    0,
-    /*          128 128*/  0,    0,
-    /*              129*/  0,    0,
-    /*              130*/  0,    0,
-    /*              131*/  0,    0,
-    /*              132*/  0,    0,
-    /*              133*/  0,    0,
-    /*              134*/  0,    0,
-    /*              135*/  0,    0,
-    /*              136*/  0,    0,
-    /*              137*/  0,    0,
-    /*              138*/  0,    0,
-    /*              139*/  0,    0,
-    /*              140*/  0,    0,
-    /*              141*/  0,    0,
-    /*              142*/  0,    0,
-    /*              143*/  0,    0,
-    /*          144 144*/  0,    0,
-    /*              145*/  0,    0,
-    /*              146*/  0,    0,
-    /*              147*/  0,    0,
-    /*              148*/  0,    0,
-    /*              149*/  0,    0,
-    /*              150*/  0,    0,
-    /*              151*/  0,    0,
-    /*              152*/  0,    0,
-    /*              153*/  0,    0,
-    /*              154*/  0,    0,
-    /*              155*/  0,    0,
-    /*              156*/  0,    0,
-    /*              157*/  0,    0,
-    /*              158*/  0,    0,
-    /*              159*/  0,    0,
-    /*          160 160*/  0,    0,
-    /*              161*/  0,    0,
-    /*              162*/  0,    0,
-    /*              163*/  0,    0,
-    /*              164*/  0,    0,
-    /*              165*/  0,    0,
-    /*              166*/  0,    0,
-    /*              167*/  0,    0,
-    /*              168*/  0,    0,
-    /*              169*/  0,    0,
-    /*              170*/  0,    0,
-    /*              171*/  0,    0,
-    /*              172*/  0,    0,
-    /*              173*/  0,    0,
-    /*              174*/  0,    0,
-    /*              175*/  0,    0,
-    /*          176 176*/  0,    0,
-    /*              177*/  0,    0,
-    /*              178*/  0,    0,
-    /*              179*/  0,    0,
-    /*              180*/  '',  '',
-    /*              181*/  0,    0,
-    /*              182*/  0,    0,
-    /*              183*/  0,    0,
-    /*              184*/  0,    0,
-    /*              185*/  0,    0,
-    /*              186*/  ';',  ':',
-    /*              187*/  '',  '',
-    /*              188*/  ',',  ';',
-    /*              189*/  '\'',  '?',
-    /*              190*/  '.',  ':',
-    /*              191*/  '/',  '?',
-    /*          192 192*/  '',  '',
-    /*              193*/  0,    0,
-    /*              194*/  0,    0,
-    /*              195*/  0,    0,
-    /*              196*/  0,    0,
-    /*              197*/  0,    0,
-    /*              198*/  0,    0,
-    /*              199*/  0,    0,
-    /*              200*/  '-',  '_',
-    /*              201*/  0,    0,
-    /*              202*/  0,    0,
-    /*              203*/  0,    0,
-    /*              204*/  0,    0,
-    /*              205*/  0,    0,
-    /*              206*/  0,    0,
-    /*              207*/  0,    0,
-    /*          208 208*/  0,    0,
-    /*              209*/  0,    0,
-    /*              210*/  0,    0,
-    /*              211*/  0,    0,
-    /*              212*/  0,    0,
-    /*              213*/  0,    0,
-    /*              214*/  0,    0,
-    /*              215*/  0,    0,
-    /*              216*/  0,    0,
-    /*              217*/  0,    0,
-    /*              218*/  0,    0,
-    /*              219*/  '`',  '^',
-    /*              220*/  '',  '',
-    /*              221*/  '+',  '*',
-    /*              222*/  '\'',  '"',
-    /*              223*/  0,    0,
-    /*          224 224*/  0,    0,
-    /*              225*/  0,    0,
-    /*              226*/  0,    0,
-    /*              227*/  0,    0,
-    /*              228*/  0,    0,
-    /*              229*/  0,    0,
-    /*              230*/  0,    0,
-    /*              231*/  '',  '',
-    /*              232*/  0,    0,
-    /*              233*/  0,    0,
-    /*              234*/  0,    0,
-    /*              235*/  0,    0,
-    /*              236*/  0,    0,
-    /*              237*/  0,    0,
-    /*              238*/  0,    0,
-    /*              239*/  0,    0,
-    /*          240 240*/  0,    0,
-    /*              241*/  '',  '',
-    /*              242*/  0,    0,
-    /*              243*/  0,    0,
-    /*              244*/  0,    0,
-    /*              245*/  0,    0,
-    /*              246*/  0,    0,
-    /*              247*/  0,    0,
-    /*              248*/  0,    0,
-    /*              249*/  0,    0,
-    /*              250*/  0,    0,
-    /*              251*/  0,    0,
-    /*              252*/  0,    0,
-    /*              253*/  0,    0,
-    /*              254*/  0,    0,
-    /*              255*/  0,    0,
+    /*            0 0  */    {  0  ,  0  },
+    /*              1  */    {  0  ,  0  },
+    /*              2  */    {  0  ,  0  },
+    /*              3  */    {  0  ,  0  },
+    /*              4  */    {  0  ,  0  },
+    /*              5  */    {  0  ,  0  },
+    /*              6  */    {  0  ,  0  },
+    /*              7  */    {  0  ,  0  },
+    /*              8  */    {  0  ,  0  },
+    /*              9  */    {  0  ,  0  },
+    /*              10 */    {  0  ,  0  },
+    /*              11 */    {  0  ,  0  },
+    /*              12 */    {  0  ,  0  },
+    /*              13 */    {  0  ,  0  },
+    /*              14 */    {  0  ,  0  },
+    /*              15 */    {  0  ,  0  },
+    /*           16 16 */    {  0  ,  0  },
+    /*              17 */    {  0  ,  0  },
+    /*              18 */    {  0  ,  0  },
+    /*              19 */    {  0  ,  0  },
+    /*              20 */    {  0  ,  0  },
+    /*              21 */    {  0  ,  0  },
+    /*              22 */    {  0  ,  0  },
+    /*              23 */    {  0  ,  0  },
+    /*              24 */    {  0  ,  0  },
+    /*              25 */    {  0  ,  0  },
+    /*              26 */    {  0  ,  0  },
+    /*              27 */    {  0  ,  0  },
+    /*              28 */    {  0  ,  0  },
+    /*              29 */    {  0  ,  0  },
+    /*              30 */    {  0  ,  0  },
+    /*              31 */    {  0  ,  0  },
+    /* space     32 32 */    { ' ' , ' ' },
+    /*              33 */    {  0  ,  0  },
+    /*              34 */    {  0  ,  0  },
+    /*              35 */    {  0  ,  0  },
+    /*              36 */    {  0  ,  0  },
+    /*              37 */    {  0  ,  0  },
+    /*              38 */    {  0  ,  0  },
+    /* punctuation  39 */    {  0  ,  0  },
+    /*              40 */    {  0  ,  0  },
+    /*              41 */    {  0  ,  0  },
+    /*              42 */    {  0  ,  0  },
+    /*              43 */    {  0  ,  0  },
+    /*              44 */    {  0  ,  0  },
+    /*              45 */    { '-' , '_' },
+    /*              46 */    {  0  ,  0  },
+    /*              47 */    {  0  ,  0  },
+    /* 0         48 48 */    { '0' , '=' },
+    /* 1            49 */    { '1' , '!' },
+    /* 2            50 */    { '2' , '"' },
+    /* 3            51 */    { '3' , '' },
+    /* 4            52 */    { '4' , '$' },
+    /* 5            53 */    { '5' , '%' },
+    /* 6            54 */    { '6' , '&' },
+    /* 7            55 */    { '7' , '/' },
+    /* 8            56 */    { '8' , '(' },
+    /* 9            57 */    { '9' , ')' },
+    /* :            58 */    { ':' ,  0  },
+    /* ;            59 */    { ';' ,  0  },
+    /* <            60 */    { '<' ,  0  },
+    /* =            61 */    { '=' , '+' },
+    /* >            62 */    { '>' ,  0  },
+    /* ?            63 */    { '?' ,  0  },
+    /* @         64 64 */    { '@' ,  0  },
+    /* A            65 */    { 'a' , 'A' },
+    /* B            66 */    { 'b' , 'B' },
+    /* C            67 */    { 'c' , 'C' },
+    /* D            68 */    { 'd' , 'D' },
+    /* E            69 */    { 'e' , 'E' },
+    /* F            70 */    { 'f' , 'F' },
+    /* G            71 */    { 'g' , 'G' },
+    /* H            72 */    { 'h' , 'H' },
+    /* I            73 */    { 'i' , 'I' },
+    /* J            74 */    { 'j' , 'J' },
+    /* K            75 */    { 'k' , 'K' },
+    /* L            76 */    { 'l' , 'L' },
+    /* M            77 */    { 'm' , 'M' },
+    /* N            78 */    { 'n' , 'N' },
+    /* O            79 */    { 'o' , 'O' },
+    /* P         80 80 */    { 'p' , 'P' },
+    /* Q            81 */    { 'q' , 'Q' },
+    /* R            82 */    { 'r' , 'R' },
+    /* S            83 */    { 's' , 'S' },
+    /* T            84 */    { 't' , 'T' },
+    /* U            85 */    { 'u' , 'U' },
+    /* V            86 */    { 'v' , 'V' },
+    /* W            87 */    { 'w' , 'W' },
+    /* X            88 */    { 'x' , 'X' },
+    /* Y            89 */    { 'y' , 'Y' },
+    /* Z            90 */    { 'z' , 'Z' },
+    /*              91 */    {  0  ,  0  },
+    /*              92 */    {  0  ,  0  },
+    /*              93 */    {  0  ,  0  },
+    /*              94 */    {  0  ,  0  },
+    /*              95 */    {  0  ,  0  },
+    /*           96 96 */    { '0' ,  0  },
+    /*              97 */    { '1' ,  0  },
+    /*              98 */    { '2' ,  0  },
+    /*              99 */    { '3' ,  0  },
+    /*              100*/    { '4' ,  0  },
+    /*              101*/    { '5' ,  0  },
+    /*              102*/    { '6' ,  0  },
+    /*              103*/    { '7' ,  0  },
+    /*              104*/    { '8' ,  0  },
+    /*              105*/    { '9' ,  0  },
+    /*              106*/    { '*' ,  0  },
+    /*              107*/    { '+' ,  0  },
+    /*              108*/    {  0  ,  0  },
+    /*              109*/    { '-' ,  0  },
+    /*              110*/    { '.' ,  0  },
+    /*              111*/    { '/' ,  0  },
+    /*          112 112*/    {  0  ,  0  },
+    /*              113*/    {  0  ,  0  },
+    /*              114*/    {  0  ,  0  },
+    /*              115*/    {  0  ,  0  },
+    /*              116*/    {  0  ,  0  },
+    /*              117*/    {  0  ,  0  },
+    /*              118*/    {  0  ,  0  },
+    /*              119*/    {  0  ,  0  },
+    /*              120*/    {  0  ,  0  },
+    /*              121*/    {  0  ,  0  },
+    /*              122*/    {  0  ,  0  },
+    /*              123*/    {  0  ,  0  },
+    /*              124*/    {  0  ,  0  },
+    /*              125*/    {  0  ,  0  },
+    /*              126*/    {  0  ,  0  },
+    /*              127*/    {  0  ,  0  },
+    /*          128 128*/    {  0  ,  0  },
+    /*              129*/    {  0  ,  0  },
+    /*              130*/    {  0  ,  0  },
+    /*              131*/    {  0  ,  0  },
+    /*              132*/    {  0  ,  0  },
+    /*              133*/    {  0  ,  0  },
+    /*              134*/    {  0  ,  0  },
+    /*              135*/    {  0  ,  0  },
+    /*              136*/    {  0  ,  0  },
+    /*              137*/    {  0  ,  0  },
+    /*              138*/    {  0  ,  0  },
+    /*              139*/    {  0  ,  0  },
+    /*              140*/    {  0  ,  0  },
+    /*              141*/    {  0  ,  0  },
+    /*              142*/    {  0  ,  0  },
+    /*              143*/    {  0  ,  0  },
+    /*          144 144*/    {  0  ,  0  },
+    /*              145*/    {  0  ,  0  },
+    /*              146*/    {  0  ,  0  },
+    /*              147*/    {  0  ,  0  },
+    /*              148*/    {  0  ,  0  },
+    /*              149*/    {  0  ,  0  },
+    /*              150*/    {  0  ,  0  },
+    /*              151*/    {  0  ,  0  },
+    /*              152*/    {  0  ,  0  },
+    /*              153*/    {  0  ,  0  },
+    /*              154*/    {  0  ,  0  },
+    /*              155*/    {  0  ,  0  },
+    /*              156*/    {  0  ,  0  },
+    /*              157*/    {  0  ,  0  },
+    /*              158*/    {  0  ,  0  },
+    /*              159*/    {  0  ,  0  },
+    /*          160 160*/    {  0  ,  0  },
+    /*              161*/    {  0  ,  0  },
+    /*              162*/    {  0  ,  0  },
+    /*              163*/    {  0  ,  0  },
+    /*              164*/    {  0  ,  0  },
+    /*              165*/    {  0  ,  0  },
+    /*              166*/    {  0  ,  0  },
+    /*              167*/    {  0  ,  0  },
+    /*              168*/    {  0  ,  0  },
+    /*              169*/    {  0  ,  0  },
+    /*              170*/    {  0  ,  0  },
+    /*              171*/    {  0  ,  0  },
+    /*              172*/    {  0  ,  0  },
+    /*              173*/    {  0  ,  0  },
+    /*              174*/    {  0  ,  0  },
+    /*              175*/    {  0  ,  0  },
+    /*          176 176*/    {  0  ,  0  },
+    /*              177*/    {  0  ,  0  },
+    /*              178*/    {  0  ,  0  },
+    /*              179*/    {  0  ,  0  },
+    /*              180*/    { '' , '' },
+    /*              181*/    {  0  ,  0  },
+    /*              182*/    {  0  ,  0  },
+    /*              183*/    {  0  ,  0  },
+    /*              184*/    {  0  ,  0  },
+    /*              185*/    {  0  ,  0  },
+    /*              186*/    { ';' , ':' },
+    /*              187*/    { '' , '' },
+    /*              188*/    { ',' , ';' },
+    /*              189*/    { '\'', '?' },
+    /*              190*/    { '.' , ':' },
+    /*              191*/    { '/' , '?' },
+    /*          192 192*/    { '' , '' },
+    /*              193*/    {  0  ,  0  },
+    /*              194*/    {  0  ,  0  },
+    /*              195*/    {  0  ,  0  },
+    /*              196*/    {  0  ,  0  },
+    /*              197*/    {  0  ,  0  },
+    /*              198*/    {  0  ,  0  },
+    /*              199*/    {  0  ,  0  },
+    /*              200*/    { '-' , '_' },
+    /*              201*/    {  0  ,  0  },
+    /*              202*/    {  0  ,  0  },
+    /*              203*/    {  0  ,  0  },
+    /*              204*/    {  0  ,  0  },
+    /*              205*/    {  0  ,  0  },
+    /*              206*/    {  0  ,  0  },
+    /*              207*/    {  0  ,  0  },
+    /*          208 208*/    {  0  ,  0  },
+    /*              209*/    {  0  ,  0  },
+    /*              210*/    {  0  ,  0  },
+    /*              211*/    {  0  ,  0  },
+    /*              212*/    {  0  ,  0  },
+    /*              213*/    {  0  ,  0  },
+    /*              214*/    {  0  ,  0  },
+    /*              215*/    {  0  ,  0  },
+    /*              216*/    {  0  ,  0  },
+    /*              217*/    {  0  ,  0  },
+    /*              218*/    {  0  ,  0  },
+    /*              219*/    { '`' , '^' },
+    /*              220*/    { '' , '' },
+    /*              221*/    { '+' , '*' },
+    /*              222*/    { '\'', '"' },
+    /*              223*/    {  0  ,  0  },
+    /*          224 224*/    {  0  ,  0  },
+    /*              225*/    {  0  ,  0  },
+    /*              226*/    {  0  ,  0  },
+    /*              227*/    {  0  ,  0  },
+    /*              228*/    {  0  ,  0  },
+    /*              229*/    {  0  ,  0  },
+    /*              230*/    {  0  ,  0  },
+    /*              231*/    { '' , '' },
+    /*              232*/    {  0  ,  0  },
+    /*              233*/    {  0  ,  0  },
+    /*              234*/    {  0  ,  0  },
+    /*              235*/    {  0  ,  0  },
+    /*              236*/    {  0  ,  0  },
+    /*              237*/    {  0  ,  0  },
+    /*              238*/    {  0  ,  0  },
+    /*              239*/    {  0  ,  0  },
+    /*          240 240*/    {  0  ,  0  },
+    /*              241*/    { '' , '' },
+    /*              242*/    {  0  ,  0  },
+    /*              243*/    {  0  ,  0  },
+    /*              244*/    {  0  ,  0  },
+    /*              245*/    {  0  ,  0  },
+    /*              246*/    {  0  ,  0  },
+    /*              247*/    {  0  ,  0  },
+    /*              248*/    {  0  ,  0  },
+    /*              249*/    {  0  ,  0  },
+    /*              250*/    {  0  ,  0  },
+    /*              251*/    {  0  ,  0  },
+    /*              252*/    {  0  ,  0  },
+    /*              253*/    {  0  ,  0  },
+    /*              254*/    {  0  ,  0  },
+    /*              255*/    {  0  ,  0  },
 };
 
 uicKeyTable uicItalianKeyEntryTable[KEY_TOTAL_KEYS] =
 {
-    /*            0 0  */  0,    0,
-    /*              1  */  0,    0,
-    /*              2  */  0,    0,
-    /*              3  */  0,    0,
-    /*              4  */  0,    0,
-    /*              5  */  0,    0,
-    /*              6  */  0,    0,
-    /*              7  */  0,    0,
-    /*              8  */  0,    0,
-    /*              9  */  0,    0,
-    /*              10 */  0,    0,
-    /*              11 */  0,    0,
-    /*              12 */  0,    0,
-    /*              13 */  0,    0,
-    /*              14 */  0,    0,
-    /*              15 */  0,    0,
-    /*           16 16 */  0,    0,
-    /*              17 */  0,    0,
-    /*              18 */  0,    0,
-    /*              19 */  0,    0,
-    /*              20 */  0,    0,
-    /*              21 */  0,    0,
-    /*              22 */  0,    0,
-    /*              23 */  0,    0,
-    /*              24 */  0,    0,
-    /*              25 */  0,    0,
-    /*              26 */  0,    0,
-    /*              27 */  0,    0,
-    /*              28 */  0,    0,
-    /*              29 */  0,    0,
-    /*              30 */  0,    0,
-    /*              31 */  0,    0,
-    /* space     32 32 */  ' ',  ' ',
-    /*              33 */  0,    0,
-    /*              34 */  0,    0,
-    /*              35 */  0,    0,
-    /*              36 */  0,    0,
-    /*              37 */  0,    0,
-    /*              38 */  0,    0,
-    /* punctuation  39 */  0,    0,
-    /*              40 */  0,    0,
-    /*              41 */  0,    0,
-    /*              42 */  0,    0,
-    /*              43 */  0,    0,
-    /*              44 */  0,    0,
-    /*              45 */  '-',  '_',
-    /*              46 */  0,    0,
-    /*              47 */  0,    0,
-    /* 0         48 48 */  '0',  '=',
-    /* 1            49 */  '1',  '!',
-    /* 2            50 */  '2',  '"',
-    /* 3            51 */  '3',  '',
-    /* 4            52 */  '4',  '$',
-    /* 5            53 */  '5',  '%',
-    /* 6            54 */  '6',  '&',
-    /* 7            55 */  '7',  '/',
-    /* 8            56 */  '8',  '(',
-    /* 9            57 */  '9',  ')',
-    /* :            58 */  ':',  0,
-    /* ;            59 */  ';',  0,
-    /* <            60 */  '<',  0,
-    /* =            61 */  '=',  '+',
-    /* >            62 */  '>',  0,
-    /* ?            63 */  '?',  0,
-    /* @         64 64 */  '@',  0,
-    /* A            65 */  'a',  'A',
-    /* B            66 */  'b',  'B',
-    /* C            67 */  'c',  'C',
-    /* D            68 */  'd',  'D',
-    /* E            69 */  'e',  'E',
-    /* F            70 */  'f',  'F',
-    /* G            71 */  'g',  'G',
-    /* H            72 */  'h',  'H',
-    /* I            73 */  'i',  'I',
-    /* J            74 */  'j',  'J',
-    /* K            75 */  'k',  'K',
-    /* L            76 */  'l',  'L',
-    /* M            77 */  'm',  'M',
-    /* N            78 */  'n',  'N',
-    /* O            79 */  'o',  'O',
-    /* P         80 80 */  'p',  'P',
-    /* Q            81 */  'q',  'Q',
-    /* R            82 */  'r',  'R',
-    /* S            83 */  's',  'S',
-    /* T            84 */  't',  'T',
-    /* U            85 */  'u',  'U',
-    /* V            86 */  'v',  'V',
-    /* W            87 */  'w',  'W',
-    /* X            88 */  'x',  'X',
-    /* Y            89 */  'y',  'Y',
-    /* Z            90 */  'z',  'Z',
-    /*              91 */  0,    0,
-    /*              92 */  0,    0,
-    /*              93 */  0,    0,
-    /*              94 */  0,    0,
-    /*              95 */  0,    0,
-    /*           96 96 */  '0',  0,
-    /*              97 */  '1',  0,
-    /*              98 */  '2',  0,
-    /*              99 */  '3',  0,
-    /*              100*/  '4',  0,
-    /*              101*/  '5',  0,
-    /*              102*/  '6',  0,
-    /*              103*/  '7',  0,
-    /*              104*/  '8',  0,
-    /*              105*/  '9',  0,
-    /*              106*/  '*',  0,
-    /*              107*/  '+',  0,
-    /*              108*/  0,    0,
-    /*              109*/  '-',  0,
-    /*              110*/  '.',  0,
-    /*              111*/  '/',  0,
-    /*          112 112*/  0,    0,
-    /*              113*/  0,    0,
-    /*              114*/  0,    0,
-    /*              115*/  0,    0,
-    /*              116*/  0,    0,
-    /*              117*/  0,    0,
-    /*              118*/  0,    0,
-    /*              119*/  0,    0,
-    /*              120*/  0,    0,
-    /*              121*/  0,    0,
-    /*              122*/  0,    0,
-    /*              123*/  0,    0,
-    /*              124*/  0,    0,
-    /*              125*/  0,    0,
-    /*              126*/  0,    0,
-    /*              127*/  0,    0,
-    /*          128 128*/  0,    0,
-    /*              129*/  0,    0,
-    /*              130*/  0,    0,
-    /*              131*/  0,    0,
-    /*              132*/  0,    0,
-    /*              133*/  0,    0,
-    /*              134*/  0,    0,
-    /*              135*/  0,    0,
-    /*              136*/  0,    0,
-    /*              137*/  0,    0,
-    /*              138*/  0,    0,
-    /*              139*/  0,    0,
-    /*              140*/  0,    0,
-    /*              141*/  0,    0,
-    /*              142*/  0,    0,
-    /*              143*/  0,    0,
-    /*          144 144*/  0,    0,
-    /*              145*/  0,    0,
-    /*              146*/  0,    0,
-    /*              147*/  0,    0,
-    /*              148*/  0,    0,
-    /*              149*/  0,    0,
-    /*              150*/  0,    0,
-    /*              151*/  0,    0,
-    /*              152*/  0,    0,
-    /*              153*/  0,    0,
-    /*              154*/  0,    0,
-    /*              155*/  0,    0,
-    /*              156*/  0,    0,
-    /*              157*/  0,    0,
-    /*              158*/  0,    0,
-    /*              159*/  0,    0,
-    /*          160 160*/  0,    0,
-    /*              161*/  0,    0,
-    /*              162*/  0,    0,
-    /*              163*/  0,    0,
-    /*              164*/  0,    0,
-    /*              165*/  0,    0,
-    /*              166*/  0,    0,
-    /*              167*/  0,    0,
-    /*              168*/  0,    0,
-    /*              169*/  0,    0,
-    /*              170*/  0,    0,
-    /*              171*/  0,    0,
-    /*              172*/  0,    0,
-    /*              173*/  0,    0,
-    /*              174*/  0,    0,
-    /*              175*/  0,    0,
-    /*          176 176*/  0,    0,
-    /*              177*/  0,    0,
-    /*              178*/  0,    0,
-    /*              179*/  0,    0,
-    /*              180*/  0,    0,
-    /*              181*/  0,    0,
-    /*              182*/  0,    0,
-    /*              183*/  0,    0,
-    /*              184*/  0,    0,
-    /*              185*/  0,    0,
-    /*              186*/  ';',  ':',
-    /*              187*/  '',  '^',
-    /*              188*/  ',',  ';',
-    /*              189*/  '\'', '?',
-    /*              190*/  '.',  ':',
-    /*              191*/  '/',  '?',
-    /*          192 192*/  '\\', '|',
-    /*              193*/  0,    0,
-    /*              194*/  0,    0,
-    /*              195*/  0,    0,
-    /*              196*/  0,    0,
-    /*              197*/  0,    0,
-    /*              198*/  0,    0,
-    /*              199*/  0,    0,
-    /*              200*/  '-',  '_',
-    /*              201*/  0,    0,
-    /*              202*/  0,    0,
-    /*              203*/  0,    0,
-    /*              204*/  0,    0,
-    /*              205*/  0,    0,
-    /*              206*/  0,    0,
-    /*              207*/  0,    0,
-    /*          208 208*/  0,    0,
-    /*              209*/  0,    0,
-    /*              210*/  0,    0,
-    /*              211*/  0,    0,
-    /*              212*/  0,    0,
-    /*              213*/  0,    0,
-    /*              214*/  0,    0,
-    /*              215*/  0,    0,
-    /*              216*/  0,    0,
-    /*              217*/  0,    0,
-    /*              218*/  0,    0,
-    /*              219*/  '',  '',
-    /*              220*/  '',  '',
-    /*              221*/  '+',  '*',
-    /*              222*/  '',  '',
-    /*              223*/  0,    0,
-    /*          224 224*/  0,    0,
-    /*              225*/  0,    0,
-    /*              226*/  0,    0,
-    /*              227*/  0,    0,
-    /*              228*/  0,    0,
-    /*              229*/  0,    0,
-    /*              230*/  0,    0,
-    /*              231*/  0,    0,
-    /*              232*/  0,    0,
-    /*              233*/  0,    0,
-    /*              234*/  0,    0,
-    /*              235*/  0,    0,
-    /*              236*/  0,    0,
-    /*              237*/  0,    0,
-    /*              238*/  0,    0,
-    /*              239*/  0,    0,
-    /*          240 240*/  0,    0,
-    /*              241*/  '',  '',
-    /*              242*/  0,    0,
-    /*              243*/  0,    0,
-    /*              244*/  0,    0,
-    /*              245*/  0,    0,
-    /*              246*/  0,    0,
-    /*              247*/  0,    0,
-    /*              248*/  0,    0,
-    /*              249*/  0,    0,
-    /*              250*/  0,    0,
-    /*              251*/  0,    0,
-    /*              252*/  0,    0,
-    /*              253*/  0,    0,
-    /*              254*/  0,    0,
-    /*              255*/  0,    0,
+    /*            0 0  */    {  0  ,  0  },
+    /*              1  */    {  0  ,  0  },
+    /*              2  */    {  0  ,  0  },
+    /*              3  */    {  0  ,  0  },
+    /*              4  */    {  0  ,  0  },
+    /*              5  */    {  0  ,  0  },
+    /*              6  */    {  0  ,  0  },
+    /*              7  */    {  0  ,  0  },
+    /*              8  */    {  0  ,  0  },
+    /*              9  */    {  0  ,  0  },
+    /*              10 */    {  0  ,  0  },
+    /*              11 */    {  0  ,  0  },
+    /*              12 */    {  0  ,  0  },
+    /*              13 */    {  0  ,  0  },
+    /*              14 */    {  0  ,  0  },
+    /*              15 */    {  0  ,  0  },
+    /*           16 16 */    {  0  ,  0  },
+    /*              17 */    {  0  ,  0  },
+    /*              18 */    {  0  ,  0  },
+    /*              19 */    {  0  ,  0  },
+    /*              20 */    {  0  ,  0  },
+    /*              21 */    {  0  ,  0  },
+    /*              22 */    {  0  ,  0  },
+    /*              23 */    {  0  ,  0  },
+    /*              24 */    {  0  ,  0  },
+    /*              25 */    {  0  ,  0  },
+    /*              26 */    {  0  ,  0  },
+    /*              27 */    {  0  ,  0  },
+    /*              28 */    {  0  ,  0  },
+    /*              29 */    {  0  ,  0  },
+    /*              30 */    {  0  ,  0  },
+    /*              31 */    {  0  ,  0  },
+    /* space     32 32 */    { ' ' , ' ' },
+    /*              33 */    {  0  ,  0  },
+    /*              34 */    {  0  ,  0  },
+    /*              35 */    {  0  ,  0  },
+    /*              36 */    {  0  ,  0  },
+    /*              37 */    {  0  ,  0  },
+    /*              38 */    {  0  ,  0  },
+    /* punctuation  39 */    {  0  ,  0  },
+    /*              40 */    {  0  ,  0  },
+    /*              41 */    {  0  ,  0  },
+    /*              42 */    {  0  ,  0  },
+    /*              43 */    {  0  ,  0  },
+    /*              44 */    {  0  ,  0  },
+    /*              45 */    { '-' , '_' },
+    /*              46 */    {  0  ,  0  },
+    /*              47 */    {  0  ,  0  },
+    /* 0         48 48 */    { '0' , '=' },
+    /* 1            49 */    { '1' , '!' },
+    /* 2            50 */    { '2' , '"' },
+    /* 3            51 */    { '3' , '' },
+    /* 4            52 */    { '4' , '$' },
+    /* 5            53 */    { '5' , '%' },
+    /* 6            54 */    { '6' , '&' },
+    /* 7            55 */    { '7' , '/' },
+    /* 8            56 */    { '8' , '(' },
+    /* 9            57 */    { '9' , ')' },
+    /* :            58 */    { ':' ,  0  },
+    /* ;            59 */    { ';' ,  0  },
+    /* <            60 */    { '<' ,  0  },
+    /* =            61 */    { '=' , '+' },
+    /* >            62 */    { '>' ,  0  },
+    /* ?            63 */    { '?' ,  0  },
+    /* @         64 64 */    { '@' ,  0  },
+    /* A            65 */    { 'a' , 'A' },
+    /* B            66 */    { 'b' , 'B' },
+    /* C            67 */    { 'c' , 'C' },
+    /* D            68 */    { 'd' , 'D' },
+    /* E            69 */    { 'e' , 'E' },
+    /* F            70 */    { 'f' , 'F' },
+    /* G            71 */    { 'g' , 'G' },
+    /* H            72 */    { 'h' , 'H' },
+    /* I            73 */    { 'i' , 'I' },
+    /* J            74 */    { 'j' , 'J' },
+    /* K            75 */    { 'k' , 'K' },
+    /* L            76 */    { 'l' , 'L' },
+    /* M            77 */    { 'm' , 'M' },
+    /* N            78 */    { 'n' , 'N' },
+    /* O            79 */    { 'o' , 'O' },
+    /* P         80 80 */    { 'p' , 'P' },
+    /* Q            81 */    { 'q' , 'Q' },
+    /* R            82 */    { 'r' , 'R' },
+    /* S            83 */    { 's' , 'S' },
+    /* T            84 */    { 't' , 'T' },
+    /* U            85 */    { 'u' , 'U' },
+    /* V            86 */    { 'v' , 'V' },
+    /* W            87 */    { 'w' , 'W' },
+    /* X            88 */    { 'x' , 'X' },
+    /* Y            89 */    { 'y' , 'Y' },
+    /* Z            90 */    { 'z' , 'Z' },
+    /*              91 */    {  0  ,  0  },
+    /*              92 */    {  0  ,  0  },
+    /*              93 */    {  0  ,  0  },
+    /*              94 */    {  0  ,  0  },
+    /*              95 */    {  0  ,  0  },
+    /*           96 96 */    { '0' ,  0  },
+    /*              97 */    { '1' ,  0  },
+    /*              98 */    { '2' ,  0  },
+    /*              99 */    { '3' ,  0  },
+    /*              100*/    { '4' ,  0  },
+    /*              101*/    { '5' ,  0  },
+    /*              102*/    { '6' ,  0  },
+    /*              103*/    { '7' ,  0  },
+    /*              104*/    { '8' ,  0  },
+    /*              105*/    { '9' ,  0  },
+    /*              106*/    { '*' ,  0  },
+    /*              107*/    { '+' ,  0  },
+    /*              108*/    {  0  ,  0  },
+    /*              109*/    { '-' ,  0  },
+    /*              110*/    { '.' ,  0  },
+    /*              111*/    { '/' ,  0  },
+    /*          112 112*/    {  0  ,  0  },
+    /*              113*/    {  0  ,  0  },
+    /*              114*/    {  0  ,  0  },
+    /*              115*/    {  0  ,  0  },
+    /*              116*/    {  0  ,  0  },
+    /*              117*/    {  0  ,  0  },
+    /*              118*/    {  0  ,  0  },
+    /*              119*/    {  0  ,  0  },
+    /*              120*/    {  0  ,  0  },
+    /*              121*/    {  0  ,  0  },
+    /*              122*/    {  0  ,  0  },
+    /*              123*/    {  0  ,  0  },
+    /*              124*/    {  0  ,  0  },
+    /*              125*/    {  0  ,  0  },
+    /*              126*/    {  0  ,  0  },
+    /*              127*/    {  0  ,  0  },
+    /*          128 128*/    {  0  ,  0  },
+    /*              129*/    {  0  ,  0  },
+    /*              130*/    {  0  ,  0  },
+    /*              131*/    {  0  ,  0  },
+    /*              132*/    {  0  ,  0  },
+    /*              133*/    {  0  ,  0  },
+    /*              134*/    {  0  ,  0  },
+    /*              135*/    {  0  ,  0  },
+    /*              136*/    {  0  ,  0  },
+    /*              137*/    {  0  ,  0  },
+    /*              138*/    {  0  ,  0  },
+    /*              139*/    {  0  ,  0  },
+    /*              140*/    {  0  ,  0  },
+    /*              141*/    {  0  ,  0  },
+    /*              142*/    {  0  ,  0  },
+    /*              143*/    {  0  ,  0  },
+    /*          144 144*/    {  0  ,  0  },
+    /*              145*/    {  0  ,  0  },
+    /*              146*/    {  0  ,  0  },
+    /*              147*/    {  0  ,  0  },
+    /*              148*/    {  0  ,  0  },
+    /*              149*/    {  0  ,  0  },
+    /*              150*/    {  0  ,  0  },
+    /*              151*/    {  0  ,  0  },
+    /*              152*/    {  0  ,  0  },
+    /*              153*/    {  0  ,  0  },
+    /*              154*/    {  0  ,  0  },
+    /*              155*/    {  0  ,  0  },
+    /*              156*/    {  0  ,  0  },
+    /*              157*/    {  0  ,  0  },
+    /*              158*/    {  0  ,  0  },
+    /*              159*/    {  0  ,  0  },
+    /*          160 160*/    {  0  ,  0  },
+    /*              161*/    {  0  ,  0  },
+    /*              162*/    {  0  ,  0  },
+    /*              163*/    {  0  ,  0  },
+    /*              164*/    {  0  ,  0  },
+    /*              165*/    {  0  ,  0  },
+    /*              166*/    {  0  ,  0  },
+    /*              167*/    {  0  ,  0  },
+    /*              168*/    {  0  ,  0  },
+    /*              169*/    {  0  ,  0  },
+    /*              170*/    {  0  ,  0  },
+    /*              171*/    {  0  ,  0  },
+    /*              172*/    {  0  ,  0  },
+    /*              173*/    {  0  ,  0  },
+    /*              174*/    {  0  ,  0  },
+    /*              175*/    {  0  ,  0  },
+    /*          176 176*/    {  0  ,  0  },
+    /*              177*/    {  0  ,  0  },
+    /*              178*/    {  0  ,  0  },
+    /*              179*/    {  0  ,  0  },
+    /*              180*/    {  0  ,  0  },
+    /*              181*/    {  0  ,  0  },
+    /*              182*/    {  0  ,  0  },
+    /*              183*/    {  0  ,  0  },
+    /*              184*/    {  0  ,  0  },
+    /*              185*/    {  0  ,  0  },
+    /*              186*/    { ';' , ':' },
+    /*              187*/    { '' , '^' },
+    /*              188*/    { ',' , ';' },
+    /*              189*/    { '\'', '?' },
+    /*              190*/    { '.' , ':' },
+    /*              191*/    { '/' , '?' },
+    /*          192 192*/    { '\\', '|' },
+    /*              193*/    {  0  ,  0  },
+    /*              194*/    {  0  ,  0  },
+    /*              195*/    {  0  ,  0  },
+    /*              196*/    {  0  ,  0  },
+    /*              197*/    {  0  ,  0  },
+    /*              198*/    {  0  ,  0  },
+    /*              199*/    {  0  ,  0  },
+    /*              200*/    { '-' , '_' },
+    /*              201*/    {  0  ,  0  },
+    /*              202*/    {  0  ,  0  },
+    /*              203*/    {  0  ,  0  },
+    /*              204*/    {  0  ,  0  },
+    /*              205*/    {  0  ,  0  },
+    /*              206*/    {  0  ,  0  },
+    /*              207*/    {  0  ,  0  },
+    /*          208 208*/    {  0  ,  0  },
+    /*              209*/    {  0  ,  0  },
+    /*              210*/    {  0  ,  0  },
+    /*              211*/    {  0  ,  0  },
+    /*              212*/    {  0  ,  0  },
+    /*              213*/    {  0  ,  0  },
+    /*              214*/    {  0  ,  0  },
+    /*              215*/    {  0  ,  0  },
+    /*              216*/    {  0  ,  0  },
+    /*              217*/    {  0  ,  0  },
+    /*              218*/    {  0  ,  0  },
+    /*              219*/    { '' , '' },
+    /*              220*/    { '' , '' },
+    /*              221*/    { '+' , '*' },
+    /*              222*/    { '' , '' },
+    /*              223*/    {  0  ,  0  },
+    /*          224 224*/    {  0  ,  0  },
+    /*              225*/    {  0  ,  0  },
+    /*              226*/    {  0  ,  0  },
+    /*              227*/    {  0  ,  0  },
+    /*              228*/    {  0  ,  0  },
+    /*              229*/    {  0  ,  0  },
+    /*              230*/    {  0  ,  0  },
+    /*              231*/    {  0  ,  0  },
+    /*              232*/    {  0  ,  0  },
+    /*              233*/    {  0  ,  0  },
+    /*              234*/    {  0  ,  0  },
+    /*              235*/    {  0  ,  0  },
+    /*              236*/    {  0  ,  0  },
+    /*              237*/    {  0  ,  0  },
+    /*              238*/    {  0  ,  0  },
+    /*              239*/    {  0  ,  0  },
+    /*          240 240*/    {  0  ,  0  },
+    /*              241*/    { '' , '' },
+    /*              242*/    {  0  ,  0  },
+    /*              243*/    {  0  ,  0  },
+    /*              244*/    {  0  ,  0  },
+    /*              245*/    {  0  ,  0  },
+    /*              246*/    {  0  ,  0  },
+    /*              247*/    {  0  ,  0  },
+    /*              248*/    {  0  ,  0  },
+    /*              249*/    {  0  ,  0  },
+    /*              250*/    {  0  ,  0  },
+    /*              251*/    {  0  ,  0  },
+    /*              252*/    {  0  ,  0  },
+    /*              253*/    {  0  ,  0  },
+    /*              254*/    {  0  ,  0  },
+    /*              255*/    {  0  ,  0  },
 };
 
 
@@ -4065,7 +4133,6 @@
 ----------------------------------------------------------------------------*/
 void uicTextEntryDraw(regionhandle reg)
 {
-    featom *atom = (featom *)reg->userID;
     textentryhandle entry = (textentryhandle)reg;
     fonthandle fhSave;
     sdword caretLocation, nCharacters, length;
@@ -4253,8 +4320,8 @@
             }
             else
             {                                               //no dragging yet
-                if (abs(((buttonhandle)region)->clickX - mouseCursorX()) >= UIC_DragButtonThresholdX ||
-                    abs(((buttonhandle)region)->clickY - mouseCursorY()) >= UIC_DragButtonThresholdY)
+                if (ABS(((buttonhandle)region)->clickX - mouseCursorX()) >= UIC_DragButtonThresholdX ||
+                    ABS(((buttonhandle)region)->clickY - mouseCursorY()) >= UIC_DragButtonThresholdY)
                 {                                           //if the mouse has been dragged far enough to be considered a drag
                     //...register the motion
                     ((buttonhandle)region)->bDragged = TRUE;
@@ -5222,7 +5289,7 @@
     Outputs     :
     Return      : button type
 ----------------------------------------------------------------------------*/
-enum tagFIBAtomFlagSff uicFindButtonType(struct tagRegion *reg)
+enum tagFIBAtomFlagsff uicFindButtonType(struct tagRegion *reg)
 {
     struct tagRegion *temp;
 
diff -urPw homeworld-orig/src/Game/UIControls.h homeworld_sdl-0.3/src/Game/UIControls.h
--- homeworld-orig/src/Game/UIControls.h	2002-09-04 12:46:22.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/UIControls.h	2004-08-01 22:35:16.000000000 -0700
@@ -9,11 +9,11 @@
 #ifndef ___UICONTROLS_H
 #define ___UICONTROLS_H
 
-#include "types.h"
-#include "region.h"
-#include "feflow.h"
+#include "Types.h"
+#include "Region.h"
+#include "FEFlow.h"
 #include "font.h"
-#include "linkedlist.h"
+#include "LinkedList.h"
 #include "prim2d.h"
 
 /*=============================================================================
diff -urPw homeworld-orig/src/Game/Undo.c homeworld_sdl-0.3/src/Game/Undo.c
--- homeworld-orig/src/Game/Undo.c	2002-09-04 12:46:22.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Undo.c	2004-08-01 22:35:30.000000000 -0700
@@ -7,12 +7,12 @@
 =============================================================================*/
 
 #include <string.h>
-#include "debug.h"
-#include "memory.h"
-#include "select.h"
-#include "commandwrap.h"
-#include "universe.h"
-#include "undo.h"
+#include "Debug.h"
+#include "Memory.h"
+#include "Select.h"
+#include "CommandWrap.h"
+#include "Universe.h"
+#include "Undo.h"
 
 /*=============================================================================
     Data:
diff -urPw homeworld-orig/src/Game/Undo.h homeworld_sdl-0.3/src/Game/Undo.h
--- homeworld-orig/src/Game/Undo.h	2002-09-04 12:46:22.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Undo.h	2004-08-01 22:35:30.000000000 -0700
@@ -9,7 +9,7 @@
 #ifndef ___UNDO_H
 #define ___UNDO_H
 
-#include "types.h"
+#include "Types.h"
 /*=============================================================================
     Type definitions:
 =============================================================================*/
diff -urPw homeworld-orig/src/Game/Universe.c homeworld_sdl-0.3/src/Game/Universe.c
--- homeworld-orig/src/Game/Universe.c	2002-09-04 12:46:24.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Universe.c	2004-08-01 22:35:17.000000000 -0700
@@ -10,55 +10,60 @@
 #include <math.h>
 #include <stdlib.h>
 #include <string.h>
-#include "types.h"
-#include "debug.h"
-#include "task.h"
-#include "file.h"
-#include "linkedlist.h"
-#include "spaceobj.h"
-#include "collision.h"
-#include "univupdate.h"
-#include "stats.h"
-#include "camera.h"
-#include "cameracommand.h"
+#include <strings.h>
+#include "Types.h"
+#include "Debug.h"
+#include "Task.h"
+#include "File.h"
+#include "LinkedList.h"
+#include "SpaceObj.h"
+#include "Collision.h"
+#include "UnivUpdate.h"
+#include "Stats.h"
+#include "Camera.h"
+#include "CameraCommand.h"
 #include "render.h"
-#include "statscript.h"
-#include "ships.h"
-#include "formation.h"
-#include "commandlayer.h"
-#include "mex.h"
-#include "tweak.h"
-#include "globals.h"
-#include "commandnetwork.h"
+#include "StatScript.h"
+#include "Ships.h"
+#include "Formation.h"
+#include "CommandLayer.h"
+#include "MEX.h"
+#include "Tweak.h"
+#include "Globals.h"
+#include "CommandNetwork.h"
 #include "utility.h"
-#include "levelload.h"
-#include "aiship.h"
-#include "gun.h"
-#include "etg.h"
-#include "dock.h"
-#include "universe.h"
-#include "aiplayer.h"
-#include "consMgr.h"
-#include "strings.h"
-#include "soundevent.h"
-#include "horserace.h"
-#include "meshanim.h"
-#include "multiplayergame.h"
-#include "gamechat.h"
-#include "researchapi.h"
-#include "singleplayer.h"
-#include "navlights.h"
-#include "teams.h"
-#include "captaincy.h"
-#include "bounties.h"
-#include "tutor.h"
-#include "ping.h"
+#include "LevelLoad.h"
+#include "AIShip.h"
+#include "Gun.h"
+#include "ETG.h"
+#include "Dock.h"
+#include "Universe.h"
+#include "AIPlayer.h"
+#include "ConsMgr.h"
+#include "Strings.h"
+#include "SoundEvent.h"
+#include "HorseRace.h"
+#include "MeshAnim.h"
+#include "MultiplayerGame.h"
+#include "GameChat.h"
+#include "ResearchAPI.h"
+#include "SinglePlayer.h"
+#include "NavLights.h"
+#include "Teams.h"
+#include "Captaincy.h"
+#include "Bounties.h"
+#include "Tutor.h"
+#include "Ping.h"
 #include "SaveGame.h"
-#include "autodownloadmap.h"
+#include "AutoDownloadMap.h"
 #include "LagPrint.h"
-#include "scenpick.h"
-#include "fastmath.h"
-#include "netcheck.h"
+#include "ScenPick.h"
+#include "FastMath.h"
+#include "NetCheck.h"
+
+#ifdef _MSC_VER
+#define strcasecmp _stricmp
+#endif
 
 extern bool cheapShips;
 
@@ -80,6 +85,8 @@
 MissileStaticInfo missileStaticInfos[NUM_RACES];
 MissileStaticInfo mineStaticInfos[2];               //only race 1 and race 2 have mines
 
+GrowSelection ClampedShipList;       // special GrowSelect which can have NULL's in it
+
 struct SphereStaticInfo *sphereStaticInfo = NULL;
 
 Camera defaultCamera;
@@ -177,8 +184,6 @@
 static void setClassCB(char *directory,char *field,void *dataToFillIn);
 static void scriptSetFramesCB(char *directory,char *field,void *dataToFillIn);
 static void LODScriptLoad(char *directory,char *field,void *dataToFillIn);
-static void setExplosionType(char *directory,char *field,void *dataToFillIn);
-static void scriptSetShipsCB(char *directory,char *field,void *dataToFillIn);
 static void setGunBindInfo(char *directory,char *field,void *dataToFillIn);
 static void setAnimationBindInfo(char *directory,char *field,void *dataToFillIn);
 static void setMadStartInfo(char *directory,char *field,void *dataToFillIn);
@@ -989,19 +994,19 @@
     //parse the modifiers
     while ((string = strtok(NULL, " ,")) != NULL)
     {
-        if (_stricmp(string, "Azimuth") == 0)
+        if (strcasecmp(string, "Azimuth") == 0)
         {
             flags |= HBF_Azimuth;
         }
-        else if (_stricmp(string, "Declination") == 0)
+        else if (strcasecmp(string, "Declination") == 0)
         {
             flags |= HBF_Declination;
         }
-        else if (_stricmp(string, "Recoil") == 0)
+        else if (strcasecmp(string, "Recoil") == 0)
         {
             flags |= HBF_Recoil;
         }
-        else if (_stricmp(string, "Frequency") == 0)
+        else if (strcasecmp(string, "Frequency") == 0)
         {
             string = strtok(NULL, " ,");
             dbgAssert(string);
@@ -1415,7 +1420,7 @@
 void gunGetDefaultOrientationFromBindings(GunStatic *gunstatic,ShipStaticInfo *statinfo)
 {
     lod *level = &statinfo->staticheader.LOD->level[0];
-    udword numHierarchys = ((meshdata *)level->pData)->nPolygonObjects;
+    //udword numHierarchys = ((meshdata *)level->pData)->nPolygonObjects;
     hmatrix concatenated, nonConcatenated;
 //    mhbinding *binding;
 
@@ -1566,7 +1571,11 @@
 
     asteroidtypestr = AsteroidTypeToStr(asteroidtype);
 
+#ifdef _WIN32
     strcpy(directory,"Resources\\Asteroids\\");
+#else
+    strcpy(directory,"Resources/Asteroids/");
+#endif
 //    strcat(directory,asteroidtypestr);
 //    strcat(directory,"\\");
 
@@ -1608,7 +1617,11 @@
 
     dustcloudtypestr = DustCloudTypeToStr(dustcloudtype);
 
+#ifdef _WIN32
     strcpy(directory,"Resources\\DustClouds\\");
+#else
+    strcpy(directory,"Resources/DustClouds/");
+#endif
 //    strcat(directory,dustcloudtypestr);
 //    strcat(directory,"\\");
 
@@ -1658,7 +1671,11 @@
 
     gascloudtypestr = GasCloudTypeToStr(gascloudtype);
 
+#ifdef _WIN32
     strcpy(directory,"Resources\\GasClouds\\");
+#else
+    strcpy(directory,"Resources/GasClouds/");
+#endif
 //    strcat(directory,gascloudtypestr);
 //    strcat(directory,"\\");
 
@@ -1697,7 +1714,11 @@
 
     nebulatypestr = NebulaTypeToStr(nebulatype);
 
+#ifdef _WIN32
     strcpy(directory,"Resources\\Nebulae\\");
+#else
+    strcpy(directory,"Resources/Nebulae/");
+#endif
 //    strcat(directory,nebulatypestr);
 //    strcat(directory,"\\");
 
@@ -1785,7 +1806,11 @@
 
     derelicttypestr = DerelictTypeToStr(derelicttype);
 
+#ifdef _WIN32
     strcpy(directory,"Derelicts\\");
+#else
+    strcpy(directory,"Derelicts/");
+#endif
 //    strcat(directory,derelicttypestr);
 //    strcat(directory,"\\");
 
@@ -1854,7 +1879,11 @@
 
     strcpy(directory,ShipRaceToStr(race));
 //    strcat(directory,"\\Missile\\");
+#ifdef _WIN32
     strcat(directory, "\\");
+#else
+    strcat(directory, "/");
+#endif
 
     strcpy(fullshipname,directory);
     strcat(fullshipname,shipname);
@@ -1898,7 +1927,11 @@
 
     strcpy(directory,ShipRaceToStr(race));
 //    strcat(directory,"\\Mine\\");
+#ifdef _WIN32
     strcat(directory, "\\");
+#else
+    strcat(directory, "/");
+#endif
 
     strcpy(fullshipname,directory);
     strcat(fullshipname,shipname);
@@ -1987,7 +2020,11 @@
     strcpy(directory,ShipRaceToStr(race));
 //    strcat(directory,"\\");
 //    strcat(directory,shiptypestr);
+#ifdef _WIN32
     strcat(directory,"\\");
+#else
+    strcat(directory,"/");
+#endif
 
     strcpy(shipname,shiptypestr);
     strcat(shipname,".shp");
@@ -3003,11 +3040,17 @@
     StaticInfo *staticinfo;
     udword max,count;
 #if UNIV_SHIP_LOADFREE_LOG
+    char *fileNameFull;
     FILE *logFile = NULL;
 
     if (univLoadFreeLog)
     {
-        logFile = fopen(UNIV_LOAD_FREE_FILENAME, "at");
+        fileNameFull = filePathPrepend(
+            UNIV_LOAD_FREE_FILENAME,
+            FF_UserSettingsPath);
+
+        if (fileMakeDestinationDirectory(fileNameFull))
+            logFile = fopen(fileNameFull, "at");
     }
     if (logFile)
     {
@@ -3018,6 +3061,12 @@
     }
 #endif
 
+#ifdef _WIN32
+#define TMP_DEFSHIP_PATH "DefaultShip\\"
+#else
+#define TMP_DEFSHIP_PATH "DefaultShip/"
+#endif
+
     //load some things shared by everyone
     if (sphereStaticInfo == NULL)
     {
@@ -3025,17 +3074,19 @@
     }
     if (defaultmesh == NULL)
     {
-        defaultmesh = meshLoad("DefaultShip\\DefaultShip.geo");
+        defaultmesh = meshLoad(TMP_DEFSHIP_PATH "DefaultShip.geo");
     }
     if (defaultlod == NULL)
     {
-        defaultlod = lodTableReadScript("DefaultShip\\", "DefaultShip.lod");
+        defaultlod = lodTableReadScript(TMP_DEFSHIP_PATH, "DefaultShip.lod");
     }
     if (defaultmex == NULL)
     {
-        defaultmex = mexLoad("DefaultShip\\DefaultShip.mex");
+        defaultmex = mexLoad(TMP_DEFSHIP_PATH "DefaultShip.mex");
     }
 
+#undef TMP_DEFSHIP_PATH
+
     max = 0;
     for (shiprace=0;shiprace<NUM_RACES;shiprace++)
     {
@@ -3770,7 +3821,9 @@
 
     taskYield(0);
 
+#ifndef C_ONLY
     for(;;)
+#endif
     {
         if ((multiPlayerGame) && (startingGame) && (gameIsRunning) && ((IAmCaptain) && (!multiPlayerGameUnderWay)))
         {
@@ -4049,6 +4102,7 @@
 
         taskYield(0);
     }
+
     taskExit();
 }
 #pragma optimize("", on)
@@ -4547,7 +4601,7 @@
     universe.gameStats.playerStats[playerIndex].totalForEachClass[ship->staticinfo->shipclass]++;
     universe.gameStats.totalRUsInAllShips += ship->staticinfo->buildCost;
     universe.gameStats.playerStats[playerIndex].totalRUsInCurrentShips += ship->staticinfo->buildCost;
-    universe.gameStats.totalShipsInGame;
+    universe.gameStats.totalShipsInGame++;
 }
 
 
@@ -4628,7 +4682,7 @@
     GameStatsDebugHeader header;
     fileDelete(gamestatsfilename);
 
-    fh = fileOpen(gamestatsfilename,FF_AppendMode);
+    fh = fileOpen(gamestatsfilename, FF_AppendMode | FF_UserSettingsPath);
     dbgAssert(!fileUsingBigfile(fh));
     fp = fileStream(fh);
 
@@ -4653,7 +4707,7 @@
         gameStatsInitForReal();
         needToInit=FALSE;
     }
-    fh = fileOpen(gamestatsfilename,FF_AppendMode);
+    fh = fileOpen(gamestatsfilename, FF_AppendMode | FF_UserSettingsPath);
     dbgAssert(!fileUsingBigfile(fh));
     fp = fileStream(fh);
 
@@ -5205,7 +5259,7 @@
         return;
     }
 
-    statsFH = fileOpen(filename, FF_WriteMode | FF_TextMode | FF_ReturnNULLOnFail);
+    statsFH = fileOpen(filename, FF_WriteMode | FF_TextMode | FF_ReturnNULLOnFail | FF_UserSettingsPath);
     if (!statsFH)
     {
         return;
diff -urPw homeworld-orig/src/Game/Universe.h homeworld_sdl-0.3/src/Game/Universe.h
--- homeworld-orig/src/Game/Universe.h	2002-09-04 12:46:24.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Universe.h	2004-08-01 22:35:17.000000000 -0700
@@ -15,22 +15,22 @@
 #ifndef ___UNIVERSE_H
 #define ___UNIVERSE_H
 
-#include "types.h"
-#include "spaceobj.h"
-#include "objtypes.h"
-#include "camera.h"
-#include "cameracommand.h"
-#include "commandlayer.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "ObjTypes.h"
+#include "Camera.h"
+#include "CameraCommand.h"
+#include "CommandLayer.h"
 #ifndef STATVIEWER_PROGRAM
-#include "star3d.h"
+#include "Star3d.h"
 #include "ConsMgr.h"
-#include "globals.h"
+#include "Globals.h"
 
-#include "gamestats.h"
+#include "GameStats.h"
 #endif
-#include "researchapi.h"
-#include "objtypes.h"
-#include "shipselect.h"
+#include "ResearchAPI.h"
+#include "ObjTypes.h"
+#include "ShipSelect.h"
 
 /*=============================================================================
     Switches:
@@ -209,7 +209,7 @@
     Derelict *world[UNIV_NUMBER_WORLDS];        //list of planets
 } Universe;
 
-GrowSelection ClampedShipList;       // special GrowSelect which can have NULL's in it
+extern GrowSelection ClampedShipList;       // special GrowSelect which can have NULL's in it
 
 
 typedef void (*univstatcallback)(StaticInfo *info, ObjType objType);
diff -urPw homeworld-orig/src/Game/UnivUpdate.c homeworld_sdl-0.3/src/Game/UnivUpdate.c
--- homeworld-orig/src/Game/UnivUpdate.c	2002-09-04 12:46:24.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/UnivUpdate.c	2004-08-01 22:35:26.000000000 -0700
@@ -10,69 +10,69 @@
 #include <stdlib.h>
 #include <math.h>
 #include "glinc.h"
-#include "types.h"
-#include "debug.h"
-#include "matrix.h"
-#include "fastmath.h"
-#include "linkedlist.h"
-#include "objtypes.h"
-#include "spaceobj.h"
-#include "memory.h"
-#include "collision.h"
-#include "physics.h"
-#include "aitrack.h"
-#include "aiship.h"
-#include "commandlayer.h"
-#include "universe.h"
-#include "select.h"
-#include "statscript.h"
-#include "soundevent.h"
+#include "Types.h"
+#include "Debug.h"
+#include "Matrix.h"
+#include "FastMath.h"
+#include "LinkedList.h"
+#include "ObjTypes.h"
+#include "SpaceObj.h"
+#include "Memory.h"
+#include "Collision.h"
+#include "Physics.h"
+#include "AITrack.h"
+#include "AIShip.h"
+#include "CommandLayer.h"
+#include "Universe.h"
+#include "Select.h"
+#include "StatScript.h"
+#include "SoundEvent.h"
 #include "color.h"
-#include "globals.h"
-#include "flightman.h"
-#include "univupdate.h"
+#include "Globals.h"
+#include "FlightMan.h"
+#include "UnivUpdate.h"
 #include "DFGFrigate.h"
-#include "ships.h"
-#include "dock.h"
+#include "Ships.h"
+#include "Dock.h"
 #include "mainrgn.h"
-#include "pieplate.h"
-#include "sensors.h"
-#include "file.h"
-#include "netcheck.h"
-#include "commandwrap.h"
+#include "PiePlate.h"
+#include "Sensors.h"
+#include "File.h"
+#include "NetCheck.h"
+#include "CommandWrap.h"
 #include "utility.h"
-#include "singleplayer.h"
-#include "nis.h"
-#include "mex.h"
+#include "SinglePlayer.h"
+#include "NIS.h"
+#include "MEX.h"
 #include "mouse.h"
-#include "aiplayer.h"
-#include "clouds.h"
-#include "nebulae.h"
-#include "blobs.h"
-#include "strings.h"
-#include "researchapi.h"
-#include "tactics.h"
-#include "infooverlay.h"
-#include "multiplayergame.h"
-#include "meshanim.h"
-#include "alliance.h"
-#include "damage.h"
-#include "madLinkIn.h"
-#include "madLinkInDefs.h"
-#include "clamp.h"
-#include "levelload.h"
-#include "attributes.h"
-#include "ping.h"
-#include "teams.h"
-#include "bounties.h"
-#include "tutor.h"
-#include "trademgr.h"
-#include "crates.h"
+#include "AIPlayer.h"
+#include "Clouds.h"
+#include "Nebulae.h"
+#include "Blobs.h"
+#include "Strings.h"
+#include "ResearchAPI.h"
+#include "Tactics.h"
+#include "InfoOverlay.h"
+#include "MultiplayerGame.h"
+#include "MeshAnim.h"
+#include "Alliance.h"
+#include "Damage.h"
+#include "MadLinkIn.h"
+#include "MadLinkInDefs.h"
+#include "Clamp.h"
+#include "LevelLoad.h"
+#include "Attributes.h"
+#include "Ping.h"
+#include "Teams.h"
+#include "Bounties.h"
+#include "Tutor.h"
+#include "TradeMgr.h"
+#include "Crates.h"
 #include "SaveGame.h"
-#include "battle.h"
-#include "randy.h"
-#include "hs.h"
-#include "launchmgr.h"
+#include "Battle.h"
+#include "Randy.h"
+#include "HS.h"
+#include "LaunchMgr.h"
 #include "ProfileTimers.h"
 
 #ifndef HW_Release
@@ -2404,7 +2404,7 @@
     }
 
     vecSub(obj2VelRelToObj1,obj2->posinfo.velocity,obj1->posinfo.velocity);
-    veltangentfactor = abs(vecDotProduct(*distvector,obj2VelRelToObj1));
+    veltangentfactor = ABS(vecDotProduct(*distvector,obj2VelRelToObj1));
     veltangentfactor /= (COLLDAMAGE_VELOCITY_TANGENT_SCALE * dist);
     // now veltangentfactor is equal to k * |vel| cos(theta) where theta is angle between distvector and obj2VelRelToObj1
 
@@ -3018,6 +3018,8 @@
                 //charge, but don't take damage
                 DustCloudChargesUp((DustCloud*)target, (sdword)damagetaken, targetWasAlive);
                 return FALSE;
+            default:
+                break;
             }
 
 #if 0
@@ -4253,7 +4255,11 @@
             //all living players on same team?
             //find allies of first player, make sure all other living players
             // are allies
-            universe.players[sigsPlayerIndex].Allies;
+
+            // This statement does nothing but presumably was meant to do something. I'm leaving it
+            // here in case someone debugging this code realises it forms part of the solution...
+            //universe.players[sigsPlayerIndex].Allies;
+            
             for (i=0; ((i<universe.numPlayers) && alliedvictory); i++)
             {
                 if (universe.players[i].playerState == PLAYER_ALIVE)
@@ -4836,8 +4842,6 @@
 ----------------------------------------------------------------------------*/
 void DeleteDeadMissile(Missile *missile, sdword deathBy)
 {
-    real32 damagetaken = missile->damage;
-    MissileStaticInfo *missilestaticinfo = (MissileStaticInfo *)missile->staticinfo;
     etgeffectstatic *stat;
     sdword LOD;
     bool fatalHit;
@@ -6511,6 +6515,8 @@
         case OBJ_DustType:
             univFreeDustCloudContents((DustCloud *)resource);
             break;
+        default:
+            break;
     }
 }
 
@@ -7421,6 +7427,12 @@
 ----------------------------------------------------------------------------*/
 bool univUpdate(real32 phystimeelapsed)
 {
+#ifdef _WIN32
+#define TMP_SAVEDGAMES_PATH "SavedGames\\"
+#else
+#define TMP_SAVEDGAMES_PATH "SavedGames/"
+#endif
+
     if ((autoSaveDebug) && ((universe.univUpdateCounter & 31) == 0))    // every 2s
     {
         char savegamename[200];
@@ -7428,7 +7440,7 @@
 
         if (multiPlayerGame)
         {
-            sprintf(savegamename,"SavedGames\\AutoSave%f",universe.totaltimeelapsed);
+            sprintf(savegamename,TMP_SAVEDGAMES_PATH "AutoSave%f",universe.totaltimeelapsed);
             SaveGame(savegamename);
             clCommandMessage(strGetString(strSavedGame));
         }
@@ -7443,7 +7455,7 @@
                 }
                 else
                 {
-                    sprintf(savegamename,"SavedGames\\AutoSaveDebug%d",savenumber);
+                    sprintf(savegamename,TMP_SAVEDGAMES_PATH "AutoSaveDebug%d",savenumber);
                     savenumber = (savenumber+1) & 7;
                     SaveGame(savegamename);
                     clCommandMessage(strGetString(strSavedGame));
@@ -7452,6 +7464,8 @@
         }
     }
 
+#undef TMP_SAVEDGAMES_PATH
+
 #ifdef GOD_LIKE_SYNC_CHECKING
     if(multiPlayerGame)
     {
diff -urPw homeworld-orig/src/Game/UnivUpdate.h homeworld_sdl-0.3/src/Game/UnivUpdate.h
--- homeworld-orig/src/Game/UnivUpdate.h	2002-09-04 12:46:24.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/UnivUpdate.h	2004-08-01 22:35:27.000000000 -0700
@@ -9,13 +9,13 @@
 #ifndef ___UNIVERSEUPDATE_H
 #define ___UNIVERSEUPDATE_H
 
-#include "types.h"
-#include "vector.h"
-#include "linkedlist.h"
-#include "objtypes.h"
-#include "spaceobj.h"
-#include "shipselect.h"
-#include "mesh.h"
+#include "Types.h"
+#include "Vector.h"
+#include "LinkedList.h"
+#include "ObjTypes.h"
+#include "SpaceObj.h"
+#include "ShipSelect.h"
+#include "Mesh.h"
 
 /*=============================================================================
     Types:
diff -urPw homeworld-orig/src/Game/Vector.c homeworld_sdl-0.3/src/Game/Vector.c
--- homeworld-orig/src/Game/Vector.c	2002-09-04 12:46:24.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Vector.c	2004-08-01 22:35:35.000000000 -0700
@@ -6,11 +6,11 @@
 
 #include <stdio.h>
 #include <math.h>
-#include "types.h"
-#include "vector.h"
-#include "debug.h"
-#include "fastmath.h"
-#include "globals.h"
+#include "Types.h"
+#include "Vector.h"
+#include "Debug.h"
+#include "FastMath.h"
+#include "Globals.h"
 
 /*=============================================================================
     Functions:
@@ -245,9 +245,9 @@
 ----------------------------------------------------------------------------*/
 real32 getVectDistSloppy(vector diff)
 {
-    diff.x = abs(diff.x);
-    diff.y = abs(diff.y);
-    diff.z = abs(diff.z);
+    diff.x = ABS(diff.x);
+    diff.y = ABS(diff.y);
+    diff.z = ABS(diff.z);
 
     if (diff.x > diff.y)
     {
diff -urPw homeworld-orig/src/Game/Vector.h homeworld_sdl-0.3/src/Game/Vector.h
--- homeworld-orig/src/Game/Vector.h	2002-09-04 12:46:24.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Vector.h	2004-08-01 22:35:35.000000000 -0700
@@ -7,7 +7,7 @@
 #ifndef ___VECTOR_H
 #define ___VECTOR_H
 
-#include "types.h"
+#include "Types.h"
 
 /*=============================================================================
     Type definitions:
@@ -28,104 +28,104 @@
 =============================================================================*/
 
 #define vecSet(v,xp,yp,zp)  \
-    (v)##.x = (xp);         \
-    (v)##.y = (yp);         \
-    (v)##.z = (zp)
+    (v).x = (xp);         \
+    (v).y = (yp);         \
+    (v).z = (zp)
 
 #define vecGrabVecFromHVec(v,h) \
-    (v)##.x = (h)##.x;          \
-    (v)##.y = (h)##.y;          \
-    (v)##.z = (h)##.z
+    (v).x = (h).x;          \
+    (v).y = (h).y;          \
+    (v).z = (h).z
 
 #define vecMakeHVecFromVec(h,v) \
-    (h)##.x = (v)##.x;          \
-    (h)##.y = (v)##.y;          \
-    (h)##.z = (v)##.z;          \
-    (h)##.w = 1.0f;
+    (h).x = (v).x;          \
+    (h).y = (v).y;          \
+    (h).z = (v).z;          \
+    (h).w = 1.0f;
 
 #define vecZeroVector(a) \
-    (a)##.x = 0.0f;     \
-    (a)##.y = 0.0f;     \
-    (a)##.z = 0.0f
+    (a).x = 0.0f;     \
+    (a).y = 0.0f;     \
+    (a).z = 0.0f
 
 #define vecAdd(a,b,c) \
-    (a)##.x = (b)##.x + (c)##.x; \
-    (a)##.y = (b)##.y + (c)##.y; \
-    (a)##.z = (b)##.z + (c)##.z
+    (a).x = (b).x + (c).x; \
+    (a).y = (b).y + (c).y; \
+    (a).z = (b).z + (c).z
 
 #define vecAddTo(a,b) \
-    (a)##.x += (b)##.x; \
-    (a)##.y += (b)##.y; \
-    (a)##.z += (b)##.z
+    (a).x += (b).x; \
+    (a).y += (b).y; \
+    (a).z += (b).z
 
 #define vecSub(a,b,c) \
-    (a)##.x = (b)##.x - (c)##.x; \
-    (a)##.y = (b)##.y - (c)##.y; \
-    (a)##.z = (b)##.z - (c)##.z
+    (a).x = (b).x - (c).x; \
+    (a).y = (b).y - (c).y; \
+    (a).z = (b).z - (c).z
 
 #define vecSubFrom(a,b) \
-    (a)##.x -= (b)##.x; \
-    (a)##.y -= (b)##.y; \
-    (a)##.z -= (b)##.z
+    (a).x -= (b).x; \
+    (a).y -= (b).y; \
+    (a).z -= (b).z
 
 #define vecDotProduct(a,b) \
-    ( ((a)##.x * (b)##.x) + ((a)##.y * (b)##.y) + ((a)##.z * (b)##.z) )
+    ( ((a).x * (b).x) + ((a).y * (b).y) + ((a).z * (b).z) )
 
 #define vecCrossProduct(result,a,b) \
-    (result)##.x = ((a)##.y * (b)##.z) - ((a)##.z * (b)##.y); \
-    (result)##.y = ((a)##.z * (b)##.x) - ((a)##.x * (b)##.z); \
-    (result)##.z = ((a)##.x * (b)##.y) - ((a)##.y * (b)##.x)
+    (result).x = ((a).y * (b).z) - ((a).z * (b).y); \
+    (result).y = ((a).z * (b).x) - ((a).x * (b).z); \
+    (result).z = ((a).x * (b).y) - ((a).y * (b).x)
 
 #define vecAddToScalarMultiply(dstvec,vec,k) \
-    (dstvec)##.x += ((vec)##.x * (k));       \
-    (dstvec)##.y += ((vec)##.y * (k));       \
-    (dstvec)##.z += ((vec)##.z * (k))
+    (dstvec).x += ((vec).x * (k));       \
+    (dstvec).y += ((vec).y * (k));       \
+    (dstvec).z += ((vec).z * (k))
 
 #define vecSubFromScalarMultiply(dstvec,vec,k) \
-    (dstvec)##.x -= ((vec)##.x * (k));       \
-    (dstvec)##.y -= ((vec)##.y * (k));       \
-    (dstvec)##.z -= ((vec)##.z * (k))
+    (dstvec).x -= ((vec).x * (k));       \
+    (dstvec).y -= ((vec).y * (k));       \
+    (dstvec).z -= ((vec).z * (k))
 
 #define vecScalarMultiply(dstvec,vec,k) \
-    (dstvec)##.x = (vec)##.x * (k);       \
-    (dstvec)##.y = (vec)##.y * (k);       \
-    (dstvec)##.z = (vec)##.z * (k)
+    (dstvec).x = (vec).x * (k);       \
+    (dstvec).y = (vec).y * (k);       \
+    (dstvec).z = (vec).z * (k)
 
 #define vecMultiplyByScalar(vec,k) \
-    (vec)##.x *= (k);                \
-    (vec)##.y *= (k);                \
-    (vec)##.z *= (k)
+    (vec).x *= (k);                \
+    (vec).y *= (k);                \
+    (vec).z *= (k)
 
 #define vecScalarDivide(dstvec,vec,k,tmp) \
     (tmp) = 1.0f / (k);                 \
-    (dstvec)##.x = (vec)##.x * (tmp);     \
-    (dstvec)##.y = (vec)##.y * (tmp);     \
-    (dstvec)##.z = (vec)##.z * (tmp)
+    (dstvec).x = (vec).x * (tmp);     \
+    (dstvec).y = (vec).y * (tmp);     \
+    (dstvec).z = (vec).z * (tmp)
 
 #define vecDivideByScalar(vec,k,tmp) \
     (tmp) = 1.0f / (k);              \
-    (vec)##.x *= (tmp);              \
-    (vec)##.y *= (tmp);              \
-    (vec)##.z *= (tmp)
+    (vec).x *= (tmp);              \
+    (vec).y *= (tmp);              \
+    (vec).z *= (tmp)
 
 #define vecNegate(vec) \
-    (vec)##.x = -(vec)##.x; \
-    (vec)##.y = -(vec)##.y; \
-    (vec)##.z = -(vec)##.z
+    (vec).x = -(vec).x; \
+    (vec).y = -(vec).y; \
+    (vec).z = -(vec).z
 
 #define vecCopyAndNegate(dstvec,vec) \
-    (dstvec)##.x = -(vec)##.x; \
-    (dstvec)##.y = -(vec)##.y; \
-    (dstvec)##.z = -(vec)##.z
+    (dstvec).x = -(vec).x; \
+    (dstvec).y = -(vec).y; \
+    (dstvec).z = -(vec).z
 
 #define vecMagnitudeSquared(a) \
-    ( ((a)##.x * (a)##.x) + ((a)##.y * (a)##.y) + ((a)##.z * (a)##.z) )
+    ( ((a).x * (a).x) + ((a).y * (a).y) + ((a).z * (a).z) )
 
 #define vecAreEqual(a,b) \
-    ( ((a)##.x == (b)##.x) && ((a)##.y == (b)##.y) && ((a)##.z == (b)##.z) )
+    ( ((a).x == (b).x) && ((a).y == (b).y) && ((a).z == (b).z) )
 
 #define vecIsZero(a) \
-    ( ((a)##.x == 0.0f) && ((a)##.y == 0.0f) && ((a)##.z == 0.0f) )
+    ( ((a).x == 0.0f) && ((a).y == 0.0f) && ((a).z == 0.0f) )
 
 /*=============================================================================
     Functions:
diff -urPw homeworld-orig/src/Game/Volume.c homeworld_sdl-0.3/src/Game/Volume.c
--- homeworld-orig/src/Game/Volume.c	2002-09-04 12:46:24.000000000 -0700
+++ homeworld_sdl-0.3/src/Game/Volume.c	2004-08-01 22:35:32.000000000 -0700
@@ -1,6 +1,6 @@
 #include "AIUtilities.h"
-#include "vector.h"
-#include "volume.h"
+#include "Vector.h"
+#include "Volume.h"
 
 //
 //  returns true if the point is in the volume
Only in homeworld-orig/src/Game: vssver.scc
diff -urPw homeworld-orig/src/JPG/interfce.c homeworld_sdl-0.3/src/JPG/interfce.c
--- homeworld-orig/src/JPG/interfce.c	2002-09-04 12:46:24.000000000 -0700
+++ homeworld_sdl-0.3/src/JPG/interfce.c	2004-08-01 22:35:03.000000000 -0700
@@ -10,7 +10,6 @@
 //
 //-----------------------------------------------------------------------------
 
-#include <windows.h>
 #include <stdlib.h>
 #include <stdio.h>
 #include <string.h>
@@ -142,9 +141,11 @@
      while (cinfo.next_scanline < cinfo.image_height) {
         row_pointer[0] = &data->ptr[cinfo.next_scanline * row_stride];
         (void) jpeg_write_scanlines(&cinfo, row_pointer, 1);
+        /*
         if (data->hWnd)
            SendMessage((HWND)data->hWnd,data->ProgressMsg,
                               cinfo.next_scanline,cinfo.image_height);
+        */
      }
 
      //-- Finish compression and release memory
@@ -167,7 +168,7 @@
      struct jpeg_decompress_struct cinfo;
      struct my_error_mgr           jerr;
 
-     BYTE      *bf;
+     ubyte     *bf;
      JSAMPARRAY buffer;
      int        row_stride,y;
 
@@ -202,9 +203,11 @@
         (void) jpeg_read_scanlines(&cinfo, buffer, 1);
         memcpy(bf,buffer[0],row_stride);
         bf += row_stride;
+        /*
         if (data->hWnd)
            SendMessage((HWND)data->hWnd,
                 data->ProgressMsg,++y,cinfo.image_height);
+        */
      }
 
      (void) jpeg_finish_decompress(&cinfo);
diff -urPw homeworld-orig/src/JPG/interfce.h homeworld_sdl-0.3/src/JPG/interfce.h
--- homeworld-orig/src/JPG/interfce.h	2002-09-04 12:46:24.000000000 -0700
+++ homeworld_sdl-0.3/src/JPG/interfce.h	2004-08-01 22:35:04.000000000 -0700
@@ -13,7 +13,7 @@
 #ifndef __JPEGINTERFACE_H__
 #define __JPEGINTERFACE_H__
 
-#include "file.h"
+#include "File.h"
 
 typedef struct _jpegdata {
    unsigned char *ptr;
@@ -25,7 +25,7 @@
    int    CCIR601sampling;
    int    smoothingfactor;
    int    quality;
-   udword hWnd;
+   /*udword hWnd;*/
    int    ProgressMsg;
    int    status;
    int    components;
diff -urPw homeworld-orig/src/JPG/jcmainct.c homeworld_sdl-0.3/src/JPG/jcmainct.c
--- homeworld-orig/src/JPG/jcmainct.c	2002-09-04 12:46:24.000000000 -0700
+++ homeworld_sdl-0.3/src/JPG/jcmainct.c	2004-08-01 22:35:05.000000000 -0700
@@ -68,32 +68,32 @@
 METHODDEF void
 start_pass_main (j_compress_ptr cinfo, J_BUF_MODE pass_mode)
 {
-  my_main_ptr main = (my_main_ptr) cinfo->main;
+  my_main_ptr main_ptr = (my_main_ptr) cinfo->main;
 
   /* Do nothing in raw-data mode. */
   if (cinfo->raw_data_in)
     return;
 
-  main->cur_iMCU_row = 0;	/* initialize counters */
-  main->rowgroup_ctr = 0;
-  main->suspended = FALSE;
-  main->pass_mode = pass_mode;	/* save mode for use by process_data */
+  main_ptr->cur_iMCU_row = 0;	/* initialize counters */
+  main_ptr->rowgroup_ctr = 0;
+  main_ptr->suspended = FALSE;
+  main_ptr->pass_mode = pass_mode;	/* save mode for use by process_data */
 
   switch (pass_mode) {
   case JBUF_PASS_THRU:
 #ifdef FULL_MAIN_BUFFER_SUPPORTED
-    if (main->whole_image[0] != NULL)
+    if (main_ptr->whole_image[0] != NULL)
       ERREXIT(cinfo, JERR_BAD_BUFFER_MODE);
 #endif
-    main->pub.process_data = process_data_simple_main;
+    main_ptr->pub.process_data = process_data_simple_main;
     break;
 #ifdef FULL_MAIN_BUFFER_SUPPORTED
   case JBUF_SAVE_SOURCE:
   case JBUF_CRANK_DEST:
   case JBUF_SAVE_AND_PASS:
-    if (main->whole_image[0] == NULL)
+    if (main_ptr->whole_image[0] == NULL)
       ERREXIT(cinfo, JERR_BAD_BUFFER_MODE);
-    main->pub.process_data = process_data_buffer_main;
+    main_ptr->pub.process_data = process_data_buffer_main;
     break;
 #endif
   default:
@@ -114,46 +114,46 @@
 			  JSAMPARRAY input_buf, JDIMENSION *in_row_ctr,
 			  JDIMENSION in_rows_avail)
 {
-  my_main_ptr main = (my_main_ptr) cinfo->main;
+  my_main_ptr main_ptr = (my_main_ptr) cinfo->main;
 
-  while (main->cur_iMCU_row < cinfo->total_iMCU_rows) {
+  while (main_ptr->cur_iMCU_row < cinfo->total_iMCU_rows) {
     /* Read input data if we haven't filled the main buffer yet */
-    if (main->rowgroup_ctr < DCTSIZE)
+    if (main_ptr->rowgroup_ctr < DCTSIZE)
       (*cinfo->prep->pre_process_data) (cinfo,
 					input_buf, in_row_ctr, in_rows_avail,
-					main->buffer, &main->rowgroup_ctr,
+					main_ptr->buffer, &main_ptr->rowgroup_ctr,
 					(JDIMENSION) DCTSIZE);
 
     /* If we don't have a full iMCU row buffered, return to application for
      * more data.  Note that preprocessor will always pad to fill the iMCU row
      * at the bottom of the image.
      */
-    if (main->rowgroup_ctr != DCTSIZE)
+    if (main_ptr->rowgroup_ctr != DCTSIZE)
       return;
 
     /* Send the completed row to the compressor */
-    if (! (*cinfo->coef->compress_data) (cinfo, main->buffer)) {
+    if (! (*cinfo->coef->compress_data) (cinfo, main_ptr->buffer)) {
       /* If compressor did not consume the whole row, then we must need to
        * suspend processing and return to the application.  In this situation
        * we pretend we didn't yet consume the last input row; otherwise, if
        * it happened to be the last row of the image, the application would
        * think we were done.
        */
-      if (! main->suspended) {
+      if (! main_ptr->suspended) {
 	(*in_row_ctr)--;
-	main->suspended = TRUE;
+	main_ptr->suspended = TRUE;
       }
       return;
     }
     /* We did finish the row.  Undo our little suspension hack if a previous
      * call suspended; then mark the main buffer empty.
      */
-    if (main->suspended) {
+    if (main_ptr->suspended) {
       (*in_row_ctr)++;
-      main->suspended = FALSE;
+      main_ptr->suspended = FALSE;
     }
-    main->rowgroup_ctr = 0;
-    main->cur_iMCU_row++;
+    main_ptr->rowgroup_ctr = 0;
+    main_ptr->cur_iMCU_row++;
   }
 }
 
@@ -244,15 +244,15 @@
 GLOBAL void
 jinit_c_main_controller (j_compress_ptr cinfo, boolean need_full_buffer)
 {
-  my_main_ptr main;
+  my_main_ptr main_ptr;
   int ci;
   jpeg_component_info *compptr;
 
-  main = (my_main_ptr)
+  main_ptr = (my_main_ptr)
     (*cinfo->mem->alloc_small) ((j_common_ptr) cinfo, JPOOL_IMAGE,
 				SIZEOF(my_main_controller));
-  cinfo->main = (struct jpeg_c_main_controller *) main;
-  main->pub.start_pass = start_pass_main;
+  cinfo->main = (struct jpeg_c_main_controller *) main_ptr;
+  main_ptr->pub.start_pass = start_pass_main;
 
   /* We don't need to create a buffer in raw-data mode. */
   if (cinfo->raw_data_in)
@@ -284,7 +284,7 @@
     /* Allocate a strip buffer for each component */
     for (ci = 0, compptr = cinfo->comp_info; ci < cinfo->num_components;
 	 ci++, compptr++) {
-      main->buffer[ci] = (*cinfo->mem->alloc_sarray)
+      main_ptr->buffer[ci] = (*cinfo->mem->alloc_sarray)
 	((j_common_ptr) cinfo, JPOOL_IMAGE,
 	 compptr->width_in_blocks * DCTSIZE,
 	 (JDIMENSION) (compptr->v_samp_factor * DCTSIZE));
diff -urPw homeworld-orig/src/JPG/jdmainct.c homeworld_sdl-0.3/src/JPG/jdmainct.c
--- homeworld-orig/src/JPG/jdmainct.c	2002-09-04 12:46:26.000000000 -0700
+++ homeworld_sdl-0.3/src/JPG/jdmainct.c	2004-08-01 22:35:05.000000000 -0700
@@ -159,7 +159,7 @@
  * This is done only once, not once per pass.
  */
 {
-  my_main_ptr main = (my_main_ptr) cinfo->main;
+  my_main_ptr main_ptr = (my_main_ptr) cinfo->main;
   int ci, rgroup;
   int M = cinfo->min_DCT_scaled_size;
   jpeg_component_info *compptr;
@@ -168,10 +168,10 @@
   /* Get top-level space for component array pointers.
    * We alloc both arrays with one call to save a few cycles.
    */
-  main->xbuffer[0] = (JSAMPIMAGE)
+  main_ptr->xbuffer[0] = (JSAMPIMAGE)
     (*cinfo->mem->alloc_small) ((j_common_ptr) cinfo, JPOOL_IMAGE,
 				cinfo->num_components * 2 * SIZEOF(JSAMPARRAY));
-  main->xbuffer[1] = main->xbuffer[0] + cinfo->num_components;
+  main_ptr->xbuffer[1] = main_ptr->xbuffer[0] + cinfo->num_components;
 
   for (ci = 0, compptr = cinfo->comp_info; ci < cinfo->num_components;
        ci++, compptr++) {
@@ -184,9 +184,9 @@
       (*cinfo->mem->alloc_small) ((j_common_ptr) cinfo, JPOOL_IMAGE,
 				  2 * (rgroup * (M + 4)) * SIZEOF(JSAMPROW));
     xbuf += rgroup;		/* want one row group at negative offsets */
-    main->xbuffer[0][ci] = xbuf;
+    main_ptr->xbuffer[0][ci] = xbuf;
     xbuf += rgroup * (M + 4);
-    main->xbuffer[1][ci] = xbuf;
+    main_ptr->xbuffer[1][ci] = xbuf;
   }
 }
 
@@ -200,7 +200,7 @@
  * This will be repeated at the beginning of each pass.
  */
 {
-  my_main_ptr main = (my_main_ptr) cinfo->main;
+  my_main_ptr main_ptr = (my_main_ptr) cinfo->main;
   int ci, i, rgroup;
   int M = cinfo->min_DCT_scaled_size;
   jpeg_component_info *compptr;
@@ -210,10 +210,10 @@
        ci++, compptr++) {
     rgroup = (compptr->v_samp_factor * compptr->DCT_scaled_size) /
       cinfo->min_DCT_scaled_size; /* height of a row group of component */
-    xbuf0 = main->xbuffer[0][ci];
-    xbuf1 = main->xbuffer[1][ci];
+    xbuf0 = main_ptr->xbuffer[0][ci];
+    xbuf1 = main_ptr->xbuffer[1][ci];
     /* First copy the workspace pointers as-is */
-    buf = main->buffer[ci];
+    buf = main_ptr->buffer[ci];
     for (i = 0; i < rgroup * (M + 2); i++) {
       xbuf0[i] = xbuf1[i] = buf[i];
     }
@@ -240,7 +240,7 @@
  * This changes the pointer list state from top-of-image to the normal state.
  */
 {
-  my_main_ptr main = (my_main_ptr) cinfo->main;
+  my_main_ptr main_ptr = (my_main_ptr) cinfo->main;
   int ci, i, rgroup;
   int M = cinfo->min_DCT_scaled_size;
   jpeg_component_info *compptr;
@@ -250,8 +250,8 @@
        ci++, compptr++) {
     rgroup = (compptr->v_samp_factor * compptr->DCT_scaled_size) /
       cinfo->min_DCT_scaled_size; /* height of a row group of component */
-    xbuf0 = main->xbuffer[0][ci];
-    xbuf1 = main->xbuffer[1][ci];
+    xbuf0 = main_ptr->xbuffer[0][ci];
+    xbuf1 = main_ptr->xbuffer[1][ci];
     for (i = 0; i < rgroup; i++) {
       xbuf0[i - rgroup] = xbuf0[rgroup*(M+1) + i];
       xbuf1[i - rgroup] = xbuf1[rgroup*(M+1) + i];
@@ -269,7 +269,7 @@
  * Also sets rowgroups_avail to indicate number of nondummy row groups in row.
  */
 {
-  my_main_ptr main = (my_main_ptr) cinfo->main;
+  my_main_ptr main_ptr = (my_main_ptr) cinfo->main;
   int ci, i, rgroup, iMCUheight, rows_left;
   jpeg_component_info *compptr;
   JSAMPARRAY xbuf;
@@ -286,12 +286,12 @@
      * so we need only do it once.
      */
     if (ci == 0) {
-      main->rowgroups_avail = (JDIMENSION) ((rows_left-1) / rgroup + 1);
+      main_ptr->rowgroups_avail = (JDIMENSION) ((rows_left-1) / rgroup + 1);
     }
     /* Duplicate the last real sample row rgroup*2 times; this pads out the
      * last partial rowgroup and ensures at least one full rowgroup of context.
      */
-    xbuf = main->xbuffer[main->whichptr][ci];
+    xbuf = main_ptr->xbuffer[main_ptr->whichptr][ci];
     for (i = 0; i < rgroup * 2; i++) {
       xbuf[rows_left + i] = xbuf[rows_left-1];
     }
@@ -306,27 +306,27 @@
 METHODDEF void
 start_pass_main (j_decompress_ptr cinfo, J_BUF_MODE pass_mode)
 {
-  my_main_ptr main = (my_main_ptr) cinfo->main;
+  my_main_ptr main_ptr = (my_main_ptr) cinfo->main;
 
   switch (pass_mode) {
   case JBUF_PASS_THRU:
     if (cinfo->upsample->need_context_rows) {
-      main->pub.process_data = process_data_context_main;
+      main_ptr->pub.process_data = process_data_context_main;
       make_funny_pointers(cinfo); /* Create the xbuffer[] lists */
-      main->whichptr = 0;	/* Read first iMCU row into xbuffer[0] */
-      main->context_state = CTX_PREPARE_FOR_IMCU;
-      main->iMCU_row_ctr = 0;
+      main_ptr->whichptr = 0;	/* Read first iMCU row into xbuffer[0] */
+      main_ptr->context_state = CTX_PREPARE_FOR_IMCU;
+      main_ptr->iMCU_row_ctr = 0;
     } else {
       /* Simple case with no context needed */
-      main->pub.process_data = process_data_simple_main;
+      main_ptr->pub.process_data = process_data_simple_main;
     }
-    main->buffer_full = FALSE;	/* Mark buffer empty */
-    main->rowgroup_ctr = 0;
+    main_ptr->buffer_full = FALSE;	/* Mark buffer empty */
+    main_ptr->rowgroup_ctr = 0;
     break;
 #ifdef QUANT_2PASS_SUPPORTED
   case JBUF_CRANK_DEST:
     /* For last pass of 2-pass quantization, just crank the postprocessor */
-    main->pub.process_data = process_data_crank_post;
+    main_ptr->pub.process_data = process_data_crank_post;
     break;
 #endif
   default:
@@ -346,14 +346,14 @@
 			  JSAMPARRAY output_buf, JDIMENSION *out_row_ctr,
 			  JDIMENSION out_rows_avail)
 {
-  my_main_ptr main = (my_main_ptr) cinfo->main;
+  my_main_ptr main_ptr = (my_main_ptr) cinfo->main;
   JDIMENSION rowgroups_avail;
 
   /* Read input data if we haven't filled the main buffer yet */
-  if (! main->buffer_full) {
-    if (! (*cinfo->coef->decompress_data) (cinfo, main->buffer))
+  if (! main_ptr->buffer_full) {
+    if (! (*cinfo->coef->decompress_data) (cinfo, main_ptr->buffer))
       return;			/* suspension forced, can do nothing more */
-    main->buffer_full = TRUE;	/* OK, we have an iMCU row to work with */
+    main_ptr->buffer_full = TRUE;	/* OK, we have an iMCU row to work with */
   }
 
   /* There are always min_DCT_scaled_size row groups in an iMCU row. */
@@ -364,14 +364,14 @@
    */
 
   /* Feed the postprocessor */
-  (*cinfo->post->post_process_data) (cinfo, main->buffer,
-				     &main->rowgroup_ctr, rowgroups_avail,
+  (*cinfo->post->post_process_data) (cinfo, main_ptr->buffer,
+				     &main_ptr->rowgroup_ctr, rowgroups_avail,
 				     output_buf, out_row_ctr, out_rows_avail);
 
   /* Has postprocessor consumed all the data yet? If so, mark buffer empty */
-  if (main->rowgroup_ctr >= rowgroups_avail) {
-    main->buffer_full = FALSE;
-    main->rowgroup_ctr = 0;
+  if (main_ptr->rowgroup_ctr >= rowgroups_avail) {
+    main_ptr->buffer_full = FALSE;
+    main_ptr->rowgroup_ctr = 0;
   }
 }
 
@@ -386,15 +386,15 @@
 			   JSAMPARRAY output_buf, JDIMENSION *out_row_ctr,
 			   JDIMENSION out_rows_avail)
 {
-  my_main_ptr main = (my_main_ptr) cinfo->main;
+  my_main_ptr main_ptr = (my_main_ptr) cinfo->main;
 
   /* Read input data if we haven't filled the main buffer yet */
-  if (! main->buffer_full) {
+  if (! main_ptr->buffer_full) {
     if (! (*cinfo->coef->decompress_data) (cinfo,
-					   main->xbuffer[main->whichptr]))
+					   main_ptr->xbuffer[main_ptr->whichptr]))
       return;			/* suspension forced, can do nothing more */
-    main->buffer_full = TRUE;	/* OK, we have an iMCU row to work with */
-    main->iMCU_row_ctr++;	/* count rows received */
+    main_ptr->buffer_full = TRUE;	/* OK, we have an iMCU row to work with */
+    main_ptr->iMCU_row_ctr++;	/* count rows received */
   }
 
   /* Postprocessor typically will not swallow all the input data it is handed
@@ -402,47 +402,47 @@
    * to exit and restart.  This switch lets us keep track of how far we got.
    * Note that each case falls through to the next on successful completion.
    */
-  switch (main->context_state) {
+  switch (main_ptr->context_state) {
   case CTX_POSTPONED_ROW:
     /* Call postprocessor using previously set pointers for postponed row */
-    (*cinfo->post->post_process_data) (cinfo, main->xbuffer[main->whichptr],
-			&main->rowgroup_ctr, main->rowgroups_avail,
+    (*cinfo->post->post_process_data) (cinfo, main_ptr->xbuffer[main_ptr->whichptr],
+			&main_ptr->rowgroup_ctr, main_ptr->rowgroups_avail,
 			output_buf, out_row_ctr, out_rows_avail);
-    if (main->rowgroup_ctr < main->rowgroups_avail)
+    if (main_ptr->rowgroup_ctr < main_ptr->rowgroups_avail)
       return;			/* Need to suspend */
-    main->context_state = CTX_PREPARE_FOR_IMCU;
+    main_ptr->context_state = CTX_PREPARE_FOR_IMCU;
     if (*out_row_ctr >= out_rows_avail)
       return;			/* Postprocessor exactly filled output buf */
     /*FALLTHROUGH*/
   case CTX_PREPARE_FOR_IMCU:
     /* Prepare to process first M-1 row groups of this iMCU row */
-    main->rowgroup_ctr = 0;
-    main->rowgroups_avail = (JDIMENSION) (cinfo->min_DCT_scaled_size - 1);
+    main_ptr->rowgroup_ctr = 0;
+    main_ptr->rowgroups_avail = (JDIMENSION) (cinfo->min_DCT_scaled_size - 1);
     /* Check for bottom of image: if so, tweak pointers to "duplicate"
      * the last sample row, and adjust rowgroups_avail to ignore padding rows.
      */
-    if (main->iMCU_row_ctr == cinfo->total_iMCU_rows)
+    if (main_ptr->iMCU_row_ctr == cinfo->total_iMCU_rows)
       set_bottom_pointers(cinfo);
-    main->context_state = CTX_PROCESS_IMCU;
+    main_ptr->context_state = CTX_PROCESS_IMCU;
     /*FALLTHROUGH*/
   case CTX_PROCESS_IMCU:
     /* Call postprocessor using previously set pointers */
-    (*cinfo->post->post_process_data) (cinfo, main->xbuffer[main->whichptr],
-			&main->rowgroup_ctr, main->rowgroups_avail,
+    (*cinfo->post->post_process_data) (cinfo, main_ptr->xbuffer[main_ptr->whichptr],
+			&main_ptr->rowgroup_ctr, main_ptr->rowgroups_avail,
 			output_buf, out_row_ctr, out_rows_avail);
-    if (main->rowgroup_ctr < main->rowgroups_avail)
+    if (main_ptr->rowgroup_ctr < main_ptr->rowgroups_avail)
       return;			/* Need to suspend */
     /* After the first iMCU, change wraparound pointers to normal state */
-    if (main->iMCU_row_ctr == 1)
+    if (main_ptr->iMCU_row_ctr == 1)
       set_wraparound_pointers(cinfo);
     /* Prepare to load new iMCU row using other xbuffer list */
-    main->whichptr ^= 1;	/* 0=>1 or 1=>0 */
-    main->buffer_full = FALSE;
+    main_ptr->whichptr ^= 1;	/* 0=>1 or 1=>0 */
+    main_ptr->buffer_full = FALSE;
     /* Still need to process last row group of this iMCU row, */
     /* which is saved at index M+1 of the other xbuffer */
-    main->rowgroup_ctr = (JDIMENSION) (cinfo->min_DCT_scaled_size + 1);
-    main->rowgroups_avail = (JDIMENSION) (cinfo->min_DCT_scaled_size + 2);
-    main->context_state = CTX_POSTPONED_ROW;
+    main_ptr->rowgroup_ctr = (JDIMENSION) (cinfo->min_DCT_scaled_size + 1);
+    main_ptr->rowgroups_avail = (JDIMENSION) (cinfo->min_DCT_scaled_size + 2);
+    main_ptr->context_state = CTX_POSTPONED_ROW;
   }
 }
 
@@ -475,15 +475,15 @@
 GLOBAL void
 jinit_d_main_controller (j_decompress_ptr cinfo, boolean need_full_buffer)
 {
-  my_main_ptr main;
+  my_main_ptr main_ptr;
   int ci, rgroup, ngroups;
   jpeg_component_info *compptr;
 
-  main = (my_main_ptr)
+  main_ptr = (my_main_ptr)
     (*cinfo->mem->alloc_small) ((j_common_ptr) cinfo, JPOOL_IMAGE,
 				SIZEOF(my_main_controller));
-  cinfo->main = (struct jpeg_d_main_controller *) main;
-  main->pub.start_pass = start_pass_main;
+  cinfo->main = (struct jpeg_d_main_controller *) main_ptr;
+  main_ptr->pub.start_pass = start_pass_main;
 
   if (need_full_buffer)		/* shouldn't happen */
     ERREXIT(cinfo, JERR_BAD_BUFFER_MODE);
@@ -504,7 +504,7 @@
        ci++, compptr++) {
     rgroup = (compptr->v_samp_factor * compptr->DCT_scaled_size) /
       cinfo->min_DCT_scaled_size; /* height of a row group of component */
-    main->buffer[ci] = (*cinfo->mem->alloc_sarray)
+    main_ptr->buffer[ci] = (*cinfo->mem->alloc_sarray)
 			((j_common_ptr) cinfo, JPOOL_IMAGE,
 			 compptr->width_in_blocks * compptr->DCT_scaled_size,
 			 (JDIMENSION) (rgroup * ngroups));
diff -urPw homeworld-orig/src/JPG/jinclude.h homeworld_sdl-0.3/src/JPG/jinclude.h
--- homeworld-orig/src/JPG/jinclude.h	2002-09-04 12:46:26.000000000 -0700
+++ homeworld_sdl-0.3/src/JPG/jinclude.h	2004-08-01 22:35:04.000000000 -0700
@@ -19,8 +19,8 @@
 
 #include "jconfig.h"		/* auto configuration options */
 #define JCONFIG_INCLUDED	/* so that jpeglib.h doesn't do it again */
-#include <Stdlib.h>
-#include "file.h"
+#include <stdlib.h>
+#include "File.h"
 
 /*
  * We need the NULL macro and size_t typedef.
Only in homeworld-orig/src/JPG: vssver.scc
diff -urPw homeworld-orig/src/kas2c/kas2c.c homeworld_sdl-0.3/src/kas2c/kas2c.c
--- homeworld-orig/src/kas2c/kas2c.c	2004-08-02 23:14:13.959562864 -0700
+++ homeworld_sdl-0.3/src/kas2c/kas2c.c	2004-08-01 22:35:11.000000000 -0700
@@ -6,13 +6,20 @@
 
 #include <stdio.h>
 #include <string.h>
+#include <strings.h>
 #include "kas2c.h"
 
+#ifdef _WIN32
+#define strcasecmp _stricmp
+#endif
+
 //#define LOTS_OF_DEBUGS 1
 
 extern char *yytname[];
 
-extern FILE *yyin, *yyout, *yyhout;
+extern FILE *yyin, *yyout, *yyhout, *yyfout;
+
+extern unsigned int functionCount;
 
 extern int yynerrs;
 
@@ -1255,7 +1262,7 @@
         { "effectParam",    PARAM_SDWORD },
     } },
 
-    { "*", 0, "", 0, { "", 0 } } // end-marker
+    { "*", 0, "", 0, { { "", 0 } } } // end-marker
 };
 
 
@@ -1309,7 +1316,7 @@
     parseLevel = LEVEL_LEVEL;
     if (name[0] && strcmp(name, fsmName[fsmCurrent]))
     {
-        fprintf(stderr, "%s(%d) warning : %s FSM ended with different name: %s\n", fsmName[fsmCurrent], name);
+        fprintf(stderr, "%s(%d) warning : %s FSM ended with different name: %s\n", curFilenameGet(), lineNumGet(), fsmName[fsmCurrent], name);
         ++yynerrs;
     }
     sprintf(stateHelp, "expecting initialize section for mission after FSM definition(s)");
@@ -1459,7 +1466,7 @@
     parseLevel = LEVEL_FSM;
     if (name[0] && strcmp(name, stateName[stateCurrent]))
     {
-        fprintf(stderr, "%s(%d) warning : %s state ended with different name: %s\n", stateName[stateCurrent], name);
+        fprintf(stderr, "%s(%d) warning : %s state ended with different name: %s\n", curFilenameGet(), lineNumGet(), stateName[stateCurrent], name);
         ++yynerrs;
     }
     sprintf(stateHelp, "expecting end of %s FSM after state definition(s)", fsmName[fsmCurrent]);
@@ -1468,7 +1475,7 @@
 //
 //  set run-time scope for variables, timers, etc.
 //
-static kasScopeSet(void)
+static void kasScopeSet(void)
 {
     switch (parseLevel)
     {
@@ -1550,6 +1557,11 @@
 
     // prototype
     fprintf(yyhout, "void %s(void);\n", funcName);
+
+    // function pointer
+    if (yyfout)
+        fprintf(yyfout, "\t(void*)%s,\n", funcName);
+    functionCount++;
 }
 
 void kasInitializeEnd(void)
@@ -1637,6 +1649,11 @@
 
     // prototype
     fprintf(yyhout, "void %s(void);\n", funcName);
+
+    // function pointer
+    if (yyfout)
+        fprintf(yyfout, "\t(void*)%s,\n", funcName);
+    functionCount++;
 }
 
 void kasWatchEnd(void)
@@ -2240,7 +2257,7 @@
     {
         if (functions[i].name[0] == '*')
             return -1;
-        else if (!stricmp(name, functions[i].name))
+        else if (!strcasecmp(name, functions[i].name))
             return i;
         ++i;
     }
diff -urPw homeworld-orig/src/kas2c/kas2c.h homeworld_sdl-0.3/src/kas2c/kas2c.h
--- homeworld-orig/src/kas2c/kas2c.h	2004-08-02 23:14:13.964562104 -0700
+++ homeworld_sdl-0.3/src/kas2c/kas2c.h	2004-08-01 22:35:11.000000000 -0700
@@ -1,7 +1,8 @@
 #ifndef __KAS2C_H
 #define __KAS2C_H
 
-#define KAS2C_VERSION "2.05"
+//#define KAS2C_VERSION "2.05"
+#define KAS2C_VERSION "2.05sdl"
 
 // "depth" of script we're currently parsing at
 #define LEVEL_LEVEL 0
@@ -98,8 +99,10 @@
 void kasFunctionParamNumber(void);
 void kasFunctionParamCharPtr(void);
 void kasFunctionParamAITeamPtr(void);
+void kasFunctionParamSelectCommandPtr(void);
 void kasFunctionParamPathPtr(void);
 void kasFunctionParamVectorPtr(void);
+void kasFunctionParamVolumePtr(void);
 void kasHeaders(int ctype);
 char *kasParamTypeToC(int type);
 char *kasParamTypeToString(int type);
@@ -112,4 +115,8 @@
 void kasLStringValue(char *value);
 void kasLStringReference(char *name);
 
+char* stateHelpGet ();
+
+char* levelNameGet ();
+
 #endif
diff -urPw homeworld-orig/src/kas2c/lexer.l homeworld_sdl-0.3/src/kas2c/lexer.l
--- homeworld-orig/src/kas2c/lexer.l	2004-08-02 23:14:13.984559064 -0700
+++ homeworld_sdl-0.3/src/kas2c/lexer.l	2004-08-01 22:35:11.000000000 -0700
@@ -1,10 +1,11 @@
 %{
 
-#include "kas2c.h"
-#include "kas2c_tab.h"
-#include "types.h"
-#include <string.h>
 #include <stdio.h>
+#include <stdlib.h>
+#include <string.h>
+#include "kas2c.h"
+#include "parser.h"
+#include "Types.h"
 
 extern int lineNum;
 extern char curFilename[];
@@ -16,7 +17,7 @@
 
 ws      [ \t]+
 comment2 \/\/.*
-ppline  \#LINE[ \t]+[0-9]+[ \t]+.*
+ppline  \#[ \t]+[0-9]+[ \t]+.*
 qstring \"[^\"\n]*[\"\n]
 number  (0x[a-fA-F0-9]+)|([0-9]+)
 id      [a-zA-Z][a-zA-Z0-9]*
@@ -35,7 +36,7 @@
 
 {ws}        ;
 {comment2}  ;
-{ppline}    {   sscanf(yytext, "%*s %d %s", &lineNum, curFilename);
+{ppline}    {   sscanf(yytext, "# %d %s", &lineNum, curFilename);
             }
 {qstring}   {   yylval.string = strdup(yytext+1); /* skip open quote */
                 if (yylval.string[yyleng-2] != '"')
diff -urPw homeworld-orig/src/kas2c/parser.y homeworld_sdl-0.3/src/kas2c/parser.y
--- homeworld-orig/src/kas2c/parser.y	2004-08-02 23:14:13.995557392 -0700
+++ homeworld_sdl-0.3/src/kas2c/parser.y	2004-08-01 22:35:11.000000000 -0700
@@ -2,10 +2,17 @@
 
 #include <malloc.h>
 #include <stdio.h>
+#include <stdlib.h>
 #include <string.h>
-#include "types.h"
+#include <strings.h>
+#include <unistd.h>
+#include "Types.h"
 #include "kas2c.h"
 
+#ifdef _WIN32
+#define strcasecmp _stricmp
+#endif
+
 int parseLevel = LEVEL_LEVEL;
 
 int ifOnceIndex;  // up to 2^32 IFONCE statements per WATCH or INIT routine
@@ -242,11 +249,12 @@
 int lineNum = 1;
 char curFilename[256]; // current input filename
 char levelName[MAX_LEVEL_NAME_LENGTH+1]; // current input filename
-FILE *yyhout;
+FILE *yyhout, *yyfout;
+unsigned int functionCount;  // number of FSM functions
 
 int yyerror (char *s)
 {
-    if (!strcmpi(s, "parse error"))
+    if (!strcasecmp(s, "parse error"))
         fprintf(stderr, "%s(%d) error : at '%s', %s\n", curFilename, lineNum, yytext, stateHelpGet());
     else
         fprintf(stderr, "%s(%d) error : at '%s', %s (%s)\n", curFilename, lineNum, yytext, stateHelpGet(), s);
@@ -269,29 +277,33 @@
 
 main(int argc, char **argv)
 {
-    char infilename[256], outfilename[256], houtfilename[256];
+    char infilename[256], outfilename[256], houtfilename[256], foutfilename[256];
     char *shortinfilename, tempfilename[256];
     extern FILE *yyin, *yyout;
     int i;
 
-    if (argc >= 2 && !stricmp(argv[1], "-F"))
+    if (argc >= 2 && !strcasecmp(argv[1], "-F"))
     {
         kasHeaders(0);
         exit(1);
     }
-    else if (argc >= 2 && !stricmp(argv[1], "-FC"))
+    else if (argc >= 2 && !strcasecmp(argv[1], "-FC"))
     {
         kasHeaders(1);
         exit(1);
     }
-    else if (argc != 4)
+    else if (argc != 4 && argc != 5)
     {
         fprintf(stderr, "\nKAS2C Version %s\n", KAS2C_VERSION);
         fprintf(stderr, "Copyright (C) 1998 Relic Entertainment Inc.  All rights reserved.\n");
+        fprintf(stderr, "Modifications for Homeworld SDL by Ted Cipicchio <ted@thereisnospork.com>\n");
         fprintf(stderr, "\n Usage:\n\n");
-        fprintf(stderr, " KAS2C mission.kas mission.c mission.h   generate mission.c and mission.h\n");
-        fprintf(stderr, " KAS2C -f                                list function headers (english style)\n");
-        fprintf(stderr, " KAS2C -fc                               list function headers (C-style)\n");
+        fprintf(stderr, " KAS2C mission.kas mission.c mission.h [func.c]\n");
+        fprintf(stderr, " - generate mission.c and mission.h (and, optionally, func.c)\n");
+        fprintf(stderr, " KAS2C -f\n");
+        fprintf(stderr, " - list function headers (english style)\n");
+        fprintf(stderr, " KAS2C -fc\n");
+        fprintf(stderr, " - list function headers (C-style)\n");
         exit(1);
     }
 
@@ -301,6 +313,8 @@
 
     strcpy(houtfilename, argv[3]);
 
+    strcpy(foutfilename, (argc == 5 ? argv[4] : ""));
+
     if (!(yyin = fopen(infilename, "r")))
     {
         fprintf(stderr, "%s: can't open\n", infilename);
@@ -319,12 +333,18 @@
         exit(1);
     }
 
+    if (argc == 5 && !(yyfout = fopen(foutfilename, "w")))
+    {
+        fprintf(stderr, "%s: can't open\n", foutfilename);
+        exit(1);
+    }
+
     // hack off leading paths for display of infilename
     shortinfilename = infilename+strlen(infilename);
     while (shortinfilename > infilename)
     {
         --shortinfilename;
-        if (*shortinfilename == '\\')
+        if (*shortinfilename == '\\' || *shortinfilename == '/')
         {
             ++shortinfilename;
             break;
@@ -388,8 +408,8 @@
     fprintf(yyhout, "//  types and exposed game functions\n");
     fprintf(yyhout, "//\n");
     fprintf(yyhout, "#include <string.h>\n");
-    fprintf(yyhout, "#include \"types.h\"\n");
-    fprintf(yyhout, "#include \"vector.h\"\n");
+    fprintf(yyhout, "#include \"Types.h\"\n");
+    fprintf(yyhout, "#include \"Vector.h\"\n");
     fprintf(yyhout, "#include \"AITeam.h\"\n");
     fprintf(yyhout, "#include \"AIMoves.h\"\n");
     fprintf(yyhout, "#include \"CommandWrap.h\"\n");
@@ -399,27 +419,69 @@
     fprintf(yyhout, "#include \"Attributes.h\"\n");
     fprintf(yyhout, "#include \"TradeMgr.h\"\n");
 
+    // declarations of function list information
+    if (yyfout)
+    {
+        fprintf(yyhout, "\n\n");
+        fprintf(yyhout, "//\n");
+        fprintf(yyhout, "//  level function pointer list\n");
+        fprintf(yyhout, "//\n");
+        fprintf(yyhout, "extern const void* %s_FunctionPointers[];\n", levelName);
+        fprintf(yyhout, "extern const unsigned int %s_FunctionPointerCount;\n", levelName);
+    }
+
     fprintf(yyhout, "\n\n");
     fprintf(yyhout, "//\n");
     fprintf(yyhout, "//  FSM prototypes\n");
     fprintf(yyhout, "//\n");
 
+    if (yyfout)
+    {
+        fprintf(yyfout, "//\n");
+        fprintf(yyfout, "//  %s\n", foutfilename);
+        fprintf(yyfout, "//\n");
+        fprintf(yyfout, "//  Finite state machine function pointers for \"%s\" mission\n", levelName);
+        fprintf(yyfout, "//\n");
+        fprintf(yyfout, "//  This code was autogenerated from %s by KAS2C Version %s\n",
+            infilename, KAS2C_VERSION);
+        fprintf(yyfout, "//\n\n\n");
+        fprintf(yyfout, "#include \"%s\"  // prototypes and #includes for exposed game functions\n", houtfilename);
+        fprintf(yyfout, "\n");
+        fprintf(yyfout, "// FSM init/watch function pointers.\n");
+        fprintf(yyfout, "const void* %s_FunctionPointers[] =\n", levelName);
+        fprintf(yyfout, "{\n");
+    }
+
     ifOnceIndex = 0;  // reset counter for each source file parsed
 
+    functionCount = 0;  // number of FSM init/watch functions created
+
     // normal yyin and yyout interaction
     yyparse();
 
     fprintf(yyhout, "\n\n#endif\n");
 
+    if (yyfout)
+    {
+        fprintf(yyfout, "};\n");
+        fprintf(yyfout, "\n");
+        fprintf(yyfout, "// Number of FSM init/watch function pointers.\n");
+        fprintf(yyfout, "const unsigned int %s_FunctionPointerCount = %u;\n", levelName, functionCount);
+    }
+
     fclose(yyin);
     fclose(yyout);
     fclose(yyhout);
+    if (yyfout)
+        fclose(yyfout);
 
     // to be done: unlink output files on error?
     if (yynerrs)
     {
         unlink(outfilename);
         unlink(houtfilename);
+        if (foutfilename[0]);
+            unlink(foutfilename);
     }
 
 }
Only in homeworld-orig/src: OEMVersion.txt
Only in homeworld-orig/src/rgl: 3dfx
Only in homeworld-orig/src/rgl: asm
diff -urPw homeworld-orig/src/rgl/asm.c homeworld_sdl-0.3/src/rgl/asm.c
--- homeworld-orig/src/rgl/asm.c	2002-09-04 12:46:26.000000000 -0700
+++ homeworld_sdl-0.3/src/rgl/asm.c	2004-08-01 22:35:13.000000000 -0700
@@ -6,12 +6,24 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 //#define _MM_FUNCTIONALITY
 #include <xmmintrin.h>
+#include <string.h>
 #include "asm.h"
+#include "_stdint.h"
 
 #define XMM_VB_SIZE (((VB_SIZE + 3) & (~3)) / 4)
+#if defined (_MSC_VER)
 #define SELECT(i0,i1,i2,i3) (i0*64 + i1*16 + i2*4 + i3)
+#elif defined (__GNUC__) && defined (__i386__)
+    #define SELECT(i0,i1,i2,i3) "$(" #i0 "*64 + " #i1 "*16 + " #i2 "*4 + " #i3 ")"
+#endif
+
+#ifdef _MSC_VER
 
 _MM_ALIGN16 struct sInVerts
 {
@@ -28,19 +40,54 @@
     __m128 w[XMM_VB_SIZE];
 } sOutputVerts;
 
+#else
+
+struct sInVerts
+{
+    __m128 x[XMM_VB_SIZE];
+    __m128 y[XMM_VB_SIZE];
+    __m128 z[XMM_VB_SIZE];
+} sInputVerts __attribute__ ((aligned (16)));
+
+struct sOutVerts
+{
+    __m128 x[XMM_VB_SIZE];
+    __m128 y[XMM_VB_SIZE];
+    __m128 z[XMM_VB_SIZE];
+    __m128 w[XMM_VB_SIZE];
+} sOutputVerts __attribute__ ((aligned (16)));
+
+#endif
+
 void gl_intrin_project(GLfloat* dest, GLfloat* source, GLfloat* matrix, GLuint count);
 void gl_xmm_project(GLfloat* dest, GLfloat* source, GLfloat* matrix, GLuint count);
 
+#define FSIZE      4
+#define FSIZE_STR "4"
+#if defined (_MSC_VER)
+    #define FPTR    dword ptr
+
 #define S(x)   [esi + FSIZE*x]
 #define D(x)   [edi + FSIZE*x]
 #define M(n)   [edx + FSIZE*n]
 
-#define FPTR    dword ptr
-#define FSIZE   4
-
 #define SOURCE  esi
 #define DEST    ebx
 #define MATRIX  edi
+#elif defined (__GNUC__) && defined (__i386__)
+    #define FPTR
+
+    #define S(x)    "4*" #x "(%%esi)"
+    #define D(x)    "4*" #x "(%%edi)"
+    #define M(n)    "4*" #n "(%%edx)"
+
+    // Remember to change the source registers in
+    // gl_wicked_fast_normal_xform() and gl_fairly_fast_scaled_normal_xform()
+    // if you change these.
+    #define SOURCE  "%%esi"
+    #define DEST    "%%edx"
+    #define MATRIX  "%%edi"
+#endif
 
 #define MAGN_X(i) 	(~(((i) & 1) - 1))
 #define SIGN_X(i) 	(~((((i) >> 1) & 1) - 1))
@@ -103,6 +150,7 @@
 static int chkcpubit()
 {
     int rval;
+#if defined (_MSC_VER)
     _asm
     {
         pusha
@@ -141,6 +189,43 @@
 
         popa
     }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ (
+        "    pushfl\n"
+        "    popl %%eax\n"
+        "    testl $0x00200000, %%eax\n"
+        "    jz chkcpubit_set_21\n"
+        "    andl $0xffdfffff, %%eax\n"
+        "    pushl %%eax\n"
+        "    popfl\n"
+        "    pushfl\n"
+        "    popl %%eax\n"
+        "    testl $0x00200000, %%eax\n"
+        "    jz chkcpubit_cpu_id_ok\n"
+        "    jmp chkcpubit_err\n"
+
+        "chkcpubit_set_21:\n"
+        "    orl $0x00200000, %%eax\n"
+        "    pushl %%eax\n"
+        "    popfl\n"
+        "    pushfl\n"
+        "    popl %%eax\n"
+        "    testl $0x00200000, %%eax\n"
+        "    jnz chkcpubit_cpu_id_ok\n"
+
+        "chkcpubit_err:\n"
+        "    movl $0, %%eax\n"
+        "    jmp chkcpubit_exit\n"
+
+        "chkcpubit_cpu_id_ok:\n"
+        "    movl $1, %%eax\n"
+
+        "chkcpubit_exit:\n"
+        : "=a" (rval) );
+#else
+    #error chkcpubit(): Not implemented on this platform.
+    rval = 0;
+#endif
     return rval;
 }
 
@@ -157,6 +242,7 @@
     }
     else
     {
+#if defined (_MSC_VER)
         _asm
         {
             pusha
@@ -174,6 +260,18 @@
             popa
         }
         return ptype;
+#elif defined (__GNUC__) && defined (__i386__)
+        __asm__ __volatile__ (
+            "    pushl %%ebx\n"
+            "    movl $1, %%eax\n"
+            "    cpuid\n"
+            "    popl %%ebx\n"
+            : "=a" (cpu_eax), "=d" (cpu_edx)
+            :
+            : "ecx" );
+
+        return (cpu_eax & 0x0f00) >> 8;
+#endif
     }
 }
 
@@ -214,6 +312,7 @@
 
 void transform_points4_general(GLuint n, GLfloat* d, GLfloat* m, GLfloat* s)
 {
+#if defined (_MSC_VER)
     _asm
     {
         push esi
@@ -306,6 +405,90 @@
         pop edi
         pop esi
     }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ (
+        "    testl %%ecx, %%ecx\n"
+        "    jz trans4gen_two\n"
+
+        "    .align 16\n"
+
+        "trans4gen_one:\n"
+        "    flds " S(0) "\n"
+        "    fmuls " M(0) "\n"
+        "    flds " S(0) "\n"
+        "    fmuls " M(1) "\n"
+        "    flds " S(0) "\n"
+        "    fmuls " M(2) "\n"
+        "    flds " S(0) "\n"
+        "    fmuls " M(3) "\n"
+
+        "    flds " S(1) "\n"
+        "    fmuls " M(4) "\n"
+        "    flds " S(1) "\n"
+        "    fmuls " M(5) "\n"
+        "    flds " S(1) "\n"
+        "    fmuls " M(6) "\n"
+        "    flds " S(1) "\n"
+        "    fmuls " M(7) "\n"
+
+        "    fxch %%st(3)\n"
+        "    faddp %%st, %%st(7)\n"
+        "    fxch %%st(1)\n"
+        "    faddp %%st, %%st(5)\n"
+        "    faddp %%st, %%st(3)\n"
+        "    faddp %%st, %%st(1)\n"
+
+        "    flds " S(2) "\n"
+        "    fmuls " M(8) "\n"
+        "    flds " S(2) "\n"
+        "    fmuls " M(9) "\n"
+        "    flds " S(2) "\n"
+        "    fmuls " M(10) "\n"
+        "    flds " S(2) "\n"
+        "    fmuls " M(11) "\n"
+
+        "    fxch %%st(3)\n"
+        "    faddp %%st, %%st(7)\n"
+        "    fxch %%st(1)\n"
+        "    faddp %%st, %%st(5)\n"
+        "    faddp %%st, %%st(3)\n"
+        "    faddp %%st, %%st(1)\n"
+
+        "    flds " S(3) "\n"
+        "    fmuls " M(12) "\n"
+        "    flds " S(3) "\n"
+        "    fmuls " M(13) "\n"
+        "    flds " S(3) "\n"
+        "    fmuls " M(14) "\n"
+        "    flds " S(3) "\n"
+        "    fmuls " M(15) "\n"
+
+        "    fxch %%st(3)\n"
+        "    faddp %%st, %%st(7)\n"
+        "    fxch %%st(1)\n"
+        "    faddp %%st, %%st(5)\n"
+        "    faddp %%st, %%st(3)\n"
+
+        "    leal " S(4) ", %%esi\n"
+        "    decl %%ecx\n"
+
+        "    faddp %%st, %%st(1)\n"
+
+        "    fxch %%st(3)\n"
+        "    fstps " D(0) "\n"
+        "    fxch %%st(1)\n"
+        "    fstps " D(1) "\n"
+        "    fstps " D(2) "\n"
+        "    fstps " D(3) "\n"
+
+        "    leal " D(4) ", %%edi\n"
+
+        "    jnz trans4gen_one\n"
+
+        "trans4gen_two:\n"
+        :
+        : "c" (n), "D" (d), "d" (m), "S" (s) );
+#endif
 }
 
 void transform_points4_identity(GLuint n, GLfloat* d, GLfloat* m, GLfloat* s)
@@ -315,6 +498,7 @@
 
 void transform_points4_perspective(GLuint n, GLfloat* d, GLfloat* m, GLfloat* s)
 {
+#if defined (_MSC_VER)
     _asm
     {
         push esi
@@ -366,11 +550,56 @@
         pop edi
         pop esi
     }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ (
+        "    testl %%ecx, %%ecx\n"
+        "    jz trans4persp_two\n"
+
+        "    .align 16\n"
+
+        "trans4persp_one:\n"
+        "    flds " S(0) "\n"
+        "    fmuls " M(0) "\n"
+        "    flds " S(1) "\n"
+        "    fmuls " M(5) "\n"
+        "    flds " S(2) "\n"
+        "    fmuls " M(10) "\n"
+
+        "    flds " S(2) "\n"
+        "    fmuls " M(8) "\n"
+        "    flds " S(2) "\n"
+        "    fmuls " M(9) "\n"
+        "    flds " S(3) "\n"
+        "    fmuls " M(14) "\n"
+
+        "    movl " S(2) ", %%eax\n"
+        "    leal " S(4) ", %%esi\n"
+        "    xorl $0x80000000, %%eax\n"
+        "    decl %%ecx\n"
+
+        "    faddp %%st, %%st(3)\n"
+        "    faddp %%st, %%st(3)\n"
+        "    faddp %%st, %%st(3)\n"
+
+        "    fstps " D(2) "\n"
+        "    fstps " D(1) "\n"
+        "    fstps " D(0) "\n"
+
+        "    movl %%eax, " D(3) "\n"
+        "    leal " D(4) ", %%edi\n"
+        "    jnz trans4persp_one\n"
+
+        "trans4persp_two:\n"
+        :
+        : "c" (n), "D" (d), "d" (m), "S" (s)
+        : "eax" );
+#endif
 }
 
 void asm_cliptest(
     GLuint n, GLfloat* d, GLubyte* clipmask, GLubyte* ormask, GLubyte* andmask)
 {
+#if defined (_MSC_VER)
     _asm
     {
         push esi
@@ -454,6 +683,102 @@
         pop edi
         pop esi
     }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ (
+        "    movl %0, %%edi\n"
+        "    movl %1, %%esi\n"
+        "    movb (%%edi), %%al\n"
+        "    movb (%%esi), %%ah\n"
+
+        "    movl %2, %%ecx\n"
+        "    movl %3, %%edi\n"
+        "    movl %4, %%esi\n"
+
+#ifdef PIC  /* Needed since we use ebx for calculations. */
+        "    movl %5, %%edx\n"
+#endif
+
+        //cliptest
+        "    testl %%ecx, %%ecx\n"
+        "    jz cliptest_two\n"
+
+        "    pushl %%ebp\n"
+        "    pushl %%ebx\n"
+#ifdef PIC  /* Keep track of clip_table. */
+        "    pushl %%edx\n"
+#endif
+
+        "    .align 16\n"
+
+        "cliptest_one:\n"
+        "    movl " S(3) ", %%ebp\n"
+        "    movl " S(2) ", %%ebx\n"
+
+        "    xorl %%edx, %%edx\n"
+        "    addl %%ebp, %%ebp\n"
+
+        "    adcl %%edx, %%edx\n"
+        "    addl %%ebx, %%ebx\n"
+
+        "    adcl %%edx, %%edx\n"
+        "    cmpl %%ebx, %%ebp\n"
+
+        "    adcl %%edx, %%edx\n"
+        "    movl " S(1) ", %%ebx\n"
+
+        "    addl %%ebx, %%ebx\n"
+
+        "    adcl %%edx, %%edx\n"
+        "    cmpl %%ebx, %%ebp\n"
+
+        "    adcl %%edx, %%edx\n"
+        "    movl " S(0) ", %%ebx\n"
+
+        "    addl %%ebx, %%ebx\n"
+
+        "    adcl %%edx, %%edx\n"
+        "    cmpl %%ebx, %%ebp\n"
+
+        "    adcl %%edx, %%edx\n"
+
+        "    leal " S(4) ", %%esi\n"
+        "    movb (%%edi), %%bl\n"
+#ifdef PIC
+        "    movl (%%esp), %%ebp\n"
+        "    movb (%%edx, %%ebp), %%dl\n"
+#else
+        "    movb %5(%%edx), %%dl\n"
+#endif
+
+        "    orb %%dl, %%bl\n"
+        "    orb %%dl, %%al\n"
+
+        "    andb %%dl, %%ah\n"
+        "    movb %%bl, (%%edi)\n"
+
+        "    incl %%edi\n"
+        "    decl %%ecx\n"
+
+        "    jnz cliptest_one\n"
+
+#ifdef PIC
+        "    popl %%edx\n"
+#endif
+        "    popl %%ebx\n"
+        "    popl %%ebp\n"
+
+        "cliptest_two:\n"
+        //cliptest
+
+        "    movl %0, %%edi\n"
+        "    movl %1, %%esi\n"
+        "    movb %%al, (%%edi)\n"
+        "    movb %%ah, (%%esi)\n"
+        :
+        : "m" (ormask), "m" (andmask), "m" (n), "m" (clipmask), "m" (d),
+          "m" (clip_table)
+        : "eax", "ecx", "edx", "edi", "esi" );
+#endif
 }
 
 void asm_project_and_cliptest_general(
@@ -485,7 +810,12 @@
     float x, y, z, w;
 } hvector;
 
+#if defined (_MSC_VER)
 static _MM_ALIGN16 __m128 mat[16], per[16];
+#else
+static __m128 mat[16] __attribute__ ((aligned (16))),
+              per[16] __attribute__ ((aligned (16)));
+#endif
 
 void intrin_project_and_cliptest_perspective(
     GLuint n, GLfloat* d, GLfloat* m, GLfloat* s,
@@ -511,6 +841,7 @@
     m0 = m;
     mat0 = (float*)mat;
 
+#if defined (_MSC_VER)
     _asm
     {
         push    esi
@@ -560,6 +891,48 @@
         pop     edi
         pop     esi
     }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ (
+        "    movss   4*0(%%esi), %%xmm0\n"
+        "    movss   4*1(%%esi), %%xmm1\n"
+        "    shufps  $0x00, %%xmm0, %%xmm0\n"
+        "    movss   4*2(%%esi), %%xmm2\n"
+        "    shufps  $0x00, %%xmm1, %%xmm1\n"
+        "    movaps  %%xmm0, 4*4*0(%%edi)\n"
+        "    movss   4*4(%%esi), %%xmm3\n"
+        "    shufps  $0x00, %%xmm2, %%xmm2\n"
+        "    movaps  %%xmm1, 4*4*1(%%edi)\n"
+        "    movss   4*5(%%esi), %%xmm4\n"
+        "    shufps  $0x00, %%xmm3, %%xmm3\n"
+        "    movaps  %%xmm2, 4*4*2(%%edi)\n"
+        "    movss   4*6(%%esi), %%xmm5\n"
+        "    shufps  $0x00, %%xmm4, %%xmm4\n"
+        "    movaps  %%xmm3, 4*4*4(%%edi)\n"
+        "    movss   4*8(%%esi), %%xmm6\n"
+        "    shufps  $0x00, %%xmm5, %%xmm5\n"
+        "    movaps  %%xmm4, 4*4*5(%%edi)\n"
+        "    movss   4*9(%%esi), %%xmm7\n"
+        "    shufps  $0x00, %%xmm6, %%xmm6\n"
+        "    movaps  %%xmm5, 4*4*6(%%edi)\n"
+        "    shufps  $0x00, %%xmm7, %%xmm7\n"
+        "    movaps  %%xmm6, 4*4*8(%%edi)\n"
+        "    movaps  %%xmm7, 4*4*9(%%edi)\n"
+
+        "    movss   4*10(%%esi), %%xmm0\n"
+        "    movss   4*12(%%esi), %%xmm1\n"
+        "    shufps  $0x00, %%xmm0, %%xmm0\n"
+        "    movss   4*13(%%esi), %%xmm2\n"
+        "    shufps  $0x00, %%xmm1, %%xmm1\n"
+        "    movaps  %%xmm0, 4*4*10(%%edi)\n"
+        "    movss   4*14(%%esi), %%xmm3\n"
+        "    shufps  $0x00, %%xmm2, %%xmm2\n"
+        "    movaps  %%xmm1, 4*4*12(%%edi)\n"
+        "    shufps  $0x00, %%xmm3, %%xmm3\n"
+        "    movaps  %%xmm2, 4*4*13(%%edi)\n"
+        "    movaps  %%xmm3, 4*4*14(%%edi)\n"
+        :
+        : "S" (m0), "D" (mat0) );
+#endif
 }
 
 void xmm_set_projection(GLfloat* m)
@@ -570,6 +943,7 @@
     m1 = m;
     mat1 = (float*)per;
 
+#if defined (_MSC_VER)
     _asm
     {
         push    eax
@@ -600,6 +974,29 @@
         pop     edx
         pop     eax
     }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ (
+        "    movss   4*0(%%eax), %%xmm0\n"
+        "    movss   4*5(%%eax), %%xmm1\n"
+        "    shufps  $0x00, %%xmm0, %%xmm0\n"
+        "    movss   4*8(%%eax), %%xmm2\n"
+        "    shufps  $0x00, %%xmm1, %%xmm1\n"
+        "    movaps  %%xmm0, 4*4*0(%%edx)\n"
+        "    movss   4*9(%%eax), %%xmm3\n"
+        "    shufps  $0x00, %%xmm2, %%xmm2\n"
+        "    movaps  %%xmm1, 4*4*5(%%edx)\n"
+        "    movss   4*10(%%eax), %%xmm4\n"
+        "    shufps  $0x00, %%xmm3, %%xmm3\n"
+        "    movaps  %%xmm2, 4*4*8(%%edx)\n"
+        "    movss   4*14(%%eax), %%xmm5\n"
+        "    shufps  $0x00, %%xmm4, %%xmm4\n"
+        "    movaps  %%xmm3, 4*4*9(%%edx)\n"
+        "    shufps  $0x00, %%xmm5, %%xmm5\n"
+        "    movaps  %%xmm4, 4*4*10(%%edx)\n"
+        "    movaps  %%xmm5, 4*4*14(%%edx)\n"
+        :
+        : "a" (m1), "d" (mat1) );
+#endif
 }
 
 void xmm_update_modelview(GLcontext* ctx) {}
@@ -607,9 +1004,16 @@
 
 void gl_xmm_3dtransform(GLfloat* dest, GLfloat* source, GLfloat* matrix, GLuint count)
 {
+#if defined (_MSC_VER)
     static _MM_ALIGN16 int n;
     static _MM_ALIGN16 __m128 One, nextX;
     static _MM_ALIGN16 float* m;
+#else
+    static int n __attribute__ ((aligned (16)));
+    static __m128 One   __attribute__ ((aligned (16))),
+                  nextX __attribute__ ((aligned (16)));
+    static float* m __attribute__ ((aligned (16)));
+#endif
 
     n = (count + 3) & (~3);
 
@@ -618,6 +1022,7 @@
 
     xmm_set_modelview(matrix);
 
+#if defined (_MSC_VER)
     _asm
     {
         push    esi
@@ -713,6 +1118,96 @@
 
         pop     esi
     }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ (
+        "    shll $4, %%ecx\n"
+
+        "xmm3dtrans_start:\n"
+        "    subl $64, %%ecx\n"
+
+        //swizzle
+        "    movups   0(%%eax, %%ecx), %%xmm7\n"
+        "    movups  16(%%eax, %%ecx), %%xmm2\n"
+        "    movups  32(%%eax, %%ecx), %%xmm4\n"
+        "    movups  48(%%eax, %%ecx), %%xmm3\n"
+        "    prefetchnta -64(%%eax, %%ecx)\n"
+        "    movaps  %%xmm7, %%xmm6\n"
+        "    movaps  %%xmm4, %%xmm5\n"
+        "    unpcklps %%xmm2, %%xmm6\n"
+        "    unpcklps %%xmm3, %%xmm5\n"
+        "    movaps  %%xmm6, %%xmm0\n"
+        "    prefetchnta 16-64(%%eax, %%ecx)\n"
+        "    shufps  " SELECT(1,0,1,0) ", %%xmm5, %%xmm0\n" //xxxx in xmm0
+        "    shufps  " SELECT(3,2,3,2) ", %%xmm5, %%xmm6\n" //yyyy in xmm6
+        "    unpckhps %%xmm2, %%xmm7\n"
+        "    prefetchnta 32-64(%%eax, %%ecx)\n"
+        "    unpckhps %%xmm3, %%xmm4\n"
+
+        //transform
+        "    movaps  4*4*0(%%esi), %%xmm3\n"
+        "    movaps  4*4*4(%%esi), %%xmm1\n"
+        "    mulps   %%xmm0, %%xmm3\n"          //x*m0 in xmm3
+        "    prefetchnta 48-64(%%eax, %%ecx)\n"
+        "    shufps  " SELECT(1,0,1,0) ", %%xmm4, %%xmm7\n" //zzzz in xmm7
+        "    mulps   %%xmm6, %%xmm1\n"          //y*m4 in xmm1
+        "    movaps  4*4*8(%%esi), %%xmm4\n"
+        "    movaps  4*4*12(%%esi), %%xmm5\n"
+        "    mulps   %%xmm7, %%xmm4\n"          //z*m8 in xmm4
+        "    addps   %%xmm3, %%xmm1\n"          //x*m0 + y*m4 in xmm1
+        "    addps   %%xmm5, %%xmm4\n"          //z*m8 + m12 in xmm4
+        "    addps   %%xmm4, %%xmm1\n"          //x*m0 + y*m4 + z*m8 + m12 in xmm1
+        "    movaps  %%xmm1, %5\n"
+
+        "    movaps  4*4*1(%%esi), %%xmm3\n"
+        "    movaps  4*4*5(%%esi), %%xmm2\n"
+        "    mulps   %%xmm0, %%xmm3\n"          //x*m1 in xmm3
+        "    mulps   %%xmm6, %%xmm2\n"          //y*m5 in xmm2
+        "    movaps  4*4*9(%%esi), %%xmm4\n"
+        "    movaps  4*4*13(%%esi), %%xmm5\n"
+        "    mulps   %%xmm7, %%xmm4\n"          //z*m9 in xmm4
+        "    addps   %%xmm3, %%xmm2\n"          //x*m1 + y*m5 in xmm2
+        "    addps   %%xmm5, %%xmm4\n"          //z*m9 + m13 in xmm4
+        "    movaps  4*4*2(%%esi), %%xmm3\n"   //...
+        "    addps   %%xmm2, %%xmm4\n"          //x*m1 + y*m5 + z*m9 + m13 in xmm4
+
+        "    movaps  4*4*6(%%esi), %%xmm1\n"
+        "    mulps   %%xmm0, %%xmm3\n"          //x*m2 in xmm3
+        "    mulps   %%xmm6, %%xmm1\n"          //y*m6 in xmm1
+        "    movaps  4*4*10(%%esi), %%xmm2\n"
+        "    movaps  4*4*14(%%esi), %%xmm5\n"
+        "    mulps   %%xmm7, %%xmm2\n"          //z*m10 in xmm4
+        "    addps   %%xmm3, %%xmm1\n"          //x*m2 + y*m6 in xmm1
+        "    addps   %%xmm5, %%xmm2\n"          //z*m10 + m14 in xmm4
+        "    addps   %%xmm2, %%xmm1\n"          //x*m2 + y*m6 + z*m10 + m14 in xmm1
+
+        //swizzle
+        "    movaps  %5, %%xmm2\n"              //x
+        "    movaps  %%xmm1, %%xmm6\n"          //z
+        "    movaps  %4, %%xmm3\n"              //w
+        "    movaps  %%xmm2, %%xmm0\n"
+        "    unpcklps %%xmm4, %%xmm0\n"                 //y1,x1,y0,x0
+        "    movaps  %%xmm0, %%xmm1\n"
+        "    movaps  %%xmm6, %%xmm5\n"
+        "    unpcklps %%xmm3, %%xmm5\n"                 //w1,z1,w0,z0
+        "    shufps  " SELECT(1,0,1,0) ", %%xmm5, %%xmm1\n" //w0,z0,y0,x0
+        "    movups  %%xmm1, (%%edx, %%ecx)\n"
+        "    shufps  " SELECT(3,2,3,2) ", %%xmm5, %%xmm0\n" //w1,z1,y1,x1
+        "    movups  %%xmm0, 16(%%edx, %%ecx)\n"
+        "    movaps  %%xmm2, %%xmm0\n"
+        "    unpckhps %%xmm4, %%xmm0\n"                 //y3,x3,y2,x2
+        "    movaps  %%xmm0, %%xmm1\n"
+        "    movaps  %%xmm6, %%xmm5\n"
+        "    unpckhps %%xmm3, %%xmm5\n"                 //w3,z3,w2,z2
+        "    shufps  " SELECT(1,0,1,0) ", %%xmm5, %%xmm1\n" //w2,z2,y2,x2
+        "    movups  %%xmm1, 32(%%edx, %%ecx)\n"
+        "    shufps  " SELECT(3,2,3,2) ", %%xmm5, %%xmm0\n" //w3,z3,y3,x3
+        "    movups  %%xmm0, 48(%%edx, %%ecx)\n"
+
+        "    jnz     xmm3dtrans_start\n"
+        :
+        : "S" (m), "c" (n), "a" (source), "d" (dest),
+          "m" (One), "m" (nextX) );
+#endif
 }
 
 void gl_intrin_3dtransform(GLfloat* dest, GLfloat* source, GLfloat* matrix, GLuint count)
@@ -722,8 +1217,15 @@
     hvector* dp;
     float* xp;
 
+#if defined (_MSC_VER)
     _MM_ALIGN16 __m128 curX, curY, curZ;
     _MM_ALIGN16 __m128 out[4];
+#else
+    __m128 curX __attribute__ ((aligned (16))),
+           curY __attribute__ ((aligned (16))),
+           curZ __attribute__ ((aligned (16)));
+    __m128 out[4] __attribute__ ((aligned (16)));
+#endif
 
     count = ((count + 3) & (~3)) >> 2;
 
@@ -770,13 +1272,24 @@
     }
 }
 
+#if defined (_MSC_VER)
 static _MM_ALIGN16 int Mask[4] = {0x80000000,0x80000000,0x80000000,0x80000000};
+#else
+static int Mask[4] __attribute__ ((aligned (16))) =
+    {0x80000000,0x80000000,0x80000000,0x80000000};
+#endif
 
 void gl_xmm_project(GLfloat* dest, GLfloat* source, GLfloat* matrix, GLuint count)
 {
+#if defined (_MSC_VER)
     static _MM_ALIGN16 int n;
     static _MM_ALIGN16 __m128 Zero;
     static _MM_ALIGN16 float* m;
+#else
+    static int n __attribute__ ((aligned (16)));
+    static __m128 Zero __attribute__ ((aligned (16)));
+    static float* m __attribute__ ((aligned (16)));
+#endif
 
     n = (count + 3) & (~3);
 
@@ -785,6 +1298,7 @@
 
     xmm_set_projection(matrix);
 
+#if defined (_MSC_VER)
     _asm
     {
         push    esi
@@ -864,6 +1378,80 @@
 
         pop     esi
     }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ (
+        "    shll     $4, %%ecx\n"
+
+        "xmmproject_start:\n"
+        "    subl     $64, %%ecx\n"
+
+        //swizzle
+        "    movups  (%%eax, %%ecx), %%xmm7\n"
+        "    movups  16(%%eax, %%ecx), %%xmm2\n"
+        "    movups  32(%%eax, %%ecx), %%xmm4\n"
+        "    movups  48(%%eax, %%ecx), %%xmm3\n"
+        "    prefetchnta -64(%%eax, %%ecx)\n"
+        "    movaps  %%xmm7, %%xmm6\n"
+        "    movaps  %%xmm4, %%xmm5\n"
+        "    unpcklps %%xmm2, %%xmm6\n"
+        "    unpcklps %%xmm3, %%xmm5\n"
+        "    movaps  %%xmm6, %%xmm0\n"
+        "    prefetchnta 16-64(%%eax, %%ecx)\n"
+        "    shufps  " SELECT(1,0,1,0) ", %%xmm5, %%xmm0\n" //xxxx in xmm0
+        "    shufps  " SELECT(3,2,3,2) ", %%xmm5, %%xmm6\n" //yyyy in xmm6
+        "    unpckhps %%xmm2, %%xmm7\n"
+        "    prefetchnta 32-64(%%eax, %%ecx)\n"
+        "    unpckhps %%xmm3, %%xmm4\n"
+
+        //project
+        "    movaps  4*4*0(%%esi), %%xmm3\n"
+        "    movaps  4*4*8(%%esi), %%xmm2\n"
+        "    shufps  " SELECT(1,0,1,0) ", %%xmm4, %%xmm7\n" //zzzz in xmm7
+        "    prefetchnta 48-64(%%eax, %%ecx)\n"
+        "    mulps   %%xmm0, %%xmm3\n"                  //x*p0 in xmm3
+        "    mulps   %%xmm7, %%xmm2\n"                  //z*p8 in xmm2
+        "    movaps  4*4*5(%%esi), %%xmm5\n"            //...
+        "    addps   %%xmm3, %%xmm2\n"                  //x*p0 + z*p8 in xmm2
+
+        "    movaps  4*4*9(%%esi), %%xmm4\n"
+        "    mulps   %%xmm6, %%xmm5\n"                  //y*p5 in xmm5
+        "    mulps   %%xmm7, %%xmm4\n"                  //z*p8 in xmm2
+        "    movaps  4*4*10(%%esi), %%xmm3\n"           //...
+        "    addps   %%xmm5, %%xmm4\n"                  //x*p0 + z*p8 in xmm2
+
+        "    movaps  4*4*14(%%esi), %%xmm6\n"
+        "    mulps   %%xmm7, %%xmm3\n"                  //z*p10 in xmm3
+        "    movaps  %%xmm7, %%xmm1\n"                  //...
+        "    addps   %%xmm3, %%xmm6\n"                  //z*p10 + p14 in xmm6
+
+        "    xorps   %4, %%xmm1\n"
+        "    movaps  %%xmm2, %%xmm0\n"                  //...
+        "    movaps  %%xmm1, %%xmm3\n"                  //-z in xmm3
+
+        //swizzle
+        "    unpcklps %%xmm4, %%xmm0\n"                 //y1,x1,y0,x0
+        "    movaps  %%xmm0, %%xmm1\n"
+        "    movaps  %%xmm6, %%xmm5\n"
+        "    unpcklps %%xmm3, %%xmm5\n"                 //w1,z1,w0,z0
+        "    shufps  " SELECT(1,0,1,0) ", %%xmm5, %%xmm1\n" //w0,z0,y0,x0
+        "    movups  %%xmm1, (%%edx, %%ecx)\n"
+        "    shufps  " SELECT(3,2,3,2) ", %%xmm5, %%xmm0\n" //w1,z1,y1,x1
+        "    movups  %%xmm0, 16(%%edx, %%ecx)\n"
+        "    movaps  %%xmm2, %%xmm0\n"
+        "    unpckhps %%xmm4, %%xmm0\n"                 //y3,x3,y2,x2
+        "    movaps  %%xmm0, %%xmm1\n"
+        "    movaps  %%xmm6, %%xmm5\n"
+        "    unpckhps %%xmm3, %%xmm5\n"                 //w3,z3,w2,z2
+        "    shufps  " SELECT(1,0,1,0) ", %%xmm5, %%xmm1\n" //w2,z2,y2,x2
+        "    movups  %%xmm1, 32(%%edx, %%ecx)\n"
+        "    shufps  " SELECT(3,2,3,2) ", %%xmm5, %%xmm0\n" //w3,z3,y3,x3
+        "    movups  %%xmm0, 48(%%edx, %%ecx)\n"
+
+        "    jnz     xmmproject_start\n"
+        :
+        : "S" (m), "c" (n), "a" (source), "d" (dest),
+          "m" (Mask) );
+#endif
 }
 
 void gl_intrin_project(GLfloat* dest, GLfloat* source, GLfloat* matrix, GLuint count)
@@ -873,9 +1461,17 @@
     hvector* dp;
     float* xp;
 
+#if defined (_MSC_VER)
     _MM_ALIGN16 __m128 curX, curY, curZ;
     _MM_ALIGN16 __m128 out[4];
     _MM_ALIGN16 int mask[4];
+#else
+    __m128 curX __attribute__ ((aligned (16))),
+           curY __attribute__ ((aligned (16))),
+           curZ __attribute__ ((aligned (16)));
+    __m128 out[4] __attribute__ ((aligned (16)));
+    int mask[4] __attribute__ ((aligned (16)));
+#endif
 
     mask[0] = mask[1] = mask[2] = mask[3] = 0x80000000;
 
@@ -920,6 +1516,8 @@
         GLfloat* dest, GLfloat* source, GLfloat* matrix, GLuint count)
 {
     GLfloat floatOne = 1.0f;
+
+#if defined (_MSC_VER)
     _asm
     {
         mov ecx, count
@@ -985,6 +1583,71 @@
         add     ecx, 4*FSIZE
         jnz     MEGA0
     }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ (
+        "    shll $4, %%ecx\n"
+        "    addl %%ecx, %%esi\n"
+        "    addl %%ecx, %%eax\n"
+
+        "    negl %%ecx\n"
+
+        "    cmpl $0, %%ecx\n"
+        "    je MEGA1\n"  /* ... */
+
+        "MEGA0:\n"
+        "    flds    0*"FSIZE_STR"(%%esi, %%ecx)\n"
+        "    fmuls   (0*4+0)*"FSIZE_STR"(%%edi)\n"
+        "    flds    1*"FSIZE_STR"(%%esi, %%ecx)\n"
+        "    fmuls   (1*4+0)*"FSIZE_STR"(%%edi)\n"
+        "    flds    2*"FSIZE_STR"(%%esi, %%ecx)\n"
+        "    fmuls   (2*4+0)*"FSIZE_STR"(%%edi)\n"
+        "    fxch    %%st(1)\n"
+        "    faddp   %%st, %%st(2)\n"
+        "    flds    0*"FSIZE_STR"(%%esi, %%ecx)\n"
+        "    fmuls   (0*4+1)*"FSIZE_STR"(%%edi)\n"
+        "    fxch    %%st(1)\n"
+        "    faddp   %%st, %%st(2)\n"
+        "    flds    1*"FSIZE_STR"(%%esi, %%ecx)\n"
+        "    fmuls   (1*4+1)*"FSIZE_STR"(%%edi)\n"
+        "    flds    2*"FSIZE_STR"(%%esi, %%ecx)\n"
+        "    fmuls   (2*4+1)*"FSIZE_STR"(%%edi)\n"
+        "    fxch    %%st(1)\n"
+        "    faddp   %%st, %%st(2)\n"
+        "    flds    0*"FSIZE_STR"(%%esi, %%ecx)\n"
+        "    fmuls   (0*4+2)*"FSIZE_STR"(%%edi)\n"
+        "    fxch    %%st(1)\n"
+        "    faddp   %%st, %%st(2)\n"
+        "    flds    1*"FSIZE_STR"(%%esi, %%ecx)\n"
+        "    fmuls   (1*4+2)*"FSIZE_STR"(%%edi)\n"
+        "    flds    2*"FSIZE_STR"(%%esi, %%ecx)\n"
+        "    fmuls   (2*4+2)*"FSIZE_STR"(%%edi)\n"
+        "    fxch    %%st(1)\n"
+        "    faddp   %%st, %%st(2)\n"
+        "    fxch    %%st(3)\n"
+        "    faddl   (3*4+0)*"FSIZE_STR"(%%edi)\n"
+        "    fxch    %%st(1)\n"
+        "    faddp   %%st, %%st(3)\n"
+        "    fxch    %%st(1)\n"
+        "    faddl   (3*4+1)*"FSIZE_STR"(%%edi)\n"
+        "    fxch    %%st(2)\n"
+        "    faddl   (3*4+2)*"FSIZE_STR"(%%edi)\n"
+        "    fxch    %%st(1)\n"
+        "    fstps   0*"FSIZE_STR"(%%eax, %%ecx)\n"
+        "    fxch    %%st(1)\n"
+        "    fstps   1*"FSIZE_STR"(%%eax, %%ecx)\n"
+        "    fstps   2*"FSIZE_STR"(%%eax, %%ecx)\n"
+
+        "    flds    %4\n"
+        "    fstps   3*"FSIZE_STR"(%%eax, %%ecx)\n"
+
+        "    addl    $(4*"FSIZE_STR"), %%ecx\n"
+        "    jnz     MEGA0\n"
+
+        "MEGA1:\n"
+        :
+        : "c" (count), "S" (source), "a" (dest), "D" (matrix),
+          "m" (floatOne) );
+#endif
 }
 
 /*
@@ -994,6 +1657,7 @@
 void gl_wicked_fast_normal_xform(
         GLfloat* dest, GLfloat* source, GLfloat* matrix, GLuint n)
 {
+#if defined (_MSC_VER)
     _asm
     {
         push esi
@@ -1060,6 +1724,61 @@
         pop edi
         pop esi
     }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ (
+        "    imull $(3*"FSIZE_STR"), %%ecx, %%ecx\n"
+        "    addl %%ecx, "SOURCE"\n"
+        "    addl %%ecx, "DEST"\n"
+
+        "    negl %%ecx\n"
+
+        "normxform_WICK0:\n"
+        "    flds    0*"FSIZE_STR"("SOURCE",%%ecx)\n"
+        "    fmuls   0*"FSIZE_STR"("MATRIX")\n"
+        "    flds    1*"FSIZE_STR"("SOURCE",%%ecx)\n"
+        "    fmuls   1*"FSIZE_STR"("MATRIX")\n"
+        "    flds    2*"FSIZE_STR"("SOURCE",%%ecx)\n"
+        "    fmuls   2*"FSIZE_STR"("MATRIX")\n"
+        "    fxch    %%st(1)\n"
+        "    faddp   %%st, %%st(2)\n"
+
+        "    flds    0*"FSIZE_STR"("SOURCE",%%ecx)\n"
+        "    fmuls   4*"FSIZE_STR"("MATRIX")\n"
+        "    fxch    %%st(1)\n"
+        "    faddp   %%st, %%st(2)\n"
+
+        "    flds    1*"FSIZE_STR"("SOURCE",%%ecx)\n"
+        "    fmuls   5*"FSIZE_STR"("MATRIX")\n"
+        "    flds    2*"FSIZE_STR"("SOURCE",%%ecx)\n"
+        "    fmuls   6*"FSIZE_STR"("MATRIX")\n"
+        "    fxch    %%st(1)\n"
+        "    faddp   %%st, %%st(1)\n"
+
+        "    flds    0*"FSIZE_STR"("SOURCE",%%ecx)\n"
+        "    fmuls   8*"FSIZE_STR"("MATRIX")\n"
+        "    fxch    %%st(1)\n"
+        "    faddp   %%st, %%st(2)\n"
+
+        "    flds    1*"FSIZE_STR"("SOURCE",%%ecx)\n"
+        "    fmuls   9*"FSIZE_STR"("MATRIX")\n"
+        "    flds    2*"FSIZE_STR"("SOURCE",%%ecx)\n"
+        "    fmuls   10*"FSIZE_STR"("MATRIX")\n"
+        "    fxch    %%st(1)\n"
+        "    faddp   %%st, %%st(1)\n"
+
+        "    fxch    %%st(2)\n"
+        "    fstps   1*"FSIZE_STR"("DEST",%%ecx)\n"
+        "    fxch    %%st(1)\n"
+        "    faddp   %%st, %%st(1)\n"
+        "    fxch    %%st(1)\n"
+        "    fstps   0*"FSIZE_STR"("DEST",%%ecx)\n"
+        "    fstps   2*"FSIZE_STR"("DEST",%%ecx)\n"
+
+        "    addl $(3*"FSIZE_STR"), %%ecx\n"
+        "    jnz normxform_WICK0\n"
+        :
+        : "c" (n), "S" (source), "d" (dest), "D" (matrix) );
+#endif
 }
 
 /*
@@ -1068,6 +1787,7 @@
 void gl_fairly_fast_scaled_normal_xform(
         GLfloat* dest, GLfloat* source, GLfloat* matrix, GLuint n, GLfloat scale)
 {
+#if defined (_MSC_VER)
     _asm
     {
         push esi
@@ -1137,6 +1857,64 @@
         pop edi
         pop esi
     }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ (
+        "    imull $(3*"FSIZE_STR"), %%ecx, %%ecx\n"
+        "    addl  "SOURCE", %%ecx\n"
+        "    addl  "DEST", %%ecx\n"
+
+        "    negl  %%ecx\n"
+
+        "snormxform_WICK0:\n"
+        "    flds    0*"FSIZE_STR"("SOURCE",%%ecx)\n"     //s0
+        "    fmuls   0*"FSIZE_STR"("MATRIX")\n"           //M0
+        "    flds    1*"FSIZE_STR"("SOURCE",%%ecx)\n"     //s1 M0
+        "    fmuls   1*"FSIZE_STR"("MATRIX")\n"           //M1 M0
+        "    flds    2*"FSIZE_STR"("SOURCE",%%ecx)\n"     //s2 M1 M0
+        "    fmuls   2*"FSIZE_STR"("MATRIX")\n"           //M2 M1 M0
+        "    fxch    %%st(1)\n"                           //M1 M2 M0
+        "    faddp   %%st, %%st(2)\n"                     //M2 M1+M0
+
+        "    flds    0*"FSIZE_STR"("SOURCE",%%ecx)\n"     //s0 M2 M1+M0
+        "    fmuls   4*"FSIZE_STR"("MATRIX")\n"           //M4 M2 M1+M0
+        "    fxch    %%st(1)\n"                           //M2 M4 M1+M0
+        "    faddp   %%st, %%st(2)\n"                     //M4 R0
+
+        "    flds    1*"FSIZE_STR"("SOURCE",%%ecx)\n"     //s1 M4 R0
+        "    fmuls   5*"FSIZE_STR"("MATRIX")\n"           //M5 M4 R0
+        "    flds    2*"FSIZE_STR"("SOURCE",%%ecx)\n"     //s2 M5 M4 R0
+        "    fmuls   6*"FSIZE_STR"("MATRIX")\n"           //M6 M5 M4 R0
+        "    fxch    %%st(1)\n"                           //M5 M6 M4 R0
+        "    faddp   %%st, %%st(1)\n"                     //M5+M6 M4 R0
+
+        "    flds    0*"FSIZE_STR"("SOURCE",%%ecx)\n"     //s0 M5+M6 M4 R0
+        "    fmuls   8*"FSIZE_STR"("MATRIX")\n"           //M8 M5+M6 M4 R0
+        "    fxch    %%st(1)\n"                           //M5+M6 M8 M4 R0
+        "    faddp   %%st, %%st(2)\n"                     //M8 R1 R0
+
+        "    flds    1*"FSIZE_STR"("SOURCE",%%ecx)\n"     //s1 M8 R1 R0
+        "    fmuls   9*"FSIZE_STR"("MATRIX")\n"           //M9 M8 R1 R0
+        "    flds    2*"FSIZE_STR"("SOURCE",%%ecx)\n"     //s2 M9 M8 R1 R0
+        "    fmuls   10*"FSIZE_STR"("MATRIX")\n"          //M10 M9 M8 R1 R0
+        "    fxch    %%st(1)\n"                           //M9 M10 M8 R1 R0
+        "    faddp   %%st, %%st(1)\n"                     //M9+M10 M8 R1 R0
+
+        "    fxch    %%st(2)\n"                           //R1 M8 M9+M10 R0
+        "    fmuls   %4\n"
+        "    fstps   1*"FSIZE_STR"("DEST",%%ecx)\n"       //M8 M9+M10 R0
+        "    fxch    %%st(1)\n"                           //M9+M10 M8 R0
+        "    faddp   %%st, %%st(1)\n"                     //R2 R0
+        "    fxch    %%st(1)\n"                           //R0 R2
+        "    fmuls   %4\n"
+        "    fstps   0*"FSIZE_STR"("DEST",%%ecx)\n"       //R2
+        "    fmuls   %4\n"
+        "    fstps   2*"FSIZE_STR"("DEST",%%ecx)\n"
+
+        "    addl $(3*"FSIZE_STR"), %%ecx\n"
+        "    jnz snormxform_WICK0\n"
+        :
+        : "c" (n), "S" (source), "d" (dest), "D" (matrix), "m" (scale) );
+#endif
 }
 
 void ablend_565(unsigned char *lpAlpha, unsigned int iAlpPitch,
@@ -1223,16 +2001,17 @@
                 unsigned int iDstPitch)
 
 {
+#if defined (_MSC_VER)
         //Mask for isolating the red, green, and blue components
-        static __int64 MASKB=0x001F001F001F001F;
-        static __int64 MASKG=0x07E007E007E007E0;
-        static __int64 MASKSHIFTG=0x03F003F003F003F0;
-        static __int64 MASKR=0xF800F800F800F800;
+        static int64_t MASKB=0x001F001F001F001F;
+        static int64_t MASKG=0x07E007E007E007E0;
+        static int64_t MASKSHIFTG=0x03F003F003F003F0;
+        static int64_t MASKR=0xF800F800F800F800;
 
         //constants used by the integer alpha blending equation
-        static __int64 SIXTEEN=0x0010001000100010;
-        static __int64 FIVETWELVE=0x0200020002000200;
-        static __int64 SIXONES=0x003F003F003F003F;
+        static int64_t SIXTEEN=0x0010001000100010;
+        static int64_t FIVETWELVE=0x0200020002000200;
+        static int64_t SIXONES=0x003F003F003F003F;
 
         unsigned char *lpLinearDstBp=(iDstX<<1)+(iDstY*iDstPitch)+lpDst; //base pointer for linear destination
         unsigned char *lpLinearSrcBp=(iSrcX<<1)+(iSrcY*iSrcPitch)+lpSrc; //base pointer for linear source
@@ -1513,6 +2292,373 @@
 done:
                 emms
         }
+#elif defined (__GNUC__) && defined (__i386__)
+        /* Mask for isolating the red, green, and blue components */
+        static int64_t MASKB=0x001F001F001F001FLL;
+        static int64_t MASKG=0x07E007E007E007E0LL;
+        static int64_t MASKSHIFTG=0x03F003F003F003F0LL;
+        static int64_t MASKR=0xF800F800F800F800LL;
+
+        /* constants used by the integer alpha blending equation */
+        static int64_t SIXTEEN=0x0010001000100010LL;
+        static int64_t FIVETWELVE=0x0200020002000200LL;
+        static int64_t SIXONES=0x003F003F003F003FLL;
+
+        /* We use ebp to replace ebx when using PIC (avoid killing the GOT),
+           so avoid stack variables. */
+#ifdef PIC
+        static unsigned char *lpLinearDstBp;
+        lpLinearDstBp=(iDstX<<1)+(iDstY*iDstPitch)+lpDst; /*base pointer for linear destination*/
+        static unsigned char *lpLinearSrcBp;
+        lpLinearSrcBp=(iSrcX<<1)+(iSrcY*iSrcPitch)+lpSrc; /*base pointer for linear source*/
+        static unsigned char *lpLinearAlpBp;
+        lpLinearAlpBp=iSrcX+(iSrcY*iAlpPitch)+lpAlpha; /*base pointer for linear alpha*/
+
+        static unsigned int iDstWStatic;
+        iDstWStatic = iDstW;
+        static unsigned int iAlpPitchStatic;
+        iAlpPitchStatic = iAlpPitch;
+        static unsigned int iSrcPitchStatic;
+        iSrcPitchStatic = iSrcPitch;
+        static unsigned int iDstPitchStatic;
+        iDstPitchStatic = iDstPitch;
+#else
+        unsigned char *lpLinearDstBp=(iDstX<<1)+(iDstY*iDstPitch)+lpDst; /*base pointer for linear destination*/
+        unsigned char *lpLinearSrcBp=(iSrcX<<1)+(iSrcY*iSrcPitch)+lpSrc; /*base pointer for linear source*/
+        unsigned char *lpLinearAlpBp=iSrcX+(iSrcY*iAlpPitch)+lpAlpha; /*base pointer for linear alpha*/
+#endif
+        __asm__ __volatile__ (
+#ifdef PIC
+            "    pushl %%ebp\n"
+#else
+            "    pushl %%ebx\n"
+#endif
+
+            "    movl    %0, %%esi\n"      //src
+            "    movl    %1, %%edi\n"      //dst
+
+            "    movl    %2, %%eax\n"      //alpha
+            //"    movl    %3, %%ecx\n"      //ecx=number of lines to copy
+
+#ifdef PIC
+            "    movl    %4, %%ebp\n"      //ebp=span width to copy
+#else
+            "    movl    %4, %%ebx\n"      //ebx=span width to copy
+#endif
+            "    testl   $6, %%esi\n"          //check if source address is qword aligned
+                                                //since addr coming in is always word aligned(16bit)
+            "    jnz     ablend_565_done\n"     //if not qword aligned we don't do anything
+
+            "ablend_565_primeloop:\n"
+            "    movd    (%%eax), %%mm1\n"      //mm1=00 00 00 00 a3 a2 a1 a0
+            "    pxor    %%mm2, %%mm2\n"        //mm2=0;
+
+            "    movq    (%%esi), %%mm4\n"      //g1: mm4=src3 src2 src1 src0
+            "    punpcklbw %%mm2, %%mm1\n"      //mm1=00a3 00a2 00a1 00a0
+
+            "ablend_565_loopqword:\n"
+            "    movl    (%%eax), %%edx\n"
+
+#ifdef PIC
+            "    testl   $0xFFFFFFFC, %%ebp\n"   //check if only 3 pixels left
+#else
+            "    testl   $0xFFFFFFFC, %%ebx\n"   //check if only 3 pixels left
+#endif
+            "    jz      ablend_565_checkback\n" //3 or less pixels left
+
+                 //early out tests
+            "    cmpl    $0xffffffff, %%edx\n"  //test for alpha value of 1
+            "    je      ablend_565_copyback\n" //if 1's copy the source pixels to the destination
+
+            "    testl   $0xffffffff, %%edx\n"    //test for alpha value of 0
+            "    jz      ablend_565_leavefront\n" //if so go to the next 4 pixels
+
+                 //the alpha blend starts
+                 //green
+                 //i=a*sg+(63-a)*dg
+                 //i=(i+32)+((i+32)>>6)>>6
+                 //red
+                 //i=a*sr+(31-a)*dr
+                 //i=(i+16)+((i+16)>>5)>>5
+            "    movq    (%%edi), %%mm5\n"      //g2: mm5=dst3 dst2 dst1 dst0
+            "    psrlw   $2, %%mm1\n"          //mm1=a?>>2 nuke out lower 2 bits
+
+            "    movq    %10, %%mm7\n"         //g3: mm7=1 bit shifted green mask
+            "    psrlw   $1, %%mm4\n"          //g3a: move src green down by 1 so that we won't overflow
+
+            "    movq    %%mm1, %%mm0\n"        //mm0=00a3 00a2 00a1 00a0
+            "    psrlw   $1, %%mm5\n"          //g3b: move dst green down by 1 so that we won't overflow
+
+            "    psrlw   $1, %%mm1\n"          //mm1=a?>>1 nuke out lower 1 bits
+            "    pand    %%mm7, %%mm4\n"        //g5: mm4=sg3 sg2 sg1 sg0
+
+            "    movq    %14, %%mm2\n"          //g4: mm2=63
+            "    pand    %%mm7, %%mm5\n"        //g7: mm5=dg3 dg2 dg1 dg0
+
+            "    movq    (%%esi), %%mm3\n"      //b1: mm3=src3 src2 src1 src0
+            "    psubsb  %%mm0, %%mm2\n"        //g6: mm2=63-a3 63-a2 63-a1 63-a0
+
+            "    movq    %8, %%mm7\n"           //b2: mm7=BLUE MASK
+            "    pmullw  %%mm0, %%mm4\n"        //g8: mm4=sg?*a?
+
+            "    movq    (%%edi), %%mm0\n"      //b3: mm0=dst3 dst2 dst1 dst0
+            "    pmullw  %%mm2, %%mm5\n"        //g9: mm5=dg?*(1-a?)
+
+            "    movq    %%mm7, %%mm2\n"        //b4: mm2=fiveones
+            "    pand    %%mm7, %%mm3\n"        //b4: mm3=sb3 sb2 sb1 sb0
+
+            "    pmullw  %%mm1, %%mm3\n"        //b6: mm3=sb?*a?
+            "    pand    %%mm7, %%mm0\n"        //b5: mm0=db3 db2 db1 db0
+
+            "    movq    (%%esi), %%mm7\n"      //r1: mm7=src3 src2 src1 src0
+            "    paddw   %%mm5, %%mm4\n"        //g10: mm4=sg?*a?+dg?*(1-a?)
+
+            "    pand    %11, %%mm7\n"          //r2: mm7=sr3 sr2 sr1 sr0
+            "    psubsb  %%mm1, %%mm2\n"        //b5a: mm2=31-a3 31-a2 31-a1 31-a0
+
+            "    paddw   %13, %%mm4\n"          //g11: mm4=(mm4+512) green
+            "    pmullw  %%mm2, %%mm0\n"        //b7: mm0=db?*(1-a?)
+
+            "    movq    %%mm4, %%mm5\n"        //g12: mm5=mm4 green
+            "    psrlw   $11, %%mm7\n"         //r4: shift src red down to position 0
+
+            "    psrlw   $6, %%mm4\n"          //g13: mm4=mm4>>6
+
+            "    paddw   %%mm5, %%mm4\n"        //g14: mm4=mm4+mm5 green
+
+            "    paddw   %%mm3, %%mm0\n"        //b8: mm0=sb?*a?+db?*(1-a?)
+
+            "    movq    (%%edi), %%mm5\n"      //r3: mm5=dst3 dst2 dst1 dst0
+
+            "    paddw   %12, %%mm0\n"         //b9: mm0=(mm0+16) blue
+
+            "    pand    %11, %%mm5\n"         //r5: mm5=dr3 dr2 dr1 dr0
+            "    psrlw   $5, %%mm4\n"          //g15: mm4=0?g0 0?g0 0?g0 0?g0 green
+
+            "    movq    %%mm0, %%mm3\n"        //b10: mm3=mm0 blue
+            "    psrlw   $5, %%mm0\n"          //b11: mm0=mm0>>5 blue
+
+            "    psrlw   $11, %%mm5\n"         //r6: shift dst red down to position 0
+            "    paddw   %%mm3, %%mm0\n"        //b12: mm0=mm3+mm0 blue
+
+            "    psrlw   $5, %%mm0\n"          //b13: mm0=000b 000b 000b 000b blue
+            "    pmullw  %%mm1, %%mm7\n"        //mm7=sr?*a?
+
+            "    pand    %9, %%mm4\n"           //g16: mm4=00g0 00g0 00g0 00g0 green
+            "    pmullw  %%mm2, %%mm5\n"        //r7: mm5=dr?*(31-a?)
+
+            "    por     %%mm4, %%mm0\n"        //mm0=00gb 00gb 00gb 00gb
+            "    addl    $4, %%eax\n"          //move to next 4 alphas
+
+            "    addl    $8, %%esi\n"          //move to next 4 pixels in src
+            "    addl    $8, %%edi\n"          //move to next 4 pixels in dst
+
+            "    movd    (%%eax), %%mm1\n"      //mm1=00 00 00 00 a3 a2 a1 a0
+            "    paddw   %%mm7, %%mm5\n"        //r8: mm5=sr?*a?+dr?*(31-a?)
+
+            "    paddw   %12, %%mm5\n"          //r9: mm5=(mm5+16) red
+            "    pxor    %%mm2, %%mm2\n"        //mm2=0;
+
+            "    movq    %%mm5, %%mm7\n"        //r10: mm7=mm5 red
+            "    psrlw   $5, %%mm5\n"          //r11: mm5=mm5>>5 red
+
+            "    movq    (%%esi), %%mm4\n"      //g1: mm4=src3 src2 src1 src0
+            "    paddw   %%mm7, %%mm5\n"        //r12: mm5=mm7+mm5 red
+
+            "    punpcklbw %%mm2, %%mm1\n"      //mm1=00a3 00a2 00a1 00a0
+            "    psrlw   $5, %%mm5\n"          //r13: mm5=mm5>>5 red
+
+            "    psllw   $11, %%mm5\n"         //r14: mm5=mm5<<10 red
+
+            "    por     %%mm5, %%mm0\n"        //mm0=0rgb 0rgb 0rgb 0rgb
+#ifdef PIC
+            "    subl    $4, %%ebp\n"          //polished off 4 pixels
+#else
+            "    subl    $4, %%ebx\n"          //polished off 4 pixels
+#endif
+
+            "    movq    %%mm0, -8(%%edi)\n"    //dst=0rgb 0rgb 0rgb 0rgb
+            "    jmp     ablend_565_loopqword\n" //go back to start
+
+            "ablend_565_copyback:\n"
+            "    movq %%mm4, (%%edi)\n"         //copy source to destination
+            "ablend_565_leavefront:\n"
+            "    addl    $8, %%edi\n"                  //advance destination by 4 pixels
+            "    addl    $4, %%eax\n"          //advance alpha by 4
+            "    addl    $8, %%esi\n"          //advance source by 4 pixels
+#ifdef PIC
+            "    subl    $4, %%ebp\n"          //decrease pixel count by 4
+#else
+            "    subl    $4, %%ebx\n"          //decrease pixel count by 4
+#endif
+            "    jmp     ablend_565_primeloop\n"
+
+            "ablend_565_checkback:\n"
+#ifdef PIC
+            "    testl   $0xFF, %%ebp\n"       //check if 0 pixels left
+#else
+            "    testl   $0xFF, %%ebx\n"       //check if 0 pixels left
+#endif
+            "    jz      ablend_565_nextline\n" //done with this span
+
+            //"ablend_565_backalign:\n"    //work out back end pixels
+            "    movq    (%%edi), %%mm5\n"      //g2: mm5=dst3 dst2 dst1 dst0
+            "    psrlw   $2, %%mm1\n"          //mm1=a?>>2 nuke out lower 2 bits
+
+            "    movq    %10, %%mm7\n"         //g3: mm7=shift 1 bit green mask
+            "    psrlw   $1, %%mm4\n"          //g3a: move src green down by 1 so that we won't overflow
+
+            "    movq    %%mm1, %%mm0\n"        //mm0=00a3 00a2 00a1 00a0
+            "    psrlw   $1, %%mm5\n"          //g3b: move dst green down by 1 so that we won't overflow
+
+            "    psrlw   $1, %%mm1\n"          //mm1=a?>>1 nuke out lower 1 bits
+            "    pand    %%mm7, %%mm4\n"        //g5: mm4=sg3 sg2 sg1 sg0
+
+            "    movq    %14, %%mm2\n"          //g4: mm2=63
+            "    pand    %%mm7, %%mm5\n"        //g7: mm5=dg3 dg2 dg1 dg0
+
+            "    movq    (%%esi), %%mm3\n"      //b1: mm3=src3 src2 src1 src0
+            "    psubsb  %%mm0, %%mm2\n"        //g6: mm2=63-a3 63-a2 63-a1 63-a0
+
+            "    movq    %8, %%mm7\n"           //b2: mm7=BLUE MASK
+            "    pmullw  %%mm0, %%mm4\n"        //g8: mm4=sg?*a?
+
+            "    movq    (%%edi), %%mm0\n"      //b3: mm0=dst3 dst2 dst1 dst0
+            "    pmullw  %%mm2, %%mm5\n"        //g9: mm5=dg?*(1-a?)
+
+            "    movq    %%mm7, %%mm2\n"        //b4: mm2=fiveones
+            "    pand    %%mm7, %%mm3\n"        //b4: mm3=sr3 sr2 sr1 sr0
+
+            "    pmullw  %%mm1, %%mm3\n"        //b6: mm3=sb?*a?
+            "    pand    %%mm7, %%mm0\n"        //b5: mm0=db3 db2 db1 db0
+
+            "    movq    (%%esi), %%mm7\n"      //r1: mm7=src3 src2 src1 src0
+            "    paddw   %%mm5, %%mm4\n"        //g10: mm4=sg?*a?+dg?*(1-a?)
+
+            "    pand    %11, %%mm7\n"          //r2: mm7=sr3 sr2 sr1 sr0
+            "    psubsb  %%mm1, %%mm2\n"        //b5a: mm2=31-a3 31-a2 31-a1 31-a0
+
+            "    paddw   %13, %%mm4\n"          //g11: mm4=(i+512) green
+            "    pmullw  %%mm2, %%mm0\n"        //b7: mm0=db?*(1-a?)
+
+            "    movq    %%mm4, %%mm5\n"        //g12: mm5=(i+512) green
+            "    psrlw   $11, %%mm7\n"         //r4: shift src red down to position 0
+
+            "    psrlw   $6, %%mm4\n"          //g13: mm4=(i+512)>>6
+
+            "    paddw   %%mm5, %%mm4\n"        //g14: mm4=(i+512)+((i+512)>>6) green
+
+            "    paddw   %%mm3, %%mm0\n"        //b8: mm0=sb?*a?+db?*(1-a?)
+
+            "    movq    (%%edi), %%mm5\n"      //r3: mm5=dst3 dst2 dst1 dst0
+
+            "    paddw   %12, %%mm0\n"         //b9: mm0=(i+16) blue
+
+            "    pand    %11, %%mm5\n"         //r5: mm5=dr3 dr2 dr1 dr0
+            "    psrlw   $5, %%mm4\n"          //g15: mm4=0?g0 0?g0 0?g0 0?g0 green
+
+            "    movq    %%mm0, %%mm3\n"        //b10: mm3=(i+16) blue
+            "    psrlw   $5, %%mm0\n"          //b11: mm0=(i+16)>>5 blue
+
+            "    psrlw   $11, %%mm5\n"         //r6: shift dst red down to position 0
+            "    paddw   %%mm3, %%mm0\n"        //b12: mm0=(i+16)+(i+16)>>5 blue
+
+            "    psrlw   $5, %%mm0\n"          //b13: mm0=000r 000r 000r 000r blue
+            "    pmullw  %%mm1, %%mm7\n"        //mm7=sr?*a?
+
+            "    pand    %9, %%mm4\n"           //g16: mm4=00g0 00g0 00g0 00g0 green
+            "    pmullw  %%mm2, %%mm5\n"        //r7: mm5=dr?*(31-a?)
+
+            "    por     %%mm4, %%mm0\n"        //mm0=00gb 00gb 00gb 00gb
+            "    addl    $4, %%eax\n"          //move to next 4 alphas
+
+                 //stall
+
+            "    paddw   %%mm7, %%mm5\n"        //r8: mm5=sr?*a?+dr?*(31-a?)
+
+            "    paddw   %12, %%mm5\n"          //r9: mm5=(i+16) red
+
+            "    movq    %%mm5, %%mm7\n"        //r10: mm7=(i+16) red
+            "    psrlw   $5, %%mm5\n"          //r11: mm5=(i+16)>>5 red
+
+            "    paddw   %%mm7, %%mm5\n"        //r12: mm5=(i+16)+((i+16)>>5) red
+
+            "    psrlw   $5, %%mm5\n"          //r13: mm5=(i+16)+((i+16)>>5)>>5 red
+
+            "    psllw   $11, %%mm5\n"         //r14: mm5=mm5<<10 red
+
+            "    por     %%mm5, %%mm0\n"        //mm0=0rgb 0rgb 0rgb 0rgb
+#ifdef PIC
+            "    testl   $2, %%ebp\n"          //check if there are 2 pixels
+#else
+            "    testl   $2, %%ebx\n"          //check if there are 2 pixels
+#endif
+
+            "    jz      ablend_565_oneendpixel\n" //goto one pixel if that's it
+
+            "    movd    %%mm0, (%%edi)\n"      //dst=0000 0000 0rgb 0rgb
+            "    psrlq   $32, %%mm0\n"         //mm0>>32
+
+            "    addl    $4, %%edi\n"          //edi=edi+4
+#ifdef PIC
+            "    subl    $2, %%ebp\n"          //saved 2 pixels
+#else
+            "    subl    $2, %%ebx\n"          //saved 2 pixels
+#endif
+
+            "    jz      ablend_565_nextline\n" //all done goto next line
+            "ablend_565_oneendpixel:\n"    //work on last pixel
+            "    movd    %%mm0, %%edx\n"        //edx=0rgb
+
+            "    movw    %%dx, (%%edi)\n"       //dst=0rgb
+
+            "ablend_565_nextline:\n"       //goto next line
+            "    decl    %%ecx\n"                            //nuke one line
+            "    jz      ablend_565_done\n"                  //all done
+
+            "    movl    %2, %%eax\n"      //alpha
+            "    movl    %0, %%esi\n"      //src
+
+            "    movl    %1, %%edi\n"      //dst
+            "    addl    %5, %%eax\n"  //inc alpha ptr by 1 line
+
+            "    addl    %6, %%esi\n"  //inc src ptr by 1 line
+            "    addl    %7, %%edi\n"  //inc dst ptr by 1 line
+
+            "    movl    %%eax, %2\n"      //save new alpha base ptr
+#ifdef PIC
+            "    movl    %4, %%ebp\n"      //ebp=span width to copy
+#else
+            "    movl    %4, %%ebx\n"      //ebx=span width to copy
+#endif
+
+            "    movl    %%esi, %0\n"      //save new src base ptr
+            "    movl    %%edi, %1\n"      //save new dst base ptr
+
+            "    jmp     ablend_565_primeloop\n" //start the next span
+            "ablend_565_done:\n"
+            "    emms\n"
+
+#ifdef PIC
+            "    popl %%ebp\n"
+#else
+            "    popl %%ebx\n"
+#endif
+            :
+            : "m" (lpLinearSrcBp), "m" (lpLinearDstBp), "m" (lpLinearAlpBp),
+              "c" (iDstH),
+#ifdef PIC
+              "m" (iDstWStatic),
+              "m" (iAlpPitchStatic), "m" (iSrcPitchStatic),
+              "m" (iDstPitchStatic),
+#else
+              "m" (iDstW),
+              "m" (iAlpPitch), "m" (iSrcPitch), "m" (iDstPitch),
+#endif
+              "m" (MASKB), "m" (MASKG), "m" (MASKSHIFTG), "m" (MASKR),
+              "m" (SIXTEEN), "m" (FIVETWELVE), "m" (SIXONES)
+            : "eax", "edx", "esi", "edi" );
+#endif
 }
 
 void ablend_555(unsigned char *lpAlpha,unsigned int iAlpPitch,
@@ -1522,14 +2668,15 @@
                 unsigned int iDstW,     unsigned int iDstH,
                 unsigned int iDstPitch)
 {
+#if defined (_MSC_VER)
         //Mask for isolating the red, green, and blue components
-        static __int64 MASKR=0x001F001F001F001F;
-        static __int64 MASKG=0x03E003E003E003E0;
-        static __int64 MASKB=0x7C007C007C007C00;
+        static int64_t MASKR=0x001F001F001F001F;
+        static int64_t MASKG=0x03E003E003E003E0;
+        static int64_t MASKB=0x7C007C007C007C00;
 
         //constants used by the integer alpha blending equation
-        static __int64 SIXTEEN=0x0010001000100010;
-        static __int64 FIVETWELVE=0x0200020002000200;
+        static int64_t SIXTEEN=0x0010001000100010;
+        static int64_t FIVETWELVE=0x0200020002000200;
 
         unsigned char *lpLinearDstBp=(iDstX<<1)+(iDstY*iDstPitch)+lpDst;
         unsigned char *lpLinearSrcBp=(iSrcX<<1)+(iSrcY*iSrcPitch)+lpSrc;
@@ -1787,4 +2934,346 @@
 done:
                 emms
         }
+#elif defined (__GNUC__) && defined (__i386__)
+        /* Mask for isolating the red, green, and blue components */
+        static int64_t MASKR=0x001F001F001F001FLL;
+        static int64_t MASKG=0x03E003E003E003E0LL;
+        static int64_t MASKB=0x7C007C007C007C00LL;
+
+        /* constants used by the integer alpha blending equation */
+        static int64_t SIXTEEN=0x0010001000100010LL;
+        static int64_t FIVETWELVE=0x0200020002000200LL;
+
+        /* We use ebp to replace ebx when using PIC (avoid killing the GOT),
+           so avoid stack variables. */
+#ifdef PIC
+        static unsigned char *lpLinearDstBp;
+        lpLinearDstBp=(iDstX<<1)+(iDstY*iDstPitch)+lpDst; /*base pointer for linear destination*/
+        static unsigned char *lpLinearSrcBp;
+        lpLinearSrcBp=(iSrcX<<1)+(iSrcY*iSrcPitch)+lpSrc; /*base pointer for linear source*/
+        static unsigned char *lpLinearAlpBp;
+        lpLinearAlpBp=iSrcX+(iSrcY*iAlpPitch)+lpAlpha; /*base pointer for linear alpha*/
+
+        static unsigned int iDstWStatic;
+        iDstWStatic = iDstW;
+        static unsigned int iAlpPitchStatic;
+        iAlpPitchStatic = iAlpPitch;
+        static unsigned int iSrcPitchStatic;
+        iSrcPitchStatic = iSrcPitch;
+        static unsigned int iDstPitchStatic;
+        iDstPitchStatic = iDstPitch;
+#else
+        unsigned char *lpLinearDstBp=(iDstX<<1)+(iDstY*iDstPitch)+lpDst; /*base pointer for linear destination*/
+        unsigned char *lpLinearSrcBp=(iSrcX<<1)+(iSrcY*iSrcPitch)+lpSrc; /*base pointer for linear source*/
+        unsigned char *lpLinearAlpBp=iSrcX+(iSrcY*iAlpPitch)+lpAlpha; /*base pointer for linear alpha*/
+#endif
+        __asm__ __volatile__ (
+#ifdef PIC
+            "    pushl %%ebp\n"
+#else
+            "    pushl %%ebx\n"
+#endif
+
+            "    movl    %0, %%esi\n"      //src
+            "    movl    %1, %%edi\n"      //dst
+
+            "    movl    %2, %%eax\n"      //alpha
+            //"    movl    %3, %%ecx\n"      //ecx=number of lines to copy
+
+#ifdef PIC
+            "    movl    %4, %%ebp\n"      //ebp=span width to copy
+#else
+            "    movl    %4, %%ebx\n"      //ebx=span width to copy
+#endif
+            "    testl   $6, %%esi\n"       //check if source address is qword aligned
+                                            //since addr coming in is always word aligned(16bit)
+            "    jnz     ablend_555_done\n" //if not qword aligned we don't do anything
+
+            "ablend_555_primeloop:\n"
+            "    movd    (%%eax), %%mm1\n"      //mm1=00 00 00 00 a3 a2 a1 a0
+            "    pxor    %%mm2, %%mm2\n"        //mm2=2;
+
+            "    movq    (%%esi), %%mm4\n"      //g1: mm4=src3 src2 src1 src0
+            "    punpcklbw %%mm2, %%mm1\n"      //mm1=00a3 00a2 00a1 00a0
+
+            "ablend_555_loopqword:\n"
+            "    movl    (%%eax), %%edx\n"
+
+#ifdef PIC
+            "    testl   $0xFFFFFFFC, %%ebp\n" //check if only 3 pixels left
+#else
+            "    testl   $0xFFFFFFFC, %%ebx\n" //check if only 3 pixels left
+#endif
+            "    jz      ablend_555_checkback\n"      //3 or less pixels left
+
+                 //early out tests"
+            "    cmpl    $0xffffffff, %%edx\n" //test for alpha value of 1
+            "    je      ablend_555_copyback\n"      //if 1's copy the source pixels to the destination
+
+            "    testl   $0xffffffff, %%edx\n" //test for alpha value of 0
+            "    jz      ablend_555_leavefront\n"     //if so go to the next 4 pixels
+
+                 //the alpha blend starts"
+                 //i=a*sr+(31-a)*dr"
+                 //i=(i+16)+((i+16)>>5)>>5"
+            "    movq    (%%edi), %%mm5\n"      //g2: mm5=dst3 dst2 dst1 dst0
+            "    psrlw   $3, %%mm1\n"          //mm1=a?>>3 nuke out lower 3 bits
+
+            "    movq    %9, %%mm7\n"           //g3: mm7=green mask
+            "    movq    %%mm1, %%mm0\n"        //mm0=00a3 00a2 00a1 00a0
+
+            "    movq    %8, %%mm2\n"           //g4: mm2=31
+            "    pand    %%mm7, %%mm4\n"        //g5: mm4=sg3 sg2 sg1 sg0
+
+            "    psubsb  %%mm0, %%mm2\n"        //g6: mm2=31-a3 31-a2 31-a1 31-a0
+            "    pand    %%mm7, %%mm5\n"        //g7: mm5=dg3 dg2 dg1 dg0
+
+            "    movq    (%%esi), %%mm3\n"      //b1: mm3=src3 src2 src1 src0
+            "    pmullw  %%mm1, %%mm4\n"        //g8: mm4=sg?*a?
+
+            "    movq    %8, %%mm7\n"           //b2: mm7=blue mask
+            "    pmullw  %%mm2, %%mm5\n"        //g9: mm5=dg?*(1-a?)
+
+            "    movq    (%%edi), %%mm0\n"      //b3: mm0=dst3 dst2 dst1 dst0
+            "    pand    %%mm7, %%mm3\n"        //b4: mm3=sb3 sb2 sb1 sb0
+
+            "    pand    %%mm7, %%mm0\n"        //b5: mm0=db3 db2 db1 db0
+            "    pmullw  %%mm1, %%mm3\n"        //b6: mm3=sb?*a?
+
+            "    movq    (%%esi), %%mm7\n"      //r1: mm7=src3 src2 src1 src0
+            "    paddw   %%mm5, %%mm4\n"        //g10: mm4=sg?*a?+dg?*(1-a?)
+
+            "    paddw   %12, %%mm4\n"          //g11: mm4=(mm4+512) green
+            "    pmullw  %%mm2, %%mm0\n"        //b7: mm0=db?*(1-a?)
+
+            "    pand    %10, %%mm7\n"          //r2: mm7=sr3 sr2 sr1 sr0
+            "    movq    %%mm4, %%mm5\n"        //g12: mm5=mm4 green
+
+            "    psrlw   $5, %%mm4\n"          //g13: mm4=mm4>>5
+
+            "    paddw   %%mm5, %%mm4\n"        //g14: mm4=mm5+mm4 green
+
+            "    movq    (%%edi), %%mm5\n"      //r3: mm5=dst3 dst2 dst1 dst0
+            "    paddw   %%mm3, %%mm0\n"        //b8: mm0=sb?*a?+db?*(1-a?)
+
+            "    paddw   %11, %%mm0\n"         //b9: mm0=(mm0+16) blue
+            "    psrlw   $10, %%mm7\n"         //r4: shift src red down to position 0
+
+            "    pand    %10, %%mm5\n"         //r5: mm5=dr3 dr2 dr1 dr0
+            "    psrlw   $5, %%mm4\n"          //g15: mm4=0?g0 0?g0 0?g0 0?g0 green
+
+            "    movq    %%mm0, %%mm3\n"        //b10: mm3=mm0 blue
+            "    psrlw   $5, %%mm0\n"          //b11: mm0=mm0>>5 blue
+
+            "    psrlw   $10, %%mm5\n"         //r6: shift dst red down to position 0
+            "    paddw   %%mm3, %%mm0\n"        //b12: mm0=mm3+mm0 blue
+
+            "    psrlw   $5, %%mm0\n"          //b13: mm0=000b 000b 000b 000b blue
+            "    pmullw  %%mm1, %%mm7\n"        //mm7=sr?*a?
+
+            "    pand    %9, %%mm4\n"           //g16: mm4=00g0 00g0 00g0 00g0 green
+            "    pmullw  %%mm2, %%mm5\n"        //r7: mm5=dr?*(31-a?)
+
+            "    por     %%mm4, %%mm0\n"        //mm0=00gb 00gb 00gb 00gb
+            "    addl    $4, %%eax\n"          //move to next 4 alphas
+
+            "    addl    $8, %%esi\n"          //move to next 4 pixels in src
+            "    addl    $8, %%edi\n"          //move to next 4 pixels in dst
+
+            "    movd    (%%eax), %%mm1\n"      //mm1=00 00 00 00 a3 a2 a1 a0
+            "    paddw   %%mm7, %%mm5\n"        //r8: mm5=sr?*a?+dr?*(31-a?)
+
+            "    paddw   %11, %%mm5\n"          //r9: mm5=(mm5+16) red
+            "    pxor    %%mm2, %%mm2\n"        //mm0=0;
+
+            "    movq    %%mm5, %%mm7\n"        //r10: mm7=mm5 red
+            "    psrlw   $5, %%mm5\n"          //r11: mm5=mm5>>5 red
+
+            "    movq    (%%esi), %%mm4\n"      //g1: mm4=src3 src2 src1 src0
+            "    paddw   %%mm7, %%mm5\n"        //r12: mm5=mm7+mm5 red
+
+            "    punpcklbw %%mm2, %%mm1\n"      //mm1=00a3 00a2 00a1 00a0
+            "    psrlw   $5, %%mm5\n"          //r13: mm5=mm5>>5 red
+
+            "    psllw   $10, %%mm5\n"         //r14: mm5=mm5<<10 red
+
+            "    por     %%mm5, %%mm0\n"        //mm0=0rgb 0rgb 0rgb 0rgb
+#ifdef PIC
+            "    subl    $4, %%ebp\n"          //polished off 4 pixels
+#else
+            "    subl    $4, %%ebx\n"          //polished off 4 pixels
+#endif
+
+            "    movq    %%mm0, -8(%%edi)\n"    //dst=0rgb 0rgb 0rgb 0rgb
+            "    jmp     ablend_555_loopqword\n" //go back to start
+
+            "ablend_555_copyback:\n"
+            "    movq %%mm4, (%%edi)\n"         //copy source to destination
+            "ablend_555_leavefront:\n"
+            "    addl    $8, %%edi\n"          //advance destination by 4 pixels
+            "    addl    $4, %%eax\n"          //advance alpha by 4
+            "    addl    $8, %%esi\n"          //advance source by 4 pixels
+#ifdef PIC
+            "    subl    $4, %%ebp\n"          //decrease pixel count by 4
+#else
+            "    subl    $4, %%ebx\n"          //decrease pixel count by 4
+#endif
+            "    jmp     ablend_555_primeloop\n"
+
+            "ablend_555_checkback:\n"
+#ifdef PIC
+            "    testl   $0xFF, %%ebp\n"       //check if 0 pixels left
+#else
+            "    testl   $0xFF, %%ebx\n"       //check if 0 pixels left
+#endif
+            "    jz      ablend_555_nextline\n" //done with this span
+
+            //"ablend_555_backalign:\n"    //work out back end pixels
+            "    movq    (%%edi), %%mm5\n"      //g2: mm5=dst3 dst2 dst1 dst0
+            "    psrlw   $3, %%mm1\n"          //mm1=a?>>3 nuke out lower 3 bits
+
+            "    movq    %9, %%mm7\n"           //g3: mm7=green mask
+            "    movq    %%mm1, %%mm0\n"        //mm0=00a3 00a2 00a1 00a0
+
+            "    movq    %8, %%mm2\n"           //g4: mm2=31 mask
+            "    pand    %%mm7, %%mm4\n"        //g5: mm4=sg3 sg2 sg1 sg0
+
+            "    psubsb  %%mm0, %%mm2\n"        //g6: mm2=31-a3 31-a2 31-a1 31-a0
+            "    pand    %%mm7, %%mm5\n"        //g7: mm5=dg3 dg2 dg1 dg0
+
+            "    movq    (%%esi), %%mm3\n"      //b1: mm3=src3 src2 src1 src0
+            "    pmullw  %%mm1, %%mm4\n"        //g8: mm4=sg?*a?
+
+            "    movq    %8, %%mm7\n"           //b2: mm7=blue mask
+            "    pmullw  %%mm2, %%mm5\n"        //g9: mm5=dg?*(1-a?)
+
+            "    movq    (%%edi), %%mm0\n"      //b3: mm0=dst3 dst2 dst1 dst0
+            "    pand    %%mm7, %%mm3\n"        //b4: mm3=sb3 sb2 sb1 sb0
+
+            "    pand    %%mm7, %%mm0\n"        //b5: mm0=db3 db2 db1 db0
+            "    pmullw  %%mm1, %%mm3\n"        //b6: mm3=sb?*a?
+
+            "    movq    (%%esi), %%mm7\n"      //r1: mm7=src3 src2 src1 src0
+            "    paddw   %%mm5, %%mm4\n"        //g10: mm4=sg?*a?+dg?*(1-a?)
+
+            "    paddw   %12, %%mm4\n"          //g11: mm4=(mm4+512) green
+            "    pmullw  %%mm2, %%mm0\n"        //b7: mm0=db?*(1-a?)
+
+            "    pand    %10, %%mm7\n"          //r2: mm7=sr3 sr2 sr1 sr0
+            "    movq    %%mm4, %%mm5\n"        //g12: mm5=mm4 green
+
+            "    psrlw   $5, %%mm4\n"          //g13: mm4=mm4>>5
+
+            "    paddw   %%mm5, %%mm4\n"        //g14: mm4=mm4+mm5 green
+
+            "    movq    (%%edi), %%mm5\n"      //r3: mm5=dst3 dst2 dst1 dst0
+            "    paddw   %%mm3, %%mm0\n"        //b8: mm0=sb?*a?+db?*(1-a?)
+
+            "    paddw   %11, %%mm0\n"         //b9: mm0=mm0 blue
+            "    psrlw   $10, %%mm7\n"         //r4: shift src red down to position 0
+
+            "    pand    %10, %%mm5\n"         //r5: mm5=dr3 dr2 dr1 dr0
+            "    psrlw   $5, %%mm4\n"          //g15: mm4=0?g0 0?g0 0?g0 0?g0 green
+
+            "    movq    %%mm0, %%mm3\n"        //b10: mm3=mm0 blue
+            "    psrlw   $5, %%mm0\n"          //b11: mm0=mm0>>5 blue
+
+            "    psrlw   $10, %%mm5\n"         //r6: shift dst red down to position 0
+            "    paddw   %%mm3, %%mm0\n"        //b12: mm0=mm0+mm3 blue
+
+            "    psrlw   $5, %%mm0\n"          //b13: mm0=000b 000b 000b 000b blue
+            "    pmullw  %%mm1, %%mm7\n"        //mm7=sr?*a?
+
+            "    pand    %9, %%mm4\n"           //g16: mm4=00g0 00g0 00g0 00g0 green
+            "    pmullw  %%mm2, %%mm5\n"        //r7: mm5=dr?*(31-a?)
+
+            "    por     %%mm4, %%mm0\n"        //mm0=00gb 00gb 00gb 00gb
+
+                 //stall
+
+            "    paddw   %%mm7, %%mm5\n"        //r8: mm5=sr?*a?+dr?*(31-a?)
+
+            "    paddw   %11, %%mm5\n"          //r9: mm5=mm5 red
+
+            "    movq    %%mm5, %%mm7\n"        //r10: mm7=mm5 red
+            "    psrlw   $5, %%mm5\n"          //r11: mm5=mm5>>5 red
+
+            "    paddw   %%mm7, %%mm5\n"        //r12: mm5=mm5+mm7 red
+
+            "    psrlw   $5, %%mm5\n"          //r13: mm5=mm5>>5 red
+
+            "    psllw   $10, %%mm5\n"         //r14: mm5=mm5<<10 red
+
+            "    por     %%mm5, %%mm0\n"        //mm0=0rgb 0rgb 0rgb 0rgb
+
+#ifdef PIC
+            "    testl   $2, %%ebp\n"          //check if there are 2 pixels
+#else
+            "    testl   $2, %%ebx\n"          //check if there are 2 pixels
+#endif
+            "    jz      ablend_555_oneendpixel\n" //goto one pixel if that's it
+
+            "    movd    %%mm0, (%%edi)\n"      //dst=0000 0000 0rgb 0rgb
+            "    psrlq   $32, %%mm0\n"         //mm0>>32
+
+            "    addl    $4, %%edi\n"          //edi=edi+4
+#ifdef PIC
+            "    subl    $2, %%ebp\n"          //saved 2 pixels
+#else
+            "    subl    $2, %%ebx\n"          //saved 2 pixels
+#endif
+
+            "    jz      ablend_555_nextline\n" //all done goto next line
+            "ablend_555_oneendpixel:\n"    //work on last pixel
+            "    movd    %%mm0, %%edx\n"        //edx=0rgb
+
+            "    movw    %%dx, (%%edi)\n"       //dst=0rgb
+
+            "ablend_555_nextline:\n"       //goto next line
+            "    decl    %%ecx\n"            //nuke one line
+            "    jz      ablend_555_done\n"  //all done
+
+            "    movl    %2, %%eax\n"      //alpha
+            "    movl    %0, %%esi\n"      //src
+
+            "    movl    %1, %%edi\n"      //dst
+            "    addl    %5, %%eax\n"  //inc alpha ptr by 1 line
+
+            "    addl    %6, %%esi\n"  //inc src ptr by 1 line
+            "    addl    %7, %%edi\n"  //inc dst ptr by 1 line
+
+            "    movl    %%eax, %2\n"      //save new alpha base ptr
+#ifdef PIC
+            "    movl    %4, %%ebp\n"      //ebp=span width to copy
+#else
+            "    movl    %4, %%ebx\n"      //ebx=span width to copy
+#endif
+
+            "    movl    %%esi, %0\n"      //save new src base ptr
+            "    movl    %%edi, %1\n"      //save new dst base ptr
+
+            "    jmp     ablend_555_primeloop\n" //start the next span
+            "ablend_555_done:\n"
+            "    emms\n"
+
+#ifdef PIC
+            "    popl %%ebp\n"
+#else
+            "    popl %%ebx\n"
+#endif
+            :
+            : "m" (lpLinearSrcBp), "m" (lpLinearDstBp), "m" (lpLinearAlpBp),
+              "c" (iDstH),
+#ifdef PIC
+              "m" (iDstWStatic),
+              "m" (iAlpPitchStatic), "m" (iSrcPitchStatic),
+              "m" (iDstPitchStatic),
+#else
+              "m" (iDstW),
+              "m" (iAlpPitch), "m" (iSrcPitch), "m" (iDstPitch),
+#endif
+              "m" (MASKR), "m" (MASKG), "m" (MASKB),
+              "m" (SIXTEEN), "m" (FIVETWELVE)
+            : "eax", "edx", "esi", "edi" );
+#endif
 }
Only in homeworld-orig/src/rgl: D3D
diff -urPw homeworld-orig/src/rgl/fixed.h homeworld_sdl-0.3/src/rgl/fixed.h
--- homeworld-orig/src/rgl/fixed.h	2002-09-04 12:46:28.000000000 -0700
+++ homeworld_sdl-0.3/src/rgl/fixed.h	2004-08-01 22:35:12.000000000 -0700
@@ -6,7 +6,7 @@
     _asm fistp dword ptr i
 
 extern double chop_temp;
-#if 1
+#if 0
 
 #define FAST_TO_INT(X) \
     ((chop_temp = (double)(X) + BIG_NUM), *(int*)(&chop_temp))
diff -urPw homeworld-orig/src/rgl/fxdriver.c homeworld_sdl-0.3/src/rgl/fxdriver.c
--- homeworld-orig/src/rgl/fxdriver.c	2002-09-04 12:46:28.000000000 -0700
+++ homeworld_sdl-0.3/src/rgl/fxdriver.c	2004-08-01 22:35:13.000000000 -0700
@@ -8,6 +8,7 @@
 
 #include <stdio.h>
 #include <assert.h>
+#include <string.h>
 #include "kgl.h"
 #include "fxdrv.h"
 
@@ -109,6 +110,8 @@
 
 static unsigned short CW, oldCW;
 
+#if defined (_MSC_VER)
+
 #define loFPU() \
     __asm { \
         __asm fstcw [oldCW] \
@@ -123,6 +126,29 @@
         __asm fldcw [oldCW] \
     }
 
+#elif defined (__GNUC__) && defined (__i386__)
+
+#define loFPU() \
+    __asm__ __volatile__ (            \
+        "fstcw %0\n\t"                \
+        "movw %0, %%ax\n\t"           \
+        "andl $0xFFFFFCFF, %%eax\n\t" \
+        "movw %%ax, %1\n\t"           \
+        "fldcw %1\n\t"                \
+        : "=m" (oldCW)                \
+        : "m" (CW)                    \
+        : "eax" );
+
+#define restoreFPU() \
+    __asm__ __volatile__ ( \
+        "fldcw %0\n\t"     \
+        :                  \
+        : "m" (oldCW) );
+
+#else
+#error Inline assembly requires x86 platform.
+#endif
+
 #define SNAPPER (float)(3L << 18)
 //intel-specific snapper, relies on loFPU
 #define SNAP(v) \
Only in homeworld-orig/src/rgl: glide3
diff -urPw homeworld-orig/src/rgl/kgl.c homeworld_sdl-0.3/src/rgl/kgl.c
--- homeworld-orig/src/rgl/kgl.c	2002-09-04 12:46:28.000000000 -0700
+++ homeworld_sdl-0.3/src/rgl/kgl.c	2004-08-01 22:35:13.000000000 -0700
@@ -6,7 +6,11 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
+#ifdef _WIN32
 #include <windows.h>
+#else
+#include <dlfcn.h>
+#endif
 
 #include <stdio.h>
 #include <stdlib.h>
@@ -34,7 +38,8 @@
 
 
 //use malloc / free if WIN_ALLOC is defined
-#undef WIN_ALLOC
+//#undef WIN_ALLOC
+#define WIN_ALLOC
 
 //poly stat variables
 GLuint g_NumPolys = 0;
@@ -411,11 +416,11 @@
     if (index >= 0 && index < nDevices)
     {
         activeDevice = index;
-        return TRUE;
+        return GL_TRUE;
     }
     else
     {
-        return FALSE;
+        return GL_FALSE;
     }
 }
 
@@ -2752,7 +2757,7 @@
 {
     GLcontext* ctx = CC;
     static GLboolean (*init_driver)();
-    HINSTANCE lib;
+    void* lib;
     char fname[64];
 
     ctx->NewMask |= NEW_RASTER;
@@ -2777,14 +2782,25 @@
 
     if (reload)
     {
+#ifdef _WIN32
         strcpy(fname, "rgl");
+#else
+        strcpy(fname, "librgl");
+#endif
         strcat(fname, devices[activeDevice].name);
+#ifndef _WIN32
+        strcat(fname, ".so");
+#endif
 
+#ifdef _WIN32
         lib = GetModuleHandle(fname);
         if (lib == NULL)
         {
             lib = LoadLibrary(fname);
         }
+#else
+        lib = dlopen(fname, RTLD_GLOBAL | RTLD_NOW);
+#endif
         if (lib == NULL)
         {
             strcat(fname, " : couldn't load driver");
@@ -2792,7 +2808,11 @@
             return GL_FALSE;
         }
 
+#ifdef _WIN32
         init_driver = (GLboolean(*)())GetProcAddress(lib, "init_driver");
+#else
+        init_driver = (GLboolean(*)())dlsym(lib, "init_driver");
+#endif
         if (init_driver == NULL)
         {
             return GL_FALSE;
@@ -5414,13 +5434,13 @@
 }
 
 /*-----------------------------------------------------------------------------
-    Name        : glLitColorTable
+    Name        : glLitColorTableEXT
     Description : binds a shared pre-lit colortable to the context
     Inputs      :
     Outputs     :
     Return      :
 ----------------------------------------------------------------------------*/
-DLL void API glLitColorTable(
+DLL void API glLitColorTableEXT(
     GLenum target, GLenum internalformat, GLsizei length,
     GLenum format, GLenum type, GLvoid const* palette)
 {
@@ -5461,13 +5481,13 @@
 }
 
 /*-----------------------------------------------------------------------------
-    Name        : glColorTable
+    Name        : glColorTableEXT
     Description : binds a colortable (palette) to the currently bound texture object
     Inputs      : [as per spec, but only palette is used]
     Outputs     :
     Return      :
 ----------------------------------------------------------------------------*/
-DLL void API glColorTable(
+DLL void API glColorTableEXT(
     GLenum target, GLenum internalformat, GLsizei length,
     GLenum format, GLenum type, GLvoid const* palette)
 {
@@ -5528,6 +5548,33 @@
 }
 
 /*-----------------------------------------------------------------------------
+    Name        : glColorTable
+    Description : alias for glColorTableEXT() (for consistency, should be
+                  removed once we're sure all references to glColorTable() are
+                  cleaned out)
+    Inputs      : [as per spec, but only palette is used]
+    Outputs     :
+    Return      :
+----------------------------------------------------------------------------*/
+DLL void API glColorTable(
+    GLenum target, GLenum internalformat, GLsizei length,
+    GLenum format, GLenum type, GLvoid const* palette)
+{ glColorTableEXT(target, internalformat, length, format, type, palette); }
+
+/*-----------------------------------------------------------------------------
+    Name        : glLitColorTable
+    Description : alias for glColorTableEXT() (like glColorTable(), it's for
+                  consistency and should eventually be removed)
+    Inputs      :
+    Outputs     :
+    Return      :
+----------------------------------------------------------------------------*/
+DLL void API glLitColorTable(
+    GLenum target, GLenum internalformat, GLsizei length,
+    GLenum format, GLenum type, GLvoid const* palette)
+{ glLitColorTableEXT(target, internalformat, length, format, type, palette); }
+
+/*-----------------------------------------------------------------------------
     Name        : glPixelTransferf
     Description : pixel transfer control
     Inputs      : pname - pixel parameter to update
@@ -6433,7 +6480,7 @@
 
 static struct __extensions__ ext[] =
 {
-    { (pROC)glColorTable, "glColorTableEXT" },
+    { (pROC)glColorTableEXT, "glColorTableEXT" },
     { (pROC)glLitColorTable, "glLitColorTableEXT" },
     { (pROC)rglFeature, "rglFeature" },
     { (pROC)rglSpecExp, "rglSpecExp" },
@@ -6469,7 +6516,7 @@
 
 static int qt_ext = sizeof(ext) / sizeof(ext[0]);
 
-pROC rglGetProcAddress(LPCSTR lpszProc)
+pROC rglGetProcAddress(char* lpszProc)
 {
     int i;
 
diff -urPw homeworld-orig/src/rgl/kgl.h homeworld_sdl-0.3/src/rgl/kgl.h
--- homeworld-orig/src/rgl/kgl.h	2002-09-04 12:46:28.000000000 -0700
+++ homeworld_sdl-0.3/src/rgl/kgl.h	2004-08-01 22:35:13.000000000 -0700
@@ -785,6 +785,12 @@
 
 DLL void API glDrawArrays(GLenum mode, GLint first, GLsizei count);
 
+DLL void API glColorTableEXT(
+    GLenum target, GLenum internalformat, GLsizei length,
+    GLenum format, GLenum type, GLvoid const* palette);
+DLL void API glLitColorTableEXT(
+    GLenum target, GLenum internalformat, GLsizei length,
+    GLenum format, GLenum type, GLvoid const* palette);
 DLL void API glColorTable(
     GLenum target, GLenum internalformat, GLsizei length,
     GLenum format, GLenum type, GLvoid const* palette);
diff -urPw homeworld-orig/src/rgl/kgl_macros.h homeworld_sdl-0.3/src/rgl/kgl_macros.h
--- homeworld-orig/src/rgl/kgl_macros.h	2002-09-04 12:46:28.000000000 -0700
+++ homeworld_sdl-0.3/src/rgl/kgl_macros.h	2004-08-01 22:35:13.000000000 -0700
@@ -6,8 +6,13 @@
 #define MEMSET memset
 #define MIN2(X, Y) ((X) < (Y) ? (X) : (Y))
 
+#ifdef _WIN32
 #define DLL __declspec(dllexport)
 #define API __stdcall
+#else
+#define DLL
+#define API
+#endif
 
 #define LOCK_BUFFER(CTX) \
     if (CTX->DriverFuncs.lock_buffer != NULL) \
diff -urPw homeworld-orig/src/rgl/kvb.h homeworld_sdl-0.3/src/rgl/kvb.h
--- homeworld-orig/src/rgl/kvb.h	2002-09-04 12:46:28.000000000 -0700
+++ homeworld_sdl-0.3/src/rgl/kvb.h	2004-08-01 22:35:12.000000000 -0700
@@ -49,7 +49,8 @@
 //void gl_render_vb(GLcontext*, GLboolean);
 //void gl_reset_vb(GLcontext*, GLboolean);
 
-void gl_transform_vb_part1();
-void gl_transform_vb_part2();
+struct gl_context_s;
+void gl_transform_vb_part1(struct gl_context_s*, GLboolean);  /* kgl.c needs this, too. */
+//void gl_transform_vb_part2();
 
 #endif
diff -urPw homeworld-orig/src/rgl/lines.c homeworld_sdl-0.3/src/rgl/lines.c
--- homeworld-orig/src/rgl/lines.c	2002-09-04 12:46:30.000000000 -0700
+++ homeworld_sdl-0.3/src/rgl/lines.c	2004-08-01 22:35:12.000000000 -0700
@@ -1,4 +1,5 @@
 #include "kgl.h"
+#include "span.h"
 
 extern GLint g_DepthMask;
 
diff -urPw homeworld-orig/src/rgl/maths.c homeworld_sdl-0.3/src/rgl/maths.c
--- homeworld-orig/src/rgl/maths.c	2002-09-04 12:46:30.000000000 -0700
+++ homeworld_sdl-0.3/src/rgl/maths.c	2004-08-01 22:35:11.000000000 -0700
@@ -4,6 +4,8 @@
 #include "kgl.h"
 #include "maths.h"
 
+extern void invert_matrix(GLfloat const*, GLfloat*);
+
 typedef enum {X,Y,Z,W} quat_coefficient;
 
 GLfloat xaxis[3] = {1.0f,0.0f,0.0f};
@@ -388,7 +390,6 @@
 
 void mat4_inverse(GLfloat* d, GLfloat* s)
 {
-    extern void invert_matrix(GLfloat const*, GLfloat*);
     invert_matrix(s, d);
 }
 
diff -urPw homeworld-orig/src/rgl/newpersptri.c homeworld_sdl-0.3/src/rgl/newpersptri.c
--- homeworld-orig/src/rgl/newpersptri.c	2002-09-04 12:46:30.000000000 -0700
+++ homeworld_sdl-0.3/src/rgl/newpersptri.c	2004-08-01 22:35:13.000000000 -0700
@@ -2,6 +2,7 @@
 #include "kgl.h"
 #include "newtriangle.h"
 #include "swdrv.h"
+#include "span.h"
 
 #define PIXEL_ADDRESS2(X,Y) (GLushort*)(ctx->FrameBuffer + ctx->scrMultByte[Y] + ctx->Buffer.ByteMult*(X))
 
diff -urPw homeworld-orig/src/rgl/newtextri.c homeworld_sdl-0.3/src/rgl/newtextri.c
--- homeworld-orig/src/rgl/newtextri.c	2002-09-04 12:46:30.000000000 -0700
+++ homeworld_sdl-0.3/src/rgl/newtextri.c	2004-08-01 22:35:12.000000000 -0700
@@ -2,6 +2,7 @@
 #include "kgl.h"
 #include "newtriangle.h"
 #include "swdrv.h"
+#include "span.h"
 
 #define PIXEL_ADDRESS2(X,Y) (GLushort*)(ctx->FrameBuffer + ctx->scrMultByte[Y] + ctx->Buffer.ByteMult*(X))
 
diff -urPw homeworld-orig/src/rgl/newtriangle.c homeworld_sdl-0.3/src/rgl/newtriangle.c
--- homeworld-orig/src/rgl/newtriangle.c	2002-09-04 12:46:30.000000000 -0700
+++ homeworld_sdl-0.3/src/rgl/newtriangle.c	2004-08-01 22:35:13.000000000 -0700
@@ -4,6 +4,7 @@
 #include "kgl.h"
 #include "newtriangle.h"
 #include "stipple.h"
+#include "span.h"
 
 #define FixedFloor(X)   ((X) & FIXED_INT_MASK)
 #define SignedFloatToFixed(X) FloatToFixed(X)
Only in homeworld-orig/src/rgl: obj
Only in homeworld-orig/src/rgl: rgld3d.exp
Only in homeworld-orig/src/rgl: rgl.exp
diff -urPw homeworld-orig/src/rgl/rglext.c homeworld_sdl-0.3/src/rgl/rglext.c
--- homeworld-orig/src/rgl/rglext.c	2002-09-04 12:46:30.000000000 -0700
+++ homeworld_sdl-0.3/src/rgl/rglext.c	2004-08-01 22:35:12.000000000 -0700
@@ -372,13 +372,20 @@
     VB->Count += 3;
 }
 
+#if defined (_MSC_VER)
 #define S(x)   dword ptr [esi + 4*x]
 #define D(x)   dword ptr [edi + 4*x]
 #define M(n)   dword ptr [edx + 4*n]
+#elif defined (__GNUC__) && defined (__i386__)
+    #define S(x)   "4*" #x "(%%esi)"
+    #define D(x)   "4*" #x "(%%edi)"
+    #define M(n)   "4*" #n "(%%edx)"
+#endif
 
 static void affine_transform(
     GLuint n, GLfloat* d, GLfloat m[16], GLfloat* s)
 {
+#if defined (_MSC_VER)
     _asm
     {
         push esi
@@ -450,10 +457,77 @@
         pop edi
         pop esi
     }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ (
+        "    testl %%ecx, %%ecx\n"
+        "    jz afft_two\n"
+
+        "    movl $0x3f800000, %%eax\n"
+
+        "afft_one:\n"
+        "    flds " S(0) "\n"
+        "    fmuls " M(0) "\n"
+        "    flds " S(0) "\n"
+        "    fmuls " M(1) "\n"
+        "    flds " S(0) "\n"
+        "    fmuls " M(2) "\n"
+
+        "    flds " S(1) "\n"
+        "    fmuls " M(4) "\n"
+        "    flds " S(1) "\n"
+        "    fmuls " M(5) "\n"
+        "    flds " S(1) "\n"
+        "    fmuls " M(6) "\n"
+
+        "    fxch %%st(2)\n"
+        "    faddp %%st, %%st(5)\n"
+        "    faddp %%st, %%st(3)\n"
+        "    faddp %%st, %%st(1)\n"
+
+        "    flds " S(2) "\n"
+        "    fmuls " M(8) "\n"
+        "    flds " S(2) "\n"
+        "    fmuls " M(9) "\n"
+        "    flds " S(2) "\n"
+        "    fmul " M(10) "\n"
+
+        "    fxch %%st(2)\n"
+        "    faddp %%st, %%st(5)\n"
+        "    faddp %%st, %%st(3)\n"
+        "    faddp %%st, %%st(1)\n"
+
+        "    fxch %%st(2)\n"
+        "    fadds " M(12) "\n"
+        "    fxch %%st(1)\n"
+        "    fadds " M(13) "\n"
+        "    fxch %%st(2)\n"
+        "    fadds " M(14) "\n"
+
+        "    fxch %%st(1)\n"
+        "    fstps " D(0) "\n"
+        "    fstps " D(2) "\n"
+        "    fstps " D(1) "\n"
+        "    movl %%eax, " D(3) "\n"
+
+        "    leal " S(4) ", %%esi\n"
+        "    decl %%ecx\n"
+
+        "    leal " D(4) ", %%edi\n"
+
+        "    jnz afft_one\n"
+
+        "afft_two:\n"
+        :
+        : "c" (n), "D" (d), "d" (m), "S" (s)
+        : "eax" );
+#else
+#error affine_transform(): Not yet implemented on this platform.
+#endif
 }
 
 static void normal_transform(GLfloat* d, GLfloat* s, GLfloat* m, GLuint n)
 {
+#if defined (_MSC_VER)
     _asm
     {
         push esi
@@ -514,6 +588,60 @@
         pop edi
         pop esi
     }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ (
+        "    testl %%ecx, %%ecx\n"
+        "    jz normt_two\n"
+
+        "normt_one:\n"
+        "    flds " S(0) "\n"
+        "    fmuls " M(0) "\n"
+        "    flds " S(0) "\n"
+        "    fmuls " M(4) "\n"
+        "    flds " S(0) "\n"
+        "    fmuls " M(8) "\n"
+
+        "    flds " S(1) "\n"
+        "    fmuls " M(1) "\n"
+        "    flds " S(1) "\n"
+        "    fmuls " M(5) "\n"
+        "    flds " S(1) "\n"
+        "    fmuls " M(9) "\n"
+
+        "    fxch %%st(2)\n"
+        "    faddp %%st, %%st(5)\n"
+        "    faddp %%st, %%st(3)\n"
+        "    faddp %%st, %%st(1)\n"
+
+        "    flds " S(2) "\n"
+        "    fmuls " M(2) "\n"
+        "    flds " S(2) "\n"
+        "    fmuls " M(6) "\n"
+        "    flds " S(2) "\n"
+        "    fmuls " M(10) "\n"
+
+        "    fxch %%st(2)\n"
+        "    faddp %%st, %%st(5)\n"
+        "    faddp %%st, %%st(3)\n"
+        "    faddp %%st, %%st(1)\n"
+
+        "    fxch %%st(2)\n"
+        "    fstps " D(0) "\n"
+        "    fstps " D(1) "\n"
+        "    fstps " D(2) "\n"
+
+        "    leal " S(4) ", %%esi\n"
+        "    decl %%ecx\n"
+
+        "    leal " D(3) ", %%edi\n"
+        "    jnz normt_one\n"
+
+        "normt_two:\n"
+        :
+        : "c" (n), "D" (d), "d" (m), "S" (s) );
+#else
+#error normal_transform(): Not yet implemented on this platform.
+#endif
 }
 
 DLL void rglMeshRender(
Only in homeworld-orig/src/rgl: rglsw.exp
diff -urPw homeworld-orig/src/rgl/scan.c homeworld_sdl-0.3/src/rgl/scan.c
--- homeworld-orig/src/rgl/scan.c	2002-09-04 12:46:30.000000000 -0700
+++ homeworld_sdl-0.3/src/rgl/scan.c	2004-08-01 22:35:13.000000000 -0700
@@ -1,4 +1,5 @@
 #include <stdio.h>
+#include <stdlib.h>
 #include <math.h>
 #include <assert.h>
 #include "kgl.h"
@@ -89,6 +90,7 @@
 
 void loFPU()
 {
+#if defined (_MSC_VER)
     _asm
     {
         fstcw   [OldFPUCW]
@@ -97,14 +99,32 @@
         mov     [FPUCW],ax
         fldcw   [FPUCW]
     }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ (
+        "   fstcw   %0\n"
+        "   movw    %0, %%ax\n"
+        "   andl    $0xFF, %%eax\n"
+        "   movw    %%ax, %1\n"
+        "   fldcw   %1\n"
+        :
+        : "m" (OldFPUCW), "m" (FPUCW)
+        : "eax" );
+#endif
 }
 
 void restoreFPU()
 {
+#if defined (_MSC_VER)
     _asm
     {
         fldcw [OldFPUCW]
     }
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ __volatile__ (
+        "   fldcw %0\n"
+        :
+        : "m" (OldFPUCW) );
+#endif
 }
 
 static void adjust_color_to_black(
diff -urPw homeworld-orig/src/rgl/sdldraw.c homeworld_sdl-0.3/src/rgl/sdldraw.c
--- homeworld-orig/src/rgl/sdldraw.c	1969-12-31 16:00:00.000000000 -0800
+++ homeworld_sdl-0.3/src/rgl/sdldraw.c	2004-08-01 22:35:12.000000000 -0700
@@ -0,0 +1,408 @@
+/*=============================================================================
+    Name    : sdldraw.c
+    Purpose : Software renderer drawing routines using SDL (ported from
+              draw.cpp).
+
+    Created 9/29/2003 by Ted Cipicchio
+=============================================================================*/
+#define NAME  "SDLDraw"
+
+#include "SDL.h"
+#include <stdio.h>
+#include <stdlib.h>
+#include <stdarg.h>
+#include <assert.h>
+#include <string.h>
+
+#include "kgl.h"
+
+Uint8 WINDOWED = 1;
+
+void rglswSetWindowed(int windowed)
+{
+    WINDOWED = (windowed ? 1 : 0);
+}
+
+/* Ignored... */
+unsigned int useDirectDraw = 1;
+
+static int SCRWIDTH;
+static int SCRHEIGHT;
+
+Uint8 bSaveFramebuffer = 0;
+Uint8 bActive = 0;
+Uint32 depth = 0;
+Uint32 scrpitch = 0;
+Uint8* scrbuf = 0;
+
+Uint32 scratch_pitch = 0;
+Uint8* scratch_buffer;
+//Uint8* scratch_buffer_2;
+
+unsigned char restoreAll()
+{
+    return 1;
+}
+
+static void finiObjects(unsigned char freeDD)
+{
+    Uint32 flags;
+    if (!bActive)
+    {
+        return;
+    }
+    flags = SDL_WasInit(SDL_INIT_EVERYTHING);
+    if (!(flags & SDL_INIT_VIDEO))
+        return;
+    if (flags ^ SDL_INIT_VIDEO)
+        SDL_QuitSubSystem(SDL_INIT_VIDEO);
+    else
+        SDL_Quit();
+}
+
+unsigned char DrawBegin(void);
+unsigned char DrawEnd(void);
+
+void LockBuffers()
+{
+    DrawBegin();
+}
+
+void UnlockBuffers()
+{
+    DrawEnd();
+}
+
+void rglswDrawAnimatic(int px, int py, unsigned char* pb)
+{
+    int y;
+    Uint8* pSource;
+    Uint8* pDest;
+
+    LockBuffers();
+
+    for (y = 0; y < 480; y++)
+    {
+        pSource = pb + 2*640*y;
+        pDest = scrbuf + scrpitch*(y+py) + 2*px;
+        MEMCPY(pDest, pSource, 2*640);
+    }
+
+    UnlockBuffers();
+}
+
+unsigned char* rglswGetScratch()
+{
+    return(bSaveFramebuffer ? scratch_buffer : scrbuf);
+}
+
+void rglswClearScratch()
+{
+    int y;
+
+    for (y = 0; y < SCRHEIGHT; y++)
+    {
+        MEMSET(scratch_buffer + scratch_pitch*y, 0, 2*SCRWIDTH);
+    }
+}
+
+static void clear_buffers(void)
+{
+    /* SDL hides access to the display surface, so we'll only clear the back
+       buffer. */
+    SDL_Surface* pSurface = SDL_GetVideoSurface();
+    if (!pSurface)
+        return;
+    SDL_FillRect(pSurface, 0, 0);
+}
+
+unsigned int GetPitch()
+{
+    SDL_Surface* pSurface = SDL_GetVideoSurface();
+    return (pSurface ? pSurface->pitch : 0);
+}
+
+unsigned char DrawBegin()
+{
+    SDL_Surface* pSurface;
+
+    //if (bSaveFramebuffer || !useDirectDraw)
+    if (bSaveFramebuffer)
+    {
+        scrpitch = scratch_pitch;
+        scrbuf = scratch_buffer;
+        return 1;
+    }
+
+    pSurface = SDL_GetVideoSurface();
+    if (!pSurface)
+    {
+        return 0;
+    }
+
+    if (SDL_LockSurface(pSurface) == -1)
+    {
+        scrpitch = scratch_pitch;
+        scrbuf = scratch_buffer;
+        return 1;
+    }
+
+    scrpitch = pSurface->pitch;
+    scratch_pitch = scrpitch;
+    scrbuf = (Uint8*)pSurface->pixels;
+
+    return 1;
+}
+
+unsigned char DrawEnd()
+{
+    SDL_Surface* pSurface;
+
+    //if (bSaveFramebuffer || !useDirectDraw)
+    if (bSaveFramebuffer)
+    {
+        scrbuf = scratch_buffer;
+        scrpitch = 0;
+        return 1;
+    }
+
+    pSurface = SDL_GetVideoSurface();
+    if (!pSurface)
+    {
+        return 0;
+    }
+
+    if (scrbuf == scratch_buffer)
+    {
+        scrpitch = 0;
+        return 1;
+    }
+
+    if (bActive)
+    {
+        SDL_UnlockSurface(pSurface);
+    }
+
+    scrpitch = 0;
+    scrbuf = 0;
+
+    return 1;
+}
+
+int rglGetScreenPitch()
+{
+    int pitch;
+    DrawBegin();
+    pitch = scrpitch;
+    DrawEnd();
+    return pitch;
+}
+
+int rglGetScreenDepth()
+{
+    return depth;
+}
+
+static void rglswPitchedCopy(
+    Uint8* dest, int destPitch,
+    Uint8* source, int sourcePitch,
+    int width, int height)
+{
+    if (destPitch == sourcePitch)
+    {
+        memcpy(dest, source, sourcePitch * height);
+    }
+    else
+    {
+        Uint8* dp;
+        Uint8* sp;
+        int y;
+
+        dp = dest;
+        sp = source;
+        for (y = 0; y < height; y++, dp += destPitch, sp += sourcePitch)
+        {
+            memcpy(dp, sp, 2*width);
+        }
+    }
+}
+
+static void rglCopyScratchBuffer()
+{
+    Uint8 bSave = bSaveFramebuffer;
+
+    //if (!useDirectDraw) return;
+
+    bSaveFramebuffer = 0;
+
+    if (!DrawBegin())
+    {
+        bSaveFramebuffer = bSave;
+        return;
+    }
+    rglswPitchedCopy(scrbuf, scrpitch,
+                     scratch_buffer, scratch_pitch,
+                     SCRWIDTH, SCRHEIGHT);
+    DrawEnd();
+
+    bSaveFramebuffer = bSave;
+}
+
+static void rglCopyToScratchBuffer()
+{
+    Uint8 bSave = bSaveFramebuffer;
+
+    //if (!useDirectDraw) return;
+
+    bSaveFramebuffer = 0;
+
+    if (!DrawBegin())
+    {
+        bSaveFramebuffer = bSave;
+        return;
+    }
+    rglswPitchedCopy(scratch_buffer, scratch_pitch,
+                     scrbuf, scrpitch,
+                     SCRWIDTH, SCRHEIGHT);
+    DrawEnd();
+
+    bSaveFramebuffer = bSave;
+}
+
+static void rglCopyToUnpitchedScratchBuffer()
+{
+    Uint8 bSave = bSaveFramebuffer;
+
+    bSaveFramebuffer = 0;
+
+    if (!DrawBegin())
+    {
+        bSaveFramebuffer = bSave;
+        return;
+    }
+    rglswPitchedCopy(scratch_buffer, 2*SCRWIDTH,
+                     scrbuf, scrpitch,
+                     SCRWIDTH, SCRHEIGHT);
+
+    bSaveFramebuffer = bSave;
+}
+
+void rglswSetSaveState(int on)
+{
+    if (on && !bSaveFramebuffer)
+    {
+        rglCopyToScratchBuffer();
+    }
+
+    bSaveFramebuffer = on ? 1 : 0;
+}
+
+void updateFrame(void)
+{
+    SDL_Surface* pSurface;
+
+    if (bSaveFramebuffer)
+    {
+        rglCopyScratchBuffer();
+    }
+
+    pSurface = SDL_GetVideoSurface();
+    if (!pSurface)
+        return;
+    SDL_Flip(pSurface);
+}
+
+unsigned char rglswCreateWindow(GLint ihwnd, GLint width)
+{
+    Uint32 flags;
+    SDL_Surface* pSurface;
+
+    /* Set up screen dimensions we'll use. */
+    SCRWIDTH = width;
+    switch (width)
+    {
+    case 1600:
+        SCRHEIGHT = 1200;
+        break;
+    case 1280:
+        SCRHEIGHT = 1024;
+        break;
+    case 1024:
+        SCRHEIGHT = 768;
+        break;
+    case 800:
+        SCRHEIGHT = 600;
+        break;
+    default:
+        SCRWIDTH  = 640;
+        SCRHEIGHT = 480;
+    }
+
+    /* Initialize SDL video if it has not already been done. */
+    flags = SDL_WasInit(SDL_INIT_EVERYTHING);
+    if (!flags)
+    {
+        if (SDL_Init(SDL_INIT_VIDEO) == -1)
+            return 0;
+    }
+    else if (!(flags & SDL_INIT_VIDEO))
+    {
+        if (SDL_InitSubSystem(SDL_INIT_VIDEO) == -1)
+            return 0;
+    }
+
+    /* Create a double-buffered display. */
+    flags = SDL_HWSURFACE | SDL_DOUBLEBUF;
+    if (!WINDOWED)
+        flags |= SDL_FULLSCREEN;
+    if (!(pSurface = SDL_SetVideoMode(SCRWIDTH, SCRHEIGHT, 16, flags)))
+        return 0;
+
+    /* Verify the render surface bit depth. */
+    depth = pSurface->format->BitsPerPixel;
+    if (depth < 15 || depth > 16)
+    {
+        SDL_QuitSubSystem(SDL_INIT_VIDEO);
+        return 0;
+    }
+
+    bActive = 1;
+
+    scratch_pitch = GetPitch();
+    scratch_buffer = (Uint8*)malloc(scratch_pitch*SCRHEIGHT);
+    memset(scratch_buffer, 0, scratch_pitch*SCRHEIGHT);
+
+    clear_buffers();
+
+    return 1;
+}
+
+void rglswDeleteWindow(GLint ihwnd)
+{
+    DrawEnd();
+    finiObjects(1);
+
+    if (scratch_buffer)
+    {
+        free(scratch_buffer);
+        scratch_buffer = 0;
+    }
+}
+
+gl_pixel_type rglGetPixelType()
+{
+    switch (depth)
+    {
+    case 15:
+        return GL_RGB555;
+    case 16:
+        return GL_RGB565;
+    default:
+        return GL_RGBUNKNOWN;
+    }
+}
+
+DLL void rglDDrawActivate(unsigned char active)
+{
+    // Okay...
+}
diff -urPw homeworld-orig/src/rgl/span.c homeworld_sdl-0.3/src/rgl/span.c
--- homeworld-orig/src/rgl/span.c	2002-09-04 12:46:30.000000000 -0700
+++ homeworld_sdl-0.3/src/rgl/span.c	2004-08-01 22:35:11.000000000 -0700
@@ -4,7 +4,7 @@
 #include "scan.h"
 #include "asm.h"
 
-#include "stipple.c"
+#include "stipple.c.h"
 
 #define MONOCOLOR_RED   255
 #define MONOCOLOR_GREEN 0
diff -urPw homeworld-orig/src/rgl/swdriver.c homeworld_sdl-0.3/src/rgl/swdriver.c
--- homeworld-orig/src/rgl/swdriver.c	2002-09-04 12:46:30.000000000 -0700
+++ homeworld_sdl-0.3/src/rgl/swdriver.c	2004-08-01 22:35:12.000000000 -0700
@@ -1,4 +1,6 @@
 #include <stdio.h>
+#include <stdlib.h>
+#include <string.h>
 #include <math.h>
 #include "kgl.h"
 #include "span.h"
@@ -1932,6 +1934,7 @@
                 dp[x] = fill;
             }
 #else
+    #if defined (_MSC_VER)
             __asm
             {
                 push ecx ;
@@ -1950,6 +1953,13 @@
                 pop eax ;
                 pop ecx ;
             }
+    #elif defined (__GNUC__) && defined (__i386__)
+            __asm__ __volatile__ (
+                "    .align 16\n"
+                "    rep stosl\n"
+                :
+                : "c" (pitch), "a" (fill), "D" (dp) );
+    #endif
 #endif
         }
     }
Only in homeworld-orig/src/rgl: vssver.scc
diff -urPw homeworld-orig/src/rgl/wgl.c homeworld_sdl-0.3/src/rgl/wgl.c
--- homeworld-orig/src/rgl/wgl.c	2002-09-04 12:46:30.000000000 -0700
+++ homeworld_sdl-0.3/src/rgl/wgl.c	2004-08-01 22:35:13.000000000 -0700
@@ -1,13 +1,70 @@
+/* Modified from the original wgl.c to also provide glx functions when not
+   using Windows.  Enough is provided here so we can dupe SDL into thinking we
+   have a valid OpenGL library when using SDL_GL_LoadLibrary(). */
+
+#ifdef _WIN32
 #define DLL __declspec(dllexport)
 #define API __stdcall
+#else
+    #include <X11/Xutil.h>
+    #define DLL
+    #define API
+#endif
 
 typedef void (*PROC)();
+extern PROC rglGetProcAddress(const char*);
+extern unsigned char* API glGetString (unsigned int cap);
+#define GL_EXTENSIONS 0x1F03
+
+#ifdef _WIN32	/* wgl */
 
 DLL unsigned int API wglMakeCurrent(int hdc, int hglrc) { return 1; }
 DLL unsigned int API wglDeleteContext(int hglrc) { return 1; }
 DLL unsigned int API wglCreateContext(int hdc) { return 1; }
-DLL PROC API wglGetProcAddress(char* string)
+DLL PROC API wglGetProcAddress(const char* string)
 {
-    extern PROC rglGetProcAddress(char*);
     return rglGetProcAddress(string);
 }
+
+#else	/* glx */
+
+XVisualInfo* glXChooseVisual (Display* dpy, int screen, int* attribList)
+{
+	return (XVisualInfo*)1;
+}
+
+unsigned long glXCreateContext (Display* dpy, XVisualInfo* vis,
+	unsigned long shareList, Bool direct)
+{
+	return 1;
+}
+
+void glXDestroyContext (Display* dpy, unsigned long ctx)
+{
+	/* ... */
+}
+
+int glXMakeCurrent (Display* dpy, unsigned long drawable, unsigned long ctx)
+{
+	return 1;
+}
+
+void glXSwapBuffers (Display* dpy, unsigned long drawable)
+{
+	/* ... */
+}
+
+int glXGetConfig (Display* dpy, XVisualInfo* vis, int attrib, int* value)
+{
+	/* This will never work... */
+	return -1;
+}
+
+const char* glXQueryExtensionsString (Display* dpy, int screen)
+{
+	/* SDL requires this from an OpenGL library, but never uses it.  Either
+	   way, we should play it safe... */
+	return (const char*)glGetString(GL_EXTENSIONS);
+}
+
+#endif
diff -urPw homeworld-orig/src/SDL/avi.c homeworld_sdl-0.3/src/SDL/avi.c
--- homeworld-orig/src/SDL/avi.c	2002-09-04 12:47:00.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/avi.c	2004-08-01 22:35:06.000000000 -0700
@@ -1,21 +1,32 @@
 /*=============================================================================
-    Name    : avi.cpp
+    Name    : avi.c
     Purpose : routines for playing AVI files
 
     Created 1/9/1999 by jdorie, khent, jjoire
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
+/* TC 2003-10-01:
+ * Ever so silently, we replace AVI functions with dummy functions when
+ * compiling on platforms other than Windows.  Shh...don't tell the game what
+ * we're doing...
+ */
 
+#ifdef _WIN32
 #include <windows.h>
 #include <vfw.h>
-#include "avi.h"
 #include "wave.h"
+#endif
+
+#include "avi.h"
+
+extern int fullScreen;
+extern void* ghMainWindow;
+extern int MAIN_WindowWidth;
+extern int MAIN_WindowHeight;
+extern int systemActive;
+
 
-extern "C" int fullScreen;
-extern "C" void* ghMainWindow;
-extern "C" int MAIN_WindowWidth;
-extern "C" int MAIN_WindowHeight;
-extern "C" int systemActive;
+#ifdef _WIN32	/* Disable AVI code outside of Windows. */
 
 PAVISTREAM    g_VidStream;      //the AVI video stream
 AVISTREAMINFO g_VidStreamInfo;  //info about the AVI stream
@@ -41,19 +52,12 @@
 
 MMRESULT g_timerHandle = NULL;
 
-BOOL aviVerifyResult(HRESULT Result)
+int aviVerifyResult(HRESULT Result)
 {
-    if (Result == 0)
-    {
-        return TRUE;
-    }
-    else
-    {
-        return FALSE;
-    }
+    return (Result == 0 ? 1 : 0);
 }
 
-BOOL aviStart(char* filename)
+int aviStart(char* filename)
 {
     HRESULT Res;
 
@@ -119,73 +123,12 @@
     return !(g_dwCurrFrame >= g_VidStreamInfo.dwLength);
 }
 
-int aviGetSamples(void* pBuf, long* pNumSamples, long nBufSize)
-{
-    HRESULT Res;
-    long nSampRead;
-
-	if(aviHasAudio == FALSE) return FALSE;
-
-	if(aviIsPlaying == FALSE)
-	{
-		memset(pBuf,0,nBufSize);
-		return TRUE;
-	}
-
-    Res = AVIStreamRead(g_AudStream, g_dwCurrSample, *pNumSamples, pBuf, nBufSize, NULL, &nSampRead);
-    if (!aviVerifyResult(Res))
-    {
-        return FALSE;
-    }
-
-    *pNumSamples = nSampRead;
-    g_dwCurrSample += nSampRead;
-
-	return TRUE;
-}
-
 void aviResetStream(void)
 {
     g_dwCurrFrame  = 0;
     g_dwCurrSample = 0;
 }
 
-int aviStop(void)
-{
-    HRESULT Res;
-
-    g_bMoreFrames = FALSE;
-    aviDonePlaying = TRUE;
-
-    if (g_timerHandle != NULL)
-    {
-        (void)timeKillEvent(g_timerHandle);
-        g_timerHandle = NULL;
-    }
-
-    Res = AVIStreamGetFrameClose(g_pFrame);
-    if (!aviVerifyResult(Res))
-    {
-        return FALSE;
-    }
-
-    Res = AVIStreamRelease(g_VidStream);
-    if (!aviVerifyResult(Res))
-    {
-        return FALSE;
-    }
-
-    Res = AVIStreamRelease(g_AudStream);
-    if (!aviVerifyResult(Res))
-    {
-        return FALSE;
-    }
-
-    AVIFileExit();
-
-    return TRUE;
-}
-
 void aviShowFrame(BITMAPINFO* pMap)
 {
     HDC hdc, hdcTemp;
@@ -307,8 +250,81 @@
    }
 }
 
+#endif	/* _WIN32 */
+
+
+int aviGetSamples(void* pBuf, long* pNumSamples, long nBufSize)
+{
+#ifdef _WIN32
+    HRESULT Res;
+    long nSampRead;
+
+	if(aviHasAudio == FALSE) return FALSE;
+
+	if(aviIsPlaying == FALSE)
+	{
+		memset(pBuf,0,nBufSize);
+		return TRUE;
+	}
+
+    Res = AVIStreamRead(g_AudStream, g_dwCurrSample, *pNumSamples, pBuf, nBufSize, NULL, &nSampRead);
+    if (!aviVerifyResult(Res))
+    {
+        return FALSE;
+    }
+
+    *pNumSamples = nSampRead;
+    g_dwCurrSample += nSampRead;
+
+	return TRUE;
+#else
+    return 0;
+#endif
+}
+
+int aviStop(void)
+{
+#ifdef _WIN32
+    HRESULT Res;
+
+    g_bMoreFrames = FALSE;
+    aviDonePlaying = TRUE;
+
+    if (g_timerHandle != NULL)
+    {
+        (void)timeKillEvent(g_timerHandle);
+        g_timerHandle = NULL;
+    }
+
+    Res = AVIStreamGetFrameClose(g_pFrame);
+    if (!aviVerifyResult(Res))
+    {
+        return FALSE;
+    }
+
+    Res = AVIStreamRelease(g_VidStream);
+    if (!aviVerifyResult(Res))
+    {
+        return FALSE;
+    }
+
+    Res = AVIStreamRelease(g_AudStream);
+    if (!aviVerifyResult(Res))
+    {
+        return FALSE;
+    }
+
+    AVIFileExit();
+
+    return TRUE;
+#else
+    return 1;
+#endif
+}
+
 int aviPlay(char* filename)
 {
+#ifdef _WIN32
     char  fullname[1024];
     char* dir;
 
@@ -365,22 +381,33 @@
 	}
 
     return TRUE;
+#else
+    return 1;
+#endif
 }
 
 int aviInit()
 {
+#ifdef _WIN32
 	DWORD nNum;
 
 	//initialize audio
 	if(InitWave(&nNum) < 0) return FALSE;
 
     return TRUE;
+#else
+    return 1;
+#endif
 }
 
 int aviCleanup()
 {
+#ifdef _WIN32
 	//cleanup audio
 	if(EndWave() < 0) return FALSE;
 
     return TRUE;
+#else
+    return 1;
+#endif
 }
Only in homeworld-orig/src/SDL: bink.c
Only in homeworld-orig/src/SDL: bink.h
diff -urPw homeworld-orig/src/SDL/color.c homeworld_sdl-0.3/src/SDL/color.c
--- homeworld-orig/src/SDL/color.c	2002-09-04 12:47:00.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/color.c	2004-08-01 22:35:06.000000000 -0700
@@ -6,8 +6,9 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
+#include <stdlib.h>
 #include <math.h>
-#include "types.h"
+#include "Types.h"
 #include "color.h"
 
 /*=============================================================================
diff -urPw homeworld-orig/src/SDL/color.h homeworld_sdl-0.3/src/SDL/color.h
--- homeworld-orig/src/SDL/color.h	2002-09-04 12:47:00.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/color.h	2004-08-01 22:35:06.000000000 -0700
@@ -9,7 +9,7 @@
 #ifndef ___COLOR_H
 #define ___COLOR_H
 
-#include "types.h"
+#include "Types.h"
 
 /*=============================================================================
     Type definitions:
@@ -22,6 +22,19 @@
     Macros:
 =============================================================================*/
 //create RGB/RGBA quads
+#ifdef ENDIAN_BIG
+
+    #define colRGB(r,g,b)       (0x000000ff | (((ubyte)(r)) << 24) | (((ubyte)(g)) << 16) | (((ubyte)(b)) << 8))
+    #define colRGBA(r,g,b,a)    ((((udword)(r)) << 24) | (((udword)(g)) << 16) | (((udword)(b)) << 8) | (udword)(a))
+    
+    //extract elements from RGB/RGBA quads
+    #define colRed(rgb)         ((ubyte)(((rgb) & 0xff000000) >> 24))
+    #define colGreen(rgb)       ((ubyte)(((rgb) & 0x00ff0000) >> 16))
+    #define colBlue(rgb)        ((ubyte)(((rgb) & 0x0000ff00) >> 8))
+    #define colAlpha(rgba)      ((ubyte)((rgba) & 0x000000ff))
+    
+#else
+
 #define colRGB(r,g,b)       (0xff000000 | (((ubyte)(b)) << 16) | (((ubyte)(g)) << 8) | ((ubyte)(r)))
 #define colRGBA(r,g,b,a)    ((((udword)(a)) << 24) | (((udword)(b)) << 16) | (((udword)(g)) << 8) | (udword)(r))
 
@@ -30,6 +43,9 @@
 #define colGreen(rgb)       ((ubyte)(((rgb) & 0x0000ff00) >> 8))
 #define colBlue(rgb)        ((ubyte)(((rgb) & 0x00ff0000) >> 16))
 #define colAlpha(rgba)      ((ubyte)(((rgba) & 0xff000000) >> 24))
+
+#endif // ENDIAN_BIG
+
 #define colClampRed(rgb)    colClamp256(colRed(rgb))
 #define colClampGreen(rgb)  colClamp256(colGreen(rgb))
 #define colClampBlue(rgb)   colClamp256(colBlue(rgb))
Only in homeworld-orig/src/SDL: dct.h
diff -urPw homeworld-orig/src/SDL/ddraw.cpp homeworld_sdl-0.3/src/SDL/ddraw.cpp
--- homeworld-orig/src/SDL/ddraw.cpp	2002-09-04 12:47:00.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/ddraw.cpp	2004-08-01 22:35:06.000000000 -0700
@@ -7,16 +7,19 @@
 =============================================================================*/
 
 
+#ifdef _WIN32
 #define WIN32_LEAN_AND_MEAN
 #include <windows.h>
-
+#endif
 
 extern "C" unsigned int fullScreen;
 extern "C" unsigned int mainDirectDraw;
 
-static BOOL hwCreated = FALSE;
-static int  hwWidth, hwHeight;
-static int  hwDepth = 0;
+static bool hwCreated = false;
+//static int  hwWidth, hwHeight;
+extern "C" int  hwWidth, hwHeight;
+//static int  hwDepth = 0;
+extern "C" int  hwDepth = 0;
 
 
 extern "C" unsigned int ddSetRes(int, int, int);
Only in homeworld-orig/src/SDL: Debug.depend
diff -urPw homeworld-orig/src/SDL/debugwnd.c homeworld_sdl-0.3/src/SDL/debugwnd.c
--- homeworld-orig/src/SDL/debugwnd.c	2002-09-04 12:47:00.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/debugwnd.c	2004-08-01 22:35:07.000000000 -0700
@@ -2,16 +2,14 @@
     DEBUGWND.C: Code to draw a debug window
 =============================================================================*/
 
-//#define WIN32_LEAN_AND_MEAN
-#include <windows.h>
 #include <stdlib.h>
 #include <stdio.h>
 #include <string.h>
 
-#include "types.h"
+#include "Types.h"
 #include "main.h"
-#include "task.h"
-#include "file.h"
+#include "Task.h"
+#include "File.h"
 #include "debugwnd.h"
 
 /*=============================================================================
@@ -24,10 +22,10 @@
 sdword dbwWindowX, dbwWindowY;                  //top-left corner of window
 sdword dbwWindowWidth, dbwWindowHeight;         //width of the window (in characters)
 sdword dbwFontWidth, dbwFontHeight;             //width and height of font characters (assumes fixed-pitch)
-HWND   hDebugWindow;                            //HWND for the debug window
-HDC    hDebugDC;                                //device context for debug window
-LOGFONT dbwLogicalFont;                                //current debug window font
-HFONT  hDebugFont;                              //font handle for selection into DC
+/*HWND   hDebugWindow;                            //HWND for the debug window*/
+/*HDC    hDebugDC;                                //device context for debug window*/
+/*LOGFONT dbwLogicalFont;                                //current debug window font*/
+udword hDebugFont;                              //font handle for selection into DC
 
 //data for the individual panes
 pane dbwPane[DBW_NumberPanes];
diff -urPw homeworld-orig/src/SDL/debugwnd.h homeworld_sdl-0.3/src/SDL/debugwnd.h
--- homeworld-orig/src/SDL/debugwnd.h	2002-09-04 12:47:00.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/debugwnd.h	2004-08-01 22:35:08.000000000 -0700
@@ -88,6 +88,7 @@
 /*=============================================================================
     Functions:
 =============================================================================*/
+#ifdef _WIN32   /* Don't use debug window outside Windows. */
 //start/close down the debug window.
 sdword dbwStart(udword hInstance, udword hWndParent);
 void   dbwClose(void);
@@ -112,6 +113,7 @@
 sdword dbwLineFeed(sdword pane);
 void   dbwPaneClear(sdword pane);
 sdword dbwCursorSet(sdword pane, sdword x, sdword y);
+#endif  /* _WIN32 */
 
 #endif //___DEBUGWND_H
 
diff -urPw homeworld-orig/src/SDL/dxdraw.h homeworld_sdl-0.3/src/SDL/dxdraw.h
--- homeworld-orig/src/SDL/dxdraw.h	2002-09-04 12:47:00.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/dxdraw.h	2004-08-01 22:35:05.000000000 -0700
@@ -22,4 +22,9 @@
 unsigned int ddDeleteWindow(void);
 unsigned int ddActivate(int activate);
 
+// 2003-09-28: Ted Cipicchio:
+// Temporary hack to allow for SDL to initialize the display with OpenGL.
+extern int hwWidth, hwHeight;
+extern int hwDepth;
+
 #endif
diff -urPw homeworld-orig/src/SDL/font.c homeworld_sdl-0.3/src/SDL/font.c
--- homeworld-orig/src/SDL/font.c	2002-09-04 12:47:00.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/font.c	2004-08-01 22:35:05.000000000 -0700
@@ -6,28 +6,26 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#define WIN32_LEAN_AND_MEAN
-#include <windows.h>
 #include <stdlib.h>
 #include "glinc.h"
 #include <stdio.h>
 #include <stdarg.h>
 #include <string.h>
-#include "types.h"
+#include "Types.h"
 #include "color.h"
 #include "prim2d.h"
-#include "memory.h"
-#include "file.h"
-#include "debug.h"
+#include "Memory.h"
+#include "File.h"
+#include "Debug.h"
 #include "utility.h"
 #include "render.h"
 #include "font.h"
-#include "fontreg.h"
+#include "FontReg.h"
 #include "main.h"
 #include "glcaps.h"
 #include "texreg.h"
 #include "glcompat.h"
-#include "twiddle.h"
+#include "Twiddle.h"
 #include "devstats.h"
 
 
@@ -803,6 +801,11 @@
 
     length = fileLoadAlloc(fileName, (void **)(&fileHeader), NonVolatile);
 
+#ifdef ENDIAN_BIG
+	fileHeader->version = LittleLong( fileHeader->version );
+	fileHeader->flags   = LittleLong( fileHeader->flags );
+#endif
+
 #if FONT_ERROR_CHECKING
     if (strcmp(fileHeader->identification, FONT_Identification))
     {                                                       //if wrong header
@@ -815,6 +818,21 @@
 #endif
     header = &fileHeader->header;
     dbgAssert(fileHeader->flags == 0);                          //!!! don't yet support color or anti-aliased fonts
+
+#ifdef ENDIAN_BIG
+	header->nCharacters = LittleLong( header->nCharacters );
+	header->spacing     = LittleLong( header->spacing );
+	header->fullHeight  = LittleLong( header->fullHeight );
+	header->baseLine    = LittleLong( header->baseLine );
+	header->name        = ( char *)LittleLong( ( udword )header->name );
+	header->imageWidth  = LittleLong( header->imageWidth );
+	header->imageHeight = LittleLong( header->imageHeight );
+	header->nColors     = LittleLong( header->nColors );
+	header->palette     = ( color *)LittleLong( ( udword )header->palette );
+	header->image       = ( ubyte *)LittleLong( ( udword )header->image );
+	header->glFont      = ( void *)LittleLong( ( udword )header->glFont );
+#endif
+
 #if FONT_VERBOSE_LEVEL >= 2
     dbgMessagef("\nfontLoad: loaded %d bytes and %d characters from file '%s'", length, header->nCharacters, fileName);
 #endif
@@ -827,9 +845,20 @@
     sizeTotal = 0;
     for (index = iCharacter = 0; index < 256; index++)
     {                                                       //for all possible characters
+#ifdef ENDIAN_BIG
+		header->character[index] = ( charheader *)LittleLong( ( udword )header->character[index] );
+#endif
+
         if (header->character[index] != NULL)
         {
             (ubyte *)header->character[index] += (udword)fileHeader;//fix up character pointer
+#ifdef ENDIAN_BIG
+			header->character[index]->width   = LittleShort( header->character[index]->width );
+			header->character[index]->height  = LittleShort( header->character[index]->height );
+			header->character[index]->offsetX = LittleShort( header->character[index]->offsetX );
+			header->character[index]->offsetY = LittleShort( header->character[index]->offsetY );
+#endif
+
             pFileCharacter = (charfileheader *)header->character[index];//get reference to data loaded from disk
             size = (pFileCharacter->width - pFileCharacter->offsetX) *
                    (pFileCharacter->height - pFileCharacter->offsetY);
@@ -853,6 +882,12 @@
         {
             newHeader->character[index] = pCharacter;       //set character * for this character
             pFileCharacter = (charfileheader *)header->character[index];//get reference to data loaded from disk
+
+#ifdef ENDIAN_BIG
+			pFileCharacter->u   = LittleShort( pFileCharacter->u );
+			pFileCharacter->v   = LittleShort( pFileCharacter->v );
+#endif
+
             pCharacter->width = pFileCharacter->width;      //duplicate attributes
             pCharacter->height = pFileCharacter->height;
             pCharacter->offsetX = pFileCharacter->offsetX;
@@ -1071,7 +1106,7 @@
 sdword fontPrintN(sdword x, sdword y, color c, char *string, sdword maxCharacters)
 {
     charheader *character;
-    real32 imageWidth, imageHeight, clipHeight = 0.0f;
+    real32 imageWidth, imageHeight; //, clipHeight = 0.0f;
     sdword clip = 0;
     ubyte ch;
     udword brightRed, brightGreen, brightBlue;
@@ -1113,6 +1148,8 @@
                 yOffset = 1;
                 xOffset = -1;
                 break;
+			default:
+				break;
         }
         saveType = fontCurrentShadowType;
         fontCurrentShadowType = FS_NONE;
diff -urPw homeworld-orig/src/SDL/font.h homeworld_sdl-0.3/src/SDL/font.h
--- homeworld-orig/src/SDL/font.h	2002-09-04 12:47:00.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/font.h	2004-08-01 22:35:05.000000000 -0700
@@ -9,7 +9,7 @@
 #ifndef ___FONT_H
 #define ___FONT_H
 
-#include "types.h"
+#include "Types.h"
 #include "color.h"
 #include "prim2d.h"
 
diff -urPw homeworld-orig/src/SDL/fquant.h homeworld_sdl-0.3/src/SDL/fquant.h
--- homeworld-orig/src/SDL/fquant.h	2002-09-04 12:47:02.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/fquant.h	2004-08-01 22:35:08.000000000 -0700
@@ -63,8 +63,8 @@
 				 unsigned long nLen,unsigned long nRate,unsigned long nSize);
 
 int fqSPack(short nVal,unsigned long nLen,unsigned long nPos,char *aBlock);
-_inline long fqSUnpack(unsigned long nLen,unsigned long nPos,char *aBlock);
-_inline unsigned long fqUnpack(unsigned long nLen,unsigned long nPos,char *aBlock);
+long fqSUnpack(unsigned long nLen,unsigned long nPos,char *aBlock);
+unsigned long fqUnpack(unsigned long nLen,unsigned long nPos,char *aBlock);
 
 int linint(float *xa,float *ya,unsigned long n,float x,float *y);
 
diff -urPw homeworld-orig/src/SDL/glcaps.c homeworld_sdl-0.3/src/SDL/glcaps.c
--- homeworld-orig/src/SDL/glcaps.c	2002-09-04 12:47:02.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/glcaps.c	2004-08-01 22:35:05.000000000 -0700
@@ -10,13 +10,17 @@
 #include <string.h>
 #include "glcaps.h"
 #include "glext.h"
-#include "debug.h"
+#include "Debug.h"
 #include "texreg.h"
-#include "strings.h"
+#include "Strings.h"
 #include "devstats.h"
 #include "sstglide.h"
 #include "main.h"
+#include "render.h"
 
+#ifdef _MSC_VER
+#define strcasecmp _stricmp
+#endif
 
 /*-----------------------------------------------------------------------------
     data
@@ -59,18 +63,30 @@
 
 int NULL_rglINT(void)
 {
+#if defined (_MSC_VER)
     __asm int 3 ;
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ ( "int $3\n\t" );
+#endif
     return 0;
 }
 
 void NULL_rglVOID(void)
 {
+#if defined (_MSC_VER)
     __asm int 3 ;
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ ( "int $3\n\t" );
+#endif
 }
 
 char* NULL_rglPCHAR(void)
 {
+#if defined (_MSC_VER)
     __asm int 3 ;
+#elif defined (__GNUC__) && defined (__i386__)
+    __asm__ ( "int $3\n\t" );
+#endif
     return NULL;
 }
 
@@ -207,6 +223,7 @@
 typedef void* (*RGLGETFRAMEBUFFERPROC)(GLint*);
 typedef void (*RGLDRAWPITCHEDPIXELSPROC)(GLint, GLint, GLint, GLint, GLsizei, GLsizei, GLsizei, GLvoid const*);
 
+
 /*-----------------------------------------------------------------------------
     Name        : glCapGetRGLAddresses
     Description :
@@ -483,7 +500,11 @@
     bool rval;
 
     rval = glDLLGetProcs(dllName);
-    if (rval && (_stricmp(dllName, "rgl.dll") == 0))
+#ifdef _WIN32
+    if (rval && (strcasecmp(dllName, "rgl.dll") == 0))
+#else
+    if (rval && (strcasecmp(dllName, "librgl.so") == 0))
+#endif
     {
         glCapGetRGLAddresses();
     }
@@ -532,6 +553,7 @@
 ----------------------------------------------------------------------------*/
 bool glCapNT(void)
 {
+#ifdef _WIN32
     OSVERSIONINFO osVer;
 
     osVer.dwOSVersionInfoSize = sizeof(osVer);
@@ -548,6 +570,9 @@
     {
         return FALSE;
     }
+#else
+    return FALSE;
+#endif
 }
 
 /*-----------------------------------------------------------------------------
@@ -559,6 +584,7 @@
 ----------------------------------------------------------------------------*/
 bool glCap95(void)
 {
+#ifdef _WIN32
     OSVERSIONINFO osVer;
 
     osVer.dwOSVersionInfoSize = sizeof(osVer);
@@ -575,6 +601,9 @@
     {
         return FALSE;
     }
+#else
+    return FALSE;
+#endif
 }
 
 /*-----------------------------------------------------------------------------
@@ -610,7 +639,6 @@
 ----------------------------------------------------------------------------*/
 static char voodoo2Extensions[] = "GL_EXT_paletted_texture GL_EXT_shared_texture_palette GL_SGIS_multitexture ";
 static char voodooExtensions[]  = "GL_EXT_paletted_texture GL_EXT_shared_texture_palette ";
-static char voodooRenderer[] = "3Dfx";
 static char voodooVendor[] = "3Dfx Interactive Inc.";
 char GENERIC_OPENGL_RENDERER[128];
 void glCapStartup(void)
@@ -622,6 +650,14 @@
     extern bool mainFastFrontend;
     extern bool mainNoPalettes;
 
+#ifdef _MACOSX_FIX_ME
+	if( !rndSmallInit( NULL, TRUE ) )
+	{
+		fprintf( stderr, "Cannot initialize OpenGL\n" );
+		return;
+	}
+#endif
+
     GLC_EXTENSIONS = (char const*)glGetString(GL_EXTENSIONS);
     GLC_RENDERER   = (char const*)glGetString(GL_RENDERER);
     GLC_VENDOR     = (char const*)glGetString(GL_VENDOR);
@@ -817,15 +853,18 @@
     else
     {
         //determine double buffering support
+#ifndef _MACOSX_FIX_ME
         glGetIntegerv(GL_DOUBLEBUFFER, &param);
         glCapDoubleBuffer = param ? TRUE : FALSE;
+#endif
+		glCapDoubleBuffer = TRUE;
 
         //is this a 3dfx GL?
-        if (_stricmp(GLC_VENDOR, voodooVendor) == 0)
+        if (strcasecmp(GLC_VENDOR, voodooVendor) == 0)
         {
             //3dfxgl.dll w/ voodoo graphics or voodoo 2 ?
-            if (_stricmp(GLC_EXTENSIONS, voodooExtensions) == 0 ||
-                _stricmp(GLC_EXTENSIONS, voodoo2Extensions) == 0)
+            if (strcasecmp(GLC_EXTENSIONS, voodooExtensions) == 0 ||
+                strcasecmp(GLC_EXTENSIONS, voodoo2Extensions) == 0)
             {
                 //we're using 3dfxgl.dll and a voodoo 1 or 2
                 gl3Dfx = TRUE;
@@ -837,11 +876,13 @@
         glCapDepthFunc = GL_LEQUAL;
     }
 
+#ifndef _MACOSX_FIX_ME
     if (gl3Dfx)
     {
         //load the Glide stuff if we can use it
         sstStartup();
     }
+#endif
 
     //enable/disable linesmoothing as per devcaps et al
     glCapLineSmooth = TRUE;
diff -urPw homeworld-orig/src/SDL/glcaps.h homeworld_sdl-0.3/src/SDL/glcaps.h
--- homeworld-orig/src/SDL/glcaps.h	2002-09-04 12:47:02.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/glcaps.h	2004-08-01 22:35:05.000000000 -0700
@@ -10,9 +10,12 @@
 #define _GLCAPS_H
 
 #ifndef SW_Render
+#ifdef _WIN32
+#define WIN32_LEAN_AND_MEAN
 #include <windows.h>
 #endif
-#include "types.h"
+#endif
+#include "Types.h"
 #include "glinc.h"
 
 #define GL_SWAPFRIENDLY 0xffe01
diff -urPw homeworld-orig/src/SDL/glcompat.c homeworld_sdl-0.3/src/SDL/glcompat.c
--- homeworld-orig/src/SDL/glcompat.c	2002-09-04 12:47:02.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/glcompat.c	2004-08-01 22:35:09.000000000 -0700
@@ -6,24 +6,25 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
+#include "SDL.h"
 #include <stdlib.h>
 #include "glinc.h"
 #include "main.h"
 #include "render.h"
 #include "texreg.h"
-#include "memory.h"
+#include "Memory.h"
 #include "glcompat.h"
 #include "gldll.h"
-#include "debug.h"
+#include "Debug.h"
 #include "mouse.h"
 #include "glcaps.h"
 #include "FEColour.h"
-#include "shipview.h"
-#include "launchmgr.h"
-#include "consmgr.h"
-#include "researchgui.h"
-#include "scenpick.h"
-#include "randy.h"
+#include "ShipView.h"
+#include "LaunchMgr.h"
+#include "ConsMgr.h"
+#include "ResearchGUI.h"
+#include "ScenPick.h"
+#include "Randy.h"
 
 
 //magic 2D coordinate adjustment factor
@@ -749,7 +750,7 @@
 ----------------------------------------------------------------------------*/
 void glcDisplayRGBABackgroundScaled(ubyte* surface)
 {
-    sdword handles;
+    sdword handles = 0;
     sdword y, x, yend;
 
     rndTextureEnvironment(RTE_Replace);
@@ -780,7 +781,7 @@
             glcCreateTexture(surface, x, y, -64, yend);
             glcScaledQuadAt(x, 479 - y + (64 - yend) - 64, 64, yend);
         }
-        Sleep(0);
+        SDL_Delay(0);
     }
 
     rndTextureEnable(FALSE);
@@ -800,7 +801,7 @@
 ----------------------------------------------------------------------------*/
 void glcDisplayRGBABackgroundWithoutScaling(ubyte* surface)
 {
-    sdword handles;
+    sdword handles = 0;
     sdword y, x, yend;
     sdword xOfs, yOfs;
 
@@ -835,7 +836,7 @@
             glcCreateTexture(surface, x, y, -64, yend);
             glcQuadAt(xOfs + x, yOfs + 479 - y + (64 - yend) - 64, 64, yend);
         }
-        Sleep(0);
+        SDL_Delay(0);
     }
 
     rndTextureEnable(FALSE);
@@ -904,7 +905,7 @@
 ----------------------------------------------------------------------------*/
 void glcDisplayRGBABackground(ubyte* surface)
 {
-    sdword handles;
+    sdword handles = 0;
     sdword xOfs, yOfs;
     sdword y, x, yend;
 
@@ -1392,7 +1393,7 @@
             {
                 if (glcLaggy && i == 0)
                 {
-                    Sleep(30);
+                    SDL_Delay(30);
                 }
                 glcDisplayRGBABackgroundPortion(glScratch, &glcMouse[index], TRUE);
                 glcPageFlipHelper();
@@ -2167,7 +2168,7 @@
     }
 }
 
-void __stdcall glcDrawPixels(GLsizei width, GLsizei height, GLenum format, GLenum type, GLvoid const* pixels)
+void APIENTRY glcDrawPixels(GLsizei width, GLsizei height, GLenum format, GLenum type, GLvoid const* pixels)
 {
     dbgAssert(glScratch != NULL);
     dbgAssert(pixels != NULL);
@@ -2183,7 +2184,7 @@
     }
 }
 
-void __stdcall glcRasterPos2f(GLfloat x, GLfloat y)
+void APIENTRY glcRasterPos2f(GLfloat x, GLfloat y)
 {
     real32 v[4], eye[4], clip[4];
     real32 viewport[2][2];
@@ -2213,7 +2214,7 @@
     glcRasterPos[1] = (sdword)(ndc[1] * viewport[1][0] + viewport[1][1]);
 }
 
-void __stdcall glcClear(GLbitfield mask)
+void APIENTRY glcClear(GLbitfield mask)
 {
     if ((glScratch != NULL) &&
         (mask & GL_COLOR_BUFFER_BIT))
@@ -2223,7 +2224,7 @@
     _glcClear(mask);
 }
 
-void __stdcall glcColor3ub(GLubyte r, GLubyte g, GLubyte b)
+void APIENTRY glcColor3ub(GLubyte r, GLubyte g, GLubyte b)
 {
     glcColor[0] = (sdword)r;
     glcColor[1] = (sdword)g;
@@ -2231,7 +2232,7 @@
     _glcColor3ub(r, g, b);
 }
 
-void __stdcall glcEnable(GLenum cap)
+void APIENTRY glcEnable(GLenum cap)
 {
     switch (cap)
     {
@@ -2248,7 +2249,7 @@
     _glcEnable(cap);
 }
 
-void __stdcall glcDisable(GLenum cap)
+void APIENTRY glcDisable(GLenum cap)
 {
     switch (cap)
     {
@@ -2360,6 +2361,11 @@
 bool glcActivate(bool active)
 {
     bool lastStatus;
+
+#ifdef _MACOSX_FIX_ME  // without this you get a wacky red front end menu
+    active = FALSE;
+#endif
+
     if (!glCapFeatureExists(GL_SWAPFRIENDLY))
     {
         return glcActiveStatus;
diff -urPw homeworld-orig/src/SDL/gldefines.h homeworld_sdl-0.3/src/SDL/gldefines.h
--- homeworld-orig/src/SDL/gldefines.h	2002-09-04 12:47:02.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/gldefines.h	2004-08-01 22:35:09.000000000 -0700
@@ -1,3 +1,12 @@
+#ifdef _WIN32
+#define WIN32_LEAN_AND_MEAN
+#include <windows.h>
+#endif
+
+#ifndef APIENTRY
+#define APIENTRY
+#endif
+
 /* Extensions */
 #define GL_VERSION_1_1                      1
 #define GL_EXT_abgr                         1
diff -urPw homeworld-orig/src/SDL/gldll.c homeworld_sdl-0.3/src/SDL/gldll.c
--- homeworld-orig/src/SDL/gldll.c	2002-09-04 12:47:02.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/gldll.c	2004-08-01 22:35:06.000000000 -0700
@@ -6,14 +6,24 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include <windows.h>
+#ifdef _MACOSX
+    #include <CoreServices/CoreServices.h>
+#endif
+
+#include "SDL.h"
 #include <stdio.h>
+#include <stdlib.h>
+#include <string.h>
 #include "gldll.h"
 #include "glcaps.h"
-#include "debug.h"
+#include "Debug.h"
 #include "devstats.h"
 #include "main.h"
 
+#ifndef _MACOSX
+    #include <dlfcn.h>
+#endif
+
 extern udword gDevcaps2;
 
 #define WRAPPERS 0
@@ -23,15 +33,28 @@
 #define GENTEX_WRAPPERS 0
 #define DELTEX_WRAPPERS 0
 
+#ifdef _WIN32
+#define GL_LIB_NAME( base )     (#base ".dll")
+#else
+#define GL_LIB_NAME( base )     ("lib" #base ".so")
+#endif
+
 #define _ERROR_WRAP( func ) ((func) != 0) ? DynalinkFailed : (DynalinkFailed |= 1)
 #define _STRINGIZE_NAME(name) #name
 #define _STRINGIZE_NAME0(name) _STRINGIZE_NAME(name)
 #define _WGL_STRINGIZE_NAME( name ) _STRINGIZE_NAME0(wgl##name)
 #define _GL_STRINGIZE_NAME( name) _STRINGIZE_NAME0(gl##name)
 #define _DGL_STRINGIZE_NAME( name ) _STRINGIZE_NAME0(_gl##name)
-#define DYNALINK_GL_FUNCTION( name ) _ERROR_WRAP((*(int (__stdcall **)())&(gl##name)) = GetProcAddress(lib, _GL_STRINGIZE_NAME(name)))
-#define DYNALINK_DGL_FUNCTION( name ) _ERROR_WRAP((*(int (__stdcall **)())&(_gl##name)) = GetProcAddress(lib, _GL_STRINGIZE_NAME(name)))
-#define DYNALINK_WGL_FUNCTION( name) _ERROR_WRAP((*(int (__stdcall **)())&(rwgl##name)) = GetProcAddress(lib, _WGL_STRINGIZE_NAME(name)))
+
+#ifdef _MACOSX
+    #define DYNALINK_GL_FUNCTION( name ) _ERROR_WRAP((*(int (APIENTRY **)())&(gl##name)) = osxGetProcAddress(_GL_STRINGIZE_NAME(name)))
+    #define DYNALINK_DGL_FUNCTION( name ) _ERROR_WRAP((*(int (APIENTRY **)())&(_gl##name)) = osxGetProcAddress(_GL_STRINGIZE_NAME(name)))
+    #define DYNALINK_WGL_FUNCTION( name ) _ERROR_WRAP((*(int (APIENTRY **)())&(rwgl##name)) = osxGetProcAddress(_WGL_STRINGIZE_NAME(name)))
+#else
+    #define DYNALINK_GL_FUNCTION( name ) _ERROR_WRAP((*(int (APIENTRY **)())&(gl##name)) = SDL_GL_GetProcAddress(_GL_STRINGIZE_NAME(name)))
+    #define DYNALINK_DGL_FUNCTION( name ) _ERROR_WRAP((*(int (APIENTRY **)())&(_gl##name)) = SDL_GL_GetProcAddress(_GL_STRINGIZE_NAME(name)))
+    #define DYNALINK_WGL_FUNCTION( name ) _ERROR_WRAP((*(int (APIENTRY **)())&(rwgl##name)) = SDL_GL_GetProcAddress(_WGL_STRINGIZE_NAME(name)))
+#endif // _MACOSX
 
 #if WRAPPERS
 static GLuint lastBound = 0;
@@ -43,7 +66,14 @@
 static GLuint watchedHandles[NUM_WATCHES];
 #endif
 
+/*
+#ifdef _WIN32
 HINSTANCE lib = NULL;
+#else
+int lib = NULL;
+#endif
+*/
+bool bOpenGlLoaded = FALSE;
 
 LOCKARRAYSEXTproc glLockArraysEXT;
 UNLOCKARRAYSEXTproc glUnlockArraysEXT;
@@ -55,7 +85,7 @@
 BINDTEXTUREproc _glBindTexture;
 BITMAPproc glBitmap;
 BLENDFUNCproc glBlendFunc;
-CLEARproc glClear;
+CLEARproc glClear = NULL;
 CLEARCOLORproc glClearColor;
 CLEARDEPTHproc glClearDepth;
 CLEARINDEXproc glClearIndex;
@@ -161,19 +191,60 @@
 ENABLECLIENTSTATEproc glEnableClientState;
 DISABLECLIENTSTATEproc glDisableClientState;
 ARRAYELEMENTproc glArrayElement;
+
+WGETPROCADDRESSproc rwglGetProcAddress;
+WSWAPBUFFERSproc rwglSwapBuffers;
+#ifdef _WIN32
 WCREATECONTEXTproc rwglCreateContext;
 WDELETECONTEXTproc rwglDeleteContext;
-WGETPROCADDRESSproc rwglGetProcAddress;
 WMAKECURRENTproc rwglMakeCurrent;
 WCHOOSEPIXELFORMATproc rwglChoosePixelFormat;
 WSETPIXELFORMATproc rwglSetPixelFormat;
 WGETPIXELFORMATproc rwglGetPixelFormat;
 WDESCRIBEPIXELFORMATproc rwglDescribePixelFormat;
-WSWAPBUFFERSproc rwglSwapBuffers;
+#endif
+
+#ifdef _MACOSX
+char *gDllName = NULL;
+
+void *osxGetProcAddress( char *proc )
+{
+	static Boolean loaded = false;
+
+	// We may want to cache the bundleRef at some point
+    static CFBundleRef bundle = NULL;
+    CFURLRef bundleURL;
+    CFStringRef functionName = CFStringCreateWithCString(kCFAllocatorDefault, proc, kCFStringEncodingASCII);
+    void *function;
+
+	bundleURL = CFURLCreateWithFileSystemPath (kCFAllocatorDefault, CFSTR("/System/Library/Frameworks/OpenGL.framework"), kCFURLPOSIXPathStyle, true);
+//                                                        CFSTR("librgl.so.bundle"), kCFURLPOSIXPathStyle, true);
+
+	if( !bundle )
+	{
+		bundle = CFBundleCreate (kCFAllocatorDefault, bundleURL);
+		assert (bundle != NULL);
+	}
+
+	if( !loaded )
+	{
+		loaded = CFBundleLoadExecutable( bundle );
+		assert( loaded );
+	}
+
+    function = CFBundleGetFunctionPointerForName (bundle, functionName);
+
+    CFRelease ( bundleURL );
+    CFRelease ( functionName );
+//    CFRelease ( bundle );
+
+    return function;
+}
+#endif // _MACOSX
 
 #if VERTEX_WRAPPERS
 FILE* vout;
-void __stdcall myVertex3fv(GLfloat const* v)
+void APIENTRY myVertex3fv(GLfloat const* v)
 {
     static GLfloat last[3];
     static GLfloat current[3];
@@ -198,7 +269,7 @@
 #endif
 
 #if WRAPPERS
-void __stdcall myBindTexture(GLenum target, GLuint textureName)
+void APIENTRY myBindTexture(GLenum target, GLuint textureName)
 {
     if (textureName == lastBound)
     {
@@ -212,20 +283,26 @@
 #if GENTEX_WRAPPERS
 static FILE* genOut = NULL;
 #if 1
-void __stdcall myGenTextures(GLsizei n, GLuint* textureNames)
+void APIENTRY myGenTextures(GLsizei n, GLuint* textureNames)
 {
     _glGenTextures(n, textureNames);
     glFlush();
 }
 #else
-void __stdcall myGenTextures(GLsizei n, GLuint* textureNames)
+void APIENTRY myGenTextures(GLsizei n, GLuint* textureNames)
 {
+    char *genOutFileName;
     int i;
 
     _glGenTextures(n, textureNames);
     if (genOut == NULL)
     {
-        genOut = fopen("gentex.txt", "wt");
+        genOutFileName = filePathPrepend("gentex.txt", FF_UserSettingsPath);
+
+        if (!fileMakeDestinationDirectory(genOutFileName))
+            return;
+
+        genOut = fopen(genOutFileName, "wt");
         if (genOut == NULL)
         {
             return;
@@ -242,7 +319,7 @@
 #endif //GENTEX_WRAPPERS
 
 #if DELTEX_WRAPPERS
-void __stdcall myDeleteTextures(GLsizei n, GLuint const* textures)
+void APIENTRY myDeleteTextures(GLsizei n, GLuint const* textures)
 {
     _glDeleteTextures(n, textures);
     glFlush();
@@ -251,7 +328,7 @@
 
 #if BEGIN_WRAPPERS
 static GLenum currentPrimitive = GL_NONE;
-void __stdcall myBegin(GLenum primitive)
+void APIENTRY myBegin(GLenum primitive)
 {
     if (primitive == GL_LINES ||
         primitive == GL_LINE_STRIP ||
@@ -276,7 +353,7 @@
 }
 
 #if TEXIMAGE_WRAPPERS
-void __stdcall myTexImage2D(GLenum target, GLint level, GLint internalFormat,
+void APIENTRY myTexImage2D(GLenum target, GLint level, GLint internalFormat,
                             GLsizei width, GLsizei height, GLint border,
                             GLenum format, GLenum type,
                             GLvoid const* pixels)
@@ -300,7 +377,7 @@
 }
 #endif
 
-void __stdcall noDitheredAlphaEnable(GLenum cap)
+void APIENTRY noDitheredAlphaEnable(GLenum cap)
 {
     if (cap == GL_BLEND)
     {
@@ -313,7 +390,7 @@
     }
 }
 
-void __stdcall noDitheredAlphaDisable(GLenum cap)
+void APIENTRY noDitheredAlphaDisable(GLenum cap)
 {
     if (cap == GL_BLEND)
     {
@@ -357,7 +434,7 @@
 {
     int DynalinkFailed = 0;
 
-    if (lib == NULL)
+    if (!bOpenGlLoaded)
     {
         return;
     }
@@ -392,19 +469,32 @@
 extern bool mainAllow3DNow;
 
 #define glDLLEnvironment() \
-    _putenv("FX_GLIDE_NO_SPLASH=1");\
+    putenv("FX_GLIDE_NO_SPLASH=1");\
     if (!mainAllow3DNow)\
     {\
-        _putenv("__GL_FORCE_K3D=0");\
+        putenv("__GL_FORCE_K3D=0");\
     }\
     if (!mainAllowKatmai)\
     {\
-        _putenv("__GL_FORCE_KNI=0");\
+        putenv("__GL_FORCE_KNI=0");\
     }
 
+/* TC 2003-10-01:
+ * I've made attempts to provide dummy functions in rgl to make SDL believe it
+ * is a valid OpenGL implementation.  Only SDL_GL_LoadLibrary() and
+ * SDL_GL_GetProcAddress() are expected to work properly; SDL_GL_SwapBuffers()
+ * should only be called if you know the DLL is actually an OpenGL DLL and not
+ * an rgl DLL (check the value of the "RGL" global variable).
+ *
+ * This currently only works with WGL (Windows) and glX.
+ */
 GLboolean glDLLGetProcs(char* dllName)
 {
     int DynalinkFailed = 0;
+    Uint32 sdl_flags;
+#if VERTEX_WRAPPERS
+    char *voutFileName;
+#endif
 
 #if TEXIMAGE_WRAPPERS
     int index;
@@ -418,7 +508,11 @@
 
     if (strstr(dllName, "3dfx") != NULL ||
         strstr(dllName, "3Dfx") != NULL ||
+#ifdef _WIN32
         strstr(dllName, "dll\\") != NULL)
+#else
+        strstr(dllName, "dll/") != NULL)
+#endif
     {
         glDLL3Dfx = GL_TRUE;
     }
@@ -427,17 +521,28 @@
         glDLL3Dfx = GL_FALSE;
     }
 
+    /* Make sure SDL video is initialized. */
+    sdl_flags = SDL_WasInit(SDL_INIT_EVERYTHING);
+    if (!sdl_flags)
+    {
+        if (SDL_Init(SDL_INIT_VIDEO) == -1)
+            return GL_FALSE;
+    }
+    else if (!(sdl_flags & SDL_INIT_VIDEO))
+    {
+        if (SDL_InitSubSystem(SDL_INIT_VIDEO) == -1)
+            return GL_FALSE;
+    }
+
     if (!glNT && glDLL3Dfx)
     {
         glDLLEnvironment();
         //try installed 3dfx GL first
-        lib = LoadLibrary("3dfxvgl.dll");
-        if (lib == NULL)
+        if (SDL_GL_LoadLibrary(GL_LIB_NAME(3dfxvgl)) == -1)
         {
             //not there, try our own
             glDLLEnvironment();
-            lib = LoadLibrary(dllName);
-            if (lib == NULL)
+            if (SDL_GL_LoadLibrary(dllName) == -1)
             {
                 return GL_FALSE;
             }
@@ -446,16 +551,41 @@
     else
     {
         glDLLEnvironment();
+
+        #if 0 // #ifdef _MACOSX_FIX_ME
+        // On OS X SDL_GL_LoadLibrary does nothing, so we must check if the given dll exists.
+        {
+		    FILE *dll_test = fopen( "librgl.so.bundle", "rb" );
+		    if( dll_test )
+			    fclose( dll_test );
+		    else
+    		{
+	    		fprintf( stderr, "Cannot load %s library\n", dllName );
+		    	return GL_FALSE;
+	    	}
+	    }
+        #endif
+
         //try loading the .DLL
-        lib = LoadLibrary(dllName);
-        if (lib == NULL)
+        if (SDL_GL_LoadLibrary(dllName) == -1)
         {
+            fprintf(stderr, "SDL_GL_LoadLibrary(%s): %s\n",
+                dllName, SDL_GetError());
             return GL_FALSE;
         }
     }
 
+    bOpenGlLoaded = TRUE;
+
 #if VERTEX_WRAPPERS
-    vout = fopen("vout.dat", "wt");
+    voutFileName = filePathPrepend("vout.dat", FF_UserSettingsPath);
+
+    if (fileMakeDestinationDirectory(voutFileName))
+        vout = fopen(voutFileName, "wt");
+#endif
+
+#ifdef _MACOSX_FIX_ME
+	gDllName = dllName;
 #endif
 
     DYNALINK_GL_FUNCTION(AlphaFunc);
@@ -482,7 +612,11 @@
     DYNALINK_GL_FUNCTION(Color4f);
     DYNALINK_GL_FUNCTION(Color4ub);
     DYNALINK_GL_FUNCTION(ColorMask);
-    glColorTable = (COLORTABLEproc)GetProcAddress(lib, "glColorTableEXT");
+#ifdef _MACOSX
+	glColorTable = (COLORTABLEproc)osxGetProcAddress("glColorTableEXT");
+#else
+    glColorTable = (COLORTABLEproc)SDL_GL_GetProcAddress("glColorTableEXT");
+#endif // _MACOSX
     DYNALINK_GL_FUNCTION(CullFace);
     DYNALINK_DGL_FUNCTION(DeleteTextures);
 #if DELTEX_WRAPPERS
@@ -608,6 +742,7 @@
         return GL_FALSE;
     }
 
+#if 0
     DYNALINK_WGL_FUNCTION(CreateContext);
     DYNALINK_WGL_FUNCTION(DeleteContext);
     DYNALINK_WGL_FUNCTION(GetProcAddress);
@@ -622,6 +757,18 @@
     {
         return GL_FALSE;
     }
+#endif
+
+#ifdef _MACOSX
+	rwglGetProcAddress = (WGETPROCADDRESSproc)osxGetProcAddress;
+#else
+    rwglGetProcAddress = (WGETPROCADDRESSproc)SDL_GL_GetProcAddress("rglGetProcAddress");
+    if (!rwglGetProcAddress)
+    {
+        /* Not an RGL lib, must be regular OpenGL. */
+        rwglGetProcAddress = (WGETPROCADDRESSproc)SDL_GL_GetProcAddress;
+    }
+#endif // _MACOSX
 
     DYNALINK_GL_FUNCTION(LockArraysEXT);
     DYNALINK_GL_FUNCTION(UnlockArraysEXT);
diff -urPw homeworld-orig/src/SDL/gldll.h homeworld_sdl-0.3/src/SDL/gldll.h
--- homeworld-orig/src/SDL/gldll.h	2002-09-04 12:47:02.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/gldll.h	2004-08-01 22:35:06.000000000 -0700
@@ -29,122 +29,126 @@
 
 #include "gldefines.h"
 
-typedef void (__stdcall * LOCKARRAYSEXTproc)(GLint, GLint);
-typedef void (__stdcall * UNLOCKARRAYSEXTproc)(void);
+typedef void (APIENTRY * LOCKARRAYSEXTproc)(GLint, GLint);
+typedef void (APIENTRY * UNLOCKARRAYSEXTproc)(void);
 
-typedef void (__stdcall * ALPHAFUNCproc)(GLenum, GLclampf);
-typedef void (__stdcall * BEGINproc)(GLenum);
-typedef void (__stdcall * BINDTEXTUREproc)(GLenum, GLuint);
-typedef void (__stdcall * BITMAPproc)(GLsizei, GLsizei, GLfloat, GLfloat, GLfloat, GLfloat, GLubyte const*);
-typedef void (__stdcall * BLENDFUNCproc)(GLenum, GLenum);
-typedef void (__stdcall * CLEARproc)(GLbitfield);
-typedef void (__stdcall * CLEARCOLORproc)(GLclampf, GLclampf, GLclampf, GLclampf);
-typedef void (__stdcall * CLEARDEPTHproc)(GLclampd);
-typedef void (__stdcall * CLEARINDEXproc)(GLfloat);
-typedef void (__stdcall * COLOR3Fproc)(GLfloat, GLfloat, GLfloat);
-typedef void (__stdcall * COLOR3UBproc)(GLubyte, GLubyte, GLubyte);
-typedef void (__stdcall * COLOR4Fproc)(GLfloat, GLfloat, GLfloat, GLfloat);
-typedef void (__stdcall * COLOR4UBproc)(GLubyte, GLubyte, GLubyte, GLubyte);
-typedef void (__stdcall * COLORMASKproc)(GLboolean, GLboolean, GLboolean, GLboolean);
-typedef void (__stdcall * COLORTABLEproc)(GLenum, GLenum, GLsizei, GLenum, GLenum, GLvoid const*);
-typedef void (__stdcall * CULLFACEproc)(GLenum);
-typedef void (__stdcall * DELETETEXTURESproc)(GLsizei, GLuint const*);
-typedef void (__stdcall * DEPTHFUNCproc)(GLenum);
-typedef void (__stdcall * DEPTHMASKproc)(GLboolean);
-typedef void (__stdcall * DEPTHRANGEproc)(GLclampd, GLclampd);
-typedef void (__stdcall * DISABLEproc)(GLenum);
-typedef void (__stdcall * DRAWARRAYSproc)(GLenum, GLint, GLsizei);
-typedef void (__stdcall * DRAWELEMENTSproc)(GLenum, GLsizei, GLenum, GLvoid const*);
-typedef void (__stdcall * DRAWBUFFERproc)(GLenum);
-typedef void (__stdcall * DRAWPIXELSproc)(GLsizei, GLsizei, GLenum, GLenum, GLvoid const*);
-typedef void (__stdcall * ENABLEproc)(GLenum);
-typedef void (__stdcall * ENDproc)(void);
-typedef void (__stdcall * EVALCOORD1Fproc)(GLfloat);
-typedef void (__stdcall * EVALCOORD2Fproc)(GLfloat, GLfloat);
-typedef void (__stdcall * EVALMESH1proc)(GLenum, GLint, GLint);
-typedef void (__stdcall * EVALMESH2proc)(GLenum, GLint, GLint, GLint, GLint);
-typedef void (__stdcall * EVALPOINT1proc)(GLint);
-typedef void (__stdcall * EVALPOINT2proc)(GLint, GLint);
-typedef void (__stdcall * FLUSHproc)(void);
-typedef void (__stdcall * FOGFproc)(GLenum, GLfloat);
-typedef void (__stdcall * FOGFVproc)(GLenum, GLfloat const*);
-typedef void (__stdcall * FOGIproc)(GLenum, GLint);
-typedef void (__stdcall * FRUSTUMproc)(GLdouble, GLdouble, GLdouble, GLdouble, GLdouble, GLdouble);
-typedef void (__stdcall * GENTEXTURESproc)(GLsizei, GLuint*);
-typedef void (__stdcall * GETDOUBLEVproc)(GLenum, GLdouble*);
-typedef GLenum (__stdcall * GETERRORproc)(void);
-typedef void (__stdcall * GETFLOATVproc)(GLenum, GLfloat*);
-typedef void (__stdcall * GETINTEGERVproc)(GLenum, GLint*);
-typedef void (__stdcall * GETBOOLEANVproc)(GLenum, GLboolean*);
-typedef GLubyte const* (__stdcall * GETSTRINGproc)(GLenum);
-typedef void (__stdcall * GETTEXLEVELPARAMETERIVproc)(GLenum, GLint, GLenum, GLint*);
-typedef void (__stdcall * HINTproc)(GLenum, GLenum);
-typedef void (__stdcall * INTERLEAVEDARRAYSproc)(GLenum, GLsizei, GLvoid const*);
-typedef GLboolean (__stdcall * ISENABLEDproc)(GLenum);
-typedef void (__stdcall * LIGHTMODELFproc)(GLenum, GLfloat);
-typedef void (__stdcall * LIGHTMODELFVproc)(GLenum, GLfloat const*);
-typedef void (__stdcall * LIGHTMODELIproc)(GLenum, GLint);
-typedef void (__stdcall * LIGHTFVproc)(GLenum, GLenum, GLfloat const*);
-typedef void (__stdcall * LINESTIPPLEproc)(GLint, GLushort);
-typedef void (__stdcall * LINEWIDTHproc)(GLfloat);
-typedef void (__stdcall * LOADIDENTITYproc)(void);
-typedef void (__stdcall * LOADMATRIXFproc)(GLfloat const*);
-typedef void (__stdcall * MAP1Fproc)(GLenum, GLfloat, GLfloat, GLint, GLint, GLfloat const*);
-typedef void (__stdcall * MAP2Fproc)(GLenum, GLfloat, GLfloat, GLint, GLint, GLfloat, GLfloat, GLint, GLint, GLfloat const*);
-typedef void (__stdcall * MAPGRID1Fproc)(GLint, GLfloat, GLfloat);
-typedef void (__stdcall * MAPGRID2Dproc)(GLint, GLdouble, GLdouble, GLint, GLdouble, GLdouble);
-typedef void (__stdcall * MATERIALFVproc)(GLenum, GLenum, GLfloat const*);
-typedef void (__stdcall * MATRIXMODEproc)(GLenum);
-typedef void (__stdcall * MULTMATRIXDproc)(GLdouble const*);
-typedef void (__stdcall * MULTMATRIXFproc)(GLfloat const*);
-typedef void (__stdcall * NORMAL3Fproc)(GLfloat, GLfloat, GLfloat);
-typedef void (__stdcall * NORMAL3FVproc)(GLfloat*);
-typedef void (__stdcall * ORTHOproc)(GLdouble, GLdouble, GLdouble, GLdouble, GLdouble, GLdouble);
-typedef void (__stdcall * PIXELSTOREIproc)(GLenum, GLint);
-typedef void (__stdcall * PIXELTRANSFERFproc)(GLenum, GLfloat);
-typedef void (__stdcall * POINTSIZEproc)(GLfloat);
-typedef void (__stdcall * POLYGONMODEproc)(GLenum, GLenum);
-typedef void (__stdcall * POPATTRIBproc)(void);
-typedef void (__stdcall * POPMATRIXproc)(void);
-typedef void (__stdcall * PUSHATTRIBproc)(GLbitfield);
-typedef void (__stdcall * PUSHMATRIXproc)(void);
-typedef void (__stdcall * RASTERPOS2Fproc)(GLfloat, GLfloat);
-typedef void (__stdcall * RASTERPOS2Iproc)(GLint, GLint);
-typedef void (__stdcall * RASTERPOS4Fproc)(GLfloat, GLfloat, GLfloat, GLfloat);
-typedef void (__stdcall * READBUFFERproc)(GLenum);
-typedef void (__stdcall * READPIXELSproc)(GLint, GLint, GLsizei, GLsizei, GLenum, GLenum, GLvoid*);
-typedef void (__stdcall * ROTATEFproc)(GLfloat, GLfloat, GLfloat, GLfloat);
-typedef void (__stdcall * SCALEFproc)(GLfloat, GLfloat, GLfloat);
-typedef void (__stdcall * SCISSORproc)(GLint, GLint, GLsizei, GLsizei);
-typedef void (__stdcall * SHADEMODELproc)(GLenum);
-typedef void (__stdcall * TEXCOORD2Fproc)(GLfloat, GLfloat);
-typedef void (__stdcall * TEXENVIproc)(GLenum, GLenum, GLint);
-typedef void (__stdcall * TEXIMAGE1Dproc)(GLenum, GLint, GLint, GLsizei, GLint, GLenum, GLenum, GLvoid const*);
-typedef void (__stdcall * TEXIMAGE2Dproc)(GLenum, GLint, GLint, GLsizei, GLsizei, GLint, GLenum, GLenum, GLvoid const*);
-typedef void (__stdcall * TEXPARAMETERIproc)(GLenum, GLenum, GLint);
-typedef void (__stdcall * TRANSLATEDproc)(GLdouble, GLdouble, GLdouble);
-typedef void (__stdcall * TRANSLATEFproc)(GLfloat, GLfloat, GLfloat);
-typedef void (__stdcall * VERTEX2Fproc)(GLfloat, GLfloat);
-typedef void (__stdcall * VERTEX2Iproc)(GLint, GLint);
-typedef void (__stdcall * VERTEX3Fproc)(GLfloat, GLfloat, GLfloat);
-typedef void (__stdcall * VERTEX3FVproc)(GLfloat const*);
-typedef void (__stdcall * VERTEX4FVproc)(GLfloat const*);
-typedef void (__stdcall * VIEWPORTproc)(GLint, GLint, GLsizei, GLsizei);
-typedef void (__stdcall * CLIPPLANEproc)(GLenum, GLdouble const*);
-typedef void (__stdcall * GETTEXIMAGEproc)(GLenum, GLint, GLenum, GLenum, GLvoid*);
-typedef void (__stdcall * VERTEXPOINTERproc)(GLint, GLenum, GLsizei, GLvoid const*);
-typedef void (__stdcall * ENABLECLIENTSTATEproc)(GLenum);
-typedef void (__stdcall * DISABLECLIENTSTATEproc)(GLenum);
-typedef void (__stdcall * ARRAYELEMENTproc)(GLint);
-typedef unsigned int (__stdcall * WCREATECONTEXTproc)(int);
-typedef unsigned int (__stdcall * WDELETECONTEXTproc)(int);
-typedef WGLPROC (__stdcall * WGETPROCADDRESSproc)(char*);
-typedef unsigned int (__stdcall * WMAKECURRENTproc)(int, int);
-typedef int (__stdcall * WCHOOSEPIXELFORMATproc)(HDC, PIXELFORMATDESCRIPTOR const*);
-typedef BOOL (__stdcall * WSETPIXELFORMATproc)(HDC, int, PIXELFORMATDESCRIPTOR const*);
-typedef int (__stdcall * WGETPIXELFORMATproc)(HDC);
-typedef int (__stdcall * WDESCRIBEPIXELFORMATproc)(HDC, int, UINT, LPPIXELFORMATDESCRIPTOR);
-typedef BOOL (__stdcall * WSWAPBUFFERSproc)(HDC);
+typedef void (APIENTRY * ALPHAFUNCproc)(GLenum, GLclampf);
+typedef void (APIENTRY * BEGINproc)(GLenum);
+typedef void (APIENTRY * BINDTEXTUREproc)(GLenum, GLuint);
+typedef void (APIENTRY * BITMAPproc)(GLsizei, GLsizei, GLfloat, GLfloat, GLfloat, GLfloat, GLubyte const*);
+typedef void (APIENTRY * BLENDFUNCproc)(GLenum, GLenum);
+typedef void (APIENTRY * CLEARproc)(GLbitfield);
+typedef void (APIENTRY * CLEARCOLORproc)(GLclampf, GLclampf, GLclampf, GLclampf);
+typedef void (APIENTRY * CLEARDEPTHproc)(GLclampd);
+typedef void (APIENTRY * CLEARINDEXproc)(GLfloat);
+typedef void (APIENTRY * COLOR3Fproc)(GLfloat, GLfloat, GLfloat);
+typedef void (APIENTRY * COLOR3UBproc)(GLubyte, GLubyte, GLubyte);
+typedef void (APIENTRY * COLOR4Fproc)(GLfloat, GLfloat, GLfloat, GLfloat);
+typedef void (APIENTRY * COLOR4UBproc)(GLubyte, GLubyte, GLubyte, GLubyte);
+typedef void (APIENTRY * COLORMASKproc)(GLboolean, GLboolean, GLboolean, GLboolean);
+typedef void (APIENTRY * COLORTABLEproc)(GLenum, GLenum, GLsizei, GLenum, GLenum, GLvoid const*);
+typedef void (APIENTRY * CULLFACEproc)(GLenum);
+typedef void (APIENTRY * DELETETEXTURESproc)(GLsizei, GLuint const*);
+typedef void (APIENTRY * DEPTHFUNCproc)(GLenum);
+typedef void (APIENTRY * DEPTHMASKproc)(GLboolean);
+typedef void (APIENTRY * DEPTHRANGEproc)(GLclampd, GLclampd);
+typedef void (APIENTRY * DISABLEproc)(GLenum);
+typedef void (APIENTRY * DRAWARRAYSproc)(GLenum, GLint, GLsizei);
+typedef void (APIENTRY * DRAWELEMENTSproc)(GLenum, GLsizei, GLenum, GLvoid const*);
+typedef void (APIENTRY * DRAWBUFFERproc)(GLenum);
+typedef void (APIENTRY * DRAWPIXELSproc)(GLsizei, GLsizei, GLenum, GLenum, GLvoid const*);
+typedef void (APIENTRY * ENABLEproc)(GLenum);
+typedef void (APIENTRY * ENDproc)(void);
+typedef void (APIENTRY * EVALCOORD1Fproc)(GLfloat);
+typedef void (APIENTRY * EVALCOORD2Fproc)(GLfloat, GLfloat);
+typedef void (APIENTRY * EVALMESH1proc)(GLenum, GLint, GLint);
+typedef void (APIENTRY * EVALMESH2proc)(GLenum, GLint, GLint, GLint, GLint);
+typedef void (APIENTRY * EVALPOINT1proc)(GLint);
+typedef void (APIENTRY * EVALPOINT2proc)(GLint, GLint);
+typedef void (APIENTRY * FLUSHproc)(void);
+typedef void (APIENTRY * FOGFproc)(GLenum, GLfloat);
+typedef void (APIENTRY * FOGFVproc)(GLenum, GLfloat const*);
+typedef void (APIENTRY * FOGIproc)(GLenum, GLint);
+typedef void (APIENTRY * FRUSTUMproc)(GLdouble, GLdouble, GLdouble, GLdouble, GLdouble, GLdouble);
+typedef void (APIENTRY * GENTEXTURESproc)(GLsizei, GLuint*);
+typedef void (APIENTRY * GETDOUBLEVproc)(GLenum, GLdouble*);
+typedef GLenum (APIENTRY * GETERRORproc)(void);
+typedef void (APIENTRY * GETFLOATVproc)(GLenum, GLfloat*);
+typedef void (APIENTRY * GETINTEGERVproc)(GLenum, GLint*);
+typedef void (APIENTRY * GETBOOLEANVproc)(GLenum, GLboolean*);
+typedef GLubyte const* (APIENTRY * GETSTRINGproc)(GLenum);
+typedef void (APIENTRY * GETTEXLEVELPARAMETERIVproc)(GLenum, GLint, GLenum, GLint*);
+typedef void (APIENTRY * HINTproc)(GLenum, GLenum);
+typedef void (APIENTRY * INTERLEAVEDARRAYSproc)(GLenum, GLsizei, GLvoid const*);
+typedef GLboolean (APIENTRY * ISENABLEDproc)(GLenum);
+typedef void (APIENTRY * LIGHTMODELFproc)(GLenum, GLfloat);
+typedef void (APIENTRY * LIGHTMODELFVproc)(GLenum, GLfloat const*);
+typedef void (APIENTRY * LIGHTMODELIproc)(GLenum, GLint);
+typedef void (APIENTRY * LIGHTFVproc)(GLenum, GLenum, GLfloat const*);
+typedef void (APIENTRY * LINESTIPPLEproc)(GLint, GLushort);
+typedef void (APIENTRY * LINEWIDTHproc)(GLfloat);
+typedef void (APIENTRY * LOADIDENTITYproc)(void);
+typedef void (APIENTRY * LOADMATRIXFproc)(GLfloat const*);
+typedef void (APIENTRY * MAP1Fproc)(GLenum, GLfloat, GLfloat, GLint, GLint, GLfloat const*);
+typedef void (APIENTRY * MAP2Fproc)(GLenum, GLfloat, GLfloat, GLint, GLint, GLfloat, GLfloat, GLint, GLint, GLfloat const*);
+typedef void (APIENTRY * MAPGRID1Fproc)(GLint, GLfloat, GLfloat);
+typedef void (APIENTRY * MAPGRID2Dproc)(GLint, GLdouble, GLdouble, GLint, GLdouble, GLdouble);
+typedef void (APIENTRY * MATERIALFVproc)(GLenum, GLenum, GLfloat const*);
+typedef void (APIENTRY * MATRIXMODEproc)(GLenum);
+typedef void (APIENTRY * MULTMATRIXDproc)(GLdouble const*);
+typedef void (APIENTRY * MULTMATRIXFproc)(GLfloat const*);
+typedef void (APIENTRY * NORMAL3Fproc)(GLfloat, GLfloat, GLfloat);
+typedef void (APIENTRY * NORMAL3FVproc)(GLfloat*);
+typedef void (APIENTRY * ORTHOproc)(GLdouble, GLdouble, GLdouble, GLdouble, GLdouble, GLdouble);
+typedef void (APIENTRY * PIXELSTOREIproc)(GLenum, GLint);
+typedef void (APIENTRY * PIXELTRANSFERFproc)(GLenum, GLfloat);
+typedef void (APIENTRY * POINTSIZEproc)(GLfloat);
+typedef void (APIENTRY * POLYGONMODEproc)(GLenum, GLenum);
+typedef void (APIENTRY * POPATTRIBproc)(void);
+typedef void (APIENTRY * POPMATRIXproc)(void);
+typedef void (APIENTRY * PUSHATTRIBproc)(GLbitfield);
+typedef void (APIENTRY * PUSHMATRIXproc)(void);
+typedef void (APIENTRY * RASTERPOS2Fproc)(GLfloat, GLfloat);
+typedef void (APIENTRY * RASTERPOS2Iproc)(GLint, GLint);
+typedef void (APIENTRY * RASTERPOS4Fproc)(GLfloat, GLfloat, GLfloat, GLfloat);
+typedef void (APIENTRY * READBUFFERproc)(GLenum);
+typedef void (APIENTRY * READPIXELSproc)(GLint, GLint, GLsizei, GLsizei, GLenum, GLenum, GLvoid*);
+typedef void (APIENTRY * ROTATEFproc)(GLfloat, GLfloat, GLfloat, GLfloat);
+typedef void (APIENTRY * SCALEFproc)(GLfloat, GLfloat, GLfloat);
+typedef void (APIENTRY * SCISSORproc)(GLint, GLint, GLsizei, GLsizei);
+typedef void (APIENTRY * SHADEMODELproc)(GLenum);
+typedef void (APIENTRY * TEXCOORD2Fproc)(GLfloat, GLfloat);
+typedef void (APIENTRY * TEXENVIproc)(GLenum, GLenum, GLint);
+typedef void (APIENTRY * TEXIMAGE1Dproc)(GLenum, GLint, GLint, GLsizei, GLint, GLenum, GLenum, GLvoid const*);
+typedef void (APIENTRY * TEXIMAGE2Dproc)(GLenum, GLint, GLint, GLsizei, GLsizei, GLint, GLenum, GLenum, GLvoid const*);
+typedef void (APIENTRY * TEXPARAMETERIproc)(GLenum, GLenum, GLint);
+typedef void (APIENTRY * TRANSLATEDproc)(GLdouble, GLdouble, GLdouble);
+typedef void (APIENTRY * TRANSLATEFproc)(GLfloat, GLfloat, GLfloat);
+typedef void (APIENTRY * VERTEX2Fproc)(GLfloat, GLfloat);
+typedef void (APIENTRY * VERTEX2Iproc)(GLint, GLint);
+typedef void (APIENTRY * VERTEX3Fproc)(GLfloat, GLfloat, GLfloat);
+typedef void (APIENTRY * VERTEX3FVproc)(GLfloat const*);
+typedef void (APIENTRY * VERTEX4FVproc)(GLfloat const*);
+typedef void (APIENTRY * VIEWPORTproc)(GLint, GLint, GLsizei, GLsizei);
+typedef void (APIENTRY * CLIPPLANEproc)(GLenum, GLdouble const*);
+typedef void (APIENTRY * GETTEXIMAGEproc)(GLenum, GLint, GLenum, GLenum, GLvoid*);
+typedef void (APIENTRY * VERTEXPOINTERproc)(GLint, GLenum, GLsizei, GLvoid const*);
+typedef void (APIENTRY * ENABLECLIENTSTATEproc)(GLenum);
+typedef void (APIENTRY * DISABLECLIENTSTATEproc)(GLenum);
+typedef void (APIENTRY * ARRAYELEMENTproc)(GLint);
+
+typedef WGLPROC (APIENTRY * WGETPROCADDRESSproc)(char*);
+typedef void (APIENTRY * WSWAPBUFFERSproc)(void);
+#ifdef _WIN32
+typedef unsigned int (APIENTRY * WCREATECONTEXTproc)(int);
+typedef unsigned int (APIENTRY * WDELETECONTEXTproc)(int);
+typedef unsigned int (APIENTRY * WMAKECURRENTproc)(int, int);
+typedef int (APIENTRY * WCHOOSEPIXELFORMATproc)(HDC, PIXELFORMATDESCRIPTOR const*);
+typedef BOOL (APIENTRY * WSETPIXELFORMATproc)(HDC, int, PIXELFORMATDESCRIPTOR const*);
+typedef int (APIENTRY * WGETPIXELFORMATproc)(HDC);
+typedef int (APIENTRY * WDESCRIBEPIXELFORMATproc)(HDC, int, UINT, LPPIXELFORMATDESCRIPTOR);
+typedef BOOL (APIENTRY * WSWAPBUFFERSproc)(HDC);
+#endif
 
 extern LOCKARRAYSEXTproc glLockArraysEXT;
 extern UNLOCKARRAYSEXTproc glUnlockArraysEXT;
@@ -254,15 +258,17 @@
 extern DISABLECLIENTSTATEproc glDisableClientState;
 extern ARRAYELEMENTproc glArrayElement;
 
+extern WGETPROCADDRESSproc rwglGetProcAddress;
+#if 0	/* Trying to phase these out... */
 extern WCREATECONTEXTproc rwglCreateContext;
 extern WDELETECONTEXTproc rwglDeleteContext;
-extern WGETPROCADDRESSproc rwglGetProcAddress;
 extern WMAKECURRENTproc rwglMakeCurrent;
 extern WCHOOSEPIXELFORMATproc rwglChoosePixelFormat;
 extern WSETPIXELFORMATproc rwglSetPixelFormat;
 extern WGETPIXELFORMATproc rwglGetPixelFormat;
 extern WDESCRIBEPIXELFORMATproc rwglDescribePixelFormat;
 extern WSWAPBUFFERSproc rwglSwapBuffers;
+#endif
 
 extern GLboolean glDLL3Dfx;
 
diff -urPw homeworld-orig/src/SDL/glinc.h homeworld_sdl-0.3/src/SDL/glinc.h
--- homeworld-orig/src/SDL/glinc.h	2002-09-04 12:47:02.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/glinc.h	2004-08-01 22:35:06.000000000 -0700
@@ -1,7 +1,10 @@
 #ifndef __GLINC_H
 #define __GLINC_H
 
+#ifdef _WIN32
+#define WIN32_LEAN_AND_MEAN
 #include <windows.h>
+#endif
 
 #include "gldll.h"
 #include "rglu.h"
Only in homeworld-orig/src/SDL: Homeworld.ex
Only in homeworld-orig/src/SDL: Homeworld.ico
Only in homeworld-orig/src/SDL: HomeworldLogo.ico
Only in homeworld-orig/src/SDL: Homeworld.mif
Only in homeworld-orig/src/SDL: Homeworld.rc
Only in homeworld-orig/src/SDL: hw.mak
Only in homeworld-orig/src/SDL: Interim.depend
diff -urPw homeworld-orig/src/SDL/light.c homeworld_sdl-0.3/src/SDL/light.c
--- homeworld-orig/src/SDL/light.c	2002-09-04 12:47:02.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/light.c	2004-08-01 22:35:05.000000000 -0700
@@ -6,24 +6,23 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#define WIN32_LEAN_AND_MEAN
-#include <windows.h>
 #include "glinc.h"
 #include <stdlib.h>
 #include <stdio.h>
 #include <string.h>
 #include <math.h>
-#include "types.h"
-#include "debug.h"
-#include "statscript.h"
-#include "globals.h"
-#include "vector.h"
+#include <limits.h>
+#include "Types.h"
+#include "Debug.h"
+#include "StatScript.h"
+#include "Globals.h"
+#include "Vector.h"
 #include "light.h"
-#include "file.h"
-#include "memory.h"
-#include "mex.h"
+#include "File.h"
+#include "Memory.h"
+#include "MEX.h"
 
-#include "shader.h"
+#include "Shader.h"
 
 /*=============================================================================
     Data:
@@ -80,7 +79,7 @@
     { NULL,NULL, NULL}
 };
 
-char lightCurrentLighting[_MAX_PATH];
+char lightCurrentLighting[PATH_MAX];
 
 /*=============================================================================
     Private script-parsing functions:
@@ -318,6 +317,12 @@
         fileLoad(fileName, buf, 0);
 
         hsfHeader = (HSFFileHeader*)buf;
+
+#ifdef ENDIAN_BIG
+		hsfHeader->version = LittleLong( hsfHeader->version );
+		hsfHeader->nLights = LittleLong( hsfHeader->nLights );
+#endif
+
         numLights = 0;
         while (pos <= (sdword)(fileSize - sizeof(HSFLight)))
         {
@@ -325,6 +330,19 @@
 
             hsfLight = (HSFLight*)(buf + pos);
 
+#ifdef ENDIAN_BIG
+			hsfLight->type      = LittleLong( hsfLight->type );
+			hsfLight->x         = LittleFloat( hsfLight->x );
+			hsfLight->y         = LittleFloat( hsfLight->y );
+			hsfLight->z         = LittleFloat( hsfLight->z );
+			hsfLight->h         = LittleFloat( hsfLight->h );
+			hsfLight->p         = LittleFloat( hsfLight->p );
+			hsfLight->b         = LittleFloat( hsfLight->b );
+			hsfLight->coneAngle = LittleFloat( hsfLight->coneAngle );
+			hsfLight->edgeAngle = LittleFloat( hsfLight->edgeAngle );
+			hsfLight->intensity = LittleFloat( hsfLight->intensity );
+#endif
+
             if (hsfLight->type != L_AmbientLight)
             {
                 numLights++;
diff -urPw homeworld-orig/src/SDL/light.h homeworld_sdl-0.3/src/SDL/light.h
--- homeworld-orig/src/SDL/light.h	2002-09-04 12:47:02.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/light.h	2004-08-01 22:35:05.000000000 -0700
@@ -9,7 +9,7 @@
 #ifndef ___LIGHT_H
 #define ___LIGHT_H
 
-#include "types.h"
+#include "Types.h"
 
 /*=============================================================================
     Switches
diff -urPw homeworld-orig/src/SDL/LinkEnd.c homeworld_sdl-0.3/src/SDL/LinkEnd.c
--- homeworld-orig/src/SDL/LinkEnd.c	2002-09-04 12:47:02.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/LinkEnd.c	2004-08-01 22:35:10.000000000 -0700
@@ -6,7 +6,7 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
+#include "Types.h"
 
 /*=============================================================================
     Data:
diff -urPw homeworld-orig/src/SDL/LinkStart.c homeworld_sdl-0.3/src/SDL/LinkStart.c
--- homeworld-orig/src/SDL/LinkStart.c	2002-09-04 12:47:02.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/LinkStart.c	2004-08-01 22:35:06.000000000 -0700
@@ -6,7 +6,7 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
+#include "Types.h"
 
 /*=============================================================================
     Data:
diff -urPw homeworld-orig/src/SDL/main.c homeworld_sdl-0.3/src/SDL/main.c
--- homeworld-orig/src/SDL/main.c	2002-09-04 12:47:02.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/main.c	2004-08-01 22:35:10.000000000 -0700
@@ -5,14 +5,19 @@
         Created June 1997 by Luke Moloney.
 ============================================================================*/
 
+#ifdef _WIN32
 #define WIN32_LEAN_AND_MEAN
 #include <windows.h>
 #include <winreg.h>
+#endif
+
+#include "SDL.h"
 
 #include "leakyfaucet.h"
 #include "regkey.h"
                 // guess what?  The game code defines HKEY to 'H' which messes up the registry code.  So the
                 // registry code gets to go here
+#if 0	/* Not registering command line... */
 int RegisterCommandLine(char *commandLine)
 {
     HKEY key;
@@ -44,6 +49,7 @@
 
     return TRUE;
 }
+#endif
 
 #include <stdlib.h>
 #include <stdio.h>
@@ -52,60 +58,58 @@
 #include "glinc.h"
 #include "resource.h"
 #include "utility.h"
-#include "key.h"
+#include "Key.h"
 #include "mouse.h"
 #include "debugwnd.h"
-#include "debug.h"
-#include "memory.h"
-#include "file.h"
-#include "camera.h"
-#include "task.h"
+#include "Debug.h"
+#include "Memory.h"
+#include "File.h"
+#include "Camera.h"
+#include "Task.h"
 #include "mainrgn.h"
 #include "main.h"
-#include "globals.h"
-#include "soundevent.h"
+#include "Globals.h"
+#include "SoundEvent.h"
 #include "soundlow.h"
-#include "nis.h"
-#include "aiplayer.h"
-#include "fontreg.h"
-#include "fereg.h"
-#include "demo.h"
-#include "researchapi.h"
-#include "objtypes.h"
-#include "formation.h"
+#include "NIS.h"
+#include "AIPlayer.h"
+#include "FontReg.h"
+#include "FEReg.h"
+#include "Demo.h"
+#include "ResearchAPI.h"
+#include "ObjTypes.h"
+#include "Formation.h"
 #include "glcaps.h"
 #include "mainswitches.h"
-#include "tactics.h"
+#include "Tactics.h"
 #include "render.h"
-#include "autolod.h"
-#include "captaincy.h"
-#include "options.h"
-#include "sensors.h"
-#include "btg.h"
-#include "researchgui.h"
-#include "consmgr.h"
+#include "AutoLOD.h"
+#include "Captaincy.h"
+#include "Options.h"
+#include "Sensors.h"
+#include "BTG.h"
+#include "ResearchGUI.h"
+#include "ConsMgr.h"
 #include "rinit.h"
 #include "avi.h"
-#include "bink.h"
-#include "titannet.h"
-#include "multiplayergame.h"
-#include "subtitle.h"
+/*#include "bink.h"*/
+#include "TitanNet.h"
+#include "MultiplayerGame.h"
+#include "Subtitle.h"
 #include "dxdraw.h"
-#include "launchmgr.h"
-#include "colpick.h"
-#include "horserace.h"
+#include "LaunchMgr.h"
+#include "ColPick.h"
+#include "HorseRace.h"
 #include "glcompat.h"
 #include "sstglide.h"
-#include "particle.h"
-#include "commandlayer.h"
-#include "key.h"
-#include "strings.h"
-
-#include "zmouse.h"
-#ifndef WM_MOUSEWHEEL
-#define WM_MOUSEWHEEL WM_MOUSELAST+1
+#include "Particle.h"
+#include "CommandLayer.h"
+#include "Key.h"
+#include "Strings.h"
+
+#ifdef _WIN32
+#define strcasecmp _stricmp
 #endif
-UINT uMSH_MOUSEWHEEL = 0;
 
 /*=============================================================================
     Data:
@@ -118,10 +122,7 @@
 udword* devTable = NULL;
 sdword  devTableLength = 0;
 
-long FAR PASCAL WindowProc(HWND hWnd, UINT message, WPARAM wParam, LPARAM lParam);
-
 static bool mainActuallyQuit = TRUE;
-static DWORD style;
 
 bool selectedRES = FALSE;
 bool selectedDEVICE = FALSE;
@@ -139,7 +140,6 @@
 bool mainNoPerspective = FALSE;
 
 bool systemActive = FALSE;              //active flag for the program
-static char classTitle[] = "Homeworld"; //name of registered class
 static char windowTitle[] = "Homeworld";//name of window
 
 //error strings
@@ -183,6 +183,7 @@
 sdword MemoryHeapSize = MEM_HeapSizeDefault;
 bool FilePathPrepended = FALSE;
 bool CDROMPathPrepended = FALSE;
+bool UserSettingsPathPrepended = FALSE;
 #if MAIN_MOUSE_FREE
 bool startupClipMouse = TRUE;
 #endif
@@ -215,7 +216,11 @@
 char mainGLToSelect[512] = "";
 char mainD3DToSelect[128] = "";
 char deviceToSelect[128] = "";
+#ifdef _WIN32
 char glToSelect[512] = "rgl.dll";
+#else
+char glToSelect[512] = "librgl.so";
+#endif
 bool8 RENDER_BOXES = FALSE;
 bool8 RENDER_LIGHTLINES = FALSE;
 #if CL_TEXTFEEDBACK
@@ -310,14 +315,6 @@
 char versionString[MAX_VERSION_STRING_LEN] = "";        // constructed at beginning of program
 
 
-//Windows-related handles
-HWND ghMainWindow;
-HINSTANCE ghInstance;
-UINT uHWCloseMsg;
-
-//location of window, for mouse movement and sizing
-POINT WindowTopLeft = {-1, -1};
-
 sdword mainWindowTotalWidth = 0;
 sdword mainWindowTotalHeight = 0;
 
@@ -622,6 +619,7 @@
 
 bool CDROMPathSet(char *string)
 {
+#ifdef _WIN32
     char message[80];
 
     if (GetDriveType(string) != DRIVE_CDROM)
@@ -630,11 +628,19 @@
         MessageBox(NULL, message, "Invalid CD-ROM path", MB_OK | MB_APPLMODAL);
         return FALSE;
     }
+#endif
     fileCDROMPathSet(string);
     CDROMPathPrepended = TRUE;
     return TRUE;
 }
 
+bool UserSettingsPathSet(char *string)
+{
+	fileUserSettingsPathSet(string);
+	UserSettingsPathPrepended = TRUE;
+	return TRUE;
+}
+
 bool EnableFileLoadLog(char *string)
 {
     logfileClear(FILELOADSLOG);
@@ -644,7 +650,7 @@
 bool SelectDevice(char* string)
 {
     memStrncpy(deviceToSelect, string, 16 - 1);
-    if (_stricmp(deviceToSelect, "d3d") == 0)
+    if (strcasecmp(deviceToSelect, "d3d") == 0)
     {
         mainReinitRenderer = 2;
     }
@@ -654,13 +660,21 @@
 
 bool SelectMSGL(char* string)
 {
+#ifdef _WIN32
     memStrncpy(glToSelect, "opengl32.dll", 512 - 1);
+#else
+    memStrncpy(glToSelect, "libGL.so", 512 - 1);
+#endif
     return TRUE;
 }
 
 bool SelectD3D(char* string)
 {
+#ifdef _WIN32
     memStrncpy(glToSelect, "rgl.dll", 512 - 1);
+#else
+    memStrncpy(glToSelect, "librgl.so", 512 - 1);
+#endif
     memStrncpy(deviceToSelect, "d3d", 16 - 1);
     selectedGL = TRUE;
     selectedDEVICE = TRUE;
@@ -1144,6 +1158,7 @@
     entryFnParam("/heap",           HeapSizeSet,                        " <n> - Sets size of global memory heap to [n]."),
     entryFnParam("/prepath",        PrependPathSet,                     " <path> - Sets path to search for opening files."),
     entryFnParam("/CDpath",         CDROMPathSet,                       " <path> - Sets path to CD-ROM in case of ambiguity."),
+    entryFnParam("/settingspath",   UserSettingsPathSet,                " <path> - Sets the path to store settings, saved games, and screenshots (defaults to ~/.homeworld)."),
 #if MAIN_MOUSE_FREE
 #ifndef HW_Release
     entryVr("/freemouse",           startupClipMouse, FALSE,            " - Mouse free to move about entire screen at startup.  Use <CTRL>F11 to toggle during play."),
@@ -1284,7 +1299,7 @@
     //entryVr("/captaincyLogOff",     captaincyLogEnable, FALSE,          " - turns off captaincy log file" ),
     //entryVr("/captaincyLogOn",      captaincyLogEnable, TRUE,           " - turns on captaincy log file" ),
     entryVr("/logOff",              logEnable, LOG_OFF,                 " - turns of network logging file"),
-    entryVr("/logOn",               logEnable, LOG_ON,,                 " - turns network logging file on"),
+    entryVr("/logOn",               logEnable, LOG_ON,                  " - turns network logging file on"),
     entryVr("/logOnVerbose",        logEnable, LOG_VERBOSE,             " - turns verbose network logging file on"),
     entryFnParam("/logFilePath",    SpecifyLogFilePath,                 "=filepath.txt"),
     entryFn("/debugSync",           EnableDebugSync,                    " autosaves game frequently, records packets, logonverbose" ),
@@ -1294,7 +1309,7 @@
     entryVrHidden("/shortWon",      ShortCircuitWON, TRUE,              " - short circuit WON stuff" ),
 #else
     entryVrHidden("/logOff",        logEnable, LOG_OFF,                 " - turns of network logging file"),
-    entryVrHidden("/logOn",         logEnable, LOG_ON,,                 " - turns network logging file on"),
+    entryVrHidden("/logOn",         logEnable, LOG_ON,                  " - turns network logging file on"),
     entryVrHidden("/logOnVerbose",  logEnable, LOG_VERBOSE,             " - turns verbose network logging file on"),
     entryFnParamHidden("/logFilePath",SpecifyLogFilePath,               "=filepath.txt"),
 //!!!shortwon in release mode!!!    entryVrHidden("/shortWon",      ShortCircuitWON, TRUE,              " - short circuit WON stuff" ),
@@ -1365,42 +1380,19 @@
 };
 
 /*-----------------------------------------------------------------------------
-    Command-line parsing functions to display a help message box.
------------------------------------------------------------------------------*/
-char *gHelpString;
-BOOL CALLBACK CommandLineFunction(HWND hDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)
-{
-    switch (uMsg)
-    {
-        case WM_INITDIALOG:
-            SetDlgItemText(hDlg, IDC_CommandLine, gHelpString);
-            //... init the edit box
-            return(TRUE);
-        case WM_COMMAND:
-            if (LOWORD(wParam) == IDOK)
-            {
-                EndDialog(hDlg, 0);
-            }
-            return(TRUE);
-        default:
-            break;
-    }
-    return(FALSE);
-}
-
-/*-----------------------------------------------------------------------------
     Name        : DebugHelpDefault
     Description : Print out command-line usage help to a dialog box
     Inputs      : string - the unrecognized command-line switch that causes this help.
     Outputs     :
     Return      :
 ----------------------------------------------------------------------------*/
+char *gHelpString;
 void DebugHelpDefault(char *string)
 {
     sdword index, length;
 
     //calc length of help string
-    length = strlen("Invalid or unrecognised command line option: '%s'\x0d\x0a");
+    length = strlen("Invalid or unrecognised command line option: '%s'\n");
     length += strlen(string);
     for (index = 0; commandOptions[index].parameter; index++)
     {
@@ -1422,12 +1414,13 @@
 
     if ((gHelpString = malloc(length)) == NULL)              //allocate string
     {
-        MessageBox(NULL, "Cannot allocate memory for help.", "Command-Line Usage", MB_OK | MB_APPLMODAL);
+        /*MessageBox(NULL, "Cannot allocate memory for help.", "Command-Line Usage", MB_OK | MB_APPLMODAL);*/
+        fprintf(stderr, "Cannot allocate memory for help.\n");
         return;
     }
 
     //copy all help strings into one
-    sprintf(gHelpString, "Invalid or unrecognised command line option: '%s'\x0d\x0a", string);
+    sprintf(gHelpString, "Invalid or unrecognised command line option: '%s'\n", string);
     for (index = 0; commandOptions[index].parameter; index++)
     {
         if (!bitTest(commandOptions[index].flags, COF_Visible))
@@ -1436,40 +1429,42 @@
         }
         if (commandOptions[index].helpString == NULL)
         {                                                   //no help string: it's a comment
-            strcat(gHelpString, "\x0d\x0a");
+            strcat(gHelpString, "\n");
             strcat(gHelpString, commandOptions[index].parameter);
-            strcat(gHelpString, "\x0d\x0a");
+            strcat(gHelpString, "\n");
         }
         else
         {                                                   //else it's a real command line option
-            sprintf(gHelpString + strlen(gHelpString), "    %s%s\x0d\x0a", commandOptions[index].parameter, commandOptions[index].helpString);
+            sprintf(gHelpString + strlen(gHelpString), "    %s%s\n", commandOptions[index].parameter, commandOptions[index].helpString);
             //                                            ^ MCL_IndentSpace spaces
         }
     }
 
-    DialogBox(ghInstance, MAKEINTRESOURCE(IDD_CommandLine), NULL, CommandLineFunction);
+    /*DialogBox(ghInstance, MAKEINTRESOURCE(IDD_CommandLine), NULL, CommandLineFunction);*/
+    printf(gHelpString);
     free(gHelpString);                                       //done with string, free it
 }
 
 /*-----------------------------------------------------------------------------
     Name        : ProcessCommandLine
-    Description : Tokenize and process all defined command-lien flags
-    Inputs      : commandLine - command-line string, sans executable name
+    Description : Process all defined command-lien flags
+    Inputs      : argc - Number of command-line arguments
+                  argv - Array of command-line arguments
     Outputs     : sets command-line switch variables
     Return      : void
     Remarks:
         Here are the command-line switches for Homeworld:
             -debug: Enable debug window by setting the DebugWindow flag
 ----------------------------------------------------------------------------*/
-sdword ProcessCommandLine(char *commandLine)
+sdword ProcessCommandLine (int argc, char* argv[])
 {
-    char *string, *nextString;
+    char* string;
     sdword index;
+    int i;
 
-    string = strtok(commandLine, TS_Delimiters);            //initial tokenize
-
-    while (string != NULL)
+    for (i = 1; i < argc; i++)  // Skip the executable name.
     {
+        string = argv[i];
         if (string[0] == '-')
         {
             string[0] = '/';
@@ -1480,7 +1475,7 @@
             {                                               //don't compare against comment lines
                 continue;
             }
-            if (!_stricmp(string, commandOptions[index].parameter))
+            if (!strcasecmp(string, commandOptions[index].parameter))
             {                                               //if this is the correct option
                 dbgAssert(commandOptions[index].variableToModify || commandOptions[index].function);
                 if (commandOptions[index].variableToModify != NULL)
@@ -1491,12 +1486,11 @@
                 {                                           //call the function associated, if applicable
                     if (bitTest(commandOptions[index].flags, COF_NextToken))
                     {                                       //does the function take next token as a parameter?
-                        nextString = strtok(NULL, TS_Delimiters);//get next token
-                        if (nextString == NULL)
+                        if (++i == argc)                    //get next token
                         {                                   //if no next token
                             break;                          //print usage
                         }
-                        string = nextString;
+                        string = argv[i];
                     }
                     if(!commandOptions[index].function(string))
                     {
@@ -1504,13 +1498,15 @@
                         break;
                     }
                 }
-                goto stringFound;
+                break;
             }
         }
+
+        if (!commandOptions[index].parameter)
+        {
         DebugHelpDefault(string);                           //no string found, print help
         return(-1);
-stringFound:;
-        string = strtok(NULL, TS_Delimiters);               //get next token
+        }
     }
     return(OKAY);
 }
@@ -1522,19 +1518,24 @@
     Outputs     :
     Return      : void
 ----------------------------------------------------------------------------*/
-void CommandProcess(HWND hWnd, WPARAM wParam, LPARAM lParam)
+/*void CommandProcess(HWND hWnd, WPARAM wParam, LPARAM lParam)*/
+void CommandProcess(int code)
 {
-    switch(wParam)
+    SDL_Event e;
+
+    switch (code)
     {
         case CID_ExitError:                                 //error message posted, exit with a message box
-            SetWindowPos(hWnd, NULL, 0, 0, 0, 0, SWP_NOSIZE | SWP_NOMOVE |
-                SWP_NOZORDER | SWP_HIDEWINDOW);
-            MessageBox(hWnd, dbgFatalErrorString, "Fatal Error", MB_ICONSTOP | MB_OK);
+            fprintf(stderr, "Fatal Error: %s\n", dbgFatalErrorString);
+
+            e.quit.type = SDL_QUIT;
+            SDL_PushEvent(&e);
 
-            PostMessage(hWnd, WM_CLOSE, CID_ExitError, 0);
             break;
         case CID_ExitOK:
-            PostMessage(hWnd, WM_CLOSE, CID_ExitOK, 0);
+            e.quit.type = SDL_QUIT;
+            SDL_PushEvent(&e);
+
             break;
     }
 }
@@ -1637,7 +1638,7 @@
     }
 }
 
-void IntroDeactivateMe(HWND hWnd)
+void IntroDeactivateMe()
 {
     if (gl95)
     {
@@ -1645,16 +1646,14 @@
     }
     sounddeactivate(TRUE);
 
+#if 0	/* Bink, no? */
     if (!binkDonePlaying)
     {
         binkPause(TRUE);
         hwSetRes(0, 0, 0);
     }
+#endif
 
-    if (!noMinimizeAltTab && utyTest(SS2_SystemStarted))
-    {
-        ShowWindow(hWnd, SW_SHOWMINNOACTIVE);
-    }
     wasDemoPlaying = demDemoPlaying;                        //save demo playback state
     demDemoPlaying = FALSE;                                 //stop the demo playback for now
 
@@ -1670,16 +1669,12 @@
     systemActive = FALSE;
 }
 
-void IntroActivateMe(HWND hWnd)
+void IntroActivateMe()
 {
     sounddeactivate(FALSE);
 
-    hwSetRes(-1, -1, -1);
+    /*hwSetRes(-1, -1, -1);*/
 
-    if (!noMinimizeAltTab && utyTest(SS2_SystemStarted))
-    {
-        ShowWindow(hWnd, SW_RESTORE);
-    }
     demDemoPlaying = wasDemoPlaying;                        //keep playing demo if it was playing when we minimized
 #if MAIN_MOUSE_FREE
     if (utySystemStarted)
@@ -1689,9 +1684,8 @@
 #endif
     systemActive = TRUE;
 
-    ShowWindow(hWnd, SW_RESTORE);
     utyForceTopmost(fullScreen);
-    ShowCursor(FALSE);
+    SDL_ShowCursor(SDL_DISABLE);
     //make sure that the mouse is rotating properly when we come back
     utyMouseButtonsClear();
 
@@ -1699,10 +1693,12 @@
     keyBufferClear();
     mrTacticalOverlayState(utyCapsLockToggleState());
 
+#if 0	/* More bink... */
     if (!binkDonePlaying)
     {
         binkPause(FALSE);
     }
+#endif
 }
 
 /*-----------------------------------------------------------------------------
@@ -1712,7 +1708,7 @@
     Outputs     :
     Return      :
 ----------------------------------------------------------------------------*/
-void DeactivateMe(HWND hWnd)
+void DeactivateMe()
 {
     if (gl95)
     {
@@ -1724,14 +1720,12 @@
     {
         rglFeature(RGL_DEACTIVATE);
     }
+    /*
     else
     {
         (void)hwActivate(FALSE);
     }
-    if (!noMinimizeAltTab && utyTest(SS2_SystemStarted))
-    {
-        ShowWindow(hWnd, SW_SHOWMINNOACTIVE);
-    }
+    */
     wasDemoPlaying = demDemoPlaying;                        //save demo playback state
     demDemoPlaying = FALSE;                                 //stop the demo playback for now
 
@@ -1753,10 +1747,12 @@
     keyBufferClear();
     systemActive = FALSE;
 
+#if 0	/* Bink stuff... */
     if (!binkDonePlaying)
     {
         binkPause(TRUE);
     }
+#endif
     /*
     if (utyTest2(SS2_ToggleKeys))
     {
@@ -1772,24 +1768,22 @@
     Outputs     :
     Return      :
 ----------------------------------------------------------------------------*/
-void ActivateMe(HWND hWnd)
+void ActivateMe()
 {
     sounddeactivate(FALSE);
 
-    if (!noMinimizeAltTab && utyTest(SS2_SystemStarted))
-    {
-        ShowWindow(hWnd, SW_RESTORE);
-    }
     demDemoPlaying = wasDemoPlaying;                        //keep playing demo if it was playing when we minimized
     if (RGL)
     {
         rglFeature(RGL_ACTIVATE);
         mainReinitRenderer = 2;
     }
+    /*
     else
     {
         (void)hwActivate(TRUE);
     }
+    */
     if (glcActive())
     {
         glcRenderEverythingALot();
@@ -1810,9 +1804,8 @@
     }
     systemActive = TRUE;
 
-    ShowWindow(hWnd, SW_RESTORE);
     utyForceTopmost(fullScreen);
-    ShowCursor(FALSE);
+    SDL_ShowCursor(SDL_DISABLE);
     //make sure that the mouse is rotating proper when we come back
     utyMouseButtonsClear();
 
@@ -1828,10 +1821,12 @@
     */
     mrTacticalOverlayState(utyCapsLockToggleState());
 
+#if 0	/* Bink stuff... */
     if (!binkDonePlaying)
     {
         binkPause(FALSE);
     }
+#endif
 }
 
 static bool mainFileExists(char* filename)
@@ -1863,7 +1858,11 @@
     }
 
     //try cwd\3dfx\opengl32.dll first
+#ifdef _WIN32
     sprintf(path, "3dfx\\%s\\opengl32.dll", subdir);
+#else
+    sprintf(path, "3dfx/%s/libGL.so", subdir);
+#endif
     if (mainFileExists(path))
     {
         return TRUE;
@@ -1874,13 +1873,18 @@
     if (dir == NULL)
     {
         //not found, use default opengl
+#ifdef _WIN32
         strcpy(path, "opengl32.dll");
+#else
+        strcpy(path, "libGL.so");
+#endif
         return FALSE;
     }
     else
     {
         char concatdir[128];
         strcpy(path, dir);
+#ifdef _WIN32
         if (path[strlen(path)-1] == '\\')
         {
             sprintf(concatdir, "dll\\%s\\opengl32.dll", subdir);
@@ -1889,38 +1893,33 @@
         {
             sprintf(concatdir, "\\dll\\%s\\opengl32.dll", subdir);
         }
+#else
+        if (path[strlen(path)-1] == '/')
+        {
+            sprintf(concatdir, "dll/%s/libGL.so", subdir);
+        }
+        else
+        {
+            sprintf(concatdir, "/dll/%s/libGL.so", subdir);
+        }
+#endif
         strcat(path, concatdir);
         return TRUE;
     }
 }
 
 /*-----------------------------------------------------------------------------
-    Name        : mainFreeLibrary
-    Description : release references to a given .dll
-    Inputs      : libname - name of the library
+    Name        : mainFreeLibraries
+    Description : Release references to possible GL libraries.
+    Inputs      :
     Outputs     :
     Return      :
 ----------------------------------------------------------------------------*/
-static void mainFreeLibrary(char* libname)
-{
-    HINSTANCE lib;
-
-    lib = GetModuleHandle(libname);
-    if (lib != NULL)
-    {
-        while (FreeLibrary(lib)) ;
-    }
-}
-
 void mainFreeLibraries(void)
 {
     void glCapResetRGLAddresses(void);
 
-    mainFreeLibrary("rglsw.dll");
-    mainFreeLibrary("rgld3d.dll");
-    mainFreeLibrary("rgl.dll");
-    mainFreeLibrary("opengl32.dll");
-    mainFreeLibrary("3dfxvgl.dll");
+    /* No longer unload the library (SDL should handle this). */
 
     RGL = FALSE;
     glCapResetRGLAddresses();
@@ -1936,6 +1935,8 @@
 ----------------------------------------------------------------------------*/
 void mainRescaleMainWindow(void)
 {
+    /* Maybe? */
+#if 0
     bool wasClipped;
 
     mainWindowTotalWidth  = MAIN_WindowWidth  + mainWidthAdd;
@@ -1953,6 +1954,7 @@
     {
         utyClipMouse(TRUE);
     }
+#endif
 
     (void)utyChangeResolution(MAIN_WindowWidth, MAIN_WindowHeight, MAIN_WindowDepth);
 }
@@ -1974,12 +1976,20 @@
     {
         if (!mainFind3DfxGL(glToSelect))
         {
+#ifdef _WIN32
             memStrncpy(glToSelect, "opengl32.dll", 512 - 1);
+#else
+            memStrncpy(glToSelect, "libGL.so", 512 - 1);
+#endif
         }
     }
     else
     {
+#ifdef _WIN32
         memStrncpy(glToSelect, "opengl32.dll", 512 - 1);
+#else
+        memStrncpy(glToSelect, "libGL.so", 512 - 1);
+#endif
     }
 
     if (!glCapLoadOpenGL(glToSelect))
@@ -1990,23 +2000,22 @@
     mainD3DToSelect[0] = '\0';
     memStrncpy(mainGLToSelect, glToSelect, 512 - 1);
 
-    if (!hwCreateWindow((int)ghMainWindow, MAIN_WindowWidth, MAIN_WindowHeight, MAIN_WindowDepth))
-    {
-        return FALSE;
-    }
+    /* Window creation moved to rndSmallInit()/rndInit()...no more
+       hwCreateWindow()... */
 
     renderData.width = MAIN_WindowWidth;
     renderData.height = MAIN_WindowHeight;
-    renderData.hWnd = ghMainWindow;
+    /*renderData.hWnd = ghMainWindow;*/
+    renderData.hWnd = 0;
     if (!rndSmallInit(&renderData, TRUE))
     {
-        (void)hwDeleteWindow();
+        /*(void)hwDeleteWindow();*/
         return FALSE;
     }
 
     if (!glCapValidGL())
     {
-        (void)hwDeleteWindow();
+        /*(void)hwDeleteWindow();*/
         return FALSE;
     }
 
@@ -2105,7 +2114,11 @@
 
     mainRescaleMainWindow();
 
+#ifdef _WIN32
     memStrncpy(glToSelect, "rgl.dll", 512 - 1);
+#else
+    memStrncpy(glToSelect, "librgl.so", 512 - 1);
+#endif
     if (!glCapLoadOpenGL(glToSelect))
     {
         return FALSE;
@@ -2120,7 +2133,8 @@
 
     renderData.width = MAIN_WindowWidth;
     renderData.height = MAIN_WindowHeight;
-    renderData.hWnd = ghMainWindow;
+    /*renderData.hWnd = ghMainWindow;*/
+    renderData.hWnd = 0;
     if (!rndSmallInit(&renderData, FALSE))
     {
         return FALSE;
@@ -2150,82 +2164,34 @@
     return RGLtype;
 }
 
-void mainRegisterClass(HANDLE hInstance)
-{
-    WNDCLASS windowClass;
-
-    // set up and register window class
-    windowClass.style         = CS_HREDRAW | CS_VREDRAW | CS_DBLCLKS;
-    windowClass.lpfnWndProc   = WindowProc;
-    windowClass.cbClsExtra    = 0;
-    windowClass.cbWndExtra    = 0;
-    windowClass.hInstance     = hInstance;
-    windowClass.hIcon         = LoadIcon(hInstance, MAKEINTRESOURCE(IDI_ICON1));
-    windowClass.hCursor       = NULL;
-    windowClass.hbrBackground = GetStockObject(BLACK_BRUSH);
-    windowClass.lpszMenuName  = NULL;
-    windowClass.lpszClassName = classTitle;
-
-    if (!RegisterClass(&windowClass))
-    {
-//        __asm int 3
-    }
-}
-
-void mainUnregisterClass(HANDLE hInstance)
-{
-    if (!UnregisterClass(classTitle, hInstance))
-    {
-//        __asm int 3
-    }
-}
-
 void mainDestroyWindow(void)
 {
-    HWND hWindow;
-
     mainActuallyQuit = FALSE;
-    (void)DestroyWindow(ghMainWindow);
 
     mainWindowTotalWidth  = MAIN_WindowWidth  + mainWidthAdd;
     mainWindowTotalHeight = MAIN_WindowHeight + mainHeightAdd;
 
+#ifdef _WIN32
     if (DebugWindow)
     {
         dbwClose();
     }
+#endif
 
 //    mainUnregisterClass(ghInstance);
 //    mainRegisterClass(ghInstance);
 
-    hWindow = CreateWindow(
-//        0,//WS_EX_TOPMOST,
-        classTitle,                                         // class name string
-        windowTitle,                                        // title string
-        style,
-        0, 0,
-        mainWindowTotalWidth,
-        mainWindowTotalHeight,
-        NULL,
-        NULL,
-        ghInstance,
-        NULL );
-
-    if (hWindow == NULL)
-    {
-        return;
-    }
-
-    ShowWindow(hWindow, 0/*nCmdShow*/);
     utyForceTopmost(fullScreen);
-    UpdateWindow(hWindow);
-
-    ghMainWindow = hWindow;
 
+#ifdef _WIN32
     if (DebugWindow)
     {
+        /* If porting this back to Windows, you'll need to get a hold of
+           values for these (hWnd is in the SDL_SysWMinfo structure, hInst
+           would need to be acquired through Windows API calls). */
         dbwStart((udword)ghInstance, (udword)ghMainWindow);
     }
+#endif
 }
 
 /*-----------------------------------------------------------------------------
@@ -2238,11 +2204,15 @@
 void mainShutdownGL(void)
 {
     rndClose();
+
+#ifndef _MACOSX_FIX_ME
     if (sstLoaded())
     {
         sstShutdown();
     }
-    hwDeleteWindow();
+#endif
+
+    /*hwDeleteWindow();*/
     mainDestroyWindow();
 }
 
@@ -2364,11 +2334,19 @@
 
 void mainSetupSoftware(void)
 {
+#ifdef _WIN32
     strcpy(glToSelect, "rgl.dll");
     strcpy(mainGLToSelect, "rgl.dll");
     strcpy(deviceToSelect, "sw");
     strcpy(mainDeviceToSelect, "sw");
     strcpy(mainD3DToSelect, "");
+#else
+    strcpy(glToSelect, "librgl.so");
+    strcpy(mainGLToSelect, "librgl.so");
+    strcpy(deviceToSelect, "sw");
+    strcpy(mainDeviceToSelect, "sw");
+    strcpy(mainD3DToSelect, "");
+#endif
 
     mainWindowWidth  = MAIN_WindowWidth  = 640;
     mainWindowHeight = MAIN_WindowHeight = 480;
@@ -2395,17 +2373,16 @@
     bMustFree = FALSE;
     if (!mainLoadParticularRGL("sw", ""))
     {
+        SDL_Event e;
 /*
         MessageBox(NULL,
                    "couldn't initialize default rendering system",
                    windowTitle, MB_APPLMODAL | MB_OK);
 */
-        SetWindowPos(ghMainWindow, NULL, 0, 0, 0, 0,
-                     SWP_NOSIZE | SWP_NOMOVE | SWP_NOZORDER | SWP_HIDEWINDOW);
-        MessageBox(ghMainWindow,
-                   "couldn't initialize default rendering system",
-                   "Fatal Error", MB_ICONSTOP | MB_OK);
-        PostMessage(ghMainWindow, WM_CLOSE, CID_ExitError, 0);
+        fprintf(stderr, "Fatal Error: Couldn't initialize default rendering system.\n");
+        e.user.type = SDL_USEREVENT;
+        e.user.code = CID_ExitError;
+        SDL_PushEvent(&e);
     }
     bMustFree = TRUE;
 }
@@ -2594,7 +2571,7 @@
 /*-----------------------------------------------------------------------------
     Name        : keyLanguageTranslate
     Description : This function translates the virtual key into the ASCII character.
-    Inputs      : virtkey and scancode
+    Inputs      : keysym
     Outputs     : converted character
     Return      : Uh-huh
 ----------------------------------------------------------------------------*/
@@ -2606,30 +2583,32 @@
             return(wParam);
         break;
         case languageFrench:
-            if (wParam < 256)
+            if (wParam < KEY_TOTAL_KEYS)
                 return(keyFrenchToEnglish(wParam));
             else
                 return(0);
         break;
         case languageGerman:
-            if (wParam < 256)
+            if (wParam < KEY_TOTAL_KEYS)
                 return(keyGermanToEnglish(wParam));
             else
                 return(0);
         break;
         case languageSpanish:
-            if (wParam < 256)
+            if (wParam < KEY_TOTAL_KEYS)
                 return(keySpanishToEnglish(wParam));
             else
                 return(0);
         break;
         case languageItalian:
-            if (wParam < 256)
+            if (wParam < KEY_TOTAL_KEYS)
                 return(keyItalianToEnglish(wParam));
             else
                 return(0);
         break;
     }
+
+    return wParam;
 /*    char   buff[256], trankey[2];
     sdword i,ret;
 
@@ -2654,62 +2633,56 @@
 }
 
 /*-----------------------------------------------------------------------------
-    Name        : WindowProc
-    Description : Message handling function for main window
-    Inputs      : See Windows help.
-    Outputs     : Ditto
-    Return      : Uh-huh
+    Name        : HandleEvent
+    Description : SDL event handling for the application
+    Inputs      : pEvent - Pointer to the event to handle
+    Outputs     :
+    Return      : Result of event handling (based on the event)
 ----------------------------------------------------------------------------*/
-long FAR PASCAL WindowProc(HWND hWnd, UINT message, WPARAM wParam, LPARAM lParam )
+//long FAR PASCAL WindowProc(HWND hWnd, UINT message, WPARAM wParam, LPARAM lParam )
+sdword HandleEvent (const SDL_Event* pEvent)
 {
     extern bool utilPlayingIntro;
 
+    /* Mouse button press times for double-click support. */
+    static Uint32 mbDownTime[3] = { 0, 0, 0 };
+    static Uint8 mbDouble[3] = { 0, 0, 0 };
+
+    dbgAssert(pEvent);
+
 #if MAIN_PRINT_MESSAGES
-    dbgMessagef("\nMessage = 0x%x, wParam = 0x%x, lParam = 0x%x", message, wParam, lParam);
+    dbgMessagef("\nEvent type = 0x%hhx", pEvent->type);
 #endif //MAIN_PRINT_MESSAGES
 
-    if (message == uHWCloseMsg)
+    switch (pEvent->type)
     {
-        goto destroy;
-    }
-
-    switch( message )
-    {
-        case WM_SYSCOMMAND:
-            if (wParam == SC_SCREENSAVE)
-            {
-                //render screensavers ineffective
-                return 0;
-            }
-            break;
-
-        case WM_ACTIVATEAPP:
+        case SDL_ACTIVEEVENT:
 #if 0
             if (!mainActuallyQuit)
             {
                 return 0;
             }
 #endif
-            if((bool)wParam && (systemActive == FALSE))
+            if (pEvent->active.gain && systemActive == FALSE)
             {                                               //we're being activated
                 if (utilPlayingIntro)
                 {
-                    IntroActivateMe(hWnd);
+                    IntroActivateMe();
                 }
                 else
                 {
-                    ActivateMe(hWnd);
+                    ActivateMe();
                 }
             }
-            else if (systemActive == TRUE)
+            else if (!pEvent->active.gain && systemActive == TRUE)
             {                                               //we're being deactivated
                 if (utilPlayingIntro)
                 {
-                    IntroDeactivateMe(hWnd);
+                    IntroDeactivateMe();
                 }
                 else
                 {
-                    DeactivateMe(hWnd);
+                    DeactivateMe();
                 }
             }
             else
@@ -2717,31 +2690,33 @@
 
             return 0;                                       //per documentation
 
-        case WM_KEYUP:                                      //keys up/down
-            switch (wParam)
+        case SDL_KEYUP:                                     //keys up/down
+            switch (pEvent->key.keysym.sym)
             {
-                case VK_ESCAPE:
+                case SDLK_ESCAPE:
+#if 0	/* Bink */
                     if (!binkDonePlaying)
                     {
                         binkStop();
                     }
                     else
+#endif
                     {
-                        keyPressUp(KeyMapFromWindows(wParam));
+                        keyPressUp(pEvent->key.keysym.sym);
                     }
 #if MAIN_MOUSE_FREE
-                case VK_F11:                                //toggle clipped cursor
+                case SDLK_F11:                              //toggle clipped cursor
                     if (keyIsHit(CONTROLKEY))
                     {
                         utyClipMouse(mouseClipped ^ TRUE);
                     }
                     else
                     {
-                        keyPressUp(KeyMapFromWindows(wParam));
+                        keyPressUp(pEvent->key.keysym.sym);
                     }
                     break;
 #endif
-                case VK_F12:
+                case SDLK_F12:
                     if (!RGL)
                     {
                         if (keyIsHit(SHIFTKEY) && keyIsHit(CONTROLKEY))
@@ -2786,222 +2761,150 @@
                     }
                     break;
                 default:
-                    keyPressUp(keyLanguageTranslate(wParam));//keyPressUp(KeyMapFromWindows(wParam));
+                    keyPressUp(keyLanguageTranslate(pEvent->key.keysym.sym));//keyPressUp(KeyMapFromWindows(wParam));
             }
             return 0;
 
-        case WM_KEYDOWN:
+        case SDL_KEYDOWN:
+            /*
             if (lParam & BIT30)
             {                                               //if it's a repeating key
                 //keyRepeat(KeyMapFromWindows(wParam));
                 keyRepeat(keyLanguageTranslate(wParam));
             }
-            else
-            {                                               //else it's a freshly-pressed key
-                keyPressDown(keyLanguageTranslate(wParam));
+            */
+            keyPressDown(keyLanguageTranslate(pEvent->key.keysym.sym));
                 //keyPressDown(KeyMapFromWindows(wParam));
-            }
-            return 0;
-
-        case WM_DEADCHAR:
-            return 0;
-
-        case WM_SYSKEYUP:                                   //keys up/down
-            keyPressUp(keyLanguageTranslate(wParam));
-            return 0;
-
-        case WM_SYSKEYDOWN:
-            if (lParam & BIT30)
-            {                                               //if it's a repeating key
-                keyRepeat(keyLanguageTranslate(wParam));
-            }
-            else
-            {                                               //else it's a freshly-pressed key
-                keyPressDown(keyLanguageTranslate(wParam));
-            }
             return 0;
 
-        case WM_COMMAND:
-            CommandProcess(hWnd, wParam, lParam);
+        case SDL_USEREVENT:
+            CommandProcess(pEvent->user.code);
             return 0;
 
-        case WM_LBUTTONDBLCLK:
+        case SDL_MOUSEBUTTONDOWN:
             if (!mouseDisabled)
             {
-                keyPressDown(KeyMapFromWindows(LMOUSE_DOUBLE));
-            }
-            break;
+                Uint32 curr_time = SDL_GetTicks();
 
-        case WM_LBUTTONDOWN:                                //mouse buttons up/down
-            if (!mouseDisabled)
+                switch (pEvent->button.button)
+                {
+                    case SDL_BUTTON_LEFT:
+#ifdef _MACOSX_FIX_ME
+                    case SDL_BUTTON_MIDDLE:
+#endif
+                        if (!mbDouble[0] && curr_time - mbDownTime[0] <= 500)
+                        {
+                            keyPressDown(LMOUSE_DOUBLE);
+                            mbDouble[0] = 1;
+                        }
+                        else
             {
                 mouseLClick();
-                keyPressDown(KeyMapFromWindows(VK_LBUTTON));
+                            keyPressDown(LMOUSE_BUTTON);
+                            mbDouble[0] = 0;
             }
+                        mbDownTime[0] = curr_time;
             break;
-
-        case WM_LBUTTONUP:
-            if (!mouseDisabled)
+#ifndef _MACOSX_FIX_ME
+                    case SDL_BUTTON_MIDDLE:
+                        if (!mbDouble[1] && curr_time - mbDownTime[1] <= 500)
             {
-                keyPressUp(KeyMapFromWindows(VK_LBUTTON));
-                keyPressUp(KeyMapFromWindows(LMOUSE_DOUBLE));
+                            keyPressDown(MMOUSE_DOUBLE);
+                            mbDouble[1] = 1;
             }
-            break;
-
-        case WM_RBUTTONDBLCLK:
-            if (!mouseDisabled)
+                        else
             {
-                keyPressDown(KeyMapFromWindows(RMOUSE_DOUBLE));
+                            keyPressDown(MMOUSE_BUTTON);
+                            mbDouble[1] = 0;
             }
+                        mbDownTime[1] = curr_time;
             break;
-
-        case WM_RBUTTONDOWN:
-            if (!mouseDisabled)
+#endif
+                    case SDL_BUTTON_RIGHT:
+                        if (!mbDouble[2] && curr_time - mbDownTime[2] <= 500)
             {
-                keyPressDown(KeyMapFromWindows(VK_RBUTTON));
+                            keyPressDown(RMOUSE_DOUBLE);
+                            mbDouble[2] = 1;
             }
-            break;
-
-        case WM_RBUTTONUP:
-            if (!mouseDisabled)
+                        else
             {
-                keyPressUp(KeyMapFromWindows(VK_RBUTTON));
-                keyPressUp(KeyMapFromWindows(RMOUSE_DOUBLE));
+                            keyPressDown(RMOUSE_BUTTON);
+                            mbDouble[2] = 0;
             }
+                        mbDownTime[2] = curr_time;
             break;
 
-        case WM_MBUTTONDOWN:
-            if (!mouseDisabled)
-            {
-                keyPressDown(KeyMapFromWindows(VK_MBUTTON));
-            }
+                    case SDL_BUTTON_WHEELUP:
+                        keyPressDown(FLYWHEEL_UP);
             break;
 
-        case WM_MBUTTONUP:
-            if (!mouseDisabled)
-            {
-                keyPressUp(KeyMapFromWindows(VK_MBUTTON));
-                keyPressUp(KeyMapFromWindows(MMOUSE_DOUBLE));
+                    case SDL_BUTTON_WHEELDOWN:
+                        keyPressDown(FLYWHEEL_DOWN);
+                    break;
+                }
             }
             break;
 
-        case WM_MBUTTONDBLCLK:
+        case SDL_MOUSEBUTTONUP:
             if (!mouseDisabled)
             {
-                keyPressDown(KeyMapFromWindows(MMOUSE_DOUBLE));
+                switch (pEvent->button.button)
+                {
+                    case SDL_BUTTON_LEFT:
+#ifdef _MACOSX_FIX_ME
+                    case SDL_BUTTON_MIDDLE:
+#endif
+                        keyPressUp(LMOUSE_BUTTON);
+                        keyPressUp(LMOUSE_DOUBLE);
+                    break;
+#ifndef _MACOSX_FIX_ME
+                    case SDL_BUTTON_MIDDLE:
+                        keyPressUp(MMOUSE_BUTTON);
+                        keyPressUp(MMOUSE_DOUBLE);
+                    break;
+#endif
+                    case SDL_BUTTON_RIGHT:
+                        keyPressUp(RMOUSE_BUTTON);
+                        keyPressUp(RMOUSE_DOUBLE);
+                    break;
+                }
             }
             break;
 
-        case WM_DESTROY:
-destroy:
+        case SDL_QUIT:
             if (mainActuallyQuit)
             {
+                SDL_Event e;
                 WindowsCleanup();
-                PostQuitMessage(0);
+                e.quit.type = SDL_QUIT;
+                SDL_PushEvent(&e);
             }
             else
             {
                 mainActuallyQuit = TRUE;
             }
             return 0;
-
-        case WM_CLOSE:
-            if ((wParam != CID_ExitError) && (wParam != CID_ExitOK))
-            {                                               //if it's not one of the 'official' exit codes generated by the game
-                return 0;                                   //don't let the game shut down by normal windows methods
             }
-            break;                                          //else close down as normal
-
-        case WM_ENTERIDLE:                                  //game deactivated due to a pop-up (menu or dialog)
-            keyClearAll();                                  //don't leave any keys stuck in this case
-            break;
 
-        case WM_PAINT:
-        {
-            PAINTSTRUCT ps;
-            BeginPaint(hWnd, &ps);
-            EndPaint(hWnd, &ps);
-            return 0;
-        }
-        case WM_MOVE:
-            WindowTopLeft.x = (int)LOWORD(lParam);
-            WindowTopLeft.y = (int)HIWORD(lParam);
             return 0;
-        case WM_GETMINMAXINFO:
-        {
-            RECT windowRect;
-            MINMAXINFO *info;
-
-            if (WindowTopLeft.x == -1)                      //if window hasn't moved yet
-            {
-                break;                                      //don't force any size restrictions
-            }
-            info = (MINMAXINFO *)lParam;
-            GetWindowRect(ghMainWindow, &windowRect);       //get window rect
-
-            info->ptMaxSize.x = mainWindowTotalWidth;
-            info->ptMaxSize.y = mainWindowTotalHeight;
-                GetSystemMetrics(SM_CYSIZEFRAME) * 2;       //GetSystemMetrics( SM_CYSCREEN )
-            info->ptMaxPosition.x = windowRect.left;        //maximise will not move it
-            info->ptMaxPosition.y = windowRect.top;
-            info->ptMinTrackSize = info->ptMaxSize;         //can't change size
-            info->ptMaxTrackSize = info->ptMaxSize;
-            return 0;
-        }
-
-        case WM_MOUSEWHEEL:
-            if (!mouseDisabled)
-            {
-                if ((short)HIWORD(wParam) < 0)
-                    keyPressDown(FLYWHEEL_DOWN);
-                else
-                    keyPressDown(FLYWHEEL_UP);
-            }
-            break;
-        case WM_INPUTLANGCHANGE:
-            // keyboard locale has changed update settings ...
-            strSetCurKeyboard();
-            return 0;
-        default:
-            if (uMSH_MOUSEWHEEL != 0 && message == uMSH_MOUSEWHEEL)
-            {
-                if ((int)wParam < 0)
-                    keyPressDown(FLYWHEEL_DOWN);
-                else
-                    keyPressDown(FLYWHEEL_UP);
-                break;
-            }
-            return DefWindowProc(hWnd, message, wParam, lParam);
-    }
-
-    return DefWindowProc(hWnd, message, wParam, lParam);
 } // WindowProc
 
 /*-----------------------------------------------------------------------------
     Name        : InitWindow
-    Description : Creates and initializes the main game window, whether full-screen or not.
+    Description : Initialize main window...stuff...
     Inputs      :
-        hInstance       - instance handle for game.
-        nCmdShow        - run state (minimized etc.)
     Outputs     :
-    Return      : window handle
+    Return      : TRUE if successful, FALSE if not
 ----------------------------------------------------------------------------*/
-static HWND InitWindow( HANDLE hInstance, int nCmdShow )
+static bool InitWindow ()
 {
-    HWND hWindow;
     char d3dToSelect[64];
-
-    mainRegisterClass(hInstance);
+	unsigned int rinDevCRC;
 
     /*
      * create a window
      */
 
-    if (fullScreen)
-    {
-        showBorder = FALSE;
-    }
-
     if (mainAutoRenderer)
     {
         if (selectedRES)
@@ -3018,18 +2921,8 @@
         }
     }
 
-    if (showBorder)
-    {
-        style = WS_OVERLAPPEDWINDOW | WS_CLIPCHILDREN | WS_CLIPSIBLINGS | WS_EX_TOPMOST;//WS_POPUP,
-        mainWidthAdd  = GetSystemMetrics(SM_CXSIZEFRAME) * 2;
-        mainHeightAdd = GetSystemMetrics(SM_CYCAPTION) + GetSystemMetrics(SM_CYSIZEFRAME) * 2;
-    }
-    else
-    {
-        style = WS_POPUP;
         mainWidthAdd  = 0;
         mainHeightAdd = 0;
-    }
 
     if (mainForceSoftware)
     {
@@ -3041,23 +2934,7 @@
     mainWindowTotalWidth  = MAIN_WindowWidth  + mainWidthAdd;
     mainWindowTotalHeight = MAIN_WindowHeight + mainHeightAdd;
 
-    hWindow = CreateWindow(
-//        0,//WS_EX_TOPMOST,
-        classTitle,                                         // class name string
-        windowTitle,                                        // title string
-        style,
-        0, 0,
-        mainWindowTotalWidth,
-        mainWindowTotalHeight,
-        NULL,
-        NULL,
-        hInstance,
-        NULL );
-
-    if (hWindow == NULL)
-    {
-        return NULL;
-    }
+    /* Window created in renderer initialization.. */
 
     mainDevStatsInit();
     rinEnumerateDevices();
@@ -3082,7 +2959,8 @@
         }
     }
 
-    if (opDeviceCRC != rinDeviceCRC())
+	rinDevCRC = rinDeviceCRC();
+    if (opDeviceCRC != rinDevCRC)
     {
         opDeviceIndex = -1;
         if (mainAutoRenderer)
@@ -3096,18 +2974,20 @@
     {
         strcpy(deviceToSelect, "sw");
         strcpy(mainDeviceToSelect, "sw");
+#ifdef _WIN32
         strcpy(glToSelect, "rgl.dll");
         strcpy(mainGLToSelect, "rgl.dll");
+#else
+        strcpy(glToSelect, "librgl.so");
+        strcpy(mainGLToSelect, "librgl.so");
+#endif
         d3dToSelect[0] = '\0';
         mainD3DToSelect[0] = '\0';
         MAIN_WindowWidth  = 640;
         MAIN_WindowHeight = 480;
         MAIN_WindowDepth  = 16;
 
-        ShowWindow(hWindow, nCmdShow);
         utyForceTopmost(fullScreen);
-        UpdateWindow(hWindow);
-        ghMainWindow = hWindow;
 
         mainRescaleMainWindow();
 
@@ -3136,20 +3016,13 @@
     {
         mainSetupSoftware();
 
-        ShowWindow(hWindow, nCmdShow);
         utyForceTopmost(fullScreen);
-        UpdateWindow(hWindow);
-        ghMainWindow = hWindow;
 
         mainRescaleMainWindow();
         if (!glCapLoadOpenGL(glToSelect))
         {
-            SetWindowPos(ghMainWindow, NULL, 0, 0, 0, 0,
-                         SWP_NOSIZE | SWP_NOMOVE | SWP_NOZORDER | SWP_HIDEWINDOW);
-            MessageBox(ghMainWindow,
-                       "couldn't initialize default rendering system",
-                       "Fatal Error", MB_ICONSTOP | MB_OK);
-            return NULL;
+            fprintf(stderr, "Fatal Error: Couldn't initialize default rendering system\n.");
+            return FALSE;
         }
     }
     memStrncpy(mainDeviceToSelect, deviceToSelect, 16 - 1);
@@ -3157,7 +3030,7 @@
 
     glCapStartup();
 
-    if (_stricmp(deviceToSelect, "d3d") == 0)
+    if (strcasecmp(deviceToSelect, "d3d") == 0)
     {
         mainReinitRenderer = 2;
     }
@@ -3208,13 +3081,7 @@
         lodScaleFactor = 1.0f;
     }
 
-    ShowWindow(hWindow, nCmdShow);
-    utyForceTopmost(fullScreen);
-    UpdateWindow(hWindow);
-
-    ghMainWindow = hWindow;
-
-    return hWindow;
+    return TRUE;
 } /* doInit */
 
 /*-----------------------------------------------------------------------------
@@ -3229,7 +3096,7 @@
     utyGameSystemsShutdown();
     if (!RGL)
     {
-        hwDeleteWindow();
+        /*hwDeleteWindow();*/
     }
     rinFreeDevices();
 }
@@ -3248,24 +3115,26 @@
     {
         windowNeedsDeleting = FALSE;
         //restore previous display mode
-        hwSetRes(0, 0, 0);
+        /*hwSetRes(0, 0, 0);*/
     }
     if (!RGL)
     {
         //create a window at appropriate res
-        (void)hwCreateWindow((int)ghMainWindow, MAIN_WindowWidth, MAIN_WindowHeight, MAIN_WindowDepth);
+        /*(void)hwCreateWindow((int)ghMainWindow, MAIN_WindowWidth, MAIN_WindowHeight, MAIN_WindowDepth);*/
     }
 }
 
+#if 0
 void RunPatcher(void)
 {
-    DeactivateMe(ghMainWindow);
+    DeactivateMe();
 
     WinExec(PATCHNAME,SW_NORMAL);
 
 //    WindowsCleanup();
     //PostQuitMessage(0);
 }
+#endif
 
 
 /*-----------------------------------------------------------------------------
@@ -3279,15 +3148,21 @@
     Outputs     :
     Return      : Exit code (Windows provides an intelligible number)
 ----------------------------------------------------------------------------*/
+/*
 int PASCAL WinMain( HINSTANCE hInstance, HINSTANCE hPrevInstance,
                         LPSTR commandLine, int nCmdShow)
+*/
+int main (int argc, char* argv[])
 {
-    static MSG   message;
     static char *errorString = NULL;
-    static HWND  hWnd;
+#ifdef _WIN32
     static HANDLE hMapping;
-    static BOOL  preInit;
+#endif
+    static bool preInit;
+    SDL_Event e;
+    int event_res = 0;
 
+#ifdef _WIN32
     //check to see if a copy of the program already running and just exit if so.
     //This messy hack is required because hPrevInstance is not reliable under Win32.
     hMapping = CreateFileMapping( (HANDLE) 0xffffffff,
@@ -3315,6 +3190,8 @@
             return 0;
         }
     }
+#endif  /* Support for other platforms? */
+
 /*
     if (strlen(leakString) != MAX_LEAK_STRING_LENGTH)
     {   // leakstring has not been plugged by the Fat-Assed plumber program
@@ -3328,9 +3205,6 @@
         }
     }
 */
-    uHWCloseMsg = RegisterWindowMessage("CloseHomeworld");
-
-    ghInstance = hInstance;
 
     mainDeviceToSelect[0] = '\0';
 
@@ -3340,11 +3214,13 @@
     //copy keyboard redefinitions
     opKeyboardLoad();
 
+    /*
     RegisterCommandLine(commandLine);       // make sure you call this before ProcessCommandLine because
                                             // ProcessCommandLine modifies commandLine
+    */
 
     //process the command line, setting flags to be used later
-    if (ProcessCommandLine(commandLine) != OKAY)
+    if (ProcessCommandLine(argc, argv) != OKAY)
     {
         return 0;
     }
@@ -3362,7 +3238,7 @@
 #if MAIN_Password
     if ((errorString = mainPasswordVerify(mainPasswordPtr)) != NULL)
     {
-        MessageBox(NULL, errorString, "Homeworld Run-Time Error", MB_OK);
+        fprintf(stderr, "Homeworld Run-Time Error\n");
         return 0;
     }
 #endif
@@ -3377,20 +3253,27 @@
     //startup the game window
     if (errorString == NULL)
     {
+#ifdef _WIN32
         if (DebugWindow)
         {
             dbwClose();
         }
+#endif
         preInit = TRUE;
-        if ((hWnd = InitWindow(hInstance, nCmdShow)) == NULL)
+        if (!InitWindow())
         {
             errorString = ersWindowInit;
         }
+#ifdef _WIN32
         if (DebugWindow)
         {
+            /* If porting this back to Windows, you'll need to get a hold of
+               values for these (hWnd is in the SDL_SysWMinfo structure, hInst
+               would need to be acquired through Windows API calls). */
             dbwStart((udword)ghInstance, (udword)ghMainWindow);
             utySet(SSA_DebugWindow);
         }
+#endif
     }
 
     mainPlayAVIs = FALSE;
@@ -3401,21 +3284,23 @@
         {
             windowNeedsDeleting = TRUE;
             //set display mode
+            /*
             if (!hwSetRes(640, 480, 32))
             {
                 hwSetRes(640, 480, 16);
             }
+            */
             utyForceTopmost(TRUE);
         }
         else if (!RGL)
         {
             windowNeedsDeleting = FALSE;
-            (void)hwCreateWindow((int)ghMainWindow, MAIN_WindowWidth, MAIN_WindowHeight, MAIN_WindowDepth);
+            /*(void)hwCreateWindow((int)ghMainWindow, MAIN_WindowWidth, MAIN_WindowHeight, MAIN_WindowDepth);*/
             utyForceTopmost(fullScreen);
         }
 #else
         windowNeedsDeleting = FALSE;
-        (void)hwCreateWindow((int)ghMainWindow, MAIN_WindowWidth, MAIN_WindowHeight, MAIN_WindowDepth);
+        /*(void)hwCreateWindow((int)ghMainWindow, MAIN_WindowWidth, MAIN_WindowHeight, MAIN_WindowDepth);*/
         utyForceTopmost(fullScreen);
 #endif
         //startup game systems
@@ -3429,19 +3314,16 @@
     {
         preInit = FALSE;
 
-        uMSH_MOUSEWHEEL = RegisterWindowMessage(MSH_MOUSEWHEEL);
-
         while(TRUE)
         {
             // Give sound a break :)
-            Sleep(0);
+            SDL_Delay(0);
 
-            if(PeekMessage(&message, NULL, 0, 0, PM_NOREMOVE))
+            if (SDL_PollEvent(&e))
             {
-                if(!GetMessage(&message, NULL, 0, 0))
+                if (e.type == SDL_QUIT)
                     break;
-                TranslateMessage(&message);
-                DispatchMessage(&message);
+                event_res = HandleEvent(&e);
             }
             else
             {
@@ -3456,11 +3338,13 @@
                 }
             }
 
+#if 0
             if (patchComplete)
             {
                 RunPatcher();
                 patchComplete = 0;
             }
+#endif
         }
     }
     else
@@ -3469,8 +3353,13 @@
         {
             (void)utyGameSystemsPreShutdown();
         }
-        MessageBox(NULL, errorString, windowTitle, MB_APPLMODAL|MB_OK);
+        fprintf(stderr, "%s\n", errorString);
         return ERR_ErrorStart;
     }
-    return message.wParam;
+
+    /* Stay clean and fresh... */
+    if (SDL_WasInit(SDL_INIT_EVERYTHING))
+        SDL_Quit();
+
+    return event_res;
 } /* WinMain */
diff -urPw homeworld-orig/src/SDL/main.h homeworld_sdl-0.3/src/SDL/main.h
--- homeworld-orig/src/SDL/main.h	2002-09-04 12:47:02.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/main.h	2004-08-01 22:35:10.000000000 -0700
@@ -7,7 +7,7 @@
 #ifndef ___MAIN_H
 #define ___MAIN_H
 
-#include "types.h"
+#include "Types.h"
 #include "mainswitches.h"
 
 /*=============================================================================
@@ -109,8 +109,11 @@
 =============================================================================*/
 void WindowsCleanup(void);
 
-void ActivateMe(void *hWnd);
-void DeactivateMe(void *hWnd);
+void ActivateMe(void);
+void DeactivateMe(void);
+
+// Event handler.
+sdword HandleEvent (const SDL_Event* pEvent);
 
 //load/save options from disk
 void utyOptionsFileRead(void);
diff -urPw homeworld-orig/src/SDL/mainrgn.c homeworld_sdl-0.3/src/SDL/mainrgn.c
--- homeworld-orig/src/SDL/mainrgn.c	2002-09-04 12:47:02.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/mainrgn.c	2004-08-01 22:35:07.000000000 -0700
@@ -8,79 +8,82 @@
 
 #undef UTY_SCREEN_SHOT
 
+#ifdef _WIN32
 #define WIN32_LEAN_AND_MEAN
 #include <windows.h>
+#endif
+
 #include <stdlib.h>
 #include <stdio.h>
 #include "glinc.h"
 #include <math.h>
 #include <float.h>
-#include "switches.h"
-#include "types.h"
-#include "fastmath.h"
-#include "region.h"
-#include "feflow.h"
-#include "debug.h"
+#include "Switches.h"
+#include "Types.h"
+#include "FastMath.h"
+#include "Region.h"
+#include "FEFlow.h"
+#include "Debug.h"
 #include "render.h"
-#include "camera.h"
-#include "cameracommand.h"
+#include "Camera.h"
+#include "CameraCommand.h"
 #include "mouse.h"
 #include "utility.h"
 #include "prim2d.h"
 #include "prim3d.h"
-#include "select.h"
-#include "universe.h"
-#include "univupdate.h"
-#include "soundevent.h"
-#include "consmgr.h"
-#include "trademgr.h"
+#include "Select.h"
+#include "Universe.h"
+#include "UnivUpdate.h"
+#include "SoundEvent.h"
+#include "ConsMgr.h"
+#include "TradeMgr.h"
 #include "CommandWrap.h"
 #include "Undo.h"
-#include "tactical.h"
-#include "globals.h"
+#include "Tactical.h"
+#include "Globals.h"
 #include "font.h"
-#include "sensors.h"
-#include "teams.h"
+#include "Sensors.h"
+#include "Teams.h"
 #include "mainrgn.h"
-#include "flightman.h"
-#include "particle.h"
-#include "etg.h"
+#include "FlightMan.h"
+#include "Particle.h"
+#include "ETG.h"
 #include "NumberDefs.h"
-#include "nis.h"
-#include "netcheck.h"
-#include "tweak.h"
+#include "NIS.h"
+#include "NetCheck.h"
+#include "Tweak.h"
 #include "main.h"
-#include "fontreg.h"
-#include "probe.h"
-#include "gun.h"
-#include "pieplate.h"
-#include "researchship.h"
-#include "launchMgr.h"
-#include "researchgui.h"
-#include "tactics.h"
+#include "FontReg.h"
+#include "Probe.h"
+#include "Gun.h"
+#include "PiePlate.h"
+#include "ResearchShip.h"
+#include "LaunchMgr.h"
+#include "ResearchGUI.h"
+#include "Tactics.h"
 #include "soundlow.h"
 #include "InfoOverlay.h"
 #include "glcaps.h"
-#include "singleplayer.h"
+#include "SinglePlayer.h"
 #include "KAS.h"
-#include "gamechat.h"
-#include "meshanim.h"
-#include "chatting.h"
+#include "GameChat.h"
+#include "MeshAnim.h"
+#include "Chatting.h"
 #include "Alliance.h"
-#include "shader.h"
+#include "Shader.h"
 #include "Objectives.h"
 #include "KASFunc.h"
-#include "tutor.h"
-#include "strings.h"
-#include "options.h"
-#include "taskbar.h"
-#include "shipview.h"
-#include "AIvar.h"
-#include "gamepick.h"
-#include "battle.h"
+#include "Tutor.h"
+#include "Strings.h"
+#include "Options.h"
+#include "TaskBar.h"
+#include "ShipView.h"
+#include "AIVar.h"
+#include "GamePick.h"
+#include "Battle.h"
 #include "Captaincy.h"
-#include "Commandnetwork.h"
-#include "bink.h"
+#include "CommandNetwork.h"
+/*#include "bink.h"*/
 #include "KeyBindings.h"
 
 /*=============================================================================
@@ -1453,7 +1456,7 @@
 #define MR_NumberMothershipTypes    8
 ubyte mrMothershipShipTypes[] = {Carrier, Mothership, P1Mothership, P2Mothership, P3Megaship, FloatingCity, ResearchStation, JunkYardHQ, 0};
 Ship *mrMothershipPtr = NULL;
-BOOL mrMothershipInFocus(Ship *mothership)
+bool mrMothershipInFocus(Ship *mothership)
 {
     FocusCommand *focus;
 
@@ -1465,7 +1468,7 @@
         return(TRUE);
     }
     return(FALSE);
-#else     11
+#else
     return(selShipInSelection(focus->ShipPtr, focus->numShips, mothership));
 #endif
 }
@@ -1558,7 +1561,7 @@
     {
         if (singlePlayerGame)
         {
-            if (binkDonePlaying)
+            /*if (binkDonePlaying)*/
             {
                 goto processEscapeKey;
             }
@@ -1572,8 +1575,19 @@
     //now translate
     //ID = (sdword)opKeyTranslate((keyindex)ID);
 
+// Q is a special case for MacOSX in that it forms part of the standard keyboard shortcut
+// for "quit". kbCheckBindings() checks if the key is bound to a *game* feature and if not
+// returns 0. Hence we lose the fact that Q was pressed before we reach the switch()
+// handler code unless we explicitly skip that lookup. Of course having checked for it
+// here we could also put the handler code here too but for consistency that's been left
+// in the switch().
+#ifdef _MACOSX                  
+    if (ID != QKEY)
+#endif
+    {
     // Drew's keybinding
     ID = (sdword)kbCheckBindings(ID);
+    }
 
     if (ID == CAPSLOCKKEY)
     {
@@ -2068,7 +2082,7 @@
             break;
 
         case EKEY:
-            caseEKey:
+        //    caseEKey:
 
             if (NoShift() && ((!(tutorial==TUTORIAL_ONLY)) || tutEnable.bBandSelect))
             {                                               //'E': select everyone onscreen
@@ -2273,7 +2287,6 @@
             {
                 focusOnMothership:;
                 {
-                    Ship *mothership = mrMothershipPtr;
                     FocusCommand focus;
                     //focus on mothership
                     if((tutorial==TUTORIAL_ONLY) && !tutEnable.bMothershipFocus)
@@ -2300,6 +2313,7 @@
                 mrMoveShips(NULL, NULL);
             }
             break;
+
         case RKEY:
 #if ETG_RELOAD_KEY
             if (!multiPlayerGame && keyIsHit(CONTROLKEY))
@@ -2381,7 +2395,24 @@
             }
 #endif
             break;
+
         case QKEY:
+#ifdef _MACOSX_FIX_ME
+            if (keyIsHit(METAKEY))  // Command-Q; player wants to quit!
+            {
+                // Ideally we'd have an "are you sure" dialog at this point but the nice
+                // dialogs that HW already has for this purpose have built-in fallbacks
+                // when they are cancelled which we don't want. Specifically, something
+                // like: feScreenStart(ghMainRegion, "Quit_game");
+                // will draw the main menu when cancelled, whilst "Quit_game2" draws the
+                // in-game "escape" menu. The first is a complete mess and cannot be
+                // undone; the second is no better than using the escape menu directly.
+                // Until we work out how to add a new Quit_ structure we just quit, no
+                // questions asked.
+                utyGameQuit(NULL, NULL);
+            }
+#endif
+
             if (pilotView)
                 bitToggle(universe.mainCameraCommand.ccMode,CCMODE_PILOT_SHIP);
             break;
@@ -3737,7 +3768,7 @@
                         destination = piePlanePoint;         //else move to point on plane
                     }
 
-                    if (!(_isnan((double)destination.x) || _isnan((double)destination.x) || _isnan((double)destination.x)))
+                    if (!(isnan((double)destination.x) || isnan((double)destination.x) || isnan((double)destination.x)))
                     {
                         clWrapMove(&universe.mainCommandLayer,(SelectCommand *)&selSelected,selCentrePoint,destination);
 //                        tutGameMessage("Game_MoveIssued");
@@ -3768,10 +3799,8 @@
                     abs(mouseCursorY() - mrOldMouseY) >= selClickBoxHeight)
                 {                                           //if selection rect dragged
                     mrSelectRectBuild(&mrSelectionRect, mrOldMouseX, mrOldMouseY);//select a group of ships
-                    if ((keyIsHit(ALTKEY) && keyIsHit(CONTROLKEY)) | keyIsHit(GKEY))
+                    if ((keyIsHit(ALTKEY) && keyIsHit(CONTROLKEY)) || keyIsHit(GKEY))
                     {                                       //alt key pressed
-//                        if (keyIsHit(CONTROLKEY))
-//                        {                                   //ctrl-alt bandbox: guard
                         if (mrDisabled) goto endReleaseButtonLogic;
 
                         selRectDragAnybody(&(universe.mainCameraCommand.actualcamera), &mrSelectionRect);//most recent selection
@@ -3795,7 +3824,6 @@
                             }
                             selSelecting.numTargets = 0;
                         }
-//                        }
                     }
                     else if (keyIsHit(ALTKEY))
                     {                                       //alt-bandbox: focus
@@ -4219,7 +4247,6 @@
     real32 distance, pulsedistance, fadesize;
     vector dirvect, pulsestart, pulseend, fadestart, fadeend;
     bool pulse_at_end = FALSE;
-    udword test = 0;
     bool draw_pulse_beg = TRUE, draw_fadein = FALSE, draw_fadeout = FALSE;
 
     pulse_at_beginning = FALSE;
@@ -4719,7 +4746,6 @@
 {
 
    hmatrix rotmat;
-   vector origin = {0.0, 0.0, 0.0};
    vector up =    {1.0, 0.0, 0.0};
    vector right = {0.0, 1.0, 0.0};
    vector head =  {0.0, 0.0, 1.0};
@@ -4935,7 +4961,6 @@
 {
 
    hmatrix rotmat;
-   vector origin = {0.0, 0.0, 0.0};
    vector up =    {1.0, 0.0, 0.0};
    vector right = {0.0, 1.0, 0.0};
    vector head =  {0.0, 0.0, 1.0};
@@ -5056,7 +5081,6 @@
    glPopMatrix();
    //stop drawing circles
 
-
    //Turn on 2D primmode
    primModeSet2();
 
@@ -5143,7 +5167,6 @@
 
    hmatrix rotmat;
    real32 newrad;
-   vector origin = {0.0, 0.0, 0.0};
    vector up =    {1.0, 0.0, 0.0};
    vector right = {0.0, 1.0, 0.0};
    vector head =  {0.0, 0.0, 1.0};
@@ -5250,7 +5273,6 @@
 
    hmatrix rotmat;
    real32 newrad;
-   vector origin = {0.0, 0.0, 0.0};
    vector up =    {1.0, 0.0, 0.0};
    vector right = {0.0, 1.0, 0.0};
    vector head =  {0.0, 0.0, 1.0};
diff -urPw homeworld-orig/src/SDL/mainrgn.h homeworld_sdl-0.3/src/SDL/mainrgn.h
--- homeworld-orig/src/SDL/mainrgn.h	2002-09-04 12:47:02.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/mainrgn.h	2004-08-01 22:35:07.000000000 -0700
@@ -9,11 +9,11 @@
 #ifndef ___MAINRGN_H
 #define ___MAINRGN_H
 
-#include "types.h"
-#include "region.h"
-#include "feflow.h"
+#include "Types.h"
+#include "Region.h"
+#include "FEFlow.h"
 #include "Camera.h"
-#include "spaceobj.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Switches:
diff -urPw homeworld-orig/src/SDL/mainswitches.h homeworld_sdl-0.3/src/SDL/mainswitches.h
--- homeworld-orig/src/SDL/mainswitches.h	2002-09-04 12:47:04.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/mainswitches.h	2004-08-01 22:35:06.000000000 -0700
@@ -2,19 +2,20 @@
 #ifndef ___MAINSWITCHES_H
 #define ___MAINSWITCHES_H
 
-#include "types.h"
+#include "Types.h"
 #ifndef STATVIEWER_PROGRAM
 //statviewer program is compiling this bitch...lets not do this
-#include "globals.h"
+#include "Globals.h"
 #endif
-#include "objtypes.h"
-#include "formation.h"
+#include "ObjTypes.h"
+#include "Formation.h"
 
 //command-line switches and parameters
 extern bool DebugWindow;
 extern sdword MemoryHeapSize;
 extern bool FilePathPrepended;
 extern bool CDROMPathPrepended;
+extern bool UserSettingsPathPrepended;
 extern bool mouseClipped;
 extern bool startupClipMouse;
 extern bool showFrontEnd;
Only in homeworld-orig/src/SDL: Md52.cpp
Only in homeworld-orig/src/SDL: Md52.h
diff -urPw homeworld-orig/src/SDL/mouse.c homeworld_sdl-0.3/src/SDL/mouse.c
--- homeworld-orig/src/SDL/mouse.c	2002-09-04 12:47:04.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/mouse.c	2004-08-01 22:35:10.000000000 -0700
@@ -6,40 +6,45 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
+#ifdef _WIN32
 #define WIN32_LEAN_AND_MEAN
 #include <windows.h>
+#endif
+
+#include "SDL.h"
+
 #include "DDDFrigate.h"
-#include "debug.h"
-#include "dock.h"
+#include "Debug.h"
+#include "Dock.h"
 #include "font.h"
-#include "fontreg.h"
+#include "FontReg.h"
 #include "glinc.h"
-#include "globals.h"
+#include "Globals.h"
 #include "GravWellGenerator.h"
 #include "main.h"
 #include "mainrgn.h"
 #include "mouse.h"
-#include "nis.h"
+#include "NIS.h"
 #include "prim2d.h"
-#include "select.h"
-#include "sensors.h"
-#include "shipselect.h"
-#include "soundevent.h"
-#include "spaceobj.h"
+#include "Select.h"
+#include "Sensors.h"
+#include "ShipSelect.h"
+#include "SoundEvent.h"
+#include "SpaceObj.h"
 #include "texreg.h"
-#include "tweak.h"
-#include "types.h"
-#include "universe.h"
+#include "Tweak.h"
+#include "Types.h"
+#include "Universe.h"
 #include "utility.h"
 #include "CommandWrap.h"
-#include "strings.h"
-#include "demo.h"
-#include "feflow.h"
-#include "researchGUI.h"
+#include "Strings.h"
+#include "Demo.h"
+#include "FEFlow.h"
+#include "ResearchGUI.h"
 #include "glcaps.h"
 #include "render.h"
-#include "tutor.h"
-#include "singleplayer.h"
+#include "Tutor.h"
+#include "SinglePlayer.h"
 #include "glcompat.h"
 #include "KeyBindings.h"
 #include "InfoOverlay.h"
@@ -133,7 +138,6 @@
 static lifheader *mouseNormalBitmap              = NULL;
 static lifheader *mouseAddShipsBitmap            = NULL;
 static lifheader *mouseFocusNoSelectBitmap       = NULL;
-static lifheader *mouseMovementBitmap            = NULL;
 static lifheader *mouseBandBoxAttackBitmap       = NULL;
 static lifheader *mouseForceAttackBitmap         = NULL;
 static lifheader *mouseGuardBitmap               = NULL;
@@ -154,7 +158,6 @@
 static GLuint tex_Normal = 0;
 static GLuint tex_AddShips = 0;
 static GLuint tex_FocusNoSelect = 0;
-static GLuint tex_Movement = 0;
 static GLuint tex_BandBoxAttack = 0;
 static GLuint tex_ForceAttack = 0;
 static GLuint tex_Guard = 0;
@@ -266,6 +269,7 @@
 ----------------------------------------------------------------------------*/
 sdword mouseStartup(void)
 {
+    /*
     RECT clientRect, windowRect;
     POINT mousePoint;
 
@@ -274,6 +278,8 @@
     GetCursorPos(&mousePoint);                              //get location of Windows mouse cursor
     mouseCursorXPosition = mousePoint.x - windowRect.left;  //compute relative coords
     mouseCursorYPosition = mousePoint.y - windowRect.top;
+    */
+    SDL_GetMouseState(&mouseCursorXPosition, &mouseCursorYPosition);
 
     mouseNormalBitmap              = trLIFFileLoad(MC_NORMAL_BM, NonVolatile);
     mouseAddShipsBitmap            = trLIFFileLoad(MC_ADD_SHIPS_BM, NonVolatile);
@@ -313,7 +319,8 @@
     mouseMirrorBitmap((udword *)mouseSupportBitmap->data, mouseSupportBitmap->width, mouseSupportBitmap->height);
     mouseMirrorBitmap((udword *)mouseTradersBitmap->data, mouseTradersBitmap->width, mouseTradersBitmap->height);
 
-    mouseDoubleClickTime = GetDoubleClickTime() / 1000.0f;
+    /*mouseDoubleClickTime = GetDoubleClickTime() / 1000.0f;*/
+    mouseDoubleClickTime = 0.5f;  /* Consistent with HandleEvent() in main.c. */
     mouseCursorFont      = frFontRegister(TW_CURSORTEXT_FONT);
 
     mouseGLInitialized = FALSE;
@@ -458,11 +465,12 @@
 {
     rectangle clientRect;
 //    RECT clientRect, windowRect;
-    POINT mousePoint;
+//    POINT mousePoint;
 
     utyClientRectGet(&clientRect);                          //get window location
 //  GetWindowRect(ghMainWindow, &windowRect);
 //  GetClientRect(ghMainWindow, &clientRect);               //get location of window
+/*
 #if MOUSE_CURSOR_CLAMP
     //clamp specified mouse location
     if (x < 0)
@@ -482,11 +490,16 @@
         y = clientRect.y1 - clientRect.y0 - 1;
     }
 #endif
+*/
     mouseCursorXPosition = x;                               //set internal mouse location
     mouseCursorYPosition = y;
+    /*
     mousePoint.x = clientRect.x0 + x;                       //compute Windows mouse location
     mousePoint.y = clientRect.y0 + y;
     SetCursorPos(mousePoint.x, mousePoint.y);               //set Windows mouse location
+    */
+
+    SDL_WarpMouse(x, y);
 }
 
 /*-----------------------------------------------------------------------------
@@ -577,7 +590,7 @@
 //            rmResearchGUIBegin(ghMainRegion,(sdword)selSelected.ShipPtr[0], 0, 0);
 //        }
 //        else
-#endif !MR_GUI_SINGLECLICK
+#endif  // !MR_GUI_SINGLECLICK
 //        if (ShiptypeInSelection((SelectCommand *)&mouseCursorSelect, RepairCorvette) ||
 //            ((ShiptypeInSelection((SelectCommand *)&mouseCursorSelect, AdvanceSupportFrigate) ||
 //              ShiptypeInSelection((SelectCommand *)&mouseCursorSelect, Carrier)) &&
@@ -1879,7 +1892,7 @@
 void mousePoll(void)
 {
     rectangle clientRect;
-    POINT mousePoint;
+    //POINT mousePoint;
 
     if (mouseDisabled)
     {
@@ -1890,9 +1903,12 @@
         return;
     }
     utyClientRectGet(&clientRect);                          //get window location
+    /*
     GetCursorPos(&mousePoint);                              //get location of Windows mouse cursor
     mouseCursorXPosition = mousePoint.x - clientRect.x0;    //compute relative coords
     mouseCursorYPosition = mousePoint.y - clientRect.y0;
+    */
+    SDL_GetMouseState(&mouseCursorXPosition, &mouseCursorYPosition);
 
     if (mouseClip)
     {
@@ -1900,11 +1916,13 @@
         mousePositionSet(mouseCursorXPosition, mouseCursorYPosition);
     }
     //perform client area enter/exit logic to hide/show Windows system cursor
+    /*
     if (primPointInRectXY2(&clientRect, mousePoint.x, mousePoint.y))
     {                                                       //mouse inside window's client area
         if (!mouseInsideClient)
         {                                                   //just entered region
-            ShowCursor(FALSE);
+            //ShowCursor(FALSE);
+            SDL_ShowCursor(SDL_DISABLE);
             mouseInsideClient = TRUE;
         }
     }
@@ -1912,10 +1930,12 @@
     {                                                       //else outside region
         if (mouseInsideClient)
         {                                                   //just exited region
-            ShowCursor(TRUE);
+            //ShowCursor(TRUE);
+            SDL_ShowCursor(SDL_ENABLE);
             mouseInsideClient = FALSE;
         }
     }
+    */
 }
 
 /*-----------------------------------------------------------------------------
diff -urPw homeworld-orig/src/SDL/mouse.h homeworld_sdl-0.3/src/SDL/mouse.h
--- homeworld-orig/src/SDL/mouse.h	2002-09-04 12:47:04.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/mouse.h	2004-08-01 22:35:11.000000000 -0700
@@ -9,9 +9,9 @@
 #ifndef ___MOUSE_H
 #define ___MOUSE_H
 
-#include "types.h"
+#include "Types.h"
 #include "prim2d.h"
-#include "spaceobj.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Switches:
Only in homeworld-orig/src/SDL: mssccprj.scc
diff -urPw homeworld-orig/src/SDL/prim2d.c homeworld_sdl-0.3/src/SDL/prim2d.c
--- homeworld-orig/src/SDL/prim2d.c	2002-09-04 12:47:04.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/prim2d.c	2004-08-01 22:35:11.000000000 -0700
@@ -6,13 +6,17 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
+#ifdef _WIN32
 #define WIN32_LEAN_AND_MEAN
 #include <windows.h>
+#endif
+
 #include "glinc.h"
 #include <stdlib.h>
 #include <math.h>
-#include "types.h"
-#include "debug.h"
+#include <string.h>
+#include "Types.h"
+#include "Debug.h"
 #include "main.h"
 #include "render.h"
 #include "prim2d.h"
diff -urPw homeworld-orig/src/SDL/prim2d.h homeworld_sdl-0.3/src/SDL/prim2d.h
--- homeworld-orig/src/SDL/prim2d.h	2002-09-04 12:47:04.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/prim2d.h	2004-08-01 22:35:05.000000000 -0700
@@ -9,7 +9,7 @@
 #ifndef ___PRIM2D_H
 #define ___PRIM2D_H
 
-#include "types.h"
+#include "Types.h"
 #include "color.h"
 #include "main.h"
 
diff -urPw homeworld-orig/src/SDL/prim3d.c homeworld_sdl-0.3/src/SDL/prim3d.c
--- homeworld-orig/src/SDL/prim3d.c	2002-09-04 12:47:04.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/prim3d.c	2004-08-01 22:35:08.000000000 -0700
@@ -6,19 +6,22 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
+#ifdef _WIN32
 #define WIN32_LEAN_AND_MEAN
+#include <windows.h>
+#endif
+
 #include <math.h>
 #include <stdlib.h>
-#include <windows.h>
-#include "debug.h"
+#include "Debug.h"
 #include "glinc.h"
-#include "linkedlist.h"
-#include "memory.h"
+#include "LinkedList.h"
+#include "Memory.h"
 #include "prim3d.h"
 #include "render.h"
 #include "texreg.h"
-#include "types.h"
-#include "vector.h"
+#include "Types.h"
+#include "Vector.h"
 #include "glcaps.h"
 #include "devstats.h"
 
diff -urPw homeworld-orig/src/SDL/prim3d.h homeworld_sdl-0.3/src/SDL/prim3d.h
--- homeworld-orig/src/SDL/prim3d.h	2002-09-04 12:47:04.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/prim3d.h	2004-08-01 22:35:08.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___PRIM3D_H
 #define ___PRIM3D_H
 
-#include "types.h"
-#include "vector.h"
+#include "Types.h"
+#include "Vector.h"
 #include "color.h"
 #include "texreg.h"
 
diff -urPw homeworld-orig/src/SDL/Queue.c homeworld_sdl-0.3/src/SDL/Queue.c
--- homeworld-orig/src/SDL/Queue.c	2002-09-04 12:47:04.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/Queue.c	2004-08-01 22:35:08.000000000 -0700
@@ -1,11 +1,9 @@
 
-#define WIN32_LEAN_AND_MEAN
-#include <windows.h>
-#include <winbase.h>
-#include "types.h"
-#include "debug.h"
-#include "memory.h"
-#include "queue.h"
+#include <string.h>
+#include "Types.h"
+#include "Debug.h"
+#include "Memory.h"
+#include "Queue.h"
 
 #define QUEUE_WRAPAROUND_FLAG   0xffffffffL
 
@@ -35,7 +33,7 @@
 ----------------------------------------------------------------------------*/
 void InitQueue(Queue *queue,udword buffersize)
 {
-    queue->mutex = (void *)CreateMutex(NULL,FALSE,NULL);
+    queue->mutex = SDL_CreateMutex();
     dbgAssert(queue->mutex != NULL);
     queue->buffer = memAlloc(buffersize,"qbuffer",NonVolatile);
     queue->buffersize = buffersize;
@@ -51,7 +49,7 @@
 ----------------------------------------------------------------------------*/
 void CloseQueue(Queue *queue)
 {
-    CloseHandle((HANDLE)queue->mutex);
+    SDL_DestroyMutex(queue->mutex);
     queue->mutex = NULL;
     memFree(queue->buffer);
     queue->buffer = NULL;
@@ -66,8 +64,8 @@
 ----------------------------------------------------------------------------*/
 void LockQueue(Queue *queue)
 {
-    DWORD result = WaitForSingleObject((HANDLE)queue->mutex,INFINITE);
-    dbgAssert(result != WAIT_FAILED);
+    int result = SDL_mutexP(queue->mutex);
+    dbgAssert(result != -1);
 }
 
 /*-----------------------------------------------------------------------------
@@ -79,8 +77,8 @@
 ----------------------------------------------------------------------------*/
 void UnLockQueue(Queue *queue)
 {
-    BOOL result = ReleaseMutex((HANDLE)queue->mutex);
-    dbgAssert(result);
+    int result = SDL_mutexV(queue->mutex);
+    dbgAssert(result != -1);
 }
 
 /*-----------------------------------------------------------------------------
@@ -90,7 +88,7 @@
     Outputs     :
     Return      :
 ----------------------------------------------------------------------------*/
-void Enqueue(Queue *queue,ubyte *packet,udword sizeofPacket)
+void HWEnqueue(Queue *queue,ubyte *packet,udword sizeofPacket)
 {
     ubyte *writeto;
     udword sizeinQ = sizeof(udword) + sizeofPacket;
@@ -133,7 +131,7 @@
     Outputs     : packet pointer
     Return      : size of data returned
 ----------------------------------------------------------------------------*/
-udword Dequeue(Queue *queue,ubyte **packet)
+udword HWDequeue(Queue *queue,ubyte **packet)
 {
     ubyte *readfrom;
     udword sizeofPacket;
diff -urPw homeworld-orig/src/SDL/Queue.h homeworld_sdl-0.3/src/SDL/Queue.h
--- homeworld-orig/src/SDL/Queue.h	2002-09-04 12:47:04.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/Queue.h	2004-08-01 22:35:08.000000000 -0700
@@ -2,7 +2,8 @@
 #ifndef ___QUEUE_H
 #define ___QUEUE_H
 
-#include "types.h"
+#include "SDL.h"
+#include "Types.h"
 
 /*=============================================================================
     Types:
@@ -10,7 +11,8 @@
 
 typedef struct
 {
-    void *mutex;
+    //void *mutex;
+    SDL_mutex *mutex;
     ubyte *buffer;
     udword buffersize;
     udword head;
@@ -28,8 +30,8 @@
 void InitQueue(Queue *queue,udword buffersize);
 void CloseQueue(Queue *queue);
 void ResetQueue(Queue *queue);
-void Enqueue(Queue *queue,ubyte *packet,udword sizeofPacket);
-udword Dequeue(Queue *queue,ubyte **packet);
+void HWEnqueue(Queue *queue,ubyte *packet,udword sizeofPacket);
+udword HWDequeue(Queue *queue,ubyte **packet);
 udword Peekqueue(Queue *queue,ubyte **packet);
 void LockQueue(Queue *queue);
 void UnLockQueue(Queue *queue);
Only in homeworld-orig/src/SDL: radbink.h
Only in homeworld-orig/src/SDL: rad.h
diff -urPw homeworld-orig/src/SDL/regkey.h homeworld_sdl-0.3/src/SDL/regkey.h
--- homeworld-orig/src/SDL/regkey.h	2002-09-04 12:47:04.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/regkey.h	2004-08-01 22:35:08.000000000 -0700
@@ -7,8 +7,11 @@
 // Do not change these registry key definitions! The installer depends on them...
 #if defined(Downloadable)
 #define BASEKEYNAME "SOFTWARE\\Sierra On-Line\\Homeworld Downloadable"
+#define CONFIGDIR ".homeworldDownloadable"
 #elif defined(OEM)
 #define BASEKEYNAME "SOFTWARE\\Sierra On-Line\\Homeworld OEM"
+#define CONFIGDIR ".homeworldOEM"
 #else
 #define BASEKEYNAME "SOFTWARE\\Sierra On-Line\\Homeworld"
+#define CONFIGDIR ".homeworld"
 #endif
Only in homeworld-orig/src/SDL: Release.depend
diff -urPw homeworld-orig/src/SDL/render.c homeworld_sdl-0.3/src/SDL/render.c
--- homeworld-orig/src/SDL/render.c	2002-09-04 12:47:04.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/render.c	2004-08-01 22:35:10.000000000 -0700
@@ -38,82 +38,88 @@
 #define USE_RND_HINT        0
 #define WILL_TWO_PASS       0
 
+#include <stdio.h>
+#include <stdlib.h>
+
+#ifdef _WIN32
 #define WIN32_LEAN_AND_MEAN
 #include <windows.h>
+#else
+    #include <sys/mman.h>
+#endif
+
 #include "glinc.h"
-#include <stdio.h>
-#include <stdlib.h>
 #include <math.h>
 #include <float.h>
-#include "debug.h"
-#include "switches.h"
-#include "netcheck.h"
-#include "spaceobj.h"
+#include "Debug.h"
+#include "Switches.h"
+#include "NetCheck.h"
+#include "SpaceObj.h"
 #include "mouse.h"
 #include "prim2d.h"
-#include "region.h"
-#include "task.h"
-#include "key.h"
-#include "universe.h"
-#include "nis.h"
-#include "camera.h"
-#include "cameracommand.h"
+#include "Region.h"
+#include "Task.h"
+#include "Key.h"
+#include "Universe.h"
+#include "NIS.h"
+#include "Camera.h"
+#include "CameraCommand.h"
 #include "prim3d.h"
 #include "font.h"
-#include "select.h"
+#include "Select.h"
 #include "texreg.h"
 #include "utility.h"
-#include "globals.h"
+#include "Globals.h"
 #include "light.h"
-#include "shader.h"
-#include "tactical.h"
-#include "mesh.h"
+#include "Shader.h"
+#include "Tactical.h"
+#include "Mesh.h"
 #include "render.h"
-#include "collision.h"
-#include "univupdate.h"
-#include "soundevent.h"
-#include "gun.h"
-#include "dock.h"
-#include "navlights.h"
+#include "Collision.h"
+#include "UnivUpdate.h"
+#include "SoundEvent.h"
+#include "Gun.h"
+#include "Dock.h"
+#include "NavLights.h"
 #include "main.h"
-#include "tweak.h"
-#include "defensefighter.h"
-#include "clouds.h"
-#include "nebulae.h"
-#include "fastmath.h"
-#include "btg.h"
-#include "demo.h"
-#include "file.h"
-#include "clipper.h"
+#include "Tweak.h"
+#include "DefenseFighter.h"
+#include "Clouds.h"
+#include "Nebulae.h"
+#include "FastMath.h"
+#include "BTG.h"
+#include "Demo.h"
+#include "File.h"
+#include "Clipper.h"
 #include "glcaps.h"
-#include "teams.h"
-#include "singleplayer.h"
-#include "hs.h"
+#include "Teams.h"
+#include "SinglePlayer.h"
+#include "HS.h"
 #include "screenshot.h"
-#include "salcapcorvette.h"
-#include "autolod.h"
-#include "proximitysensor.h"
-#include "objectives.h"
-#include "subtitle.h"
-#include "tutor.h"
-#include "animatic.h"
-#include "bink.h"
+#include "SalCapCorvette.h"
+#include "AutoLOD.h"
+#include "ProximitySensor.h"
+#include "Objectives.h"
+#include "Subtitle.h"
+#include "Tutor.h"
+#include "Animatic.h"
+/*#include "bink.h"*/
 #include "StringsOnly.h"
 #include "mainrgn.h"
-#include "aiship.h"
-#include "commandnetwork.h"
+#include "AIShip.h"
+#include "CommandNetwork.h"
 #include "ProfileTimers.h"
 #include "LagPrint.h"
 #include "glcompat.h"
-#include "tracking.h"
-#include "launchmgr.h"
+#include "Tracking.h"
+#include "LaunchMgr.h"
 #include "devstats.h"
 
 bool8 rndFogOn = FALSE;
 
 #if RND_VISUALIZATION
-extern BOOL dockLines;
-extern BOOL gunLines;
+extern bool dockLines;
+extern bool gunLines;
 extern bool8 RENDER_BOXES;
 extern bool8 RENDER_LIGHTLINES;
 #endif
@@ -140,9 +146,15 @@
 
 static sdword rndHint = 0;
 
+/* Should remove this stuff after cleaning up rgl functions. */
+/*
 HGLRC hGLRenderContext;
 HDC hGLDeviceContext;
 HWND hGLWindow;
+*/
+udword hGLRenderContext;
+udword hGLDeviceContext;
+udword hGLWindow;
 
 udword meshRenders;
 
@@ -479,9 +491,21 @@
     GLboolean bools[MAX_BOOLS];
     char totalString[256];
     char valueString[128];
+    char *fileNameFull;
     FILE *f;
 
-    f = fopen(rndGLStateLogFileName, "at");
+    fileNameFull = filePathPrepend(rndGLStateLogFileName, FF_UserSettingsPath);
+
+    if (!fileMakeDestinationDirectory(fileNameFull))
+    {
+        dbgMessagef(
+            "\nError creating directory for '%s' for GL state logging.",
+            rndGLStateLogFileName);
+
+        return;
+    }
+
+    f = fopen(fileNameFull, "at");
     if (f == NULL)
     {
         dbgMessagef("\nError opening '%s' for GL state logging.", rndGLStateLogFileName);
@@ -633,7 +657,9 @@
 
     taskYield(0);
 
+#ifndef C_ONLY
     while (1)
+#endif
     {
         taskStackSaveCond(0);
         rndFrameRate = rndFrameCount - rndFrameRateStart;   //number of frames since last printed
@@ -691,7 +717,9 @@
 
     taskYield(0);
 
+#ifndef C_ONLY
     while (1)
+#endif
     {
         taskStackSaveCond(0);
 
@@ -787,7 +815,6 @@
     if (selSelected.numShips == 1)
     {
         Ship* ship = selSelected.ShipPtr[0];
-        ShipStaticInfo* shipstaticinfo = (ShipStaticInfo*)ship->staticinfo;
 
         if (ship->trail[0] == NULL)
         {
@@ -810,99 +837,104 @@
     sprintf(rndCapScaleCapStatsString, "\n trailScaleCap %f", scalar);
 }
 
-bool setupPixelFormat(HDC hDC)
+/*bool setupPixelFormat(HDC hDC)*/
+bool setupPixelFormat()
 {
-    int pixelFormat;
-    PIXELFORMATDESCRIPTOR pfd =
+	Uint32 flags;
+	static Uint32 lastWidth  = 0;
+	static Uint32 lastHeight = 0;
+	static Uint32 lastDepth  = 0;
+	static bool   lastFull   = FALSE;
+
+    // don't bother doing anything if nothing's actually changed
+	if(lastWidth  == MAIN_WindowWidth
+    && lastHeight == MAIN_WindowHeight
+    && lastDepth  == MAIN_WindowDepth
+    && lastFull   == fullScreen)
     {
-        sizeof(PIXELFORMATDESCRIPTOR),  /* size */
-        1,              /* version */
-        PFD_SUPPORT_OPENGL |
-        PFD_DRAW_TO_WINDOW |
-        PFD_DOUBLEBUFFER,       /* support double-buffering */
-        PFD_TYPE_RGBA,          /* color type */
-//        16,             /* prefered color depth */
-        MAIN_WindowDepth,
-        0, 0, 0, 0, 0, 0,       /* color bits (ignored) */
-        0,              /* no alpha buffer */
-        0,              /* alpha bits (ignored) */
-        0,              /* no accumulation buffer */
-        0, 0, 0, 0,         /* accum bits (ignored) */
-        16,             /* depth buffer */
-        0,              /* no stencil buffer */
-        0,              /* no auxiliary buffers */
-        PFD_MAIN_PLANE,         /* main layer */
-        0,              /* reserved */
-        0, 0, 0,            /* no layer, visible, damage masks */
-    };
-
-    if (rwglChoosePixelFormat == NULL || glNT)
-    {
-        pixelFormat = ChoosePixelFormat(hDC, &pfd);
+		return TRUE;
     }
-    else
+
+	/* SDL video initialized? */
+	flags = SDL_WasInit(SDL_INIT_EVERYTHING);
+	if (!flags)
     {
-        pixelFormat = rwglChoosePixelFormat(hDC, &pfd);
+		if (SDL_Init(SDL_INIT_VIDEO) == -1)
+			return FALSE;
     }
-    if (pixelFormat == 0)
+	else if (!(flags & SDL_INIT_VIDEO))
     {
-        dbgMessagef("\nChoosePixelFormat failed (%d).", GetLastError());
+		if (SDL_InitSubSystem(SDL_INIT_VIDEO) == -1)
         return FALSE;
     }
 
-    if (rwglSetPixelFormat == NULL || glNT)
-    {
-        if (SetPixelFormat(hDC, pixelFormat, &pfd) != TRUE)
-        {
-            dbgMessagef("\nSetPixelFormat failed (%d).", GetLastError());
+	/* Set attributes. */
+	SDL_GL_SetAttribute(SDL_GL_BUFFER_SIZE,  MAIN_WindowDepth);
+	SDL_GL_SetAttribute(SDL_GL_DEPTH_SIZE,   16);
+	SDL_GL_SetAttribute(SDL_GL_STENCIL_SIZE, 0);
+	SDL_GL_SetAttribute(SDL_GL_DOUBLEBUFFER, 1);
+
+	/* Create OpenGL window. */
+	flags = SDL_HWSURFACE | SDL_OPENGL;
+	if (/* main */ fullScreen) flags |= SDL_FULLSCREEN;
+	if (!SDL_SetVideoMode(MAIN_WindowWidth, MAIN_WindowHeight,
+		MAIN_WindowDepth, flags))
             return FALSE;
+
+	int FSAA = 0/*os_config_read_uint( NULL, "FSAA", 1 )*/;
+	if ( FSAA ) {
+	    SDL_GL_SetAttribute( SDL_GL_MULTISAMPLEBUFFERS, 1 );
+	    SDL_GL_SetAttribute( SDL_GL_MULTISAMPLESAMPLES, FSAA );
         }
-    }
-    else
+
+	if (SDL_SetVideoMode (MAIN_WindowWidth, MAIN_WindowHeight, MAIN_WindowDepth, flags) == NULL)
     {
-        if (rwglSetPixelFormat(hDC, pixelFormat, &pfd) != TRUE)
+	    fprintf (stderr, "Couldn't set FSAA video mode: %s\n", SDL_GetError ());
+	    SDL_GL_SetAttribute( SDL_GL_MULTISAMPLEBUFFERS, 0 );
+	    SDL_GL_SetAttribute( SDL_GL_MULTISAMPLESAMPLES, 0 );
+
+	    if (SDL_SetVideoMode (MAIN_WindowWidth, MAIN_WindowHeight, MAIN_WindowDepth, flags) == NULL)
         {
-            dbgMessagef("\nSetPixelFormat failed (%d).", GetLastError());
+		fprintf (stderr, "Couldn't set video mode: %s\n", SDL_GetError ());
+		//exit (1);
             return FALSE;
         }
     }
 
-    return TRUE;
-}
-
-bool setupPalette(HDC hDC)
-{
-    int pixelFormat;
-    PIXELFORMATDESCRIPTOR pfd;
+	SDL_ShowCursor(SDL_DISABLE);
 
-    if (rwglGetPixelFormat == NULL || glNT)
+#ifdef _MACOSX_FIX_ME
+	if (!((flags & SDL_FULLSCREEN)))
     {
-        pixelFormat = GetPixelFormat(hDC);
+		SDL_WM_GrabInput(SDL_GRAB_ON);
     }
-    else
-    {
-        pixelFormat = rwglGetPixelFormat(hDC);
+#endif
+
+	lastWidth  = MAIN_WindowWidth;
+	lastHeight = MAIN_WindowHeight;
+	lastDepth  = MAIN_WindowDepth;
+	lastFull   = fullScreen;
+
+	return TRUE;
     }
 
-    if (rwglDescribePixelFormat == NULL || glNT)
+/*bool setupPalette(HDC hDC)*/
+bool setupPalette()
     {
-        DescribePixelFormat(hDC, pixelFormat, sizeof(PIXELFORMATDESCRIPTOR), &pfd);
-    }
-    else
+	int pix_size;
+
+	/* Never call SDL_GL_GetAttribute when using RGL... */
+	if (SDL_GL_GetAttribute(SDL_GL_BUFFER_SIZE, &pix_size) == -1)
     {
-        rwglDescribePixelFormat(hDC, pixelFormat, sizeof(PIXELFORMATDESCRIPTOR), &pfd);
+		/* Hoping it will work... */
+		pix_size = MAIN_WindowDepth;
     }
+	if (pix_size >= 15)
+		return TRUE;
 
-    if (pfd.dwFlags & PFD_NEED_PALETTE)
-    {
         dbgMessage("rndInit: needs paletted display");
         return FALSE;
     }
-    else
-    {
-        return TRUE;
-    }
-}
 
 typedef int (*AUXINITPOSITIONPROC)(GLuint, GLuint, GLuint, GLuint, GLuint);
 
@@ -910,18 +942,32 @@
 {
     if (GL)
     {
+        Uint32 flags;
+
+        /*
         hGLWindow = initData->hWnd;
         hGLDeviceContext = GetDC(initData->hWnd);
-        if (!setupPixelFormat(hGLDeviceContext))
+        */
+        /*if (!setupPixelFormat(hGLDeviceContext))*/
+        if (!setupPixelFormat())
         {
             return FALSE;
         }
-        if (!setupPalette(hGLDeviceContext))
+        /*if (!setupPalette(hGLDeviceContext))*/
+        if (!setupPalette())
         {
+            /* Kill the window we created. */
+            flags = SDL_WasInit(SDL_INIT_EVERYTHING);
+            if (flags & ~SDL_INIT_VIDEO)
+                SDL_QuitSubSystem(SDL_INIT_VIDEO);
+            else
+                SDL_Quit();
             return FALSE;
         }
+        /*
         hGLRenderContext = (HGLRC)rwglCreateContext((unsigned int)hGLDeviceContext);
         rwglMakeCurrent((int)hGLDeviceContext, (int)hGLRenderContext);
+        */
     }
     else
     {
@@ -930,7 +976,7 @@
         initPositionProc = (AUXINITPOSITIONPROC)rwglGetProcAddress("rauxInitPosition");
         dbgAssert(initPositionProc != NULL);
 
-        hGLWindow = initData->hWnd;
+        hGLWindow = (udword)(initData->hWnd);
         rglCreateWindow((GLint)hGLWindow, (GLint)MAIN_WindowWidth, (GLint)MAIN_WindowDepth);
 
         if (!initPositionProc(0, 0, initData->width, initData->height, MAIN_WindowDepth))
@@ -939,8 +985,10 @@
         }
     }
 
+#ifndef _MACOSX_FIX_ME
     glLockArraysEXT = (LOCKARRAYSEXTproc)rwglGetProcAddress("glLockArraysEXT");
     glUnlockArraysEXT = (UNLOCKARRAYSEXTproc)rwglGetProcAddress("glUnlockArraysEXT");
+#endif
 
     return TRUE;
 }
@@ -963,20 +1011,26 @@
 
     if (!RGL)
     {
+        /*
         hGLWindow = initData->hWnd;
         hGLDeviceContext = GetDC(initData->hWnd);
-        if (!setupPixelFormat(hGLDeviceContext))
+        */
+        /*if (!setupPixelFormat(hGLDeviceContext))*/
+        if (!setupPixelFormat())
         {
             dbgMessage("\nrndInit: GL couldn't setupPixelFormat");
             return !OKAY;
         }
-        if (!setupPalette(hGLDeviceContext))
+        /*if (!setupPalette(hGLDeviceContext))*/
+        if (!setupPalette())
         {
             dbgMessage("\nrndInit: GL couldn't setupPalette");
             return !OKAY;
         }
+        /*
         hGLRenderContext = (HGLRC)rwglCreateContext((unsigned int)hGLDeviceContext);  //greate GL render context and select into window
         rwglMakeCurrent((int)hGLDeviceContext, (int)hGLRenderContext);
+        */
 
 //        auxInitPosition(0, 0, initData->width, initData->height);   //create the viewport for rendering
 //        auxInitDisplayMode(AUX_RGB | AUX_DEPTH | AUX_DOUBLE);       //set mode (direct color, Z-buffered, double buffered)
@@ -988,7 +1042,7 @@
         initPositionProc = (AUXINITPOSITIONPROC)rwglGetProcAddress("rauxInitPosition");
         dbgAssert(initPositionProc != NULL);
 
-        hGLWindow = initData->hWnd;
+        hGLWindow = (udword)(initData->hWnd);
         rglCreateWindow((GLint)hGLWindow, (GLint)MAIN_WindowWidth, (GLint)MAIN_WindowDepth);
 
         if (!initPositionProc(0, 0, initData->width, initData->height, MAIN_WindowDepth))
@@ -1057,8 +1111,10 @@
 
     glDepthFunc(glCapDepthFunc);
 
+#ifndef _MACOSX_FIX_ME
     glLockArraysEXT = (LOCKARRAYSEXTproc)rwglGetProcAddress("glLockArraysEXT");
     glUnlockArraysEXT = (UNLOCKARRAYSEXTproc)rwglGetProcAddress("glUnlockArraysEXT");
+#endif
 
     return(OKAY);
 }
@@ -1078,12 +1134,21 @@
     }
     else
     {
+        /*
         if (hGLRenderContext)
         {
             rwglMakeCurrent(0, 0);                              //release GL render context
             rwglDeleteContext((int)hGLRenderContext);
         }
         ReleaseDC(hGLWindow, hGLDeviceContext);                 //release the Device context
+        */
+		Uint32 flags = SDL_WasInit(SDL_INIT_EVERYTHING);
+		if (!(flags & SDL_INIT_VIDEO))
+			return;
+		if (flags ^ SDL_INIT_VIDEO)
+			SDL_QuitSubSystem(SDL_INIT_VIDEO);
+		else
+			SDL_Quit();
     }
 }
 
@@ -1892,8 +1957,8 @@
         primLine3(&nisCamera->eyeposition, &cameraVector, flashFlag ? colWhite : colFuscia);
         vecScalarMultiply(upVector, nisCamera->upvector, 200);
         vecAdd(upVector, nisCamera->eyeposition, upVector);
-//        upVector.z -= abs(nisCamera->eyeposition.z - cameraVector.z) +
-//            abs(nisCamera->eyeposition.y - cameraVector.y);
+//        upVector.z -= ABS(nisCamera->eyeposition.z - cameraVector.z) +
+//            ABS(nisCamera->eyeposition.y - cameraVector.y);
         primLine3(&nisCamera->eyeposition, &upVector, colWhite);
 //      if (selSelected.numShips > 0)
 //      {
@@ -2266,10 +2331,12 @@
 
     dbgAssert(camera != NULL); //verify parameters
 
+#if 0   /* Bink stuff... */
     if (!binkDonePlaying)
     {                               //!!! can be cleaned up using the render function pointer
         return;
     }
+#endif
 
     if (RGL)
     {
@@ -2612,7 +2679,7 @@
                                         }
                                         scaleFactor = 1.0f - selCameraSpace.z * shipStaticInfo->scaleCap;
 #if RND_VERBOSE_LEVEL >= 1
-                                        if (_isnan((double)scaleFactor))
+                                        if (isnan((double)scaleFactor))
                                         {
                                             dbgMessage("\n-- scaleFactor is NaN --");
                                         }
@@ -3161,6 +3228,10 @@
                    }
                 }
                 etgEffectDraw(effect);
+                break;
+
+            default:
+                dbgFatalf(DBG_Loc, "Undefined object type %d", spaceobj->objtype);
 dontdraw3:;
             }
             objnode = objnode->next;
@@ -3274,6 +3345,26 @@
     head.colorMapType = *pdata++;
     head.imageType = *pdata++;
     psdata = (uword*)pdata;
+
+#ifdef ENDIAN_BIG
+    head.colorMapStartIndex = LittleShort(*psdata);
+    pdata += 2;
+    psdata = (uword*)pdata;
+    head.colorMapNumEntries = LittleShort(*psdata);
+    pdata += 2;
+    head.colorMapBitsPerEntry = *pdata++;
+    psdata = (uword*)pdata;
+    head.imageOffsetX = LittleShort((sword)*psdata);
+    pdata += 2;
+    psdata = (uword*)pdata;
+    head.imageOffsetY = LittleShort((sword)*psdata);
+    pdata += 2;
+    psdata = (uword*)pdata;
+    head.imageWidth = LittleShort(*psdata);
+    pdata += 2;
+    psdata = (uword*)pdata;
+    head.imageHeight = LittleShort(*psdata);
+#else
     head.colorMapStartIndex = *psdata;
     pdata += 2;
     psdata = (uword*)pdata;
@@ -3291,6 +3382,8 @@
     pdata += 2;
     psdata = (uword*)pdata;
     head.imageHeight = *psdata;
+#endif
+
     pdata += 2;
     head.pixelDepth = *pdata++;
     head.imageDescriptor = *pdata++;
@@ -3877,7 +3970,9 @@
 #endif
     taskYield(0);
 
+#ifndef C_ONLY
     while (1)
+#endif
     {
         taskStackSaveCond(0);
         primErrorMessagePrint();
@@ -3888,6 +3983,7 @@
 #if RND_GL_STATE_DEBUG
         if (keyIsHit(GKEY) && keyIsStuck(LKEY))
         {                                                   //if starting a new round of state saving
+            static char *fileNameFull;
             static FILE *f;
             keyClearSticky(LKEY);
             rndGLStateSaving = TRUE;
@@ -3900,12 +3996,18 @@
                 sprintf(rndGLStateLogFileName, "gl%d.state", rndGLStateLogIndex);
             }
             rndGLStateLogIndex++;
-            f = fopen(rndGLStateLogFileName, "wt");         //open the file to clean it out
+
+            fileNameFull = filePathPrepend(
+                rndGLStateLogFileName, FF_UserSettingsPath);
+            if (fileMakeDestinationDirectory(fileNameFull))
+            {
+                f = fopen(fileNameFull, "wt");              //open the file to clean it out
             if (f != NULL)
             {
                 fclose(f);                                  //close the file
             }
         }
+        }
 #endif
         glColor3ub(colRed(RND_StarColor), colGreen(RND_StarColor), colBlue(RND_StarColor));
         shouldSwap = feShouldSaveMouseCursor();
@@ -3926,7 +4028,7 @@
             {
                 rglFeature(RGL_SAVEBUFFER_OFF);
             }
-            if (binkDonePlaying)
+            /*if (binkDonePlaying)*/
             {
                 if (RGL)
                 {
@@ -3963,7 +4065,7 @@
         {
             rndDrawScissorBars(rndScissorEnabled);
         }
-        glDisable(GL_SCISSOR_TEST);                         //in case the scene was rendered with scissoring, turn it off properlu.
+        glDisable(GL_SCISSOR_TEST);                         //in case the scene was rendered with scissoring, turn it off properly.
 
 
         /* need to update audio event layer */
@@ -4074,15 +4176,25 @@
 
             rndTakeScreenshot = FALSE;
             //buf = (ubyte*)malloc(3*MAIN_WindowWidth*MAIN_WindowHeight);
+#ifdef _WIN32
             buf = (void *)VirtualAlloc(NULL, 3*MAIN_WindowWidth*MAIN_WindowHeight, MEM_COMMIT, PAGE_READWRITE);
+#else
+            buf = mmap(NULL, 3*MAIN_WindowWidth*MAIN_WindowHeight,
+                PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANON, -1, 0);
+#endif
             if (buf != NULL)
             {
-                BOOL result;
+                int result;
                 glReadPixels(0, 0, MAIN_WindowWidth, MAIN_WindowHeight, GL_RGB, GL_UNSIGNED_BYTE, buf);
                 ssSaveScreenshot(buf);
                 //free(buf);
+#ifdef _WIN32
                 result = VirtualFree(buf, 0, MEM_RELEASE);
                 dbgAssert(result);
+#else
+                result = munmap(buf, 0);
+                dbgAssert(result != -1);
+#endif
             }
         }
 #endif //SS_SCREENSHOTS
@@ -4482,34 +4594,34 @@
 
 
 #define vcSub(a,b,c) \
-    (a)##->x = (b)##->x - (c)##->x; \
-    (a)##->y = (b)##->y - (c)##->y; \
-    (a)##->z = (b)##->z - (c)##->z
+    (a)->x = (b)->x - (c)->x; \
+    (a)->y = (b)->y - (c)->y; \
+    (a)->z = (b)->z - (c)->z
 
 #define vcCrossProduct(result,a,b) \
-    (result)##->x = ((a)##->y * (b)##->z) - ((a)##->z * (b)##->y); \
-    (result)##->y = ((a)##->z * (b)##->x) - ((a)##->x * (b)##->z); \
-    (result)##->z = ((a)##->x * (b)##->y) - ((a)##->y * (b)##->x)
+    (result)->x = ((a)->y * (b)->z) - ((a)->z * (b)->y); \
+    (result)->y = ((a)->z * (b)->x) - ((a)->x * (b)->z); \
+    (result)->z = ((a)->x * (b)->y) - ((a)->y * (b)->x)
 
 #define vcAddToScalarMultiply(dstvec,vec,k) \
-    (dstvec)##->x += ((vec)##->x * (k));       \
-    (dstvec)##->y += ((vec)##->y * (k));       \
-    (dstvec)##->z += ((vec)##->z * (k))
+    (dstvec)->x += ((vec)->x * (k));       \
+    (dstvec)->y += ((vec)->y * (k));       \
+    (dstvec)->z += ((vec)->z * (k))
 
 #define vcAddToScalarMultiply(dstvec,vec,k) \
-    (dstvec)##->x += ((vec)##->x * (k));       \
-    (dstvec)##->y += ((vec)##->y * (k));       \
-    (dstvec)##->z += ((vec)##->z * (k))
+    (dstvec)->x += ((vec)->x * (k));       \
+    (dstvec)->y += ((vec)->y * (k));       \
+    (dstvec)->z += ((vec)->z * (k))
 
 #define vcScalarMultiply(dstvec,vec,k) \
-    (dstvec)##->x = (vec)##->x * (k);       \
-    (dstvec)##->y = (vec)##->y * (k);       \
-    (dstvec)##->z = (vec)##->z * (k)
+    (dstvec)->x = (vec)->x * (k);       \
+    (dstvec)->y = (vec)->y * (k);       \
+    (dstvec)->z = (vec)->z * (k)
 
 
 
 #define vcDotProduct(a,b) \
-    ( ((a)##->x * (b)##->x) + ((a)##->y * (b)##->y) + ((a)##->z * (b)##->z) )
+    ( ((a)->x * (b)->x) + ((a)->y * (b)->y) + ((a)->z * (b)->z) )
 
 
 /*-----------------------------------------------------------------------------
@@ -4955,14 +5067,7 @@
     primErrorMessagePrint();
     if (!RGL)
     {
-        if (rwglSwapBuffers == NULL || glNT)
-        {
-            SwapBuffers(hGLDeviceContext);
-        }
-        else
-        {
-            rwglSwapBuffers(hGLDeviceContext);
-        }
+        SDL_GL_SwapBuffers();
     }
-    Sleep(1);
+    SDL_Delay(1);
 }
diff -urPw homeworld-orig/src/SDL/render.h homeworld_sdl-0.3/src/SDL/render.h
--- homeworld-orig/src/SDL/render.h	2002-09-04 12:47:04.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/render.h	2004-08-01 22:35:10.000000000 -0700
@@ -9,11 +9,11 @@
 #ifndef ___RENDER_H
 #define ___RENDER_H
 
-#include "types.h"
-#include "camera.h"
-#include "matrix.h"
+#include "Types.h"
+#include "Camera.h"
+#include "Matrix.h"
 #include "color.h"
-#include "spaceobj.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Switches:
Only in homeworld-orig/src/SDL: res.geo
diff -urPw homeworld-orig/src/SDL/resource.h homeworld_sdl-0.3/src/SDL/resource.h
--- homeworld-orig/src/SDL/resource.h	2002-09-04 12:47:04.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/resource.h	2004-08-01 22:35:08.000000000 -0700
@@ -1,5 +1,7 @@
 #ifndef ___RESOURCE_H
 #define ___RESOURCE_H
+/* TC 2003-09-30: Still using this for some of the codes (particularly
+   "CID_*"). */
 
 #define ID_MAINMENU                     101
 #define IDD_ABOUT                       102
diff -urPw homeworld-orig/src/SDL/rglu.c homeworld_sdl-0.3/src/SDL/rglu.c
--- homeworld-orig/src/SDL/rglu.c	2002-09-04 12:47:04.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/rglu.c	2004-08-01 22:35:05.000000000 -0700
@@ -9,8 +9,8 @@
 
 #include <math.h>
 #include "glinc.h"
-#include "shader.h"
-#include "fastmath.h"
+#include "Shader.h"
+#include "FastMath.h"
 
 
 #ifndef M_PI
diff -urPw homeworld-orig/src/SDL/rinit.c homeworld_sdl-0.3/src/SDL/rinit.c
--- homeworld-orig/src/SDL/rinit.c	2002-09-04 12:47:04.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/rinit.c	2004-08-01 22:35:10.000000000 -0700
@@ -1,5 +1,5 @@
 /*=============================================================================
-    Name    : rinit.cpp
+    Name    : rinit.c
     Purpose : rGL / OpenGL enumeration initialization routines
 
     Created 1/5/1999 by khent
@@ -7,15 +7,19 @@
 =============================================================================*/
 
 
-#define WIN32_LEAN_AND_MEAN
+/*#define WIN32_LEAN_AND_MEAN*/
 #define STRICT
 #define D3D_OVERLOADS
 
+#if 0	/* Only needed for Direct3D...hey, we might reenable it one of these days... */
 #include <windows.h>
 #include <windowsx.h>
 #include <ddraw.h>
 #include <dinput.h>
 #include <d3drm.h>
+#endif
+
+#include "SDL.h"
 #include <stdio.h>
 
 #include <stdio.h>
@@ -23,31 +27,32 @@
 #include <string.h>
 #include "rinit.h"
 #include "devstats.h"
+#include "Types.h"
 
 
-extern "C" unsigned int glNT;
-extern "C" unsigned int gl95;
-extern "C" unsigned int mainSoftwareDirectDraw;
-extern "C" unsigned int mainOutputCRC;
-extern "C" unsigned long strCurLanguage;
+extern unsigned int glNT;
+extern unsigned int gl95;
+extern unsigned int mainSoftwareDirectDraw;
+extern unsigned int mainOutputCRC;
+extern unsigned long strCurLanguage;
 
 #define RIN_MODESINDEVSTATLIST 10
 unsigned int rinDevstatModeTable[RIN_MODESINDEVSTATLIST][3] =
 {
-    16,  640, DEVSTAT_NO_64048016,
-    16,  800, DEVSTAT_NO_80060016,
-    16, 1024, DEVSTAT_NO_102476816,
-    16, 1280, DEVSTAT_NO_1280102416,
-    16, 1600, DEVSTAT_NO_1600120016,
-    32,  640, DEVSTAT_NO_64048032,
-    32,  800, DEVSTAT_NO_80060032,
-    32, 1024, DEVSTAT_NO_102476832,
-    32, 1280, DEVSTAT_NO_1280102432,
-    32, 1600, DEVSTAT_NO_1600120032,
+    { 16,  640, DEVSTAT_NO_64048016 },
+    { 16,  800, DEVSTAT_NO_80060016 },
+    { 16, 1024, DEVSTAT_NO_102476816 },
+    { 16, 1280, DEVSTAT_NO_1280102416 },
+    { 16, 1600, DEVSTAT_NO_1600120016 },
+    { 32,  640, DEVSTAT_NO_64048032 },
+    { 32,  800, DEVSTAT_NO_80060032 },
+    { 32, 1024, DEVSTAT_NO_102476832 },
+    { 32, 1280, DEVSTAT_NO_1280102432 },
+    { 32, 1600, DEVSTAT_NO_1600120032 },
 };
 
-extern "C" unsigned int* devTable;
-extern "C" int devTableLength;
+extern unsigned int* devTable;
+extern int devTableLength;
 
 //3dfx fullscreen-only present boolean
 static bool bFullscreenDevice;
@@ -55,23 +60,25 @@
 static rdevice* rDeviceList;
 static int nDevices;
 
-extern "C" unsigned int gDevcaps  = 0xFFFFFFFF;
-extern "C" unsigned int gDevcaps2 = 0x00000000;
+unsigned int gDevcaps  = 0xFFFFFFFF;
+unsigned int gDevcaps2 = 0x00000000;
 
+#if 0	/* Direct3D stuff...not used. */
 char* gDescription = NULL;
 char* gDriverName = NULL;
 
 typedef HRESULT(WINAPI * DIRECTDRAWCREATE)(GUID*, LPDIRECTDRAW*, IUnknown*);
 typedef HRESULT(WINAPI * DIRECTINPUTCREATE)(HINSTANCE, DWORD, LPDIRECTINPUT*, IUnknown*);
+#endif
 
 #define SST_VOODOO  0
 #define SST_VOODOO2 1
 #define SST_OTHER   2
 
-extern "C" unsigned int sstHardwareExists(int*);
-extern "C" unsigned int glCapNT(void);
+extern unsigned int sstHardwareExists(int*);
+extern unsigned int glCapNT(void);
 
-void* memAlloc(int size)
+static void* rinMemAlloc(int size)
 {
     unsigned char* block;
 
@@ -81,12 +88,12 @@
     return (void*)block;
 }
 
-void memFree(void* memblock)
+static void rinMemFree(void* memblock)
 {
     free(memblock);
 }
 
-extern "C" unsigned int crc32Compute(void*, unsigned int);
+extern unsigned int crc32Compute(void*, unsigned int);
 
 /*-----------------------------------------------------------------------------
     Name        : rinDeviceCRC
@@ -109,7 +116,7 @@
         return 0;
     }
 
-    devlist = (rdevice*)memAlloc(nDevices * sizeof(rdevice));
+    devlist = (rdevice*)rinMemAlloc(nDevices * sizeof(rdevice));
     pdevlist = devlist;
 
     cdev = rDeviceList;
@@ -124,7 +131,7 @@
 
     crc = crc32Compute((void*)devlist, nDevices * sizeof(rdevice));
 
-    memFree(devlist);
+    rinMemFree(devlist);
 
     return crc;
 }
@@ -143,7 +150,7 @@
     rmode* mode;
     rmode* cmode;
 
-    mode = (rmode*)memAlloc(sizeof(rmode));
+    mode = (rmode*)rinMemAlloc(sizeof(rmode));
     mode->width  = width;
     mode->height = height;
     mode->depth  = depth;
@@ -182,7 +189,7 @@
     //accept 16 & 32 bit mode only
     if (depth != 16 && depth != 32)
     {
-        return false;
+        return FALSE;
     }
 
     //possibly eliminate 32bit modes, if devstats tells us to
@@ -192,7 +199,7 @@
         {
             if (dev->devcaps & DEVSTAT_NO_32BIT)
             {
-                return false;
+                return FALSE;
             }
         }
         else if (dev->type == RIN_TYPE_OPENGL)
@@ -200,7 +207,7 @@
             if ((dev->devcaps & DEVSTAT_NO_32BIT_GL) ||
                 (dev->devcaps & DEVSTAT_NO_32BIT))
             {
-                return false;
+                return FALSE;
             }
         }
     }
@@ -209,22 +216,22 @@
     switch (width)
     {
     case 640:
-        if (height !=  480) return false;
+        if (height !=  480) return FALSE;
         break;
     case 800:
-        if (height !=  600) return false;
+        if (height !=  600) return FALSE;
         break;
     case 1024:
-        if (height !=  768) return false;
+        if (height !=  768) return FALSE;
         break;
     case 1280:
-        if (height != 1024) return false;
+        if (height != 1024) return FALSE;
         break;
     case 1600:
-        if (height != 1200) return false;
+        if (height != 1200) return FALSE;
         break;
     default:
-        return false;
+        return FALSE;
     }
 
     //check for specifically disabled display modes
@@ -235,12 +242,12 @@
         {
             if (dev->devcaps & rinDevstatModeTable[index][2])
             {
-                return false;
+                return FALSE;
             }
         }
     }
 
-    return true;
+    return TRUE;
 }
 
 /*-----------------------------------------------------------------------------
@@ -288,7 +295,7 @@
     {
         freeMode = cmode;    //save to free
         cmode = cmode->next; //next
-        memFree(freeMode);   //free
+        rinMemFree(freeMode);   //free
     }
 
     //attach new modes
@@ -416,12 +423,12 @@
         {
             freeMode = mode;    //save to free
             mode = mode->next;  //next
-            memFree(freeMode);  //free
+            rinMemFree(freeMode);  //free
         }
 
         freeDev = dev;          //save to free
         dev = dev->next;        //next
-        memFree(freeDev);       //free
+        rinMemFree(freeDev);       //free
     }
 
     rDeviceList = NULL;
@@ -430,6 +437,7 @@
     return 1;
 }
 
+#if 0	/* Direct3D-specific enumeration. */
 /*-----------------------------------------------------------------------------
     Name        : rinEnumDisplayModes_cb
     Description : callback during display mode enumeration
@@ -470,51 +478,6 @@
     return D3DENUMRET_OK;
 }
 
-/*-----------------------------------------------------------------------------
-    Name        : rinEnumPrimaryDisplayModes_cb
-    Description : callback during display mode enumeration, old DDraw
-    Inputs      : ...
-    Outputs     :
-    Return      :
-----------------------------------------------------------------------------*/
-static HRESULT WINAPI rinEnumPrimaryDisplayModes_cb(LPDDSURFACEDESC ddsd, LPVOID lpContext)
-{
-    rdevice* dev;
-
-    dev = (rdevice*)lpContext;
-
-    if (dev == NULL)
-    {
-        goto SKIP_MODE;
-    }
-
-    if ((ddsd->dwFlags & DDSD_WIDTH) &&
-        (ddsd->dwFlags & DDSD_HEIGHT) &&
-        (ddsd->dwFlags & DDSD_PIXELFORMAT))
-    {
-        if (ddsd->ddpfPixelFormat.dwRGBBitCount != 16 &&
-            ddsd->ddpfPixelFormat.dwRGBBitCount != 32)
-        {
-            goto SKIP_MODE;
-        }
-        if (ddsd->dwWidth < 640 || ddsd->dwHeight < 480)
-        {
-            goto SKIP_MODE;
-        }
-        if (ddsd->dwWidth > 1600)
-        {
-            goto SKIP_MODE;
-        }
-
-        rinAddMode(dev,
-                   ddsd->dwWidth, ddsd->dwHeight,
-                   ddsd->ddpfPixelFormat.dwRGBBitCount);
-    }
-
-  SKIP_MODE:
-    return D3DENUMRET_OK;
-}
-
 static FILE* crcLog;
 
 static void rinResetCRCLog(void)
@@ -627,68 +590,6 @@
     return D3DENUMRET_OK;
 }
 
-/*-----------------------------------------------------------------------------
-    Name        : rinEnumPrimary_cb
-    Description : callback during DirectDraw <= 3 device enumeration
-    Inputs      : ...
-    Outputs     :
-    Return      :
-----------------------------------------------------------------------------*/
-static BOOL WINAPI rinEnumPrimary_cb(
-    GUID FAR* lpGUID, LPSTR lpDriverDescription, LPSTR lpDriverName, LPVOID lpContext)
-{
-    LPDIRECTDRAW ddraw;
-
-    //only want primary
-    if (lpGUID != NULL)
-    {
-        return D3DENUMRET_OK;
-    }
-
-    if (FAILED(DirectDrawCreate(lpGUID, &ddraw, NULL)))
-    {
-        return D3DENUMRET_OK;
-    }
-
-    ddraw->EnumDisplayModes(0, NULL, lpContext, rinEnumPrimaryDisplayModes_cb);
-
-    return D3DENUMRET_OK;
-}
-
-static BOOL WINAPI rinEnum3Dfx_cb(
-    GUID FAR* lpGUID, LPSTR lpDriverDescription, LPSTR lpDriverName, LPVOID lpContext)
-{
-    LPDIRECTDRAW ddraw;
-
-    if (lpGUID == NULL)
-    {
-        //not interested in primary devices
-        return D3DENUMRET_OK;
-    }
-
-    if (FAILED(DirectDrawCreate(lpGUID, &ddraw, NULL)))
-    {
-        //broken DirectDraw
-        return D3DENUMRET_OK;
-    }
-
-    //enumerate display modes on this secondary device
-    ddraw->EnumDisplayModes(0, NULL, lpContext, rinEnumPrimaryDisplayModes_cb);
-
-    rdevice* dev = (rdevice*)lpContext;
-    if (dev != NULL)
-    {
-        //setup 3dfx OpenGL device info
-        dev->type = RIN_TYPE_OPENGL;
-        strncpy(dev->data, lpDriverName, 63);
-        strncpy(dev->name, lpDriverDescription, 63);
-        dev->data[63] = '\0';
-        dev->name[63] = '\0';
-    }
-
-    return D3DENUMRET_CANCEL;
-}
-
 void rinRemoveDriverFromName(char* name)
 {
     int   pos;
@@ -927,48 +828,7 @@
     }
     return numD3Ddevs;
 }
-
-/*-----------------------------------------------------------------------------
-    Name        : rinEnumeratePrimary
-    Description : enumerate available display modes on the primary display
-    Inputs      : dev - the device whose modes are to be filled
-    Outputs     :
-    Return      : true or false (could or couldn't enumerate)
-----------------------------------------------------------------------------*/
-bool rinEnumeratePrimary(rdevice* dev)
-{
-    HRESULT hr = DirectDrawEnumerate(rinEnumPrimary_cb, dev);
-    if (FAILED(hr))
-    {
-        return false;
-    }
-    if (dev == NULL)
-    {
-        return false;
-    }
-    return (dev->modes == NULL) ? false : true;
-}
-
-/*-----------------------------------------------------------------------------
-    Name        : rinEnumerate3Dfx
-    Description : enumerate available display modes on possible 3Dfx display
-    Inputs      : dev - the device whose modes are to be filled
-    Outputs     :
-    Return      : true or false (could or couldn't enumerate)
-----------------------------------------------------------------------------*/
-bool rinEnumerate3Dfx(rdevice* dev)
-{
-    HRESULT hr = DirectDrawEnumerate(rinEnum3Dfx_cb, dev);
-    if (FAILED(hr))
-    {
-        return false;
-    }
-    if (dev == NULL)
-    {
-        return false;
-    }
-    return (dev->modes == NULL) ? false : true;
-}
+#endif	/* Direct3D-specific enumeration. */
 
 /*-----------------------------------------------------------------------------
     Name        : rinMaxWidth
@@ -1008,6 +868,121 @@
 }
 
 /*-----------------------------------------------------------------------------
+    Name        : rinEnumeratePrimary
+    Description : enumerate available display modes on the primary display
+    Inputs      : dev - the device whose modes are to be filled
+    Outputs     :
+    Return      : true or false (could or couldn't enumerate)
+----------------------------------------------------------------------------*/
+bool rinEnumeratePrimary(rdevice* dev)
+{
+	SDL_PixelFormat fmt;
+	SDL_Rect** modes;
+    Uint32 flags;
+	int max_width;
+	int i;
+
+	if (!dev)
+		return FALSE;
+
+	max_width = rinMaxWidth();
+
+	/* Make sure SDL video is initialized. */
+	flags = SDL_WasInit(SDL_INIT_EVERYTHING);
+	if (!flags)
+	{
+		if (SDL_Init(SDL_INIT_VIDEO) == -1)
+			return FALSE;
+	}
+	else if (!(flags & SDL_INIT_VIDEO))
+	{
+		if (SDL_InitSubSystem(SDL_INIT_VIDEO) == -1)
+			return FALSE;
+	}
+
+	/* Enumerate 16-bit modes. */
+	fmt.BitsPerPixel = 16;
+	modes = SDL_ListModes(&fmt, SDL_FULLSCREEN | SDL_HWSURFACE);
+	if (modes)
+	{
+		if (modes == (SDL_Rect**)-1)
+		{
+			/* Add basic modes (shouldn't really happen). */
+			rinAddMode(dev,  640, 480, 16);
+			rinAddMode(dev,  800, 600, 16);
+			rinAddMode(dev, 1024, 768, 16);
+			if (max_width >= 1280)
+				rinAddMode(dev, 1280, 1024, 16);
+			if (max_width >= 1600)
+				rinAddMode(dev, 1600, 1200, 16);
+		}
+		else
+		{
+			for (i = 0; modes[i]; i++)
+			{
+				if (modes[i]->w < 640 || modes[i]->h < 480 ||
+					modes[i]->w > 1600)
+					continue;
+				rinAddMode(dev, modes[i]->w, modes[i]->h, 16);
+			}
+		}
+	}
+
+	/* Enumerate 32-bit modes. */
+	fmt.BitsPerPixel = 32;
+	modes = SDL_ListModes(&fmt, SDL_FULLSCREEN | SDL_HWSURFACE);
+	if (modes)
+	{
+		if (modes == (SDL_Rect**)-1)
+		{
+			/* Add basic modes (shouldn't really happen). */
+			rinAddMode(dev,  640, 480, 32);
+			rinAddMode(dev,  800, 600, 32);
+			rinAddMode(dev, 1024, 768, 32);
+			if (max_width >= 1280)
+				rinAddMode(dev, 1280, 1024, 32);
+			if (max_width >= 1600)
+				rinAddMode(dev, 1600, 1200, 32);
+		}
+		else
+		{
+			for (i = 0; modes[i]; i++)
+			{
+				if (modes[i]->w < 640 || modes[i]->h < 480 ||
+					modes[i]->w > 1600)
+					continue;
+				rinAddMode(dev, modes[i]->w, modes[i]->h, 32);
+			}
+		}
+	}
+
+	return (dev->modes != 0);
+}
+
+/*-----------------------------------------------------------------------------
+    Name        : rinEnumerate3Dfx
+    Description : enumerate available display modes on possible 3Dfx display
+    Inputs      : dev - the device whose modes are to be filled
+    Outputs     :
+    Return      : true or false (could or couldn't enumerate)
+----------------------------------------------------------------------------*/
+bool rinEnumerate3Dfx(rdevice* dev)
+{
+	bool res;
+
+	if (!dev)
+		return FALSE;
+
+	/* Use primary display enumeration. */
+	res = rinEnumeratePrimary(dev);
+
+	/* Set 3dfx OpenGL device info. */
+	dev->type = RIN_TYPE_OPENGL;
+
+	return res;
+}
+
+/*-----------------------------------------------------------------------------
     Name        : rinEnumerateDevices
     Description : populate the device list by enumerating available renderers
     Inputs      :
@@ -1020,25 +995,30 @@
     rdevice* gldev;
     rdevice  primaryDev;
     bool primaryVal;
+    
+#ifndef _MACOSX_FIX_ME
     int voodoo, maxWidth;
+#endif
 
+#if 0	/* CRC log only used by Direct3D. */
     if (mainOutputCRC)
     {
         rinResetCRCLog();
     }
+#endif
 
     rDeviceList = NULL;
     nDevices = 0;
     gDevcaps  = 0xFFFFFFFF;
     gDevcaps2 = 0x00000000;
 
-    bFullscreenDevice = false;
+    bFullscreenDevice = FALSE;
 
     //add Direct3D devices
-    nDevices += rinEnumerateDirect3D();
+    /*nDevices += rinEnumerateDirect3D();*/
 
     //add OpenGL device
-    dev = (rdevice*)memAlloc(sizeof(rdevice));
+    dev = (rdevice*)rinMemAlloc(sizeof(rdevice));
     if (nDevices == 1)
     {
         dev->devcaps  = rDeviceList->devcaps;
@@ -1061,7 +1041,7 @@
     }
     if (dev->devcaps & DEVSTAT_NO_DDRAWSW)
     {
-        mainSoftwareDirectDraw = FALSE;
+        mainSoftwareDirectDraw = 0;
     }
     dev->type = RIN_TYPE_OPENGL;
     dev->data[0] = '\0';
@@ -1104,13 +1084,14 @@
     gldev = dev;
     nDevices++;
 
+#ifndef _MACOSX_FIX_ME
     //add possible 3dfx OpenGL device
     voodoo = SST_VOODOO2; //sane default if sstHardwareExists doesn't get called
     if (!(gDevcaps & DEVSTAT_NO_3DFXGL) &&
         (bFullscreenDevice || sstHardwareExists(&voodoo)))
     {
         rdevice* odev = dev;
-        dev = (rdevice*)memAlloc(sizeof(rdevice));
+        dev = (rdevice*)rinMemAlloc(sizeof(rdevice));
         dev->devcaps = 0;
         dev->type = RIN_TYPE_OPENGL;
         dev->data[0] = '\0';
@@ -1137,6 +1118,7 @@
         rinSortModes(dev);
         nDevices++;
     }
+#endif // _MACOSX_FIX_ME
 
     if (!(gDevcaps & DEVSTAT_NOGL_9X))
     {
@@ -1153,8 +1135,9 @@
         }
     }
 
+#ifndef _MACOSX_FIX_ME
     //add software renderer, an explicitly known device
-    dev = (rdevice*)memAlloc(sizeof(rdevice));
+    dev = (rdevice*)rinMemAlloc(sizeof(rdevice));
     dev->devcaps = 0;
     dev->type = RIN_TYPE_SOFTWARE;
     dev->data[0] = '\0';
@@ -1168,6 +1151,10 @@
             rinSortModes(&primaryDev);
         }
         rinCopyModesSelectively(dev, &primaryDev, 16, 1600);
+        if (!dev->modes)
+            rinCopyModesSelectively(dev, &primaryDev, 24, 1600);
+        if (!dev->modes)
+            rinCopyModesSelectively(dev, &primaryDev, 32, 1600);
     }
     else
     {
@@ -1187,11 +1174,14 @@
     rinSortModes(dev);
     rinAddDevice(dev);
     nDevices++;
+#endif // _MACOSX
 
+#if 0	/* CRC log only used by Direct3D. */
     if (mainOutputCRC)
     {
         rinCloseCRCLog();
     }
+#endif
 
     //success
     return 1;
diff -urPw homeworld-orig/src/SDL/screenshot.c homeworld_sdl-0.3/src/SDL/screenshot.c
--- homeworld-orig/src/SDL/screenshot.c	2002-09-04 12:47:04.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/screenshot.c	2004-08-01 22:35:05.000000000 -0700
@@ -9,7 +9,7 @@
 #include <stdlib.h>
 #include <string.h>
 #include "main.h"
-#include "debug.h"
+#include "Debug.h"
 #include "screenshot.h"
 #include "interfce.h"
 
@@ -17,7 +17,7 @@
 {
     int   i;
     FILE* outfile;
-    char  filename[32], testname[128];
+    char  filename[32], testname[PATH_MAX + 1];
 
     filename[0] = '\0';
 
@@ -41,24 +41,16 @@
 
 void ssSaveScreenshot(ubyte* buf)
 {
-    char* dir;
-    char fname[128];
+    char *fname;
     FILE* out;
     unsigned char *pTempLine;
     long Top, Bot, i, Size;
 
     JPEGDATA jp;
 
-    dir = getenv("HW_Data");
-    if (dir == NULL)
-    {
-        strcpy(fname, "screenshots\\");
-    }
-    else
-    {
-        strcpy(fname, dir);
-        strcat(fname, "\\screenshots\\");
-    }
+    fname = filePathPrepend("ScreenShots/", FF_UserSettingsPath);
+    if (!fileMakeDirectory(fname))
+        return;
 
     _numberify(fname);
 
diff -urPw homeworld-orig/src/SDL/screenshot.h homeworld_sdl-0.3/src/SDL/screenshot.h
--- homeworld-orig/src/SDL/screenshot.h	2002-09-04 12:47:04.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/screenshot.h	2004-08-01 22:35:06.000000000 -0700
@@ -21,7 +21,7 @@
 #define SS_VERBOSE_LEVEL       0               //don't print any verbose strings in retail
 
 #endif //HW_Debug
-#include "types.h"
+#include "Types.h"
 
 void ssSaveScreenshot(ubyte* buf);
 
diff -urPw homeworld-orig/src/SDL/smixer.c homeworld_sdl-0.3/src/SDL/smixer.c
--- homeworld-orig/src/SDL/smixer.c	2002-09-04 12:47:04.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/smixer.c	2004-08-01 22:35:08.000000000 -0700
@@ -4,21 +4,21 @@
 
     Created 01/10/1998 by salfreds
     Copyright Relic Entertainment, Inc.  All rights reserved.
+
+    Butchered for your enjoyment...
 =============================================================================*/
 
-#include <windows.h>
 #include <stdio.h>
-#include <process.h>
-#include <dsound.h>
+#include <string.h>
 #include "fquant.h"
 #include "soundcmn.h"
 #include "soundlow.h"
-#include "debug.h"
-#include "soundstructs.h"
-#include "randy.h"
-#include "fastmath.h"
+#include "Debug.h"
+#include "SoundStructs.h"
+#include "Randy.h"
+#include "FastMath.h"
 #include "main.h"
-#include "globals.h"
+#include "Globals.h"
 
 #define MIX_BLOCK_SIZE			FQ_SIZE * sizeof(short) * 2 // 256 samples, 16-bit, stereo = 1024 bytes
 
@@ -36,25 +36,21 @@
 #define MIX_PANIC_DUR			16L	// approx 4 seconds - dur*fps
 
 /* function prototypes */
-void isoundmixerthreadWAVEOUT(void *dummy);
-void isoundmixerthreadDSOUND(void *dummy);
-void isoundmixerqueueWAVEOUT();
+void isoundmixerthreadSDL(void *dummy);
+void isoundmixerqueueSDL();
 sdword isoundmixerprocess(void *pBuf1, udword nSize1, void *pBuf2, udword nSize2);
 sdword isoundmixerdecodeEffect(sbyte *readptr, real32 *writeptr1, real32 *writeptr2, ubyte *exponent, sdword size, uword bitrate, EFFECT *effect);
 #define isoundmixerdecode(a, b, c, d, e, f)		isoundmixerdecodeEffect(a, b, c, d, e, f, NULL);
 
 /* variables */
-byte waveoutbuffer[WO_MIX_BUFFER_SIZE];
-WAVEHDR wh;
-HWAVEOUT hwo;
-MMRESULT mmresult;
-MMTIME mmtime;
-WAVEFORMATEX woFormat;
+struct fake_wavehdr {
+    char *lpData;
+    udword dwBufferLength;
+    udword dwFlags;
+} WaveHead[WO_NUM_BUFFER_BLOCKS];
 
-LPSTR pWaveBuf[WO_NUM_BUFFER_BLOCKS];
-WAVEHDR WaveHead[WO_NUM_BUFFER_BLOCKS];	// pointers to wave header information
+ubyte waveoutbuffer[WO_MIX_BUFFER_SIZE];
 
-sdword nBufRIndex = 0;
 sdword nBufWIndex = 0;
 
 udword mixerticks = 0;
@@ -65,21 +61,19 @@
 sdword numvoices = 0;
 
 udword buffersize;
-DWORD dwBlockSize;
-DWORD dwWritePos;
-DWORD dwMixAhead;
+udword dwBlockSize;
+udword dwWritePos;
+udword dwMixAhead;
 
 sdword dctmode = FQ_MNORM;	// DCT mode
 sdword dctsize = FQ_HSIZE;	// DCT block size
 
 sdword dctpanicmode = SOUND_MODE_NORM;	// DCT panic mode, normal by default
 
-LPDIRECTSOUNDBUFFER lpMixBuffer = NULL;
-
 real32 timebufferL[FQ_DSIZE], timebufferR[FQ_DSIZE], temptimeL[FQ_DSIZE], temptimeR[FQ_DSIZE];
 real32 mixbuffer1L[FQ_SIZE], mixbuffer1R[FQ_SIZE], mixbuffer2L[FQ_SIZE], mixbuffer2R[FQ_SIZE];
 
-extern LPDIRECTSOUND lpDirectSound;
+//extern LPDIRECTSOUND lpDirectSound;
 extern CHANNEL channels[];
 extern bool soundinited;
 extern STREAM streams[];
@@ -126,6 +120,8 @@
 
 void soundMixerSetMode(sdword mode)		// mode SOUND_MODE_NORM or SOUND_MODE_AUTO or SOUND_MODE_LOW
 {
+#ifndef _MACOSX_FIX_ME
+
 	if(mode == SOUND_MODE_LOW)
 	{
 		// set DCT mode
@@ -167,6 +163,8 @@
 	// set panic mode
 	dctpanicmode=SOUND_MODE_NORM;
 
+#endif // _MACOSX_FIX_ME
+
 	return;
 }
 
@@ -179,92 +177,25 @@
 }
 
 
-sdword smixCreateDSoundBuffer(WAVEFORMATEX *pcmwf)
-{
-	DSBUFFERDESC    dsbd;
-	
-	// Set up the direct sound buffer.
-	memset(&dsbd, 0, sizeof(DSBUFFERDESC));
-	dsbd.dwSize			= sizeof(DSBUFFERDESC);
-	dsbd.dwFlags		= DSBCAPS_STATIC | DSBCAPS_CTRLDEFAULT;
-	dsbd.lpwfxFormat	= pcmwf;
-	dsbd.dwBufferBytes	= DS_MIX_BUFFER_SIZE;
-
-	if ((lpDirectSound->lpVtbl->CreateSoundBuffer(lpDirectSound, &dsbd,
-		&lpMixBuffer, NULL )) != DS_OK)
-	{
-		lpMixBuffer = NULL;
-		return (SOUND_ERR);
-	}
-
-	return (SOUND_OK);
-}
-
-
-sdword smixInitMixBuffer(WAVEFORMATEX *pcmwf)
-{
-	HRESULT hr;
-	LPVOID lpvPtr1, lpvPtr2;
-	DWORD dwLength1, dwLength2;
-	sdword i;
-	
-	if (bDirectSoundCertified)
+sdword smixInitMixBuffer(SDL_AudioSpec *aspec)
 	{
-		buffersize = DS_MIX_BUFFER_SIZE;
-		dwBlockSize = buffersize / DS_NUM_BUFFER_BLOCKS;
-		dwMixAhead = DS_MIX_BUFFER_AHEAD;
-		
-		// write 0's to mixer buffer
-		// lock primary buffer
-		hr = lpMixBuffer->lpVtbl->Lock(lpMixBuffer, 0, buffersize,
-					&lpvPtr1, &dwLength1, &lpvPtr2, &dwLength2, 0L);
-		
-		memset((byte *)lpvPtr1, 0, buffersize);
-		
-		hr = lpMixBuffer->lpVtbl->Unlock(lpMixBuffer, lpvPtr1, dwLength1, lpvPtr2, dwLength2);
-	
-		// start playing some silence
-		hr = lpMixBuffer->lpVtbl->SetCurrentPosition(lpMixBuffer, 0);
-		hr = lpMixBuffer->lpVtbl->Play(lpMixBuffer, 0, 0, DSBPLAY_LOOPING);
-	
-		return (SOUND_OK);
-	}
+        unsigned i;
 
-	// else this is the waveout thread stuff
 	buffersize = WO_MIX_BUFFER_SIZE;
 	dwBlockSize = buffersize / WO_NUM_BUFFER_BLOCKS;
 	dwMixAhead = WO_MIX_BUFFER_AHEAD;
 	
-	memcpy(&woFormat, pcmwf, sizeof(WAVEFORMATEX));
-	
-	mmresult = waveOutOpen(&hwo, WAVE_MAPPER, (LPWAVEFORMATEX)&woFormat, 0, 0, CALLBACK_NULL | WAVE_ALLOWSYNC);
-	if (mmresult != MMSYSERR_NOERROR)
-	{
-		// couldn't initialize the wave device
-		return (SOUND_ERR);
-	}
-	
 	for (i = 0; i < WO_NUM_BUFFER_BLOCKS; i++)
 	{
-		pWaveBuf[i] = (LPSTR)(waveoutbuffer + (dwBlockSize * i));
-		WaveHead[i].lpData = pWaveBuf[i];
+		WaveHead[i].lpData =
+		    (unsigned char *)(waveoutbuffer + (dwBlockSize * i));
 		WaveHead[i].dwBufferLength = dwBlockSize;
 		WaveHead[i].dwFlags = 0;
 	
-		mmresult = waveOutPrepareHeader(hwo, (LPWAVEHDR)&WaveHead[i], sizeof(WAVEHDR));
-		if (mmresult != MMSYSERR_NOERROR)
-		{
-			// couldn't initialize the wave device
-			// close the device...
-			isoundmixerrestore();
-			return (SOUND_ERR);
-		}
 	}
-	
 	return (SOUND_OK);
 }
 
-
 /*-----------------------------------------------------------------------------
 	Name		:
 	Description	:
@@ -272,8 +203,9 @@
 	Outputs		:
 	Return		:
 ----------------------------------------------------------------------------*/	
-sdword isoundmixerinit(WAVEFORMATEX *pcmwf)
+sdword isoundmixerinit(SDL_AudioSpec *aspec)
 {
+#ifndef _MACOSX_FIX_ME
 	
 	// Initialize codec
 	fqInitDequant();
@@ -287,6 +219,7 @@
 	// Set block size for effects
 	fqSize(dctsize);
 
+#if 0
 	if (bDirectSoundCertified)
 	{
 		// Create the Direct Sound buffer
@@ -295,6 +228,7 @@
 			return (SOUND_ERR);
 		}
 	}
+#endif
 			
 	// init the iDCT function
 	if (SOUND_OK != fqDecBlock(mixbuffer1L, mixbuffer2L, timebufferL, temptimeL, FQ_MINIT, FQ_MINIT))
@@ -307,20 +241,15 @@
 		return (SOUND_ERR);
 	}
 	
-	// start the thread
-	if (smixInitMixBuffer(pcmwf) != SOUND_OK)
+	if (smixInitMixBuffer(aspec) != SOUND_OK)
 	{
 		return (SOUND_ERR);
 	}
 
-	if (bDirectSoundCertified)
-	{
-		_beginthread(isoundmixerthreadDSOUND, 0, NULL);
-	}
-	else
-	{
-		_beginthread(isoundmixerthreadWAVEOUT, 0, NULL);
-	}
+	// start the thread
+	SDL_CreateThread(isoundmixerthreadSDL, NULL);
+
+#endif // _MACOSX_FIX_ME
 
 	return (SOUND_OK);
 }
@@ -335,27 +264,7 @@
 ----------------------------------------------------------------------------*/	
 void isoundmixerrestore(void)
 {
-	HRESULT hr;
-	sdword i;
-
-	if (bDirectSoundCertified)
-	{
 		mixer.timeout = 0;
-		hr = lpMixBuffer->lpVtbl->Stop(lpMixBuffer);
-//		mixer.status = SOUND_FREE;
-		lpMixBuffer->lpVtbl->Release(lpMixBuffer);
-	}
-	else
-	{				
-		mixer.timeout = 0;
-		mmresult = waveOutReset(hwo);
-//		mixer.status = SOUND_FREE;
-		for (i = 0; i < WO_NUM_BUFFER_BLOCKS; i++)
-		{
-			mmresult = waveOutUnprepareHeader(hwo, &WaveHead[i], sizeof(WAVEHDR));
-		}
-		mmresult = waveOutClose(hwo);
-	}
 }
 
 
@@ -368,6 +277,8 @@
 ----------------------------------------------------------------------------*/	
 sdword isoundmixerprocess(void *pBuf1, udword nSize1, void *pBuf2, udword nSize2)
 {
+#ifndef _MACOSX_FIX_ME
+
 	sdword i, amountread;
 	CHANNEL	*pchan;
 	STREAM *pstream;
@@ -698,7 +609,7 @@
 				}
 	
 				if ((pchan->currentpos == (sbyte *)(pstream->buffer + (pstream->blocksize * (pstream->readblock + 1)))) ||
-					(pchan->currentpos == pstream->writepos))
+					(pchan->currentpos == (sbyte *)pstream->writepos))
 				{
 					pstream->blockstatus[pstream->readblock++] = 0;
 					if (pstream->readblock >= 2)
@@ -911,6 +822,8 @@
 
 	mixerticks++;
 
+#endif // _MAOSX_FIX_ME
+
 	return (SOUND_OK);
 }
 
@@ -924,6 +837,8 @@
 ----------------------------------------------------------------------------*/	
 sdword isoundmixerdecodeEffect(sbyte *readptr, real32 *writeptr1, real32 *writeptr2, ubyte *exponent, sdword size, uword bitrate, EFFECT *effect)
 {
+#ifndef _MACOSX_FIX_ME
+
     sbyte tempblock[FQ_LEN];
 
 	memset(tempblock, 0, FQ_LEN);
@@ -941,6 +856,7 @@
 					FQ_LEN, bitrate, size);
 
 	return (bitrate >> 3);
+#endif 
 }
 
 /*-----------------------------------------------------------------------------
@@ -950,185 +866,10 @@
 	Outputs		:
 	Return		:
 ----------------------------------------------------------------------------*/	
-void isoundmixerthreadDSOUND(void *dummy)
-{
-	unsigned long i,dataleft;
-	short *lpvWritePtr;
-	LPVOID lpvPtr1, lpvPtr2;
-	DWORD dwLength1, dwLength2;
-	HRESULT hr;
-	DWORD			dwCurrentPlayCursor;
-	DWORD			dwCurrentWriteCursor;
-	DWORD	dwReadAhead;
-	DWORD	dwPlayAhead;
-	bool	missed = FALSE;
-	bool	mix = FALSE;
-	bool	test = FALSE;
-
-	mixer.status = SOUND_PLAYING;	
-
-	while (soundinited && (mixer.status >= SOUND_STOPPED))
-	{
-		if (mixer.status >= SOUND_PLAYING)
-		{
-			/* write block to DSound buffer */					
-			hr = lpMixBuffer->lpVtbl->GetCurrentPosition(lpMixBuffer, &dwCurrentPlayCursor, &dwCurrentWriteCursor);
-			
-			dwReadAhead = dwCurrentPlayCursor + dwMixAhead;
-			if (dwReadAhead >= buffersize)
-			{
-				dwReadAhead -= buffersize;
-			}
-		
-			dwPlayAhead = dwWritePos + (buffersize - dwMixAhead);
-			if (dwPlayAhead >= buffersize)
-			{
-				dwPlayAhead -= buffersize;
-			}
-	
-			if ((dwReadAhead >= dwWritePos) && (dwCurrentPlayCursor >= dwPlayAhead))
-			{
-				mix = TRUE;
-			}
-			else if ((dwReadAhead >= dwWritePos) && (dwCurrentPlayCursor + buffersize >= dwPlayAhead)
-					 && (dwWritePos > dwCurrentPlayCursor))
-			{
-				mix = TRUE;
-			}
-			else if ((dwCurrentPlayCursor >= dwPlayAhead) && (dwReadAhead + buffersize >= dwWritePos)
-					 && (dwWritePos > dwCurrentPlayCursor))
-			{
-				mix = TRUE;
-			}
-			else
-			{
-				mix = FALSE;
-			}
-	
-			if (mix)
-			{
-				/* lock primary buffer */
-				hr = lpMixBuffer->lpVtbl->Lock(lpMixBuffer, dwWritePos, dwBlockSize,
-						  &lpvPtr1, &dwLength1, &lpvPtr2, &dwLength2, 0L);
-		
-				/* successful */
-				if (hr == DS_OK)
-				{
-					lpvWritePtr = (short *)lpvPtr1;
-					dataleft = (unsigned long)dwLength1;
-			
-					for (i = 0; i < dwBlockSize; i += MIX_BLOCK_SIZE)
-					{
-						dataleft -= MIX_BLOCK_SIZE;
-		
-						if (dataleft > 0)
-						{
-							// process 256 samples, 16-bit (independent of # of channels)
-							isoundmixerprocess(lpvWritePtr, FQ_SIZE * sizeof(short), NULL, 0);
-							lpvWritePtr += FQ_SIZE * sizeof(short);
-						}
-						else
-						if (dataleft < 0)
-						{
-							// process 256 samples, 16-bit (independent of # of channels)
-							isoundmixerprocess(lpvWritePtr, (dataleft/2 + (FQ_SIZE * sizeof(short))),lpvPtr2, (0 - dataleft/2));
-							lpvWritePtr = (short *)lpvPtr2 + dataleft/2;
-							dataleft = (unsigned long)dwLength2 + dataleft;
-						}
-						else	/* if (dataleft == 0) */
-						{
-							// process 256 samples, 16-bit (independent of # of channels)
-							isoundmixerprocess(lpvWritePtr, FQ_SIZE * sizeof(short), NULL, 0);
-							lpvWritePtr = (short *)lpvPtr2;
-							dataleft = (unsigned long)dwLength2;
-						}
-					}
-		
-					hr = lpMixBuffer->lpVtbl->Unlock(lpMixBuffer, lpvPtr1, dwLength1, lpvPtr2, dwLength2);
-					dbgAssert(hr == DS_OK);
-	
-					dwWritePos += dwBlockSize;
-				
-					if (dwWritePos >= buffersize)
-					{
-						dwWritePos -= buffersize;
-					}
-				}
-				else	/* primary buffer not ready yet */
-				{
-					Sleep(DS_MIX_SLEEP);
-				}
-			}
-			else
-			{
-				Sleep(DS_MIX_SLEEP);
-			}
-	
-			if (mixer.status == SOUND_STOPPING)
-			{
-				/* check and see if its done yet */
-				if (mixer.timeout <= mixerticks)
-				{
-					lpMixBuffer->lpVtbl->Stop(lpMixBuffer);
-					mixer.timeout = 0;
-					mixer.status = SOUND_STOPPED;
-				}
-			}
+SDL_sem *audio_ready;
+SDL_sem *audio_received;
 			
-			if (bSoundPaused && (mixer.status == SOUND_PLAYING))
-			{
-				mixer.status = SOUND_STOPPING;
-			}
-			if (bSoundDeactivated && (mixer.status == SOUND_PLAYING))
-			{
-				lpMixBuffer->lpVtbl->Stop(lpMixBuffer);
-				mixer.status = SOUND_STOPPED;
-			}
-		}
-		else if (mixer.status == SOUND_STOPPED)
-		{
-			/* mixer is paused so don't do nothing */
-			if ((!bSoundPaused) && (!bSoundDeactivated))
-			{
-				/* write 0's to mixer buffer */
-				/* lock primary buffer */
-				lpMixBuffer->lpVtbl->Lock(lpMixBuffer, 0, buffersize,
-							&lpvPtr1, &dwLength1, &lpvPtr2, &dwLength2, 0L);
-				
-				memset((byte *)lpvPtr1, 0, buffersize);
-				
-				lpMixBuffer->lpVtbl->Unlock(lpMixBuffer, lpvPtr1, dwLength1, lpvPtr2, dwLength2);
-			
-				/* start playing some silence */
-				lpMixBuffer->lpVtbl->SetCurrentPosition(lpMixBuffer, 0);
-				lpMixBuffer->lpVtbl->Play(lpMixBuffer, 0, 0, DSBPLAY_LOOPING);
-			
-				mixer.status = SOUND_PLAYING;
-			}
-			else
-			{
-				Sleep(0L);
-			}
-		}
-	}
-
-	// hr = lpMixBuffer->lpVtbl->Stop(lpMixBuffer);
-
-	/* clean out the buffer */
-	mixer.status = SOUND_FREE;
-
-	_endthread();
-}
-
-
-/*-----------------------------------------------------------------------------
-	Name		:
-	Description	:
-	Inputs		:
-	Outputs		:
-	Return		:
-----------------------------------------------------------------------------*/	
-void isoundmixerthreadWAVEOUT(void *dummy)
+void isoundmixerthreadSDL(void *dummy)
 {
 	sdword i;
 	
@@ -1136,16 +877,18 @@
 	bool	mix = FALSE;
 	bool	test = FALSE;
 
-	DWORD flags;
+	udword flags;
 
-	memset(&waveoutbuffer, 0, buffersize);
+	audio_ready = SDL_CreateSemaphore(0);
+	audio_received = SDL_CreateSemaphore(0);
+
+	SDL_PauseAudio(0);
 
-	nBufRIndex = 0;
 	nBufWIndex = 0;
 	for(i=0;i<WO_NUM_BUFFER_BLOCKS-1;i++)
 	{
-		isoundmixerqueueWAVEOUT();
-		Sleep(0);
+		isoundmixerqueueSDL();
+		// Sleep(0);
 	}
 
 	mixer.status = SOUND_PLAYING;
@@ -1154,22 +897,7 @@
 	{
 		if (mixer.status >= SOUND_PLAYING)
 		{
-			// check flags field
-			flags=WaveHead[nBufRIndex].dwFlags&(DWORD)(WHDR_DONE|WHDR_PREPARED|WHDR_BEGINLOOP|WHDR_ENDLOOP|WHDR_INQUEUE);
-			if((flags == (DWORD)(WHDR_DONE|WHDR_PREPARED)) || (flags == (DWORD)WHDR_PREPARED))
-			{
-				isoundmixerqueueWAVEOUT();
-
-				nBufRIndex++;
-				if (nBufRIndex >= WO_NUM_BUFFER_BLOCKS)
-				{
-					nBufRIndex = 0;
-				}
-			}
-			else
-			{
-				Sleep(WO_MIX_SLEEP);
-			}
+		        isoundmixerqueueSDL();
 
 			if (mixer.status == SOUND_STOPPING)
 			{
@@ -1178,7 +906,7 @@
 				{
 					mixer.timeout = 0;
 
-					mmresult = waveOutReset(hwo);
+					// mmresult = waveOutReset(hwo);
 					// dbgAssert(mmresult == MMSYSERR_NOERROR);
 
 					mixer.status = SOUND_STOPPED;
@@ -1192,7 +920,7 @@
 
 			if (bSoundDeactivated && (mixer.status == SOUND_PLAYING))
 			{
-				mmresult = waveOutReset(hwo);
+			        // mmresult = waveOutReset(hwo);//
 				// dbgAssert(mmresult == MMSYSERR_NOERROR);
 
 				mixer.status = SOUND_STOPPED;
@@ -1205,19 +933,18 @@
 			{
 				memset(&waveoutbuffer, 0, buffersize);
 			
-				nBufRIndex = 0;
 				nBufWIndex = 0;
 				for(i=0;i<WO_NUM_BUFFER_BLOCKS-1;i++)
 				{
-					isoundmixerqueueWAVEOUT();
-					Sleep(0L);
+					isoundmixerqueueSDL();
+					// Sleep(0L);
 				}
 
 				mixer.status = SOUND_PLAYING;
 			}
 			else
 			{
-				Sleep(0L);
+			    // Sleep(0L);
 			}
 		}
 	}
@@ -1225,27 +952,21 @@
 	// mmresult = waveOutReset(hwo);
 	// dbgAssert(mmresult == MMSYSERR_NOERROR);
 
+	SDL_DestroySemaphore(audio_ready);
+	SDL_DestroySemaphore(audio_received);
+
 	mixer.status = SOUND_FREE;
 
-	_endthread();
+	// _endthread();
 }
 
-/*-----------------------------------------------------------------------------
-	Name		:
-	Description	:
-	Inputs		:
-	Outputs		:
-	Return		:
-----------------------------------------------------------------------------*/	
-void isoundmixerqueueWAVEOUT()
+void isoundmixerqueueSDL()
 {
 	udword i, dataleft;
 	short *lpvWritePtr;
-	LPVOID lpvPtr2=NULL;
-	DWORD dwLength2=0;
 
-	// aet flags field
-	WaveHead[nBufWIndex].dwFlags = (DWORD)WHDR_PREPARED;
+	// set flags field
+	// WaveHead[nBufWIndex].dwFlags = (DWORD)WHDR_PREPARED;
 
 	lpvWritePtr = (short *)WaveHead[nBufWIndex].lpData;
 	dataleft = WaveHead[nBufWIndex].dwBufferLength;
@@ -1258,13 +979,15 @@
 		{
 			// process 256 samples, 16-bit (independent of # of channels)
 			isoundmixerprocess(lpvWritePtr, FQ_SIZE * sizeof(short), NULL, 0);
+			/* write(adump_fd, lpvWritePtr, FQ_SIZE * sizeof(short)); */
 			lpvWritePtr += FQ_SIZE * sizeof(short);
 		}
 		// dbgAssert(dataleft >= 0);
 	}
 	
 	// write data to waveout device
-	mmresult = waveOutWrite(hwo, (LPWAVEHDR)&WaveHead[nBufWIndex], sizeof(WAVEHDR));
+	SDL_SemPost(audio_ready);
+	SDL_SemWait(audio_received);
 	// dbgAssert(mmresult == MMSYSERR_NOERROR);
 
 	nBufWIndex++;
@@ -1275,3 +998,13 @@
 
 	return;
 }
+
+void soundfeedercb(void *userdata, Uint8 *stream, int len)
+{
+    SDL_SemWait(audio_ready);
+    dbgAssert(len == (int)WaveHead[nBufWIndex].dwBufferLength);
+    memcpy(stream, WaveHead[nBufWIndex].lpData, len);
+    SDL_SemPost(audio_received);
+    return;
+}
+
diff -urPw homeworld-orig/src/SDL/smixer.c.wip homeworld_sdl-0.3/src/SDL/smixer.c.wip
--- homeworld-orig/src/SDL/smixer.c.wip	2004-08-02 23:14:13.935566512 -0700
+++ homeworld_sdl-0.3/src/SDL/smixer.c.wip	2004-08-01 22:35:09.000000000 -0700
@@ -6,19 +6,16 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include <windows.h>
 #include <stdio.h>
-#include <process.h>
-#include <dsound.h>
 #include "fquant.h"
 #include "soundcmn.h"
 #include "soundlow.h"
-#include "debug.h"
-#include "soundstructs.h"
-#include "randy.h"
-#include "fastmath.h"
+#include "Debug.h"
+#include "SoundStructs.h"
+#include "Randy.h"
+#include "FastMath.h"
 #include "main.h"
-#include "globals.h"
+#include "Globals.h"
 
 #define MIX_BLOCK_SIZE			FQ_SIZE * sizeof(short) * 2 // 256 samples, 16-bit, stereo = 1024 bytes
 
@@ -36,8 +33,9 @@
 #define MIX_PANIC_DUR			16L	// approx 4 seconds - dur*fps
 
 /* function prototypes */
-void isoundmixerthreadWAVEOUT(void *dummy);
-void isoundmixerthreadDSOUND(void *dummy);
+//void isoundmixerthreadWAVEOUT(void *dummy);
+//void isoundmixerthreadDSOUND(void *dummy);
+void isoundmixerthreadSDLMIXER (void* dummy);
 void isoundmixerqueueWAVEOUT();
 sdword isoundmixerprocess(void *pBuf1, udword nSize1, void *pBuf2, udword nSize2);
 sdword isoundmixerdecodeEffect(sbyte *readptr, real32 *writeptr1, real32 *writeptr2, ubyte *exponent, sdword size, uword bitrate, EFFECT *effect);
@@ -74,12 +72,12 @@
 
 sdword dctpanicmode = SOUND_MODE_NORM;	// DCT panic mode, normal by default
 
-LPDIRECTSOUNDBUFFER lpMixBuffer = NULL;
+//LPDIRECTSOUNDBUFFER lpMixBuffer = NULL;
 
 real32 timebufferL[FQ_DSIZE], timebufferR[FQ_DSIZE], temptimeL[FQ_DSIZE], temptimeR[FQ_DSIZE];
 real32 mixbuffer1L[FQ_SIZE], mixbuffer1R[FQ_SIZE], mixbuffer2L[FQ_SIZE], mixbuffer2R[FQ_SIZE];
 
-extern LPDIRECTSOUND lpDirectSound;
+//extern LPDIRECTSOUND lpDirectSound;
 extern CHANNEL channels[];
 extern bool soundinited;
 extern STREAM streams[];
@@ -179,88 +177,17 @@
 }
 
 
-sdword smixCreateDSoundBuffer(WAVEFORMATEX *pcmwf)
-{
-	DSBUFFERDESC    dsbd;
-	
-	// Set up the direct sound buffer.
-	memset(&dsbd, 0, sizeof(DSBUFFERDESC));
-	dsbd.dwSize			= sizeof(DSBUFFERDESC);
-	dsbd.dwFlags		= DSBCAPS_STATIC | DSBCAPS_CTRLDEFAULT;
-	dsbd.lpwfxFormat	= pcmwf;
-	dsbd.dwBufferBytes	= DS_MIX_BUFFER_SIZE;
-
-	if ((lpDirectSound->lpVtbl->CreateSoundBuffer(lpDirectSound, &dsbd,
-		&lpMixBuffer, NULL )) != DS_OK)
-	{
-		lpMixBuffer = NULL;
-		return (SOUND_ERR);
-	}
-
-	return (SOUND_OK);
-}
-
-
-sdword smixInitMixBuffer(WAVEFORMATEX *pcmwf)
+sdword smixInitMixBuffer(SDLWAVEFORMAT *pcmwf)
 {
 	HRESULT hr;
 	LPVOID lpvPtr1, lpvPtr2;
 	DWORD dwLength1, dwLength2;
 	sdword i;
 	
-	if (bDirectSoundCertified)
-	{
 		buffersize = DS_MIX_BUFFER_SIZE;
 		dwBlockSize = buffersize / DS_NUM_BUFFER_BLOCKS;
 		dwMixAhead = DS_MIX_BUFFER_AHEAD;
 		
-		// write 0's to mixer buffer
-		// lock primary buffer
-		hr = lpMixBuffer->lpVtbl->Lock(lpMixBuffer, 0, buffersize,
-					&lpvPtr1, &dwLength1, &lpvPtr2, &dwLength2, 0L);
-		
-		memset((byte *)lpvPtr1, 0, buffersize);
-		
-		hr = lpMixBuffer->lpVtbl->Unlock(lpMixBuffer, lpvPtr1, dwLength1, lpvPtr2, dwLength2);
-	
-		// start playing some silence
-		hr = lpMixBuffer->lpVtbl->SetCurrentPosition(lpMixBuffer, 0);
-		hr = lpMixBuffer->lpVtbl->Play(lpMixBuffer, 0, 0, DSBPLAY_LOOPING);
-	
-		return (SOUND_OK);
-	}
-
-	// else this is the waveout thread stuff
-	buffersize = WO_MIX_BUFFER_SIZE;
-	dwBlockSize = buffersize / WO_NUM_BUFFER_BLOCKS;
-	dwMixAhead = WO_MIX_BUFFER_AHEAD;
-	
-	memcpy(&woFormat, pcmwf, sizeof(WAVEFORMATEX));
-	
-	mmresult = waveOutOpen(&hwo, WAVE_MAPPER, (LPWAVEFORMATEX)&woFormat, 0, 0, CALLBACK_NULL | WAVE_ALLOWSYNC);
-	if (mmresult != MMSYSERR_NOERROR)
-	{
-		// couldn't initialize the wave device
-		return (SOUND_ERR);
-	}
-	
-	for (i = 0; i < WO_NUM_BUFFER_BLOCKS; i++)
-	{
-		pWaveBuf[i] = (LPSTR)(waveoutbuffer + (dwBlockSize * i));
-		WaveHead[i].lpData = pWaveBuf[i];
-		WaveHead[i].dwBufferLength = dwBlockSize;
-		WaveHead[i].dwFlags = 0;
-	
-		mmresult = waveOutPrepareHeader(hwo, (LPWAVEHDR)&WaveHead[i], sizeof(WAVEHDR));
-		if (mmresult != MMSYSERR_NOERROR)
-		{
-			// couldn't initialize the wave device
-			// close the device...
-			isoundmixerrestore();
-			return (SOUND_ERR);
-		}
-	}
-	
 	return (SOUND_OK);
 }
 
diff -urPw homeworld-orig/src/SDL/soundcmn.h homeworld_sdl-0.3/src/SDL/soundcmn.h
--- homeworld-orig/src/SDL/soundcmn.h	2002-09-04 12:47:04.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/soundcmn.h	2004-08-01 22:35:08.000000000 -0700
@@ -1,11 +1,13 @@
 #ifndef ___SOUNDCMN_H
 #define ___SOUNDCMN_H
 
+#include <SDL.h>
+
 #include "fqcodec.h"
 #include "fqeffect.h"
-#include "types.h"
+#include "Types.h"
 #include "soundlow.h"
-#include "file.h"
+#include "File.h"
 
 #define NUM_FADE_BLOCKS		20
 
@@ -16,6 +18,17 @@
 
 /* structures */
 
+/* Basic replacement for WAVEFORMATEX. */
+typedef struct
+{
+	Uint16 format;
+        Uint16 channels;
+        Uint32 frequency;
+        Uint32 avgBytesPerSecond;
+        Uint16 blockAlign;
+/*        Unit16 bitsPerSample; */
+} SDLWAVEFORMAT;
+
 typedef struct
 {
 	udword			id;
@@ -33,7 +46,7 @@
 	sbyte			pan;
 	sbyte			pad[2];
 
-	WAVEFORMATEX	waveformat;
+	SDLWAVEFORMAT	waveformat;
 	sword			wavepad;
 } PATCH;
 
@@ -148,12 +161,12 @@
 {
 	STREAMHEADER	header;
 
-	BYTE			*buffer;	/* this is a pointer to the buffer to read data from the stream file */
+	ubyte			*buffer;	/* this is a pointer to the buffer to read data from the stream file */
 	sdword			buffersize;	/* this is the size of the stream buffer / SOUND_STREAM_NUM_BUFFERS */
 	sdword			blocksize;	/* this is the size of the stream buffer / SOUND_STREAM_NUM_BUFFERS */
 
-	BYTE			*writepos;
-	BYTE			*bufferend;
+	ubyte			*writepos;
+	ubyte			*bufferend;
 
 	sdword			blockstatus[2];
 
@@ -195,7 +208,7 @@
 
 typedef struct
 {
-	HANDLE			filehandle;	/* this is the O/S handle to the file */
+	FILE*			fp;	        /* this is the O/S handle to the file */
 	sdword			handle;		/* this handle is used for indexing into the streamfiles array */
 } STREAMFILE;
 
@@ -207,7 +220,7 @@
 } SOUNDCOMPONENT;
 
 /* functions */
-sdword isoundmixerinit(WAVEFORMATEX *pcmwf);
+sdword isoundmixerinit(SDL_AudioSpec *aspec);
 void isoundmixerrestore(void);
 void isoundstreamupdate(void *dummy);
 
@@ -218,8 +231,8 @@
 sdword SNDcreatehandle(sdword channel);
 PATCH *SNDgetpatch(void *bankaddress, sdword patnum);
 
-sdword smixCreateDSoundBuffer(WAVEFORMATEX *pcmwf);
-sdword smixInitMixBuffer(WAVEFORMATEX *pcmwf);
+sdword smixCreateDSoundBuffer(SDLWAVEFORMAT *pcmwf);
+sdword smixInitMixBuffer(SDL_AudioSpec *aspec);
 
 sdword streamStartThread(void);
 
diff -urPw homeworld-orig/src/SDL/soundlow.c homeworld_sdl-0.3/src/SDL/soundlow.c
--- homeworld-orig/src/SDL/soundlow.c	2002-09-04 12:47:04.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/soundlow.c	2004-08-01 22:35:09.000000000 -0700
@@ -4,18 +4,15 @@
 
     Created 7/24/1997 by gshaw
     Copyright Relic Entertainment, Inc.  All rights reserved.
+
+    CUT CUT CUT CUT CUT OMG WTF HAVE I DONE!?!#@
 =============================================================================*/
 
-#define WIN32_LEAN_AND_MEAN
-#include <windows.h>
-#include <mmsystem.h>
 #include <string.h>
-#include <dsound.h>
-
-#include "switches.h"
-#include "debug.h"
+#include "Switches.h"
+#include "Debug.h"
 #include "soundlow.h"
-#include "file.h"
+#include "File.h"
 #include "soundcmn.h"
 #include "main.h"
 
@@ -40,8 +37,6 @@
 /* variables */
 CHANNEL channels[SOUND_MAX_VOICES];
 sword numpatches = 0;
-LPDIRECTSOUND lpDirectSound = NULL;
-LPDIRECTSOUNDBUFFER lpPrimaryBuffer = NULL;
 sdword	lasthandle = 0;
 bool soundinited = FALSE;
 BANK *bank;
@@ -52,8 +47,6 @@
 bool bSoundPaused = FALSE;
 bool bSoundDeactivated = FALSE;
 
-WAVEFORMATEX waveFormatEX;
-
 sdword numbanks = 0;
 sdword numchans[4] = {0,0,0,0};
 BANKPOINTERS bankpointers[4];
@@ -68,7 +61,6 @@
 //streamprintfunction	debugfunction = NULL;
 //char debugtext[256];
 
-extern HWND ghMainWindow;
 extern real32 cardiod[];
 extern udword mixerticks;
 
@@ -181,6 +173,8 @@
 }
 
 
+extern void soundfeedercb(void *userdata, Uint8 *stream, int len);
+
 /*-----------------------------------------------------------------------------
 	Name		:
 	Description	:
@@ -188,131 +182,14 @@
 	Outputs		:
 	Return		:
 ----------------------------------------------------------------------------*/	
-void soundupdate(void)
-{
-	return;
-}
-
-
-sdword soundStartDSound(HWND hWnd)
-{
-	DSBUFFERDESC dsbdesc;
-	DSCAPS dscaps;
-	HRESULT hr;
-
-	if (useWaveout)
-	{
-		return (SOUND_ERR);
-	}
-	
-	if(DS_OK == DirectSoundCreate(NULL, &lpDirectSound, NULL))
-	{
-		// Set up DSBUFFERDESC structure.
-		memset(&dsbdesc, 0, sizeof(DSBUFFERDESC)); // Zero it out.
-		dsbdesc.dwSize = sizeof(DSBUFFERDESC);
-		dsbdesc.dwFlags = DSBCAPS_PRIMARYBUFFER;
-
-		// Buffer size is determined by sound hardware.
-		dsbdesc.dwBufferBytes = 0;
-		dsbdesc.lpwfxFormat = NULL; // Must be NULL for primary buffers.
-
-		if (coopDSound)
-		{
-			// Try to set in priority mode so Homeworld will share the wave device
-			hr = lpDirectSound->lpVtbl->SetCooperativeLevel(lpDirectSound, hWnd, DSSCL_PRIORITY);
-			if (hr != DS_OK)
-			{
-				// Hmmm, couldn't set priority so lets try exclusive
-                hr = lpDirectSound->lpVtbl->SetCooperativeLevel(lpDirectSound, hWnd, DSSCL_EXCLUSIVE);
-			}
-		}
-		else
-		{
-			// Try to set in Exclusive mode
-			hr = lpDirectSound->lpVtbl->SetCooperativeLevel(lpDirectSound, hWnd, DSSCL_EXCLUSIVE);
-			if (hr != DS_OK)
-			{
-				// maybe something already has the wave device so lets try sharing it?
-                hr = lpDirectSound->lpVtbl->SetCooperativeLevel(lpDirectSound, hWnd, DSSCL_PRIORITY);
-			}
-		}
-		
-		if(hr == DS_OK)
-		{
-			// Get direct sound Caps.
-			dscaps.dwSize = sizeof(DSCAPS);
-			if (DS_OK == lpDirectSound->lpVtbl->GetCaps(lpDirectSound, &dscaps))
-			{
-#ifndef HW_Release
-				dbgMessagef("\n*****  DIRECT SOUND CAPS  *****");
-#endif
-				if ((dscaps.dwFlags & DSCAPS_CERTIFIED) || useDSound)
-				{
-#ifndef HW_Release
-					dbgMessagef("\nDriver is CERTIFIED");
-#endif
-					bDirectSoundCertified = TRUE;
-				}
-				else 	// if (dscaps.dwFlags & DSCAPS_EMULDRIVER)
+sdword soundinit(bool mode)
 				{
-#ifndef HW_Release
-					dbgMessagef("\nDriver not certified, using WAVEOUT");
+#ifdef _MACOSX_FIX_ME
+	return SOUND_ERR;
 #endif
-					lpDirectSound->lpVtbl->Release(lpDirectSound);
-					return (SOUND_ERR);
-				}
-				
-				// Succeeded. Try to create buffer.
-				if(DS_OK == lpDirectSound->lpVtbl->CreateSoundBuffer(lpDirectSound, &dsbdesc, &lpPrimaryBuffer, NULL))
-				{
-					// Succeeded. Set primary buffer to desired format.
-					if(DS_OK == (lpPrimaryBuffer)->lpVtbl->SetFormat(lpPrimaryBuffer, &waveFormatEX))
-					{
-						return (SOUND_OK);
-					}
-					else
-					{
-						(lpPrimaryBuffer)->lpVtbl->Release(lpPrimaryBuffer);
-					}
-				}
-			}
-			else
-			{
-				lpDirectSound->lpVtbl->Release(lpDirectSound);
-			}
-		}
-		// SetCooperativeLevel failed.
-		// CreateSoundBuffer, or SetFormat.
-		lpPrimaryBuffer = NULL;
-	}
-	
-	return (SOUND_ERR);
-}
-
-
-void soundStopDSound(void)
-{
-    HRESULT hr;
-
-	if (bDirectSoundCertified)
-	{
-		/* shut down DirectSound */
-		hr = lpPrimaryBuffer->lpVtbl->Release(lpPrimaryBuffer);
-		hr = lpDirectSound->lpVtbl->Release(lpDirectSound);
-	}
-}
 
-
-/*-----------------------------------------------------------------------------
-	Name		:
-	Description	:
-	Inputs		:
-	Outputs		:
-	Return		:
-----------------------------------------------------------------------------*/	
-sdword soundinit(HWND hWnd, sdword mode)
-{
-	sdword i;
+	SDL_AudioSpec aspec;
+	sdword i, result;
 
 	// clean up the channels
 	for (i = 0; i < soundnumvoices; i++)
@@ -331,99 +208,49 @@
 	streamer.status = SOUND_FREE;
 	streamer.timeout = 0;
 
-	// Set up wave format structure.
-	memset(&waveFormatEX, 0, sizeof(WAVEFORMATEX));
-	waveFormatEX.wFormatTag = WAVE_FORMAT_PCM;
-	waveFormatEX.nChannels = 2;
-	waveFormatEX.wBitsPerSample = 16;
-	waveFormatEX.nSamplesPerSec = FQ_RATE;
-	waveFormatEX.nBlockAlign = waveFormatEX.nChannels * (waveFormatEX.wBitsPerSample / 8);
-	waveFormatEX.nAvgBytesPerSec = waveFormatEX.nSamplesPerSec * waveFormatEX.nBlockAlign;
-
-	if (soundStartDSound(hWnd) != SOUND_OK)
-	{
-		// couldn't init DSound so use Waveout instead
 		useWaveout = TRUE;
 		useDSound = FALSE;
 		coopDSound = FALSE;
 		bDirectSoundCertified = FALSE;
-	}
-	
-	if (isoundmixerinit(&waveFormatEX) != SOUND_OK)
-	{
-		soundinited = FALSE;
-		return (SOUND_ERR);
-	}
 
+	// Set up wave format structure.
+	aspec.freq = FQ_RATE;
+	aspec.format = AUDIO_S16;
+	aspec.channels = 2;
+	aspec.samples = FQ_SIZE;
+	aspec.callback = soundfeedercb;
+	aspec.userdata = NULL;
+
+	if (SDL_OpenAudio(&aspec, NULL) < 0) {
+	    dbgMessagef("Couldn't open audio: %s\n", SDL_GetError());
+	    result = SOUND_ERR;
+	}
+	else if (isoundmixerinit(&aspec) != SOUND_OK) {
+	    dbgMessagef("Unable to init mixer subsystem\n");
+	    result = SOUND_ERR;
+	} else {
 	soundinited = TRUE;
-	
-	return (SOUND_OK);
+	    result = SOUND_OK;
+	}
+	return result;
 }
 
 
-sdword soundreinit(HWND hWnd)
-{
-	// need to restart Direct Sound
-	if (soundStartDSound(hWnd) != SOUND_OK)
+sdword soundreinit()
 	{
 		// couldn't init DSound so use Waveout instead
 		useWaveout = TRUE;
 		useDSound = FALSE;
 		coopDSound = FALSE;
 		bDirectSoundCertified = FALSE;
-	}
-	
-	if (bDirectSoundCertified)
-	{
-		// Create the Direct Sound mix buffer
-		if (smixCreateDSoundBuffer(&waveFormatEX) != SOUND_OK)
-		{
-			return (SOUND_ERR);
-		}
-	}
 	
-	// Initialize the mix buffer
-	if (smixInitMixBuffer(&waveFormatEX) != SOUND_OK)
-	{
-			return (SOUND_ERR);
-	}
-
-	bSoundPaused = FALSE;
-
-	while(mixer.status != SOUND_PLAYING)
-	{
-		Sleep(0);
-	}
-
-	return (SOUND_OK);
+	return SOUND_ERR;
 }
 
 
 void soundclose(void)
 {
-	// do a quick fade out
-	soundstopall(SOUND_FADE_STOPALL);
-
-	// shut down the streamer thread
-	streamer.timeout = mixerticks + SOUND_FADE_MIXER;
-	
-	// shut down the mixer thread
-	mixer.timeout = mixerticks + SOUND_FADE_MIXER;
-	
 	bSoundPaused = TRUE;
-
-	while (mixer.status != SOUND_STOPPED)
-	{
-		musicEventUpdateVolume();
-		Sleep(0);
-	}
-	// reinit the streams
-	
-    // clean up the mix buffer
-	isoundmixerrestore();
-
-	// need to shutdown Direct Sound
-	soundStopDSound();
 }
 
 
@@ -436,27 +263,17 @@
 ----------------------------------------------------------------------------*/	
 void soundrestore(void)
 {
-	/* shut down sounds that are still playing */
-
 	soundpause(TRUE);
 
 	soundinited = FALSE;
 	
 	while (!((streamer.status == SOUND_FREE) && (mixer.status == SOUND_FREE)))
 	{
-		Sleep(0);
+		SDL_Delay(0);
 	}
 
 	isoundmixerrestore();
 
-	if (bDirectSoundCertified)
-	{
-		/* shut down DirectSound */
-		lpPrimaryBuffer->lpVtbl->Release(lpPrimaryBuffer);
-
-		lpDirectSound->lpVtbl->Release(lpDirectSound);
-	}
-
 	return;
 }
 
@@ -480,7 +297,7 @@
 			while (!(mixer.status == SOUND_STOPPED))
 			{
 				musicEventUpdateVolume();
-				Sleep(0);
+				SDL_Delay(0);
 			}
 
 		}
@@ -791,7 +608,7 @@
 		pchan->currentpos = (sbyte *)ppatch->dataoffset;
 	}
 	
-	if (ppatch->waveformat.nSamplesPerSec < FQ_RATE)
+	if (ppatch->waveformat.frequency < FQ_RATE)
 	{
 		pchan->fqsize = FQ_QSIZE;
 	}
@@ -1329,10 +1146,7 @@
 {
 	CHANNEL *pchan;
 	sdword	i;
-	sdword	newchan = 0,
-			dupchan = 0;
 	sdword	channel = SOUND_DEFAULT;
-    DWORD	dwStatus = 0;
 	sdword	lowchannel = SOUND_DEFAULT;
 	real32	lowvolume = (real32)SOUND_VOL_MAX;
 	sdword	lowticks = 255;
@@ -1614,7 +1428,7 @@
 		pchan->currentpos = (sbyte *)ppatch->dataoffset;
 	}
 	
-	if (ppatch->waveformat.nSamplesPerSec < FQ_RATE)
+	if (ppatch->waveformat.frequency < FQ_RATE)
 	{
 		pchan->fqsize = FQ_QSIZE;
 	}
diff -urPw homeworld-orig/src/SDL/soundlow.c.wip homeworld_sdl-0.3/src/SDL/soundlow.c.wip
--- homeworld-orig/src/SDL/soundlow.c.wip	2004-08-02 23:14:13.941565600 -0700
+++ homeworld_sdl-0.3/src/SDL/soundlow.c.wip	2004-08-01 22:35:05.000000000 -0700
@@ -6,16 +6,13 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#define WIN32_LEAN_AND_MEAN
-#include <windows.h>
-#include <mmsystem.h>
-#include <string.h>
-#include <dsound.h>
+#include "SDL_mixer.h"
 
-#include "switches.h"
-#include "debug.h"
+#include <string.h>
+#include "Switches.h"
+#include "Debug.h"
 #include "soundlow.h"
-#include "file.h"
+#include "File.h"
 #include "soundcmn.h"
 #include "main.h"
 
@@ -40,8 +37,6 @@
 /* variables */
 CHANNEL channels[SOUND_MAX_VOICES];
 sword numpatches = 0;
-LPDIRECTSOUND lpDirectSound = NULL;
-LPDIRECTSOUNDBUFFER lpPrimaryBuffer = NULL;
 sdword	lasthandle = 0;
 bool soundinited = FALSE;
 BANK *bank;
@@ -52,7 +47,7 @@
 bool bSoundPaused = FALSE;
 bool bSoundDeactivated = FALSE;
 
-WAVEFORMATEX waveFormatEX;
+SDLWAVEFORMAT gWaveFormat;
 
 sdword numbanks = 0;
 sdword numchans[4] = {0,0,0,0};
@@ -68,7 +63,6 @@
 //streamprintfunction	debugfunction = NULL;
 //char debugtext[256];
 
-extern HWND ghMainWindow;
 extern real32 cardiod[];
 extern udword mixerticks;
 
@@ -194,17 +188,42 @@
 }
 
 
-sdword soundStartDSound(HWND hWnd)
+sdword soundStartDSound(void)
 {
-	DSBUFFERDESC dsbdesc;
-	DSCAPS dscaps;
-	HRESULT hr;
+	Uint32 flags;
 
+#if 0
 	if (useWaveout)
 	{
 		return (SOUND_ERR);
 	}
+#endif
+
+	flags = SDL_WasInit(SDL_INIT_EVERYTHING);
+	if (!flags)
+	{
+		if (SDL_Init(SDL_INIT_AUDIO) == -1)
+			return SOUND_ERR;
+	}
+	else if (!(flags & SDL_INIT_AUDIO))
+	{
+		if (SDL_InitSubSystem(SDL_INIT_AUDIO) == -1)
+			return SOUND_ERR;
+	}
+
+	if (Mix_OpenAudio(gWaveFormat.frequency, gWaveFormat.format,
+		gWaveFormat.channels, gWaveFormat.chunkSize) == -1)
+	{
+		if (flags)
+			SDL_QuitSubSystem(SDL_INIT_AUDIO);
+		else
+			SDL_Quit();
+		return SOUND_ERR;
+	}
 	
+	return SOUND_OK;
+
+#if 0
 	if(DS_OK == DirectSoundCreate(NULL, &lpDirectSound, NULL))
 	{
 		// Set up DSBUFFERDESC structure.
@@ -287,11 +306,14 @@
 	}
 	
 	return (SOUND_ERR);
+#endif
 }
 
 
 void soundStopDSound(void)
 {
+	Mix_CloseAudio();
+#if 0
     HRESULT hr;
 
 	if (bDirectSoundCertified)
@@ -300,6 +322,7 @@
 		hr = lpPrimaryBuffer->lpVtbl->Release(lpPrimaryBuffer);
 		hr = lpDirectSound->lpVtbl->Release(lpDirectSound);
 	}
+#endif
 }
 
 
@@ -310,7 +333,7 @@
 	Outputs		:
 	Return		:
 ----------------------------------------------------------------------------*/	
-sdword soundinit(HWND hWnd, sdword mode)
+sdword soundinit(sdword mode)
 {
 	sdword i;
 
@@ -332,6 +355,12 @@
 	streamer.timeout = 0;
 
 	// Set up wave format structure.
+	gWaveFormat.frequency = FQ_RATE;
+	gWaveFormat.format = AUDIO_S16SYS;
+	gWaveFormat.channels = 2;
+	gWaveFormat.chunkSize = 1024;
+
+#if 0
 	memset(&waveFormatEX, 0, sizeof(WAVEFORMATEX));
 	waveFormatEX.wFormatTag = WAVE_FORMAT_PCM;
 	waveFormatEX.nChannels = 2;
@@ -339,17 +368,15 @@
 	waveFormatEX.nSamplesPerSec = FQ_RATE;
 	waveFormatEX.nBlockAlign = waveFormatEX.nChannels * (waveFormatEX.wBitsPerSample / 8);
 	waveFormatEX.nAvgBytesPerSec = waveFormatEX.nSamplesPerSec * waveFormatEX.nBlockAlign;
+#endif
 
-	if (soundStartDSound(hWnd) != SOUND_OK)
+	if (soundStartDSound() != SOUND_OK)
 	{
-		// couldn't init DSound so use Waveout instead
-		useWaveout = TRUE;
-		useDSound = FALSE;
-		coopDSound = FALSE;
-		bDirectSoundCertified = FALSE;
+		soundinited = FALSE;
+		return (SOUND_ERR);
 	}
 	
-	if (isoundmixerinit(&waveFormatEX) != SOUND_OK)
+	if (isoundmixerinit(&gWaveFormat) != SOUND_OK)
 	{
 		soundinited = FALSE;
 		return (SOUND_ERR);
@@ -361,10 +388,10 @@
 }
 
 
-sdword soundreinit(HWND hWnd)
+sdword soundreinit()
 {
 	// need to restart Direct Sound
-	if (soundStartDSound(hWnd) != SOUND_OK)
+	if (soundStartDSound() != SOUND_OK)
 	{
 		// couldn't init DSound so use Waveout instead
 		useWaveout = TRUE;
@@ -392,7 +419,7 @@
 
 	while(mixer.status != SOUND_PLAYING)
 	{
-		Sleep(0);
+		SDL_Delay(0);
 	}
 
 	return (SOUND_OK);
@@ -444,7 +471,7 @@
 	
 	while (!((streamer.status == SOUND_FREE) && (mixer.status == SOUND_FREE)))
 	{
-		Sleep(0);
+		SDL_Delay(0);
 	}
 
 	isoundmixerrestore();
diff -urPw homeworld-orig/src/SDL/soundlow.h homeworld_sdl-0.3/src/SDL/soundlow.h
--- homeworld-orig/src/SDL/soundlow.h	2002-09-04 12:47:04.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/soundlow.h	2004-08-01 22:35:10.000000000 -0700
@@ -9,7 +9,7 @@
 #ifndef ___SOUNDLOW_H
 #define ___SOUNDLOW_H
 
-#include "types.h"
+#include "Types.h"
 #include "fqcodec.h"
 #include "fqeffect.h"
 
@@ -152,8 +152,10 @@
 void soundPanicReset(void);	// mixer.c
 
 /* functions */
-sdword soundinit(HWND hWnd, sdword mode);
-sdword soundreinit(HWND hWnd);
+//sdword soundinit(HWND hWnd, sdword mode);
+sdword soundinit(bool mode);
+//sdword soundreinit(HWND hWnd);
+sdword soundreinit();
 void soundrestore(void);
 void soundclose(void);
 void soundupdate(void);
diff -urPw homeworld-orig/src/SDL/sstglide.c homeworld_sdl-0.3/src/SDL/sstglide.c
--- homeworld-orig/src/SDL/sstglide.c	2002-09-04 12:47:06.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/sstglide.c	2004-08-01 22:35:06.000000000 -0700
@@ -6,21 +6,37 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
+#ifdef _WIN32
 #include <windows.h>
+#else
+#include <dlfcn.h>
+#endif
+#include "SDL_loadso.h"
 #include <string.h>
 #include <glide.h>
 #include "sstglide.h"
+#include "gldll.h"
 
-static bool sstHaveGlide = FALSE;
+#ifdef _WIN32
+#define APIENTRY __stdcall
+#else
+#define APIENTRY
+#endif
+
+#ifdef _WIN32
+#define DLL_GETPROCADDRESS(LIB, SYM) GetProcAddress(LIB, SYM)
+#elif !defined(_MACOSX)
+#define DLL_GETPROCADDRESS(LIB, SYM) dlsym(LIB, SYM)
+#endif
 
-typedef void (__stdcall * ALPHAFUNCproc)(GLenum, GLclampf);
+static bool sstHaveGlide = FALSE;
 
-typedef FxBool (__stdcall * GRLFBLOCKproc)(GrLock_t, GrBuffer_t, GrLfbWriteMode_t,
+typedef FxBool (APIENTRY * GRLFBLOCKproc)(GrLock_t, GrBuffer_t, GrLfbWriteMode_t,
                                            GrOriginLocation_t, FxBool, GrLfbInfo_t*);
-typedef FxBool (__stdcall * GRLFBUNLOCKproc)(GrLock_t, GrBuffer_t);
-typedef void (__stdcall * GRBUFFERSWAPproc)(int);
-typedef void (__stdcall * GRSSTIDLEproc)(void);
-typedef void (__stdcall * GRSSTQUERYBOARDSproc)(GrHwConfiguration*);
+typedef FxBool (APIENTRY * GRLFBUNLOCKproc)(GrLock_t, GrBuffer_t);
+typedef void (APIENTRY * GRBUFFERSWAPproc)(int);
+typedef void (APIENTRY * GRSSTIDLEproc)(void);
+typedef void (APIENTRY * GRSSTQUERYBOARDSproc)(GrHwConfiguration*);
 
 GRLFBLOCKproc sstLfbLock = NULL;
 GRLFBUNLOCKproc sstLfbUnlock = NULL;
@@ -30,21 +46,28 @@
 
 bool sstHardwareExists(sdword* type)
 {
-    HINSTANCE lib;
+    void* lib;
     GrHwConfiguration hwconfig;
     bool rval;
 
-    lib = GetModuleHandle("glide2x.dll");
-    if (lib == NULL)
-    {
-        lib = LoadLibrary("glide2x.dll");
-        if (lib == NULL)
+#ifdef _WIN32
+    lib = (void*)GetModuleHandle("glide2x.dll");
+    if (!lib)
+        lib = (void*)LoadLibrary("glide2x.dll");
+#else
+    lib = dlopen("libglide2x.so", RTLD_NOW);
+#endif
+    if (!lib)
         {
             return FALSE;
         }
-    }
 
-    sstQueryBoards = (GRSSTQUERYBOARDSproc)GetProcAddress(lib, "_grSstQueryBoards@4");
+#ifdef _MACOSX
+    sstQueryBoards = (GRSSTQUERYBOARDSproc)SDL_LoadFunction(lib, "grSstQueryBoards");
+#else
+    sstQueryBoards = (GRSSTQUERYBOARDSproc)DLL_GETPROCADDRESS(lib, "grSstQueryBoards");
+#endif
+
     if (sstQueryBoards == NULL)
     {
         return FALSE;
@@ -84,20 +107,32 @@
         rval = FALSE;
     }
 
-    while (FreeLibrary(lib)) ;
+#ifdef _WIN32
+    while (FreeLibrary((HINSTANCE)lib)) ;
+#else
+    while (!dlclose(lib)) { }
+#endif
 
     return rval;
 }
 
 static void sstFreeHandle(void)
 {
-    HINSTANCE lib;
+    void* lib;
 
-    lib = GetModuleHandle("glide2x.dll");
+#ifdef _WIN32
+    lib = (void*)GetModuleHandle("glide2x.dll");
     if (lib != NULL)
     {
-        while (FreeLibrary(lib)) ;
+        while (FreeLibrary((HINSTANCE)lib)) ;
     }
+#else
+    lib = dlopen("libglide2x.so", RTLD_LAZY);
+    if (lib)
+    {
+        while (!dlclose(lib)) { }
+    }
+#endif
 }
 
 bool sstLoaded(void)
@@ -107,25 +142,35 @@
 
 void sstStartup(void)
 {
-    HINSTANCE lib;
+    void* lib;
 
     //locate Glide .DLL and grab func pointers
-    lib = GetModuleHandle("glide2x.dll");
-    if (lib == NULL)
-    {
-        lib = LoadLibrary("glide2x.dll");
-        if (lib == NULL)
+#ifdef _WIN32
+    lib = (void*)GetModuleHandle("glide2x.dll");
+    if (!lib)
+        lib = (void*)LoadLibrary("glide2x.dll");
+#else
+    lib = dlopen("libglide2x.so", RTLD_NOW);
+#endif
+    if (!lib)
         {
             sstHaveGlide = FALSE;
             return;
         }
-    }
 
-    sstLfbLock = (GRLFBLOCKproc)GetProcAddress(lib, "_grLfbLock@24");
-    sstLfbUnlock = (GRLFBUNLOCKproc)GetProcAddress(lib, "_grLfbUnlock@8");
-    sstBufferSwap = (GRBUFFERSWAPproc)GetProcAddress(lib, "_grBufferSwap@4");
-    sstSstIdle = (GRSSTIDLEproc)GetProcAddress(lib, "_grSstIdle@0");
-    sstQueryBoards = (GRSSTQUERYBOARDSproc)GetProcAddress(lib, "_grSstQueryBoards@4");
+#ifdef _MACOSX
+    sstLfbLock     = (GRLFBLOCKproc)SDL_LoadFunction(lib, "grLfbLock");
+    sstLfbUnlock   = (GRLFBUNLOCKproc)SDL_LoadFunction(lib, "grLfbUnlock");
+    sstBufferSwap  = (GRBUFFERSWAPproc)SDL_LoadFunction(lib, "grBufferSwap");
+    sstSstIdle     = (GRSSTIDLEproc)SDL_LoadFunction(lib, "grSstIdle");
+    sstQueryBoards = (GRSSTQUERYBOARDSproc)SDL_LoadFunction(lib, "grSstQueryBoards");
+#else
+    sstLfbLock     = (GRLFBLOCKproc)DLL_GETPROCADDRESS(lib, "grLfbLock");
+    sstLfbUnlock   = (GRLFBUNLOCKproc)DLL_GETPROCADDRESS(lib, "grLfbUnlock");
+    sstBufferSwap  = (GRBUFFERSWAPproc)DLL_GETPROCADDRESS(lib, "grBufferSwap");
+    sstSstIdle     = (GRSSTIDLEproc)DLL_GETPROCADDRESS(lib, "grSstIdle");
+    sstQueryBoards = (GRSSTQUERYBOARDSproc)DLL_GETPROCADDRESS(lib, "grSstQueryBoards");
+#endif
 
     if (sstLfbLock == NULL ||
         sstLfbUnlock == NULL ||
diff -urPw homeworld-orig/src/SDL/sstglide.h homeworld_sdl-0.3/src/SDL/sstglide.h
--- homeworld-orig/src/SDL/sstglide.h	2002-09-04 12:47:06.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/sstglide.h	2004-08-01 22:35:06.000000000 -0700
@@ -9,7 +9,7 @@
 #ifndef _SSTGLIDE_H
 #define _SSTGLIDE_H
 
-#include "types.h"
+#include "Types.h"
 
 #define SST_VOODOO  0
 #define SST_VOODOO2 1
diff -urPw homeworld-orig/src/SDL/sstream.c homeworld_sdl-0.3/src/SDL/sstream.c
--- homeworld-orig/src/SDL/sstream.c	2002-09-04 12:47:06.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/sstream.c	2004-08-01 22:35:08.000000000 -0700
@@ -6,23 +6,25 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
+#ifdef _WIN32
 #define WIN32_LEAN_AND_MEAN
 #include <windows.h>
-#include <string.h>
 #include <mmsystem.h>
+#include <string.h>
 #include <dsound.h>
 #include <process.h>
+#endif
 
-#include "types.h"
-#include "switches.h"
-#include "debug.h"
+#include "Types.h"
+#include "Switches.h"
+#include "Debug.h"
 #include "soundlow.h"
 #include "soundcmn.h"
-#include "file.h"
+#include "File.h"
 #include "fqeffect.h"
-#include "soundstructs.h"
-#include "speechevent.h"
-#include "subtitle.h"
+#include "SoundStructs.h"
+#include "SpeechEvent.h"
+#include "Subtitle.h"
 
 /* functions */
 sdword isoundstreamreadheader(STREAM *pstream);
@@ -41,7 +43,6 @@
 bool ssOldFormatVCE = FALSE;
 #endif
 
-extern LPDIRECTSOUND lpDirectSound;
 extern CHANNEL channels[];
 extern SENTENCELUT *SentenceLUT;
 extern bool soundinited;
@@ -81,10 +82,10 @@
 
 sdword streamStartThread(void)
 {
-	_beginthread(isoundstreamupdate, 0, NULL);
-			
 	streamer.status = SOUND_PLAYING;
 
+	SDL_CreateThread(isoundstreamupdate, NULL);
+			
 	return (SOUND_OK);
 }
 
@@ -173,6 +174,11 @@
 
 #if VCE_BACKWARDS_COMPATIBLE
     fileBlockRead(streamfile, &identifier, sizeof(identifier));//read in an identifier
+
+#ifdef ENDIAN_BIG
+    identifier = LittleLong( identifier );
+#endif
+
     if (identifier == ID_STREAM_DATA)
     {                                                       //if it's 'DATA'
         ssOldFormatVCE = TRUE;
@@ -183,6 +189,10 @@
 
 	fileBlockRead(streamfile, &checksum, sizeof(checksum));
 
+#ifdef ENDIAN_BIG
+    checksum = LittleLong( checksum );
+#endif
+
 	fileSeek(streamfile, 0, FS_Start);
 
 	return (checksum);
@@ -217,8 +227,11 @@
 			pstream->playing = FALSE;
 			memset(pstream->buffer, 0, pstream->buffersize);
 			
+#ifndef _MACOSX_FIX_ME			
 			fqAcModel(NULL, NULL, 0, pstream->delaybuffer1, DELAY_BUF_SIZE, &(pstream->delaypos1));
 			fqAcModel(NULL, NULL, 0, pstream->delaybuffer2, DELAY_BUF_SIZE, &(pstream->delaypos2));
+#endif
+
 			break;
 		}
 	}
@@ -575,7 +588,6 @@
 ----------------------------------------------------------------------------*/	
 sdword soundstreamvolume(sdword handle, sword vol, real32 fadetime)
 {
-    HRESULT hr = SOUND_ERR;
 	CHANNEL *pchan;
 	sdword channel;
 	bool stop = FALSE;
@@ -1030,12 +1042,14 @@
 ----------------------------------------------------------------------------*/	
 void isoundstreamupdate(void *dummy)
 {
+#ifndef _MACOSX_FIX_ME
+
 	sdword i;
 	STREAM *pstream;
 	CHANNEL *pchan;
 	sdword ret;
 	sdword readsize;
-	BYTE *bufferpos;
+	Uint8 *bufferpos;
 	sdword bufsize;
 	STREAMQUEUE *pqueue;
 	
@@ -1362,7 +1376,7 @@
 			}
 		}
 		
-		Sleep(SOUND_STREAM_SLEEP);
+		// Sleep(SOUND_STREAM_SLEEP);
 	}
 	
 	/* clean up all the streams */
@@ -1379,6 +1393,6 @@
 
 	streamer.status = SOUND_FREE;
 
-	_endthread();
+#endif // _MACOSX_FIX_ME
 }
 
diff -urPw homeworld-orig/src/SDL/sstream.c.wip homeworld_sdl-0.3/src/SDL/sstream.c.wip
--- homeworld-orig/src/SDL/sstream.c.wip	2004-08-02 23:14:13.944565144 -0700
+++ homeworld_sdl-0.3/src/SDL/sstream.c.wip	2004-08-01 22:35:09.000000000 -0700
@@ -6,23 +6,25 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
+#ifdef _WIN32
 #define WIN32_LEAN_AND_MEAN
 #include <windows.h>
-#include <string.h>
 #include <mmsystem.h>
 #include <dsound.h>
 #include <process.h>
+#endif
 
-#include "types.h"
-#include "switches.h"
-#include "debug.h"
+#include <string.h>
+#include "Types.h"
+#include "Switches.h"
+#include "Debug.h"
 #include "soundlow.h"
 #include "soundcmn.h"
-#include "file.h"
+#include "File.h"
 #include "fqeffect.h"
-#include "soundstructs.h"
-#include "speechevent.h"
-#include "subtitle.h"
+#include "SoundStructs.h"
+#include "SpeechEvent.h"
+#include "Subtitle.h"
 
 /* functions */
 sdword isoundstreamreadheader(STREAM *pstream);
@@ -41,7 +43,7 @@
 bool ssOldFormatVCE = FALSE;
 #endif
 
-extern LPDIRECTSOUND lpDirectSound;
+/*extern LPDIRECTSOUND lpDirectSound;*/
 extern CHANNEL channels[];
 extern SENTENCELUT *SentenceLUT;
 extern bool soundinited;
diff -urPw homeworld-orig/src/SDL/Subtitle.c homeworld_sdl-0.3/src/SDL/Subtitle.c
--- homeworld-orig/src/SDL/Subtitle.c	2002-09-04 12:47:06.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/Subtitle.c	2004-08-01 22:35:06.000000000 -0700
@@ -6,29 +6,26 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#define WIN32_LEAN_AND_MEAN
-#include <windows.h>
 #include <stdio.h>
 #include <string.h>
 #include "glinc.h"
-#include "debug.h"
-#include "memory.h"
+#include "Debug.h"
+#include "Memory.h"
 #include "font.h"
 #include "color.h"
-#include "statscript.h"
-#include "font.h"
-#include "fontReg.h"
+#include "StatScript.h"
+#include "FontReg.h"
 #include "main.h"
-#include "key.h"
-#include "universe.h"
-#include "teams.h"
+#include "Key.h"
+#include "Universe.h"
+#include "Teams.h"
 #include "mainrgn.h"
-#include "sensors.h"
-#include "nis.h"
+#include "Sensors.h"
+#include "NIS.h"
 #include "render.h"
-#include "fereg.h"
-#include "strings.h"
-#include "subtitle.h"
+#include "FEReg.h"
+#include "Strings.h"
+#include "Subtitle.h"
 
 /*=============================================================================
     Data:
@@ -63,7 +60,7 @@
 #endif //SUB_MODULE_TEST
 
 //semaphore for communicating between stream thread and main game thread
-HANDLE subSemaphore;
+SDL_sem* subSemaphore;
 
 //pointer to timer to use currently.  May be different depending on NIS's etc.
 real32 *subTimeElapsed = NULL;
@@ -576,7 +573,7 @@
 #if SUB_VERBOSE_LEVEL >= 1
     subMissedSubtitles = 0;
 #endif
-    subSemaphore = CreateSemaphore(NULL, 1, 1, SUB_SemaphoreName);
+    subSemaphore = SDL_CreateSemaphore(1);
     dbgAssert(subSemaphore != NULL);
 
     memset(&subRegion, 0, sizeof(subRegion));               //clear out the themes and printing regions
@@ -687,7 +684,7 @@
 #if SUB_VERBOSE_LEVEL >= 1
     dbgMessage("\nShutdown subtitle module");
 #endif
-    CloseHandle(subSemaphore);
+    SDL_DestroySemaphore(subSemaphore);
 
     //free any allocated memory
     for (index = 0; index < SUB_NumberRegions; index++)
@@ -1128,7 +1125,7 @@
         }
     }
 #endif //SUB_MODULE_TEST
-    WaitForSingleObject(subSemaphore, INFINITE);            //make sure nobody else is working with the subtitle transfer buffers
+    SDL_SemWait(subSemaphore);            //make sure nobody else is working with the subtitle transfer buffers
     if (subNumberNewSubtitles > 0)
     {
         //because subtitles are delivered as a series of phrases, we must "stitch"
@@ -1200,7 +1197,7 @@
         subMissedSubtitles = 0;
     }
 #endif
-    ReleaseSemaphore(subSemaphore, 1, NULL);
+    SDL_SemPost(subSemaphore);
 }
 
 /*-----------------------------------------------------------------------------
@@ -1225,7 +1222,7 @@
     dbgMessagef("\nSubtitle: actor %d says '%s'.", actor, text);
 #endif
 */
-    WaitForSingleObject(subSemaphore, INFINITE);            //make sure nobody else is working with the subtitle transfer buffers
+    SDL_SemWait(subSemaphore);            //make sure nobody else is working with the subtitle transfer buffers
     if (subNumberNewSubtitles < SUB_NumberNewSubtitles - 1)
     {
         dbgAssert(length < SUB_SubtitleLength);
@@ -1244,7 +1241,7 @@
         subMissedSubtitles++;
 #endif
     }
-    ReleaseSemaphore(subSemaphore, 1, NULL);
+    SDL_SemPost(subSemaphore);
     return(OKAY);
 }
 
Only in homeworld-orig/src/SDL: sw.mak
diff -urPw homeworld-orig/src/SDL/texreg.c homeworld_sdl-0.3/src/SDL/texreg.c
--- homeworld-orig/src/SDL/texreg.c	2002-09-04 12:47:06.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/texreg.c	2004-08-01 22:35:07.000000000 -0700
@@ -6,23 +6,21 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#ifndef SW_Render
-#include <windows.h>
-#endif
 #include "glinc.h"
 #include <stdio.h>
 #include <stdlib.h>
-#include "debug.h"
-#include "memory.h"
+#include <limits.h>
+#include "Debug.h"
+#include "Memory.h"
 #include "color.h"
-#include "twiddle.h"
+#include "Twiddle.h"
 #include "prim2d.h"
-#include "file.h"
-#include "key.h"
+#include "File.h"
+#include "Key.h"
 #include "texreg.h"
-#include "statscript.h"
-#include "strings.h"
-#include "colpick.h"
+#include "StatScript.h"
+#include "Strings.h"
+#include "ColPick.h"
 #include "render.h"
 
 #include "main.h"
@@ -30,7 +28,12 @@
 #include "HorseRace.h"
 
 #include "glcaps.h"
-#include "universe.h"
+#include "Universe.h"
+#include "gldll.h"
+
+#ifdef _MSC_VER
+#define strcasecmp _stricmp
+#endif
 
 /*=============================================================================
     Data:
@@ -54,7 +57,7 @@
 
 //actual registry:
 texreg *trTextureRegistry = NULL;
-crc32 *trNameCRCs;                              //separate list to reduce cache misses during searches.
+crc32 *trNameCRCs = NULL;                              //separate list to reduce cache misses during searches.
 sdword trLowestFree = 0;                        //indices of extremes free texture indices
 sdword trHighestAllocated = -1;
 
@@ -138,9 +141,13 @@
 ----------------------------------------------------------------------------*/
 sdword trLitPaletteBitDepth(void)
 {
-    sdword bits;
+    sdword bits = 0;
+
+#ifndef _MACOSX_FIX_ME
     dbgAssert(glLitColorTableEXT != NULL);
     glLitColorTableEXT(0, 0, 0, 0, 0, &bits);
+#endif
+
     return bits;
 }
 
@@ -207,6 +214,7 @@
 ----------------------------------------------------------------------------*/
 void trReload(void)
 {
+#ifndef _MACOSX_FIX_ME
     //glcaps module has already asserted that paletted texture extensions exist
     if (!trNoPalettes)
     {
@@ -222,8 +230,11 @@
     }
     else
     {
+#endif // _MACOSX_FIX_ME
         trLitPaletteBits = 0;
+#ifndef _MACOSX_FIX_ME
     }
+#endif
 
     if (RGL)
     {
@@ -274,6 +285,7 @@
 
     glHint(GL_PERSPECTIVE_CORRECTION_HINT, GL_FASTEST);
 
+#ifndef _MACOSX_FIX_ME
     //glcaps module has already asserted that paletted texture extensions exist
     if (!trNoPalettes)
     {
@@ -289,8 +301,11 @@
     }
     else
     {
+#endif // _MACOSX_FIX_ME
         trLitPaletteBits = 0;
+#ifndef _MACOSX_FIX_ME
     }
+#endif
 
     if (RGL)
     {
@@ -404,7 +419,8 @@
 {
     texreg *reg = trStructure(handle);
     trcolorinfo *oldColorInfos, *newColorInfos;
-    sdword index, colorIndex = trPaletteIndex(handle);
+    sdword index;
+
     udword *handles;
 
     dbgAssert(!trPending(trIndex(handle)));                 //make sure it has internal textures
@@ -750,7 +766,8 @@
     crc32 nameCRC, *regCRC;
     texreg *reg;
 
-    strupr(fileName);                                       //!!! is this going to screw anything up?
+    //strupr(fileName);                                       //!!! is this going to screw anything up?
+    /* Yes, yes it is... */
     length = strlen(fileName);
     dbgAssert(length > 0);
 
@@ -792,7 +809,8 @@
     crc32 nameCRC, *regCRC;
     texreg *reg;
 
-    strupr(fileName);                                       //!!! is this going to screw anything up?
+    //strupr(fileName);                                       //!!! is this going to screw anything up?
+    /* Yup... */
     length = strlen(fileName);
     dbgAssert(length > 0);
 
@@ -811,9 +829,9 @@
     }
 
     nameCRC = crc32Compute((ubyte*)fileName, length);               //compute a name for the CRC
-
     reg = &trTextureRegistry[trHighestAllocated];
     regCRC = &trNameCRCs[trHighestAllocated];
+
     for (index = trHighestAllocated; index >= 0 ; index--, reg--, regCRC--)
     {                                                       //for all registry entries
         if (*regCRC == nameCRC)
@@ -855,6 +873,7 @@
             }
         }
     }
+
     //if we get here, no matching texture was found; allocate a
     //registry structure and load in texture
     for (index = trLowestFree; index < trRegistrySize; index++)
@@ -878,6 +897,7 @@
                 bitSet(trTextureRegistry[index].flags, TRF_Alpha);
             }
             */
+
             trTextureRegistry[index].meshReference = meshReference;//texture's parent mesh
             trTextureRegistry[index].nUsageCount = 1;       //one usage of this texture
             trNameCRCs[index] = nameCRC;                    //save the name CRC
@@ -910,6 +930,7 @@
             return(trHandleMake(index, 0));
         }
     }
+
 #if TR_ERROR_CHECKING
     dbgFatalf(DBG_Loc, "\ntrTextureRegister: unable to allocate texture '%s' from list of %d entries", fileName, trRegistrySize);
 #endif //TR_ERROR_CHECKING
@@ -1671,6 +1692,20 @@
     lifheader *newHeader;
 
     fileLoadAlloc(fileName, (void**)&newHeader, flags);             //load in the .LiF file
+
+#ifdef ENDIAN_BIG
+	newHeader->version     = LittleLong( newHeader->version );
+	newHeader->flags       = LittleLong( newHeader->flags );
+	newHeader->width       = LittleLong( newHeader->width );
+	newHeader->height      = LittleLong( newHeader->height );
+	newHeader->paletteCRC  = LittleLong( newHeader->paletteCRC );
+	newHeader->imageCRC    = LittleLong( newHeader->imageCRC );
+	newHeader->data        = ( ubyte *)LittleLong( ( udword )newHeader->data );
+	newHeader->palette     = ( color *)LittleLong( ( udword )newHeader->palette );
+	newHeader->teamEffect0 = ( ubyte *)LittleLong( ( udword )newHeader->teamEffect0 );
+	newHeader->teamEffect1 = ( ubyte *)LittleLong( ( udword )newHeader->teamEffect1 );
+#endif
+
 #if TR_ERROR_CHECKING
     if (strcmp(newHeader->ident, LIF_FileIdentifier))
     {                                                       //verify proper file
@@ -1692,6 +1727,7 @@
     (ubyte *)newHeader->palette += (udword)newHeader;
     (ubyte *)newHeader->teamEffect0 += (udword)newHeader;
     (ubyte *)newHeader->teamEffect1 += (udword)newHeader;
+
     return(newHeader);
 }
 
@@ -1981,9 +2017,8 @@
     sdword index, count;
     sdword paletteIndex;
     texreg *reg, *otherReg;
-    sdword firstIndex = -1;
     trcolorinfo *colorInfo;
-    char fullName[_MAX_PATH];
+    char fullName[PATH_MAX];
     color *colorData;
     lifheader *lifFile;
     ubyte *scaledData;
@@ -1993,6 +2028,7 @@
     ShipRace race;
 
 #if TR_ERROR_CHECKING
+    sdword firstIndex = -1;
     sdword j;
     //make sure all pending textures have the same palette requirements.
     for (index = 0; index < sortList->nTextures; index++)
@@ -2086,9 +2122,15 @@
 //            reg = &trTextureRegistry[sortList->textureList[0]];
             baseScalar = colUdwordToReal(reg->baseScalar);
             stripeScalar = colUdwordToReal(reg->stripeScalar);
+#ifdef _WIN32
             if (strchr(reg->fileName, '\\') && (baseScalar != 0.0f || stripeScalar != 0.0f))
             {
                 count = strchr(reg->fileName, '\\') - (reg->fileName);
+#else
+            if (strpbrk(reg->fileName, "\\/") && (baseScalar != 0.0f || stripeScalar != 0.0f))
+            {
+                count = strpbrk(reg->fileName, "\\/") - (reg->fileName);
+#endif
                 dbgAssert(count > 0);
                 memStrncpy(fullName, reg->fileName, count + 1);
                 //fullName[count] = 0;
@@ -2594,8 +2636,8 @@
             bestScaleFactor = scaleFactor;
         }
         scaleOld = scaleFactor;
-        scaleFactor += (sdword)((__int64)margin * (__int64)65536 /
-                                (__int64)totalAvailable);
+        scaleFactor += (sdword)((sqword)margin * (sqword)65536 /
+                                (sqword)totalAvailable);
         if (scaleFactor <= 0)
         {
             scaleFactor = scaleOld / 2;
@@ -2739,6 +2781,14 @@
     f = fileOpen(name, 0);
     fileBlockRead(f, &header, sizeof(llfileheader));        //read the file header
 
+#ifdef ENDIAN_BIG
+	header.version       = LittleLong( header.version );
+	header.nElements     = LittleLong( header.nElements );
+	header.stringLength  = LittleLong( header.stringLength );
+	header.sharingLength = LittleLong( header.sharingLength );
+	header.totalLength   = LittleLong( header.totalLength );
+#endif
+
 #if TR_ERROR_CHECKING
     if (strcmp(header.ident, LL_FileIdentifier) != 0)
     {
@@ -2763,6 +2813,17 @@
     //fix up the names of the texture files
     for (index = 0; index < header.nElements; index++)
     {
+#ifdef ENDIAN_BIG
+		list[index].textureName = ( char *)LittleLong( ( udword )list[index].textureName );
+		list[index].width       = LittleLong( list[index].width );
+		list[index].height      = LittleLong( list[index].height );
+		list[index].flags       = LittleLong( list[index].flags );
+		list[index].imageCRC    = LittleLong( list[index].imageCRC );
+		list[index].nShared     = LittleLong( list[index].nShared );
+		list[index].sharedTo    = ( sdword *)LittleLong( ( udword )list[index].sharedTo );
+		list[index].sharedFrom  = LittleLong( list[index].sharedFrom );
+#endif
+
         list[index].textureName += (udword)stringBlock;
     }
     //fix up any sharing pointers there may be
@@ -2774,6 +2835,18 @@
             if (list[index].nShared != 0)
             {
                 (ubyte *)list[index].sharedTo += (udword)sharingBlock;
+
+#ifdef ENDIAN_BIG
+                // anonymous block so I can declare i with limited scope and not have
+                // a plain C compiler complain
+                {
+                    int  i = 0;
+                    for( i = 0; i < list[index].nShared; i++ )
+                    {
+                        list[index].sharedTo[i] = LittleLong( list[index].sharedTo[i] );
+                    }
+                }
+#endif
             }
         }
     }
@@ -2796,12 +2869,20 @@
 bool trImageMeasureFromListing(char *name, llelement *list, sdword listLength, sdword *width, sdword *height, udword *flags, char **sharedFrom)
 {
     sdword base = 0, index, length = listLength, result;
+    char ch, name_cpy[PATH_MAX];
+    unsigned int i;
+
+    /* I've successfully gone and crapped all over the file names by mixing in
+       forward slashes with backward slashes... */
+    for (i = 0; (ch = name[i]); i++)
+        name_cpy[i] = (ch == '/' ? '\\' : ch);
+    name_cpy[i] = '\0';
 
     while (length >= 1)
     {
         index = length / 2 + base;                          //get centre of section
         dbgAssert(index >= 0 && index < listLength);
-        result = _stricmp(name, list[index].textureName);
+        result = strcasecmp(name_cpy, list[index].textureName);
         if (result == 0)
         {                                                   //if exact match
             *width = list[index].width;
@@ -2883,6 +2964,19 @@
     fileBlockRead(handle, &header, sizeof(lifheader));
     fileClose(handle);
 
+#ifdef ENDIAN_BIG
+	header.version     = LittleLong( header.version );
+	header.flags       = LittleLong( header.flags );
+	header.width       = LittleLong( header.width );
+	header.height      = LittleLong( header.height );
+	header.paletteCRC  = LittleLong( header.paletteCRC );
+	header.imageCRC    = LittleLong( header.imageCRC );
+	header.data        = ( ubyte *)LittleLong( ( udword )header.data );
+	header.palette     = ( color *)LittleLong( ( udword )header.palette );
+	header.teamEffect0 = ( ubyte *)LittleLong( ( udword )header.teamEffect0 );
+	header.teamEffect1 = ( ubyte *)LittleLong( ( udword )header.teamEffect1 );
+#endif
+
     if (strcmp(header.ident, LIF_FileIdentifier))
     {                                                       //verify proper file
         return(FALSE);
@@ -2910,7 +3004,7 @@
 void trRegistryRefresh(void)
 {
     sdword index, width, height, scaleFactor, texes;
-    char fullName[_MAX_PATH];
+    char fullName[PATH_MAX];
     char *pSharedFrom;
     texreg *reg;
     llelement *lifListing;
@@ -3195,7 +3289,6 @@
 {
     ubyte *newPalette;
     texreg *reg;
-    static bool currentAlpha = FALSE;
 
 #if TR_NIL_TEXTURE
     if (GLOBAL_NO_TEXTURES)
@@ -4199,6 +4292,7 @@
 #if TR_TEXTURE_USAGE
 void trTextureUsageList(char *fileName)
 {
+    char *fileNameFull;
     FILE *fp;
     char directoryName[256], *pSlash;
     sdword index = 0;
@@ -4213,15 +4307,27 @@
     dbgAssert(trAllocated(index));
     strcpy(directoryName, trTextureRegistry[index].fileName);
     pSlash = directoryName;
+#ifdef _WIN32
     while ((pSlash = strchr(pSlash + 1, '\\')) != NULL)
     {
         if (!strchr(pSlash + 1, '\\'))
+#else
+    while ((pSlash = strpbrk(pSlash + 1, "\\/")) != NULL)
+    {
+        if (!strpbrk(pSlash + 1, "\\/"))
+#endif
         {
             *pSlash = 0;
             break;
         }
     }
-    fp = fopen(fileName, "wt");
+
+    fileNameFull = filePathPrepend(fileName, FF_UserSettingsPath);
+
+    if (!fileMakeDestinationDirectory(fileNameFull))
+        return;
+
+    fp = fopen(fileNameFull, "wt");
     if (fp == NULL)
     {
         return;
@@ -4238,9 +4344,15 @@
             fprintf(fp, "%12d %12d %s\n", directorySize, sharedDirectorySize, directoryName);
             strcpy(directoryName, reg->fileName);
             pSlash = directoryName;
+#ifdef _WIN32
             while ((pSlash = strchr(pSlash + 1, '\\')) != NULL)
             {
                 if (!strchr(pSlash + 1, '\\'))
+#else
+            while ((pSlash = strpbrk(pSlash + 1, "\\/")) != NULL)
+            {
+                if (!strpbrk(pSlash + 1, "\\/"))
+#endif
                 {
                     *pSlash = 0;
                     break;
diff -urPw homeworld-orig/src/SDL/texreg.h homeworld_sdl-0.3/src/SDL/texreg.h
--- homeworld-orig/src/SDL/texreg.h	2002-09-04 12:47:06.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/texreg.h	2004-08-01 22:35:08.000000000 -0700
@@ -9,9 +9,9 @@
 #ifndef ___TEXREG_H
 #define ___TEXREG_H
 
-#include "types.h"
+#include "Types.h"
 #include "color.h"
-#include "crc32.h"
+#include "CRC32.h"
 
 /*=============================================================================
     Switches:
diff -urPw homeworld-orig/src/SDL/TimeoutTimer.c homeworld_sdl-0.3/src/SDL/TimeoutTimer.c
--- homeworld-orig/src/SDL/TimeoutTimer.c	2002-09-04 12:47:06.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/TimeoutTimer.c	2004-08-01 22:35:06.000000000 -0700
@@ -6,15 +6,13 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-// unfortunately need this for the timers
-#define WIN32_LEAN_AND_MEAN
-#include <windows.h>
+#include "SDL.h"
 
-#include "types.h"
+#include "Types.h"
 #include "TimeoutTimer.h"
 #include "utility.h"
 
-extern LONGLONG utyTimerDivisor;
+extern Uint32 utyTimerDivisor;
 
 void TTimerInit(TTimer *timer)
 {
@@ -33,8 +31,8 @@
 
 bool TTimerUpdate(TTimer *timer)
 {
-    LARGE_INTEGER perftimer;
-    LONGLONG difference;
+    Uint32 timerval;
+    Uint32 difference;
     udword nTicks;
 
     if (!timer->enabled)
@@ -47,9 +45,9 @@
         return TRUE;
     }
 
-    QueryPerformanceCounter(&perftimer);
+    timerval = SDL_GetTicks();
 
-    difference = perftimer.QuadPart - timer->timerLast;
+    difference = timerval - timer->timerLast;
     nTicks = (udword)(difference / utyTimerDivisor);
 
     if (nTicks >= timer->timeoutTicks)
@@ -73,33 +71,33 @@
 
 void TTimerReset(TTimer *timer)
 {
-    LARGE_INTEGER perftimer;
+    Uint32 timerval;
 
     if (!timer->enabled)
     {
         return;
     }
 
-    QueryPerformanceCounter(&perftimer);
+    timerval = SDL_GetTicks();
 
     timer->timedOut = FALSE;
-    timer->timerLast = perftimer.QuadPart;
+    timer->timerLast = timerval;
 }
 
 void TTimerStart(TTimer *timer,real32 timeout)
 {
-    LARGE_INTEGER perftimer;
+    Uint32 timerval;
 
-    QueryPerformanceCounter(&perftimer);
+    timerval = SDL_GetTicks();
 
     timer->enabled = TRUE;
     timer->timedOut = FALSE;
-    timer->timerLast = perftimer.QuadPart;
+    timer->timerLast = timerval;
     timer->timeoutTicks = (udword) (timeout * UTY_TimerResloutionMax);
 }
 
 void GetRawTime(sqword *time)
 {
-    QueryPerformanceCounter((LARGE_INTEGER *)time);
+    *time = SDL_GetTicks();
 }
 
diff -urPw homeworld-orig/src/SDL/TimeoutTimer.h homeworld_sdl-0.3/src/SDL/TimeoutTimer.h
--- homeworld-orig/src/SDL/TimeoutTimer.h	2002-09-04 12:47:06.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/TimeoutTimer.h	2004-08-01 22:35:07.000000000 -0700
@@ -9,13 +9,13 @@
 #ifndef ___TIMEOUT_TIMER_H
 #define ___TIMEOUT_TIMER_H
 
-#include "types.h"
+#include "Types.h"
 
 typedef struct TTimer
 {
     bool enabled;
     bool timedOut;
-    __int64 timerLast;
+    sqword timerLast;
     udword timeoutTicks;
 } TTimer;
 
diff -urPw homeworld-orig/src/SDL/Titan.c homeworld_sdl-0.3/src/SDL/Titan.c
--- homeworld-orig/src/SDL/Titan.c	2002-09-04 12:47:06.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/Titan.c	2004-08-01 22:35:08.000000000 -0700
@@ -1,14 +1,24 @@
 
+#ifdef _WIN32
 #define WIN32_LEAN_AND_MEAN
 #include <windows.h>
+#else
+#include <sys/time.h>
+#endif
 
 #include <string.h>
 #include <stdio.h>
 #include <stdarg.h>
-#include "types.h"
-#include "file.h"
+#include <time.h>
+#include "Types.h"
+#include "File.h"
 #include "CommandWrap.h"
 
+#ifdef _MSC_VER
+#define snprintf _snprintf
+#define vsnprintf _vsnprintf
+#endif
+
 #define TITAN_LOG_FILE_NAME "titanlog.txt"
 
 //bool titanLogEnable = TRUE;
@@ -20,15 +30,26 @@
 #define DATA_SIZE 200 // space passed data is allowed to take up
 #define TIME_SIZE 9   // space required by time string at front of each line
         char buffer[DATA_SIZE + TIME_SIZE + 2]; // +1 for the carriage-return and null terminator
-        SYSTEMTIME systime;
         va_list argList;
         int aNumChars;
+#ifdef _WIN32
+        SYSTEMTIME systime;
 
         GetSystemTime(&systime);
-        _snprintf(buffer, TIME_SIZE, "%02d:%02d:%02d ", systime.wHour, systime.wMinute, systime.wSecond);
+        snprintf(buffer, TIME_SIZE, "%02d:%02d:%02d ", systime.wHour, systime.wMinute, systime.wSecond);
+#else
+        struct timeval tv;
+        long tv_hour, tv_minute, tv_second;
+
+        gettimeofday(&tv, 0);
+        tv_hour   = (tv.tv_sec % 86400) / 3600;
+        tv_minute = (tv.tv_sec %  3600) /   60;
+        tv_second = (tv.tv_sec %    60);
+        snprintf(buffer, TIME_SIZE, "%02ld:%02ld:%02ld ", tv_hour, tv_minute, tv_second);
+#endif
 
         va_start(argList, format);                            //get first arg
-        aNumChars = _vsnprintf(buffer + TIME_SIZE, DATA_SIZE, format, argList); //prepare output string
+        aNumChars = vsnprintf(buffer + TIME_SIZE, DATA_SIZE, format, argList); //prepare output string
         va_end(argList);
 
         if (aNumChars >= 0)
diff -urPw homeworld-orig/src/SDL/TitanInterfaceC.h homeworld_sdl-0.3/src/SDL/TitanInterfaceC.h
--- homeworld-orig/src/SDL/TitanInterfaceC.h	2002-09-04 12:47:06.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/TitanInterfaceC.h	2004-08-01 22:35:05.000000000 -0700
@@ -2,7 +2,11 @@
 #ifndef ___TITAN_INTERFACEC_H
 #define ___TITAN_INTERFACEC_H
 
+#ifdef _MACOSX
+    #include <stdlib.h>
+#else
 #include <wchar.h>
+#endif // _MACOSX
 
 // Homeworld Message Types
 #define TITANMSGTYPE_JOINGAMEREQUEST   0x10
@@ -287,10 +291,10 @@
 int titanStartChatServer(wchar_t *password);
 
 void titanSendPing(Address *address,unsigned int pingsizebytes);
-void titanSendPointMessage(int playerIndex,unsigned char *packet,unsigned long sizeofPacket);
-void titanSendBroadcastMessage(unsigned char *packet,unsigned long sizeofPacket);
-void titanAnyoneSendPointMessage(int playerIndex,unsigned char *packet,unsigned long sizeofPacket);
-void titanAnyoneSendBroadcastMessage(unsigned char *packet,unsigned long sizeofPacket);
+void titanSendPointMessage(int playerIndex,unsigned char *packet,unsigned int sizeofPacket);
+void titanSendBroadcastMessage(unsigned char *packet,unsigned int sizeofPacket);
+void titanAnyoneSendPointMessage(int playerIndex,unsigned char *packet,unsigned int sizeofPacket);
+void titanAnyoneSendBroadcastMessage(unsigned char *packet,unsigned int sizeofPacket);
 void titanPumpEngine();
 
 void titanSetGameKey(unsigned char *key);
@@ -361,7 +365,7 @@
 void chatReceiveUserJoinReply(short status, unsigned long userID);
 void chatReceiveUsersHere(const char *name, unsigned long userID);
 void chatReceiveUsersJoined(const char *name, unsigned long userID);
-void chatReceiveMessage(unsigned long originUserID, signed long whisper,unsigned long type, unsigned long size, const void* chatData);
+void chatReceiveMessage(unsigned long originUserID, int whisper,unsigned long type, unsigned long size, const void* chatData);
 void chatReceiveUserLeft(unsigned long userID);
 
 int authReceiveReply(short status);
diff -urPw homeworld-orig/src/SDL/TitanInterface.cpp homeworld_sdl-0.3/src/SDL/TitanInterface.cpp
--- homeworld-orig/src/SDL/TitanInterface.cpp	2002-09-04 12:47:06.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/TitanInterface.cpp	2004-08-01 22:35:08.000000000 -0700
@@ -1,11 +1,15 @@
 // TitanInterface
 
+#ifdef _WIN32
 #include <process.h>
+#include <winsock.h>
+#include <crtdbg.h>
+#endif
+
 #include <sys/stat.h>
 #include "common/won.h"
 #include "common/DataObject.h"
-#include <winsock.h>
-#include "common/ThreadBase.h"
+#include "common/Threadbase.h"
 #include "common/WONException.h"
 #include "db/dbconstants.h"
 #include "msg/TMessage.h"
@@ -62,7 +66,6 @@
 #include "TitanInterface.h"
 #include "ClientCDKey.h"
 #include "wassert.h"
-#include <crtdbg.h>
 
 #define DEBUG_DISCONNECT    0
 #define CLOCK_COMMANDS_THRU_ENGINE
diff -urPw homeworld-orig/src/SDL/TitanInterfaceC.stub.c homeworld_sdl-0.3/src/SDL/TitanInterfaceC.stub.c
--- homeworld-orig/src/SDL/TitanInterfaceC.stub.c	1969-12-31 16:00:00.000000000 -0800
+++ homeworld_sdl-0.3/src/SDL/TitanInterfaceC.stub.c	2004-08-01 22:35:06.000000000 -0700
@@ -0,0 +1,187 @@
+/*============================================================================
+ * TitanInterfaceC.stub.c
+ * Dummy functions to simulate a WONnet connection that never works.
+ *
+ * Author:  Ted Cipicchio <ted@thereisnospork.com>
+ * Created: Sat Oct 4 2003
+ *==========================================================================*/
+#include "TitanInterfaceC.h"
+
+/*----------------------------------------------------------------------------
+ * Global Variables
+ *--------------------------------------------------------------------------*/
+
+wchar_t ChannelPassword[MAX_PASSWORD_LEN];
+TPChannelList tpChannelList;
+TPServerList tpServerList;
+CaptainGameInfo tpGameCreated;
+Address myAddress;
+unsigned long DIRSERVER_PORTS[MAX_PORTS];
+unsigned long PATCHSERVER_PORTS[MAX_PORTS];
+ipString DIRSERVER_IPSTRINGS[MAX_IPS];
+ipString PATCHSERVER_IPSTRINGS[MAX_IPS];
+unsigned long HomeworldCRC[4];
+wchar_t GameWereInterestedIn[MAX_TITAN_GAME_NAME_LEN];
+void *GameWereInterestedInMutex = 0;
+
+
+/*----------------------------------------------------------------------------
+ * Functions
+ *--------------------------------------------------------------------------*/
+
+void titanGotNumUsersInRoomCB(const wchar_t *theRoomName, int theNumUsers)
+{ }
+
+
+unsigned long titanStart(unsigned long isLan, unsigned long isIP)
+{ return 0; }
+
+
+unsigned long titanCheckCanNetwork(unsigned long isLan, unsigned long isIP)
+{ return 0; }
+
+
+// --MikeN
+// Call this method to begin shutdown of titan.  Parameters specify packet to send
+// to connected client(s) (a shutdown message).  The callback titanNoClientsCB() will
+// be invoked when complete.
+void titanStartShutdown(unsigned long titanMsgType, const void* thePacket,
+                        unsigned short theLen)
+{
+	/* Probably won't ever be called, but we'll be consistent anyway... */
+	titanNoClientsCB();
+}
+
+
+void titanLeaveGameNotify(void)
+{ }
+
+
+void titanShutdown(void)
+{ }
+
+
+void titanRefreshRequest(char* theDir)
+{ }
+
+
+unsigned long titanReadyToStartGame(unsigned char *routingaddress)
+{ return 0; }
+
+
+unsigned long titanBehindFirewall(void)
+{ return 0; }
+
+
+void titanCreateGame(wchar_t *str, DirectoryCustomInfo* myInfo)
+{ }
+
+
+void titanRemoveGame(wchar_t *str)
+{ }
+
+
+void titanCreateDirectory(char *str, char* desc)
+{ }
+
+
+void titanSendLanBroadcast(const void* thePacket, unsigned short theLen)
+{ }
+
+
+void titanSendPacketTo(Address *address, unsigned char titanMsgType,
+                       const void* thePacket, unsigned short theLen)
+{ }
+
+
+void titanBroadcastPacket(unsigned char titanMsgType, const void* thePacket, unsigned short theLen)
+{ }
+
+
+void titanAnyoneSendPacketTo(Address *address, unsigned char titanMsgType,
+                       const void* thePacket, unsigned short theLen)
+{ }
+
+
+void titanAnyoneBroadcastPacket(unsigned char titanMsgType, const void* thePacket, unsigned short theLen)
+{ }
+
+
+void titanConnectToClient(Address *address)
+{ }
+
+
+int titanStartChatServer(wchar_t *password)
+{ return 0; }
+
+
+void titanSendPing(Address *address,unsigned int pingsizebytes)
+{ }
+
+
+void titanPumpEngine()
+{ }
+
+
+void titanSetGameKey(unsigned char *key)
+{ }
+
+
+const unsigned char *titanGetGameKey(void)
+{ return 0; }
+
+
+Address titanGetMyPingAddress(void)
+{ return myAddress; }
+
+
+int titanGetPatch(char *filename,char *saveFileName)
+{
+	titanGetPatchFailedCB(PATCHFAIL_UNABLE_TO_CONNECT);
+	return PATCHFAIL_UNABLE_TO_CONNECT;
+}
+
+
+void titanReplaceGameInfo(wchar_t *str, DirectoryCustomInfo* myInfo, unsigned long replaceTimeout)
+{ }
+
+
+void chatConnect(wchar_t *password)
+{ }
+
+
+void chatClose(void)
+{ }
+
+
+void BroadcastChatMessage(unsigned short size, const void* chatData)
+{ }
+
+
+void SendPrivateChatMessage(unsigned long* userIDList, unsigned short numUsersInList,
+                            unsigned short size, const void* chatData)
+{ }
+
+
+void authAuthenticate(char *loginName, char *password)
+{ }
+
+
+void authCreateUser(char *loginName, char *password)
+{ }
+
+
+void authChangePassword(char *loginName, char *oldpassword, char *newpassword)
+{ }
+
+
+int titanSaveWonstuff()
+{ return 0; }
+
+
+void titanWaitShutdown(void)
+{ }
+
+
+void titanConnectingCancelHit(void)
+{ }
diff -urPw homeworld-orig/src/SDL/TitanPacketMsg.cpp homeworld_sdl-0.3/src/SDL/TitanPacketMsg.cpp
--- homeworld-orig/src/SDL/TitanPacketMsg.cpp	2002-09-04 12:47:06.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/TitanPacketMsg.cpp	2004-08-01 22:35:06.000000000 -0700
@@ -1,8 +1,8 @@
-#include "common/won.h"
+#include "common/WON.h"
 #include "msg/TMessage.h"
 #include "msg/BadMsgException.h"
-#include "TitanPacketMsg.h"
-#include "TitanInterfaceC.h"
+#include "titanpacketmsg.h"
+#include "titaninterfacec.h"
 
 using WONMsg::MiniMessage;
 
diff -urPw homeworld-orig/src/SDL/TitanPacketMsg.h homeworld_sdl-0.3/src/SDL/TitanPacketMsg.h
--- homeworld-orig/src/SDL/TitanPacketMsg.h	2002-09-04 12:47:06.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/TitanPacketMsg.h	2004-08-01 22:35:06.000000000 -0700
@@ -2,7 +2,7 @@
 #define _TitanPacketMsg_H
 
 
-#include "STRING"
+#include <string>
 #include "msg/TMessage.h"
 #include "msg/MServiceTypes.h"
 
diff -urPw homeworld-orig/src/SDL/trails.c homeworld_sdl-0.3/src/SDL/trails.c
--- homeworld-orig/src/SDL/trails.c	2002-09-04 12:47:06.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/trails.c	2004-08-01 22:35:07.000000000 -0700
@@ -20,29 +20,29 @@
 #include <math.h>
 #include <float.h>
 #include "glinc.h"
-#include "types.h"
-#include "debug.h"
-#include "memory.h"
+#include "Types.h"
+#include "Debug.h"
+#include "Memory.h"
 #include "prim3d.h"
 #include "render.h"
-#include "statscript.h"
-#include "spaceobj.h"
-#include "universe.h"
-#include "teams.h"
+#include "StatScript.h"
+#include "SpaceObj.h"
+#include "Universe.h"
+#include "Teams.h"
 #include "trails.h"
 #include "main.h"
 
-#include "fastmath.h"
-#include "particle.h"
-#include "randy.h"
-#include "camera.h"
-
-#include "clouds.h"
-#include "select.h"
-#include "tactics.h"
+#include "FastMath.h"
+#include "Particle.h"
+#include "Randy.h"
+#include "Camera.h"
+
+#include "Clouds.h"
+#include "Select.h"
+#include "Tactics.h"
 
 #include "glcaps.h"
-#include "shader.h"
+#include "Shader.h"
 #include "devstats.h"
 
 extern udword gDevcaps2;
@@ -789,8 +789,6 @@
     ShipStaticInfo* shipstaticinfo = (ShipStaticInfo*)ship->staticinfo;
     real32 maxvel, mag, velratio;
     vector vel, pos;
-    real32 w = 20.0f;
-    real32 h = 60.0f;
     hmatrix coordMatrixForGL;
     real32 scaleFactor;
     real32 scale[3];
@@ -1931,7 +1929,7 @@
     Ship* ship = (Ship*)trail->vship;
 
     NLipsScaleFactor = ship->magnitudeSquared;
-    if (_isnan((double)NLipsScaleFactor))
+    if (isnan((double)NLipsScaleFactor))
     {
         NLipsScaleFactor = 1.0f;
     }
@@ -2123,7 +2121,7 @@
             //NaN checking (error correction)
             for (i = 0; i < n; i++)
             {
-                if (_isnan((double)segments[i].x))
+                if (isnan((double)segments[i].x))
                 {
                     n = (i == 0) ? 0 : i - 1;
                     break;
diff -urPw homeworld-orig/src/SDL/trails.h homeworld_sdl-0.3/src/SDL/trails.h
--- homeworld-orig/src/SDL/trails.h	2002-09-04 12:47:06.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/trails.h	2004-08-01 22:35:08.000000000 -0700
@@ -9,10 +9,10 @@
 #ifndef ___TRAIL_H
 #define ___TRAIL_H
 
-#include "types.h"
+#include "Types.h"
 #include "color.h"
-#include "vector.h"
-#include "globals.h"
+#include "Vector.h"
+#include "Globals.h"
 
 /*=============================================================================
     Switches:
diff -urPw homeworld-orig/src/SDL/utility.c homeworld_sdl-0.3/src/SDL/utility.c
--- homeworld-orig/src/SDL/utility.c	2002-09-04 12:47:06.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/utility.c	2004-08-01 22:35:09.000000000 -0700
@@ -4,18 +4,43 @@
     Created June 1997 by Luke Moloney
 =============================================================================*/
 
+#include "SDL.h"
+#include "SDL_syswm.h"
+
+#include <stdlib.h>
+#include <stdio.h>
+
+#ifdef _WIN32
 #define WIN32_LEAN_AND_MEAN
 #include <windows.h>
 #include <winreg.h>
-#include <stdlib.h>
-#include <stdio.h>
-#include <string.h>
 #include <shellapi.h>
+#elif defined(_MACOSX)
+    #include <sys/types.h>
+    #include <sys/mman.h>
+    #include <unistd.h>
+#else
+    #include <sys/mman.h>
+    #include <unistd.h>
+    #include <X11/Xlib.h>
+    #include <X11/keysym.h>
+#endif
+
+#include <string.h>
+#include <strings.h>
+#include <ctype.h>
+#include <sys/stat.h>
+#include <limits.h>
 #include "glinc.h"
-#include "liloptions.h"
-#include "autodownloadmap.h"
+#include "LilOptions.h"
+#include "AutoDownloadMap.h"
 #include "regkey.h"
 
+
+#ifdef _MSC_VER
+#define strcasecmp _stricmp
+#endif
+
 extern char mainDeviceToSelect[];
 extern char mainGLToSelect[];
 extern char mainD3DToSelect[];
@@ -23,7 +48,7 @@
 #define REG_UDWORD 0
 #define REG_STRING 1
 
-// #define HW_NOTOVERSIZE   1                   // comment to enable oversize-CD code
+#define HW_NOTOVERSIZE   1                   // comment to enable oversize-CD code
 #define REG_MAGIC_STR "D657E436967616D4"    // used for oversize-CD code
 
 udword regMagicNum = 0; // used right below
@@ -32,7 +57,7 @@
 typedef struct registryOption
 {
     char*  name;
-    DWORD  type;
+    udword  type;
     void*  data;
 } registryOption;
 
@@ -60,78 +85,134 @@
 
 int utyEnsureRegistry(void)
 {
-    HKEY key;
-    DWORD disp;
-
-    if (RegOpenKeyEx(HKEY_LOCAL_MACHINE, BASEKEYNAME, 0, KEY_ALL_ACCESS, &key) == ERROR_SUCCESS)
+    char ch_buf[512];
+    char* home_dir;
+    struct stat file_stat;
+    FILE* fp;
+
+    /* Get the user's home directory. */
+    home_dir = getenv("HOME");
+    if (!home_dir)
     {
-        //already there
-        return 1;
+        fprintf(stderr, "Unable to find home directory in which to store options.\n");
+        return 0;
     }
 
-    if (RegCreateKeyEx(HKEY_LOCAL_MACHINE, BASEKEYNAME, 0,
-                       "", REG_OPTION_NON_VOLATILE,
-                       KEY_ALL_ACCESS, NULL,
-                       &key, &disp) == ERROR_SUCCESS)
+    /* Build configuration directory string. */
+    strcpy(ch_buf, home_dir);
+    strcat(ch_buf, "/" CONFIGDIR);
+
+    /* Check for configuration directory. */
+    if (stat(ch_buf, &file_stat))
     {
-        //successfully created
-        RegCloseKey(key);
-        return 1;
+        /* Create configuration directory. */
+        if (mkdir(ch_buf, S_IRUSR | S_IWUSR | S_IXUSR))
+        {
+            fprintf(stderr, "Unable to create configuration directory \"%s\".\n", ch_buf);
+            return 0;
+        }
+    }
+    else
+    {
+        /* Is the configuration directory a directory? */
+        if (!S_ISDIR(file_stat.st_mode))
+        {
+            fprintf(stderr, "Unable to use \"%s\" for configuration (not a directory).\n", ch_buf);
+            return 0;
+        }
     }
 
-    //couldn't create
+    /* Check for/create configuration file. */
+    strcat(ch_buf, "/reg");
+    fp = fopen(ch_buf, "a");
+    if (!fp)
+    {
+        fprintf(stderr, "Unable to create/open settings file \"%s\".\n", ch_buf);
     return 0;
 }
+    fclose(fp);
+
+    /* Everything seems okay. */
+    return 1;
+}
 
 void utyRegistryOptionsRead(void)
 {
-    registryOption* reg;
-    HKEY key;
-    DWORD type, length;
-    BYTE data[128];
-    DWORD* pdword;
+    char ch_buf[512];
+    char* home_dir;
+    FILE* fp;
+    unsigned int str_len;
+    char* curr_tok;
+    char* next_tok;
+    registryOption* curr_reg;
 
+    /* Check for settings file. */
     if (!utyEnsureRegistry())
-    {
         return;
-    }
 
-    reg = regOptionsList;
-    while (reg->name != NULL)
+    /* Open settings. */
+    home_dir = getenv("HOME");
+    sprintf(ch_buf, "%s/" CONFIGDIR "/reg", home_dir);
+    fp = fopen(ch_buf, "r");
+    if (!fp)
+        return;
+
+    while (fgets(ch_buf, 512, fp))
+    {
+        str_len = strlen(ch_buf);
+        if (ch_buf[str_len - 1] == '\n')
+            ch_buf[str_len - 1] = '\0';
+
+        /* Ignore initial whitespace. */
+        curr_tok = ch_buf;
+        while (*curr_tok && isspace(*curr_tok))
+            curr_tok++;
+        if (*curr_tok == '\0')
+            continue;
+
+        /* Check the setting. */
+        curr_tok = strtok(curr_tok, " \t");
+        next_tok = strtok(0, " \t");
+        curr_reg = regOptionsList;
+        while (curr_reg->name)
     {
-        if (RegOpenKeyEx(HKEY_LOCAL_MACHINE, BASEKEYNAME,
-                         0, KEY_ALL_ACCESS, &key) != ERROR_SUCCESS)
+            if (strcmp(curr_reg->name, curr_tok))
         {
-            reg++;
+                curr_reg++;
             continue;
         }
 
-        length = 128;
-        if (RegQueryValueEx(key, reg->name, 0, &type, data, &length) == ERROR_SUCCESS)
-        {
-            switch (type)
+            /* Read the setting. */
+            switch (curr_reg->type)
             {
-            case REG_DWORD_LITTLE_ENDIAN:
-                pdword = (DWORD*)reg->data;
-                *pdword = *((DWORD*)data);
+                case REG_UDWORD:
+                    if (next_tok)
+                        sscanf( next_tok, "%u", (udword*)curr_reg->data );
+                    else
+                        *(udword*)curr_reg->data = 0;
                 break;
 
-            case REG_SZ:
-                memcpy((BYTE*)reg->data, data, length);
+                case REG_STRING:
+                    if (next_tok)
+                        strcpy((char*)curr_reg->data, next_tok);
+                    else
+                        *((char*)curr_reg->data) = '\0';
                 break;
             }
-        }
 
-        RegCloseKey(key);
-
-        reg++;
+            break;
     }
 }
 
+    fclose(fp);
+}
+
 void utyRegistryOptionsWrite(void)
 {
-    registryOption* reg;
-    HKEY key;
+    char ch_buf[512];
+    char* home_dir;
+    FILE* fp;
+    registryOption* curr_reg;
 
     if (!utyEnsureRegistry())
     {
@@ -141,33 +222,27 @@
     loadedDevcaps  = gDevcaps;
     loadedDevcaps2 = gDevcaps2;
 
-    reg = regOptionsList;
-    while (reg->name != NULL)
+    home_dir = getenv("HOME");
+    sprintf(ch_buf, "%s/" CONFIGDIR "/reg", home_dir);
+    fp = fopen(ch_buf, "w");
+    curr_reg = regOptionsList;
+    while (curr_reg->name != NULL)
     {
-        if (RegOpenKeyEx(HKEY_LOCAL_MACHINE, BASEKEYNAME,
-                         0, KEY_SET_VALUE, &key) != ERROR_SUCCESS)
-        {
-            reg++;
-            continue;
-        }
-
-        switch (reg->type)
+        switch (curr_reg->type)
         {
         case REG_UDWORD:
-            (void)RegSetValueEx(key, reg->name, 0, REG_DWORD_LITTLE_ENDIAN,
-                                reg->data, sizeof(udword));
+                fprintf(fp, "%s %u\n", curr_reg->name, *(udword*)curr_reg->data);
             break;
 
-        case REG_SZ:
-            (void)RegSetValueEx(key, reg->name, 0, REG_SZ,
-                                reg->data, strlen((char*)reg->data)+1);
+            case REG_STRING:
+                fprintf(fp, "%s %s\n", curr_reg->name, (char*)curr_reg->data);
             break;
         }
 
-        RegCloseKey(key);
-
-        reg++;
+        curr_reg++;
     }
+
+    fclose(fp);
 }
 
 /*-----------------------------------------------------------------------------
@@ -179,6 +254,7 @@
 ----------------------------------------------------------------------------*/
 bool utyBrowserExec(char *URL)
 {
+#if 0
     HKEY key;
     char shellCommand[BIT8];
     //char options[BIT8] = "";
@@ -232,105 +308,108 @@
 
     RegCloseKey(key);
     return(TRUE);
+#else
+    return FALSE;
+#endif
 }
 
-#include "types.h"
+#include "Types.h"
 #include "resource.h"
-#include "key.h"
+#include "Key.h"
 #include "debugwnd.h"
-#include "debug.h"
-#include "memory.h"
+#include "Debug.h"
+#include "Memory.h"
 #pragma warning( 4 : 4142 )     //turn off "benign redefinition of type" warning
 #include "main.h"
 #pragma warning( 2 : 4142 )
-#include "universe.h"
-#include "task.h"
+#include "Universe.h"
+#include "Task.h"
 #include "render.h"
-#include "file.h"
-#include "region.h"
+#include "File.h"
+#include "Region.h"
 #include "mouse.h"
 #include "mainrgn.h"
-#include "select.h"
+#include "Select.h"
 #include "prim2d.h"
-#include "uicontrols.h"
-#include "FeFlow.h"
-#include "Font.h"
+#include "UIControls.h"
+#include "FEFlow.h"
+#include "font.h"
 #include "FontReg.h"
-#include "statscript.h"
-#include "stats.h"
+#include "StatScript.h"
+#include "Stats.h"
 #include "ConsMgr.h"
-#include "soundevent.h"
-#include "globals.h"
-#include "commandnetwork.h"
-#include "netcheck.h"
-#include "undo.h"
-#include "tactical.h"
+#include "SoundEvent.h"
+#include "Globals.h"
+#include "CommandNetwork.h"
+#include "NetCheck.h"
+#include "Undo.h"
+#include "Tactical.h"
 #include "trails.h"
 #include "light.h"
 #include "texreg.h"
 #include "TaskBar.h"
-#include "sensors.h"
-#include "levelload.h"
-#include "colpick.h"
-#include "teams.h"
+#include "Sensors.h"
+#include "LevelLoad.h"
+#include "ColPick.h"
+#include "Teams.h"
 #include "ScenPick.h"
-#include "randy.h"
-#include "etg.h"
+#include "Randy.h"
+#include "ETG.h"
 #include "NIS.h"
-#include "spaceobj.h"
+#include "SpaceObj.h"
 #include "utility.h"
-#include "univupdate.h"
-#include "clouds.h"
-#include "fastmath.h"
-#include "singleplayer.h"
-#include "FeReg.h"
-#include "nebulae.h"
-#include "aiplayer.h"
+#include "UnivUpdate.h"
+#include "Clouds.h"
+#include "FastMath.h"
+#include "SinglePlayer.h"
+#include "FEReg.h"
+#include "Nebulae.h"
+#include "AIPlayer.h"
 #include "TitanInterfaceC.h"
-#include "btg.h"
-#include "gun.h"
-#include "strings.h"
+#include "BTG.h"
+#include "Gun.h"
+#include "Strings.h"
 #include "prim3d.h"
-#include "launchMgr.h"
-#include "demo.h"
-#include "pieplate.h"
-#include "researchapi.h"
-#include "tactics.h"
+#include "LaunchMgr.h"
+#include "Demo.h"
+#include "PiePlate.h"
+#include "ResearchAPI.h"
+#include "Tactics.h"
 #include "InfoOverlay.h"
-#include "horserace.h"
+#include "HorseRace.h"
 #include "MultiplayerGame.h"
 #include "MultiplayerLANGame.h"
-#include "titannet.h"
+#include "TitanNet.h"
 #include "glcaps.h"
-#include "gamepick.h"
-#include "gamechat.h"
-#include "shipview.h"
-#include "damage.h"
+#include "GamePick.h"
+#include "GameChat.h"
+#include "ShipView.h"
+#include "Damage.h"
 #include "SaveGame.h"
 #include "GamePick.h"
 #include "BigFile.h"
-#include "tutor.h"
-#include "autolod.h"
-#include "ping.h"
-#include "battle.h"
-#include "shader.h"
-#include "transformer.h"
+#include "Tutor.h"
+#include "AutoLOD.h"
+#include "Ping.h"
+#include "Battle.h"
+#include "Shader.h"
+#include "Transformer.h"
 #include "Captaincy.h"
-#include "options.h"
-#include "linklimits.h"
-#include "particle.h"
-#include "trademgr.h"
-#include "bink.h"
-#include "bounties.h"
-#include "subtitle.h"
-#include "animatic.h"
+#include "Options.h"
+#include "LinkLimits.h"
+#include "Particle.h"
+#include "TradeMgr.h"
+/*#include "bink.h"*/
+#include "Bounties.h"
+#include "Subtitle.h"
+#include "Animatic.h"
 #include "dxdraw.h"
 #include "sstglide.h"
 #include "PlugScreen.h"
-#include "hs.h"
+#include "HS.h"
 #include "glcompat.h"
 #include "KeyBindings.h"
-#include "ResearchGui.h"
+#include "ResearchGUI.h"
 
 //
 //  for bigfiles
@@ -349,8 +428,6 @@
 
 bool utilPlayingIntro = FALSE;
 
-unsigned long HomeworldCRC[4] = { 0,0,0,0 };    // dont use udword, this goes in TitanInterfaceC.h
-
 static char* dataEnvironment = NULL;
 
 void *utyMemoryHeap;
@@ -360,9 +437,8 @@
 bool needtutorial=TRUE;
 
 //data for the timing of tasks
-LARGE_INTEGER utyTimerFrequency;
-LONGLONG utyTimerDivisor;
-LONGLONG utyTimerLast;
+Uint32 utyTimerDivisor;
+Uint32 utyTimerLast;
 
 //flag stating system has started properly
 sdword utySystemStarted = FALSE;
@@ -1063,6 +1139,10 @@
 #define UTY_SectionName         "Options"
 void utyOptionsFileRead(void)
 {
+#ifndef _WIN32
+    char* home_dir;
+    char ch_buf[PATH_MAX];
+#endif
     /*
     sdword index;
     char returnString[UTY_StringLength];
@@ -1084,8 +1164,21 @@
         strcpy((char *)utyStringOptionsList[index].flag,returnString);
     }
     */
-
+#ifdef _WIN32
     scriptSetFileSystem("", DIS_FileName, utyOptionsList);
+#else
+    home_dir = getenv("HOME");
+    if (home_dir)
+    {
+        strcpy(ch_buf, home_dir);
+        strcat(ch_buf, "/" CONFIGDIR "/");
+    }
+    else
+    {
+        ch_buf[0] = '\0';
+    }
+    scriptSetFileSystem(ch_buf, DIS_FileName, utyOptionsList);
+#endif
 
     //call any functions that need to acknowledge a change due to loading
     cameraSensitivitySet(opMouseSens);
@@ -1103,6 +1196,10 @@
 ----------------------------------------------------------------------------*/
 void utyOptionsFileWrite(void)
 {
+#ifndef _WIN32
+    char* home_dir;
+    char ch_buf[128];
+#endif
     sdword index;
     FILE *f;
 /*
@@ -1122,7 +1219,21 @@
                                 returnString, UTY_FileName);
     }
 */
+#ifdef _WIN32
     f = fopen(DIS_FileName, "wt");
+#else
+    home_dir = getenv("HOME");
+    if (home_dir)
+    {
+        strcpy(ch_buf, home_dir);
+        strcat(ch_buf, "/" CONFIGDIR "/" DIS_FileName);
+    }
+    else
+    {
+        strcpy(ch_buf, DIS_FileName);
+    }
+    f = fopen(ch_buf, "wt");
+#endif
     if (f == NULL)
     {
         goto REGISTRY;
@@ -1135,7 +1246,7 @@
         }
         else
         {
-            fprintf(f, "%s    %s\n", utyOptionsList[index].name, utyOptionsList[index].dataPtr);
+            fprintf(f, "%s    %s\n", utyOptionsList[index].name, (char*)utyOptionsList[index].dataPtr);
         }
     }
     fclose(f);
@@ -1646,8 +1757,14 @@
 ----------------------------------------------------------------------------*/
 udword utyCloseOK(regionhandle region, sdword ID, udword event, udword data)
 {
-    PostMessage(ghMainWindow, WM_COMMAND, CID_ExitOK, 0);   //exit the game
-    return(0);
+    SDL_Event e;
+    e.user.type = SDL_USEREVENT;                            //exit the game
+    e.user.code = CID_ExitOK;
+    e.user.data1 = 0;
+    e.user.data2 = 0;
+    SDL_PushEvent(&e);
+
+    return 0;
 }
 
 /*-----------------------------------------------------------------------------
@@ -1660,19 +1777,22 @@
 ----------------------------------------------------------------------------*/
 void utyFatalErrorWaitLoop(int exitCode)
 {
-    MSG   msg;
+    SDL_Event e;
 
-    OutputDebugString(dbgFatalErrorString);                 //print error string to the debugger
+    //OutputDebugString(dbgFatalErrorString);                 //print error string to the debugger
 
-    while (PeekMessage(&msg, ghMainWindow, 0, 0, PM_REMOVE))//remove all messages from Queue
-        ;
-    SendMessage(ghMainWindow, WM_COMMAND, CID_ExitError, 0);//tell app to exit
+    while (SDL_PollEvent(&e)) { }                           //remove all messages from Queue
+
+    e.user.type = SDL_USEREVENT;                            //tell app to exit
+    e.user.code = CID_ExitError;
+    e.user.data1 = 0;
+    e.user.data2 = 0;
+    SDL_PushEvent(&e);
+
+    fprintf(stderr, "%s\n", dbgFatalErrorString);
+    //e.quit.type = SDL_QUIT;
+    //SDL_PushMessage(&e);                                    //???
 
-    while (PeekMessage(&msg, ghMainWindow, 0, 0, PM_REMOVE))//remove all messages from Queue
-    {
-        TranslateMessage(&msg);
-        DispatchMessage(&msg);
-    }
     exit(exitCode);
 }
 
@@ -1685,12 +1805,16 @@
 ----------------------------------------------------------------------------*/
 sdword utyNonFatalErrorWaitLoop(void)
 {
-    int returnValue;
+    //int returnValue;
 
-    OutputDebugString(dbgFatalErrorString);                 //print error string to the debugger
-    returnValue = MessageBox(ghMainWindow, dbgFatalErrorString, "Non-Fatal Error (cancel to debug)", MB_ICONSTOP | MB_OKCANCEL);
+    //OutputDebugString(dbgFatalErrorString);                 //print error string to the debugger
+    fprintf(stderr, "%s\n", dbgFatalErrorString);
 
-    return(returnValue == IDCANCEL);
+#ifdef HW_Debug
+    return TRUE;
+#else
+    return FALSE;
+#endif
 }
 
 /*-----------------------------------------------------------------------------
@@ -1706,10 +1830,10 @@
 
 void gameStart(char *loadfilename)
 {
-    char *useScenarioFile;
-    Player *player;
+    char *useScenarioFile = 0;
+    Player *player = NULL;
     uword i;
-    udword numCompPlayers = 0;
+    //udword numCompPlayers = 0;
 
 #if MAIN_Password && MAIN_CDCheck
     if (mainCDCheckEnabled)
@@ -2241,7 +2365,7 @@
         {
             titanPumpEngine();
         }
-        Sleep(100);     // Give titan some time to handle this
+        SDL_Delay(100);     // Give titan some time to handle this
 
         if (TitanActive)
         {
@@ -2475,7 +2599,8 @@
 void utyPreDemoStateSaveCB(ubyte **buffer, sdword *length)
 {
     ubyte *stateBuffer, *newPointer;
-    sdword bufferLength = BUFFER_GRANULARITY, bufferPos, index, newSize, newType;
+    sdword bufferLength = BUFFER_GRANULARITY, bufferPos, index, newType;
+    sdword newSize = 0;
 
     stateBuffer = memAlloc(BUFFER_GRANULARITY, "PreDemoState", Pyrophoric);
 
@@ -2535,7 +2660,7 @@
 ----------------------------------------------------------------------------*/
 void utyPreDemoStateLoad(ubyte *stateBuffer, sdword stateSize)
 {
-    sdword index, statePos, type, sizeToRead;
+    sdword index, statePos, type, sizeToRead = 0;
     ubyte *readTo;
 
     for (index = statePos = 0; utyDemoStateTable[index].data != NULL && statePos < stateSize; index++)
@@ -3015,7 +3140,7 @@
 {
     cpResetRegions();
 
-    if (_stricmp(name, "Tutorial1") == 0)
+    if (strcasecmp(name, "Tutorial1") == 0)
     {
         forceSP = TRUE;
     }
@@ -3588,7 +3713,7 @@
     HomeworldCRC[1] = 0;
     HomeworldCRC[2] = 0;
     HomeworldCRC[3] = 0;
-    sscanf(field,"%x %x %x %x",&HomeworldCRC[0],&HomeworldCRC[1],&HomeworldCRC[2],&HomeworldCRC[3]);
+    sscanf(field,"%x %x %x %x",(int)&HomeworldCRC[0],(int)&HomeworldCRC[1],(int)&HomeworldCRC[2],(int)&HomeworldCRC[3]);
     onlygetfirstcrc = TRUE;
 }
 
@@ -3636,13 +3761,20 @@
 
 /*-----------------------------------------------------------------------------
     Name        : utyGetFirstCDPath
-    Description : Gets path to first CD-ROM drive containing the HW CD ("D:\", say)
+    Description : Gets path to first CD-ROM drive containing the HW CD ("D:\",
+                  say)
+                  On Unix-based platforms, this will use the value in the
+                  HW_CDROM environment variable.  If the value does not specify
+                  a valid directory, or HW_CDROM is not defined, "/mnt/cdrom"
+                  will be used.
     Inputs      : N/A
-    Outputs     : szPath (path to first CD-ROM drive continaning the HW CD - 4 chars)
+    Outputs     : szPath - Path to first CD-ROM drive continaning the HW CD (at
+                  least 128 chars)
     Return      : N/A
 ----------------------------------------------------------------------------*/
 void utyGetFirstCDPath(char *szPath)
 {
+#ifdef _WIN32
     char nLetter,szFile[255];
 
     HANDLE handle;
@@ -3680,6 +3812,37 @@
     /* No CD-ROM available */
     strcpy(szPath,"");
     return;
+#else
+    char* env_path;
+    struct stat dir_stat;
+
+    /* Check for CD path environment variable. */
+    env_path = getenv("HW_CDROM");
+    if (env_path)
+    {
+        strncpy(szPath, env_path, 126);
+        szPath[126] = '\0';
+        unsigned int str_len = strlen(szPath);
+        if (szPath[str_len - 1] != '/');
+            strcat(szPath, "/");
+
+        /* Does it exist? */
+        if (!stat(szPath, &dir_stat) && S_ISDIR(dir_stat.st_mode))
+            return;
+    }
+
+    /* Default to "/mnt/cdrom". */
+    if (stat("/mnt/cdrom/", &dir_stat) || !S_ISDIR(dir_stat.st_mode))
+    {
+        /* Guess not... */
+        szPath[0] = '\0';
+        return;
+    }
+
+    /* Path seems okay. */
+    strcpy(szPath, "/mnt/cdrom/");
+    return;
+#endif
 }
 
 /*-----------------------------------------------------------------------------
@@ -3721,7 +3884,11 @@
 void *utyGrowthHeapAlloc(sdword size)
 {
     dbgAssert(size > 0);
+#ifdef _WIN32
     return((void *)VirtualAlloc(NULL, size, MEM_COMMIT, PAGE_READWRITE));
+#else
+    return mmap(0, size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANON, -1, 0);
+#endif
 }
 
 /*-----------------------------------------------------------------------------
@@ -3733,9 +3900,15 @@
 ----------------------------------------------------------------------------*/
 void utyGrowthHeapFree(void *heap)
 {
+#ifdef _WIN32
     BOOL result;
     result = VirtualFree(heap, 0, MEM_RELEASE);
     dbgAssert(result);
+#else
+    int result;
+    result = munmap(heap, 0);
+    dbgAssert(result != -1);
+#endif
 }
 
 char *utyMissingCDMessages[] =
@@ -3821,7 +3994,7 @@
     // Attempt to set the CD-ROM path
     if(CDROMPathPrepended == FALSE)
     {
-        char drivePath[4];
+        char drivePath[PATH_MAX];
 
         // Find the first CD-ROM drive containing the HW CD
         utyGetFirstCDPath(drivePath);
@@ -3844,6 +4017,40 @@
 */
     }
 
+	// Attempt to set the user settings path.
+	if (UserSettingsPathPrepended == FALSE)
+	{
+#ifdef _WIN32
+		// Use the same directory as the Homeworld data (similar to the
+		// functionality in the original Homeworld).
+		if ((dataEnvironment = getenv("HW_Data")) != NULL)
+		{
+			fileUserSettingsPathSet(dataEnvironment);
+		}
+		else
+		{
+			fileUserSettingsPathSet("");
+		}
+#else
+		// Attempt to use ~/.homeworld if we can get the user's home
+		// directory, else use the Homeworld data directory.
+		if ((dataEnvironment = getenv("HOME")) != NULL)
+		{
+			char tempPath[PATH_MAX];
+			snprintf(tempPath, PATH_MAX, "%s/.homeworld", dataEnvironment);
+			fileUserSettingsPathSet(tempPath);
+		}
+		else if ((dataEnvironment = getenv("HW_Data")) != NULL)
+		{
+			fileUserSettingsPathSet(dataEnvironment);
+		}
+		else
+		{
+			fileUserSettingsPathSet("");
+		}
+#endif
+	}
+
 
 #if MAIN_Password && MAIN_CDCheck
     if (mainCDCheckEnabled)
@@ -3933,6 +4140,7 @@
 #endif
 #endif
 #endif
+
     // check data dir on HD...
     if (!fileExists(utyMusicFilename, 0))
     {
@@ -3956,17 +4164,33 @@
     //start up the memory manager
     if (MemoryHeapSize == MEM_HeapSizeDefault)
     {                                                       //if the user has not specified a heap size
-        sdword newSize;
+        sdword newSize = 0;
+#ifdef _WIN32
         MEMORYSTATUS memStat;
         GlobalMemoryStatus(&memStat);
-
         newSize = (sdword)((real32)memStat.dwTotalPhys * MEM_HeapDefaultScalar);
+#elif defined(_MACOSX)
+		int phys_pages = 32768;
+		int page_size = getpagesize();
+		newSize = (sdword)((real32)phys_pages * (real32)page_size
+            * MEM_HeapDefaultScalar);
+#else
+        long phys_pages = sysconf(_SC_PHYS_PAGES);
+        long page_size = sysconf (_SC_PAGE_SIZE);
+        newSize = (sdword)((real32)phys_pages * (real32)page_size
+            * MEM_HeapDefaultScalar);
+#endif
         if (newSize > MEM_HeapSizeDefault)
         {
             MemoryHeapSize = min(newSize, MEM_HeapDefaultMax);
         }
     }
+#ifdef _WIN32
     utyMemoryHeap = (void *)VirtualAlloc(NULL, MemoryHeapSize + sizeof(memcookie) * 4, MEM_COMMIT, PAGE_READWRITE);
+#else
+    utyMemoryHeap = mmap(0, MemoryHeapSize + sizeof(memcookie) * 4,
+        PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANON, -1, 0);
+#endif
     if (utyMemoryHeap == NULL)
     {
         sprintf(errorString, "Error allocating heap of size %d", MemoryHeapSize);
@@ -4012,6 +4236,7 @@
         }
         if (CompareBigfiles)
         {
+			dataEnvironment = getenv("HW_Data");
             if (!dataEnvironment || !dataEnvironment[0])
                 // in absence of environment vars (like in a retail install), assume
                 // data file structure will start alongside the EXE
@@ -4033,7 +4258,7 @@
         HomeworldCRC[0] = utyCodeCRCCompute();
         if (!IgnoreBigfiles)
         {
-            bigCRC(&HomeworldCRC[1],&HomeworldCRC[2]);
+            bigCRC((udword*)&HomeworldCRC[1],(udword*)&HomeworldCRC[2]);
         }
         else
         {
@@ -4075,6 +4300,7 @@
 char *utyGameSystemsInit(void)
 {
     rndinitdata renderData;
+    Uint32 sdl_flags;
 
     utyToggleKeyStatesSave();
     utySet2(SS2_ToggleKeys);
@@ -4092,21 +4318,21 @@
 
     dbgMessagef("\nHomeworld CRC = 0x%x 0x%x 0x%x 0x%x", HomeworldCRC[0],HomeworldCRC[1],HomeworldCRC[2],HomeworldCRC[3]);
     //startup timer
-    if (QueryPerformanceFrequency(&utyTimerFrequency) != TRUE)
-    {                                                       //get performance timer speed
-        return("Unable to query system performance timer.");
+    sdl_flags = SDL_WasInit(SDL_INIT_EVERYTHING);
+    if (!sdl_flags)
+    {
+        if (SDL_Init(SDL_INIT_TIMER) == -1)
+            return("Unable to initialize SDL timer.");
     }
-
-        if (utyTimerFrequency.QuadPart < UTY_TimerResloutionMax)
-    {                                                       //make sure it runs fast enough
-        sprintf(errorString, "System performance timer runs at %d Hz.  We need at least %d Hz.",
-                utyTimerFrequency, UTY_TimerResloutionMax);
-        return(errorString);
+    else if (!(sdl_flags & SDL_INIT_TIMER))
+    {
+        if (SDL_InitSubSystem(SDL_INIT_TIMER) == -1)
+            return("Unable to initialize SDL timer.");
     }
-    utyTimerDivisor = utyTimerFrequency.QuadPart / UTY_TimerResloutionMax;
+    utyTimerDivisor = 1000 / UTY_TimerResloutionMax;
     utySet(SSA_Timer);
                                                             //start the task manager
-    taskStartup((udword)(utyTimerFrequency.QuadPart / utyTimerDivisor));
+    taskStartup((udword)(1000 / utyTimerDivisor));
     utySet(SSA_Task);
 
 #if MEM_STATISTICS
@@ -4131,48 +4357,50 @@
     utySet2(SS2_SoundEngine);
 
 #if (!defined(Downloadable) || defined(DLPublicBeta))
+    /* Intro playing requires a window, which we have not made yet thanks to
+       how the code's been butchered. */
+#if 0
     if (enableAVI)
     {
-        MSG msg;
-        BOOL gotMsg;
+        SDL_Event e;
+        bool gotMsg;
         sdword intro;
 
         utilPlayingIntro = TRUE;
 
         for (intro = 0;;)
         {
-            Sleep(0);
+            SDL_Delay(0);
             if (systemActive)
             {
-                gotMsg = PeekMessage(&msg, NULL, 0, 0, PM_REMOVE);
+                gotMsg = SDL_PollEvent(&e);
             }
             else
             {
-                gotMsg = GetMessage(&msg, NULL, 0, 0);
+                gotMsg = SDL_WaitEvent(&e);
             }
             if (gotMsg)
             {
-                TranslateMessage(&msg);
-                DispatchMessage(&msg);
+                HandleEvent(&e);
             }
             else
             {
                 switch (intro)
                 {
                 case 0:
-                    binkInit(-1);
+                    /*binkInit(-1);*/
                     intro++;
                     break;
                 case 1:
-                    binkPlay("Movies\\sierra.bik", NULL, NULL, S_RGB555, TRUE, ANIM00_Sierra);
+                    /*binkPlay("Movies\\sierra.bik", NULL, NULL, S_RGB555, TRUE, ANIM00_Sierra);*/
                     intro++;
                     break;
                 case 2:
-                    binkPlay("Movies\\relicintro.bik", NULL, NULL, S_RGB555, TRUE, ANIM00_Relic);
+                    /*binkPlay("Movies\\relicintro.bik", NULL, NULL, S_RGB555, TRUE, ANIM00_Relic);*/
                     intro++;
                     break;
                 case 3:
-                    binkCleanup();
+                    /*binkCleanup();*/
                     mainCleanupAfterVideo();
                     intro++;
                     break;
@@ -4182,16 +4410,21 @@
             }
         }
     }
+#endif
 #else
     //show the opening plugscreens later
 #endif
 
+#ifndef _MACOSX_FIX_ME
 DONE_INTROS:
+#endif
+
     utilPlayingIntro = FALSE;
 
     renderData.width = MAIN_WindowWidth;                    //setup data for
     renderData.height = MAIN_WindowHeight;                  //initializing the
-    renderData.hWnd = ghMainWindow;                         //rendering system
+    /*renderData.hWnd = ghMainWindow;*/                         //rendering system
+    renderData.hWnd = 0;                                    //rendering system
     if (rndInit(&renderData) != OKAY)                       //startup the rendering system
     {
         //fallback to 640x480@16 rGL+sw, and fatally exit if that doesn't work either
@@ -4377,7 +4610,10 @@
 
     opUpdateSettings();
 
+#ifndef _MACOSX_FIX_ME
     soundEventPlayMusic(SOUND_FRONTEND_TRACK);
+#endif
+
 //    if (!nisEnabled)
 //    {
         feScreenStart(ghMainRegion, "Main_game_screen");
@@ -4444,7 +4680,6 @@
 ----------------------------------------------------------------------------*/
 char* utyGameSystemsPreShutdown(void)
 {
-    BOOL result;
     if (utyTest(SSA_FontReg))
     {
         frShutdown();
@@ -4465,8 +4700,13 @@
     }
     if (utyTest(SSA_MemoryHeap))
     {
-        result = VirtualFree(utyMemoryHeap, 0, MEM_RELEASE);
+#ifdef _WIN32
+        bool result = VirtualFree(utyMemoryHeap, 0, MEM_RELEASE);
         dbgAssert(result);
+#else
+        int result = munmap(utyMemoryHeap, 0);
+        dbgAssert(result != -1);
+#endif
         utyClear(SSA_MemoryHeap);
     }
 
@@ -4474,7 +4714,9 @@
     {
         if (utyTest(SSA_DebugWindow))
         {
-            dbwClose();
+            /* Debug window disabled...search for other dbw*() functions if
+               reenabling. */
+            /*dbwClose();*/
             utyClear(SSA_DebugWindow);
         }
     }
@@ -4501,7 +4743,9 @@
     {
         if (utyTest(SSA_DebugWindow))
         {
-            dbwWriteOptions();
+            /* Debug window disabled...search for other dbw*() functions if
+               reenabling. */
+            /*dbwWriteOptions();*/
         }
     }
 
@@ -4732,7 +4976,7 @@
     {
         if (!RGL)
         {
-            hwDeleteWindow();
+            /*hwDeleteWindow();*/
         }
         rndClose();
         //the GL has now SHUTDOWN
@@ -4807,10 +5051,15 @@
     }
     if (utyTest(SSA_MemoryHeap))
     {
+#ifdef _WIN32
         bool result;
-
         result = VirtualFree(utyMemoryHeap, 0, MEM_RELEASE);
         dbgAssert(result);
+#else
+        int result;
+        result = munmap(utyMemoryHeap, 0);
+        dbgAssert(result != -1);
+#endif
         utyClear(SSA_MemoryHeap);
     }
 
@@ -4819,7 +5068,9 @@
     {
         if (utyTest(SSA_DebugWindow))
         {
-            dbwClose();
+            /* Debug window disabled...search for other dbw*() functions if
+               reenabling. */
+            /*dbwClose();*/
             utyClear(SSA_DebugWindow);
         }
     }
@@ -4845,15 +5096,15 @@
 ----------------------------------------------------------------------------*/
 void utyTasksDispatch(void)
 {
-    LARGE_INTEGER timer;
-    LONGLONG difference, remainder;
+    Uint32 timer;
+    Uint32 difference, remainder;
 
-    QueryPerformanceCounter(&timer);                        //get counter, let's assume it works
-    difference = timer.QuadPart - utyTimerLast;             //get difference of this frame to last frame
+    timer = SDL_GetTicks();                                 //get counter, let's assume it works
+    difference = timer - utyTimerLast;                      //get difference of this frame to last frame
     utyNFrameTicks = (udword)(difference / utyTimerDivisor);
     remainder = difference % utyTimerDivisor;               //get remainder of the division
     taskExecuteAllPending(utyNFrameTicks);                  //execute tasks for the correct number of ticks
-    utyTimerLast = timer.QuadPart - remainder;              //save timer for differencing next frame
+    utyTimerLast = timer - remainder;                       //save timer for differencing next frame
 }
 
 /*-----------------------------------------------------------------------------
@@ -4866,10 +5117,8 @@
 ----------------------------------------------------------------------------*/
 void utyTaskTimerClear(void)
 {
-    LARGE_INTEGER timer;
-
-    QueryPerformanceCounter(&timer);                        //get counter, let's assume it works
-    utyTimerLast = timer.QuadPart;                          //save timer for differencing next frame
+    Uint32 timer = SDL_GetTicks();                          //get counter, let's assume it works
+    utyTimerLast = timer;                                   //save timer for differencing next frame
 
 }
 
@@ -4884,6 +5133,7 @@
 ----------------------------------------------------------------------------*/
 void utyClientRectGet(rectangle *rect)
 {
+#if 0
     RECT clientRect;
     POINT point;
     GetClientRect(ghMainWindow, &clientRect);               //get location of window
@@ -4901,6 +5151,23 @@
     */
     rect->x1 = rect->x0 + MAIN_WindowWidth - 1;
     rect->y1 = rect->y0 + MAIN_WindowHeight - 1;
+#endif
+    SDL_Surface* pSurface;
+
+    /* Don't know screen coordinates with SDL... */
+    rect->x0 = 0;
+    rect->y0 = 0;
+    pSurface = SDL_GetVideoSurface();
+    if (pSurface)
+    {
+        rect->x1 = pSurface->w - 1;
+        rect->y1 = pSurface->h - 1;
+    }
+    else
+    {
+        rect->x1 = 0;
+        rect->y1 = 0;
+    }
 }
 
 /*-----------------------------------------------------------------------------
@@ -4912,8 +5179,10 @@
 ----------------------------------------------------------------------------*/
 void utyForceTopmost(bool bTopMost)
 {
+#if 0
     SetWindowPos(ghMainWindow, bTopMost ? HWND_TOPMOST : HWND_NOTOPMOST,
         0, 0, 0, 0, SWP_NOMOVE | SWP_NOSIZE | SWP_NOSENDCHANGING);
+#endif
 }
 
 /*-----------------------------------------------------------------------------
@@ -4926,19 +5195,8 @@
 #if MAIN_MOUSE_FREE
 void utyClipMouse(sdword clip)
 {
-    RECT rect;
-    rectangle *clientRect;
-
-    if ((!mouseClipped) && (clip))
-    {
-        clientRect = (rectangle *)(&rect);
-        utyClientRectGet(clientRect);
-        ClipCursor(&rect);
-    }
-    if ((mouseClipped) && (!clip))
-    {
-        ClipCursor(NULL);
-    }
+    SDL_ShowCursor(clip ? SDL_DISABLE : SDL_ENABLE);
+    //SDL_WM_GrabInput(clip ? SDL_GRAB_ON : SDL_GRAB_OFF);
     mouseClipped = clip;
 }
 #endif
@@ -4952,30 +5210,33 @@
 ----------------------------------------------------------------------------*/
 void utyMouseButtonsClear(void)
 {
+    Uint8 mouse_state;
+
     mousePoll();
-    if (GetKeyState(VK_LBUTTON) & BIT15)
+    mouse_state = SDL_GetMouseState(0, 0);
+    if (mouse_state & SDL_BUTTON_LMASK)
     {
-        keyPressDown(KeyMapFromWindows(VK_LBUTTON));
+        keyPressDown(LMOUSE_BUTTON);
     }
     else
     {
-        keyPressUp(KeyMapFromWindows(VK_LBUTTON));
+        keyPressUp(LMOUSE_BUTTON);
     }
-    if (GetKeyState(VK_RBUTTON) & BIT15)
+    if (mouse_state & SDL_BUTTON_RMASK)
     {
-        keyPressDown(KeyMapFromWindows(VK_RBUTTON));
+        keyPressDown(RMOUSE_BUTTON);
     }
     else
     {
-        keyPressUp(KeyMapFromWindows(VK_RBUTTON));
+        keyPressUp(RMOUSE_BUTTON);
     }
-    if (GetKeyState(VK_MBUTTON) & BIT15)
+    if (mouse_state & SDL_BUTTON_MMASK)
     {
-        keyPressDown(KeyMapFromWindows(VK_MBUTTON));
+        keyPressDown(MMOUSE_BUTTON);
     }
     else
     {
-        keyPressUp(KeyMapFromWindows(VK_MBUTTON));
+        keyPressUp(MMOUSE_BUTTON);
     }
 }
 
@@ -4988,7 +5249,11 @@
 ----------------------------------------------------------------------------*/
 real32 utyCaretBlinkRate(void)
 {
+#ifdef _WIN32
     return((real32)GetCaretBlinkTime() / 500.0f);
+#else
+    return 0.25f;  /* Works for me... */
+#endif
 }
 
 /*-----------------------------------------------------------------------------
@@ -5005,9 +5270,9 @@
         //this is needed because the second button click is
         //not registered as a WM_LBUTTONDOWN click.  Only call this
         //function if mouseLDoubleClick didn't do any special processing
-        keyPressDown(KeyMapFromWindows(VK_LBUTTON));
+        keyPressDown(LMOUSE_BUTTON);
     }
-    keyPressUp(KeyMapFromWindows(VK_LBUTTON));
+    keyPressUp(LMOUSE_BUTTON);
 }
 
 /*-----------------------------------------------------------------------------
@@ -5019,7 +5284,29 @@
 ----------------------------------------------------------------------------*/
 udword utyCodeCRCCompute(void)
 {
-    return((udword)crc32Compute((ubyte *)linkStartCode, (udword)linkEndCode - (udword)linkStartCode));
+    /* linkStartCode() might not come before linkEndCode() (didn't link that
+       way on my system), so we'll check which is greater first.
+       I could just remove this entirely, since I'm pretty sure it's only
+       needed for WONnet, but I'll keep it for now...
+       I could also rearrange their order in the Makefile, but I'm just a lazy
+       bastard... */
+    size_t start, count;
+    if (linkStartCode < linkEndCode)
+    {
+        start = (size_t)linkStartCode;
+        count = (size_t)linkEndCode - start;
+    }
+    else
+    {
+        start = (size_t)linkEndCode;
+        count = (size_t)linkStartCode - start;
+    }
+
+#ifdef _MACOSX_FIX_ME
+	return((udword)crc32Compute( (ubyte*)start, 2));
+#else
+    return((udword)crc32Compute(start, count));
+#endif
 }
 
 /*-----------------------------------------------------------------------------
@@ -5074,12 +5361,10 @@
 static sdword utyScrollLockState;
 void utyToggleKeyStatesSave(void)
 {
-    ubyte state[256];
-
-    GetKeyboardState(state);
-    utyCapsLockState = state[VK_CAPITAL] & 1;
-    utyNumLockState = state[VK_NUMLOCK] & 1;
-    utyScrollLockState = state[VK_SCROLL] & 1;
+    Uint8* state = SDL_GetKeyState(0);
+    utyCapsLockState = state[SDLK_CAPSLOCK] & 1;
+    utyNumLockState = state[SDLK_NUMLOCK] & 1;
+    utyScrollLockState = state[SDLK_SCROLLOCK] & 1;
 }
 
 /*-----------------------------------------------------------------------------
@@ -5093,37 +5378,99 @@
 ----------------------------------------------------------------------------*/
 void utyToggleKeyStatesRestore(void)
 {
-    ubyte state[256];
-
-    GetKeyboardState(state);
-    if((utyCapsLockState && !(state[VK_NUMLOCK] & 1)) || (!utyCapsLockState && (state[VK_CAPITAL] & 1)) )
+    Uint8* state;
+#if !defined(_WIN32) && !defined(_MACOSX)
+    SDL_SysWMinfo info;
+    SDL_VERSION(&info.version);
+    SDL_GetWMInfo(&info);
+    XEvent xe;
+    xe.xkey.display = info.info.x11.display;
+    xe.xkey.window = info.info.x11.window;
+    xe.xkey.root = RootWindow(info.info.x11.display,
+        DefaultScreen(info.info.x11.display));
+    xe.xkey.subwindow = None;
+    xe.xkey.time = CurrentTime;
+    xe.xkey.x = 1;
+    xe.xkey.y = 1;
+    xe.xkey.x_root = 1;
+    xe.xkey.y_root = 1;
+    xe.xkey.state = 0;
+    xe.xkey.same_screen = TRUE;
+#endif
+    state = SDL_GetKeyState(0);
+    if((utyCapsLockState && !(state[SDLK_NUMLOCK] & 1)) || (!utyCapsLockState && (state[SDLK_CAPSLOCK] & 1)) )
     {
+#ifdef _WIN32
         // Simulate a key press
         keybd_event( VK_CAPITAL, 0x45, KEYEVENTF_EXTENDEDKEY | 0, 0 );
 
         // Simulate a key release
         keybd_event( VK_CAPITAL, 0x45, KEYEVENTF_EXTENDEDKEY | KEYEVENTF_KEYUP, 0);
+#elif !defined(_MACOSX)
+        xe.xkey.keycode = XKeysymToKeycode(info.info.x11.display, XK_Caps_Lock);
+
+        // Simulate a key press
+        xe.xkey.type = KeyPress;
+        XSendEvent(info.info.x11.display, info.info.x11.window, TRUE,
+            KeyPressMask, &xe);
+
+        // Simulate a key release
+        xe.xkey.type = KeyRelease;
+        XSendEvent(info.info.x11.display, info.info.x11.window, TRUE,
+            KeyPressMask, &xe);
+#endif
     }
-    if((utyScrollLockState && !(state[VK_NUMLOCK] & 1)) || (!utyScrollLockState && (state[VK_SCROLL] & 1)) )
+    if((utyScrollLockState && !(state[SDLK_NUMLOCK] & 1)) || (!utyScrollLockState && (state[SDLK_SCROLLOCK] & 1)) )
     {
+#ifdef _WIN32
         // Simulate a key press
         keybd_event( VK_SCROLL, 0x45, KEYEVENTF_EXTENDEDKEY | 0, 0 );
 
         // Simulate a key release
         keybd_event( VK_SCROLL, 0x45, KEYEVENTF_EXTENDEDKEY | KEYEVENTF_KEYUP, 0);
+#elif !defined(_MACOSX)
+        xe.xkey.keycode = XKeysymToKeycode(info.info.x11.display, XK_Scroll_Lock);
+
+        // Simulate a key press
+        xe.xkey.type = KeyPress;
+        XSendEvent(info.info.x11.display, info.info.x11.window, TRUE,
+            KeyPressMask, &xe);
+
+        // Simulate a key release
+        xe.xkey.type = KeyRelease;
+        XSendEvent(info.info.x11.display, info.info.x11.window, TRUE,
+            KeyPressMask, &xe);
+#endif
     }
-    if((utyNumLockState && !(state[VK_NUMLOCK] & 1)) || (!utyNumLockState && (state[VK_NUMLOCK] & 1)) )
+    if((utyNumLockState && !(state[SDLK_NUMLOCK] & 1)) || (!utyNumLockState && (state[SDLK_NUMLOCK] & 1)) )
     {
+#ifdef _WIN32
         // Simulate a key press
         keybd_event( VK_NUMLOCK, 0x45, KEYEVENTF_EXTENDEDKEY | 0, 0 );
 
         // Simulate a key release
         keybd_event( VK_NUMLOCK, 0x45, KEYEVENTF_EXTENDEDKEY | KEYEVENTF_KEYUP, 0);
+#elif !defined(_MACOSX)
+        xe.xkey.keycode = XKeysymToKeycode(info.info.x11.display, XK_Num_Lock);
+
+        // Simulate a key press
+        xe.xkey.type = KeyPress;
+        XSendEvent(info.info.x11.display, info.info.x11.window, TRUE,
+            KeyPressMask, &xe);
+
+        // Simulate a key release
+        xe.xkey.type = KeyRelease;
+        XSendEvent(info.info.x11.display, info.info.x11.window, TRUE,
+            KeyPressMask, &xe);
+#endif
     }
-    state[VK_CAPITAL]  = (state[VK_CAPITAL] & 0xfe) | (utyCapsLockState);
-    state[VK_NUMLOCK]  = (state[VK_NUMLOCK] & 0xfe) | (utyNumLockState);
-    state[VK_SCROLL]  = (state[VK_SCROLL] & 0xfe) | (utyScrollLockState);
-    SetKeyboardState(state);
+    /* Modifying internal keystate array.  Original HW source code did this
+       using the Windows API SetKeyboardState() function, so hopefully we get
+       the same result here ("state" already points to the internal array used
+       by SDL). */
+    state[SDLK_CAPSLOCK]  = (state[SDLK_CAPSLOCK]  & 0xfe) | (utyCapsLockState);
+    state[SDLK_NUMLOCK]   = (state[SDLK_NUMLOCK]   & 0xfe) | (utyNumLockState);
+    state[SDLK_SCROLLOCK] = (state[SDLK_SCROLLOCK] & 0xfe) | (utyScrollLockState);
 }
 
 /*-----------------------------------------------------------------------------
@@ -5135,7 +5482,8 @@
 ----------------------------------------------------------------------------*/
 bool utyCapsLockToggleState(void)
 {
-    return(GetKeyState(VK_CAPITAL) & 1);
+    Uint8* state = SDL_GetKeyState(0);
+    return(state[SDLK_CAPSLOCK] & 1);
 }
 
 void utyStartDroppedDialog(sdword playernum)
diff -urPw homeworld-orig/src/SDL/utility.h homeworld_sdl-0.3/src/SDL/utility.h
--- homeworld-orig/src/SDL/utility.h	2002-09-04 12:47:06.000000000 -0700
+++ homeworld_sdl-0.3/src/SDL/utility.h	2004-08-01 22:35:09.000000000 -0700
@@ -8,11 +8,11 @@
 #ifndef ___UITILITY_H
 #define ___UITILITY_H
 
-#include "types.h"
+#include "Types.h"
 #include "prim2d.h"
-#include "region.h"
-#include "feflow.h"
-#include "objtypes.h"
+#include "Region.h"
+#include "FEFlow.h"
+#include "ObjTypes.h"
 #include "TitanInterfaceC.h"
 
 /*=============================================================================
@@ -122,9 +122,9 @@
 //flag stating system has started properly
 extern sdword utySystemStarted;
 extern regionhandle ghMainRegion;
-sdword enableTextures;
-sdword enableSmoothing;
-sdword enableStipple;
+extern sdword enableTextures;
+extern sdword enableSmoothing;
+extern sdword enableStipple;
 extern ShipRace whichRaceSelected;
 
 extern color utyBaseColor;
@@ -178,11 +178,12 @@
 void utyClipMouse(sdword clip);
 
 void utyNewGameStart(char *name, featom *atom);
+void utyGameQuit(char *name, featom *atom);
 void utyGameQuitToMain(char *name, featom *atom);
 
 //load/save options from disk
 void utyOptionsFileRead(void);
-void utyOptionsFileRead(void);
+void utyOptionsFileWrite(void);
 
 //text entry things
 real32 utyCaretBlinkRate(void);
Only in homeworld-orig/src/SDL: vc50.pdb
Only in homeworld-orig/src/SDL: vssver.scc
Only in homeworld-orig/src/SDL: wassert.c
Only in homeworld-orig/src/SDL: wassert.h
diff -urPw homeworld-orig/src/SDL/win32glue.c homeworld_sdl-0.3/src/SDL/win32glue.c
--- homeworld-orig/src/SDL/win32glue.c	1969-12-31 16:00:00.000000000 -0800
+++ homeworld_sdl-0.3/src/SDL/win32glue.c	2004-08-01 22:35:06.000000000 -0700
@@ -0,0 +1,128 @@
+/* There is no corresponding win32glue.h file since these functions
+   are called directly from converted W32 object files. */
+
+/* Entirely ripped from the Wine project (thanks!) */
+
+#define DO_FPU(x,y) __asm__ __volatile__( x " %0;fwait" : "=m" (y) : )
+#define POP_FPU(x) DO_FPU("fstpl",x)
+
+#define WINAPI      __stdcall
+typedef unsigned long DWORD;
+typedef unsigned char BYTE;
+#define __int64 long long
+typedef __int64 LONGLONG;
+
+#ifndef __cdecl
+# if defined(__i386__) && defined(__GNUC__)
+#  define __cdecl __attribute__((__cdecl__))
+# elif !defined(_MSC_VER)
+#  define __cdecl
+# endif
+#endif /* __cdecl */
+
+#ifndef __stdcall
+# ifdef __i386__
+#  ifdef __GNUC__
+#   define __stdcall __attribute__((__stdcall__))
+#  elif defined(_MSC_VER)
+    /* Nothing needs to be done. __stdcall already exists */
+#  else
+#   error You need to define __stdcall for your compiler
+#  endif
+# else  /* __i386__ */
+#  define __stdcall
+# endif  /* __i386__ */
+#endif /* __stdcall */
+
+/*********************************************************************
+ *                  _ftol   (NTDLL.@)
+ *
+ * VERSION
+ *      [GNUC && i386]
+ */
+#if defined(__GNUC__) && defined(__i386__)
+LONGLONG __cdecl _ftol(void)
+{
+        /* don't just do DO_FPU("fistp",retval), because the rounding
+         * mode must also be set to "round towards zero"... */
+        double fl;
+        POP_FPU(fl);
+        return (LONGLONG)fl;
+}
+#endif /* defined(__GNUC__) && defined(__i386__) */
+
+asm (".globl _chkstk\n"
+     ".type   _chkstk, @function\n"
+     "_chkstk:\n"
+     "popl %ecx\n"           /* Copy function's return address */
+     "subl %eax, %esp\n"
+     "pushl %ecx\n"          /* Restore original return address */
+     "ret\n"
+     ".size   _chkstk, .-_chkstk\n");
+
+#if 0
+#define SIZE_OF_80387_REGISTERS      80
+typedef struct _FLOATING_SAVE_AREA
+{
+    DWORD   ControlWord;
+    DWORD   StatusWord;
+    DWORD   TagWord;
+    DWORD   ErrorOffset;
+    DWORD   ErrorSelector;
+    DWORD   DataOffset;
+    DWORD   DataSelector;
+    BYTE    RegisterArea[SIZE_OF_80387_REGISTERS];
+    DWORD   Cr0NpxState;
+} FLOATING_SAVE_AREA, *PFLOATING_SAVE_AREA;
+
+#define MAXIMUM_SUPPORTED_EXTENSION     512
+typedef struct _CONTEXT86
+{
+    DWORD   ContextFlags;
+
+    /* These are selected by CONTEXT_DEBUG_REGISTERS */
+    DWORD   Dr0;
+    DWORD   Dr1;
+    DWORD   Dr2;
+    DWORD   Dr3;
+    DWORD   Dr6;
+    DWORD   Dr7;
+
+    /* These are selected by CONTEXT_FLOATING_POINT */
+    FLOATING_SAVE_AREA FloatSave;
+
+    /* These are selected by CONTEXT_SEGMENTS */
+    DWORD   SegGs;
+    DWORD   SegFs;
+    DWORD   SegEs;
+    DWORD   SegDs;
+
+    /* These are selected by CONTEXT_INTEGER */
+    DWORD   Edi;
+    DWORD   Esi;
+    DWORD   Ebx;
+    DWORD   Edx;
+    DWORD   Ecx;
+    DWORD   Eax;
+
+    /* These are selected by CONTEXT_CONTROL */
+    DWORD   Ebp;
+    DWORD   Eip;
+    DWORD   SegCs;
+    DWORD   EFlags;
+    DWORD   Esp;
+    DWORD   SegSs;
+
+    BYTE    ExtendedRegisters[MAXIMUM_SUPPORTED_EXTENSION];
+} CONTEXT86;
+
+/**************************************************************************
+ *                 _chkstk                              [NTDLL.@]
+ *
+ * Glorified "enter xxxx".
+ */
+void WINAPI _chkstk( CONTEXT86 *context )
+{
+    context->Esp -= context->Eax;
+}
+#endif
Only in homeworld-orig/src/SDL: zmouse.h
diff -urPw homeworld-orig/src/Ships/AdvanceSupportFrigate.c homeworld_sdl-0.3/src/Ships/AdvanceSupportFrigate.c
--- homeworld-orig/src/Ships/AdvanceSupportFrigate.c	2002-09-04 12:46:34.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/AdvanceSupportFrigate.c	2004-08-01 22:35:15.000000000 -0700
@@ -6,21 +6,21 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "debug.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Debug.h"
+#include "SpaceObj.h"
 #include "AdvanceSupportFrigate.h"
-#include "statscript.h"
-#include "gun.h"
-#include "attack.h"
+#include "StatScript.h"
+#include "Gun.h"
+#include "Attack.h"
 #include "DefaultShip.h"
-#include "shipselect.h"
-#include "aiship.h"
-#include "collision.h"
-#include "dock.h"
-#include "universe.h"
-#include "commandlayer.h"
-#include "repaircorvette.h"
+#include "ShipSelect.h"
+#include "AIShip.h"
+#include "Collision.h"
+#include "Dock.h"
+#include "Universe.h"
+#include "CommandLayer.h"
+#include "RepairCorvette.h"
 
 
 typedef struct
diff -urPw homeworld-orig/src/Ships/AdvanceSupportFrigate.h homeworld_sdl-0.3/src/Ships/AdvanceSupportFrigate.h
--- homeworld-orig/src/Ships/AdvanceSupportFrigate.h	2002-09-04 12:46:34.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/AdvanceSupportFrigate.h	2004-08-01 22:35:15.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___ADVANCE_SUPPORT_FRIGATE_H
 #define ___ADVANCE_SUPPORT_FRIGATE_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Defines:
diff -urPw homeworld-orig/src/Ships/Carrier.c homeworld_sdl-0.3/src/Ships/Carrier.c
--- homeworld-orig/src/Ships/Carrier.c	2002-09-04 12:46:34.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/Carrier.c	2004-08-01 22:35:14.000000000 -0700
@@ -6,21 +6,21 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "debug.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Debug.h"
+#include "SpaceObj.h"
 #include "Carrier.h"
-#include "statscript.h"
-#include "gun.h"
-#include "attack.h"
+#include "StatScript.h"
+#include "Gun.h"
+#include "Attack.h"
 #include "DefaultShip.h"
-#include "shipselect.h"
-#include "repaircorvette.h"
-#include "salcapcorvette.h"
+#include "ShipSelect.h"
+#include "RepairCorvette.h"
+#include "SalCapCorvette.h"
 #include "SaveGame.h"
-#include "universe.h"
-#include "commandlayer.h"
-#include "consmgr.h"
+#include "Universe.h"
+#include "CommandLayer.h"
+#include "ConsMgr.h"
 
 typedef struct
 {
@@ -175,7 +175,7 @@
     sdword i;
     for(i=0;i<MAX_NUM_DROP;i++)
     {
-        spec->droptarget[i] = SpaceObjRegistryGetID((SpaceObj *)spec->droptarget[i]);
+        spec->droptarget[i] = (SpaceObjRotImpTargGuidanceShipDerelict*)SpaceObjRegistryGetID((SpaceObj *)spec->droptarget[i]);
     }
 }
 
diff -urPw homeworld-orig/src/Ships/Carrier.h homeworld_sdl-0.3/src/Ships/Carrier.h
--- homeworld-orig/src/Ships/Carrier.h	2002-09-04 12:46:34.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/Carrier.h	2004-08-01 22:35:14.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___CARRIER_H
 #define ___CARRIER_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Defines:
diff -urPw homeworld-orig/src/Ships/CloakGenerator.c homeworld_sdl-0.3/src/Ships/CloakGenerator.c
--- homeworld-orig/src/Ships/CloakGenerator.c	2002-09-04 12:46:34.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/CloakGenerator.c	2004-08-01 22:35:13.000000000 -0700
@@ -7,19 +7,19 @@
 =============================================================================*/
 
 #include <string.h>
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 #include "CloakGenerator.h"
 #include "SoundEvent.h"
-#include "linkedlist.h"
+#include "LinkedList.h"
 #include "memory.h"
-#include "universe.h"
-#include "vector.h"
+#include "Universe.h"
+#include "Vector.h"
 #include "SaveGame.h"
-#include "genericinterceptor.h"
-#include "salcapcorvette.h"
-#include "attack.h"
-#include "battle.h"
+#include "GenericInterceptor.h"
+#include "SalCapCorvette.h"
+#include "Attack.h"
+#include "Battle.h"
 
 CloakGeneratorStatics CloakGeneratorStatic;
 
@@ -167,9 +167,7 @@
 {
     Player *playerowner = cloakship->playerowner;
     Node *objnode = universe.ShipList.head;
-    udword num = universe.ShipList.num;
     CloakGeneratorStatics *cloakgeneratorstatics;
-    CloakGeneratorSpec *spec = (CloakGeneratorSpec *)cloakship->ShipSpecifics;  //maybe don't need
     Ship *spaceobj;
     real32 distanceSqr;
     vector diff;
diff -urPw homeworld-orig/src/Ships/CloakGenerator.h homeworld_sdl-0.3/src/Ships/CloakGenerator.h
--- homeworld-orig/src/Ships/CloakGenerator.h	2002-09-04 12:46:34.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/CloakGenerator.h	2004-08-01 22:35:14.000000000 -0700
@@ -9,9 +9,9 @@
 #ifndef ___CLOAK_GENERATOR_H
 #define ___CLOAK_GENERATOR_H
 
-#include "types.h"
-#include "spaceobj.h"
-#include "linkedlist.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "LinkedList.h"
 
 
 /*=============================================================================
diff -urPw homeworld-orig/src/Ships/DDDFrigate.c homeworld_sdl-0.3/src/Ships/DDDFrigate.c
--- homeworld-orig/src/Ships/DDDFrigate.c	2002-09-04 12:46:34.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/DDDFrigate.c	2004-08-01 22:35:15.000000000 -0700
@@ -6,25 +6,25 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "debug.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Debug.h"
+#include "SpaceObj.h"
 #include "Drone.h"
 #include "DDDFrigate.h"
-#include "statscript.h"
-#include "gun.h"
-#include "attack.h"
-#include "universe.h"
-#include "univupdate.h"
-#include "formation.h"
-#include "commandlayer.h"
-#include "dock.h"
-#include "aiship.h"
-#include "collision.h"
-#include "aitrack.h"
-#include "soundevent.h"
+#include "StatScript.h"
+#include "Gun.h"
+#include "Attack.h"
+#include "Universe.h"
+#include "UnivUpdate.h"
+#include "Formation.h"
+#include "CommandLayer.h"
+#include "Dock.h"
+#include "AIShip.h"
+#include "Collision.h"
+#include "AITrack.h"
+#include "SoundEvent.h"
 #include "SaveGame.h"
-#include "randy.h"
+#include "Randy.h"
 
 #define DDDSTATE_ALLINSIDE  0
 #define DDDSTATE_LAUNCHTHEM 1
diff -urPw homeworld-orig/src/Ships/DDDFrigate.h homeworld_sdl-0.3/src/Ships/DDDFrigate.h
--- homeworld-orig/src/Ships/DDDFrigate.h	2002-09-04 12:46:34.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/DDDFrigate.h	2004-08-01 22:35:14.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___DDD_FRIGATE_H
 #define ___DDD_FRIGATE_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Defines:
diff -urPw homeworld-orig/src/Ships/DefaultShip.c homeworld_sdl-0.3/src/Ships/DefaultShip.c
--- homeworld-orig/src/Ships/DefaultShip.c	2002-09-04 12:46:34.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/DefaultShip.c	2004-08-01 22:35:15.000000000 -0700
@@ -6,14 +6,14 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "spaceobj.h"
-#include "gun.h"
-#include "attack.h"
-#include "universe.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "Gun.h"
+#include "Attack.h"
+#include "Universe.h"
 #include "DefaultShip.h"
 #include "GenericInterceptor.h"
-#include "univupdate.h"
+#include "UnivUpdate.h"
 
 typedef struct
 {
diff -urPw homeworld-orig/src/Ships/DefaultShip.h homeworld_sdl-0.3/src/Ships/DefaultShip.h
--- homeworld-orig/src/Ships/DefaultShip.h	2002-09-04 12:46:34.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/DefaultShip.h	2004-08-01 22:35:15.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___DEFAULT_SHIP_H
 #define ___DEFAULT_SHIP_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Types:
diff -urPw homeworld-orig/src/Ships/DefenseFighter.c homeworld_sdl-0.3/src/Ships/DefenseFighter.c
--- homeworld-orig/src/Ships/DefenseFighter.c	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/DefenseFighter.c	2004-08-01 22:35:15.000000000 -0700
@@ -8,26 +8,26 @@
 #include <string.h>
 #include <stdlib.h>
 #include "glinc.h"
-#include "types.h"
-#include "spaceobj.h"
-#include "gun.h"
-#include "attack.h"
-#include "universe.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "Gun.h"
+#include "Attack.h"
+#include "Universe.h"
 #include "DefenseFighter.h"
 #include "memory.h"
-#include "univupdate.h"
-#include "linkedlist.h"
-#include "fastmath.h"
-#include "vector.h"
-#include "soundevent.h"
-#include "debug.h"
-#include "randy.h"
-#include "aitrack.h"
-#include "aiship.h"
-#include "collision.h"
-#include "etg.h"
+#include "UnivUpdate.h"
+#include "LinkedList.h"
+#include "FastMath.h"
+#include "Vector.h"
+#include "SoundEvent.h"
+#include "Debug.h"
+#include "Randy.h"
+#include "AITrack.h"
+#include "AIShip.h"
+#include "Collision.h"
+#include "ETG.h"
 #include "SaveGame.h"
-#include "randy.h"
+#include "Randy.h"
 
 DefenseFighterStatics DefenseFighterStatic;
 
diff -urPw homeworld-orig/src/Ships/DefenseFighter.h homeworld_sdl-0.3/src/Ships/DefenseFighter.h
--- homeworld-orig/src/Ships/DefenseFighter.h	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/DefenseFighter.h	2004-08-01 22:35:15.000000000 -0700
@@ -9,9 +9,9 @@
 #ifndef ___DEFENSE_FIGHTER_H
 #define ___DEFENSE_FIGHTER_H
 
-#include "types.h"
-#include "spaceobj.h"
-#include "flightman.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "FlightMan.h"
 
 /*=============================================================================
     Types:
diff -urPw homeworld-orig/src/Ships/DFGFrigate.c homeworld_sdl-0.3/src/Ships/DFGFrigate.c
--- homeworld-orig/src/Ships/DFGFrigate.c	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/DFGFrigate.c	2004-08-01 22:35:15.000000000 -0700
@@ -8,20 +8,20 @@
 #include <stdlib.h>
 #include <math.h>
 #include "glinc.h"
-#include "types.h"
-#include "debug.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Debug.h"
+#include "SpaceObj.h"
 #include "DFGFrigate.h"
-#include "statscript.h"
-#include "gun.h"
-#include "attack.h"
+#include "StatScript.h"
+#include "Gun.h"
+#include "Attack.h"
 #include "DefaultShip.h"
-#include "vector.h"
-#include "fastmath.h"
-#include "universe.h"
-#include "univupdate.h"
-#include "attack.h"
-#include "randy.h"
+#include "Vector.h"
+#include "FastMath.h"
+#include "Universe.h"
+#include "UnivUpdate.h"
+#include "Attack.h"
+#include "Randy.h"
 
 DFGFrigateStatics DFGFrigateStatic;
 
@@ -52,8 +52,8 @@
 
 void DFGFInit(Ship *ship)
 {
-    DFGFrigateSpec *spec = (DFGFrigateSpec *) ship->ShipSpecifics;
 }
+
 void univDFGFieldEffect(Ship *ship, Bullet *bullet,real32 totaltimeelapsed)
 {
     vector  dir1,shiptobullet;
@@ -62,7 +62,6 @@
     real32 bulletspeed;
     real32 theta;
     matrix rotmatrix,newmatrix,tmpmatrix;
-    DFGFrigateSpec *spec = (DFGFrigateSpec *) ship->ShipSpecifics;
     sdword LOD;
     etglod *etgLOD;
     etgeffectstatic *stat;
diff -urPw homeworld-orig/src/Ships/DFGFrigate.h homeworld_sdl-0.3/src/Ships/DFGFrigate.h
--- homeworld-orig/src/Ships/DFGFrigate.h	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/DFGFrigate.h	2004-08-01 22:35:15.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___DFG_FRIGATE_H
 #define ___DFG_FRIGATE_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Defines:
diff -urPw homeworld-orig/src/Ships/Drone.c homeworld_sdl-0.3/src/Ships/Drone.c
--- homeworld-orig/src/Ships/Drone.c	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/Drone.c	2004-08-01 22:35:14.000000000 -0700
@@ -6,14 +6,14 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "debug.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Debug.h"
+#include "SpaceObj.h"
 #include "DefaultShip.h"
 #include "Drone.h"
-#include "statscript.h"
-#include "gun.h"
-#include "attack.h"
+#include "StatScript.h"
+#include "Gun.h"
+#include "Attack.h"
 
 typedef struct
 {
diff -urPw homeworld-orig/src/Ships/Drone.h homeworld_sdl-0.3/src/Ships/Drone.h
--- homeworld-orig/src/Ships/Drone.h	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/Drone.h	2004-08-01 22:35:14.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___DRONE_H
 #define ___DRONE_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Defines:
diff -urPw homeworld-orig/src/Ships/FloatingCity.c homeworld_sdl-0.3/src/Ships/FloatingCity.c
--- homeworld-orig/src/Ships/FloatingCity.c	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/FloatingCity.c	2004-08-01 22:35:15.000000000 -0700
@@ -6,13 +6,13 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "debug.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Debug.h"
+#include "SpaceObj.h"
 #include "FloatingCity.h"
-#include "statscript.h"
-#include "gun.h"
-#include "attack.h"
+#include "StatScript.h"
+#include "Gun.h"
+#include "Attack.h"
 #include "DefaultShip.h"
 
 typedef struct
diff -urPw homeworld-orig/src/Ships/FloatingCity.h homeworld_sdl-0.3/src/Ships/FloatingCity.h
--- homeworld-orig/src/Ships/FloatingCity.h	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/FloatingCity.h	2004-08-01 22:35:15.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___FLOATING_CITY_H
 #define ___FLOATING_CITY_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Defines:
diff -urPw homeworld-orig/src/Ships/GenericDefender.c homeworld_sdl-0.3/src/Ships/GenericDefender.c
--- homeworld-orig/src/Ships/GenericDefender.c	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/GenericDefender.c	2004-08-01 22:35:15.000000000 -0700
@@ -6,24 +6,24 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "debug.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Debug.h"
+#include "SpaceObj.h"
 #include "GenericDefender.h"
-#include "statscript.h"
-#include "gun.h"
-#include "attack.h"
+#include "StatScript.h"
+#include "Gun.h"
+#include "Attack.h"
 #include "DefaultShip.h"
-#include "shipselect.h"
-#include "aiship.h"
-#include "fastmath.h"
-#include "gun.h"
-#include "collision.h"
-#include "aitrack.h"
-#include "battle.h"
-#include "minelayercorvette.h"
-#include "soundevent.h"
-#include "physics.h"
+#include "ShipSelect.h"
+#include "AIShip.h"
+#include "FastMath.h"
+#include "Gun.h"
+#include "Collision.h"
+#include "AITrack.h"
+#include "Battle.h"
+#include "MinelayerCorvette.h"
+#include "SoundEvent.h"
+#include "Physics.h"
 #include "GenericInterceptor.h"
 
 #ifdef gshaw
diff -urPw homeworld-orig/src/Ships/GenericDefender.h homeworld_sdl-0.3/src/Ships/GenericDefender.h
--- homeworld-orig/src/Ships/GenericDefender.h	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/GenericDefender.h	2004-08-01 22:35:15.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___GENERIC_DEFENDER_H
 #define ___GENERIC_DEFENDER_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Defines:
diff -urPw homeworld-orig/src/Ships/GenericInterceptor.c homeworld_sdl-0.3/src/Ships/GenericInterceptor.c
--- homeworld-orig/src/Ships/GenericInterceptor.c	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/GenericInterceptor.c	2004-08-01 22:35:15.000000000 -0700
@@ -9,31 +9,31 @@
 #include <stdlib.h>
 #include <math.h>
 #include <string.h>
-#include "types.h"
-#include "fastmath.h"
-#include "debug.h"
-#include "objtypes.h"
-#include "spaceobj.h"
-#include "collision.h"
-#include "physics.h"
-#include "universe.h"
+#include "Types.h"
+#include "FastMath.h"
+#include "Debug.h"
+#include "ObjTypes.h"
+#include "SpaceObj.h"
+#include "Collision.h"
+#include "Physics.h"
+#include "Universe.h"
 #include "GenericInterceptor.h"
-#include "statscript.h"
-#include "gun.h"
-#include "aiship.h"
-#include "aitrack.h"
-#include "mex.h"
-#include "soundevent.h"
-#include "flightman.h"
-#include "commandlayer.h"
-#include "univupdate.h"
-#include "tactics.h"
-#include "nis.h"
-#include "madlinkin.h"
-#include "madlinkindefs.h"
+#include "StatScript.h"
+#include "Gun.h"
+#include "AIShip.h"
+#include "AITrack.h"
+#include "MEX.h"
+#include "SoundEvent.h"
+#include "FlightMan.h"
+#include "CommandLayer.h"
+#include "UnivUpdate.h"
+#include "Tactics.h"
+#include "NIS.h"
+#include "MadLinkIn.h"
+#include "MadLinkInDefs.h"
 #include "DefenseFighter.h"
-#include "randy.h"
-#include "battle.h"
+#include "Randy.h"
+#include "Battle.h"
 
 #ifdef gshaw
 //#define DEBUG_AIATTACK
@@ -850,7 +850,7 @@
                         formtype = NO_FORMATION;            // yet another R1 Mothership special consideration
                     }
 
-                    if ( (abs(trajectory.z) >= 0.75) )
+                    if ( (ABS(trajectory.z) >= 0.75) )
                     {
                         //vecScalarMultiply(tmpvec,trajectory,interceptorstat->flyPastDist[ship->tacticstype][targetIndex]);
                         vecScalarMultiply(tmpvec,trajectory,FAKE_FLY_BY_DISTANCE_MUCH_BIGGER_THAN_NEEDED);
@@ -868,7 +868,7 @@
                         //vecNormalizeToLength(&tmpvec,interceptorstat->flyPastDist[ship->tacticstype][targetIndex]);
                         vecNormalizeToLength(&tmpvec,FAKE_FLY_BY_DISTANCE_MUCH_BIGGER_THAN_NEEDED);
 
-                        if (abs(trajectory.x) > abs(trajectory.y))
+                        if (ABS(trajectory.x) > ABS(trajectory.y))
                         {
                             matMakeRotAboutY(&tmpmat,(real32)cos(randegf),(real32)sin(randegf));
                         }
@@ -1225,7 +1225,6 @@
 
 bool InterceptorInRange(Ship *ship,SpaceObjRotImpTarg *target)
 {
-    GenericInterceptorSpec *spec = (GenericInterceptorSpec *)ship->ShipSpecifics;
     GenericInterceptorStatics *interceptorstat = (GenericInterceptorStatics *)ship->staticinfo->custstatinfo;
     real32 range;
     uword targetIndex;
diff -urPw homeworld-orig/src/Ships/GenericInterceptor.h homeworld_sdl-0.3/src/Ships/GenericInterceptor.h
--- homeworld-orig/src/Ships/GenericInterceptor.h	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/GenericInterceptor.h	2004-08-01 22:35:13.000000000 -0700
@@ -9,9 +9,9 @@
 #ifndef ___GENERIC_INTERCEPTOR_H
 #define ___GENERIC_INTERCEPTOR_H
 
-#include "types.h"
-#include "spaceobj.h"
-#include "flightman.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "FlightMan.h"
 
 /*=============================================================================
     Types:
diff -urPw homeworld-orig/src/Ships/GravWellGenerator.c homeworld_sdl-0.3/src/Ships/GravWellGenerator.c
--- homeworld-orig/src/Ships/GravWellGenerator.c	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/GravWellGenerator.c	2004-08-01 22:35:14.000000000 -0700
@@ -7,23 +7,23 @@
 =============================================================================*/
 
 #include <string.h>
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 #include "GravWellGenerator.h"
 #include "SoundEvent.h"
-#include "vector.h"
-#include "universe.h"
-#include "aitrack.h"
-#include "select.h"
+#include "Vector.h"
+#include "Universe.h"
+#include "AITrack.h"
+#include "Select.h"
 #include "SaveGame.h"
-#include "madlinkin.h"
-#include "univupdate.h"
-#include "attack.h"
-#include "randy.h"
-#include "battle.h"
-#include "fastmath.h"
-#include "blobs.h"
-#include "etg.h"
+#include "MadLinkIn.h"
+#include "UnivUpdate.h"
+#include "Attack.h"
+#include "Randy.h"
+#include "Battle.h"
+#include "FastMath.h"
+#include "Blobs.h"
+#include "ETG.h"
 
 GravWellGeneratorStatics GravWellGeneratorStatic;
 
@@ -393,9 +393,7 @@
 void GravAddObjectsInProximity(Ship *gravship)
 {
     Node *objnode = universe.ShipList.head;
-    udword num = universe.ShipList.num;
     GravWellGeneratorStatics *gravwellgeneratorstatics;
-    GravWellGeneratorSpec *spec = (GravWellGeneratorSpec *)gravship->ShipSpecifics;  //maybe don't need
     Ship *ship;
 
     real32 distanceSqr;
diff -urPw homeworld-orig/src/Ships/GravWellGenerator.h homeworld_sdl-0.3/src/Ships/GravWellGenerator.h
--- homeworld-orig/src/Ships/GravWellGenerator.h	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/GravWellGenerator.h	2004-08-01 22:35:14.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___GRAV_WELL_GENERATOR_H
 #define ___GRAV_WELL_GENERATOR_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Types:
diff -urPw homeworld-orig/src/Ships/HeavyCorvette.c homeworld_sdl-0.3/src/Ships/HeavyCorvette.c
--- homeworld-orig/src/Ships/HeavyCorvette.c	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/HeavyCorvette.c	2004-08-01 22:35:14.000000000 -0700
@@ -7,22 +7,22 @@
 =============================================================================*/
 
 #include <string.h>
-#include "types.h"
-#include "debug.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Debug.h"
+#include "SpaceObj.h"
 #include "HeavyCorvette.h"
-#include "statscript.h"
-#include "gun.h"
-#include "attack.h"
+#include "StatScript.h"
+#include "Gun.h"
+#include "Attack.h"
 #include "DefaultShip.h"
-#include "shipselect.h"
-#include "aiship.h"
-#include "aitrack.h"
-#include "tactics.h"
-#include "fastmath.h"
-#include "universe.h"
-#include "soundevent.h"
-#include "battle.h"
+#include "ShipSelect.h"
+#include "AIShip.h"
+#include "AITrack.h"
+#include "Tactics.h"
+#include "FastMath.h"
+#include "Universe.h"
+#include "SoundEvent.h"
+#include "Battle.h"
 
 //#define DEBUG_HEAVYCORVETTE
 
@@ -237,9 +237,6 @@
 bool doBurstFire(Ship *ship)
 {
     HeavyCorvetteSpec *spec = (HeavyCorvetteSpec *)ship->ShipSpecifics;
-    GunInfo *gunInfo = ship->gunInfo;
-    sdword numGuns = gunInfo->numGuns;
-    //Gun *gun;
     sdword done;
     vector trajectory,heading;
     real32 range,one_over_range;
@@ -269,8 +266,6 @@
     //fix later
     spec->bulletLifeTime = range*oneOverburstSpeed;
 
-
-
     bitSet(ship->specialFlags,SPECIAL_BurstFiring);
     done = gunShootGunsAtTarget(ship,&dummyTarg,0.0f,&trajectory);
     bitClear(ship->specialFlags,SPECIAL_BurstFiring);
diff -urPw homeworld-orig/src/Ships/HeavyCorvette.h homeworld_sdl-0.3/src/Ships/HeavyCorvette.h
--- homeworld-orig/src/Ships/HeavyCorvette.h	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/HeavyCorvette.h	2004-08-01 22:35:14.000000000 -0700
@@ -9,9 +9,9 @@
 #ifndef ___HEAVY_CORVETTE_H
 #define ___HEAVY_CORVETTE_H
 
-#include "types.h"
-#include "spaceobj.h"
-#include "attack.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "Attack.h"
 
 /*=============================================================================
     Types:
diff -urPw homeworld-orig/src/Ships/HeavyCruiser.c homeworld_sdl-0.3/src/Ships/HeavyCruiser.c
--- homeworld-orig/src/Ships/HeavyCruiser.c	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/HeavyCruiser.c	2004-08-01 22:35:14.000000000 -0700
@@ -6,13 +6,13 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "debug.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Debug.h"
+#include "SpaceObj.h"
 #include "HeavyCruiser.h"
-#include "statscript.h"
-#include "gun.h"
-#include "attack.h"
+#include "StatScript.h"
+#include "Gun.h"
+#include "Attack.h"
 #include "DefaultShip.h"
 
 typedef struct
diff -urPw homeworld-orig/src/Ships/HeavyCruiser.h homeworld_sdl-0.3/src/Ships/HeavyCruiser.h
--- homeworld-orig/src/Ships/HeavyCruiser.h	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/HeavyCruiser.h	2004-08-01 22:35:14.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___HEAVY_CRUISER_H
 #define ___HEAVY_CRUISER_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Defines:
diff -urPw homeworld-orig/src/Ships/IonCannonFrigate.c homeworld_sdl-0.3/src/Ships/IonCannonFrigate.c
--- homeworld-orig/src/Ships/IonCannonFrigate.c	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/IonCannonFrigate.c	2004-08-01 22:35:14.000000000 -0700
@@ -6,13 +6,13 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "debug.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Debug.h"
+#include "SpaceObj.h"
 #include "IonCannonFrigate.h"
-#include "statscript.h"
-#include "gun.h"
-#include "attack.h"
+#include "StatScript.h"
+#include "Gun.h"
+#include "Attack.h"
 #include "DefaultShip.h"
 
 typedef struct
diff -urPw homeworld-orig/src/Ships/IonCannonFrigate.h homeworld_sdl-0.3/src/Ships/IonCannonFrigate.h
--- homeworld-orig/src/Ships/IonCannonFrigate.h	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/IonCannonFrigate.h	2004-08-01 22:35:14.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___ION_CANNON_FRIGATE_H
 #define ___ION_CANNON_FRIGATE_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Defines:
diff -urPw homeworld-orig/src/Ships/LightCorvette.c homeworld_sdl-0.3/src/Ships/LightCorvette.c
--- homeworld-orig/src/Ships/LightCorvette.c	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/LightCorvette.c	2004-08-01 22:35:14.000000000 -0700
@@ -7,13 +7,13 @@
 =============================================================================*/
 
 #include <string.h>
-#include "types.h"
-#include "debug.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Debug.h"
+#include "SpaceObj.h"
 #include "LightCorvette.h"
-#include "statscript.h"
-#include "gun.h"
-#include "attack.h"
+#include "StatScript.h"
+#include "Gun.h"
+#include "Attack.h"
 #include "DefaultShip.h"
 
 typedef struct
diff -urPw homeworld-orig/src/Ships/LightCorvette.h homeworld_sdl-0.3/src/Ships/LightCorvette.h
--- homeworld-orig/src/Ships/LightCorvette.h	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/LightCorvette.h	2004-08-01 22:35:14.000000000 -0700
@@ -9,9 +9,9 @@
 #ifndef ___LIGHT_CORVETTE_H
 #define ___LIGHT_CORVETTE_H
 
-#include "types.h"
-#include "spaceobj.h"
-#include "attack.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "Attack.h"
 
 /*=============================================================================
     Types:
diff -urPw homeworld-orig/src/Ships/MinelayerCorvette.c homeworld_sdl-0.3/src/Ships/MinelayerCorvette.c
--- homeworld-orig/src/Ships/MinelayerCorvette.c	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/MinelayerCorvette.c	2004-08-01 22:35:14.000000000 -0700
@@ -12,27 +12,27 @@
 #include <string.h>
 #include <math.h>
 #include <stdlib.h>
-#include "types.h"
-#include "debug.h"
-#include "univupdate.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Debug.h"
+#include "UnivUpdate.h"
+#include "SpaceObj.h"
 #include "MinelayerCorvette.h"
-#include "statscript.h"
-#include "gun.h"
-#include "attack.h"
+#include "StatScript.h"
+#include "Gun.h"
+#include "Attack.h"
 #include "DefaultShip.h"
-#include "universe.h"
-#include "gun.h"
-#include "aitrack.h"
-#include "aiship.h"
-#include "attack.h"
-#include "collision.h"
-#include "fastmath.h"
-#include "physics.h"
+#include "Universe.h"
+#include "Gun.h"
+#include "AITrack.h"
+#include "AIShip.h"
+#include "Attack.h"
+#include "Collision.h"
+#include "FastMath.h"
+#include "Physics.h"
 #include "SaveGame.h"
-#include "randy.h"
-#include "soundevent.h"
-#include "battle.h"
+#include "Randy.h"
+#include "SoundEvent.h"
+#include "Battle.h"
 
 MinelayerCorvetteStatics MinelayerCorvetteStatic;
 
@@ -194,7 +194,6 @@
 void SetAIVecHeading(Ship *ship, SpaceObjRotImpTarg *target, vector *trajectory)
 {
     //real32 range;
-    ShipStaticInfo *shipstaticinfo = (ShipStaticInfo *)ship->staticinfo;
     vector tmpvec;
     udword target_class;
     real32 randegf;
@@ -265,19 +264,10 @@
 void MineLayerAttackRun(Ship *ship,SpaceObjRotImpTarg *target,AttackSideStep *attacksidestep,AttackSideStepParameters *parameters)
 {
     vector trajectory;
-    //real32 dist;
     real32 range;
-    //real32 temp;
-//    bool didshoot;
-    ShipStaticInfo *shipstaticinfo = (ShipStaticInfo *)ship->staticinfo;
     Gun *gun;
     udword numGuns,target_class;
     GunInfo *guninfo = ship->gunInfo;
-    //vector tmpvec;
-    //real32 randegf;
-    //sdword randeg;
-    //matrix tmpmat;
-    //vector targetheading;
     MinelayerCorvetteSpec *spec = (MinelayerCorvetteSpec *)ship->ShipSpecifics;
     MinelayerCorvetteStatics *minelayercorvettestatics;
     minelayercorvettestatics = (MinelayerCorvetteStatics *) ((ShipStaticInfo *)(ship->staticinfo))->custstatinfo;
@@ -472,7 +462,6 @@
     MinelayerCorvetteStatics *minelayercorvettestatics;
     MinelayerCorvetteSpec *spec = (MinelayerCorvetteSpec *)ship->ShipSpecifics;
     sdword flag;
-    GunInfo *guninfo = ship->gunInfo;
     Gun *gun0,*gun1;
     real32 time;
     sdword maxmis;
@@ -650,10 +639,6 @@
 
 bool MinelayerCorvetteSpecialActivate(Ship *ship)
 {
-    MinelayerCorvetteStatics *minelayercorvettestatics;
-    MinelayerCorvetteSpec *spec = (MinelayerCorvetteSpec *)ship->ShipSpecifics;
-    minelayercorvettestatics = (MinelayerCorvetteStatics *) ((ShipStaticInfo *)(ship->staticinfo))->custstatinfo;
-
     return(MinelayerCorvetteStaticMineDrop(ship,NULL));
 }
 
@@ -795,7 +780,7 @@
                 }
             }
         }
-ret:
+
         node = node->next;
     }
 
diff -urPw homeworld-orig/src/Ships/MinelayerCorvette.h homeworld_sdl-0.3/src/Ships/MinelayerCorvette.h
--- homeworld-orig/src/Ships/MinelayerCorvette.h	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/MinelayerCorvette.h	2004-08-01 22:35:14.000000000 -0700
@@ -9,10 +9,10 @@
 #ifndef ___MINELAYER_CORVETTE_H
 #define ___MINELAYER_CORVETTE_H
 
-#include "types.h"
-#include "spaceobj.h"
-#include "attack.h"
-#include "formation.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "Attack.h"
+#include "Formation.h"
 /*=============================================================================
     Types:
 =============================================================================*/
diff -urPw homeworld-orig/src/Ships/MissileDestroyer.c homeworld_sdl-0.3/src/Ships/MissileDestroyer.c
--- homeworld-orig/src/Ships/MissileDestroyer.c	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/MissileDestroyer.c	2004-08-01 22:35:15.000000000 -0700
@@ -6,20 +6,20 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "debug.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Debug.h"
+#include "SpaceObj.h"
 #include "MissileDestroyer.h"
-#include "statscript.h"
-#include "gun.h"
-#include "attack.h"
+#include "StatScript.h"
+#include "Gun.h"
+#include "Attack.h"
 #include "DefaultShip.h"
-#include "universe.h"
-#include "soundevent.h"
-#include "battle.h"
-#include "aiship.h"
-#include "aitrack.h"
-#include "collision.h"
+#include "Universe.h"
+#include "SoundEvent.h"
+#include "Battle.h"
+#include "AIShip.h"
+#include "AITrack.h"
+#include "Collision.h"
 
 typedef struct
 {
@@ -155,6 +155,7 @@
 
     spec->lasttimeDidSpecialTargeting = universe.totaltimeelapsed;
 
+    // check that the "volley reload time" has passed
     if ((universe.totaltimeelapsed - spec->lasttimeFiredVolley) > mdestroyerstat->missileVolleyTime)
     {
         spec->lasttimeFiredVolley = universe.totaltimeelapsed;
@@ -189,10 +190,7 @@
                 battleChatterAttempt(SOUND_EVENT_DEFAULT, BCE_COMM_MissleDest_VolleyAttack, ship, SOUND_EVENT_DEFAULT);
             }
         }
-
-
         //////////////////////
-
     }
 
     if (spec->curTargetIndex >= numShipsToTarget)
@@ -249,6 +247,8 @@
         //didn't try to fire...so lets fly towards a target...lets pick...0
         aishipFlyToShipAvoidingObjs(ship,(Ship *)targets->TargetPtr[0],AISHIP_FastAsPossible|AISHIP_PointInDirectionFlying,0.0f);
     }
+    
+    return FALSE;
 }
 
 CustShipHeader MissileDestroyerHeader =
diff -urPw homeworld-orig/src/Ships/MissileDestroyer.h homeworld_sdl-0.3/src/Ships/MissileDestroyer.h
--- homeworld-orig/src/Ships/MissileDestroyer.h	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/MissileDestroyer.h	2004-08-01 22:35:15.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___MISSILE_DESTROYER_H
 #define ___MISSILE_DESTROYER_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Defines:
diff -urPw homeworld-orig/src/Ships/Mothership.c homeworld_sdl-0.3/src/Ships/Mothership.c
--- homeworld-orig/src/Ships/Mothership.c	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/Mothership.c	2004-08-01 22:35:14.000000000 -0700
@@ -6,21 +6,21 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "debug.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Debug.h"
+#include "SpaceObj.h"
 #include "Mothership.h"
-#include "statscript.h"
-#include "gun.h"
-#include "attack.h"
+#include "StatScript.h"
+#include "Gun.h"
+#include "Attack.h"
 #include "DefaultShip.h"
-#include "madLinkin.h"
-#include "savegame.h"
-#include "universe.h"
-#include "aitrack.h"
-#include "salcapcorvette.h"
-#include "madlinkindefs.h"
-#include "commandlayer.h"
+#include "MadLinkIn.h"
+#include "SaveGame.h"
+#include "Universe.h"
+#include "AITrack.h"
+#include "SalCapCorvette.h"
+#include "MadLinkInDefs.h"
+#include "CommandLayer.h"
 
 extern sdword R1MOTHERSHIP_Big;
 extern sdword R2MOTHERSHIP_Big;
@@ -164,7 +164,6 @@
 void MothershipDoorUpKeep(Ship *ship)
 {
     MothershipSpec *spec = (MothershipSpec *)ship->ShipSpecifics;
-    MothershipStatics *mothershipstatics = (MothershipStatics *)((ship->staticinfo))->custstatinfo;
     vector positionWS,doorHeading,doorRight,doorUp;
     vector heading,up,right;
     matrix coordsysWS;
@@ -239,6 +238,7 @@
     if(madLinkInGetDoorInfo(ship,coordsys,position))
     {
         position->x += TW_R1_MOTHERSHIP_DOOR_OFFSET_MODIFIER;
+
         headingdir = mothershipstatics->specialDoorOrientationHeading[((Ship *)cargo)->shiprace][((Ship *)cargo)->shiptype];
         if(headingdir == -1)
             headingdir = 0;
diff -urPw homeworld-orig/src/Ships/Mothership.h homeworld_sdl-0.3/src/Ships/Mothership.h
--- homeworld-orig/src/Ships/Mothership.h	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/Mothership.h	2004-08-01 22:35:14.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___MOTHERSHIP_H
 #define ___MOTHERSHIP_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Defines:
diff -urPw homeworld-orig/src/Ships/MultiGunCorvette.c homeworld_sdl-0.3/src/Ships/MultiGunCorvette.c
--- homeworld-orig/src/Ships/MultiGunCorvette.c	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/MultiGunCorvette.c	2004-08-01 22:35:15.000000000 -0700
@@ -7,13 +7,13 @@
 =============================================================================*/
 
 #include <string.h>
-#include "types.h"
-#include "debug.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Debug.h"
+#include "SpaceObj.h"
 #include "MultiGunCorvette.h"
-#include "statscript.h"
-#include "gun.h"
-#include "attack.h"
+#include "StatScript.h"
+#include "Gun.h"
+#include "Attack.h"
 #include "DefaultShip.h"
 
 typedef struct
diff -urPw homeworld-orig/src/Ships/MultiGunCorvette.h homeworld_sdl-0.3/src/Ships/MultiGunCorvette.h
--- homeworld-orig/src/Ships/MultiGunCorvette.h	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/MultiGunCorvette.h	2004-08-01 22:35:15.000000000 -0700
@@ -9,9 +9,9 @@
 #ifndef ___MULTIGUN_CORVETTE_H
 #define ___MULTIGUN_CORVETTE_H
 
-#include "types.h"
-#include "spaceobj.h"
-#include "attack.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "Attack.h"
 
 /*=============================================================================
     Types:
diff -urPw homeworld-orig/src/Ships/P1IonArrayFrigate.c homeworld_sdl-0.3/src/Ships/P1IonArrayFrigate.c
--- homeworld-orig/src/Ships/P1IonArrayFrigate.c	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/P1IonArrayFrigate.c	2004-08-01 22:35:15.000000000 -0700
@@ -6,13 +6,13 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "debug.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Debug.h"
+#include "SpaceObj.h"
 #include "P1IonArrayFrigate.h"
-#include "statscript.h"
-#include "gun.h"
-#include "attack.h"
+#include "StatScript.h"
+#include "Gun.h"
+#include "Attack.h"
 #include "DefaultShip.h"
 
 typedef struct
diff -urPw homeworld-orig/src/Ships/P1IonArrayFrigate.h homeworld_sdl-0.3/src/Ships/P1IonArrayFrigate.h
--- homeworld-orig/src/Ships/P1IonArrayFrigate.h	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/P1IonArrayFrigate.h	2004-08-01 22:35:15.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___P1_ION_ARRAY_FRIGATE_H
 #define ___P1_ION_ARRAY_FRIGATE_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Defines:
diff -urPw homeworld-orig/src/Ships/P1MissileCorvette.c homeworld_sdl-0.3/src/Ships/P1MissileCorvette.c
--- homeworld-orig/src/Ships/P1MissileCorvette.c	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/P1MissileCorvette.c	2004-08-01 22:35:15.000000000 -0700
@@ -7,15 +7,15 @@
 =============================================================================*/
 
 #include <string.h>
-#include "types.h"
-#include "debug.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Debug.h"
+#include "SpaceObj.h"
 #include "P1MissileCorvette.h"
-#include "statscript.h"
-#include "gun.h"
-#include "attack.h"
+#include "StatScript.h"
+#include "Gun.h"
+#include "Attack.h"
 #include "DefaultShip.h"
-#include "universe.h"
+#include "Universe.h"
 
 typedef struct
 {
diff -urPw homeworld-orig/src/Ships/P1MissileCorvette.h homeworld_sdl-0.3/src/Ships/P1MissileCorvette.h
--- homeworld-orig/src/Ships/P1MissileCorvette.h	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/P1MissileCorvette.h	2004-08-01 22:35:15.000000000 -0700
@@ -9,9 +9,9 @@
 #ifndef ___P1_MISSILE_CORVETTE_H
 #define ___P1_MISSILE_CORVETTE_H
 
-#include "types.h"
-#include "spaceobj.h"
-#include "attack.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "Attack.h"
 
 /*=============================================================================
     Defines:
diff -urPw homeworld-orig/src/Ships/P1Mothership.c homeworld_sdl-0.3/src/Ships/P1Mothership.c
--- homeworld-orig/src/Ships/P1Mothership.c	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/P1Mothership.c	2004-08-01 22:35:14.000000000 -0700
@@ -6,13 +6,13 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "debug.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Debug.h"
+#include "SpaceObj.h"
 #include "P1Mothership.h"
-#include "statscript.h"
-#include "gun.h"
-#include "attack.h"
+#include "StatScript.h"
+#include "Gun.h"
+#include "Attack.h"
 #include "DefaultShip.h"
 
 typedef struct
diff -urPw homeworld-orig/src/Ships/P1Mothership.h homeworld_sdl-0.3/src/Ships/P1Mothership.h
--- homeworld-orig/src/Ships/P1Mothership.h	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/P1Mothership.h	2004-08-01 22:35:14.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___P1_MOTHERSHIP_H
 #define ___P1_MOTHERSHIP_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Defines:
diff -urPw homeworld-orig/src/Ships/P1StandardCorvette.c homeworld_sdl-0.3/src/Ships/P1StandardCorvette.c
--- homeworld-orig/src/Ships/P1StandardCorvette.c	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/P1StandardCorvette.c	2004-08-01 22:35:14.000000000 -0700
@@ -7,13 +7,13 @@
 =============================================================================*/
 
 #include <string.h>
-#include "types.h"
-#include "debug.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Debug.h"
+#include "SpaceObj.h"
 #include "P1StandardCorvette.h"
-#include "statscript.h"
-#include "gun.h"
-#include "attack.h"
+#include "StatScript.h"
+#include "Gun.h"
+#include "Attack.h"
 #include "DefaultShip.h"
 
 typedef struct
diff -urPw homeworld-orig/src/Ships/P1StandardCorvette.h homeworld_sdl-0.3/src/Ships/P1StandardCorvette.h
--- homeworld-orig/src/Ships/P1StandardCorvette.h	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/P1StandardCorvette.h	2004-08-01 22:35:14.000000000 -0700
@@ -9,9 +9,9 @@
 #ifndef ___P1_STANDARD_CORVETTE_H
 #define ___P1_STANDARD_CORVETTE_H
 
-#include "types.h"
-#include "spaceobj.h"
-#include "attack.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "Attack.h"
 
 /*=============================================================================
     Defines:
diff -urPw homeworld-orig/src/Ships/P2AdvanceSwarmer.c homeworld_sdl-0.3/src/Ships/P2AdvanceSwarmer.c
--- homeworld-orig/src/Ships/P2AdvanceSwarmer.c	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/P2AdvanceSwarmer.c	2004-08-01 22:35:14.000000000 -0700
@@ -7,13 +7,13 @@
 =============================================================================*/
 
 #include <string.h>
-#include "types.h"
-#include "debug.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Debug.h"
+#include "SpaceObj.h"
 #include "P2AdvanceSwarmer.h"
-#include "statscript.h"
-#include "gun.h"
-#include "attack.h"
+#include "StatScript.h"
+#include "Gun.h"
+#include "Attack.h"
 #include "DefaultShip.h"
 
 typedef struct
diff -urPw homeworld-orig/src/Ships/P2AdvanceSwarmer.h homeworld_sdl-0.3/src/Ships/P2AdvanceSwarmer.h
--- homeworld-orig/src/Ships/P2AdvanceSwarmer.h	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/P2AdvanceSwarmer.h	2004-08-01 22:35:14.000000000 -0700
@@ -9,9 +9,9 @@
 #ifndef ___P2_ADVANCESWARMER_H
 #define ___P2_ADVANCESWARMER_H
 
-#include "types.h"
-#include "spaceobj.h"
-#include "attack.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "Attack.h"
 
 /*=============================================================================
     Types:
diff -urPw homeworld-orig/src/Ships/P2FuelPod.c homeworld_sdl-0.3/src/Ships/P2FuelPod.c
--- homeworld-orig/src/Ships/P2FuelPod.c	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/P2FuelPod.c	2004-08-01 22:35:13.000000000 -0700
@@ -6,13 +6,13 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "debug.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Debug.h"
+#include "SpaceObj.h"
 #include "P2FuelPod.h"
-#include "statscript.h"
-#include "gun.h"
-#include "attack.h"
+#include "StatScript.h"
+#include "Gun.h"
+#include "Attack.h"
 #include "DefaultShip.h"
 
 typedef struct
diff -urPw homeworld-orig/src/Ships/P2FuelPod.h homeworld_sdl-0.3/src/Ships/P2FuelPod.h
--- homeworld-orig/src/Ships/P2FuelPod.h	2002-09-04 12:46:36.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/P2FuelPod.h	2004-08-01 22:35:14.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___P2_FUEL_POD_H
 #define ___P2_FUEL_POD_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Defines:
diff -urPw homeworld-orig/src/Ships/P2Mothership.c homeworld_sdl-0.3/src/Ships/P2Mothership.c
--- homeworld-orig/src/Ships/P2Mothership.c	2002-09-04 12:46:38.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/P2Mothership.c	2004-08-01 22:35:14.000000000 -0700
@@ -6,13 +6,13 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "debug.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Debug.h"
+#include "SpaceObj.h"
 #include "P2Mothership.h"
-#include "statscript.h"
-#include "gun.h"
-#include "attack.h"
+#include "StatScript.h"
+#include "Gun.h"
+#include "Attack.h"
 #include "DefaultShip.h"
 
 typedef struct
diff -urPw homeworld-orig/src/Ships/P2Mothership.h homeworld_sdl-0.3/src/Ships/P2Mothership.h
--- homeworld-orig/src/Ships/P2Mothership.h	2002-09-04 12:46:38.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/P2Mothership.h	2004-08-01 22:35:14.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___P2_MOTHERSHIP_H
 #define ___P2_MOTHERSHIP_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Defines:
diff -urPw homeworld-orig/src/Ships/P2MultiBeamFrigate.c homeworld_sdl-0.3/src/Ships/P2MultiBeamFrigate.c
--- homeworld-orig/src/Ships/P2MultiBeamFrigate.c	2002-09-04 12:46:38.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/P2MultiBeamFrigate.c	2004-08-01 22:35:14.000000000 -0700
@@ -9,25 +9,25 @@
 #include <stdlib.h>
 #include <math.h>
 #include <string.h>
-#include "types.h"
-#include "fastmath.h"
-#include "debug.h"
-#include "objtypes.h"
-#include "spaceobj.h"
-#include "collision.h"
-#include "physics.h"
-#include "universe.h"
-#include "p2MultiBeamFrigate.h"
-#include "statscript.h"
-#include "gun.h"
-#include "aiship.h"
-#include "aitrack.h"
-#include "attack.h"
-#include "mex.h"
-#include "soundevent.h"
-#include "flightman.h"
-#include "commandlayer.h"
-#include "univupdate.h"
+#include "Types.h"
+#include "FastMath.h"
+#include "Debug.h"
+#include "ObjTypes.h"
+#include "SpaceObj.h"
+#include "Collision.h"
+#include "Physics.h"
+#include "Universe.h"
+#include "P2MultiBeamFrigate.h"
+#include "StatScript.h"
+#include "Gun.h"
+#include "AIShip.h"
+#include "AITrack.h"
+#include "Attack.h"
+#include "MEX.h"
+#include "SoundEvent.h"
+#include "FlightMan.h"
+#include "CommandLayer.h"
+#include "UnivUpdate.h"
 #include "DefaultShip.h"
 
 #define STATE_INIT          0
@@ -354,12 +354,12 @@
 
 void P2MultiBeamFrigateHouseKeep(Ship *ship)
 {
+/*
     P2MultiBeamFrigateSpec *spec = (P2MultiBeamFrigateSpec *)ship->ShipSpecifics;
-//    ShipStaticInfo         *shipstaticinfo = (ShipStaticInfo *)ship->staticinfo;
-  //  real32 desiredrotspeed;
-  //  real32 rotspeed;
+    ShipStaticInfo         *shipstaticinfo = (ShipStaticInfo *)ship->staticinfo;
+    real32 desiredrotspeed;
+    real32 rotspeed;
 
-/*
     if (spec->spining)
     {
         if (universe.totaltimeelapsed - spec->aiattacklast > 0.15)
diff -urPw homeworld-orig/src/Ships/P2MultiBeamFrigate.h homeworld_sdl-0.3/src/Ships/P2MultiBeamFrigate.h
--- homeworld-orig/src/Ships/P2MultiBeamFrigate.h	2002-09-04 12:46:38.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/P2MultiBeamFrigate.h	2004-08-01 22:35:14.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___P2_MULTI_BEAM_FRIGATE_H
 #define ___P2_MULTI_BEAM_FRIGATE_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Defines:
diff -urPw homeworld-orig/src/Ships/P2Swarmer.c homeworld_sdl-0.3/src/Ships/P2Swarmer.c
--- homeworld-orig/src/Ships/P2Swarmer.c	2002-09-04 12:46:38.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/P2Swarmer.c	2004-08-01 22:35:15.000000000 -0700
@@ -7,13 +7,13 @@
 =============================================================================*/
 
 #include <string.h>
-#include "types.h"
-#include "debug.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Debug.h"
+#include "SpaceObj.h"
 #include "P2Swarmer.h"
-#include "statscript.h"
-#include "gun.h"
-#include "attack.h"
+#include "StatScript.h"
+#include "Gun.h"
+#include "Attack.h"
 #include "DefaultShip.h"
 
 typedef struct
diff -urPw homeworld-orig/src/Ships/P2Swarmer.h homeworld_sdl-0.3/src/Ships/P2Swarmer.h
--- homeworld-orig/src/Ships/P2Swarmer.h	2002-09-04 12:46:38.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/P2Swarmer.h	2004-08-01 22:35:15.000000000 -0700
@@ -9,9 +9,9 @@
 #ifndef ___P2_SWARMER_H
 #define ___P2_SWARMER_H
 
-#include "types.h"
-#include "spaceobj.h"
-#include "attack.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "Attack.h"
 
 /*=============================================================================
     Types:
diff -urPw homeworld-orig/src/Ships/P3StandardShip.c homeworld_sdl-0.3/src/Ships/P3StandardShip.c
--- homeworld-orig/src/Ships/P3StandardShip.c	2002-09-04 12:46:38.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/P3StandardShip.c	2004-08-01 22:35:14.000000000 -0700
@@ -6,13 +6,13 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "debug.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Debug.h"
+#include "SpaceObj.h"
 #include "P3StandardShip.h"
-#include "statscript.h"
-#include "gun.h"
-#include "attack.h"
+#include "StatScript.h"
+#include "Gun.h"
+#include "Attack.h"
 #include "DefaultShip.h"
 
 typedef struct
diff -urPw homeworld-orig/src/Ships/P3StandardShip.h homeworld_sdl-0.3/src/Ships/P3StandardShip.h
--- homeworld-orig/src/Ships/P3StandardShip.h	2002-09-04 12:46:38.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/P3StandardShip.h	2004-08-01 22:35:14.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___P3_STANDARD_SHIP_H
 #define ___P3_STANDARD_SHIP_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Defines:
diff -urPw homeworld-orig/src/Ships/Probe.c homeworld_sdl-0.3/src/Ships/Probe.c
--- homeworld-orig/src/Ships/Probe.c	2002-09-04 12:46:38.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/Probe.c	2004-08-01 22:35:14.000000000 -0700
@@ -5,19 +5,18 @@
     Created 01/06/1998 by bpasechnik
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
-#include <windows.h>
 #include <math.h>
-#include "types.h"
-#include "spaceobj.h"
-#include "aitrack.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "AITrack.h"
 #include "Probe.h"
-#include "statscript.h"
+#include "StatScript.h"
 #include "SoundEvent.h"
-#include "debug.h"
-#include "universe.h"
-#include "vector.h"
-#include "madlinkin.h"
-#include "madlinkindefs.h"
+#include "Debug.h"
+#include "Universe.h"
+#include "Vector.h"
+#include "MadLinkIn.h"
+#include "MadLinkInDefs.h"
 
 #define PROBE_WAIT_FOR_SAILS_TO_OPEN    3.0f
 
@@ -64,7 +63,7 @@
 void ProbeHouseKeep(Ship *ship)
 {
     ProbeSpec *spec = (ProbeSpec *) ship->ShipSpecifics;
-    ProbeStatics *probestatics = ((ShipStaticInfo *)(ship->staticinfo))->custstatinfo;
+    //ProbeStatics *probestatics = ((ShipStaticInfo *)(ship->staticinfo))->custstatinfo;
     vector right,heading,testvec;
 
 
@@ -82,7 +81,7 @@
             //open wings after being given a move command!
             if(command != NULL && command->ordertype.order == COMMAND_DOCK)
             {
-
+                // don't open sails as we're docking at the end of a mission having not been used during it
             }
             else
             {
diff -urPw homeworld-orig/src/Ships/Probe.h homeworld_sdl-0.3/src/Ships/Probe.h
--- homeworld-orig/src/Ships/Probe.h	2002-09-04 12:46:38.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/Probe.h	2004-08-01 22:35:14.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___PROBE_H
 #define ___PROBE_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Types:
diff -urPw homeworld-orig/src/Ships/ProximitySensor.c homeworld_sdl-0.3/src/Ships/ProximitySensor.c
--- homeworld-orig/src/Ships/ProximitySensor.c	2002-09-04 12:46:38.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/ProximitySensor.c	2004-08-01 22:35:13.000000000 -0700
@@ -6,21 +6,21 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 #include "ProximitySensor.h"
 #include "SoundEvent.h"
-#include "universe.h"
+#include "Universe.h"
 #include "memory.h"
-#include "univupdate.h"
-#include "linkedlist.h"
-#include "fastmath.h"
-#include "vector.h"
-#include "ping.h"
-#include "blobs.h"
-#include "madlinkin.h"
-#include "madlinkindefs.h"
-#include "battle.h"
+#include "UnivUpdate.h"
+#include "LinkedList.h"
+#include "FastMath.h"
+#include "Vector.h"
+#include "Ping.h"
+#include "Blobs.h"
+#include "MadLinkIn.h"
+#include "MadLinkInDefs.h"
+#include "Battle.h"
 #include "Alliance.h"
 
 
@@ -251,7 +251,7 @@
     Outputs     :
     Return      : TRUE if the ping times out.
 ----------------------------------------------------------------------------*/
-bool ProximitySensorPingTimeout(struct ping *hellaPing, udword userID, ubyte *userData, bool bRemoveReferences)
+bool ProximitySensorPingTimeout(struct ping *hellaPing, udword userID, char *userData, bool bRemoveReferences)
 {
     ProximitySensorSpec *spec = (ProximitySensorSpec *)((Ship *)userID)->ShipSpecifics;
 
diff -urPw homeworld-orig/src/Ships/ProximitySensor.h homeworld_sdl-0.3/src/Ships/ProximitySensor.h
--- homeworld-orig/src/Ships/ProximitySensor.h	2002-09-04 12:46:38.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/ProximitySensor.h	2004-08-01 22:35:14.000000000 -0700
@@ -9,11 +9,11 @@
 #ifndef ___PROXIMITYSENSOR_H
 #define ___PROXIMITYSENSOR_H
 
-#include "types.h"
-#include "spaceobj.h"
-#include "select.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "Select.h"
 #ifndef STATVIEWER_PROGRAM
-#include "universe.h"
+#include "Universe.h"
 #endif
 
 
@@ -51,7 +51,7 @@
 #define SENSOR_SENSE    1
 #define SENSOR_SENSED   2
 #define SENSOR_SENSED2  3
-color ProximitySensorBlipColor;
+extern color ProximitySensorBlipColor;
 
 /*=============================================================================
     Functions:
diff -urPw homeworld-orig/src/Ships/RepairCorvette.c homeworld_sdl-0.3/src/Ships/RepairCorvette.c
--- homeworld-orig/src/Ships/RepairCorvette.c	2002-09-04 12:46:38.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/RepairCorvette.c	2004-08-01 22:35:15.000000000 -0700
@@ -7,24 +7,24 @@
 =============================================================================*/
 
 #include <string.h>
-#include "types.h"
-#include "debug.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Debug.h"
+#include "SpaceObj.h"
 #include "RepairCorvette.h"
-#include "statscript.h"
-#include "fastmath.h"
-#include "gun.h"
-#include "attack.h"
+#include "StatScript.h"
+#include "FastMath.h"
+#include "Gun.h"
+#include "Attack.h"
 #include "DefaultShip.h"
-#include "shipselect.h"
-#include "aiship.h"
-#include "aitrack.h"
-#include "commandlayer.h"
-#include "univupdate.h"
-#include "universe.h"
-#include "collision.h"
+#include "ShipSelect.h"
+#include "AIShip.h"
+#include "AITrack.h"
+#include "CommandLayer.h"
+#include "UnivUpdate.h"
+#include "Universe.h"
+#include "Collision.h"
 #include "SaveGame.h"
-#include "soundevent.h"
+#include "SoundEvent.h"
 
 void stopRepairEffect(Ship *ship);
 
@@ -62,10 +62,10 @@
         {                                                                                       \
             aitrackZeroVelocity(ship);                                                          \
         }
-
-//aishipGetTrajectory(ship,(SpaceObjRotImpTarg *)spec->target,&trajectory);         \
-//        range = RangeToTarget(ship,(SpaceObjRotImpTarg *)spec->target,&trajectory);           \
-//                                                                                          \
+/*
+        aishipGetTrajectory(ship,(SpaceObjRotImpTarg *)spec->target,&trajectory);           \
+        range = RangeToTarget(ship,(SpaceObjRotImpTarg *)spec->target,&trajectory);         \
+*/                                                                                          
 
 
 
diff -urPw homeworld-orig/src/Ships/RepairCorvette.h homeworld_sdl-0.3/src/Ships/RepairCorvette.h
--- homeworld-orig/src/Ships/RepairCorvette.h	2002-09-04 12:46:38.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/RepairCorvette.h	2004-08-01 22:35:15.000000000 -0700
@@ -9,10 +9,10 @@
 #ifndef ___REPAIR_CORVETTE_H
 #define ___REPAIR_CORVETTE_H
 
-#include "types.h"
-#include "spaceobj.h"
-#include "attack.h"
-#include "shipselect.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "Attack.h"
+#include "ShipSelect.h"
 
 /*=============================================================================
     Types:
diff -urPw homeworld-orig/src/Ships/ResearchShip.c homeworld_sdl-0.3/src/Ships/ResearchShip.c
--- homeworld-orig/src/Ships/ResearchShip.c	2002-09-04 12:46:38.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/ResearchShip.c	2004-08-01 22:35:14.000000000 -0700
@@ -7,22 +7,22 @@
 =============================================================================*/
 
 #include <math.h>
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 #include "ResearchShip.h"
-#include "univupdate.h"
+#include "UnivUpdate.h"
 #include "SoundEvent.h"
-#include "statscript.h"
-#include "aitrack.h"
-#include "matrix.h"
-#include "aiship.h"
-#include "debug.h"
-#include "fastmath.h"
-#include "select.h"
-#include "universe.h"
-#include "linkedlist.h"
+#include "StatScript.h"
+#include "AITrack.h"
+#include "Matrix.h"
+#include "AIShip.h"
+#include "Debug.h"
+#include "FastMath.h"
+#include "Select.h"
+#include "Universe.h"
+#include "LinkedList.h"
 #include "SaveGame.h"
-#include "dock.h"
+#include "Dock.h"
 
 #define ROTATE_WAIT 0
 #define ROTATE_DO   1
@@ -476,13 +476,14 @@
 
 void ResearchShipMakeReadyForHyperspace(Ship *ship)
 {
-    ResearchShipSpec *spec = (ResearchShipSpec *)ship->ShipSpecifics;
+//    ResearchShipSpec *spec = (ResearchShipSpec *)ship->ShipSpecifics;
     if(ship->flags & SOF_Slaveable)
     {
         bitClear(ship->slaveinfo->Master->specialFlags,SPECIAL_StopForResearchDocking);
         dockCrushMaster(ship->slaveinfo->Master);
     }
-/*   if(ship->dockvars.reserveddocking != -1)
+/*
+    if(ship->dockvars.reserveddocking != -1)
     {
         sdword dockpointindex;
 
diff -urPw homeworld-orig/src/Ships/ResearchShip.h homeworld_sdl-0.3/src/Ships/ResearchShip.h
--- homeworld-orig/src/Ships/ResearchShip.h	2002-09-04 12:46:38.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/ResearchShip.h	2004-08-01 22:35:14.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___RESEARCH_SHIP_H
 #define ___RESERACH_SHIP_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Types:
diff -urPw homeworld-orig/src/Ships/ResourceCollector.c homeworld_sdl-0.3/src/Ships/ResourceCollector.c
--- homeworld-orig/src/Ships/ResourceCollector.c	2002-09-04 12:46:38.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/ResourceCollector.c	2004-08-01 22:35:14.000000000 -0700
@@ -6,15 +6,15 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 #include "ResourceCollector.h"
 #include "SoundEvent.h"
-#include "statscript.h"
+#include "StatScript.h"
 #include "DefaultShip.h"
-#include "shipselect.h"
-#include "repaircorvette.h"
-#include "rescollect.h"
+#include "ShipSelect.h"
+#include "RepairCorvette.h"
+#include "ResCollect.h"
 
 typedef struct
 {
diff -urPw homeworld-orig/src/Ships/ResourceCollector.h homeworld_sdl-0.3/src/Ships/ResourceCollector.h
--- homeworld-orig/src/Ships/ResourceCollector.h	2002-09-04 12:46:38.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/ResourceCollector.h	2004-08-01 22:35:14.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___RESOURCE_COLLECTOR_H
 #define ___RESOURCE_COLLECTOR_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Types:
diff -urPw homeworld-orig/src/Ships/ResourceController.c homeworld_sdl-0.3/src/Ships/ResourceController.c
--- homeworld-orig/src/Ships/ResourceController.c	2002-09-04 12:46:38.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/ResourceController.c	2004-08-01 22:35:15.000000000 -0700
@@ -6,17 +6,17 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 #include "ResourceController.h"
-#include "statscript.h"
-#include "shipselect.h"
-#include "aiship.h"
-#include "collision.h"
-#include "dock.h"
-#include "universe.h"
-#include "commandlayer.h"
-#include "repaircorvette.h"
+#include "StatScript.h"
+#include "ShipSelect.h"
+#include "AIShip.h"
+#include "Collision.h"
+#include "Dock.h"
+#include "Universe.h"
+#include "CommandLayer.h"
+#include "RepairCorvette.h"
 
 typedef struct
 {
diff -urPw homeworld-orig/src/Ships/ResourceController.h homeworld_sdl-0.3/src/Ships/ResourceController.h
--- homeworld-orig/src/Ships/ResourceController.h	2002-09-04 12:46:38.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/ResourceController.h	2004-08-01 22:35:15.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___RESOURCE_CONTROLLER_H
 #define ___RESOURCE_CONTROLLER_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Types:
diff -urPw homeworld-orig/src/Ships/SalCapCorvette.c homeworld_sdl-0.3/src/Ships/SalCapCorvette.c
--- homeworld-orig/src/Ships/SalCapCorvette.c	2002-09-04 12:46:38.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/SalCapCorvette.c	2004-08-01 22:35:14.000000000 -0700
@@ -9,48 +9,48 @@
 #include <stdio.h>
 #include <math.h>
 
-#include "types.h"
-#include "debug.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Debug.h"
+#include "SpaceObj.h"
 #include "SalCapCorvette.h"
-#include "statscript.h"
-#include "gun.h"
-#include "attack.h"
+#include "StatScript.h"
+#include "Gun.h"
+#include "Attack.h"
 #include "DefaultShip.h"
-#include "select.h"
-#include "shipselect.h"
-#include "univupdate.h"
-#include "aiship.h"
-#include "aitrack.h"
+#include "Select.h"
+#include "ShipSelect.h"
+#include "UnivUpdate.h"
+#include "AIShip.h"
+#include "AITrack.h"
 #include "memory.h"
-#include "universe.h"
-#include "fastmath.h"
-#include "dock.h"
-#include "vector.h"
-#include "commandlayer.h"
-#include "soundevent.h"
-#include "physics.h"
-#include "multiplayergame.h"
+#include "Universe.h"
+#include "FastMath.h"
+#include "Dock.h"
+#include "Vector.h"
+#include "CommandLayer.h"
+#include "SoundEvent.h"
+#include "Physics.h"
+#include "MultiplayerGame.h"
 #include "SaveGame.h"
-#include "aivar.h"
+#include "AIVar.h"
 #include "prim3d.h"
 #include "render.h"
-#include "clamp.h"
-#include "nis.h"
-#include "madlinkin.h"
-#include "madlinkindefs.h"
-#include "mothership.h"
-#include "collision.h"
-#include "carrier.h"
-#include "alliance.h"
-#include "tactics.h"
-#include "ping.h"
-#include "singleplayer.h"
-#include "battle.h"
-#include "commandwrap.h"
-#include "genericdefender.h"
-#include "gravwellgenerator.h"
-#include "randy.h"
+#include "Clamp.h"
+#include "NIS.h"
+#include "MadLinkIn.h"
+#include "MadLinkInDefs.h"
+#include "Mothership.h"
+#include "Collision.h"
+#include "Carrier.h"
+#include "Alliance.h"
+#include "Tactics.h"
+#include "Ping.h"
+#include "SinglePlayer.h"
+#include "Battle.h"
+#include "CommandWrap.h"
+#include "GenericDefender.h"
+#include "GravWellGenerator.h"
+#include "Randy.h"
 
 #define DEBUG_SALCAP
 
@@ -94,7 +94,7 @@
 void clLaunchShip(CommandLayer *comlayer,SelectCommand *selectcom,ShipPtr receiverShip);
 void startTractorBeam(Ship *ship, SpaceObjRotImpTargGuidanceShipDerelict *target);
 
-
+SalCapCorvetteStatics SalCapCorvetteStatic;
 SalCapCorvetteStatics SalCapCorvetteStaticRace1;
 SalCapCorvetteStatics SalCapCorvetteStaticRace2;
 SalCapCorvetteStatics SalCapCorvetteStaticDawg;
@@ -217,8 +217,8 @@
 //make tractor beam originate from 'tractor beam light'
 void startTractorBeam(Ship *ship, SpaceObjRotImpTargGuidanceShipDerelict *target)
 {
-    ShipStaticInfo *shipstatic = (ShipStaticInfo *)ship->staticinfo;
-    TractorBeamStatic *tractorBeamStatic = shipstatic->tractorEmitterStatic;
+    //ShipStaticInfo *shipstatic = (ShipStaticInfo *)ship->staticinfo;
+    //TractorBeamStatic *tractorBeamStatic = shipstatic->tractorEmitterStatic;
     SalCapCorvetteSpec *spec = (SalCapCorvetteSpec *)ship->ShipSpecifics;
 
     //vector beamposition;
@@ -289,7 +289,6 @@
 ----------------------------------------------------------------------------*/
 void StopTractorBeam(Ship *ship)
 {
-    SalCapCorvetteSpec *spec = (SalCapCorvetteSpec *)ship->ShipSpecifics;
     etgEffectDelete(ship->rceffect);
     univRemoveObjFromRenderList((SpaceObj *)ship->rceffect);
     listDeleteNode(&ship->rceffect->objlink);
@@ -1169,7 +1168,6 @@
 
 sdword salCapFlyToWithinDockingRange(Ship *ship)
 {
-    SalCapCorvetteStatics *salcapcorvettestatics = ((ShipStaticInfo *)(ship->staticinfo))->custstatinfo;
     real32 maxpushvelocity;
 
     SalCapCorvetteSpec *spec = (SalCapCorvetteSpec *)ship->ShipSpecifics;
@@ -1264,7 +1262,6 @@
 sdword salCapFlyToDockingPoint1over2(Ship *ship,SpaceObjRotImpTargGuidanceShipDerelict *target)
 {
     SalCapCorvetteSpec *spec = (SalCapCorvetteSpec *)ship->ShipSpecifics;
-    SalCapCorvetteStatics *salcapcorvettestatics = ((ShipStaticInfo *)(ship->staticinfo))->custstatinfo;
 
     vector coneheadingInWorldCoordSys,conepositionInWorldCoordSys;
     vector destination,dockwithHeading;
@@ -1307,7 +1304,7 @@
 sdword salCapFlyToDockingPoint1(Ship *ship,SpaceObjRotImpTargGuidanceShipDerelict *target)
 {
     SalCapCorvetteSpec *spec = (SalCapCorvetteSpec *)ship->ShipSpecifics;
-    SalCapCorvetteStatics *salcapcorvettestatics = ((ShipStaticInfo *)(ship->staticinfo))->custstatinfo;
+    //SalCapCorvetteStatics *salcapcorvettestatics = ((ShipStaticInfo *)(ship->staticinfo))->custstatinfo;
 
     vector coneheadingInWorldCoordSys,conepositionInWorldCoordSys;
     vector dockwithUp,dockwithHeading,dockwithRight,navpoint;
@@ -1337,6 +1334,7 @@
             }
         }
     }
+
         matGetVectFromMatrixCol1(dockwithUp,spec->dockwith->rotinfo.coordsys);
         matGetVectFromMatrixCol2(dockwithRight,spec->dockwith->rotinfo.coordsys);
         matGetVectFromMatrixCol3(dockwithHeading,spec->dockwith->rotinfo.coordsys);
@@ -1355,12 +1353,11 @@
             desiredUp = dockwithUp;
         }
     }
+    
     matMultiplyMatByVec(&coneheadingInWorldCoordSys,&spec->dockwith->rotinfo.coordsys,&spec->dockwith->dockInfo->dockpoints[spec->dockindex].dockstaticpoint->conenormal);
     matMultiplyMatByVec(&conepositionInWorldCoordSys,&spec->dockwith->rotinfo.coordsys,&spec->dockwith->dockInfo->dockpoints[spec->dockindex].dockstaticpoint->position);
     vecAddTo(conepositionInWorldCoordSys,spec->dockwith->posinfo.position);
 
-
-
     needDest = TRUE;
     if(spec->dockwith->shiptype == Mothership)
     {
@@ -1840,7 +1837,7 @@
             {
                 //not enough doods targetting this bizitch...play sound event
                 //with ye'old battler chatter of course
-    bloot:;
+                ;
             }
         }
         spec->salvageState = SAL_DOCKINGSTATE1;
@@ -2078,7 +2075,7 @@
                 if(!salCapAreEnoughSalvagersTargettingThisTarget(ship,spec->target))
                 {
                     //not enough doods targetting this bizitch...play sound event
-    blooty:;
+                    ;
                 }
             }
         }
@@ -2800,7 +2797,6 @@
 //Don't forget to clear tractorbeaminfo in ship and derelict structures.!
 void SalCapClose(Ship *ship)
 {
-    SalCapCorvetteSpec *spec = (SalCapCorvetteSpec *)ship->ShipSpecifics;
 }
 
 void salCapClearTechBool()
@@ -3156,7 +3152,6 @@
 
 void SalCapCorvette_RegisterExtraSpaceObjs(Ship *ship)
 {
-    SalCapCorvetteSpec *spec = (SalCapCorvetteSpec *)ship->ShipSpecifics;
 }
 
 void SalCapCorvette_PreFix(Ship *ship)
diff -urPw homeworld-orig/src/Ships/SalCapCorvette.h homeworld_sdl-0.3/src/Ships/SalCapCorvette.h
--- homeworld-orig/src/Ships/SalCapCorvette.h	2002-09-04 12:46:38.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/SalCapCorvette.h	2004-08-01 22:35:14.000000000 -0700
@@ -9,10 +9,10 @@
 #ifndef ___SAL_CAP_CORVETTE_H
 #define ___SAL_CAP_CORVETTE_H
 
-#include "types.h"
-#include "spaceobj.h"
-#include "attack.h"
-#include "shipselect.h"
+#include "Types.h"
+#include "SpaceObj.h"
+#include "Attack.h"
+#include "ShipSelect.h"
 
 /*=============================================================================
     Types:
@@ -47,7 +47,7 @@
     real32 maxPushingVelocitySingle;
     real32 noLightClampingDistance;
 } SalCapCorvetteStatics;
-SalCapCorvetteStatics SalCapCorvetteStatic;
+extern SalCapCorvetteStatics SalCapCorvetteStatic;
 
 //Defs for Salvaging State...
 #define SALVAGE_AT_GET_TECH 0x01
diff -urPw homeworld-orig/src/Ships/SensorArray.c homeworld_sdl-0.3/src/Ships/SensorArray.c
--- homeworld-orig/src/Ships/SensorArray.c	2002-09-04 12:46:38.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/SensorArray.c	2004-08-01 22:35:15.000000000 -0700
@@ -6,11 +6,11 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 #include "SensorArray.h"
 #include "SoundEvent.h"
-#include "universe.h"
+#include "Universe.h"
 
 typedef struct
 {
diff -urPw homeworld-orig/src/Ships/SensorArray.h homeworld_sdl-0.3/src/Ships/SensorArray.h
--- homeworld-orig/src/Ships/SensorArray.h	2002-09-04 12:46:38.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/SensorArray.h	2004-08-01 22:35:15.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___SENSOR_ARRAY_H
 #define ___SENSOR_ARRAY_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Types:
diff -urPw homeworld-orig/src/Ships/StandardDestroyer.c homeworld_sdl-0.3/src/Ships/StandardDestroyer.c
--- homeworld-orig/src/Ships/StandardDestroyer.c	2002-09-04 12:46:38.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/StandardDestroyer.c	2004-08-01 22:35:14.000000000 -0700
@@ -6,13 +6,13 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "debug.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Debug.h"
+#include "SpaceObj.h"
 #include "StandardDestroyer.h"
-#include "statscript.h"
-#include "gun.h"
-#include "attack.h"
+#include "StatScript.h"
+#include "Gun.h"
+#include "Attack.h"
 #include "DefaultShip.h"
 
 typedef struct
diff -urPw homeworld-orig/src/Ships/StandardDestroyer.h homeworld_sdl-0.3/src/Ships/StandardDestroyer.h
--- homeworld-orig/src/Ships/StandardDestroyer.h	2002-09-04 12:46:38.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/StandardDestroyer.h	2004-08-01 22:35:14.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___STANDARD_DESTROYER_H
 #define ___STANDARD_DESTROYER_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Defines:
diff -urPw homeworld-orig/src/Ships/StandardFrigate.c homeworld_sdl-0.3/src/Ships/StandardFrigate.c
--- homeworld-orig/src/Ships/StandardFrigate.c	2002-09-04 12:46:38.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/StandardFrigate.c	2004-08-01 22:35:14.000000000 -0700
@@ -6,13 +6,13 @@
     Copyright Relic Entertainment, Inc.  All rights reserved.
 =============================================================================*/
 
-#include "types.h"
-#include "debug.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "Debug.h"
+#include "SpaceObj.h"
 #include "StandardFrigate.h"
-#include "statscript.h"
-#include "gun.h"
-#include "attack.h"
+#include "StatScript.h"
+#include "Gun.h"
+#include "Attack.h"
 #include "DefaultShip.h"
 
 typedef struct
diff -urPw homeworld-orig/src/Ships/StandardFrigate.h homeworld_sdl-0.3/src/Ships/StandardFrigate.h
--- homeworld-orig/src/Ships/StandardFrigate.h	2002-09-04 12:46:38.000000000 -0700
+++ homeworld_sdl-0.3/src/Ships/StandardFrigate.h	2004-08-01 22:35:15.000000000 -0700
@@ -9,8 +9,8 @@
 #ifndef ___STANDARD_FRIGATE_H
 #define ___STANDARD_FRIGATE_H
 
-#include "types.h"
-#include "spaceobj.h"
+#include "Types.h"
+#include "SpaceObj.h"
 
 /*=============================================================================
     Defines:
Only in homeworld-orig/src/Ships: vssver.scc
Only in homeworld-orig/src: Sigs
diff -urPw homeworld-orig/src/SinglePlayer/Mission01.kas homeworld_sdl-0.3/src/SinglePlayer/Mission01.kas
--- homeworld-orig/src/SinglePlayer/Mission01.kas	2002-09-04 12:46:38.000000000 -0700
+++ homeworld_sdl-0.3/src/SinglePlayer/Mission01.kas	2004-08-01 22:35:37.000000000 -0700
@@ -1,7 +1,7 @@
 //
 //  MISSION01
 //
-#include "..\\Game\\speechevent.h"
+#include "../Game/SpeechEvent.h"
 #include "Attributes.h"
 
 
Only in homeworld-orig/src/SinglePlayer: Mission01.mdb
diff -urPw homeworld-orig/src/SinglePlayer/Mission02.kas homeworld_sdl-0.3/src/SinglePlayer/Mission02.kas
--- homeworld-orig/src/SinglePlayer/Mission02.kas	2002-09-04 12:46:40.000000000 -0700
+++ homeworld_sdl-0.3/src/SinglePlayer/Mission02.kas	2004-08-01 22:35:38.000000000 -0700
@@ -1,8 +1,8 @@
 //
 //      MISSION02 - Battle w/ Turanic Raiders
 //
-#include "..\\Game\\speechevent.h"
-#include "..\\Game\\soundmusic.h"
+#include "../Game/SpeechEvent.h"
+#include "../Game/SoundMusic.h"
 
 
     LOCALIZATION //
Only in homeworld-orig/src/SinglePlayer: Mission02.mdb
diff -urPw homeworld-orig/src/SinglePlayer/Mission03.kas homeworld_sdl-0.3/src/SinglePlayer/Mission03.kas
--- homeworld-orig/src/SinglePlayer/Mission03.kas	2002-09-04 12:46:40.000000000 -0700
+++ homeworld_sdl-0.3/src/SinglePlayer/Mission03.kas	2004-08-01 22:35:38.000000000 -0700
@@ -2,7 +2,7 @@
 //  MISSION03
 //
 
-#include "speechevent.h"
+#include "SpeechEvent.h"
 
     LOCALIZATION //
 //LString Standards:
Only in homeworld-orig/src/SinglePlayer: Mission03.mdb
diff -urPw homeworld-orig/src/SinglePlayer/Mission04.kas homeworld_sdl-0.3/src/SinglePlayer/Mission04.kas
--- homeworld-orig/src/SinglePlayer/Mission04.kas	2002-09-04 12:46:40.000000000 -0700
+++ homeworld_sdl-0.3/src/SinglePlayer/Mission04.kas	2004-08-01 22:35:39.000000000 -0700
@@ -5,9 +5,9 @@
 //            : Secondary Assess enemy fleet
 //            : Secondary Build an Assualt Frigate for use against Turanic Raider Mothership
 //
-#include "..\\Game\\speechevent.h"
-#include "..\\Game\\soundmusic.h"
-#include "attributes.h"
+#include "../Game/SpeechEvent.h"
+#include "../Game/SoundMusic.h"
+#include "Attributes.h"
     LOCALIZATION
 
         LSTRING_LocationCard
Only in homeworld-orig/src/SinglePlayer: Mission04.mdb
diff -urPw homeworld-orig/src/SinglePlayer/Mission05.kas homeworld_sdl-0.3/src/SinglePlayer/Mission05.kas
--- homeworld-orig/src/SinglePlayer/Mission05.kas	2002-09-04 12:46:40.000000000 -0700
+++ homeworld_sdl-0.3/src/SinglePlayer/Mission05.kas	2004-08-01 22:35:39.000000000 -0700
@@ -1,8 +1,8 @@
 //
 //  MISSION05 - Battle w/ sacking force
 //
-#include "..\\Game\\speechevent.h"
-#include "..\\Game\\soundmusic.h"
+#include "../Game/SpeechEvent.h"
+#include "../Game/SoundMusic.h"
 
     LOCALIZATION //
 
Only in homeworld-orig/src/SinglePlayer: Mission05.mdb
Only in homeworld-orig/src/SinglePlayer: Mission05_OEM.mdb
diff -urPw homeworld-orig/src/SinglePlayer/Mission06.kas homeworld_sdl-0.3/src/SinglePlayer/Mission06.kas
--- homeworld-orig/src/SinglePlayer/Mission06.kas	2002-09-04 12:46:42.000000000 -0700
+++ homeworld_sdl-0.3/src/SinglePlayer/Mission06.kas	2004-08-01 22:35:39.000000000 -0700
@@ -1,9 +1,9 @@
 //
 //  MISSION06 - Asteroids 3D
 //
-#include "..\\Game\\speechevent.h"
-#include "attributes.h"
-#include "..\\Game\\soundmusic.h"
+#include "../Game/SpeechEvent.h"
+#include "Attributes.h"
+#include "../Game/SoundMusic.h"
 
     LOCALIZATION //
 
Only in homeworld-orig/src/SinglePlayer: Mission06.mdb
diff -urPw homeworld-orig/src/SinglePlayer/Mission07.kas homeworld_sdl-0.3/src/SinglePlayer/Mission07.kas
--- homeworld-orig/src/SinglePlayer/Mission07.kas	2002-09-04 12:46:42.000000000 -0700
+++ homeworld_sdl-0.3/src/SinglePlayer/Mission07.kas	2004-08-01 22:35:40.000000000 -0700
@@ -156,8 +156,8 @@
 #define MASTERTEAM     TEAM_P2Mothership
 #define EVENTSTEAM     TEAM_Dummy1
 #include "Swarmer.kash"
-#include "speechevent.h"
-#include "soundmusic.h"
+#include "SpeechEvent.h"
+#include "SoundMusic.h"
 #include "CommandDefs.h"
 //-----------------------------------------------------------------------------
 //    Name        : Events
Only in homeworld-orig/src/SinglePlayer: Mission07.mdb
diff -urPw homeworld-orig/src/SinglePlayer/Mission08.kas homeworld_sdl-0.3/src/SinglePlayer/Mission08.kas
--- homeworld-orig/src/SinglePlayer/Mission08.kas	2002-09-04 12:46:42.000000000 -0700
+++ homeworld_sdl-0.3/src/SinglePlayer/Mission08.kas	2004-08-01 22:35:40.000000000 -0700
@@ -178,16 +178,16 @@
 
     ENDL //
 
-#include "speechevent.h"
+#include "SpeechEvent.h"
 #include "CommandDefs.h"
-#include "soundmusic.h"
+#include "SoundMusic.h"
 
 #define MISSION8
 #define MOTHERTEAM         TEAM_MsgSender
 #define MASTERTEAM         TEAM_Master
 #define EVENTSTEAM         TEAM_Events
 
-#include "swarmer.kash"
+#include "Swarmer.kash"
 
 
 
Only in homeworld-orig/src/SinglePlayer: Mission08.mdb
diff -urPw homeworld-orig/src/SinglePlayer/Mission09.kas homeworld_sdl-0.3/src/SinglePlayer/Mission09.kas
--- homeworld-orig/src/SinglePlayer/Mission09.kas	2002-09-04 12:46:44.000000000 -0700
+++ homeworld_sdl-0.3/src/SinglePlayer/Mission09.kas	2004-08-01 22:35:40.000000000 -0700
@@ -2,9 +2,9 @@
 //  MISSION09 - Ghostship
 //
 //
-#include "..\\Game\\speechevent.h"
-#include "attributes.h"
-#include "..\\Game\\soundmusic.h"
+#include "../Game/SpeechEvent.h"
+#include "Attributes.h"
+#include "../Game/SoundMusic.h"
     LOCALIZATION //
 
             LSTRING_Savegame
Only in homeworld-orig/src/SinglePlayer: Mission09.mdb
diff -urPw homeworld-orig/src/SinglePlayer/Mission10.kas homeworld_sdl-0.3/src/SinglePlayer/Mission10.kas
--- homeworld-orig/src/SinglePlayer/Mission10.kas	2002-09-04 12:46:44.000000000 -0700
+++ homeworld_sdl-0.3/src/SinglePlayer/Mission10.kas	2004-08-01 22:35:38.000000000 -0700
@@ -3,8 +3,8 @@
 //        Mission10 - Research Station - SuperNova Battle               //
 //                                                                      //
 //----------------------------------------------------------------------//
-#include "..\\Game\\speechevent.h"
-#include "..\\Game\\soundmusic.h"
+#include "../Game/SpeechEvent.h"
+#include "../Game/SoundMusic.h"
 
     LOCALIZATION //
 
Only in homeworld-orig/src/SinglePlayer: Mission10.mdb
diff -urPw homeworld-orig/src/SinglePlayer/Mission11.kas homeworld_sdl-0.3/src/SinglePlayer/Mission11.kas
--- homeworld-orig/src/SinglePlayer/Mission11.kas	2002-09-04 12:46:46.000000000 -0700
+++ homeworld_sdl-0.3/src/SinglePlayer/Mission11.kas	2004-08-01 22:35:38.000000000 -0700
@@ -1,9 +1,9 @@
 //
 //  MISSION11 - Battle against P3 (help the Traders)
 //
-#include "..\\Game\\speechevent.h"
-#include "..\\Game\\soundmusic.h"
-#include "attributes.h"
+#include "../Game/SpeechEvent.h"
+#include "../Game/SoundMusic.h"
+#include "Attributes.h"
 
 
     LOCALIZATION //
Only in homeworld-orig/src/SinglePlayer: Mission11.mdb
diff -urPw homeworld-orig/src/SinglePlayer/Mission12.kas homeworld_sdl-0.3/src/SinglePlayer/Mission12.kas
--- homeworld-orig/src/SinglePlayer/Mission12.kas	2002-09-04 12:46:46.000000000 -0700
+++ homeworld_sdl-0.3/src/SinglePlayer/Mission12.kas	2004-08-01 22:35:38.000000000 -0700
@@ -1,8 +1,8 @@
 //
 //      MISSION12 - Elite Guard Trap
 //
-#include "..\\Game\\speechevent.h"
-#include "..\\Game\\soundmusic.h"
+#include "../Game/SpeechEvent.h"
+#include "../Game/SoundMusic.h"
 
 
     LOCALIZATION //
Only in homeworld-orig/src/SinglePlayer: Mission12.mdb
diff -urPw homeworld-orig/src/SinglePlayer/Mission13.kas homeworld_sdl-0.3/src/SinglePlayer/Mission13.kas
--- homeworld-orig/src/SinglePlayer/Mission13.kas	2002-09-04 12:46:46.000000000 -0700
+++ homeworld_sdl-0.3/src/SinglePlayer/Mission13.kas	2004-08-01 22:35:39.000000000 -0700
@@ -5,7 +5,7 @@
 //                                                             //
 //                                                             //
 //-------------------------------------------------------------//
-#include "..\\Game\\speechevent.h"
+#include "../Game/SpeechEvent.h"
 
 
     LOCALIZATION //
@@ -47,8 +47,8 @@
 
     ENDL //
 
-#include "utilities.kash"
-#include "attributes.h"
+#include "Utilities.kash"
+#include "Attributes.h"
 
 //      Mission Flow     
 FSM MissionFlow
Only in homeworld-orig/src/SinglePlayer: Mission13.mdb
diff -urPw homeworld-orig/src/SinglePlayer/Mission14.kas homeworld_sdl-0.3/src/SinglePlayer/Mission14.kas
--- homeworld-orig/src/SinglePlayer/Mission14.kas	2002-09-04 12:46:48.000000000 -0700
+++ homeworld_sdl-0.3/src/SinglePlayer/Mission14.kas	2004-08-01 22:35:39.000000000 -0700
@@ -1,7 +1,7 @@
 //
 //      MISSION14 - Mining Facility
 //
-#include "..\\Game\\speechevent.h"
+#include "../Game/SpeechEvent.h"
 
 
     LOCALIZATION //
Only in homeworld-orig/src/SinglePlayer: Mission14.mdb
diff -urPw homeworld-orig/src/SinglePlayer/Mission15.kas homeworld_sdl-0.3/src/SinglePlayer/Mission15.kas
--- homeworld-orig/src/SinglePlayer/Mission15.kas	2002-09-04 12:46:48.000000000 -0700
+++ homeworld_sdl-0.3/src/SinglePlayer/Mission15.kas	2004-08-01 22:35:39.000000000 -0700
@@ -2,9 +2,9 @@
 //  MISSION14 - Headshot asteroid
 //
 
-#include "speechevent.h"
+#include "SpeechEvent.h"
 #include "CommandDefs.h"
-#include "soundmusic.h"
+#include "SoundMusic.h"
 
 // ---could be from "Subtitle.h" if it didn't include so much extra....
 #define STA_FleetCommand        0
Only in homeworld-orig/src/SinglePlayer: Mission15.mdb
diff -urPw homeworld-orig/src/SinglePlayer/Mission16.kas homeworld_sdl-0.3/src/SinglePlayer/Mission16.kas
--- homeworld-orig/src/SinglePlayer/Mission16.kas	2002-09-04 12:46:50.000000000 -0700
+++ homeworld_sdl-0.3/src/SinglePlayer/Mission16.kas	2004-08-01 22:35:40.000000000 -0700
@@ -118,7 +118,7 @@
 
 #define MASTERTEAM          TEAM_ImperialFlagship
 #define MASTERTEAMSHIPS     TEAMSHIPS_ImperialFlagship
-#include "speechevent.h"
+#include "SpeechEvent.h"
 #include "CommandDefs.h"
 #include "AIFeatures.h"
 #include "Utilities.kash"
Only in homeworld-orig/src/SinglePlayer: Mission16.mdb
Only in homeworld-orig/src/SinglePlayer: vssver.scc
diff -urPw homeworld-orig/src/Tutorials/Tutorial1.kas homeworld_sdl-0.3/src/Tutorials/Tutorial1.kas
--- homeworld-orig/src/Tutorials/Tutorial1.kas	2002-09-04 12:47:00.000000000 -0700
+++ homeworld_sdl-0.3/src/Tutorials/Tutorial1.kas	2004-08-01 22:35:16.000000000 -0700
@@ -1328,7 +1328,7 @@
     ENDL
 
 //includes
-#include "speechevent.h"
+#include "SpeechEvent.h"
 #include "Attributes.h"
 #include "FormationDefs.h"
 
Only in homeworld-orig/src/Tutorials: Tutorial1.mdb
Only in homeworld-orig/src/Tutorials: vssver.scc
Only in homeworld-orig/src: vssver.scc
